<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>seiputaway.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>seiputaway.c</h1><a href="seiputaway_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/******************************************************************</span>
00002 <span class="comment"> * seiputaway.c - routines to enable Seisan data to be stored from</span>
00003 <span class="comment"> *                Earthworm</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * S. Flower, Feb 2001</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Modified 11 Oct 2001 - instead of writing direct to the output</span>
00008 <span class="comment"> * file we write to a temporary file and rename it when it is</span>
00009 <span class="comment"> * complete - this ensures that the file can be read OK as soon</span>
00010 <span class="comment"> * as it is available</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * Modified 26 Oct 2001 - fixed bug that puts gaps at wrong end</span>
00013 <span class="comment"> * of output traces</span>
00014 <span class="comment"> *</span>
00015 <span class="comment"> * Modified 26 Oct 2001 - seisan file writing routines moved to a</span>
00016 <span class="comment"> * sparate file because of complexity of doing seisan writes</span>
00017 <span class="comment"> * with the Earthworm putaway structure</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> * Modified 31st Jan 2002 - new routines to make dealing with</span>
00020 <span class="comment"> * earthworm data structures easier to follow (pa_find_data())</span>
00021 <span class="comment"> ******************************************************************/</span>
00022 
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 <span class="preprocessor">#include &lt;time.h&gt;</span>
00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
00027 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00028 <span class="preprocessor">#include &lt;math.h&gt;</span>
00029 <span class="preprocessor">#include &lt;float.h&gt;</span>
00030 <span class="preprocessor">#if defined (_WINNT)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;io.h&gt;</span>
00032 <span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00036 
00037 <span class="preprocessor">#include "<a class="code" href="earthworm_8h.html">earthworm.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="trace__buf_8h.html">trace_buf.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="swap_8h.html">swap.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="ws__clientII_8h.html">ws_clientII.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="site_8h.html">site.h</a>"</span>
00042 <span class="preprocessor">#include "<a class="code" href="time__ew_8h.html">time_ew.h</a>"</span>
00043 
00044 <span class="preprocessor">#include "<a class="code" href="seihead_8h.html">seihead.h</a>"</span>
00045 
00046 
00047 <span class="comment">/* private global variables */</span>
<a name="l00048"></a><a class="code" href="seiputaway_8c.html#a0">00048</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a0">output_native_numbers</a>;
00049 
00050 
00051 <span class="comment">/**********************************************************************</span>
00052 <span class="comment"> * SEIPA_init</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * Description: initialise SEIsan put away routines</span>
00055 <span class="comment"> *</span>
00056 <span class="comment"> * Input parameters: output_dir - the directory to be used for Seisan</span>
00057 <span class="comment"> *                                output files</span>
00058 <span class="comment"> *                   output_format - "intel" or "sparc" for byte ordering</span>
00059 <span class="comment"> *                   debug - flag for debugging output</span>
00060 <span class="comment"> * Output parameters: none</span>
00061 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00062 <span class="comment"> *</span>
00063 <span class="comment"> * Comments:</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> ***********************************************************************/</span>
<a name="l00066"></a><a class="code" href="seiputaway_8c.html#a1">00066</a> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a1">SEIPA_init</a> (<span class="keywordtype">char</span> *output_dir, <span class="keywordtype">char</span> *output_format, <span class="keywordtype">int</span> debug)
00067 
00068 {
00069     
00070   <span class="comment">/* make sure that the output directory exists */</span>
00071   <span class="keywordflow">if</span> (<a class="code" href="dirops__ew_8c.html#a1">CreateDir</a> (output_dir) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00072   {
00073     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: Call to CreateDir failed\n"</span>);
00074     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00075   }
00076 
00077 <span class="preprocessor">#if defined (_INTEL)</span>
00078 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"intel"</span>))
00079     <a class="code" href="seiputaway_8c.html#a0">output_native_numbers</a> = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00080   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"sparc"</span>))
00081     <a class="code" href="seiputaway_8c.html#a0">output_native_numbers</a> = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00082   <span class="keywordflow">else</span>
00083   {
00084     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: can't recognise OutputFormat (%s)\n"</span>, output_format);
00085     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00086   }
00087 <span class="preprocessor">#elif defined (_SPARC)</span>
00088 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"sparc"</span>))
00089     <a class="code" href="seiputaway_8c.html#a0">output_native_numbers</a> = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00090   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"intel"</span>))
00091     <a class="code" href="seiputaway_8c.html#a0">output_native_numbers</a> = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00092   <span class="keywordflow">else</span>
00093   {
00094     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: can't recognise OutputFormat (%s)\n"</span>, output_format);
00095     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00096   }
00097 <span class="preprocessor">#else</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#error "_INTEL or _SPARC must be set before compiling"</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00100 <span class="preprocessor"></span>
00101   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00102 
00103 }
00104 
00105 <span class="comment">/****************************************************************************</span>
00106 <span class="comment"> * SEIPA_next_ev</span>
00107 <span class="comment"> *</span>
00108 <span class="comment"> * Description: called when a snippet has been received,</span>
00109 <span class="comment"> *              before it is processed</span>
00110 <span class="comment"> *</span>
00111 <span class="comment"> * Input parameters: trace_req - array of trace request structures</span>
00112 <span class="comment"> *                   n_reqs - size of array</span>
00113 <span class="comment"> *                   output_dir - output directory</span>
00114 <span class="comment"> *                   e_date, e_time - event time in the form</span>
00115 <span class="comment"> *                                    'ccyymmdd' and 'hhmmss.ff'</span>
00116 <span class="comment"> *                   debug - flag for debugging output</span>
00117 <span class="comment"> * Output parameters: none</span>
00118 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00119 <span class="comment"> *</span>
00120 <span class="comment"> * Comments:</span>
00121 <span class="comment"> *</span>
00122 <span class="comment"> ***********************************************************************/</span>
<a name="l00123"></a><a class="code" href="seiputaway_8c.html#a2">00123</a> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a2">SEIPA_next_ev</a> (<a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req, <span class="keywordtype">int</span> n_reqs, <span class="keywordtype">char</span> *output_dir,
00124                    <span class="keywordtype">char</span> *e_date, <span class="keywordtype">char</span> *e_time, <span class="keywordtype">char</span> *subnet, <span class="keywordtype">int</span> debug)
00125 {
00126 
00127   <span class="keywordtype">int</span> count;
00128   <span class="keywordtype">double</span> min_start_time, max_end_time;
00129   <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req_ptr;
00130 
00131 
00132   <span class="keywordflow">if</span> (debug)
00133   {
00134     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering SEIPA_next_ev, date/time: %s %s\n"</span>, e_date, e_time);
00135   }
00136 
00137   <span class="comment">/* calculate overall duration of all traces */</span>
00138   min_start_time = DBL_MAX;
00139   max_end_time = 0.0;
00140   <span class="keywordflow">for</span> (count=0; count&lt;n_reqs; count++)
00141   {
00142     trace_req_ptr = trace_req + count;
00143     <span class="keywordflow">if</span> (trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a> &lt; min_start_time)
00144       min_start_time = trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>;
00145     <span class="keywordflow">if</span> (trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> &gt; max_end_time)
00146       max_end_time = trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>;
00147   }
00148   <span class="keywordflow">if</span> (debug)
00149   {
00150     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Request details: %lf-%lf %s\n"</span>, min_start_time, max_end_time, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>);
00151   }
00152   
00153   <span class="comment">/* open the SEIsan file */</span>
00154   <span class="comment">/* changed by CJB 3/20/2002 to use subnet name if one exists */</span>
00155   <span class="keywordflow">if</span> (subnet[0] != <span class="charliteral">'\0'</span>)
00156   {
00157         <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a12">open_seisan_file</a> (output_dir, subnet, min_start_time,
00158                                       max_end_time - min_start_time, output_native_numbers))
00159         {
00160                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: unable to open Seisan output file\n"</span>);
00161                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00162         }
00163   }
00164   <span class="keywordflow">else</span>
00165   {
00166         <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a12">open_seisan_file</a> (output_dir, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>, min_start_time,
00167                                       max_end_time - min_start_time, output_native_numbers))
00168         {
00169                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: unable to open Seisan output file\n"</span>);
00170                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00171         }
00172   }
00173 
00174   <span class="comment">/* write the seisan event file headers */</span>
00175   <span class="keywordflow">for</span> (count=0; count&lt;n_reqs; count++)
00176   {
00177     trace_req_ptr = trace_req + count;
00178     <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a13">add_seisan_channel</a> (trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>))
00179     {
00180       <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: error writing to Seisan output file\n"</span>);
00181       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00182     }
00183     <span class="keywordflow">if</span> (debug)
00184     {
00185       <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Channel %d/%d, %s %s %lf %lf\n"</span>,
00186              count, n_reqs, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>,
00187              trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, min_start_time,
00188              trace_req_ptr-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>);
00189     }
00190   }
00191 
00192   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00193 
00194 }
00195 
00196 <span class="comment">/*****************************************************************************</span>
00197 <span class="comment"> * SEIPA_next</span>
00198 <span class="comment"> *</span>
00199 <span class="comment"> * Description: called once for each trace to be put away</span>
00200 <span class="comment"> *</span>
00201 <span class="comment"> * Input parameters: trace_req - the data to be stored</span>
00202 <span class="comment"> *                   gap_thresh - size of any gap in seconds</span>
00203 <span class="comment"> *                   debug - flag for debugging output</span>
00204 <span class="comment"> * Output parameters: none</span>
00205 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00206 <span class="comment"> *</span>
00207 <span class="comment"> * Comments: see pa_find_data()</span>
00208 <span class="comment"> *</span>
00209 <span class="comment"> *****************************************************************************/</span>
<a name="l00210"></a><a class="code" href="seiputaway_8c.html#a3">00210</a> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a3">SEIPA_next</a> (<a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req, <span class="keywordtype">double</span> gap_thresh, <span class="keywordtype">int</span> debug)
00211 
00212 {
00213 
00214   <span class="keywordtype">int</span> status, loop_count;
00215   <span class="keywordtype">short</span> short_val;
00216   <span class="keywordtype">long</span> value, count;
00217   <span class="keywordtype">float</span> float_val;
00218   <span class="keywordtype">double</span> sample_time, double_val, data_end_time;
00219   <span class="keywordtype">char</span> *data_ptr;
00220   <span class="keyword">struct </span><a class="code" href="structFound__data.html">Found_data</a> data;
00221 
00222 
00223   <span class="keywordflow">if</span> (debug) <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering SEIPA_next\n"</span>);
00224 
00225   <span class="comment">/* loop over the requested times for the data - the test for n_samples==0</span>
00226 <span class="comment">   * is an emergency condition that could happen with very bad floating point</span>
00227 <span class="comment">   * rounding errors (very unlikely though) */</span>
00228   data.<a class="code" href="structFound__data.html#m0">n_samples</a> = 1;
00229   <span class="keywordflow">for</span> (sample_time = trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>, loop_count = 0;
00230        (sample_time &lt; trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>) &amp;&amp; (data.<a class="code" href="structFound__data.html#m0">n_samples</a> &gt; 0);
00231            sample_time += ((double) data.<a class="code" href="structFound__data.html#m0">n_samples</a> / data.<a class="code" href="structFound__data.html#m1">sample_rate</a>), loop_count ++)
00232   {
00233     <span class="comment">/* get the data for this time */</span>
00234     status = <a class="code" href="seiutils_8c.html#a18">pa_find_data</a> (trace_req, sample_time, &amp;data);
00235     <span class="keywordflow">switch</span> (status)
00236         {
00237     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a1">FD_FOUND_REQUESTED</a>:
00238     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a2">FD_FOUND_GAP</a>:
00239           <span class="keywordflow">break</span>;
00240     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a3">FD_NO_MORE_DATA</a>:
00241       <span class="comment">/* if no data has been found on previous calls, then exit</span>
00242 <span class="comment">           * so that no data will be recorded for this channel */</span>
00243           <span class="keywordflow">if</span> (sample_time == trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00244 
00245           <span class="comment">/* otherwise calculate the size of the gap to the end of requested data */</span>
00246           data.<a class="code" href="structFound__data.html#m0">n_samples</a> = (long) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - sample_time));
00247           <span class="keywordflow">break</span>;
00248 
00249     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a4">FD_BAD_DATATYPE</a>:
00250       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_next: unrecognised data type code, skipping this scn: %s.%s.%s\n"</span>,
00251             trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>);
00252       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00253 
00254     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a5">FD_CHANGED_SRATE</a>:
00255       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_next: bad sample rate, skipping this scn: %s.%s.%s\n"</span>,
00256             trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>);
00257       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00258         }
00259 
00260     <span class="comment">/* adjust the number of samples to ensure it doesn't go beyond the end time */</span>
00261         data_end_time = sample_time + ((double) data.<a class="code" href="structFound__data.html#m0">n_samples</a> / data.<a class="code" href="structFound__data.html#m1">sample_rate</a>);
00262         <span class="keywordflow">if</span> (data_end_time &gt; trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>)
00263           data.<a class="code" href="structFound__data.html#m0">n_samples</a> = (long) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - sample_time));
00264     <span class="keywordflow">if</span> (debug) <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Loop %d: %s %ld @ %.1lfHz, time %.3lf\n"</span>,
00265                       loop_count, status == FD_FOUND_REQUESTED ? <span class="stringliteral">"samples"</span> : <span class="stringliteral">"gap"</span>,
00266                                           data.<a class="code" href="structFound__data.html#m0">n_samples</a>, data.<a class="code" href="structFound__data.html#m1">sample_rate</a>, sample_time);
00267 
00268     <span class="comment">/* on the first time write the seisan channel header */</span>
00269     <span class="keywordflow">if</span> (sample_time == trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>)
00270         {
00271       <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a14">start_seisan_channel</a> (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>,
00272                                   sample_time, data.<a class="code" href="structFound__data.html#m1">sample_rate</a>,
00273                                   (<span class="keywordtype">long</span>) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>))))
00274           {
00275         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_next: error starting new Seisan channel\n"</span>);
00276         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00277           }
00278         }
00279 
00280         <span class="comment">/* write the data */</span>
00281         value = <a class="code" href="seihead_8h.html#a0">SEISAN_MISSING_DATA_FLAG</a>;
00282         data_ptr = data.<a class="code" href="structFound__data.html#m2">data</a>;
00283         <span class="keywordflow">for</span> (count=0; count&lt;data.<a class="code" href="structFound__data.html#m0">n_samples</a>; count++)
00284         {
00285           <span class="keywordflow">if</span> (status == <a class="code" href="seihead_8h.html#a1">FD_FOUND_REQUESTED</a>)
00286           {
00287                 <span class="keywordflow">switch</span> (data.<a class="code" href="structFound__data.html#m3">data_type_code</a>)
00288                 {
00289                 <span class="comment">/* write all values into longs regardless of input type */</span>
00290                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a6">FD_SHORT_INT</a>:
00291                   short_val = *((<span class="keywordtype">short</span> *) data_ptr);
00292           value = (long) short_val;
00293                   data_ptr += <span class="keyword">sizeof</span> (short);
00294                   <span class="keywordflow">break</span>;
00295                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a7">FD_LONG_INT</a>:
00296                   value = *((<span class="keywordtype">long</span> *) data_ptr);
00297                   data_ptr += <span class="keyword">sizeof</span> (long);
00298                   <span class="keywordflow">break</span>;
00299                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a8">FD_FLOAT</a>:
00300                   float_val = *((<span class="keywordtype">float</span> *) data_ptr);
00301           value = (long) float_val;
00302                   data_ptr += <span class="keyword">sizeof</span> (float);
00303                   <span class="keywordflow">break</span>;
00304                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a9">FD_DOUBLE</a>:
00305                   double_val = *((<span class="keywordtype">double</span> *) data_ptr);
00306           value = (long) double_val;
00307                   data_ptr += <span class="keyword">sizeof</span> (double);
00308                   <span class="keywordflow">break</span>;
00309                 }
00310           }
00311       <a class="code" href="seiutils_8c.html#a15">add_seisan_channel_data</a> (1, &amp;value);
00312         }
00313   }
00314 
00315   <span class="comment">/* stop writing on this channel and fill in any gap at the end of the data */</span>
00316   <a class="code" href="seiutils_8c.html#a16">end_seisan_channel</a> ();
00317 
00318   <span class="keywordflow">if</span> (debug)
00319   {
00320     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Successful completion of SEIPA_next\n"</span>);
00321   }
00322   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00323 
00324 }
00325 
00326 
00327 <span class="comment">/************************************************************************</span>
00328 <span class="comment"> * SEIPA_end_ev</span>
00329 <span class="comment"> *</span>
00330 <span class="comment"> * Description: called when an event has been completely processed</span>
00331 <span class="comment"> *</span>
00332 <span class="comment"> * Input parameters: debug - flag for debugging output</span>
00333 <span class="comment"> * Output parameters: none</span>
00334 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00335 <span class="comment"> *</span>
00336 <span class="comment"> * Comments:</span>
00337 <span class="comment"> *</span>
00338 <span class="comment"> *****************************************************************************/</span>
<a name="l00339"></a><a class="code" href="seiputaway_8c.html#a4">00339</a> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a4">SEIPA_end_ev</a> (<span class="keywordtype">int</span> debug)
00340 
00341 {
00342 
00343   <span class="keywordtype">int</span> ret_val;
00344 
00345 
00346   <span class="keywordflow">if</span> (debug)
00347   {
00348     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering SEIPA_end_ev\n"</span>);
00349   }
00350   ret_val = <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00351 
00352   <span class="comment">/* check and close the Seisan file */</span>
00353   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a17">close_seisan_file</a> ())
00354   {
00355     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_end_ev: error writing to Seisan file\n"</span>);
00356     ret_val = <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00357   }
00358 
00359   <span class="keywordflow">return</span> ret_val;
00360 
00361 }
00362 
00363 <span class="comment">/************************************************************************</span>
00364 <span class="comment"> * SEIPA_close</span>
00365 <span class="comment"> *</span>
00366 <span class="comment"> * Description: called at program shutdown</span>
00367 <span class="comment"> *</span>
00368 <span class="comment"> * Input parameters: debug - flag for debugging output</span>
00369 <span class="comment"> * Output parameters: none</span>
00370 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00371 <span class="comment"> *</span>
00372 <span class="comment"> * Comments:</span>
00373 <span class="comment"> *</span>
00374 <span class="comment"> *****************************************************************************/</span>
<a name="l00375"></a><a class="code" href="seiputaway_8c.html#a5">00375</a> <span class="keywordtype">int</span> <a class="code" href="seiputaway_8c.html#a5">SEIPA_close</a> (<span class="keywordtype">int</span> debug)
00376 {
00377 
00378   <span class="keywordflow">if</span> (debug)
00379   {
00380     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering SEIPA_close\n"</span>);
00381   }
00382 
00383   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00384 
00385 }
00386 
00387 
00388 
00389 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:09 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
