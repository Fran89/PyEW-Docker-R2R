<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gseputaway.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>gseputaway.c</h1><a href="gseputaway_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/******************************************************************</span>
00002 <span class="comment"> * gseputaway.c - routines to enable GSE data to be stored from</span>
00003 <span class="comment"> *                Earthworm</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * S. Flower, Feb 2001</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Modified 11 Oct 2001 - instead of writing direct to the GSE</span>
00008 <span class="comment"> * file we write to a temporary file and rename it when it is</span>
00009 <span class="comment"> * complete - this ensures that the file can be read OK as soon</span>
00010 <span class="comment"> * as it is available.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * Modified 11 Oct 2001 - removed the check that all requested</span>
00013 <span class="comment"> * channels had been written - GSE can cope if there are missing</span>
00014 <span class="comment"> * channels and the check was deleting files if all channels were</span>
00015 <span class="comment"> * not present.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * Modified 26 Oct 2001 - fixed bug that puts gaps at wrong end</span>
00018 <span class="comment"> * of output traces</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> * Modified 31st Jan 2002 - new routines to make dealing with</span>
00021 <span class="comment"> * earthworm data structures easier to follow (pa_find_data())</span>
00022 <span class="comment"> ******************************************************************/</span>
00023 
00024 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00025 <span class="preprocessor">#include &lt;time.h&gt;</span>
00026 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00027 <span class="preprocessor">#include &lt;string.h&gt;</span>
00028 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00029 <span class="preprocessor">#include &lt;math.h&gt;</span>
00030 <span class="preprocessor">#if defined (_WINNT)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;process.h&gt;</span>
00032 <span class="preprocessor">#include &lt;io.h&gt;</span>
00033 <span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00037 
00038 <span class="preprocessor">#include "<a class="code" href="earthworm_8h.html">earthworm.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="earthworm__defs_8h.html">earthworm_defs.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="trace__buf_8h.html">trace_buf.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="swap_8h.html">swap.h</a>"</span>
00042 <span class="preprocessor">#include "<a class="code" href="ws__clientII_8h.html">ws_clientII.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="site_8h.html">site.h</a>"</span>
00044 <span class="preprocessor">#include "<a class="code" href="time__ew_8h.html">time_ew.h</a>"</span>
00045 
00046 <span class="preprocessor">#include "<a class="code" href="gsehead_8h.html">gsehead.h</a>"</span>
00047 <span class="preprocessor">#include "<a class="code" href="seihead_8h.html">seihead.h</a>"</span>
00048 
00049 
00050 <span class="comment">/* the value used to represent missing data in GSE */</span>
<a name="l00051"></a><a class="code" href="gseputaway_8c.html#a0">00051</a> <span class="preprocessor">#define GSE_MISSING_DATA_FLAG           0</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">/* private global variables */</span>
<a name="l00054"></a><a class="code" href="gseputaway_8c.html#a1">00054</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="gseputaway_8c.html#a1">line_terminator</a>;
<a name="l00055"></a><a class="code" href="gseputaway_8c.html#a2">00055</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="gseputaway_8c.html#a2">file_open_mode</a>;
<a name="l00056"></a><a class="code" href="gseputaway_8c.html#a3">00056</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="gseputaway_8c.html#a3">gse_filename</a> [<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];
<a name="l00057"></a><a class="code" href="gseputaway_8c.html#a4">00057</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="gseputaway_8c.html#a4">tmp_filename</a> [<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];
<a name="l00058"></a><a class="code" href="gseputaway_8c.html#a5">00058</a> <span class="keyword">static</span> FILE *<a class="code" href="gseputaway_8c.html#a5">gse_fp</a>;
<a name="l00059"></a><a class="code" href="gseputaway_8c.html#a6">00059</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a6">new_data_channel</a>;
<a name="l00060"></a><a class="code" href="gseputaway_8c.html#a7">00060</a> <span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="gseputaway_8c.html#a7">channel_checksum</a> = 0l;
<a name="l00061"></a><a class="code" href="gseputaway_8c.html#a8">00061</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a8">data_line_length</a>;
<a name="l00062"></a><a class="code" href="gseputaway_8c.html#a9">00062</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a9">n_channels</a>, <a class="code" href="gseputaway_8c.html#a10">channels_written</a>;
00063 
00064 <span class="comment">/* private forward declarations */</span>
00065 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a11">open_gse_file</a> (<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *msg_id, <span class="keywordtype">char</span> *sta_code);
00066 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a12">write_gse_channel_header</a> (<span class="keywordtype">int</span> start_year, <span class="keywordtype">int</span> start_month, <span class="keywordtype">int</span> start_day,
00067                                      <span class="keywordtype">int</span> start_hour, <span class="keywordtype">int</span> start_min, <span class="keywordtype">double</span> start_sec,
00068                                      <span class="keywordtype">char</span> *chan_name, <span class="keywordtype">char</span> *chan_type, <span class="keywordtype">char</span> *aux_id,
00069                                      <span class="keywordtype">long</span> n_samps,
00070                                      <span class="keywordtype">double</span> frequency, <span class="keywordtype">double</span> calib_value,
00071                                      <span class="keywordtype">double</span> calib_period, <span class="keywordtype">char</span> *instrum_name,
00072                                      <span class="keywordtype">double</span> horiz_angle, <span class="keywordtype">double</span> vert_angle);
00073 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a13">write_gse_channel_data</a> (<span class="keywordtype">int</span> n_samps, <span class="keywordtype">long</span> *data);
00074 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a14">write_gse_channel_trailer</a> (<span class="keywordtype">void</span>);
00075 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a15">close_gse_file</a> (<span class="keywordtype">void</span>);
00076 
00077 
00078 
00079 <span class="comment">/**********************************************************************</span>
00080 <span class="comment"> * GSEPA_init</span>
00081 <span class="comment"> *</span>
00082 <span class="comment"> * Description: initialise GSE put away routines</span>
00083 <span class="comment"> *</span>
00084 <span class="comment"> * Input parameters: output_dir - the directory to be used for GSE</span>
00085 <span class="comment"> *                                output files</span>
00086 <span class="comment"> *                   output_format - "intel" or "sparc" for line termination</span>
00087 <span class="comment"> *                   debug - flag for debugging output</span>
00088 <span class="comment"> * Output parameters: none</span>
00089 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00090 <span class="comment"> *</span>
00091 <span class="comment"> * Comments:</span>
00092 <span class="comment"> *</span>
00093 <span class="comment"> ***********************************************************************/</span>
<a name="l00094"></a><a class="code" href="gseputaway_8c.html#a16">00094</a> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a16">GSEPA_init</a> (<span class="keywordtype">char</span> *output_dir, <span class="keywordtype">char</span> *output_format, <span class="keywordtype">int</span> debug)
00095 
00096 {
00097     
00098   <span class="keywordflow">if</span> (debug)
00099   {
00100     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering GSEPA_init, output dir: %s\n"</span>, output_dir);
00101   }
00102 
00103   <span class="comment">/* make sure that the output directory exists */</span>
00104   <span class="keywordflow">if</span> (<a class="code" href="dirops__ew_8c.html#a1">CreateDir</a> (output_dir) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00105   {
00106     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_init: Call to CreateDir failed\n"</span>);
00107     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00108   }
00109 
00110 <span class="preprocessor">#if defined (_INTEL)</span>
00111 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"intel"</span>))
00112   {
00113     <a class="code" href="gseputaway_8c.html#a1">line_terminator</a> = <span class="stringliteral">"\n"</span>;
00114     <a class="code" href="gseputaway_8c.html#a2">file_open_mode</a> = <span class="stringliteral">"w"</span>;
00115   }
00116   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"sparc"</span>))
00117   {
00118     <a class="code" href="gseputaway_8c.html#a1">line_terminator</a> = <span class="stringliteral">"\n"</span>;
00119     <a class="code" href="gseputaway_8c.html#a2">file_open_mode</a> = <span class="stringliteral">"wb"</span>;
00120   }
00121   <span class="keywordflow">else</span>
00122   {
00123     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_init: can't recognise OutputFormat (%s)\n"</span>, output_format);
00124     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00125   }
00126 <span class="preprocessor">#elif defined (_SPARC)</span>
00127 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"sparc"</span>))
00128   {
00129     <a class="code" href="gseputaway_8c.html#a1">line_terminator</a> = <span class="stringliteral">"\n"</span>;
00130     <a class="code" href="gseputaway_8c.html#a2">file_open_mode</a> = <span class="stringliteral">"w"</span>;
00131   }
00132   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! strcmp (output_format, <span class="stringliteral">"intel"</span>))
00133   {
00134     <a class="code" href="gseputaway_8c.html#a1">line_terminator</a> = <span class="stringliteral">"\r\n"</span>;
00135     <a class="code" href="gseputaway_8c.html#a2">file_open_mode</a> = <span class="stringliteral">"wb"</span>;
00136   }
00137   <span class="keywordflow">else</span>
00138   {
00139     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"SEIPA_init: can't recognise OutputFormat (%s)\n"</span>, output_format);
00140     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00141   }
00142 <span class="preprocessor">#else</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#error "_INTEL or _SPARC must be set before compiling"</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00147 
00148 }
00149 
00150 <span class="comment">/****************************************************************************</span>
00151 <span class="comment"> * GSEPA_next_ev</span>
00152 <span class="comment"> *</span>
00153 <span class="comment"> * Description: called when a snippet has been received,</span>
00154 <span class="comment"> *              before it is processed</span>
00155 <span class="comment"> *</span>
00156 <span class="comment"> * Input parameters: trace_req - array of trace reqeust structures</span>
00157 <span class="comment"> *                   n_reqs - size of array</span>
00158 <span class="comment"> *                   output_dir - output directory</span>
00159 <span class="comment"> *                   e_date, e_time - event time in the form</span>
00160 <span class="comment"> *                                    'ccyymmdd' and 'hhmmss.ff'</span>
00161 <span class="comment"> *                   debug - flag for debugging output</span>
00162 <span class="comment"> * Output parameters: none</span>
00163 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00164 <span class="comment"> *</span>
00165 <span class="comment"> * Comments:</span>
00166 <span class="comment"> *</span>
00167 <span class="comment"> ***********************************************************************/</span>
<a name="l00168"></a><a class="code" href="gseputaway_8c.html#a17">00168</a> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a17">GSEPA_next_ev</a> (<a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req, <span class="keywordtype">int</span> n_reqs, <span class="keywordtype">char</span> *output_dir,
00169                    <span class="keywordtype">char</span> *e_date, <span class="keywordtype">char</span> *e_time, <span class="keywordtype">int</span> debug)
00170 {
00171 
00172   <span class="keywordtype">int</span> event_year, event_month, event_day, event_hour, event_min;
00173   <span class="keywordtype">double</span> event_sec;
00174   <span class="keywordtype">char</span> string [100];
00175   <a class="code" href="structTRACE__HEADER.html">TRACE_HEADER</a> *trace_hdr;
00176 
00177   <span class="keyword">static</span> <span class="keywordtype">int</span> tmp_file_count = 0;
00178 
00179 
00180   <span class="keywordflow">if</span> (debug)
00181   {
00182     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering GSEPA_next_ev, date/time: %s %s\n"</span>, e_date, e_time);
00183   }
00184 
00185   <span class="comment">/* parse and store the date/time - we assume that it doesn't need to</span>
00186 <span class="comment">   * be checked for validity - I don't know if that is correct */</span>
00187   strcpy (string, e_date);
00188   event_day = atoi (&amp;string[6]);
00189   string[6] = <span class="charliteral">'\0'</span>;
00190   event_month = atoi (&amp;string[4]);
00191   string[4] = <span class="charliteral">'\0'</span>;
00192   event_year = atoi (string);
00193   strcpy (string, e_time);
00194   event_sec = atof (&amp;string[4]);
00195   string[4] = <span class="charliteral">'\0'</span>;
00196   event_min = atoi (&amp;string[2]);
00197   string[2] = <span class="charliteral">'\0'</span>;
00198   event_hour = atoi (string);
00199   
00200   <span class="comment">/* use the temporary file as the output file - we will rename it to the proper GSE file name</span>
00201 <span class="comment">   * when it is complete and closed */</span>
00202   sprintf (tmp_filename, <span class="stringliteral">"%s%c%d_%d_gse.tmp"</span>,
00203            output_dir, DIR_DELIM, getpid (), tmp_file_count ++);
00204   sprintf (gse_filename, <span class="stringliteral">"%s%c%04d_%02d_%02d_%02d_%02d_%02.0f.gse"</span>,
00205            output_dir, DIR_DELIM, event_year, event_month, event_day,
00206            event_hour, event_min, event_sec);
00207 
00208   <span class="comment">/* open the GSE file */</span>
00209   trace_hdr = (<a class="code" href="structTRACE__HEADER.html">TRACE_HEADER</a> *) trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a>;
00210   <span class="keywordflow">if</span> (! <a class="code" href="gseputaway_8c.html#a11">open_gse_file</a> (tmp_filename, <span class="stringliteral">"EW"</span>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>))
00211   {
00212     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_init: unable to open GSE output file\n"</span>);
00213     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00214   }
00215 
00216   <span class="comment">/* store tracking information */</span>
00217   <a class="code" href="gseputaway_8c.html#a9">n_channels</a> = n_reqs;
00218   <a class="code" href="gseputaway_8c.html#a10">channels_written</a> = 0;
00219 
00220   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00221 
00222 }
00223 
00224 <span class="comment">/*****************************************************************************</span>
00225 <span class="comment"> * GSEPA_next</span>
00226 <span class="comment"> *</span>
00227 <span class="comment"> * Description: called once for each trace to be put away</span>
00228 <span class="comment"> *</span>
00229 <span class="comment"> * Input parameters: trace_req - the data to be stored</span>
00230 <span class="comment"> *                   gap_thresh - size of any gap in seconds</span>
00231 <span class="comment"> *                   debug - flag for debugging output</span>
00232 <span class="comment"> * Output parameters: none</span>
00233 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00234 <span class="comment"> *</span>
00235 <span class="comment"> * Comments: see pa_find_data()</span>
00236 <span class="comment"> *</span>
00237 <span class="comment"> *****************************************************************************/</span>
<a name="l00238"></a><a class="code" href="gseputaway_8c.html#a18">00238</a> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a18">GSEPA_next</a> (<a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req, <span class="keywordtype">double</span> gap_thresh, <span class="keywordtype">int</span> debug)
00239 
00240 {
00241 
00242   <span class="keywordtype">int</span> status, loop_count;
00243   <span class="keywordtype">short</span> short_val;
00244   <span class="keywordtype">long</span> value, count;
00245   <span class="keywordtype">float</span> float_val;
00246   <span class="keywordtype">double</span> sample_time, double_val, data_end_time;
00247   <span class="keywordtype">char</span> *data_ptr;
00248   <span class="keyword">struct </span><a class="code" href="structFound__data.html">Found_data</a> data;
00249   time_t ltime;
00250   <span class="keyword">struct </span>tm unix_time;
00251 
00252 
00253   <span class="keywordflow">if</span> (debug) <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering GSEPA_next\n"</span>);
00254 
00255   <span class="comment">/* loop over the requested times for the data - the test for n_samples==0</span>
00256 <span class="comment">   * is an emergency condition that could happen with very bad floating point</span>
00257 <span class="comment">   * rounding errors (very unlikely though) */</span>
00258   data.<a class="code" href="structFound__data.html#m0">n_samples</a> = 1;
00259   <span class="keywordflow">for</span> (sample_time = trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>, loop_count = 0;
00260        (sample_time &lt; trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>) &amp;&amp; (data.<a class="code" href="structFound__data.html#m0">n_samples</a> &gt; 0);
00261            sample_time += ((double) data.<a class="code" href="structFound__data.html#m0">n_samples</a> / data.<a class="code" href="structFound__data.html#m1">sample_rate</a>), loop_count ++)
00262   {
00263     <span class="comment">/* get the data for this time */</span>
00264     status = <a class="code" href="seiutils_8c.html#a18">pa_find_data</a> (trace_req, sample_time, &amp;data);
00265     <span class="keywordflow">switch</span> (status)
00266         {
00267     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a1">FD_FOUND_REQUESTED</a>:
00268     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a2">FD_FOUND_GAP</a>:
00269           <span class="keywordflow">break</span>;
00270     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a3">FD_NO_MORE_DATA</a>:
00271       <span class="comment">/* if no data has been found on previous calls, then exit</span>
00272 <span class="comment">           * so that no data will be recorded for this channel */</span>
00273           <span class="keywordflow">if</span> (sample_time == trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00274 
00275           <span class="comment">/* otherwise calculate the size of the gap to the end of requested data */</span>
00276           data.<a class="code" href="structFound__data.html#m0">n_samples</a> = (long) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - sample_time));
00277           <span class="keywordflow">break</span>;
00278 
00279     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a4">FD_BAD_DATATYPE</a>:
00280       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_next: unrecognised data type code, skipping this scn: %s.%s.%s\n"</span>,
00281             trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>);
00282       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00283 
00284     <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a5">FD_CHANGED_SRATE</a>:
00285       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_next: bad sample rate, skipping this scn: %s.%s.%s\n"</span>,
00286             trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>);
00287       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00288         }
00289 
00290     <span class="comment">/* adjust the number of samples to ensure it doesn't go beyond the end time */</span>
00291         data_end_time = sample_time + ((double) data.<a class="code" href="structFound__data.html#m0">n_samples</a> / data.<a class="code" href="structFound__data.html#m1">sample_rate</a>);
00292         <span class="keywordflow">if</span> (data_end_time &gt; trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>)
00293           data.<a class="code" href="structFound__data.html#m0">n_samples</a> = (long) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - sample_time));
00294     <span class="keywordflow">if</span> (debug) <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Loop %d: %s %ld @ %.1lfHz, time %.3lf\n"</span>,
00295                       loop_count, status == FD_FOUND_REQUESTED ? <span class="stringliteral">"samples"</span> : <span class="stringliteral">"gap"</span>,
00296                                           data.<a class="code" href="structFound__data.html#m0">n_samples</a>, data.<a class="code" href="structFound__data.html#m1">sample_rate</a>, sample_time);
00297 
00298     <span class="comment">/* on the first time write the gse channel header */</span>
00299     <span class="keywordflow">if</span> (sample_time == trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>)
00300         {
00301       ltime = (time_t) sample_time;
00302       <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a> (&amp;ltime, &amp;unix_time);
00303       <span class="keywordflow">if</span> (! <a class="code" href="gseputaway_8c.html#a12">write_gse_channel_header</a> (unix_time.tm_year + 1900, unix_time.tm_mon +1,
00304                                       unix_time.tm_mday, unix_time.tm_hour, unix_time.tm_min,
00305                                       ((<span class="keywordtype">double</span>) unix_time.tm_sec) + (sample_time - (<span class="keywordtype">double</span>) ltime),
00306                                       trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, <span class="stringliteral">"-"</span>,
00307                                       (<span class="keywordtype">long</span>) (data.<a class="code" href="structFound__data.html#m1">sample_rate</a> * (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> - trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>)),
00308                                                                       data.<a class="code" href="structFound__data.html#m1">sample_rate</a>, -1.0, -1.0, <span class="stringliteral">"-"</span>, -1.0, -1.0))
00309           {
00310         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_next: error starting new GSE channel\n"</span>);
00311         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00312           }
00313         }
00314 
00315         <span class="comment">/* write the data */</span>
00316         value = <a class="code" href="gseputaway_8c.html#a0">GSE_MISSING_DATA_FLAG</a>;
00317         data_ptr = data.<a class="code" href="structFound__data.html#m2">data</a>;
00318         <span class="keywordflow">for</span> (count=0; count&lt;data.<a class="code" href="structFound__data.html#m0">n_samples</a>; count++)
00319         {
00320           <span class="keywordflow">if</span> (status == <a class="code" href="seihead_8h.html#a1">FD_FOUND_REQUESTED</a>)
00321           {
00322                 <span class="keywordflow">switch</span> (data.<a class="code" href="structFound__data.html#m3">data_type_code</a>)
00323                 {
00324                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a6">FD_SHORT_INT</a>:
00325                   short_val = *((<span class="keywordtype">short</span> *) data_ptr);
00326           value = (long) short_val;
00327                   data_ptr += <span class="keyword">sizeof</span> (short);
00328                   <span class="keywordflow">break</span>;
00329                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a7">FD_LONG_INT</a>:
00330                   value = *((<span class="keywordtype">long</span> *) data_ptr);
00331                   data_ptr += <span class="keyword">sizeof</span> (long);
00332                   <span class="keywordflow">break</span>;
00333                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a8">FD_FLOAT</a>:
00334                   float_val = *((<span class="keywordtype">float</span> *) data_ptr);
00335           value = (long) float_val;
00336                   data_ptr += <span class="keyword">sizeof</span> (float);
00337                   <span class="keywordflow">break</span>;
00338                 <span class="keywordflow">case</span> <a class="code" href="seihead_8h.html#a9">FD_DOUBLE</a>:
00339                   double_val = *((<span class="keywordtype">double</span> *) data_ptr);
00340           value = (long) double_val;
00341                   data_ptr += <span class="keyword">sizeof</span> (double);
00342                   <span class="keywordflow">break</span>;
00343                 }
00344           }
00345       <a class="code" href="gseputaway_8c.html#a13">write_gse_channel_data</a> (1, &amp;value);
00346         }
00347   }
00348 
00349   <span class="comment">/* stop writing on this channel and fill in any gap at the end of the data */</span>
00350   <a class="code" href="gseputaway_8c.html#a14">write_gse_channel_trailer</a> ();
00351 
00352   <span class="keywordflow">if</span> (debug)
00353   {
00354     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Successful completion of GSEPA_next\n"</span>);
00355   }
00356   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00357 
00358 }
00359 
00360 <span class="comment">/************************************************************************</span>
00361 <span class="comment"> * GSEPA_end_ev</span>
00362 <span class="comment"> *</span>
00363 <span class="comment"> * Description: called when an event has been completely processed</span>
00364 <span class="comment"> *</span>
00365 <span class="comment"> * Input parameters: debug - flag for debugging output</span>
00366 <span class="comment"> * Output parameters: none</span>
00367 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00368 <span class="comment"> *</span>
00369 <span class="comment"> * Comments:</span>
00370 <span class="comment"> *</span>
00371 <span class="comment"> *****************************************************************************/</span>
<a name="l00372"></a><a class="code" href="gseputaway_8c.html#a19">00372</a> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a19">GSEPA_end_ev</a> (<span class="keywordtype">int</span> debug)
00373 
00374 {
00375 
00376   <span class="keywordtype">int</span> ret_val;
00377 
00378 
00379   ret_val = <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00380 
00381   <span class="comment">/* check and close the GSE file */</span>
00382   <span class="keywordflow">if</span> (! <a class="code" href="gseputaway_8c.html#a15">close_gse_file</a> ())
00383   {
00384     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_end_ev: error writing to GSE file\n"</span>);
00385     ret_val = <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00386   }
00387 
00388   <span class="comment">/* rename the temporary file to the proper GSE file name - the return value from</span>
00389 <span class="comment">   * rename_ew() doesn't appear reliable, so check for the existence of the renamed</span>
00390 <span class="comment">   * file after the rename operation */</span>
00391   <span class="keywordflow">if</span> (ret_val == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00392   {
00393     <a class="code" href="dirops__ew_8c.html#a4">rename_ew</a> (tmp_filename, gse_filename);
00394     <span class="keywordflow">if</span> (access (gse_filename, 0))
00395     {
00396       <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_end_ev: unable to rename file (%s) to (%s)\n"</span>, tmp_filename, gse_filename);
00397       ret_val = <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00398     }
00399   }
00400 
00401   <span class="comment">/* if there was an error, delete the file */</span>
00402   <span class="keywordflow">if</span> (ret_val != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00403   {
00404     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GSEPA_end_ev: output file is being deleted (%s)\n"</span>, tmp_filename);
00405     remove (tmp_filename);
00406   }
00407 
00408   <span class="keywordflow">return</span> ret_val;
00409 
00410 }
00411 
00412 <span class="comment">/************************************************************************</span>
00413 <span class="comment"> * GSEPA_close</span>
00414 <span class="comment"> *</span>
00415 <span class="comment"> * Description: called at program shutdown</span>
00416 <span class="comment"> *</span>
00417 <span class="comment"> * Input parameters: debug - flag for debugging output</span>
00418 <span class="comment"> * Output parameters: none</span>
00419 <span class="comment"> * Returns: EW_SUCCESS or EW_FAILURE</span>
00420 <span class="comment"> *</span>
00421 <span class="comment"> * Comments:</span>
00422 <span class="comment"> *</span>
00423 <span class="comment"> *****************************************************************************/</span>
<a name="l00424"></a><a class="code" href="gseputaway_8c.html#a20">00424</a> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a20">GSEPA_close</a> (<span class="keywordtype">int</span> debug)
00425 {
00426 
00427   <span class="keywordflow">if</span> (debug)
00428   {
00429     <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Entering GSEPA_close: \n"</span>);
00430   }
00431 
00432   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00433 
00434 }
00435 
00436 
00437 <span class="comment">/************************************************************************</span>
00438 <span class="comment"> ************************************************************************</span>
00439 <span class="comment"> * All code below this point is private to this file</span>
00440 <span class="comment"> ************************************************************************</span>
00441 <span class="comment"> ************************************************************************/</span>
00442 
00443 <span class="comment">/************************************************************************</span>
00444 <span class="comment"> * open_gse_file</span>
00445 <span class="comment"> *</span>
00446 <span class="comment"> * Description: open a GSE file and write the main header for the file</span>
00447 <span class="comment"> *</span>
00448 <span class="comment"> * Input parameters: filename - the file to write</span>
00449 <span class="comment"> *                   msg_id - the message id</span>
00450 <span class="comment"> *                   sta_code - the station code</span>
00451 <span class="comment"> * Output parameters: none</span>
00452 <span class="comment"> * Returns: TRUE if file written OK, FALSE otherwise</span>
00453 <span class="comment"> *</span>
00454 <span class="comment"> * Comments:</span>
00455 <span class="comment"> *</span>
00456 <span class="comment"> ************************************************************************/</span>
<a name="l00457"></a><a class="code" href="gseputaway_8c.html#a11">00457</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a11">open_gse_file</a> (<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *msg_id, <span class="keywordtype">char</span> *sta_code)
00458 
00459 {
00460 
00461   <span class="comment">/* attempt to open the file */</span>
00462   <a class="code" href="gseputaway_8c.html#a5">gse_fp</a> = fopen (filename, file_open_mode);
00463   <span class="keywordflow">if</span> (! <a class="code" href="gseputaway_8c.html#a5">gse_fp</a>) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00464 
00465   <span class="comment">/* write the GSE header */</span>
00466   fprintf (gse_fp, <span class="stringliteral">"BEGIN GSE2.0%s"</span>, line_terminator);
00467   fprintf (gse_fp, <span class="stringliteral">"MSG_TYPE DATA%s"</span>, line_terminator);
00468   fprintf (gse_fp, <span class="stringliteral">"MSG_ID %s %s%s"</span>, msg_id, sta_code, line_terminator);
00469   fprintf (gse_fp, <span class="stringliteral">"DATA_TYPE WAVEFORM GSE2.0%s"</span>, line_terminator);
00470 
00471   <span class="comment">/* check the file */</span>
00472   <span class="keywordflow">if</span> (ferror (gse_fp)) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00473   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00474 
00475 }
00476 
00477 <span class="comment">/************************************************************************</span>
00478 <span class="comment"> * write_gse_channel_header</span>
00479 <span class="comment"> *</span>
00480 <span class="comment"> * Description: write a GSE channel header</span>
00481 <span class="comment"> *</span>
00482 <span class="comment"> * Input parameters: start_year, month, day - the date of the data</span>
00483 <span class="comment"> *                   start_hour, min, sec - the time of the data</span>
00484 <span class="comment"> *                   chan_name, type - the channel name and type</span>
00485 <span class="comment"> *                                     (e.g. EKR1, SZ)</span>
00486 <span class="comment"> *                   aux_id - auxiliary identification code</span>
00487 <span class="comment"> *                   n_samps - number of samples in the following data block</span>
00488 <span class="comment"> *                   frequency - the recording frequency (hz)</span>
00489 <span class="comment"> *                   calib_value, calib_period - calibration details</span>
00490 <span class="comment"> *                   instrum_name - GSE code for the sensor type</span>
00491 <span class="comment"> *                   horiz_angle, vert_angle - sensor orientation</span>
00492 <span class="comment"> * Output parameters: none</span>
00493 <span class="comment"> * Returns: TRUE if file written OK, FALSE otherwise</span>
00494 <span class="comment"> *</span>
00495 <span class="comment"> * Comments:</span>
00496 <span class="comment"> *</span>
00497 <span class="comment"> ************************************************************************/</span>
<a name="l00498"></a><a class="code" href="gseputaway_8c.html#a12">00498</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a12">write_gse_channel_header</a> (<span class="keywordtype">int</span> start_year, <span class="keywordtype">int</span> start_month, <span class="keywordtype">int</span> start_day,
00499                                      <span class="keywordtype">int</span> start_hour, <span class="keywordtype">int</span> start_min, <span class="keywordtype">double</span> start_sec,
00500                                      <span class="keywordtype">char</span> *chan_name, <span class="keywordtype">char</span> *chan_type, <span class="keywordtype">char</span> *aux_id,
00501                                      <span class="keywordtype">long</span> n_samps,
00502                                      <span class="keywordtype">double</span> frequency, <span class="keywordtype">double</span> calib_value,
00503                                      <span class="keywordtype">double</span> calib_period, <span class="keywordtype">char</span> *instrum_name,
00504                                      <span class="keywordtype">double</span> horiz_angle, <span class="keywordtype">double</span> vert_angle)
00505 
00506 {
00507     
00508   <span class="comment">/* write the header for this channel */</span>
00509   fprintf (gse_fp, <span class="stringliteral">"WID2 %04d/%02d/%02d %02d:%02d:%06.3lf %-5.5s %-3.3s "</span>
00510                <span class="stringliteral">"%-4.4s INT %8ld %11.6lf %10.2le %7.3lf %-6.6s %5.1lf %4.1lf%s"</span>,
00511            start_year, start_month, start_day, start_hour, start_min, start_sec,
00512            chan_name, chan_type, aux_id, n_samps, frequency, calib_value,
00513            calib_period, instrum_name, horiz_angle, vert_angle, line_terminator);
00514   fprintf (gse_fp, <span class="stringliteral">"DAT2%s"</span>, line_terminator);
00515 
00516   <span class="comment">/* flag write_gse_channel_data to expect a new channel */</span>
00517   <a class="code" href="gseputaway_8c.html#a6">new_data_channel</a> = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00518     
00519   <span class="comment">/* check the file */</span>
00520   <span class="keywordflow">if</span> (ferror (gse_fp)) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00521   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00522 
00523 }
00524 
00525 <span class="comment">/************************************************************************</span>
00526 <span class="comment"> * write_gse_channel_data</span>
00527 <span class="comment"> *</span>
00528 <span class="comment"> * Description: write channel data in GSE format</span>
00529 <span class="comment"> *</span>
00530 <span class="comment"> * Input parameters: n_samps - the number of samples to write</span>
00531 <span class="comment"> *                   data - the data to write</span>
00532 <span class="comment"> * Output parameters: none</span>
00533 <span class="comment"> * Returns: TRUE if file written OK, FALSE otherwise</span>
00534 <span class="comment"> *</span>
00535 <span class="comment"> * Comments: This routine may be called more than once if all the data</span>
00536 <span class="comment"> *           is not available at one go - the total number of samples</span>
00537 <span class="comment"> *           written must equal to number of samples declared in the header</span>
00538 <span class="comment"> *</span>
00539 <span class="comment"> ************************************************************************/</span>
<a name="l00540"></a><a class="code" href="gseputaway_8c.html#a13">00540</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a13">write_gse_channel_data</a> (<span class="keywordtype">int</span> n_samps, <span class="keywordtype">long</span> *data)
00541 
00542 {
00543 
00544   <span class="keywordtype">int</span> count, length;
00545   <span class="keywordtype">long</span> value;
00546   <span class="keywordtype">char</span> string [100];
00547 
00548   <span class="keyword">static</span> <span class="keywordtype">long</span> modulo = 100000000;
00549 
00550 
00551   <span class="comment">/* if this is the start of a new channel, reset the sample</span>
00552 <span class="comment">   * counter and the checksum */</span>
00553   <span class="keywordflow">if</span> (new_data_channel)
00554   {
00555     <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> = 0;
00556     <a class="code" href="gseputaway_8c.html#a6">new_data_channel</a> = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00557     <a class="code" href="gseputaway_8c.html#a7">channel_checksum</a> = 0l;
00558   }
00559 
00560   <span class="comment">/* for each data sample ... */</span>
00561   <span class="keywordflow">for</span> (count=0; count&lt;n_samps; count++)
00562   {
00563     <span class="comment">/* format the sample, checking for missing data */</span>
00564     value = *(data + count);
00565     sprintf (string, <span class="stringliteral">"%ld"</span>, value);
00566 
00567     <span class="comment">/* write the sample using an 80 char. line length */</span>
00568     length = strlen (string);
00569     <span class="keywordflow">if</span> ((length + <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> +1) &gt; 80)
00570     {
00571       fprintf (gse_fp, <span class="stringliteral">"%s"</span>, line_terminator);
00572       <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> = 0;
00573     }
00574     <span class="keywordflow">if</span> (<a class="code" href="gseputaway_8c.html#a8">data_line_length</a> &gt; 0)
00575     {
00576       fprintf (gse_fp, <span class="stringliteral">" "</span>);
00577       <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> ++;
00578     }
00579     fprintf (gse_fp, string);
00580     <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> += length;
00581           
00582     <span class="comment">/* accumulate the checksum */</span>
00583     <span class="keywordflow">if</span> (labs (value) &gt;= modulo) value -= (value / modulo) * modulo;
00584     <a class="code" href="gseputaway_8c.html#a7">channel_checksum</a> += value;
00585     <span class="keywordflow">if</span> (labs (channel_checksum) &gt;= modulo)
00586       <a class="code" href="gseputaway_8c.html#a7">channel_checksum</a> -= (<a class="code" href="gseputaway_8c.html#a7">channel_checksum</a> / modulo) * modulo;
00587   }
00588 
00589   <span class="comment">/* check the file */</span>
00590   <span class="keywordflow">if</span> (ferror (gse_fp)) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00591   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00592 
00593 }
00594 
00595 <span class="comment">/************************************************************************</span>
00596 <span class="comment"> * write_gse_channel_trailer</span>
00597 <span class="comment"> *</span>
00598 <span class="comment"> * Description: write trailer info. for a channel</span>
00599 <span class="comment"> *</span>
00600 <span class="comment"> * Input parameters: none</span>
00601 <span class="comment"> * Output parameters: none</span>
00602 <span class="comment"> * Returns: TRUE if file written OK, FALSE otherwise</span>
00603 <span class="comment"> *</span>
00604 <span class="comment"> * Comments:</span>
00605 <span class="comment"> *</span>
00606 <span class="comment"> ************************************************************************/</span>
<a name="l00607"></a><a class="code" href="gseputaway_8c.html#a14">00607</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a14">write_gse_channel_trailer</a> (<span class="keywordtype">void</span>)
00608 
00609 {
00610 
00611   <span class="comment">/* write the checksum for this channel */</span>
00612   <span class="keywordflow">if</span> (<a class="code" href="gseputaway_8c.html#a8">data_line_length</a> &gt; 0)
00613   {
00614     fprintf (gse_fp, <span class="stringliteral">"%s"</span>, line_terminator);
00615     <a class="code" href="gseputaway_8c.html#a8">data_line_length</a> = 0;
00616   }
00617   fprintf (gse_fp, <span class="stringliteral">"CHK2 %d%s"</span>, abs (channel_checksum), line_terminator);
00618 
00619   <span class="comment">/* check the file */</span>
00620   <span class="keywordflow">if</span> (ferror (gse_fp)) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00621   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00622 
00623 }
00624 
00625 <span class="comment">/************************************************************************</span>
00626 <span class="comment"> * close_gse_file</span>
00627 <span class="comment"> *</span>
00628 <span class="comment"> * Description: write trailer info. for a file and close it</span>
00629 <span class="comment"> *</span>
00630 <span class="comment"> * Input parameters: none</span>
00631 <span class="comment"> * Output parameters: none</span>
00632 <span class="comment"> * Returns: TRUE if file written OK, FALSE otherwise</span>
00633 <span class="comment"> *</span>
00634 <span class="comment"> * Comments:</span>
00635 <span class="comment"> *</span>
00636 <span class="comment"> ************************************************************************/</span>
<a name="l00637"></a><a class="code" href="gseputaway_8c.html#a15">00637</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gseputaway_8c.html#a15">close_gse_file</a> (<span class="keywordtype">void</span>)
00638 
00639 {
00640 
00641   <span class="keywordtype">int</span> ret_val;
00642 
00643 
00644   <span class="comment">/* write the GSE trailer */</span>
00645   fprintf (gse_fp, <span class="stringliteral">"STOP%s"</span>, line_terminator);
00646   
00647   <span class="comment">/* check the file */</span>
00648   <span class="keywordflow">if</span> (ferror (gse_fp)) ret_val = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00649   <span class="keywordflow">else</span> ret_val = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00650 
00651   <span class="comment">/* close it and return */</span>
00652   fclose (gse_fp);
00653   <span class="keywordflow">return</span> ret_val;
00654 
00655 }
00656 
00657 
00658 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:03 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
