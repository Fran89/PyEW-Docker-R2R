<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>main.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>main.cpp</h1><a href="main_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// STEP 1: Include the header file for the appropriate server object</span>
00002 <span class="comment">//</span>
00003 <span class="preprocessor">#include "<a class="code" href="server__template_8h.html">server_template.h</a>"</span>
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="comfile_8h.html">comfile.h</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="globalutils_8h.html">globalutils.h</a>&gt;</span>
00008 
00009 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00010 
00011 <span class="comment">//#ifdef _Windows</span>
00012 <span class="comment">//#define WIN32_LEAN_AND_MEAN // Exclude rarely-used stuff from Windows headers</span>
00013 <span class="comment">//#endif</span>
00014 
00015 
00016 
00017 <span class="comment">// a Borland-specific pragma to suppress warnings</span>
00018 <span class="preprocessor">#pragma argsused</span>
<a name="l00019"></a><a class="code" href="main_8cpp.html#a0">00019</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="main_8cpp.html#a0">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[] )
00020 {
00021    <span class="keywordtype">int</span> r_status = <a class="code" href="result__status_8h.html#a2">MSB_RESULT_GOOD</a>;
00022 
00023    <a class="code" href="classTComFileParser.html">TComFileParser</a> * _parser = NULL;
00024 
00025    <span class="keywordflow">try</span>
00026    {
00027 <span class="preprocessor">#ifdef _DEBUG</span>
00028 <span class="preprocessor"></span>      <a class="code" href="classTLogger.html#d0">TLogger::TruncateOnOpen</a>();
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031       <a class="code" href="logit_8c.html#a17">logit_init</a>( argv[0], 0, 1024, 1 );
00032 
00033       <span class="comment">// This read the lookup files specified in the environment.</span>
00034       <a class="code" href="classTGlobalUtils.html">TGlobalUtils</a> _global = <a class="code" href="classTGlobalUtils.html">TGlobalUtils</a>(argv[0]);
00035 
00036 <span class="comment">// STEP 2: Change "ServerTemplate" to the appropriate server object type.</span>
00037 <span class="comment">//</span>
00038       <a class="code" href="classServerTemplate.html">ServerTemplate</a> _server;
00039 
00040 
00041       <span class="comment">// Check command line args</span>
00042       <span class="comment">//</span>
00043       <span class="comment">// Generally</span>
00044       <span class="comment">//</span>
00045       <span class="comment">//     Mode        command line formats</span>
00046       <span class="comment">//     ----        ----------------------</span>
00047       <span class="comment">//     standalone  p</span>
00048       <span class="comment">//                 p c.d</span>
00049       <span class="comment">//</span>
00050       <span class="comment">//     client      p</span>
00051       <span class="comment">//                 p c.d</span>
00052       <span class="comment">//</span>
00053       <span class="comment">//     server      &lt;nothing&gt;</span>
00054       <span class="comment">//                 c.d</span>
00055       <span class="comment">//</span>
00056       <span class="comment">//     module      &lt;nothing&gt;</span>
00057       <span class="comment">//                 c.d</span>
00058       <span class="comment">//</span>
00059       <span class="comment">//       Where:  p   = one or more process parameters</span>
00060       <span class="comment">//               c.d = configuration file</span>
00061       <span class="comment">//</span>
00062       <span class="comment">// If the configuration is not given for server or</span>
00063       <span class="comment">// module modes, will build the name</span>
00064       <span class="comment">// from &lt;server&gt;.GetDefaultConfigFileName()</span>
00065       <span class="comment">// If that is also NULL, then try argv[0].d</span>
00066      
00067       std::string _configfilename;
00068 
00069       std::string _param;
00070 
00071       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _p = 1 ; _p &lt; argc ; _p++ )
00072       {
00073          _param = argv[_p];
00074 
00075          <span class="keywordflow">if</span> ( 2 &lt; _param.length() )
00076          {
00077             <span class="keywordflow">if</span> ( _param.compare( _param.length()-2, 2, <span class="stringliteral">".d"</span> ) == 0 )
00078             {
00079                _configfilename = argv[_p];
00080                _p = argc;
00081             }
00082          }
00083       }
00084 
00085 
00086       <span class="keywordflow">if</span> ( _configfilename.length() == 0 )
00087       {
00088          _configfilename = argv[0];
00089          _configfilename.append( <span class="stringliteral">".d"</span> );
00090       }
00091 
00092       <span class="keywordflow">if</span> ( (_parser = <span class="keyword">new</span> <a class="code" href="classTComFileParser.html">TComFileParser</a>()) == NULL )
00093       {
00094          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating TComFileParser to parse configuration file"</span>);
00095       }
00096 
00097       <span class="keywordflow">if</span> ( ! _parser-&gt;<a class="code" href="classTComFileParser.html#a2">Open</a>(_configfilename.c_str()) )
00098       {
00099          <span class="keywordtype">char</span> _msg[80];
00100          sprintf( _msg, <span class="stringliteral">"Failed opening configuration file %s"</span>, _configfilename.c_str() );
00101          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(_msg);
00102       }
00103 
00104 
00105       <span class="keywordtype">bool</span> _reading = <span class="keyword">true</span>;
00106 
00107       <span class="keywordtype">char</span> * _token;
00108 
00109       <span class="keywordflow">do</span>
00110       {
00111           <span class="keywordflow">switch</span>( _parser-&gt;<a class="code" href="classTComFileParser.html#a5">ReadLine</a>() )
00112           {
00113             <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>:  <span class="comment">// eof</span>
00114                  _reading = <span class="keyword">false</span>;
00115                  <span class="keywordflow">break</span>;
00116 
00117             <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>: <span class="comment">// error</span>
00118                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"error returned by TComFileParser::ReadLine()"</span>);
00119 
00120             <span class="keywordflow">case</span> 0:  <span class="comment">// empty line, TComFileParser should not return this</span>
00121                  <span class="keywordflow">break</span>;
00122 
00123             <span class="keywordflow">default</span>:
00124 
00125                  <span class="comment">// Get the command into _token</span>
00126                  _token = _parser-&gt;<a class="code" href="classConfigSource.html#a5">NextToken</a>();
00127 
00128                  <span class="comment">// check if module .d commands override globals (logging level, etc.)</span>
00129                  <span class="comment">//</span>
00130                  <span class="keywordflow">if</span> ( _global.<a class="code" href="classTGlobalUtils.html#a1">HandleConfigLine</a>(_parser) != <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00131                  {
00132                     <span class="keywordflow">continue</span>;
00133                  }
00134 
00135                  <span class="keywordflow">if</span> ( _server.<a class="code" href="classServerTemplate.html#a0">HandleConfigLine</a>(_parser) == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00136                  {
00137                     <span class="comment">// Not handled by this, the global config, or the server.</span>
00138                     <span class="comment">//</span>
00139                     <span class="comment">// Don't throw an error here because the server will be queried about</span>
00140                     <span class="comment">// it's readiness shortly, and it is preferable to report all error</span>
00141                     <span class="comment">// in the config file.</span>
00142                     <span class="comment">//</span>
00143                     <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00144                                   , <span class="stringliteral">"main(): unrecognized config file parameter: %s\n"</span>
00145                                   , _token
00146                                   );
00147                     <span class="keywordflow">continue</span>;
00148                  }
00149           }
00150       } <span class="keywordflow">while</span>( _reading );
00151 
00152       <span class="keyword">delete</span>( _parser );
00153       _parser = NULL;
00154 
00155 
00156       <span class="keywordflow">if</span> ( ! _global.<a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00157       {
00158          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Global utilities not configured properly"</span>);
00159       }
00160 
00161       <span class="keywordflow">if</span> ( ! _server.<a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00162       {
00163           <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server component not configured properly"</span>);
00164       }
00165 
00166       <span class="keywordflow">switch</span> ( _server.<a class="code" href="classMutableServerBase.html#a4">Run</a>( argc, argv ) )
00167       {
00168         <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>:
00169              <span class="keywordflow">break</span>;
00170         <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>:
00171              r_status = <a class="code" href="result__status_8h.html#a3">MSB_RESULT_FAIL</a>;
00172              <span class="keywordflow">break</span>;
00173         <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>:
00174              <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"ServerTemplate::Run() returned error"</span>);
00175       }
00176       
00177    }
00178    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00179    {
00180       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00181                    , <span class="stringliteral">"main(): Exiting due to\n%s\n"</span>
00182                    , _we.what()
00183                    );
00184       r_status = <a class="code" href="result__status_8h.html#a1">MSB_RESULT_ERROR</a>;
00185    }
00186 
00187    <span class="keywordflow">if</span> ( _parser != NULL )
00188    {
00189       <span class="keyword">delete</span>( _parser ) ;
00190    }
00191 
00192    <a class="code" href="classTLogger.html#d2">TLogger::Close</a>();
00193 
00194    <span class="keywordflow">return</span> r_status;
00195 }
00196 <span class="comment">//---------------------------------------------------------------------------</span>
00197 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:04 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
