<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>comfile.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>comfile.cpp</h1><a href="comfile_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 
00003 <span class="preprocessor">#include "<a class="code" href="comfile_8h.html">comfile.h</a>"</span>
00004 
00005 
00006 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00007"></a><a class="code" href="classTComFileParser.html#a0">00007</a> <a class="code" href="classTComFileParser.html#a0">TComFileParser::TComFileParser</a>()
00008 {
00009    <a class="code" href="classConfigSource.html#n0">ReadMode</a>       = <a class="code" href="comfile_8h.html#a1">CS_MODE_FILE</a>;
00010    <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>  = 0;
00011    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _f = 0 ; _f &lt; <a class="code" href="comfile_8h.html#a0">MAX_COM_FILE</a> ; _f++ )
00012    {
00013       <a class="code" href="classTComFileParser.html#n0">files</a>[_f] = NULL;
00014    }
00015 }
00016 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00017"></a><a class="code" href="classTComFileParser.html#a1">00017</a> <a class="code" href="classTComFileParser.html#a1">TComFileParser::~TComFileParser</a>()
00018 {
00019 }
00020 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00021"></a><a class="code" href="classTComFileParser.html#a2">00021</a> <span class="keywordtype">bool</span> <a class="code" href="classTComFileParser.html#a2">TComFileParser::Open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* p_filename)  <span class="comment">// open first file</span>
00022 {
00023    <a class="code" href="classTComFileParser.html#a4">Close</a>();
00024    <a class="code" href="classConfigSource.html#n2">LastError</a> = 0;
00025    strcpy( LastMessage, <span class="stringliteral">""</span> );
00026    <a class="code" href="classTComFileParser.html#n4">eof</a> = <span class="keyword">false</span>;
00027    <span class="keywordflow">if</span>( (<a class="code" href="classTComFileParser.html#n0">files</a>[<a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>] = fopen( p_filename, <span class="stringliteral">"r"</span>)) == NULL )
00028    {
00029       sprintf( LastMessage, <span class="stringliteral">"File &lt;%s&gt; not found.\n"</span>, p_filename );
00030       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00031    }
00032    <a class="code" href="classConfigSource.html#n0">ReadMode</a> = <a class="code" href="comfile_8h.html#a1">CS_MODE_FILE</a>;
00033    <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>++;  <span class="comment">// now 1</span>
00034    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00035 }
00036 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00037"></a><a class="code" href="classTComFileParser.html#a3">00037</a> <span class="keywordtype">bool</span> <a class="code" href="classTComFileParser.html#a3">TComFileParser::DesignateArchive</a>(FILE* p_file)
00038 {
00039    <span class="keywordflow">if</span> ( p_file == NULL )
00040    {
00041       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00042    }
00043         <a class="code" href="classConfigSource.html#n0">ReadMode</a> = <a class="code" href="comfile_8h.html#a2">CS_MODE_ARCHIVE</a>;
00044         <a class="code" href="classTComFileParser.html#n4">eof</a> = <span class="keyword">false</span>;
00045         <a class="code" href="classTComFileParser.html#n2">Archive</a> = p_file;
00046         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00047 }
00048 <span class="comment">//---------------------------------------------------------------------------</span>
00049 <span class="comment">// close all opened files</span>
<a name="l00050"></a><a class="code" href="classTComFileParser.html#a4">00050</a> <span class="keywordtype">void</span> <a class="code" href="classTComFileParser.html#a4">TComFileParser::Close</a>()
00051 {
00052    <span class="keywordflow">while</span>( 0 &lt; <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a> )
00053    {
00054       <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>--;
00055       <span class="keywordflow">if</span> ( <a class="code" href="classTComFileParser.html#n0">files</a>[<a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>] != NULL )
00056       {
00057                  fclose( files[OpenFileCount] );
00058          <a class="code" href="classTComFileParser.html#n0">files</a>[<a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>] = NULL;
00059       }
00060    }
00061 }
00062 <span class="comment">//---------------------------------------------------------------------------</span>
00063 <span class="comment">//</span>
00064 <span class="comment">// RETURNS        0 - n  = length of line read</span>
00065 <span class="comment">//         COMFILE_EOF   = eof</span>
00066 <span class="comment">//         COMFILE_ERROR = error</span>
00067 <span class="comment">//</span>
<a name="l00068"></a><a class="code" href="classTComFileParser.html#a5">00068</a> <span class="keywordtype">int</span> <a class="code" href="classTComFileParser.html#a5">TComFileParser::ReadLine</a>()
00069 {
00070    <span class="keywordtype">int</span> r_value = <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>;
00071 
00072    <span class="keywordtype">bool</span> _readyToReturn = <span class="keyword">false</span>;
00073 
00074         <span class="keywordtype">char</span>  buf[<a class="code" href="configsource_8h.html#a1">MAX_LINE_LENGTH</a>+1];   <span class="comment">// read buffer</span>
00075 
00076         <a class="code" href="classConfigSource.html#n2">LastError</a> = 0;
00077    strcpy( LastMessage, <span class="stringliteral">""</span> );
00078 
00079         <span class="keywordflow">if</span>( eof )
00080    {
00081       <span class="comment">// Already finished parsing all comfiles, return EOF</span>
00082                 <span class="keywordflow">return</span> <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>;
00083         }
00084 
00085 
00086    <span class="keywordflow">switch</span>( ReadMode )
00087    {
00088      <span class="keywordflow">case</span> <a class="code" href="comfile_8h.html#a1">CS_MODE_FILE</a>:   <span class="comment">// file:</span>
00089 
00090           <span class="keywordflow">while</span>( ! _readyToReturn )
00091           {
00092              <span class="comment">// Get string from current file</span>
00093                   <span class="keywordflow">if</span>( (fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, files[OpenFileCount-1])) != NULL )
00094                   {
00095                 <span class="comment">// able to read line from file</span>
00096 
00097                           <a class="code" href="classConfigSource.html#n3">LineParseIndex</a> = -1; <span class="comment">// i = -1; start of line, no tokens yet</span>
00098 
00099                 <span class="keywordflow">switch</span>( buf[0] )
00100                 {
00101                   <span class="keywordflow">case</span> <span class="charliteral">'@'</span>:
00102                        <span class="keywordflow">if</span> ( <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a> == <a class="code" href="comfile_8h.html#a0">MAX_COM_FILE</a> )
00103                        {
00104                           <span class="comment">// failed opening new file</span>
00105                           sprintf( LastMessage, <span class="stringliteral">"Attempt to open more than %d command files."</span>, MAX_COM_FILE );
00106                           r_value = <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>;
00107                           _readyToReturn = <span class="keyword">true</span>;
00108                        }
00109                        <span class="keywordflow">else</span>
00110                        {
00111                           <span class="comment">// Found indicator of new file to open</span>
00112                                       buf[0] = <span class="charliteral">' '</span>;       <span class="comment">// replace file name indicator with token spacer</span>
00113                        strcpy( CurrentLine, buf);  <span class="comment">// make line with filename available to tokenizer code</span>
00114                                       <span class="keywordtype">char</span>* filename = <a class="code" href="classConfigSource.html#a5">NextToken</a>(); <span class="comment">// get filename from current line</span>
00115 
00116                           <span class="comment">// open new file</span>
00117                               <span class="keywordflow">if</span>( (<a class="code" href="classTComFileParser.html#n0">files</a>[<a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>] = fopen(filename, <span class="stringliteral">"r"</span>)) != NULL )
00118                           {
00119                                              <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>++;
00120                              <span class="comment">// loop again to get next [first] line from [newly-opened] file for parsing</span>
00121                           }
00122                           <span class="keywordflow">else</span>
00123                           {
00124                              <span class="comment">// failed opening new file</span>
00125                                                  sprintf( LastMessage, <span class="stringliteral">"File &lt;%s&gt; not found.\n"</span>, filename );
00126                              r_value = <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>;
00127                              _readyToReturn = <span class="keyword">true</span>;
00128                           }
00129                        }
00130                        <span class="keywordflow">break</span>;
00131 
00132                   <span class="keywordflow">default</span>:
00133                        <span class="comment">// remove terminating newline</span>
00134                        <span class="keywordflow">if</span> ( buf[strlen(buf)-1] == <span class="charliteral">'\n'</span> )
00135                        {
00136                           buf[strlen(buf)-1] = 0;  <span class="comment">// replace end-of-line with end-of-string</span>
00137                        }
00138 
00139                        <span class="comment">// check for empty spaces or comment start</span>
00140                        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _c = 0, _sz = strlen(buf) ; _c &lt; _sz ; _c++ )
00141                        {
00142                           <span class="keywordflow">switch</span>( buf[_c] )
00143                           {
00144                             <span class="keywordflow">case</span> <span class="charliteral">' '</span>:
00145                             <span class="keywordflow">case</span> <span class="charliteral">'\t'</span>:
00146                                  <span class="keywordflow">break</span>;
00147 
00148                             <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
00149                             <span class="keywordflow">case</span> <span class="charliteral">'#'</span>:
00150                                  <span class="comment">// empty line or comment, go to next line</span>
00151                                  _c = _sz;
00152                                  <span class="keywordflow">break</span>;
00153 
00154                             <span class="keywordflow">default</span>:
00155                                  <span class="comment">// not an indication of new file, return info about current line</span>
00156                                  strcpy( CurrentLine, buf );
00157                                  r_value = strlen( CurrentLine );
00158                                  _readyToReturn = <span class="keyword">true</span>;
00159                                  <a class="code" href="classConfigSource.html#n3">LineParseIndex</a> = _c - 1;
00160                                  _c = _sz;
00161                                  <span class="keywordflow">break</span>;
00162                           }
00163                        }
00164 
00165                 }
00166              }
00167              <span class="keywordflow">else</span>
00168              {
00169                 <span class="comment">// nothing read from current file, must be end of current file</span>
00170                 fclose( files[--OpenFileCount] );
00171                 <a class="code" href="classTComFileParser.html#n0">files</a>[<a class="code" href="classTComFileParser.html#n1">OpenFileCount</a>] = NULL;
00172 
00173                      <span class="keywordflow">if</span>( <a class="code" href="classTComFileParser.html#n1">OpenFileCount</a> == 0 )
00174                 {
00175                    <span class="comment">// no files remain open, return indication of end-of-file</span>
00176                    strcpy( Token , <span class="stringliteral">"eof"</span> );
00177                    <a class="code" href="classTComFileParser.html#n4">eof</a> = <span class="keyword">true</span>;
00178                    r_value = <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>;
00179                    _readyToReturn = <span class="keyword">true</span>;
00180                 }
00181                 <span class="comment">// else a file remains open, get the next line from that file</span>
00182              }
00183           } <span class="comment">// while( ! _notReadyToReturn )</span>
00184           <span class="keywordflow">break</span>;
00185 
00186 
00187      <span class="keywordflow">case</span> <a class="code" href="comfile_8h.html#a2">CS_MODE_ARCHIVE</a>:  <span class="comment">// This mode reads archive files char-by-char into CurrentLine</span>
00188           {
00189                   <span class="keywordtype">char</span>  chr;        <span class="comment">// read char</span>
00190                   <span class="keywordtype">int</span>   charsread = 0;   <span class="comment">// chars read from archive file</span>
00191 
00192              <span class="keywordflow">while</span>( ! _readyToReturn )
00193              {
00194                 <span class="keywordflow">switch</span>( (chr = (char)fgetc( Archive )) )
00195                 {
00196                   <span class="keywordflow">case</span> EOF:
00197                        <span class="comment">// could also be an error</span>
00198                        strcpy( Token , <span class="stringliteral">"eof"</span> );
00199                        <a class="code" href="classTComFileParser.html#n4">eof</a> = <span class="keyword">true</span>;
00200                        <span class="keywordflow">if</span> ( charsread == 0 )
00201                        {
00202                           <span class="comment">// encountered EOF with no line data in buffer</span>
00203                           r_value = <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>;
00204                           _readyToReturn = <span class="keyword">true</span>;
00205                           <span class="keywordflow">break</span>;
00206                        }
00207                        <span class="comment">// encountered EOF without preceeding end-of-line NULL termination</span>
00208                        <span class="comment">// unlikely, but....</span>
00209                        <span class="comment">// fall through</span>
00210 
00211                   <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
00212                        <a class="code" href="classConfigSource.html#n3">LineParseIndex</a> = -1; <span class="comment">// i = -1;</span>
00213                        buf[charsread] = 0;         <span class="comment">// null-terminate</span>
00214                        strcpy( CurrentLine, buf);
00215                        r_value = strlen( CurrentLine );
00216                        _readyToReturn = <span class="keyword">true</span>;
00217                        <span class="keywordflow">break</span>;
00218 
00219                   <span class="keywordflow">case</span> <span class="charliteral">'\r'</span>:
00220                        <span class="comment">// drop this char, read the next one</span>
00221                        <span class="comment">//goto archive;</span>
00222                        <span class="keywordflow">break</span>;
00223 
00224                   <span class="keywordflow">default</span>:
00225                        <span class="comment">// append this char</span>
00226                        buf[charsread++] = chr;
00227                        <span class="comment">// continue loop to get next one</span>
00228                        <span class="keywordflow">break</span>;
00229                 }
00230              } <span class="comment">// while( ! _readyToReturn )</span>
00231 
00232           }
00233           <span class="keywordflow">break</span>;
00234    }
00235 
00236    <span class="keywordflow">return</span> r_value;
00237 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:00 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
