<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>serverbase.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>serverbase.h</h1><a href="serverbase_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">**  ServerBase -- a Earthworm base class for any TCP/Stream server</span>
00003 <span class="comment">*/</span>
00004 <span class="comment">//---------------------------------------------------------------------------</span>
00005 <span class="preprocessor">#if !defined(EWserverbaseH)</span>
<a name="l00006"></a><a class="code" href="serverbase_8h.html#a0">00006</a> <span class="preprocessor"></span><span class="preprocessor">#define EWserverbaseH</span>
00007 <span class="preprocessor"></span><span class="comment">//---------------------------------------------------------------------------</span>
00008 
00009 <span class="preprocessor">#include &lt;<a class="code" href="socket__exception_8h.html">socket_exception.h</a>&gt;</span>
00010 
00011 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winsock2.h&gt;</span> <span class="comment">// prevent conflicts with winsock.h</span>
00013 <span class="preprocessor">#endif</span>
00014 <span class="preprocessor"></span>
00015 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00016 <span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">platform.h</a>&gt;</span>
00017 <span class="comment">// C++ compilers don't like the earthworm def for thr_ret</span>
00018 <span class="preprocessor">#undef thr_ret</span>
<a name="l00019"></a><a class="code" href="serverbase_8h.html#a1">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define thr_ret void fun</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="socket__ew_8h.html">socket_ew.h</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="transport_8h.html">transport.h</a>&gt;</span>
00022 }
<a name="l00023"></a><a class="code" href="serverbase_8h.html#a2">00023</a> <span class="preprocessor">#define _USING_EW_XPORT 1 // prevent conflict between EW &amp; MW</span>
00024 <span class="preprocessor"></span>
00025 
00026 <span class="comment">// microsoft pragma to avoid 157 messages in some cases</span>
00027 <span class="preprocessor">#pragma warning(disable:4786)</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">// following includes must follow the winsock2.h include, etc.</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="threadableobject_8h.html">threadableobject.h</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;time.h&gt;</span>     <span class="comment">// time() -- for interthread heartbeats</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="configurable_8h.html">configurable.h</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;map&gt;</span>
00034 <span class="preprocessor">#include &lt;vector&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="worm__types_8h.html">worm_types.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="worm__defs_8h.html">worm_defs.h</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="worm__signal_8h.html">worm_signal.h</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="globalutils_8h.html">globalutils.h</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="configsource_8h.html">configsource.h</a>&gt;</span>
00041 
00042 
00043 
<a name="l00044"></a><a class="code" href="serverbase_8h.html#a3">00044</a> <span class="preprocessor">#define SERVE_MAX_THREADS    100</span>
<a name="l00045"></a><a class="code" href="serverbase_8h.html#a4">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define WAIT_FOR_SERVICE_THREAD  3000    // milliseconds to wait for a service thread to come free</span>
00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="serverbase_8h.html#a5">00047</a> <span class="preprocessor">#define SERVICE_THREAD_SLEEP_MS  1000  // milliseconds for client to sleep between loop passes</span>
00048 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="serverbase_8h.html#a6">00049</a> <span class="preprocessor">#define SERVICE_THREAD_PULSE_MAX 10 // maximum seconds that the main thread will allow a service</span>
00050 <span class="preprocessor"></span>                                    <span class="comment">// thread to exist without getting a valid pulse before it</span>
00051                                     <span class="comment">// kills the service thread</span>
00052 
<a name="l00053"></a><a class="code" href="serverbase_8h.html#a7">00053</a> <span class="preprocessor">#define THREAD_STACK  (unsigned int)8096</span>
00054 <span class="preprocessor"></span>
00055 <span class="comment">// Absolute minumum time to listen for a message if specified</span>
<a name="l00056"></a><a class="code" href="serverbase_8h.html#a8">00056</a> <span class="preprocessor">#define MIN_RECV_TIMEOUT_MS  50</span>
00057 <span class="preprocessor"></span>
00058 
<a name="l00059"></a><a class="code" href="serverbase_8h.html#a22">00059</a> <span class="keyword">enum</span> <a class="code" href="serverbase_8h.html#a22">WORM_SERVER_THREAD_STATE</a>  <span class="comment">// Server Thread States</span>
00060 {
00061    <a class="code" href="serverbase_8h.html#a22a14">THREAD_ERROR</a>            = -1
00062  , <a class="code" href="serverbase_8h.html#a22a15">THREAD_STARTING</a>         =  0
00063  , <a class="code" href="serverbase_8h.html#a22a16">THREAD_INITIALIZING</a>     =  1
00064  , <a class="code" href="serverbase_8h.html#a22a17">THREAD_WAITING</a>          =  2  <span class="comment">// waiting for something to do</span>
00065  , <a class="code" href="serverbase_8h.html#a22a18">THREAD_PROCESSING</a>       =  3  <span class="comment">// doing something</span>
00066  , <a class="code" href="serverbase_8h.html#a22a19">THREAD_BLOCKINGSOCKET</a>   =  4
00067  , <a class="code" href="serverbase_8h.html#a22a20">THREAD_DISCONNECTED</a>     =  5
00068  , <a class="code" href="serverbase_8h.html#a22a21">THREAD_COMPLETED</a>        = 10
00069 };
00070 
<a name="l00071"></a><a class="code" href="serverbase_8h.html#a9">00071</a> <span class="keyword">typedef</span> <span class="keywordtype">char</span> <a class="code" href="serverbase_8h.html#a9">CLIENT_IPADDR</a>[16];
00072 
<a name="l00073"></a><a class="code" href="struct__ServiceThreadInfoStruct.html">00073</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ServiceThreadInfoStruct.html">_ServiceThreadInfoStruct</a>
00074 {
<a name="l00075"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m0">00075</a>    SOCKET                   <a class="code" href="struct__ServiceThreadInfoStruct.html#m0">descriptor</a>; <span class="comment">// Socket descriptors</span>
<a name="l00076"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m1">00076</a>    TO_THREAD_ID             <a class="code" href="struct__ServiceThreadInfoStruct.html#m1">threadid</a>;
<a name="l00077"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m2">00077</a>    <a class="code" href="serverbase_8h.html#a9">CLIENT_IPADDR</a>            <a class="code" href="struct__ServiceThreadInfoStruct.html#m2">ipaddr</a>;
<a name="l00078"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m3">00078</a>    <span class="keyword">struct </span>sockaddr_in       sock_addr;
<a name="l00079"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m4">00079</a>    <a class="code" href="serverbase_8h.html#a22">WORM_SERVER_THREAD_STATE</a> <a class="code" href="struct__ServiceThreadInfoStruct.html#m4">status</a>;
<a name="l00080"></a><a class="code" href="struct__ServiceThreadInfoStruct.html#m5">00080</a>    time_t                   <a class="code" href="struct__ServiceThreadInfoStruct.html#m5">lastpulse</a>; <span class="comment">// = time(NULL) during each pass of ClientServicer() loop</span>
00081 } <a class="code" href="struct__ServiceThreadInfoStruct.html">ServiceThreadInfoStruct</a>;
00082 
<a name="l00083"></a><a class="code" href="serverbase_8h.html#a11">00083</a> <span class="keyword">typedef</span> std::map&lt;SOCKET, ServiceThreadInfoStruct&gt; <a class="code" href="serverbase_8h.html#a11">SERVICETHREAD_MAP</a>;
<a name="l00084"></a><a class="code" href="serverbase_8h.html#a12">00084</a> <span class="keyword">typedef</span> SERVICETHREAD_MAP::iterator <a class="code" href="serverbase_8h.html#a12">SERVICETHREAD_MAP_ITERATOR</a>;
00085 
<a name="l00086"></a><a class="code" href="serverbase_8h.html#a13">00086</a> <span class="keyword">typedef</span> std::vector&lt;SOCKET&gt; <a class="code" href="serverbase_8h.html#a13">SERVICETHREADID_VECTOR</a>;
00087 
00088 <span class="comment">//---------------------------------------------------------------------------</span>
00089 
<a name="l00090"></a><a class="code" href="classWormServerBase.html">00090</a> <span class="keyword">class </span><a class="code" href="classWormServerBase.html">WormServerBase</a> : <span class="keyword">public</span> <a class="code" href="classThreadableObject.html">ThreadableObject</a>
00091                      , <span class="keyword">public</span> <a class="code" href="classTConfigurable.html">TConfigurable</a>
00092 {
00093 <span class="keyword">private</span>:
00094    <span class="comment">// Members in the private: area cannot be accessed by deriving classes</span>
00095    <span class="comment">// (except through accessor methods in the protected area)</span>
00096 
00097    <span class="comment">// Socketing</span>
<a name="l00098"></a><a class="code" href="classWormServerBase.html#o0">00098</a>    SOCKET         <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a>;
00099 
<a name="l00100"></a><a class="code" href="classWormServerBase.html#o1">00100</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a>; <span class="comment">// both max allowed and max waiting in listen queue</span>
00101 
00102 <span class="keyword">protected</span>:
00103 
<a name="l00104"></a><a class="code" href="classWormServerBase.html#n0">00104</a>    <span class="keywordtype">bool</span>           <a class="code" href="classWormServerBase.html#n0">SocketDebug</a>;
00105 
<a name="l00106"></a><a class="code" href="classWormServerBase.html#n1">00106</a>    <span class="keywordtype">char</span>           <a class="code" href="classWormServerBase.html#n1">ServerIPAddr</a>[20]; <span class="comment">// IP address of wave_server machine</span>
<a name="l00107"></a><a class="code" href="classWormServerBase.html#n2">00107</a>    <span class="keywordtype">int</span>            <a class="code" href="classWormServerBase.html#n2">ServerPort</a>;       <span class="comment">// Server port for requests &amp; replies</span>
00108 
<a name="l00109"></a><a class="code" href="classWormServerBase.html#n3">00109</a>    <span class="keywordtype">int</span>            <a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a>;    <span class="comment">// Timeout milliseconds for send_ew() calls, blocking if -1</span>
00110 
00111    <span class="comment">// Listen() -- listens to the passive socket, starts client server threads</span>
00112    <span class="comment">//             as requests arrive.</span>
00113    <span class="comment">//</span>
00114    THREAD_RETURN <a class="code" href="classWormServerBase.html#b0">Listener</a>( <span class="keywordtype">void</span> * p_dummy );
<a name="l00115"></a><a class="code" href="classWormServerBase.html#n4">00115</a>    TO_THREAD_ID  <a class="code" href="classWormServerBase.html#n4">ListenerThreadId</a>;
<a name="l00116"></a><a class="code" href="classWormServerBase.html#n5">00116</a>    <span class="keywordtype">long</span>          <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a>;
00117 
00118    <span class="keyword">static</span> <span class="keywordtype">bool</span>   <a class="code" href="classWormServerBase.html#e0">DoSCNLsMatch</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_s1
00119                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_c1
00120                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_n1
00121                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_l1
00122                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_s2
00123                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_c2
00124                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_n2
00125                              , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_l2
00126                              );
00127 
00128 
00129    <span class="comment">// =======================================================================</span>
00130    <span class="comment">//                  from TConfigurable</span>
00131    <span class="comment">// =======================================================================</span>
00132 
00133    <span class="comment">/* CheckConfig() -- allows derivative classes to report the status of their</span>
00134 <span class="comment">   **                  the lookup values.</span>
00135 <span class="comment">   **</span>
00136 <span class="comment">   ** From within any deriving class, or further derivation, ALWAYS contain a call to</span>
00137 <span class="comment">   ** &lt;super_class&gt;::CheckConfig() in their own CheckConfig() method...</span>
00138 <span class="comment">   ** this ensures that all classes in the heirarchy get their chance to report status.</span>
00139 <span class="comment">   **</span>
00140 <span class="comment">   ** All implementations should set ConfigStatus value to WORM_STAT_BADSTATE if there</span>
00141 <span class="comment">   ** is a configuration problem, otherwise leave it alone.</span>
00142 <span class="comment">   */</span>
00143    <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b1">CheckConfig</a>();
00144 
00145 
00146    <span class="comment">// =======================================================================</span>
00147    <span class="comment">//                  WormServerBase</span>
00148    <span class="comment">// =======================================================================</span>
00149 
00150    <span class="comment">// Accessor to private data</span>
00151    <span class="comment">//</span>
<a name="l00152"></a><a class="code" href="classWormServerBase.html#b2">00152</a>    <span class="keywordtype">bool</span> <a class="code" href="classWormServerBase.html#b2">SetMaxThreads</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> p_count )
00153    {
00154       <span class="comment">// Check for a sane value</span>
00155       <span class="keywordflow">if</span> ( <a class="code" href="serverbase_8h.html#a3">SERVE_MAX_THREADS</a> &lt; p_count )
00156       {
00157          <span class="keywordflow">return</span> <span class="keyword">false</span>;
00158       }
00159       MaxServiceThreads = p_count;
00160       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00161    }
00162 
00163    <span class="comment">// not valid until after PrepToRun()</span>
<a name="l00164"></a><a class="code" href="classWormServerBase.html#n6">00164</a>    <span class="keywordtype">int</span>            <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a>;
00165 
00166 
<a name="l00167"></a><a class="code" href="classWormServerBase.html#n7">00167</a>    <a class="code" href="serverbase_8h.html#a11">SERVICETHREAD_MAP</a> <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>;
00168 
<a name="l00169"></a><a class="code" href="classWormServerBase.html#n8">00169</a>    <span class="keywordtype">int</span>            <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a>;    <span class="comment">// Timeout (milliseconds) to wait for message from client in ListenForMsg(),</span>
00170                                     <span class="comment">// -1 == ignored and socket made blocking during recv_ew()</span>
00171 
00172    <span class="comment">// Ring to check for shutdown flags, to post heartbeats, etc.</span>
<a name="l00173"></a><a class="code" href="classWormServerBase.html#n9">00173</a>    <a class="code" href="worm__types_8h.html#a34">WORM_RING_NAME</a> <a class="code" href="classWormServerBase.html#n9">CommandRingName</a>;      <span class="comment">// name of transport ring</span>
<a name="l00174"></a><a class="code" href="classWormServerBase.html#n10">00174</a>    <a class="code" href="worm__types_8h.html#a30">WORM_RING_ID</a>   <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a>;   <span class="comment">// key to transport ring</span>
<a name="l00175"></a><a class="code" href="classWormServerBase.html#n11">00175</a>    <a class="code" href="structSHM__INFO.html">SHM_INFO</a>       <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>;  <span class="comment">// Info structure for shared memory (command ring)</span>
00176 
00177    <span class="comment">/*</span>
00178 <span class="comment">   ** ListenForMsg()</span>
00179 <span class="comment">   **</span>
00180 <span class="comment">   **    Listens on an active socket for a message ('\n' terminated)</span>
00181 <span class="comment">   **    from the client.</span>
00182 <span class="comment">   **</span>
00183 <span class="comment">   ** PARAMETERS:</span>
00184 <span class="comment">   **          p_descriptor = socket descriptor for recv()</span>
00185 <span class="comment">   **          p_rcv_buffer = buffer to receive data</span>
00186 <span class="comment">   **          p_length = on call set to maximum chars to read,</span>
00187 <span class="comment">   **                     on return will be actual number read</span>
00188 <span class="comment">   **          p_timeoutms = used to override RecvTimeoutMS</span>
00189 <span class="comment">   **                        If greater than zero, then use it for the</span>
00190 <span class="comment">   **                        timeout, otherwise RecvTimeoutMS is used.</span>
00191 <span class="comment">   **</span>
00192 <span class="comment">   ** RETURNS  0 = read completed successfully</span>
00193 <span class="comment">   **         -1 = read timed-out (check if p_length == 0 else p_rcv_buffer[p_length-1] == '\n')</span>
00194 <span class="comment">   **         -2 = client closed socket (terminate service thread)</span>
00195 <span class="comment">   **         -3 = socket error (other then time-out)</span>
00196 <span class="comment">   **         -4 = abort to prevent buffer overrun</span>
00197 <span class="comment">   **</span>
00198 <span class="comment">   ** WARNING: This method will support blocking client sockets (config</span>
00199 <span class="comment">   **          parm RecvTimeoutMSecs not set or -1), however, if used then</span>
00200 <span class="comment">   **          can only send a single pulse to the main thread before entering</span>
00201 <span class="comment">   **          the client thread a potentially blocked state.</span>
00202 <span class="comment">   **          This prevents the main thread from identifying, reporting and</span>
00203 <span class="comment">   **          terminating hung threads.  Therefore, use blocking sockets</span>
00204 <span class="comment">   **          with caution.</span>
00205 <span class="comment">   */</span>
00206    <span class="keywordtype">int</span> <a class="code" href="classWormServerBase.html#b3">ListenForMsg</a>( SOCKET p_descriptor
00207                    , <span class="keywordtype">char</span> * p_rcv_buffer
00208                    , <span class="keywordtype">int</span> *  p_length
00209                    , <span class="keywordtype">int</span>    p_timeoutms = -1 <span class="comment">// uses RecvTimeoutMS if not included in the function call (or -1)</span>
00210                    );
00211 
00212    <span class="comment">/*</span>
00213 <span class="comment">   **</span>
00214 <span class="comment">   ** RETURNS  WORM_STAT_SUCCESS</span>
00215 <span class="comment">   **          WORM_STAT_FAILURE</span>
00216 <span class="comment">   */</span>
00217    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#b4">SendMessage</a>( <span class="keyword">const</span> SOCKET p_descriptor, <span class="keyword">const</span> <span class="keywordtype">char</span> * p_msg, <span class="keywordtype">int</span> * p_length );
00218 
00219 
00220    <span class="comment">/* Running -- flag indicating if the main loop is running,</span>
00221 <span class="comment">   **            set to false by terminate message, or various</span>
00222 <span class="comment">   **            errors, to tell all threads to exit.</span>
00223 <span class="comment">   **</span>
00224 <span class="comment">   **     changed by main thread, read by others, may need to be volatile</span>
00225 <span class="comment">   */</span>
<a name="l00226"></a><a class="code" href="classWormServerBase.html#n12">00226</a>    <span class="keywordtype">bool</span>        <a class="code" href="classWormServerBase.html#n12">Running</a>;
00227 
00228    <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type, <span class="keywordtype">short</span> ierr, <span class="keywordtype">char</span> *note );
00229 
00230    <span class="comment">// ReleaseServiceThreadInfo() -- enables</span>
<a name="l00231"></a><a class="code" href="classWormServerBase.html#b6">00231</a>    <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b6">ReleaseServiceThreadInfo</a>( SOCKET p_descriptor )
00232    {
00233       <span class="keywordflow">if</span> ( 0 &lt; ThreadsInfo.count(p_descriptor) )
00234       {
00235          ThreadsInfo.erase(p_descriptor);
00236       }
00237    }
00238 
00239 
00240    <span class="comment">/* PrepareToRun() -- actions to take prior to entering main loop</span>
00241 <span class="comment">   **</span>
00242 <span class="comment">   **   ALWAYS call base class's PrepareToRun() at the top</span>
00243 <span class="comment">   **</span>
00244 <span class="comment">   ** RETURN:  true if ready</span>
00245 <span class="comment">   **          false if some condition prevents proper execution</span>
00246 <span class="comment">   */</span>
<a name="l00247"></a><a class="code" href="classWormServerBase.html#b7">00247</a>    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classWormServerBase.html#b7">PrepareToRun</a>()
00248    {
00249       LoggingLevel = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>();
00250       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00251    }
00252 
00253    <span class="comment">/* MainThreadActions() -- override to implements actions performed during the main</span>
00254 <span class="comment">   **                        thread's loop (other than sending heartbeats, which are</span>
00255 <span class="comment">   **                        handled by other code.</span>
00256 <span class="comment">   **                        This is made virtual since some servers may look for input</span>
00257 <span class="comment">   **                        from a ring, some may look into the database, while others</span>
00258 <span class="comment">   **                        may only respond to requests from clients.</span>
00259 <span class="comment">   */</span>
<a name="l00260"></a><a class="code" href="classWormServerBase.html#b8">00260</a>    <span class="keyword">virtual</span> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#b8">MainThreadActions</a>() { <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>; }
00261 
00262    <span class="comment">/* FinishedRunning() -- actions to take after exiting main loop</span>
00263 <span class="comment">   **</span>
00264 <span class="comment">   **   ALWAYS call base class's FinishedRunning() at the top</span>
00265 <span class="comment">   */</span>
<a name="l00266"></a><a class="code" href="classWormServerBase.html#b9">00266</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b9">FinishedRunning</a>() { }
00267 
00268    <span class="comment">/* ClientServicer() -- method to perform the work of servicing a client</span>
00269 <span class="comment">   **</span>
00270 <span class="comment">   ** note: THREAD_RETURN is some kind of void, so just return or leave block</span>
00271 <span class="comment">   */</span>
00272    <span class="comment">// note: THREAD_RETURN is some kind of void, so just return or leave block</span>
00273    <span class="comment">//</span>
00274    <span class="keyword">virtual</span> THREAD_RETURN <a class="code" href="classWormServerBase.html#b10">ClientServicer</a>( <span class="keywordtype">void</span> * p_socketdescriptor ) = 0;
00275 
00276    <span class="comment">// MyThreadFunction is a pointer to one of the member functions of this class</span>
00277    <span class="comment">// (WormServerBase) that takes no parameters and returns THREAD_RETURN</span>
00278 <span class="comment">//   THREAD_RETURN (WormServerBase::*MyThreadFunction)(void * p_argument);</span>
00279 
00280 
00281 <span class="keyword">public</span>:
00282 
00283    <span class="comment">// =======================================================================</span>
00284    <span class="comment">//                  from TConfigurable</span>
00285    <span class="comment">// =======================================================================</span>
00286 
00287    <span class="comment">/*</span>
00288 <span class="comment">   **  HandleConfigLine()</span>
00289 <span class="comment">   **</span>
00290 <span class="comment">   **  PARMS:</span>
00291 <span class="comment">   **          p_parser -- the parser being used, command string already</span>
00292 <span class="comment">   **                      in the current token for comparison with Its()</span>
00293 <span class="comment">   **</span>
00294 <span class="comment">   ** RETURN:</span>
00295 <span class="comment">   **          HANDLE_INVALID --  line invalid</span>
00296 <span class="comment">   **          HANDLE_UNUSED  --  line not used</span>
00297 <span class="comment">   **          HANDLE_USED    --  line used okay</span>
00298 <span class="comment">   **</span>
00299 <span class="comment">   **  Override for child classes to handle command lines</span>
00300 <span class="comment">   */</span>
00301    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classWormServerBase.html#a0">HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser );
00302 
00303    <span class="comment">// =======================================================================</span>
00304    <span class="comment">//                  from ThreadableObject</span>
00305    <span class="comment">// =======================================================================</span>
00306 
00307    <span class="comment">/* StartThreadFunc -- used by ThreadableObject global function to reenter</span>
00308 <span class="comment">   **                    this class in a new thread</span>
00309 <span class="comment">   */</span>
<a name="l00310"></a><a class="code" href="classWormServerBase.html#a1">00310</a>    <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#a1">StartThreadFunc</a>( <span class="keywordtype">void</span> * p_arg )
00311    {
00312       <span class="comment">// Determining which method to enter for this server is simple:</span>
00313       <span class="comment">// if p_arg is NULL, then this is the call to start the</span>
00314       <span class="comment">// listener thread.</span>
00315       <span class="comment">// if p_arg is not null, then this is a call to start a</span>
00316       <span class="comment">// client service thread (p_arg is the socket descriptor,</span>
00317       <span class="comment">// used to access the thread info in the map)</span>
00318       <span class="keywordflow">if</span> ( p_arg == NULL )
00319       {
00320          <a class="code" href="classWormServerBase.html#b0">Listener</a>(p_arg);  <span class="comment">// p_arg is ignored</span>
00321       }
00322       <span class="keywordflow">else</span>
00323       {
00324          <a class="code" href="classWormServerBase.html#b10">ClientServicer</a>(p_arg);
00325       }
00326    }
00327 
00328    <span class="comment">// =======================================================================</span>
00329    <span class="comment">//                  WormServerBase</span>
00330    <span class="comment">// =======================================================================</span>
00331 
00332    <span class="comment">// Call this base class constructor before the constructors</span>
00333    <span class="comment">// for any derived classes, thusly:</span>
00334    <span class="comment">//</span>
00335    <span class="comment">//    &lt;derived-class&gt;(const char * p_filename) : WormServerBase(p_filename)</span>
00336    <span class="comment">//    {</span>
00337    <span class="comment">//       .... code for derived class constructor</span>
00338    <span class="comment">//    }</span>
00339    <span class="comment">//</span>
00340    <a class="code" href="classWormServerBase.html#a2">WormServerBase</a>();
00341 
00342    <a class="code" href="classWormServerBase.html#a3">~WormServerBase</a>();
00343 
00344    <span class="comment">// Run() -- starts the listener thread, then parses incoming messages,</span>
00345    <span class="comment">//          shutting everything down as needed.</span>
00346    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#a4">Run</a>();
00347 
00348 };
00349 
00350 <span class="preprocessor">#endif // EWserverbaseH</span>
00351 <span class="preprocessor"></span>
00352 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:10 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
