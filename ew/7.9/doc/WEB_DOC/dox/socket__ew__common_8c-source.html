<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>socket_ew_common.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>socket_ew_common.c</h1><a href="socket__ew__common_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: socket__ew__common_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.4  2000/12/01 23:48:54  lombard</span>
00011 <span class="comment"> *     Fixed a few more logit format errors.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.3  2000/07/10 21:14:51  lombard</span>
00014 <span class="comment"> *     Fixed bug in recvfrom_ew where improper arguments were used in recvfrom calls</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *     Revision 1.2  2000/06/28 17:17:54  lombard</span>
00017 <span class="comment"> *     Fixed bug in format for logit calls after select errors, several places</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00020 <span class="comment"> *     Initial revision</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> */</span>
00024 
00025 <span class="comment">/****************** socket_ew_common *************************/</span>
00026 
00027 <span class="comment">/*</span>
00028 <span class="comment"> * Changes:</span>
00029 <span class="comment"> * 12/7/1999, PNL</span>
00030 <span class="comment"> * Accept_ew now sets the new socket to non-blocking mode.</span>
00031 <span class="comment"> *  Previously it was assumed that the new socket inherited non-blocking</span>
00032 <span class="comment"> *  from the original socket; this is not true in WinNT or Solaris 2.6.</span>
00033 <span class="comment"> * Errors from select() calls are now handled.</span>
00034 <span class="comment"> */</span>
00035 <span class="comment">/********************* #INCLUDES *****************************/</span>
00036 <span class="comment">/*************************************************************/</span>
00037 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="socket__ew_8h.html">socket_ew.h</a>&gt;</span>
00039 
00040 <span class="comment">/********************** GLOBAL *******************************/</span>
00041 <span class="comment">/********************* VARIABLES *****************************/</span>
00042 <span class="comment">/*************************************************************/</span>
00043 <span class="comment">/* Timeout used for select() calls: 0.2 seconds */</span>
<a name="l00044"></a><a class="code" href="socket__ew__common_8c.html#a0">00044</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a0">SELECT_TIMEOUT_SECONDS</a>=0;
<a name="l00045"></a><a class="code" href="socket__ew__common_8c.html#a1">00045</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a1">SELECT_TIMEOUT_uSECONDS</a>=200000;
00046 
<a name="l00047"></a><a class="code" href="socket__ew__common_8c.html#a2">00047</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>=0;       <span class="comment">/* Set by setSocket_ewDebug() */</span>
00048 
<a name="l00049"></a><a class="code" href="socket__ew__common_8c.html#a3">00049</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a3">SOCKET_SYS_INIT</a>;  <span class="comment">/* Global initialization flag.</span>
00050 <span class="comment">                                Declared in sys-dependent socket_ew.c,</span>
00051 <span class="comment">                                set in SocketSysInit(), </span>
00052 <span class="comment">                                checked in socket_ew()  */</span>
00053 
00054 <span class="comment">/********************* SOCKET_ew *****************************/</span>
00055 <span class="comment">/*********** Internal Utility Function Prototypes ************/</span>
00056 <span class="comment">/*************************************************************/</span>
00057 <span class="keyword">struct </span>timeval FAR * <a class="code" href="socket__ew__common_8c.html#a4">resetTimeout</a>(struct timeval FAR *);
00058 Time_ew <a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(<span class="keywordtype">int</span> timeout_msec);
00059 
00060 
00061 <span class="comment">/********************* SOCKET_ew *****************************/</span>
00062 <span class="comment">/********************* Functions *****************************/</span>
00063 <span class="comment">/*************************************************************/</span>
00064 
<a name="l00065"></a><a class="code" href="socket__ew__common_8c.html#a6">00065</a> SOCKET <a class="code" href="socket__ew__common_8c.html#a6">socket_ew</a> (<span class="keywordtype">int</span> af, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> protocol)
00066 {
00067   <span class="comment">/* socket_ew() allocates a socket descriptor and associated </span>
00068 <span class="comment">     resources. It first makes sure that the Socket system has </span>
00069 <span class="comment">     been initialized, then it calls socket(), and finally sets </span>
00070 <span class="comment">     the socket descriptor to non-blocking mode.</span>
00071 <span class="comment">     Arguments af, type and protocol are passed directly to socket().</span>
00072 <span class="comment">     No network I/O occurs.</span>
00073 <span class="comment">     Caller can call socketGetError_ew() for details about any </span>
00074 <span class="comment">     failures.</span>
00075 <span class="comment">  */</span>
00076 
00077   SOCKET newSocket;
00078   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"socket_ew()"</span>;
00079   <span class="keywordtype">int</span> retVal;
00080   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lOnOff=1;
00081 
00082   <span class="keywordflow">if</span> (EW_SOCKET_DEBUG)
00083     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00084 
00085   <span class="keywordflow">if</span> (!<a class="code" href="socket__ew__common_8c.html#a3">SOCKET_SYS_INIT</a>)
00086     <a class="code" href="socket__ew_8c.html#a2">SocketSysInit</a>();
00087 
00088   newSocket = socket(af,type,protocol);
00089   <span class="keywordflow">if</span> (newSocket == INVALID_SOCKET  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00090     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00091           <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00092   
00093   <span class="keywordflow">if</span> (newSocket != INVALID_SOCKET)
00094   {
00095     retVal=ioctlsocket(newSocket,FIONBIO,&amp;lOnOff);
00096     <span class="keywordflow">if</span> (retVal==SOCKET_ERROR)
00097     {
00098       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00099         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00100               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00101       closesocket(newSocket);
00102       <span class="keywordflow">return</span>(SOCKET_ERROR);
00103     }
00104   }
00105   
00106   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00107     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00108   <span class="keywordflow">return</span>(newSocket);
00109 }
00110 
00111 <span class="comment">/*************************************************************/</span>
00112 
<a name="l00113"></a><a class="code" href="socket__ew__common_8c.html#a7">00113</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a7">connect_ew</a>(SOCKET s, <span class="keyword">struct</span> sockaddr FAR* name, 
00114                <span class="keywordtype">int</span> namelen, <span class="keywordtype">int</span> timeout_msec)
00115 {
00116   <span class="comment">/* connect_ew() attempts to create a socket connection during a</span>
00117 <span class="comment">   * period specified by timeout.  </span>
00118 <span class="comment">   * Arguments s, name, and namelenare passed directly to connect().</span>
00119 <span class="comment">   * On success conect_ew() returns zero.</span>
00120 <span class="comment">   * On failure, either due to a network error, or a timeout, conect_ew</span>
00121 <span class="comment">   * closes the socket and returns SOCKET_ERROR.</span>
00122 <span class="comment">   * *Note:  The timeout clock starts after connect_ew() calls</span>
00123 <span class="comment">   * connect(), not when connect_ew() starts.</span>
00124 <span class="comment">   * A timeout value of -1 causes connect_ew() to revert to a blocking</span>
00125 <span class="comment">   * connect call.</span>
00126 <span class="comment">   * Caller can call socketGetError_ew() for details about any </span>
00127 <span class="comment">   * failures.</span>
00128 <span class="comment">   */</span>
00129 
00130    <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"connect_ew()"</span>;
00131 
00132    <span class="keywordtype">int</span>     retVal, ioctlRetVal, connectRetVal, selectRetVal;
00133    fd_set  ConnectedSockets;
00134    <span class="keywordtype">long</span>    lOnOff;
00135    <span class="keywordtype">int</span>     lastError;
00136    <span class="keyword">struct  </span>timeval SelectTimeout;
00137    
00138   <span class="keywordflow">if</span> ( EW_SOCKET_DEBUG )
00139     <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span> , <span class="stringliteral">"Entering %s\n"</span>, MyFuncName );
00140 
00141 <span class="comment">/* If there is no timeout, make the socket blocking</span>
00142 <span class="comment">   ************************************************/</span>
00143    <span class="keywordflow">if</span> ( timeout_msec == -1 )
00144    {
00145      lOnOff = 0;
00146      ioctlRetVal = ioctlsocket( s, FIONBIO, &amp;lOnOff );
00147      <span class="keywordflow">if</span> ( ioctlRetVal &lt; 0 )
00148      {
00149        <span class="keywordflow">if</span> ( EW_SOCKET_DEBUG )
00150          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00151                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName );
00152        retVal = -1;
00153        <span class="keywordflow">goto</span> Done;
00154      }
00155 
00156 <span class="comment">/* Try to get a connection (blocking)</span>
00157 <span class="comment"> **********************************/</span>
00158      <span class="keywordflow">if</span> ( connect( s, name, namelen ) == 0 )     <span class="comment">/* Got a connection */</span>
00159        retVal = 0;
00160      <span class="keywordflow">else</span>                                        <span class="comment">/* Didn't get a connection */</span>
00161        retVal = -1;
00162      
00163 <span class="comment">/* Change the socket back to non-blocking so</span>
00164 <span class="comment">   we don't screw up any further operations</span>
00165 <span class="comment">   *****************************************/</span>
00166       lOnOff = 1;
00167       ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00168       <span class="keywordflow">if</span> ( ioctlRetVal &lt; 0 )
00169       {
00170         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00171                <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName );
00172         retVal = -1;
00173       }
00174       <span class="keywordflow">goto</span> Done;
00175    }
00176    
00177 <span class="comment">/* Initiate a non-blocking connection request</span>
00178 <span class="comment">   ******************************************/</span>
00179    connectRetVal = connect( s, name, namelen );
00180 
00181    <span class="keywordflow">if</span> ( connectRetVal == 0 )                         <span class="comment">/* Got a connection */</span>
00182    {
00183       retVal = 0;
00184       <span class="keywordflow">goto</span> Done;
00185    }
00186 
00187    lastError = <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>();
00188 
00189    <span class="keywordflow">if</span> ( lastError != CONNECT_WOULDBLOCK_EW )         <span class="comment">/* Connect() error */</span>
00190    {
00191      <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"Connect request failed in connect_ew(): %s.\n"</span>,
00192             strerror(lastError) );
00193      retVal = -1;
00194      <span class="keywordflow">goto</span> Done;
00195    }
00196 
00197 <span class="comment">/* Hang around in select() until connect is successful</span>
00198 <span class="comment">                        or until timeout period expires</span>
00199 <span class="comment">   ****************************************************/</span>
00200    FD_ZERO( &amp;ConnectedSockets );
00201    FD_SET( s, &amp;ConnectedSockets );
00202 
00203    SelectTimeout.tv_sec  = timeout_msec/1000;
00204    SelectTimeout.tv_usec = (timeout_msec%1000)*1000;
00205 
00206    selectRetVal = select( s+1, 0, &amp;ConnectedSockets, 0, &amp;SelectTimeout );
00207 
00208 <span class="comment">/* select() failed </span>
00209 <span class="comment">   ***************/</span>
00210    <span class="keywordflow">if</span> ( selectRetVal == -1 )                           
00211    {
00212      <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"select() failed in connect_ew(). Error: %d\n"</span>,
00213             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() );
00214      retVal = -1;
00215    }
00216 
00217 <span class="comment">/* select() succeeded; connection may have been completed</span>
00218 <span class="comment">   ******************************************************/</span>
00219    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( selectRetVal &gt; 0  &amp;&amp;  FD_ISSET( s, &amp;ConnectedSockets ) )  
00220    {                                             
00221    <span class="comment">/* NOTE: For Solaris, we must do one more connection test.</span>
00222 <span class="comment">    *       Other possible tests besides getsockopt(SO_ERROR) could </span>
00223 <span class="comment">    *       be a zero-length read() or a call to getpeername() </span>
00224 <span class="comment">    */</span>    
00225      <span class="keywordtype">int</span> error, len, rc;
00226      error = 0;
00227      len = <span class="keyword">sizeof</span>(error);
00228      rc  = getsockopt(s, SOL_SOCKET, SO_ERROR, (<span class="keywordtype">char</span> *)&amp;error, &amp;len); 
00229      
00230      <span class="keywordflow">if</span> ( rc &lt; 0 )          <span class="comment">/* Pending error on some systems  */</span>
00231      {
00232        error = <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(); 
00233        retVal = -1;
00234      }
00235      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( error )      <span class="comment">/* Pending error on others systems */</span>
00236      {
00237        retVal = -1;
00238      }
00239      <span class="keywordflow">else</span>                   <span class="comment">/* OK, got a connection! */</span>
00240      {
00241        <span class="keywordflow">if</span> ( EW_SOCKET_DEBUG ) 
00242          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"Got a connection\n"</span> );
00243        retVal = 0;
00244      }
00245 
00246      <span class="keywordflow">if</span> ( retVal == -1  &amp;&amp;  <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a> ) 
00247        <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"connect_ew() connection failed; "</span>
00248              <span class="stringliteral">"getsockopt detected error: %s.\n"</span>, 
00249              strerror(error) ); 
00250    }
00251 
00252 <span class="comment">/* Only other possibility: select timed out! </span>
00253 <span class="comment">   *****************************************/</span>
00254    <span class="keywordflow">else</span>
00255    {
00256      <span class="keywordflow">if</span> ( EW_SOCKET_DEBUG ) <span class="comment">/* this line added by Alex 2/9/99 */</span>
00257        <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"connect timed out in connect_ew().\n"</span> );
00258      retVal = -1;
00259    }
00260    
00261 Done:
00262    <span class="keywordflow">if</span> ( retVal == -1 )
00263    {
00264      <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( s, SOCKET_CLOSE_SIMPLY_EW ); <span class="comment">/*skip setsockopt()*/</span>
00265      retVal = SOCKET_ERROR;
00266    }
00267    
00268    <span class="keywordflow">if</span> ( EW_SOCKET_DEBUG )
00269      <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00270    
00271    <span class="keywordflow">return</span>(retVal);
00272 }
00273 
00274 <span class="comment">/*************************************************************/</span>
00275 
<a name="l00276"></a><a class="code" href="socket__ew__common_8c.html#a8">00276</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a8">bind_ew</a> (SOCKET s, <span class="keyword">struct</span> sockaddr FAR* name, <span class="keywordtype">int</span> namelen )
00277 {
00278   <span class="comment">/* bind_ew() attempts to bind the socket s to a name/port number.</span>
00279 <span class="comment">     This is basicly same as normal bind() call, with some logging added.</span>
00280 <span class="comment">     Caller can call socketGetError_ew() for details about any failures.  </span>
00281 <span class="comment">  */</span>
00282 
00283   <span class="keywordtype">int</span> retVal;
00284   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"bind_ew()"</span>;
00285 
00286   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00287     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00288 
00289   retVal=bind(s,name,namelen);
00290   <span class="keywordflow">if</span> (retVal &lt; 0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00291     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00292           <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00293   
00294   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00295     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00296 
00297   <span class="keywordflow">return</span>(retVal);
00298 }
00299 
00300 <span class="comment">/*************************************************************/</span>
00301 
<a name="l00302"></a><a class="code" href="socket__ew__common_8c.html#a9">00302</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a9">listen_ew</a> (SOCKET s, <span class="keywordtype">int</span> backlog ) 
00303 {
00304   <span class="comment">/* listen_ew() signals the mysterious protocol stack god, that the</span>
00305 <span class="comment">     socket is ready to accept connections.</span>
00306 <span class="comment">     Arguments are passed directly to listen().</span>
00307 <span class="comment">     Caller can call socketGetError_ew() for details about any failures.  </span>
00308 <span class="comment">  */</span>
00309 
00310   <span class="keywordtype">int</span> retVal;
00311   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"listen_ew()"</span>;
00312 
00313   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00314     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00315 
00316   retVal=listen(s, backlog);
00317   <span class="keywordflow">if</span> (retVal &lt; 0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00318     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00319           <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00320 
00321   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00322     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00323 
00324   <span class="keywordflow">return</span>(retVal);
00325 }
00326 
00327 <span class="comment">/*************************************************************/</span>
00328 
<a name="l00329"></a><a class="code" href="socket__ew__common_8c.html#a10">00329</a> SOCKET <a class="code" href="socket__ew__common_8c.html#a10">accept_ew</a>(SOCKET s, <span class="keyword">struct</span> sockaddr FAR* addr, <span class="keywordtype">int</span> FAR* addrlen,
00330                  <span class="keywordtype">int</span> timeout_msec)
00331 {
00332   <span class="comment">/* accept_ew() attempts to accept a connection on a socket.</span>
00333 <span class="comment">     Arguments s, addr, addrlen are passed directly to accept(),</span>
00334 <span class="comment">     timeout_msec: length of time in milliseconds that accept_ew() </span>
00335 <span class="comment">      will wait before returning. Timeout is measure from the</span>
00336 <span class="comment">      point after the initial accept() call. </span>
00337 <span class="comment">     Pass timeout of -1 for accept_ew to revert to blocking </span>
00338 <span class="comment">      accept() call.</span>
00339 <span class="comment">     If no connection is accepted before the timeout expires, </span>
00340 <span class="comment">      or if an error occurs, the function returns INVALID_SOCKET.  </span>
00341 <span class="comment">     Caller can call socketGetError_ew() for details about </span>
00342 <span class="comment">     any failures. </span>
00343 <span class="comment">     If the latest socket error was WOULDBLOCK_EW, then </span>
00344 <span class="comment">      no connections were made during the timeout period.</span>
00345 <span class="comment">  */</span>
00346 
00347   SOCKET newSocket;
00348   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"accept_ew()"</span>;
00349   Time_ew StartTime;
00350   fd_set AcceptedSockets;
00351   <span class="keyword">struct </span>timeval SelectTimeout; 
00352   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00353   <span class="keywordtype">int</span> retVal;
00354   <span class="keywordtype">long</span> lOnOff;
00355   <span class="keywordtype">int</span> sel;
00356   
00357   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00358     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00359 
00360   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00361   <span class="keywordflow">if</span>(timeout_msec == -1)
00362   {
00363     lOnOff = 0;
00364     retVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00365     
00366     <span class="keywordflow">if</span> (retVal &lt; 0)
00367     {
00368       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00369         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00370               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00371       <span class="keywordflow">goto</span> Abort;
00372     }
00373   }
00374 
00375   newSocket=accept(s,addr,addrlen);
00376   
00377   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00378 <span class="comment">     change it back so that we don't screw up any further operations</span>
00379 <span class="comment">  */</span>
00380   <span class="keywordflow">if</span>(timeout_msec == -1)
00381   {
00382     lOnOff = 1;
00383     retVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00384     <span class="keywordflow">if</span> (retVal==SOCKET_ERROR)
00385     {
00386       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00387         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00388               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00389       <span class="keywordflow">goto</span> Abort;
00390     }
00391   }
00392   
00393   <span class="keywordflow">if</span> (newSocket == INVALID_SOCKET)
00394   {
00395     <span class="keywordflow">if</span> (<a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW)
00396     {
00397       FD_ZERO(&amp;AcceptedSockets);
00398       FD_SET(s,&amp;AcceptedSockets);
00399       StartTime=<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00400       <span class="keywordflow">while</span>( (sel = select(s+1, &amp;AcceptedSockets, 0, 0,
00401                            <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0)
00402       { <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00403         <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00404           <span class="keywordflow">return</span> INVALID_SOCKET;
00405         
00406         FD_ZERO(&amp;AcceptedSockets);
00407         FD_SET(s,&amp;AcceptedSockets);
00408         <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(1000);  <span class="comment">/* Sleep for a second, and then try again.*/</span>
00409       }
00410       <span class="keywordflow">if</span> (sel &lt; 0 &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00411       {
00412         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
00413               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
00414         <span class="keywordflow">goto</span> Abort;
00415       }
00416       newSocket=accept(s,addr,addrlen);
00417     }
00418     <span class="keywordflow">if</span>(newSocket == INVALID_SOCKET &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00419     {
00420       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00421             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00422     }
00423   }
00424   
00425   <span class="comment">/* Set the new socket to non-blocking mode */</span>
00426   lOnOff = 1;
00427   retVal = ioctlsocket(newSocket,FIONBIO,&amp;lOnOff);
00428   <span class="keywordflow">if</span> (retVal == SOCKET_ERROR)
00429   {
00430     <span class="keywordflow">if</span> (EW_SOCKET_DEBUG)
00431       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s setting new socket to non-blocking\n"</span>,
00432             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00433     <span class="keywordflow">goto</span> Abort;
00434   }
00435   <span class="keywordflow">return</span>(newSocket);
00436 
00437 Abort:
00438   <span class="keywordflow">if</span> (newSocket &gt; 0) <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>(newSocket, 0);
00439   newSocket = INVALID_SOCKET;
00440   <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>(s, 0);
00441   s = INVALID_SOCKET;
00442   <span class="keywordflow">return</span>(newSocket);
00443 }
00444 
00445 <span class="comment">/*************************************************************/</span>
00446 
<a name="l00447"></a><a class="code" href="socket__ew__common_8c.html#a11">00447</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a11">recv_all</a> (SOCKET s,<span class="keywordtype">char</span> FAR* buf,<span class="keywordtype">int</span> len,<span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> timeout_msec)
00448 {
00449   <span class="comment">/* recv_all attempts to receive data on a connection oriented scoket.</span>
00450 <span class="comment">     buf:     buffer for incoming data, which must be provided by the caller</span>
00451 <span class="comment">     len:     number of bytes to read; buffer must be at least len + 1 bytes.</span>
00452 <span class="comment">     flags:   flags that are passed directly to recv().</span>
00453 <span class="comment">     timeout: length of time in milliseconds that the recv_ew() will wait</span>
00454 <span class="comment">     before returning(if no data is received), after making the initial recv()</span>
00455 <span class="comment">     call.  </span>
00456 <span class="comment"></span>
00457 <span class="comment">     If timeout_msec &gt; 0, recv_all() returns when the sooner of two things</span>
00458 <span class="comment">     happens: </span>
00459 <span class="comment">     1.  The timeout from the time of the first recv() call, expires; </span>
00460 <span class="comment">     2.  "len" bytes of data are received.</span>
00461 <span class="comment"></span>
00462 <span class="comment">     recv_all() returns the number of bytes of data received, or SOCKET_ERROR</span>
00463 <span class="comment">     on error.  The caller is responsible for noting any discrepencies in the</span>
00464 <span class="comment">     difference between the number of bytes requested to be sent, and the</span>
00465 <span class="comment">     number of reported bytes sent.  If there is a discrepency, then a timeout</span>
00466 <span class="comment">     or error occured. Caller can call socketGetError_ew() for details about </span>
00467 <span class="comment">     any failures.</span>
00468 <span class="comment"></span>
00469 <span class="comment">     If timeout_msec == -1, recv_all() sets the socket to blocking and returns</span>
00470 <span class="comment">     when:</span>
00471 <span class="comment">     1. "len" bytes of data are received.</span>
00472 <span class="comment">     2. EOF is detected by recv returning 0 bytes.</span>
00473 <span class="comment">     */</span>
00474 
00475   <span class="keywordtype">int</span> retVal,ioctlRetVal;
00476   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"recv_all()"</span>;
00477   fd_set ReadableSockets;
00478   Time_ew StartTime;
00479   <span class="keyword">struct </span>timeval SelectTimeout; 
00480   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00481   <span class="keywordtype">int</span> BytesToRecv = len;
00482   <span class="keywordtype">int</span> BytesRcvd = 0;
00483   <span class="keywordtype">int</span> BytesJustRcvd;
00484   <span class="keywordtype">long</span> lOnOff;
00485   <span class="keywordtype">int</span> sel;
00486   
00487   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00488     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00489 
00490   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00491   <span class="keywordflow">if</span>(timeout_msec == -1)
00492   {
00493     lOnOff = 0;
00494     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00495     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00496     {
00497       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00498         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00499               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00500       <span class="keywordflow">return</span> ioctlRetVal;
00501     }
00502   }
00503 
00504   StartTime = <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00505   <span class="keywordflow">while</span> ( BytesRcvd &lt; BytesToRecv )
00506   {
00507     <span class="keywordflow">if</span> ( (timeout_msec &gt; 0) &amp;&amp; ((<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime ))
00508     {  <span class="comment">/* Time is up; return what we got */</span>
00509       retVal = BytesRcvd;
00510       <span class="keywordflow">goto</span> Done;
00511     }
00512     BytesJustRcvd = recv(s, buf + BytesRcvd, BytesToRecv - BytesRcvd, flags);
00513     <span class="keywordflow">if</span> ( BytesJustRcvd == 0 )        <span class="comment">/* apparently EOF */</span>
00514     {
00515       retVal = BytesRcvd;
00516       <span class="keywordflow">goto</span> Done;
00517     }
00518     <span class="keywordflow">if</span> ( BytesJustRcvd &lt; 0 ) <span class="comment">/* Error happened */</span>
00519     {
00520       <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW )
00521       {
00522         FD_ZERO(&amp;ReadableSockets);
00523         FD_SET(s,&amp;ReadableSockets);
00524         <span class="keywordflow">while</span>( (sel = select(s+1, &amp;ReadableSockets, 0, 0,
00525                        <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0)
00526         { <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00527           <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00528           {
00529             retVal = BytesRcvd;
00530             <span class="keywordflow">goto</span> Done;
00531           }
00532           FD_ZERO(&amp;ReadableSockets);
00533           FD_SET(s,&amp;ReadableSockets);
00534           <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100);  <span class="comment">/* Wait a while, and then try</span>
00535 <span class="comment">                             again */</span>
00536         }
00537         <span class="keywordflow">if</span> (sel &lt; 0)
00538         {
00539           <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
00540                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
00541           retVal = BytesRcvd;
00542           <span class="keywordflow">goto</span> Done;
00543         }
00544         
00545         <span class="comment">/* Set BytesJustRcvd, so that we are not kicked out of the</span>
00546 <span class="comment">           while loop because of a hard error on a recv.  Note: we</span>
00547 <span class="comment">           will still be kicked out if we have exceeded the timeout.</span>
00548 <span class="comment">        */</span>
00549         BytesJustRcvd = 0;
00550       }
00551       <span class="keywordflow">else</span>  <span class="comment">/* some other error occured */</span>
00552       {
00553         <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00554           <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00555                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00556         retVal = BytesJustRcvd; <span class="comment">/* the error condition */</span>
00557         <span class="keywordflow">goto</span> Done;
00558       }
00559     }  <span class="comment">/* End of If there was an error on recv() */</span>
00560     <span class="keywordflow">else</span>
00561     {
00562       BytesRcvd += BytesJustRcvd;
00563     }
00564   }  <span class="comment">/* End: while not all data sent */</span>
00565   retVal = BytesRcvd;
00566   
00567  Done:
00568   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00569 <span class="comment">     change it back so that we don't screw up any further operations</span>
00570 <span class="comment">  */</span>
00571   <span class="keywordflow">if</span>(timeout_msec == -1)
00572   {
00573     lOnOff = 1;
00574     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00575     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00576     {
00577       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00578         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00579               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00580     }
00581   }
00582   
00583   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00584     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00585   
00586   <span class="keywordflow">return</span>(retVal);
00587 }
00588 
00589 <span class="comment">/*************************************************************/</span>
00590 
<a name="l00591"></a><a class="code" href="socket__ew__common_8c.html#a12">00591</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a12">recv_ew</a> (SOCKET s, <span class="keywordtype">char</span> FAR* buf, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> timeout_msec)
00592 {
00593   <span class="comment">/* recv_ew attempts to receive data on a connection oriented scoket.</span>
00594 <span class="comment">     buf:     buffer for incoming data, which must be provided by the caller</span>
00595 <span class="comment">     len:     length of the buffer.</span>
00596 <span class="comment">     flags:   flags that are passed directly to recv().</span>
00597 <span class="comment">     timeout: length of time in milliseconds. that the recv_ew() will wait </span>
00598 <span class="comment">     before returning(if no data is received), after making</span>
00599 <span class="comment">     the initial recv() call. If data (or a shutdown request) is not</span>
00600 <span class="comment">     received before the timeout expires, or if an error occurs, the </span>
00601 <span class="comment">     function returns SOCKET_ERROR. As soon as any data is received, </span>
00602 <span class="comment">     the function returns; the function does not attempt to completely</span>
00603 <span class="comment">     fill the buffer before returning.  </span>
00604 <span class="comment">     Caller can call socketGetError_ew() for details about any failures.</span>
00605 <span class="comment">     If the latest socket error is WOULDBLOCK_EW, then recv_ew timed out</span>
00606 <span class="comment">     before receiving any data,</span>
00607 <span class="comment">     </span>
00608 <span class="comment">     If (-1) is passed for timeout_msec, then recv_ew() reverts to a blocking</span>
00609 <span class="comment">     recv() call.</span>
00610 <span class="comment">  */</span>
00611 
00612   <span class="keywordtype">int</span> retVal,ioctlRetVal;
00613   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"recv_ew()"</span>;
00614   fd_set ReadableSockets;
00615   Time_ew StartTime;
00616   <span class="keyword">struct </span>timeval SelectTimeout; 
00617   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00618   <span class="keywordtype">long</span> lOnOff;
00619   <span class="keywordtype">int</span> sel;
00620   
00621   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00622     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00623 
00624   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00625   <span class="keywordflow">if</span>(timeout_msec == -1)
00626   {
00627     lOnOff = 0;
00628     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00629     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00630     {
00631       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00632             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00633     }
00634   }
00635   retVal=recv(s,buf,len,flags);
00636   
00637   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00638 <span class="comment">     change it back so that we don't screw up any further operations</span>
00639 <span class="comment">  */</span>
00640   <span class="keywordflow">if</span>(timeout_msec == -1)
00641   {
00642     lOnOff = 1;
00643     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00644       <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00645       {
00646         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00647               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00648       }
00649   }
00650 
00651   <span class="comment">/* Use select() to wait for something to read. We use a small time interval</span>
00652 <span class="comment">   * (0.2 seconds) in select, and check the clock against timeout_msec (here</span>
00653 <span class="comment">   * converted to seconds) in a while() loop.</span>
00654 <span class="comment">   */</span>
00655   <span class="keywordflow">if</span> (retVal &lt; 0 &amp;&amp; <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW)
00656   {
00657     FD_ZERO(&amp;ReadableSockets);
00658     FD_SET(s,&amp;ReadableSockets);
00659     StartTime=<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00660     <span class="keywordflow">while</span>( (sel = select(s+1, &amp;ReadableSockets, 0, 0, 
00661                          <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0 )
00662     {  <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00663       
00664       <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00665         <span class="keywordflow">break</span>;
00666       FD_ZERO(&amp;ReadableSockets);
00667       FD_SET(s,&amp;ReadableSockets);
00668       <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100);  <span class="comment">/* Wait a while, and then try again */</span>
00669     }
00670     <span class="keywordflow">if</span> (sel &lt; 0)
00671     {
00672       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
00673             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
00674       <span class="keywordflow">return</span>(SOCKET_ERROR);
00675     }
00676     <span class="comment">/* Try to read, even if select() timed out */</span>
00677     retVal=recv(s,buf,len,flags);
00678   }
00679 
00680   <span class="keywordflow">if</span>(retVal &lt;0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00681   {
00682     <span class="keywordflow">if</span> (sel == 0)
00683       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Timeout occured in %s\n"</span>, MyFuncName);
00684     <span class="keywordflow">else</span>
00685       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00686             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00687   }
00688 
00689   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00690                 <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00691 
00692   <span class="keywordflow">return</span>(retVal);
00693 }
00694 
00695 <span class="comment">/*************************************************************/</span>
00696 
<a name="l00697"></a><a class="code" href="socket__ew__common_8c.html#a13">00697</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a13">recvfrom_ew</a> (SOCKET s, <span class="keywordtype">char</span> FAR* buf, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> flags, 
00698                           <span class="keyword">struct</span> sockaddr FAR* from, <span class="keywordtype">int</span> FAR* fromlen,
00699                           <span class="keywordtype">int</span> timeout_msec)
00700 {
00701 
00702   <span class="comment">/* recvfrom_ew() is similar to recv_ew(), except used for datagram</span>
00703 <span class="comment">     sockets.  timeout is specified in milliseconds.  Caller can call </span>
00704 <span class="comment">     socketGetError_ew() for details about any failures. </span>
00705 <span class="comment">  */</span>
00706 
00707   <span class="keywordtype">int</span> retVal, ioctlRetVal;
00708   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"recvfrom_ew()"</span>;
00709   fd_set ReadableSockets;
00710   Time_ew StartTime;
00711   <span class="keyword">struct </span>timeval SelectTimeout; 
00712   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00713   <span class="keywordtype">long</span> lOnOff;
00714   <span class="keywordtype">int</span> sel, flen;
00715   
00716   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00717     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00718 
00719 
00720   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00721   <span class="keywordflow">if</span>(timeout_msec == -1)
00722   {
00723     lOnOff = 0;
00724     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00725     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00726     {
00727       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00728             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00729       <span class="comment">/* Should we return this error, or continue? */</span>
00730     }
00731   }
00732   <span class="comment">/* Use a local copy of fromlen (because recvfrom sets fromlen=0 if socket is</span>
00733 <span class="comment">     non-blocking and there's no data =&gt; fromlen=0 input to second recvfrom) */</span>
00734   flen = *fromlen;
00735   retVal = recvfrom(s,buf,len,flags,from,&amp;flen);
00736 
00737   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00738 <span class="comment">     change it back so that we don't screw up any further operations */</span>
00739   <span class="keywordflow">if</span>(timeout_msec == -1)
00740   {
00741     lOnOff = 1;
00742     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00743     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00744     {
00745       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00746             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00747     }
00748   }
00749   
00750   <span class="keywordflow">if</span> (retVal &lt; 0 &amp;&amp; <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW)
00751   {
00752     FD_ZERO(&amp;ReadableSockets);
00753     FD_SET(s,&amp;ReadableSockets);
00754     StartTime=<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00755     <span class="keywordflow">while</span>( (sel = select(s+1, &amp;ReadableSockets, 0, 0,
00756                          <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0 )
00757     {  <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00758       
00759       <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00760         <span class="keywordflow">break</span>;
00761 
00762       FD_ZERO(&amp;ReadableSockets);
00763       FD_SET(s,&amp;ReadableSockets);
00764       <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100);  <span class="comment">/* Wait a while, and then try</span>
00765 <span class="comment">                    again */</span>
00766     }
00767     <span class="keywordflow">if</span> (sel &lt; 0)
00768     {
00769       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
00770             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
00771       <span class="keywordflow">return</span>(SOCKET_ERROR);
00772     }
00773     <span class="comment">/* Try to read, even if select() timed out */</span>
00774     flen = *fromlen;
00775     retVal = recvfrom(s,buf,len,flags,from,&amp;flen);
00776   }
00777 
00778   <span class="keywordflow">if</span>(retVal &lt;0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
00779   {
00780     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00781               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00782   }
00783 
00784   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00785                 <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00786 
00787   *fromlen = flen;
00788   <span class="keywordflow">return</span>(retVal);
00789 }
00790 
00791 <span class="comment">/*************************************************************/</span>
00792 
<a name="l00793"></a><a class="code" href="socket__ew__common_8c.html#a14">00793</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a14">send_ew</a> ( SOCKET s, <span class="keyword">const</span> <span class="keywordtype">char</span> FAR * buf, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> flags, 
00794               <span class="keywordtype">int</span> timeout_msec)
00795 {
00796   <span class="comment">/* Send `len' bytes from `buf' out a socket `s'.</span>
00797 <span class="comment">     Argument `flags' is passed directly to send().</span>
00798 <span class="comment">     If timeout_msec &gt; 0, send_ew() returns when the sooner of two things </span>
00799 <span class="comment">     happens:  </span>
00800 <span class="comment">     1.  The timeout measured in milliseconds expires;  </span>
00801 <span class="comment">     2.  All of the data provided by the caller is sent.</span>
00802 <span class="comment">     If timeout_msec == -1, the socket is set to blocking and send_ew() </span>
00803 <span class="comment">     returns when all the data is sent or an error occured.</span>
00804 <span class="comment">     send_ew() always returns when an unexpected error occurs.</span>
00805 <span class="comment">     send_ew() returns the number of bytes of data sent, or</span>
00806 <span class="comment">     SOCKET_ERROR on error.  The caller is responsible for noting</span>
00807 <span class="comment">     any discrepencies in the difference between the number of bytes</span>
00808 <span class="comment">     requested to be sent, and the number of reported bytes sent.  If</span>
00809 <span class="comment">     there is a discrepency, then a timeout may have occured.</span>
00810 <span class="comment">     Caller can call socketGetError_ew() for details about any failures.</span>
00811 <span class="comment">     If the latest socket error was WOULDBLOCK_EW, then </span>
00812 <span class="comment">      the timeout occured before all the data was sent.</span>
00813 <span class="comment">     */</span>
00814 
00815   <span class="keywordtype">int</span> retVal, ioctlRetVal;
00816   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"send_ew()"</span>;
00817   <span class="keywordtype">int</span> BytesToSend=len;
00818   <span class="keywordtype">int</span> BytesSent=0;
00819   <span class="keywordtype">int</span> BytesJustSent=0;
00820   Time_ew StartTime;
00821   fd_set WriteableSockets;
00822   <span class="keyword">struct </span>timeval SelectTimeout; 
00823   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00824   <span class="keywordtype">long</span> lOnOff;
00825   <span class="keywordtype">int</span> sel;
00826   
00827   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00828     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00829   
00830   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00831   <span class="keywordflow">if</span>(timeout_msec == -1)
00832   {
00833     lOnOff = 0;
00834     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00835     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00836     {
00837       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00838         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00839               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00840       <span class="keywordflow">return</span> (ioctlRetVal);
00841     }
00842   }
00843   
00844   StartTime = <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00845   <span class="keywordflow">while</span>( BytesSent &lt; BytesToSend )
00846   {
00847     <span class="keywordflow">if</span> ( (timeout_msec &gt;= 0) &amp;&amp; ((<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime ))
00848     {
00849       retVal = BytesSent;
00850       <span class="keywordflow">goto</span> Done;
00851     }
00852     BytesJustSent = send(s, buf+BytesSent, <a class="code" href="socket__ew_8h.html#a3">min</a>(len-BytesSent, MAXSENDSIZE_EW),
00853                          flags);
00854     <span class="keywordflow">if</span> (BytesJustSent &lt;= 0)
00855     {
00856       <span class="keywordflow">if</span> (BytesJustSent == 0 || <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW)
00857       {
00858         FD_ZERO(&amp;WriteableSockets);
00859         FD_SET(s,&amp;WriteableSockets);
00860         <span class="keywordflow">while</span>( (sel = select(s+1, 0, &amp;WriteableSockets, 0,
00861                              <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0)
00862         {  <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00863           <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00864           {
00865             retVal = BytesSent;
00866             <span class="keywordflow">goto</span> Done;
00867           }
00868           
00869           FD_ZERO(&amp;WriteableSockets);
00870           FD_SET(s,&amp;WriteableSockets);
00871           <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100);  <span class="comment">/* Wait a while, and then try again */</span>
00872         }
00873         <span class="keywordflow">if</span> (sel &lt; 0)
00874         {
00875           <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
00876                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
00877           retVal = BytesSent;
00878           <span class="keywordflow">goto</span> Done;
00879         }
00880 
00881         <span class="comment">/* Set BytesJustSent, so that we are not kicked out of the</span>
00882 <span class="comment">        while loop because of a hard error on a send.  Note:  we</span>
00883 <span class="comment">        will still be kicked out if we have exceeded the timeout.</span>
00884 <span class="comment">        */</span>
00885         BytesJustSent = 0;
00886       }
00887       <span class="keywordflow">else</span>  <span class="comment">/* some other error occured */</span>
00888       {
00889         <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00890           <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
00891                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00892         retVal = BytesSent;
00893         <span class="keywordflow">goto</span> Done;
00894       }
00895     }  <span class="comment">/* End of If there was an error on send() */</span>
00896     <span class="keywordflow">else</span>
00897     {
00898       BytesSent += BytesJustSent;
00899     }
00900   }  <span class="comment">/* End: while not all data sent */</span>
00901   retVal = BytesSent;
00902 
00903 Done:
00904   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00905 <span class="comment">  change it back so that we don't screw up any further operations</span>
00906 <span class="comment">  */</span>
00907   <span class="keywordflow">if</span>(timeout_msec == -1)
00908   {
00909     lOnOff = 1;
00910     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00911     <span class="keywordflow">if</span> (ioctlRetVal &lt; 0)
00912     {
00913       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00914         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00915         <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00916       retVal = SOCKET_ERROR;
00917     }
00918   }
00919 
00920   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00921     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
00922 
00923   <span class="keywordflow">return</span>(retVal);
00924 }
00925 
00926 <span class="comment">/*************************************************************/</span>
00927 
<a name="l00928"></a><a class="code" href="socket__ew__common_8c.html#a15">00928</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a15">sendto_ew</a> (SOCKET s, <span class="keyword">const</span> <span class="keywordtype">char</span> FAR * buf, <span class="keywordtype">int</span> len, 
00929                <span class="keywordtype">int</span> flags, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr FAR * to,
00930                <span class="keywordtype">int</span> tolen, <span class="keywordtype">int</span> timeout_msec)
00931 {
00932   <span class="comment">/* sendto_ew() is similar to send_ew(), except used for datagram</span>
00933 <span class="comment">     sockets. Once the socket is ready for sending, sendto_ew calls</span>
00934 <span class="comment">     sendto() only once. No checks are made to ensure all data is sent.</span>
00935 <span class="comment">     Arguments s, flags, to,  and tolen are passed directly to sendto().</span>
00936 <span class="comment">     Timeout is specified in milliseconds; value of -1 sets socket to </span>
00937 <span class="comment">     blocking mode and turns off timing. </span>
00938 <span class="comment">     Caller can call socketGetError_ew() for details about any failures. </span>
00939 <span class="comment">  */</span>
00940 
00941   <span class="keywordtype">int</span> retVal, ioctlRetVal;
00942   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"sendto_ew()"</span>;
00943   Time_ew StartTime;
00944   fd_set WriteableSockets;
00945   <span class="keyword">struct </span>timeval SelectTimeout; 
00946   Time_ew timeout=<a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00947   <span class="keywordtype">long</span> lOnOff;
00948   <span class="keywordtype">int</span> sel;
00949   
00950   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00951     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
00952 
00953   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00954   <span class="keywordflow">if</span>(timeout_msec == -1)
00955   {
00956     lOnOff = 0;
00957     ioctlRetVal=ioctlsocket(s,FIONBIO,&amp;lOnOff);
00958     <span class="keywordflow">if</span> (ioctlRetVal==SOCKET_ERROR)
00959     {
00960       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00961       {
00962         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to blocking\n"</span>,
00963               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00964       }
00965       <span class="keywordflow">return</span> ioctlRetVal;
00966     }
00967   }
00968   
00969   StartTime=<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>();
00970   retVal = sendto(s,buf,len,flags,to,tolen);
00971   
00972   <span class="comment">/* If there is no timeout, then the call was made blocking,</span>
00973 <span class="comment">     change it back so that we don't screw up any further operations</span>
00974 <span class="comment">  */</span>
00975   <span class="keywordflow">if</span>(timeout_msec == -1)
00976   {
00977     lOnOff = 1;
00978     ioctlRetVal = ioctlsocket(s,FIONBIO,&amp;lOnOff);
00979     <span class="keywordflow">if</span> (ioctlRetVal &lt; 0)
00980     {
00981       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
00982         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s during change to non-blocking\n"</span>,
00983         <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
00984       <span class="keywordflow">return</span> SOCKET_ERROR;
00985     }
00986   }
00987 
00988   <span class="keywordflow">if</span> (retVal &lt; 0 &amp;&amp; <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW)
00989   {
00990     FD_ZERO(&amp;WriteableSockets);
00991     FD_SET(s,&amp;WriteableSockets);
00992     <span class="keywordflow">while</span>( (sel = select(s+1, 0, &amp;WriteableSockets, 0,
00993                          <a class="code" href="ws__clientII_8c.html#a10">resetTimeout</a>(&amp;SelectTimeout))) == 0)
00994     {  <span class="comment">/* select timed out; if timeout hasn't expired, reset and try again */</span>
00995       <span class="keywordflow">if</span> ( <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout &gt; StartTime )
00996         <span class="keywordflow">return</span> SOCKET_ERROR;
00997 
00998       FD_ZERO(&amp;WriteableSockets);
00999       FD_SET(s,&amp;WriteableSockets);
01000       <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100);  
01001       <span class="comment">/* Wait a while, and then try again */</span>
01002     }
01003     <span class="keywordflow">if</span> (sel &lt; 0)
01004     {
01005       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"Error %d occured during select() in %s\n"</span>,
01006             <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(), MyFuncName);
01007       <span class="keywordflow">return</span> SOCKET_ERROR;
01008     }
01009     retVal=sendto(s,buf,len,flags,to,tolen);
01010   }
01011   
01012   <span class="keywordflow">if</span>(retVal &lt;0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
01013   {
01014     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
01015           <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
01016   }
01017   
01018   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01019     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
01020   
01021   <span class="keywordflow">return</span>(retVal);
01022 }
01023 
01024 <span class="comment">/*************************************************************/</span>
01025 
<a name="l01026"></a><a class="code" href="socket__ew__common_8c.html#a4">01026</a> <span class="keyword">struct </span>timeval FAR * <a class="code" href="socket__ew__common_8c.html#a4">resetTimeout</a>(struct timeval FAR * pSelectTimeout)
01027 {
01028 
01029   <span class="comment">/* resetTimeout() reinitializes the TIMEVAL structure used in</span>
01030 <span class="comment">     select() calls.  Depending on the OS, the timeout value</span>
01031 <span class="comment">     maybe altered during the select() call, and therefore needs</span>
01032 <span class="comment">     to be reinitialized before every select() call.</span>
01033 <span class="comment">     */</span>
01034   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"resetTimeout()"</span>;
01035   <span class="keyword">static</span> <span class="keywordtype">int</span> EW_SOCKET_DEBUG_R=0;
01036   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG_R)
01037     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
01038 
01039   pSelectTimeout-&gt;tv_sec=<a class="code" href="socket__ew__common_8c.html#a0">SELECT_TIMEOUT_SECONDS</a>;
01040   pSelectTimeout-&gt;tv_usec=<a class="code" href="socket__ew__common_8c.html#a1">SELECT_TIMEOUT_uSECONDS</a>;
01041 
01042   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG_R)
01043     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
01044 
01045   <span class="keywordflow">return</span>(pSelectTimeout);
01046 }
01047 
01048 <span class="comment">/*************************************************************/</span>
01049 
<a name="l01050"></a><a class="code" href="socket__ew__common_8c.html#a16">01050</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>(SOCKET s,<span class="keywordtype">int</span> HowToClose)
01051 {
01052   <span class="comment">/* closesocket_ew() closes the socket s.  HowToClose indicates</span>
01053 <span class="comment">     whether the socket should be closed gracefully or immediately.</span>
01054 <span class="comment">     Use SOCKET_CLOSE_IMMEDIATELY_EW or SOCKET_CLOSE_GRACEFULLY_EW</span>
01055 <span class="comment">     to indicate closure method.  Caller can call socketGetError_ew()</span>
01056 <span class="comment">     for details about any failures.</span>
01057 <span class="comment">  */</span>
01058 
01059   <span class="comment">/*</span>
01060 <span class="comment">    #define SOCKET_CLOSE_IMMEDIATELY_EW 0</span>
01061 <span class="comment">    #define SOCKET_CLOSE_GRACEFULLY_EW -1</span>
01062 <span class="comment">    #define SOCKET_CLOSE_SIMPLY_EW     -2</span>
01063 <span class="comment">  */</span>
01064 
01065   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"closesocket_ew()"</span>;
01066   <span class="keyword">struct </span>linger Linger_Value;
01067   <span class="keywordtype">int</span> retVal;
01068 
01069   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01070     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
01071 
01072 <span class="comment">/* Note1: setsockopt(SO_LINGER) doesn't seem to work on x86 Solaris 2.5, </span>
01073 <span class="comment">          at least when the socket isn't connected. WMK 981019   </span>
01074 <span class="comment">   Note2: Added the case SOCKET_CLOSE_SIMPLY_EW to skip the call to </span>
01075 <span class="comment">          setsockopt. This case is used in connect_ew when the connection</span>
01076 <span class="comment">          has failed.  LDD 981022</span>
01077 <span class="comment"> *************************************************************************/</span>
01078   <span class="keywordflow">if</span> ( HowToClose != <a class="code" href="socket__ew_8h.html#a2">SOCKET_CLOSE_SIMPLY_EW</a> )
01079   {
01080     <span class="keywordflow">if</span> ( HowToClose == <a class="code" href="socket__ew_8h.html#a0">SOCKET_CLOSE_IMMEDIATELY_EW</a> )
01081     {
01082       Linger_Value.l_onoff=1;     <span class="comment">/* Reset or hard close */</span>
01083       Linger_Value.l_linger=0;    <span class="comment">/* Set timeout to 0 seconds */</span>
01084     }
01085     <span class="keywordflow">else</span>
01086     {
01087       Linger_Value.l_onoff=0;     <span class="comment">/* Non-blocking graceful close (NBGC) */</span>
01088       Linger_Value.l_linger=0;
01089     }
01090     
01091     <span class="keywordflow">if</span> ( setsockopt(s,SOL_SOCKET,SO_LINGER,(<span class="keywordtype">char</span> *) &amp;Linger_Value,
01092                     <span class="keyword">sizeof</span>(<span class="keyword">struct</span> linger)) == -1 )
01093     {
01094       <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01095         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>, <span class="stringliteral">"closesocket_ew:setsockopt error: %s\n"</span>, 
01096                strerror(<a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>()) );
01097     }
01098   }
01099   
01100   retVal=closesocket(s);
01101   
01102   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01103     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
01104   
01105   <span class="keywordflow">return</span> (retVal);
01106 }
01107 
01108 <span class="comment">/*************************************************************/</span>
01109 
<a name="l01110"></a><a class="code" href="socket__ew__common_8c.html#a17">01110</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a17">select_ew</a> (<span class="keywordtype">int</span> nfds, fd_set FAR * readfds, fd_set FAR * writefds, 
01111                fd_set FAR * exceptfds, 
01112                <span class="keywordtype">int</span> timeout_msec)
01113 
01114      <span class="comment">/* select_ew() determines the state of sets of sockets, by </span>
01115 <span class="comment">     calling select().  Timeout is in milliseconds, and is</span>
01116 <span class="comment">     converted by select_ew to the select() timeout structure, and</span>
01117 <span class="comment">     passed on (to select()). No "-1" feature here; if you are willing to</span>
01118 <span class="comment">     block indefinitely in select(), you might as well wait in the actual</span>
01119 <span class="comment">     I/O call instead.</span>
01120 <span class="comment">     Caller can call socketGetError_ew() for details about any failures.</span>
01121 <span class="comment">     */</span>
01122 {
01123   <span class="keywordtype">int</span> retVal;
01124   <span class="keyword">static</span> <span class="keywordtype">char</span> * MyFuncName = <span class="stringliteral">"select_ew()"</span>;
01125   <span class="keyword">struct </span>timeval SelectTimeout={0,0};
01126 
01127   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01128     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Entering %s\n"</span>,MyFuncName);
01129   
01130   SelectTimeout.tv_usec=1000 * timeout_msec;
01131   
01132   retVal = select(nfds,readfds,writefds,exceptfds,&amp;SelectTimeout);
01133   <span class="keywordflow">if</span> (retVal &lt; 0  &amp;&amp; <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>)
01134     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Error: %d, occurred in %s\n"</span>,
01135           <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>(),MyFuncName);
01136   
01137   <span class="keywordflow">if</span>(EW_SOCKET_DEBUG)
01138     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"Exiting %s\n"</span>,MyFuncName);
01139   
01140   <span class="keywordflow">return</span>(retVal);
01141 }
01142 
01143 <span class="comment">/*************************************************************/</span>
01144 
<a name="l01145"></a><a class="code" href="socket__ew__common_8c.html#a18">01145</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a18">setSocket_ewDebug</a>(<span class="keywordtype">int</span> debug)
01146 {
01147   <span class="comment">/* setSocket_ewDebug() turns debugging on or off for </span>
01148 <span class="comment">     the SOCKET_ew routines.</span>
01149 <span class="comment">  */</span>
01150   <a class="code" href="socket__ew__common_8c.html#a2">EW_SOCKET_DEBUG</a>=debug;
01151   <span class="keywordflow">return</span>(0);
01152 }
01153 
01154 <span class="comment">/*************************************************************/</span>
01155 
<a name="l01156"></a><a class="code" href="socket__ew__common_8c.html#a19">01156</a> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a19">setSocket_ewSelectTimeout</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Timeout)
01157 {
01158   <span class="comment">/* setSocket_ewSelectTimeout() sets the timeout period</span>
01159 <span class="comment">     passed to select() calls made internally within the </span>
01160 <span class="comment">     SOCKET_ew routines.  The timeout period is in </span>
01161 <span class="comment">     milliseconds.</span>
01162 <span class="comment">  */</span>
01163   <a class="code" href="socket__ew__common_8c.html#a1">SELECT_TIMEOUT_uSECONDS</a>=1000*Timeout;
01164   <span class="keywordflow">return</span>(0);
01165 }
01166 
01167 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:10 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
