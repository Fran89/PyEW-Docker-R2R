<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>parse_usnsn.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>parse_usnsn.c</h1><a href="parse__usnsn_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: parse__usnsn_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.12  2002/03/22 20:44:24  lucky</span>
00011 <span class="comment"> *     pre v6.1 checkin</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.11  2001/08/02 22:40:21  davidk</span>
00014 <span class="comment"> *     typecast some double to float assignments to eliminate compiler</span>
00015 <span class="comment"> *     warnings on NT.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> *     Revision 1.10  2001/04/17 17:49:37  lucky</span>
00018 <span class="comment"> *     *** empty log message ***</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *     Revision 1.8  2000/10/02 21:29:58  lucky</span>
00021 <span class="comment"> *     The Debug printout of the entire file is now done only in extreme cases of</span>
00022 <span class="comment"> *     Debug being set to 10.</span>
00023 <span class="comment"> *     Changed the max length of phase field to PHA_LEN</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> *     Revision 1.7  2000/09/12 18:13:25  lucky</span>
00026 <span class="comment"> *     Plugged memory leak with nsnbuf.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> *     Revision 1.6  2000/06/26 20:36:41  lucky</span>
00029 <span class="comment"> *     NSN deletion now works!</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> *     Revision 1.5  2000/06/26 20:04:39  lucky</span>
00032 <span class="comment"> *     When encountering a delete message, we return RETURN_DELETE to the</span>
00033 <span class="comment"> *     calling program so that it can handle it appropriately.</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> *     Revision 1.4  2000/05/31 16:16:58  lucky</span>
00036 <span class="comment"> *     Fixed the check for deletion message -- used to be in line #4, now it</span>
00037 <span class="comment"> *     #3</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> *     Revision 1.3  2000/05/02 19:50:54  lucky</span>
00040 <span class="comment"> *     Cosmetic fixes needed to have NT compile without warnings.</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> *     Revision 1.2  2000/04/06 16:03:07  lucky</span>
00043 <span class="comment"> *     We now check to see if we got a Delete message. For now, we don't do anything</span>
00044 <span class="comment"> *     about it, only log a message and return FAILURE in hopes that the calling</span>
00045 <span class="comment"> *     program will deal with the consequences.</span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00048 <span class="comment"> *     Initial revision</span>
00049 <span class="comment"> *</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> */</span>
00052 
00053 <span class="comment">/*</span>
00054 <span class="comment"></span>
00055 <span class="comment">   parse_usnsn.c</span>
00056 <span class="comment"></span>
00057 <span class="comment"></span>
00058 <span class="comment">     Routines used to parse a text message from NEIC.</span>
00059 <span class="comment">    </span>
00060 <span class="comment">     A successful call to ParseNSNMsg fills the NSNStruct</span>
00061 <span class="comment">     with values from the text message contained in NsnMsg.</span>
00062 <span class="comment"></span>
00063 <span class="comment">     If debug is not 0, debug info will be written. If debug &gt; 1,</span>
00064 <span class="comment">     a file with the parsed values of the message will be </span>
00065 <span class="comment">     written in the debug_dir directory.</span>
00066 <span class="comment"></span>
00067 <span class="comment">     ParseNSNMsg returns EW_SUCCESS if everything goes well, </span>
00068 <span class="comment">     otherwise it returns EW_FAILURE.  </span>
00069 <span class="comment"></span>
00070 <span class="comment">     Only ParseNSNMsg() should be called from outside of this</span>
00071 <span class="comment">     file. All other functions in here are utilities used</span>
00072 <span class="comment">     by ParseNSNMsg()</span>
00073 <span class="comment"></span>
00074 <span class="comment">*/</span>
00075       
00076 
00077 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00078 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00079 <span class="preprocessor">#include &lt;math.h&gt;</span>
00080 <span class="preprocessor">#include &lt;<a class="code" href="parse__usnsn_8h.html">parse_usnsn.h</a>&gt;</span>
00081 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00082 <span class="preprocessor">#include &lt;<a class="code" href="rw__mag_8h.html">rw_mag.h</a>&gt;</span>
00083 
<a name="l00084"></a><a class="code" href="parse__usnsn_8c.html#a0">00084</a> <span class="preprocessor">#define     MAX_LINES       1000</span>
<a name="l00085"></a><a class="code" href="parse__usnsn_8c.html#a1">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define     MAX_LINE_SIZE   300</span>
00086 <span class="preprocessor"></span>
00087 
00088 <span class="keyword">extern</span>  <span class="keywordtype">int</span>             <a class="code" href="chron3_8c.html#a11">epochsec17</a> (<span class="keywordtype">double</span> *, <span class="keywordtype">char</span> *);
00089 
00090 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a3">ConvertNSNMsg</a> (<span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">char</span> **, <span class="keywordtype">int</span> *);
00091 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a4">ParsePhaseMagnitude</a> (<span class="keywordtype">char</span> *, <a class="code" href="struct__PhaseMag.html">PhaseMag</a> *);
00092 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a5">ParsePhase</a> (<span class="keywordtype">char</span> *, <a class="code" href="struct__PhaseStruct.html">Phase</a> *, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">double</span> *);
00093 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a6">ParseMagnitude</a> (<span class="keywordtype">char</span> *, <a class="code" href="struct__OriginMag.html">OriginMag</a> *);
00094 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a7">ParseEllipse</a> (<span class="keywordtype">char</span> *, <span class="keywordtype">double</span>, <a class="code" href="struct__ErrorElipse.html">Err_Elipse</a> *);
00095 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a8">AppendDateStr</a> (<span class="keywordtype">char</span>     *, <span class="keywordtype">char</span> *);
00096 <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a9">BuildDateStr</a> (<span class="keywordtype">char</span> *, <span class="keywordtype">char</span> *);
00097 <span class="keyword">static</span>  <span class="keywordtype">int</span>     <a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (<span class="keywordtype">char</span> **, <span class="keywordtype">int</span> *, <span class="keywordtype">char</span> *);
00098 
00099 <span class="comment">/************************************************************************</span>
00100 <span class="comment"> * ParseNSNMsg() - Fill the msg struct from the text supplied in </span>
00101 <span class="comment"> *                 nsnbuf.</span>
00102 <span class="comment"> ************************************************************************/</span>
<a name="l00103"></a><a class="code" href="parse__usnsn_8c.html#a11">00103</a> <span class="keywordtype">int</span>     <a class="code" href="parse__usnsn_8c.html#a11">ParseNSNMsg</a> (<span class="keywordtype">char</span> *NsnMsg, <span class="keywordtype">int</span> msgLen, 
00104                                 <a class="code" href="struct__NSNMsgStruct.html">NSNStruct</a> *msgStruct, <span class="keywordtype">int</span> debug, <span class="keywordtype">char</span> *debug_dir)
00105 {
00106         <span class="keywordtype">int</span>             i, j;
00107         <span class="keywordtype">char</span>    datestr[15];
00108         <span class="keywordtype">char</span>    DateStr[20];
00109         <span class="keywordtype">char</span>    tmp1[256];
00110         <span class="keywordtype">char</span>    tmp2[256];
00111         <span class="keywordtype">char</span>    tmp3[256];
00112         <span class="keywordtype">int</span>             lineno;
00113         FILE    *fp;
00114         <span class="keywordtype">char</span>    filename[100];
00115     <span class="keywordtype">char</span>    **nsnbuf;
00116     <span class="keywordtype">int</span>     nlines;
00117     <span class="keywordtype">int</span>     isAuto;
00118 
00119 
00120 
00121         <span class="keywordflow">if</span> ((NsnMsg == NULL) || (msgStruct == NULL) || (debug_dir == NULL))
00122         {
00123                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Invalid parameters passed in.\n"</span>);
00124                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00125         }       
00126 
00127         nsnbuf = (<span class="keywordtype">char</span> **) malloc (MAX_LINES * <span class="keyword">sizeof</span> (<span class="keywordtype">char</span> *));
00128         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="parse__usnsn_8c.html#a0">MAX_LINES</a>; i++)
00129                 nsnbuf[i] = (<span class="keywordtype">char</span> *) malloc (MAX_LINE_SIZE * <span class="keyword">sizeof</span> (<span class="keywordtype">char</span>));
00130 
00131 
00132         <span class="comment">/* Create nsnbuf (array of lines) for easier parsing</span>
00133 <span class="comment">         ****************************************************/</span>
00134         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a3">ConvertNSNMsg</a> (NsnMsg, msgLen, nsnbuf, &amp;nlines) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00135         {
00136                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to ConvertNSNMsg failed\n"</span>);
00137                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00138         }
00139 
00140 
00141         <span class="comment">/* skip the first two lines */</span>
00142         lineno = 2;
00143 
00144 
00145         <span class="comment">/* First, we have to see if this is a deletion message.</span>
00146 <span class="comment">           We don't do anything with it, so if we get it, we'll</span>
00147 <span class="comment">           just return FAILURE, and let the calling program deal </span>
00148 <span class="comment">           with the ramifications.</span>
00149 <span class="comment">         ********************************************************/</span>
00150         sscanf (nsnbuf[lineno + 3], <span class="stringliteral">"%s\n"</span>, tmp1);
00151         <span class="keywordflow">if</span> (strcmp (tmp1, <span class="stringliteral">"EVENT"</span>) == 0)
00152         {
00153                 <span class="comment">/* Yup, it's a deletion message */</span>
00154 
00155                 <span class="comment">/* extract the NSN event key */</span>
00156                 strncpy (msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>, (nsnbuf[lineno + 3] + 21), 4);
00157                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>[4] = <span class="charliteral">'\0'</span>;
00158                 
00159                 <span class="keywordflow">return</span> <a class="code" href="parse__usnsn_8h.html#a38">RETURN_DELETE</a>;
00160         }
00161 
00162         <span class="comment">/* see if this is an automatic, or a reviewed solution */</span>
00163         sscanf (nsnbuf[lineno], <span class="stringliteral">"%s\n"</span>, tmp1);
00164         <span class="keywordflow">if</span> (strcmp (tmp1, <span class="stringliteral">"The"</span>) == 0)
00165         {
00166                 <span class="comment">/* Yup, it's an automatic: skip four more lines */</span>
00167                 lineno = lineno + 4;
00168                 isAuto = 1;
00169         }
00170         <span class="keywordflow">else</span>
00171         {
00172                 <span class="comment">/* it's a reviewed solution message: we are at the first line */</span>
00173                 isAuto = 0;
00174         }
00175 
00176 
00177 <span class="comment">/*</span>
00178 <span class="comment"> * line 1; extract date, comment, event key, whether it is preliminary</span>
00179 <span class="comment"> *********************************************************************/</span>
00180         strncpy (datestr, (nsnbuf[lineno] + DATE_BASE), 11);
00181         datestr[11] = <span class="charliteral">'\0'</span>;
00182 
00183         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a9">BuildDateStr</a> (datestr, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m1">EventDate</a>) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00184         {
00185                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Call to BuildDateStr failed.\n"</span>);
00186                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00187         }
00188 
00189         strncpy (msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>, (nsnbuf[lineno] + EVENT_KEY_BASE), 4);
00190         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>[4] = <span class="charliteral">'\0'</span>;
00191 
00192         <span class="keywordflow">if</span> (nsnbuf[lineno][<a class="code" href="parse__usnsn_8h.html#a3">PRELIM_BASE</a>] == <span class="charliteral">'p'</span>)
00193         {
00194                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m2">automatic</a> = 1;
00195         }
00196         <span class="keywordflow">else</span>
00197         {
00198                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m2">automatic</a> = 0;
00199         }
00200 
00201         
00202 <span class="comment">/*</span>
00203 <span class="comment"> * line 2; extract origin time and error</span>
00204 <span class="comment"> *********************************************************************/</span>
00205         lineno = lineno + 1;
00206         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"ot"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00207         {
00208                 sscanf (nsnbuf[lineno], <span class="stringliteral">"    ot  = %s   +/-   %s\n"</span>, tmp1, tmp2);
00209 
00210                 strcpy (DateStr, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m1">EventDate</a>);
00211                 <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a8">AppendDateStr</a> (DateStr, tmp1) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00212                 {
00213                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Call to AppendDateStr failed.\n"</span>);
00214                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00215                 }
00216 
00217                 <a class="code" href="chron3_8c.html#a11">epochsec17</a> (&amp;msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m3">ot</a>, DateStr);
00218                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m4">ot_err</a> = (double) atof (tmp2);
00219         }
00220         <span class="keywordflow">else</span>
00221         {
00222                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00223                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00224         }
00225 
00226 <span class="comment">/*</span>
00227 <span class="comment"> * line 3; extract latitude </span>
00228 <span class="comment"> *********************************************************************/</span>
00229         lineno = lineno + 1;
00230         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"lat"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00231         {
00232                 sscanf (nsnbuf[lineno], <span class="stringliteral">"    lat = %s   +/-   %s\n"</span>, tmp1, tmp2);
00233 
00234                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m5">lat</a> = (float) atof (tmp1);
00235                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m6">lat_err</a> = (float) atof (tmp2);
00236         }
00237         <span class="keywordflow">else</span>
00238         {
00239                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00240                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00241         }
00242 
00243 <span class="comment">/*</span>
00244 <span class="comment"> * line 4; extract longitude </span>
00245 <span class="comment"> *********************************************************************/</span>
00246         lineno = lineno + 1;
00247         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"lon"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00248         {
00249                 sscanf (nsnbuf[lineno], <span class="stringliteral">"    lon = %s   +/-   %s\n"</span>, tmp1, tmp2);
00250 
00251                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m7">lon</a> = (float) atof (tmp1);
00252                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m8">lon_err</a> = (float) atof (tmp2);
00253         }
00254         <span class="keywordflow">else</span>
00255         {
00256                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00257                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00258         }
00259 
00260 
00261 <span class="comment">/*</span>
00262 <span class="comment"> * line 5; extract depth </span>
00263 <span class="comment"> *********************************************************************/</span>
00264         lineno = lineno + 1;
00265         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"dep"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00266         {
00267                 <span class="comment">/* Depth could have an error */</span>
00268                 <span class="keywordflow">if</span> (nsnbuf[lineno][<a class="code" href="parse__usnsn_8h.html#a1">DEPTH_BASE</a>] == <span class="charliteral">'+'</span>)
00269                 {
00270                         sscanf (nsnbuf[lineno], <span class="stringliteral">"    dep = %s   +/-   %s\n"</span>, tmp1, tmp2);
00271                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m9">depth</a> = (float) atof (tmp1);
00272                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m10">depth_err</a> = (float) atof (tmp2);
00273 
00274                 }
00275                 <span class="keywordflow">else</span>
00276                 {
00277                         <span class="comment">/* no +/- error, we have some string there */</span>
00278                         sscanf (nsnbuf[lineno], <span class="stringliteral">"    dep = %s\n"</span>, tmp1);
00279                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m9">depth</a> = (float) atof (tmp1);
00280                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m10">depth_err</a> = (double) 0.0;
00281                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m11">depth_fixed</a> = 1;
00282                 }
00283         }
00284         <span class="keywordflow">else</span>
00285         {
00286                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00287                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00288         }
00289 
00290 <span class="comment">/*</span>
00291 <span class="comment"> * line 6; extract number of phases and std error</span>
00292 <span class="comment"> *********************************************************************/</span>
00293         lineno = lineno + 1;
00294         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"nph"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00295         {
00296                 sscanf (nsnbuf[lineno], <span class="stringliteral">"    nph = %s of %s    se = %s  \n"</span>, tmp1, tmp2, tmp3);
00297                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m12">nph_used</a> = atoi (tmp1);
00298                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m13">nph_assoc</a> = atoi (tmp2);
00299                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m16">std_error</a> = (double) atof (tmp3);
00300         }
00301         <span class="keywordflow">else</span>
00302         {
00303                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned P3DB_FAILURE; exitting\n"</span>);
00304                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00305         }
00306 
00307 
00308 <span class="comment">/*</span>
00309 <span class="comment"> * line 7; extract the error elipse</span>
00310 <span class="comment"> *********************************************************************/</span>
00311         lineno = lineno + 1;
00312         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"error"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00313         {
00314                 strncpy (tmp1, (nsnbuf[lineno] + ELLIPSE_BASE), (size_t) ELLIPSE_LENGTH);
00315                 tmp1[<a class="code" href="parse__usnsn_8h.html#a5">ELLIPSE_LENGTH</a>] =<span class="charliteral">'\0'</span>;
00316 
00317                 <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a7">ParseEllipse</a> (tmp1, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m10">depth_err</a>, &amp;msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m17">error</a>) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00318                 {
00319                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Call to ParseEllipse failed.\n"</span>);
00320                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00321                 }
00322         }
00323         <span class="keywordflow">else</span>
00324         {
00325                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00326                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00327         }
00328 
00329 <span class="comment">/*</span>
00330 <span class="comment"> * line 8; extract magnitudes</span>
00331 <span class="comment"> *********************************************************************/</span>
00332         lineno = lineno + 1;
00333         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"mb"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00334         {
00335                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m18">numMags</a> = 5;
00336                 <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a6">ParseMagnitude</a> (nsnbuf[lineno], msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00337                 {
00338                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Call to ParseMagnitude failed.\n"</span>);
00339                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00340                 }
00341         }
00342         <span class="keywordflow">else</span>
00343         {
00344                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00345                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00346         }
00347 
00348 <span class="comment">/*</span>
00349 <span class="comment"> * line 9; find the beginning of the picks section</span>
00350 <span class="comment"> *********************************************************************/</span>
00351         lineno = lineno + 1;
00352         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (nsnbuf, &amp;lineno, <span class="stringliteral">"sta"</span>) == <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00353         {
00354 
00355                 <span class="comment">/* Now, read and parse all the phases */</span>
00356                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m14">nph_actual</a> = 0;
00357                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m15">Dmin</a> = <a class="code" href="parse__usnsn_8h.html#a6">EARTH_CIRCUM</a>;
00358                 <span class="keywordflow">for</span> (i = 0; i &lt; msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m13">nph_assoc</a>; i++)
00359                 {
00360                         lineno = lineno + 1;
00361                         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a5">ParsePhase</a> (nsnbuf[lineno], &amp;msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m14">nph_actual</a>],
00362                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m1">EventDate</a>, &amp;msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m14">nph_actual</a>, 
00363                                                         &amp;msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m15">Dmin</a>) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00364                         {
00365                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Call to ParsePhase failed.\n"</span>);
00366                                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00367                         }
00368                 }
00369 
00370 
00371                 <span class="keywordflow">if</span> (debug &gt; 10)
00372                 {
00373                         <span class="comment">/* Print the parsed version of the message</span>
00374 <span class="comment">                         ********************************************/</span>
00375                         sprintf (filename, <span class="stringliteral">"%s/%s-%s"</span>, 
00376                                                 debug_dir, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m1">EventDate</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>);
00377                         
00378                         fp = fopen (filename, <span class="stringliteral">"wt"</span>);
00379 
00380 
00381                         <span class="comment">/*** This is where we are done ****/</span>
00382                         fprintf (fp, <span class="stringliteral">"\n===&gt; PRINTING SUMMARY FOR EVENT %s \n"</span>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m0">EventKey</a>);
00383                         fprintf (fp, <span class="stringliteral">"Event Date: %s\n"</span>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m1">EventDate</a>);
00384                         fprintf (fp, 
00385                                                 <span class="stringliteral">"ot=%0.2f,%0.2f; lat=%0.2f,%0.2f; lon=%0.2f,%0.2f; dep=%0.2f,%0.2f\n"</span>, 
00386                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m3">ot</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m4">ot_err</a>,
00387                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m5">lat</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m6">lat_err</a>,
00388                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m7">lon</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m8">lon_err</a>,
00389                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m9">depth</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m10">depth_err</a>);
00390                         fprintf (fp, <span class="stringliteral">"Magnitudes computed: \n"</span>);
00391                         fprintf (fp, <span class="stringliteral">"\t %c (%d) = %0.2f from %d phases\n"</span>, 
00392                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[0].<a class="code" href="struct__OriginMag.html#m1">magLabel</a>,
00393                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[0].<a class="code" href="struct__OriginMag.html#m0">MagType</a>,
00394                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[0].<a class="code" href="struct__OriginMag.html#m2">magAvg</a>, 
00395                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[0].<a class="code" href="struct__OriginMag.html#m3">numStas</a>);
00396                         fprintf (fp, <span class="stringliteral">"\t %c (%d) = %0.2f from %d phases\n"</span>, 
00397                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[1].<a class="code" href="struct__OriginMag.html#m1">magLabel</a>,
00398                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[1].<a class="code" href="struct__OriginMag.html#m0">MagType</a>,
00399                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[1].<a class="code" href="struct__OriginMag.html#m2">magAvg</a>, 
00400                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[1].<a class="code" href="struct__OriginMag.html#m3">numStas</a>);
00401                         fprintf (fp, <span class="stringliteral">"\t %c (%d) = %0.2f from %d phases\n"</span>, 
00402                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[2].<a class="code" href="struct__OriginMag.html#m1">magLabel</a>,
00403                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[2].<a class="code" href="struct__OriginMag.html#m0">MagType</a>,
00404                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[2].<a class="code" href="struct__OriginMag.html#m2">magAvg</a>, 
00405                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[2].<a class="code" href="struct__OriginMag.html#m3">numStas</a>);
00406                         fprintf (fp, <span class="stringliteral">"\t %c (%d) = %0.2f from %d phases\n"</span>, 
00407                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[3].<a class="code" href="struct__OriginMag.html#m1">magLabel</a>,
00408                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[3].<a class="code" href="struct__OriginMag.html#m0">MagType</a>,
00409                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[3].<a class="code" href="struct__OriginMag.html#m2">magAvg</a>,     
00410                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[3].<a class="code" href="struct__OriginMag.html#m3">numStas</a>);
00411                         fprintf (fp, <span class="stringliteral">"\t %c (%d) = %0.2f from %d phases\n"</span>, 
00412                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[4].<a class="code" href="struct__OriginMag.html#m1">magLabel</a>,
00413                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[4].<a class="code" href="struct__OriginMag.html#m0">MagType</a>,
00414                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[4].<a class="code" href="struct__OriginMag.html#m2">magAvg</a>, 
00415                                                                                 msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m19">O_mag</a>[4].<a class="code" href="struct__OriginMag.html#m3">numStas</a>);
00416                         
00417                         fprintf (fp, <span class="stringliteral">"\nThere were total of %d phases, of which %d were marked as used\n"</span>,
00418                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m13">nph_assoc</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m12">nph_used</a>);
00419                         fprintf (fp, <span class="stringliteral">"Std error (RMS) was %0.2f: \n"</span>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m16">std_error</a>);
00420                         fprintf (fp, <span class="stringliteral">"Of those, we parsed the following %d phases: \n"</span>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m14">nph_actual</a>);
00421                         <span class="keywordflow">for</span> (i = 0; i &lt; msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m14">nph_actual</a>; i++)
00422                         {
00423                           fprintf (fp, <span class="stringliteral">"%s %s (%c %c) %0.2f   %0.1f,%0.1f,%d MAGS  "</span>,
00424                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m0">sta</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m1">phase</a>,
00425                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m3">onset</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m4">motion</a>,
00426                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m5">ot</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m6">res</a>,
00427                                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m8">dist</a>, msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m9">azm</a>);
00428                         
00429                           <span class="keywordflow">for</span> (j = 0; j &lt; msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a>; j++)
00430                           {
00431                             <span class="keywordflow">if</span> (msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m5">used</a> == 1)
00432                               fprintf (fp, <span class="stringliteral">"USED %c (%d),%0.1f,%0.2f ==&gt; %0.1f  "</span>, 
00433                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m1">magLabel</a>,
00434                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m0">MagType</a>,
00435                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m2">value</a>,
00436                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m3">period</a>,
00437                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m4">mag</a>);
00438                             <span class="keywordflow">else</span>
00439                               fprintf (fp, <span class="stringliteral">"NOT USED %c (%d),%0.1f,%0.2f ==&gt; %0.1f  "</span>, 
00440                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m1">magLabel</a>,
00441                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m0">MagType</a>,
00442                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m2">value</a>,
00443                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m3">period</a>,
00444                                         msgStruct-&gt;<a class="code" href="struct__NSNMsgStruct.html#m20">phases</a>[i].<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[j].<a class="code" href="struct__PhaseMag.html#m4">mag</a>);
00445                           }
00446                           fprintf (fp, <span class="stringliteral">"\n"</span>);
00447                         
00448                         }
00449 
00450                         fclose (fp);
00451                 }
00452                 
00453         }
00454         <span class="keywordflow">else</span>
00455         {
00456                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"GetNextLine returned EW_FAILURE; exitting\n"</span>);
00457                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00458         }
00459 
00460 
00461         <span class="comment">/* free up allocated space */</span>
00462         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="parse__usnsn_8c.html#a0">MAX_LINES</a>; i++)
00463                 free ((<span class="keywordtype">void</span> *) nsnbuf[i]);
00464         free ((<span class="keywordtype">void</span> *) nsnbuf);
00465 
00466 <span class="comment">/*</span>
00467 <span class="comment">logit ("", "BEFORE RETURN\n");</span>
00468 <span class="comment">for (i = 0; i &lt; msgStruct-&gt;nph_actual; i++)</span>
00469 <span class="comment">  logit ("", "Chan %d, &lt;%s&gt;\n", i, msgStruct-&gt;phases[i].sta);</span>
00470 <span class="comment">*/</span>
00471 
00472 
00473         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00474 
00475 }
00476 
00477 
00478 <span class="comment">/************************************************************************</span>
00479 <span class="comment"> * ConvertNSNMsg () - fill the buffer with the stuff in msg.</span>
00480 <span class="comment"> *   set nlines to the number of lines read.</span>
00481 <span class="comment"> ************************************************************************/</span>
<a name="l00482"></a><a class="code" href="parse__usnsn_8c.html#a3">00482</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a3">ConvertNSNMsg</a> (<span class="keywordtype">char</span> *msg, <span class="keywordtype">int</span> msgsize, <span class="keywordtype">char</span> **buffer, <span class="keywordtype">int</span> *nlines)
00483 {
00484 
00485         <span class="keywordtype">int</span>             i, j, done;
00486         <span class="keywordtype">char</span>    *line;
00487 
00488         <span class="keywordflow">if</span> ((buffer == NULL) || (msg == NULL) || (msgsize &lt; 0))
00489         {
00490                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"ConvertNSNMsg: Invalid parameters passed in.\n"</span>);
00491                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00492         }
00493 
00494         *nlines = 0;
00495 
00496         done = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00497         i = 0;
00498         j = 0;
00499         <span class="keywordflow">while</span> (done == <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>)
00500         {
00501                 
00502                 line = buffer[*nlines];
00503 
00504                 <span class="keywordflow">while</span> ((msg[i] != <span class="charliteral">'\n'</span>) &amp;&amp; (i &lt; msgsize))
00505                 {
00506                         line[j] = msg[i];
00507                         i = i + 1;
00508                         j = j + 1;
00509                 }
00510                 <span class="keywordflow">if</span> (msg[i] == <span class="charliteral">'\n'</span>)
00511                 {
00515                         line[j] = <span class="charliteral">'\n'</span>;
00516                         *nlines = *nlines + 1;
00517                         j = 0;
00518                         i = i + 1;
00519                 }
00520                 <span class="keywordflow">else</span>
00521                 {
00522                         line[j] = <span class="charliteral">'\0'</span>;
00523                         done = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00524                 }
00525                         
00526         }
00527 
00528         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00529 }
00530 
00531 
00532 
00533 <span class="comment">/************************************************************************</span>
00534 <span class="comment"> * GetNextLine () - return the next line from the message (in buffer)</span>
00535 <span class="comment"> *  where the first word of the line is given by argument word.</span>
00536 <span class="comment"> ************************************************************************/</span>
<a name="l00537"></a><a class="code" href="parse__usnsn_8c.html#a10">00537</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>     <a class="code" href="parse__usnsn_8c.html#a10">GetNextLine</a> (<span class="keywordtype">char</span> **buffer, <span class="keywordtype">int</span> *lineno, <span class="keywordtype">char</span> *word)
00538 {
00539 
00540         <span class="keywordtype">char</span>    tmp[256];
00541         <span class="keywordtype">int</span>             done;
00542 
00543         <span class="keywordflow">if</span> ((buffer == NULL) || (word == NULL))
00544         {
00545                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00546                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00547         }
00548 
00549         done = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00550         <span class="keywordflow">while</span> (done == <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>)
00551         {
00552                 <span class="keywordflow">if</span> (strlen (buffer[*lineno]) == 1)
00553                         ;
00554                 <span class="keywordflow">else</span>
00555                 {
00556                         <span class="comment">/* Check the first word */</span>
00557 
00558                         sscanf (buffer[*lineno], <span class="stringliteral">"%s\n"</span>, tmp);
00559 
00560                         <span class="keywordflow">if</span> (strcmp (tmp, word) == 0)
00561                         {
00562                                 done = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00563                         }
00564                         <span class="keywordflow">else</span>
00565                                 ;
00566                 }
00567 
00568                 <span class="keywordflow">if</span> (done != <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>)
00569                         *lineno = *lineno + 1;
00570         }
00571 
00572         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00573 }
00574 
00575 
00576 <span class="comment">/************************************************************************</span>
00577 <span class="comment"> * BuildDateStr () - Create a date string suitable for a call to </span>
00578 <span class="comment"> *   epochsec17, from an NSN format date string.</span>
00579 <span class="comment"> ************************************************************************/</span>
<a name="l00580"></a><a class="code" href="parse__usnsn_8c.html#a9">00580</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a9">BuildDateStr</a> (<span class="keywordtype">char</span> *in, <span class="keywordtype">char</span> *out)
00581 {
00582 
00583         <span class="keywordtype">char</span>    year[6];
00584         <span class="keywordtype">char</span>    month[6];
00585         <span class="keywordtype">char</span>    day[6];
00586 
00587         <span class="keywordflow">if</span> ((in == NULL) || (out == NULL))
00588         {
00589                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00590                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00591         }
00592 
00593         strncpy (day, in, 2);
00594         day[2] = <span class="charliteral">'\0'</span>;
00595 
00596         <span class="keywordflow">if</span> (day[0] == <span class="charliteral">' '</span>)
00597                 day[0] =<span class="charliteral">'0'</span>;
00598 
00599         <span class="comment">/* figure out the month */</span>
00600         <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'J'</span>)
00601         {
00602                 <span class="keywordflow">if</span> (in[4] == <span class="charliteral">'A'</span>)
00603                         sprintf (month, <span class="stringliteral">"01"</span>);
00604                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[4] == <span class="charliteral">'U'</span>)
00605                 {
00606                         <span class="keywordflow">if</span> (in[5] == <span class="charliteral">'N'</span>)
00607                                 sprintf (month, <span class="stringliteral">"06"</span>);
00608                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[5] == <span class="charliteral">'L'</span>)
00609                                 sprintf (month, <span class="stringliteral">"07"</span>);
00610                         <span class="keywordflow">else</span>
00611                         {
00612                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Unknown month %s!\n"</span>, month);
00613                                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00614                         }
00615                 }
00616                 <span class="keywordflow">else</span>
00617                 {
00618                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Unknown month %s!\n"</span>, month);
00619                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00620                 }
00621         }
00622         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'M'</span>)
00623         {
00624                 <span class="keywordflow">if</span> (in[5] == <span class="charliteral">'R'</span>)
00625                         sprintf (month, <span class="stringliteral">"03"</span>);
00626                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[5] == <span class="charliteral">'Y'</span>)
00627                         sprintf (month, <span class="stringliteral">"05"</span>);
00628                 <span class="keywordflow">else</span>
00629                 {
00630                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Unknown month %s!\n"</span>, month);
00631                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00632                 }
00633         }
00634         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'A'</span>)
00635         {
00636                 <span class="keywordflow">if</span> (in[4] == <span class="charliteral">'P'</span>)
00637                         sprintf (month, <span class="stringliteral">"04"</span>);
00638                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[4] == <span class="charliteral">'U'</span>)
00639                         sprintf (month, <span class="stringliteral">"08"</span>);
00640                 <span class="keywordflow">else</span>
00641                 {
00642                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Unknown month %s!\n"</span>, month);
00643                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00644                 }
00645         }
00646         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'F'</span>)
00647                 sprintf (month, <span class="stringliteral">"02"</span>);
00648         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'S'</span>)
00649                 sprintf (month, <span class="stringliteral">"09"</span>);
00650         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'O'</span>)
00651                 sprintf (month, <span class="stringliteral">"10"</span>);
00652         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'N'</span>)
00653                 sprintf (month, <span class="stringliteral">"11"</span>);
00654         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[3] == <span class="charliteral">'D'</span>)
00655                 sprintf (month, <span class="stringliteral">"12"</span>);
00656         <span class="keywordflow">else</span>
00657         {
00658                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Unknown month %s!\n"</span>, month);
00659                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00660         }
00661 
00662         strncpy (year, (in + 7), 4);
00663         year[4] = <span class="charliteral">'\0'</span>;
00664 
00665         sprintf (out, <span class="stringliteral">"%s%s%s"</span>, year, month, day);
00666 
00667 
00668         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00669 
00670 }
00671 
00672 
00673 <span class="comment">/************************************************************************</span>
00674 <span class="comment"> * AppendDateStr () - Append hours, minutes, and seconds to the </span>
00675 <span class="comment"> *   date, to create a string suitable for a call to epochsec17</span>
00676 <span class="comment"> ************************************************************************/</span>
<a name="l00677"></a><a class="code" href="parse__usnsn_8c.html#a8">00677</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a8">AppendDateStr</a> (<span class="keywordtype">char</span>     *orig, <span class="keywordtype">char</span> *append)
00678 {
00679 
00680         <span class="keywordtype">int</span>             i, j;
00681         <span class="keywordtype">char</span>    tmp[10];
00682 
00683         <span class="comment">/* strip off ':'s and append to the old date string */</span>
00684 
00685         <span class="keywordflow">if</span> ((orig == NULL) || (append == NULL))
00686         {
00687                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00688                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00689         }
00690 
00691         i = 0;
00692         j = 0;
00693 
00694         <span class="keywordflow">for</span> (i = 0; i &lt; 11; i++)
00695         {
00696                 <span class="keywordflow">if</span> (append[i] == <span class="charliteral">':'</span>)
00697                         ;
00698                 <span class="keywordflow">else</span>
00699                 {
00700                         tmp[j] = append[i];
00701                         j = j + 1;
00702                 }
00703         }
00704         tmp[j] = <span class="charliteral">'\0'</span>;
00705 
00706         strcat (orig, tmp);
00707 
00708         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00709                         
00710 
00711 }
00712 
00713 <span class="comment">/************************************************************************</span>
00714 <span class="comment"> * ParseEllipse () - fill the Ellipse structure from the NSN formatted</span>
00715 <span class="comment"> *   error elipse string</span>
00716 <span class="comment"> ************************************************************************/</span>
<a name="l00717"></a><a class="code" href="parse__usnsn_8c.html#a7">00717</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a7">ParseEllipse</a> (<span class="keywordtype">char</span> *str, <span class="keywordtype">double</span> depth_err, <a class="code" href="struct__ErrorElipse.html">Err_Elipse</a> *error)
00718 {
00719 
00720         <span class="keywordtype">int</span>             i, j, k, l, index;
00721         <span class="keywordtype">double</span>  err[9];
00722         <span class="keywordtype">char</span>    tmp[10];
00723 
00724         <span class="keywordflow">if</span> ((str == NULL) || (error == NULL))
00725         {
00726                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00727                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00728         }
00729 
00730         <span class="comment">/* Extract numbers */</span>
00731         i = 0;
00732         index = 0;
00733         <span class="comment">/* Loop over 3 sets of numbers */</span>
00734         <span class="keywordflow">for</span> (k = 0; k &lt; 3; k++)
00735         {
00736                 <span class="comment">/* Loop over 3 numbers in each set */</span>
00737                 <span class="keywordflow">for</span> (l = 0; l &lt; 3; l++)
00738                 {
00739                         j = 0;
00740                         <span class="keywordflow">while</span> ((i &lt; <a class="code" href="parse__usnsn_8h.html#a5">ELLIPSE_LENGTH</a>) &amp;&amp; (str[i] != <span class="charliteral">','</span>) &amp;&amp; (str[i] != <span class="charliteral">';'</span>))
00741                         {
00742                                 tmp[j] = str[i];
00743                                 j = j + 1;
00744                                 i = i + 1;
00745                         }
00746                         
00747                         <span class="comment">/* Got a number, convert it */</span>
00748                         tmp[j] = <span class="charliteral">'\0'</span>;
00749                         err[index] = atof (tmp);
00750                         index = index + 1;
00751                         i = i + 1;
00752                 }
00753         }
00754 
00755 
00756         <span class="comment">/* For some reason, the meaning of the ellipse changes</span>
00757 <span class="comment">         * if depth is fixed:</span>
00758 <span class="comment">         *</span>
00759 <span class="comment">         *   ind 0  =  Semi-major strike</span>
00760 <span class="comment">         *   ind 1  =  Semi-minor strike</span>
00761 <span class="comment">         *   ind 2  =  Intermediate strike</span>
00762 <span class="comment">         *</span>
00763 <span class="comment">         *   ind 3  =  Semi-major dip</span>
00764 <span class="comment">         *   ind 4  =  Semi-minor dip</span>
00765 <span class="comment">         *   ind 5  =  Intermediate dip</span>
00766 <span class="comment">         *</span>
00767 <span class="comment">         *   ind 6  =  Semi-major length</span>
00768 <span class="comment">         *   ind 7  =  Semi-minor length</span>
00769 <span class="comment">         *   ind 8  =  Intermediate length</span>
00770 <span class="comment">         *</span>
00771 <span class="comment">         *  For non-fixed depth, the Semi-minor and intermediate axes</span>
00772 <span class="comment">         *  are swapped.</span>
00773 <span class="comment">         *</span>
00774 <span class="comment">         */</span>
00775 
00776         <span class="keywordflow">if</span> (depth_err != 0.0)
00777         {
00778                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m0">maj_s</a> = err[0];
00779                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m1">maj_d</a> = err[3];
00780                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m2">maj_l</a> = err[6];
00781 
00782                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m6">int_s</a> = err[1];
00783                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m7">int_d</a> = err[4];
00784                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m8">int_l</a> = err[7];
00785 
00786                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m3">min_s</a> = err[2];
00787                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m4">min_d</a> = err[5];
00788                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m5">min_l</a> = err[8];
00789         }
00790         <span class="keywordflow">else</span>
00791         {
00792                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m0">maj_s</a> = err[0];
00793                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m1">maj_d</a> = err[3];
00794                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m2">maj_l</a> = err[6];
00795 
00796                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m3">min_s</a> = err[1];
00797                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m4">min_d</a> = err[4];
00798                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m5">min_l</a> = err[7];
00799 
00800                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m6">int_s</a> = err[2];
00801                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m7">int_d</a> = err[5];
00802                 error-&gt;<a class="code" href="struct__ErrorElipse.html#m8">int_l</a> = err[8];
00803         }
00804 
00805         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00806 
00807 }
00808 
00809 <span class="comment">/************************************************************************</span>
00810 <span class="comment"> * ParseMagnitude () - fill the Mag structure from the NSN formatted</span>
00811 <span class="comment"> *   magnitudes string</span>
00812 <span class="comment"> ************************************************************************/</span>
<a name="l00813"></a><a class="code" href="parse__usnsn_8c.html#a6">00813</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a6">ParseMagnitude</a> (<span class="keywordtype">char</span> *str, <a class="code" href="struct__OriginMag.html">OriginMag</a> *mag)
00814 {
00815 
00816         <span class="keywordtype">char</span>    tmp[10];
00817 
00818         <span class="keywordflow">if</span> ((str == NULL) || (mag == NULL))
00819         {
00820                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00821                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00822         }
00823 
00824 
00825         <span class="comment">/* HACK: we only know about duration and local mags */</span>
00826         
00827         <span class="comment">/* Mb */</span>
00828         mag[0].<a class="code" href="struct__OriginMag.html#m1">magLabel</a> = <span class="charliteral">'b'</span>;
00829         mag[0].<a class="code" href="struct__OriginMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
00830         strncpy (tmp, (str + MB_BASE), MAG_LEN);
00831         tmp[<a class="code" href="parse__usnsn_8h.html#a7">MAG_LEN</a>] = <span class="charliteral">'\0'</span>;
00832         mag[0].<a class="code" href="struct__OriginMag.html#m2">magAvg</a> = (double) atof (tmp);
00833 
00834         strncpy (tmp, (str + MB_DATUM), DATUM_LEN);
00835         tmp[<a class="code" href="parse__usnsn_8h.html#a8">DATUM_LEN</a>] = <span class="charliteral">'\0'</span>;
00836         mag[0].<a class="code" href="struct__OriginMag.html#m3">numStas</a> = (int) atoi (tmp);
00837 
00838 
00839         <span class="comment">/* ML */</span>
00840         mag[1].<a class="code" href="struct__OriginMag.html#m1">magLabel</a> = <span class="charliteral">'L'</span>;
00841         mag[1].<a class="code" href="struct__OriginMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
00842         strncpy (tmp, (str + ML_BASE), MAG_LEN);
00843         tmp[<a class="code" href="parse__usnsn_8h.html#a7">MAG_LEN</a>] = <span class="charliteral">'\0'</span>;
00844         mag[1].<a class="code" href="struct__OriginMag.html#m2">magAvg</a> = (double) atof (tmp);
00845 
00846         strncpy (tmp, (str + ML_DATUM), DATUM_LEN);
00847         tmp[<a class="code" href="parse__usnsn_8h.html#a8">DATUM_LEN</a>] = <span class="charliteral">'\0'</span>;
00848         mag[1].<a class="code" href="struct__OriginMag.html#m3">numStas</a> = (int) atoi (tmp);
00849 
00850 
00851         <span class="comment">/* Mblg */</span>
00852         mag[2].<a class="code" href="struct__OriginMag.html#m1">magLabel</a> = <span class="charliteral">'g'</span>;
00853         mag[2].<a class="code" href="struct__OriginMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
00854         strncpy (tmp, (str + MBLG_BASE), MAG_LEN);
00855         tmp[<a class="code" href="parse__usnsn_8h.html#a7">MAG_LEN</a>] = <span class="charliteral">'\0'</span>;
00856         mag[2].<a class="code" href="struct__OriginMag.html#m2">magAvg</a> = (double) atof (tmp);
00857 
00858         strncpy (tmp, (str + MBLG_DATUM), DATUM_LEN);
00859         tmp[<a class="code" href="parse__usnsn_8h.html#a8">DATUM_LEN</a>] = <span class="charliteral">'\0'</span>;
00860         mag[2].<a class="code" href="struct__OriginMag.html#m3">numStas</a> = (int) atoi (tmp);
00861 
00862 
00863         <span class="comment">/* Md */</span>
00864         mag[3].<a class="code" href="struct__OriginMag.html#m1">magLabel</a> = <span class="charliteral">'d'</span>;
00865         mag[3].<a class="code" href="struct__OriginMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a34">MAGTYPE_DURATION</a>;
00866         strncpy (tmp, (str + MD_BASE), MAG_LEN);
00867         tmp[<a class="code" href="parse__usnsn_8h.html#a7">MAG_LEN</a>] = <span class="charliteral">'\0'</span>;
00868         mag[3].<a class="code" href="struct__OriginMag.html#m2">magAvg</a> = (double) atof (tmp);
00869 
00870         strncpy (tmp, (str + MD_DATUM), DATUM_LEN);
00871         tmp[<a class="code" href="parse__usnsn_8h.html#a8">DATUM_LEN</a>] = <span class="charliteral">'\0'</span>;
00872         mag[3].<a class="code" href="struct__OriginMag.html#m3">numStas</a> = (int) atoi (tmp);
00873 
00874 
00875         <span class="comment">/* MS */</span>
00876         mag[4].<a class="code" href="struct__OriginMag.html#m1">magLabel</a> = <span class="charliteral">'S'</span>;
00877         mag[4].<a class="code" href="struct__OriginMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
00878         strncpy (tmp, (str + MS_BASE), MAG_LEN);
00879         tmp[<a class="code" href="parse__usnsn_8h.html#a7">MAG_LEN</a>] = <span class="charliteral">'\0'</span>;
00880         mag[4].<a class="code" href="struct__OriginMag.html#m2">magAvg</a> = (double) atof (tmp);
00881 
00882         strncpy (tmp, (str + MS_DATUM), DATUM_LEN);
00883         tmp[<a class="code" href="parse__usnsn_8h.html#a8">DATUM_LEN</a>] = <span class="charliteral">'\0'</span>;
00884         mag[4].<a class="code" href="struct__OriginMag.html#m3">numStas</a> = (int) atoi (tmp);
00885 
00886         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00887 }
00888 
00889 <span class="comment">/************************************************************************</span>
00890 <span class="comment"> * ParsePhase () - fill the Phase structure from the NSN formatted</span>
00891 <span class="comment"> *   phase string</span>
00892 <span class="comment"> ************************************************************************/</span>
<a name="l00893"></a><a class="code" href="parse__usnsn_8c.html#a5">00893</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a5">ParsePhase</a> (<span class="keywordtype">char</span> *str, <a class="code" href="struct__PhaseStruct.html">Phase</a> *phase, <span class="keywordtype">char</span> *EventDate, 
00894                                                                         <span class="keywordtype">int</span> *num_phases, <span class="keywordtype">double</span> *Dmin)
00895 {
00896         <span class="keywordtype">char</span>    tmp[256];
00897         <span class="keywordtype">char</span>    datestr[256];
00898         <span class="keywordtype">int</span>             i, j;
00899 
00900         <span class="keywordflow">if</span> ((str == NULL) || (phase == NULL))
00901         {
00902                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in\n"</span>);
00903                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00904         }
00905 
00906 
00907         <span class="comment">/* ingore phases that don't start with the station name */</span>
00908         <span class="keywordflow">if</span> (str[1] == <span class="charliteral">' '</span>)
00909         {
00910                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00911         }
00912 
00913 
00914         strncpy (phase-&gt;<a class="code" href="struct__PhaseStruct.html#m0">sta</a>, (str + STA_BASE), STA_LEN);
00915         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m0">sta</a>[<a class="code" href="parse__usnsn_8h.html#a20">STA_LEN</a>] = <span class="charliteral">'\0'</span>;
00916 
00917         strncpy (tmp, (str + PHA_BASE), PHA_LEN);
00918         tmp[<a class="code" href="parse__usnsn_8h.html#a22">PHA_LEN</a>] = <span class="charliteral">'\0'</span>;
00919 
00920         j = 0;
00921         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m3">onset</a> = <span class="charliteral">' '</span>;
00922         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m4">motion</a> = <span class="charliteral">' '</span>;
00923         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="parse__usnsn_8h.html#a22">PHA_LEN</a>; i++)
00924         {
00925                 <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'?'</span>)
00926                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m2">automatic</a> = 1;
00927                 <span class="comment">/* onset codes */</span>
00928                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'i'</span>)
00929                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m3">onset</a> = <span class="charliteral">'i'</span>;
00930                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'e'</span>)
00931                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m3">onset</a> = <span class="charliteral">'e'</span>;
00932                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'q'</span>)
00933                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m3">onset</a> = <span class="charliteral">'q'</span>;
00934 
00935                 <span class="comment">/* first motion codes */</span>
00936                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'c'</span>)
00937                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m4">motion</a> = <span class="charliteral">'c'</span>;
00938                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'d'</span>)
00939                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m4">motion</a> = <span class="charliteral">'d'</span>;
00940                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'u'</span>)
00941                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m4">motion</a> = <span class="charliteral">'u'</span>;
00942                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">'r'</span>)
00943                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m4">motion</a> = <span class="charliteral">'r'</span>;
00944                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">' '</span>)
00945                         ;
00946 
00947                 <span class="comment">/* part of the phase code */</span>
00948                 <span class="keywordflow">else</span>
00949                 {
00950                         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m1">phase</a>[j] = tmp[i];
00951                         j = j + 1;
00952                 }
00953         }
00954 
00955         <span class="keywordflow">if</span> (j &gt;= <a class="code" href="parse__usnsn_8h.html#a22">PHA_LEN</a>)
00956         {
00957                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"MAX Phase length (%d) exceeded!\n"</span>, PHA_LEN);
00958                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00959         }
00960         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m1">phase</a>[j] = <span class="charliteral">'\0'</span>;
00961 
00962         strncpy (tmp, (str + OT_BASE), OT_LEN);
00963         tmp[<a class="code" href="parse__usnsn_8h.html#a24">OT_LEN</a>] = <span class="charliteral">'\0'</span>;
00964 
00965         strcpy (datestr, EventDate);
00966         <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a8">AppendDateStr</a> (datestr, tmp) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00967         {
00968                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to AppendDateStr failed.\n"</span>);
00969                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00970         }
00971         <a class="code" href="chron3_8c.html#a11">epochsec17</a> (&amp;phase-&gt;<a class="code" href="struct__PhaseStruct.html#m5">ot</a>, datestr);
00972 
00973 
00974         strncpy (tmp, (str + RES_BASE), RES_LEN);
00975         tmp[<a class="code" href="parse__usnsn_8h.html#a26">RES_LEN</a>] = <span class="charliteral">'\0'</span>;
00976         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m6">res</a> = (double) atof (tmp);
00977 
00978         <span class="keywordflow">if</span> (str[<a class="code" href="parse__usnsn_8h.html#a27">RES_USED</a>] == <span class="charliteral">'X'</span>)
00979                 phase-&gt;<a class="code" href="struct__PhaseStruct.html#m7">res_used</a> = 1;
00980         <span class="keywordflow">else</span>
00981                 phase-&gt;<a class="code" href="struct__PhaseStruct.html#m7">res_used</a> = 0;
00982 
00983         strncpy (tmp, (str + DIST_BASE), DIST_LEN);
00984         tmp[<a class="code" href="parse__usnsn_8h.html#a29">DIST_LEN</a>] = <span class="charliteral">'\0'</span>;
00985         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m8">dist</a> = (double) atof (tmp);
00986 
00987         <span class="comment">/* convert from degrees to km */</span>
00988         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m8">dist</a> = (phase-&gt;<a class="code" href="struct__PhaseStruct.html#m8">dist</a> * <a class="code" href="parse__usnsn_8h.html#a6">EARTH_CIRCUM</a>)/360.0;
00989 
00990         <span class="keywordflow">if</span> (phase-&gt;<a class="code" href="struct__PhaseStruct.html#m8">dist</a> &lt;= *Dmin)
00991         {
00992                 *Dmin = phase-&gt;<a class="code" href="struct__PhaseStruct.html#m8">dist</a>;
00993         }
00994 
00995         strncpy (tmp, (str + AZM_BASE), AZM_LEN);
00996         tmp[<a class="code" href="parse__usnsn_8h.html#a31">AZM_LEN</a>] = <span class="charliteral">'\0'</span>;
00997         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m9">azm</a> = (int) atoi (tmp);
00998 
00999 
01000         <span class="comment">/* magnitudes */</span>
01001         phase-&gt;<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a> = 0;
01002         <span class="keywordflow">if</span> (str[<a class="code" href="parse__usnsn_8h.html#a32">MAG1_BASE</a>] != <span class="charliteral">' '</span>)
01003         {
01004                 <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a4">ParsePhaseMagnitude</a> ((str+MAG1_BASE), &amp;phase-&gt;<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[0]) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
01005                 {
01006                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to ParsePhaseMagnitude failed\n"</span>);
01007                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01008                 }
01009                 phase-&gt;<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a> = phase-&gt;<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a> + 1;
01010 
01011         }
01012         <span class="keywordflow">if</span> (str[<a class="code" href="parse__usnsn_8h.html#a35">MAG2_BASE</a>] != <span class="charliteral">' '</span>)
01013         {
01014 
01015                 <span class="keywordflow">if</span> (<a class="code" href="parse__usnsn_8c.html#a4">ParsePhaseMagnitude</a> ((str+MAG2_BASE), &amp;phase-&gt;<a class="code" href="struct__PhaseStruct.html#m11">mag</a>[1]) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
01016                 {
01017                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to ParsePhaseMagnitude failed\n"</span>);
01018                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01019                 }
01020                 phase-&gt;<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a> = phase-&gt;<a class="code" href="struct__PhaseStruct.html#m10">num_mags</a> + 1;
01021         }
01022 
01023         *num_phases = *num_phases + 1;
01024         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
01025 }
01026 
01027 <span class="comment">/************************************************************************</span>
01028 <span class="comment"> * ParsePhaseMagnitude () - fill the PhaseMag structure from the NSN </span>
01029 <span class="comment"> *   formatted phase string</span>
01030 <span class="comment"> ************************************************************************/</span>
<a name="l01031"></a><a class="code" href="parse__usnsn_8c.html#a4">01031</a> <span class="keyword">static</span>  <span class="keywordtype">int</span>             <a class="code" href="parse__usnsn_8c.html#a4">ParsePhaseMagnitude</a> (<span class="keywordtype">char</span> *str, <a class="code" href="struct__PhaseMag.html">PhaseMag</a> *mag)
01032 {
01033         <span class="keywordtype">char</span>    *ptr;
01034         <span class="keywordtype">char</span>    tmp[5];
01035         <span class="keywordtype">int</span>             expn, mult;
01036 
01037         <span class="keywordflow">if</span> ((str == NULL) || (mag == NULL))
01038         {
01039                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in\n"</span>);
01040                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01041         }
01042 
01043 
01044         <span class="comment">/* Hack: we only know duration and local mags */</span>
01045         mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> = str[0];
01046         <span class="keywordflow">if</span> (mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> == <span class="charliteral">'b'</span>)
01047                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
01048         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> == <span class="charliteral">'L'</span>)
01049                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
01050         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> == <span class="charliteral">'g'</span>) <span class="comment">/* HACK -- we don't have Mblg type yet */</span>
01051                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
01052         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> == <span class="charliteral">'d'</span>)
01053                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a34">MAGTYPE_DURATION</a>;
01054         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a> == <span class="charliteral">'S'</span>)
01055                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m0">MagType</a> = <a class="code" href="earthworm__defs_8h.html#a35">MAGTYPE_LOCAL_ZERO2PEAK</a>;
01056         <span class="keywordflow">else</span>
01057         {
01058                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid magnitude type: %c\n"</span>, mag-&gt;<a class="code" href="struct__PhaseMag.html#m1">magLabel</a>);
01059                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01060         }
01061 
01062         ptr = str + 2;
01063         strncpy (tmp, ptr, 3);
01064         tmp[3] = <span class="charliteral">'\0'</span>;
01065         mag-&gt;<a class="code" href="struct__PhaseMag.html#m2">value</a> = (double) atof (tmp);
01066 
01067         ptr = ptr + 3;
01068         <span class="keywordflow">if</span> (ptr[0] == <span class="charliteral">'+'</span>)
01069                 mult = 1;
01070         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptr[0] == <span class="charliteral">'-'</span>)
01071                 mult = -1;
01072 
01073         ptr = ptr + 1;
01074         strncpy (tmp, ptr, 1);
01075         tmp[1] = <span class="charliteral">'\0'</span>;
01076         expn = mult * ((int) atoi (tmp));
01077         mag-&gt;<a class="code" href="struct__PhaseMag.html#m2">value</a> = (double) (mag-&gt;<a class="code" href="struct__PhaseMag.html#m2">value</a> * pow (10.0, (<span class="keywordtype">double</span>) expn));
01078 
01079         ptr = ptr + 1;
01080         strncpy (tmp, ptr, 4);
01081         tmp[4] = <span class="charliteral">'\0'</span>;
01082         mag-&gt;<a class="code" href="struct__PhaseMag.html#m3">period</a> = (double) atof (tmp);
01083 
01084         ptr = ptr + 5;
01085         strncpy (tmp, ptr, 3);
01086         tmp[3] = <span class="charliteral">'\0'</span>;
01087         mag-&gt;<a class="code" href="struct__PhaseMag.html#m4">mag</a> = (double) atof (tmp);
01088 
01089         ptr = ptr + 3;
01090 
01091         <span class="keywordflow">if</span> (ptr[0] != <span class="charliteral">'X'</span>)
01092                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m5">used</a> = 1;
01093         <span class="keywordflow">else</span>
01094                 mag-&gt;<a class="code" href="struct__PhaseMag.html#m5">used</a> = 0;
01095 
01096 
01097         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
01098 
01099 }
01100 
01101 
01102 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:07 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
