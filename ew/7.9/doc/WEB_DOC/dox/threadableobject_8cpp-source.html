<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>threadableobject.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>threadableobject.cpp</h1><a href="threadableobject_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/********************************************</span>
00002 <span class="comment">*              worm_threads.c               *</span>
00003 <span class="comment">*            Windows NT version             *</span>
00004 <span class="comment">*                                           *</span>
00005 <span class="comment">* This file contains functions StartThread, *</span>
00006 <span class="comment">* WaitThread, and KillThread                *</span>
00007 <span class="comment">*********************************************/</span>
00008 <span class="comment">//---------------------------------------------------------------------------</span>
00009 <span class="preprocessor">#include "<a class="code" href="threadableobject_8h.html">threadableobject.h</a>"</span>
00010 
00011 <span class="comment">//---------------------------------------------------------------------------</span>
00012 <span class="preprocessor">#ifdef _SOLARIS</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span>
00014 <span class="preprocessor">#endif</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#pragma package(smart_init)</span>
00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="classThreadableObject.html#q1">00018</a> <a class="code" href="classTMutex.html">TMutex</a> * <a class="code" href="classThreadableObject.html#q1">ThreadableObject::ThatMutex</a> = NULL;
<a name="l00019"></a><a class="code" href="classThreadableObject.html#q0">00019</a> <a class="code" href="classThreadableObject.html">ThreadableObject</a> * <a class="code" href="classThreadableObject.html#q0">ThreadableObject::That</a> = NULL;
00020 
00021 <span class="comment">//---------------------------------------------------------------------------</span>
00022 <span class="preprocessor">#ifdef _SOLARIS</span>
00023 <span class="preprocessor"></span><span class="comment">/*</span>
00024 <span class="comment">** SignalHandler() -- Solaris-specific signal handler</span>
00025 <span class="comment">**</span>
00026 <span class="comment">**  Added for use with the KillThread function so that</span>
00027 <span class="comment">**  killed threads will exit gracefully</span>
00028 <span class="comment">*/</span>
00029 <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadableSigHandler( <span class="keywordtype">int</span> p_sig )
00030 {
00031    <span class="keywordtype">void</span> * status;
00032 
00033    <span class="keywordflow">switch</span> (p_sig)
00034    {
00035       <span class="keywordflow">case</span> SIGUSR1:
00036            <span class="comment">// DEBUG</span>
00037            <span class="comment">// printf( "thread %d caught SIGUSR1; calling thr_exit()\n"</span>
00038            <span class="comment">//       , (int)thr_self()</span>
00039            <span class="comment">//       );</span>
00040            thr_exit( status );
00041    }
00042 }
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 <span class="comment">//---------------------------------------------------------------------------</span>
00046 <span class="comment">// StartThreadableObject() -- this is a helper function, used only in this file,</span>
00047 <span class="comment">//                            that has the signature type required by the</span>
00048 <span class="comment">//                            _beginthread() function.</span>
00049 <span class="comment">//</span>
00050 <span class="comment">//                            It is important that sufficient time between</span>
00051 <span class="comment">//                            calls to this function be allowed to prevent</span>
00052 <span class="comment">//                            conflicts with the class-scope variable</span>
00053 <span class="comment">//                            'That' (accessed with ::GetThat).</span>
00054 <span class="comment">//                            Generally, sleeping 1/4 - 1/2 second after</span>
00055 <span class="comment">//                            calls to StartThread()</span>
00056 <span class="comment">//                            or StartThreadWithArg() will suffice.</span>
00057 <span class="comment">//</span>
<a name="l00058"></a><a class="code" href="threadableobject_8cpp.html#a0">00058</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="threadableobject_8cpp.html#a0">StartObjectThread</a>( <span class="keywordtype">void</span> * p_argument )
00059 {
00060    <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#d0">ThreadableObject::GetThat</a>() != NULL )
00061    {
00062       <a class="code" href="classThreadableObject.html#d0">ThreadableObject::GetThat</a>()-&gt;<a class="code" href="classThreadableObject.html#a1">StartThreadFunc</a>(p_argument);
00063    }
00064 }
00065 
00066 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00067"></a><a class="code" href="classThreadableObject.html#b0">00067</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classThreadableObject.html#b0">ThreadableObject::StartThreadWithArg</a>( TO_STACK_SIZE   p_stack_size
00068                                                      , TO_THREAD_ID  * thread_id
00069                                                      , <span class="keywordtype">void</span> *          p_parameters
00070 #ifdef _SOLARIS
00071                                                      , <span class="keywordtype">bool</span>            p_isdaemon = <span class="keyword">false</span>
00072 #endif
00073                                                      )
00074 {
00075 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00076 <span class="preprocessor"></span>   <span class="keywordtype">long</span> tid = -1;
00077 
00078    <span class="comment">// Use mutex to keep global "That" from being clobbered.</span>
00079    <a class="code" href="classThreadableObject.html#q1">ThatMutex</a>-&gt;<a class="code" href="classTMutex.html#a2">RequestLock</a>();
00080    <a class="code" href="classThreadableObject.html#q0">That</a> = <span class="keyword">this</span>;
00081    tid = _beginthread( StartObjectThread, p_stack_size, p_parameters );
00082    <a class="code" href="classThreadableObject.html#q1">ThatMutex</a>-&gt;<a class="code" href="classTMutex.html#a3">ReleaseLock</a>();
00083 
00084    <span class="keywordflow">if</span> ( tid == -1 )
00085    {
00086       <span class="comment">// Couldn't create thread</span>
00087       <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00088    }
00089 
00090 <span class="preprocessor">#elif defined(_SOLARIS)</span>
00091 <span class="preprocessor"></span>
00092    <span class="keywordtype">int</span> rc;              <span class="comment">// Function return code</span>
00093    TO_THREAD_ID tid;     <span class="comment">// working thread id</span>
00094 
00095    <span class="comment">// Set up a signal-handling function to be inherited by threads</span>
00096    <span class="comment">// used by the KillThread() method</span>
00097    sigset( SIGUSR1, &amp;ThreadableSigHandler );
00098 
00099    <span class="comment">// Start the thread</span>
00100    <span class="comment">//</span>
00101    <span class="comment">// Note: THR_DETACHED is required for thr_exit to work. That is,</span>
00102    <span class="comment">//   a detached thread can truly kill itself without lingering in</span>
00103    <span class="comment">//   some afterlife, waiting for some other thread to pick up it's exit</span>
00104    <span class="comment">//   status before it can truly cease to be...</span>
00105    <span class="comment">//</span>
00106    <span class="comment">// Use mutex to keep global "That" from being clobbered.</span>
00107    <a class="code" href="classThreadableObject.html#q1">ThatMutex</a>-&gt;<a class="code" href="classTMutex.html#a2">RequestLock</a>();
00108    <a class="code" href="classThreadableObject.html#q0">That</a> = <span class="keyword">this</span>;
00109    rc = thr_create( (<span class="keywordtype">void</span> *)0
00110                   , p_stack_size
00111                   , StartObjectThread
00112                   , p_parameters
00113                   , THR_DETACHED|THR_NEW_LWP|(p_isdaemon ? THR_DAEMON : 0)
00114                   , &amp;tid
00115                   );
00116    <a class="code" href="classThreadableObject.html#q1">ThatMutex</a>-&gt;<a class="code" href="classTMutex.html#a3">ReleaseLock</a>();
00117 
00118    <span class="keywordflow">if</span> ( rc != 0 )
00119    {
00120       <span class="comment">// Couldn't create thread</span>
00121       <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00122    }
00123 <span class="preprocessor">#endif</span>
00124 <span class="preprocessor"></span>
00125    *thread_id = (TO_THREAD_ID)tid;     <span class="comment">/* Return the thread id */</span>
00126 
00127    <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00128 }
00129 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00130"></a><a class="code" href="classThreadableObject.html#e0">00130</a> <span class="keywordtype">void</span> <a class="code" href="classThreadableObject.html#e0">ThreadableObject::KillSelfThread</a>( <span class="keywordtype">void</span> )
00131 {
00132 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00133 <span class="preprocessor"></span>    _endthread();
00134 <span class="preprocessor">#elif defined(_SOLARIS)</span>
00135 <span class="preprocessor"></span>   thr_exit( (<span class="keywordtype">void</span> *)NULL );
00136 <span class="preprocessor">#endif</span>
00137 <span class="preprocessor"></span>}
00138 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00139"></a><a class="code" href="classThreadableObject.html#e1">00139</a> <span class="keywordtype">int</span> <a class="code" href="classThreadableObject.html#e1">ThreadableObject::WaitForThread</a>( TO_THREAD_ID * thread_id )
00140 {
00141 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00142 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( WaitForSingleObject((HANDLE)(*thread_id), INFINITE ) == WAIT_FAILED )
00143    {
00144       <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00145    }
00146 <span class="preprocessor">#elif defined(_SOLARIS)</span>
00147 <span class="preprocessor"></span>   <span class="comment">// this is unimplemented within Solaris</span>
00148 <span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>   <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00150 }
00151 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00152"></a><a class="code" href="classThreadableObject.html#e2">00152</a> <span class="keywordtype">int</span> <a class="code" href="classThreadableObject.html#e2">ThreadableObject::KillThread</a>( TO_THREAD_ID tid )
00153 {
00154 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00155 <span class="preprocessor"></span>    <span class="keyword">const</span> DWORD exit_code = 0;
00156 
00157     <span class="keywordflow">if</span> ( TerminateThread( (HANDLE)tid, exit_code ) == 0 )
00158     {
00159        <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00160     }
00161     <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00162 <span class="preprocessor">#elif defined(_SOLARIS)</span>
00163 <span class="preprocessor"></span>   <span class="keywordflow">return</span>( thr_kill( (thread_t) tid, SIGUSR1 ) );
00164 <span class="preprocessor">#endif</span>
00165 <span class="preprocessor"></span>}
00166 <span class="comment">//---------------------------------------------------------------------------</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:11 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
