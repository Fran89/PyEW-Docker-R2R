<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>modulebase.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>modulebase.h</h1><a href="modulebase_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">**  ModuleBase -- A base class for modules.  Includes facilities for</span>
00003 <span class="comment">**                spawning worker threads, sending heartbeat and error</span>
00004 <span class="comment">**                messages to a shared memory ring and checking the</span>
00005 <span class="comment">**                same ring for the shutdown flag.</span>
00006 <span class="comment">**</span>
00007 <span class="comment">**</span>
00008 <span class="comment">**  Configuration file:</span>
00009 <span class="comment">**  ------------------</span>
00010 <span class="comment">**</span>
00011 <span class="comment"></span>
00012 <span class="comment"># CmdRingName -- name of ring to check for flags and to send TYPE_HEARTBEAT</span>
00013 <span class="comment">#                and TYPE_ERROR messages to.  REQUIRED</span>
00014 <span class="comment">#</span>
00015 <span class="comment">#</span>
00016 <span class="comment">CmdRingName  WAVE_RING</span>
00017 <span class="comment"></span>
00018 <span class="comment"># LoopSleepMS -- Milliseconds to sleep between main loop executions.</span>
00019 <span class="comment">#                Default is 1000.  OPTIONAL</span>
00020 <span class="comment">#</span>
00021 <span class="comment"># LoopSleepMS 500</span>
00022 <span class="comment"></span>
00023 <span class="comment">**</span>
00024 <span class="comment">*/</span>
00025 <span class="comment">//---------------------------------------------------------------------------</span>
00026 <span class="preprocessor">#ifndef modulebaseH</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define modulebaseH</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="configurable_8h.html">configurable.h</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="threadableobject_8h.html">threadableobject.h</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;string.h&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="worm__types_8h.html">worm_types.h</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="worm__statuscode_8h.html">worm_statuscode.h</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="globalutils_8h.html">globalutils.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;ringwriter.h&gt;</span>
00036 <span class="preprocessor">#include &lt;msgheartbeat.h&gt;</span>
00037 <span class="preprocessor">#include &lt;msgerror.h&gt;</span>
00038 
00039 <span class="preprocessor">#include &lt;time.h&gt;</span>
00040 
00041 <span class="comment">// Default milliseconds to sleep between main loop executions</span>
<a name="l00042"></a><a class="code" href="modulebase_8h.html#a0">00042</a> <span class="preprocessor">#define DEF_LOOP_SLEEP_MS  1000</span>
00043 <span class="preprocessor"></span>
00044 
00045 
00046 <span class="comment">/* Some stuff to standardize the tracking of the worker thread status</span>
00047 <span class="comment">** (an expanded version, WORM_SERVICE_THREAD_INFO, is defined in</span>
00048 <span class="comment">**  serverbase.h, for service threads)</span>
00049 <span class="comment">*/</span>
00050 
<a name="l00051"></a><a class="code" href="modulebase_8h.html#a7">00051</a> <span class="keyword">enum</span> <a class="code" href="modulebase_8h.html#a7">WORKER_THREAD_STATUS</a>
00052 {
00053     <a class="code" href="modulebase_8h.html#a7a2">THREAD_STATUS_STARTING</a>  <span class="comment">// set by starting thread</span>
00054   , <a class="code" href="modulebase_8h.html#a7a3">THREAD_STATUS_INIT</a>      <span class="comment">// set by worker for any initialization</span>
00055   , <a class="code" href="modulebase_8h.html#a7a4">THREAD_STATUS_GOOD</a>      <span class="comment">// set by worker</span>
00056   , <a class="code" href="modulebase_8h.html#a7a5">THREAD_STATUS_QUIT</a>      <span class="comment">// set by worker</span>
00057   , <a class="code" href="modulebase_8h.html#a7a6">THREAD_STATUS_ERROR</a>     <span class="comment">// set by worker</span>
00058 };
00059 
00060 <span class="comment">// Structure for used by derivative classes to track their</span>
00061 <span class="comment">// worker threads</span>
<a name="l00062"></a><a class="code" href="structWORKER__THREAD__INFO.html">00062</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structWORKER__THREAD__INFO.html">WORKER_THREAD_INFO</a>
00063 {
<a name="l00064"></a><a class="code" href="structWORKER__THREAD__INFO.html#m0">00064</a>    TO_THREAD_ID          <a class="code" href="structWORKER__THREAD__INFO.html#m0">thread_id</a>;
<a name="l00065"></a><a class="code" href="structWORKER__THREAD__INFO.html#m1">00065</a>    time_t                <a class="code" href="structWORKER__THREAD__INFO.html#m1">lastpulse</a>; <span class="comment">// from time(NULL)</span>
<a name="l00066"></a><a class="code" href="structWORKER__THREAD__INFO.html#m2">00066</a>    <a class="code" href="modulebase_8h.html#a7">WORKER_THREAD_STATUS</a>  <a class="code" href="structWORKER__THREAD__INFO.html#m2">status</a>;
00067 } <a class="code" href="structWORKER__THREAD__INFO.html">WORKER_THREAD_INFO_STRUCT</a>;
00068 
00069 
00070 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00071"></a><a class="code" href="classTModuleBase.html">00071</a> <span class="keyword">class </span><a class="code" href="classTModuleBase.html">TModuleBase</a> : <span class="keyword">public</span> <a class="code" href="classTConfigurable.html">TConfigurable</a>
00072                   , <span class="keyword">public</span> <a class="code" href="classThreadableObject.html">ThreadableObject</a>
00073 {
00074 <span class="keyword">protected</span>:
00075 
00076 
00077    <span class="comment">// ----------------------------------------------------------------------</span>
00078    <span class="comment">//                        FOR  TConfigurable</span>
00079 
00080    <span class="comment">/*</span>
00081 <span class="comment">   **  HandleConfigLine()</span>
00082 <span class="comment">   **</span>
00083 <span class="comment">   **  PARMS:</span>
00084 <span class="comment">   **          p_parser -- the parser being used, command string already</span>
00085 <span class="comment">   **                      in the current token for comparison with Its()</span>
00086 <span class="comment">   **</span>
00087 <span class="comment">   ** RETURN:</span>
00088 <span class="comment">   **          HANDLE_INVALID --  line invalid</span>
00089 <span class="comment">   **          HANDLE_UNUSED  --  line not used</span>
00090 <span class="comment">   **          HANDLE_USED    --  line used okay</span>
00091 <span class="comment">   **</span>
00092 <span class="comment">   **  Override for child classes to handle command lines</span>
00093 <span class="comment">   **</span>
00094 <span class="comment">   ** In ModuleBase class, used as a convenient way to access the TGlobalUtils</span>
00095 <span class="comment">   ** for module initialization.  This means that derivative classes do not</span>
00096 <span class="comment">   ** have to deal with TGlobalUtils until needing to use it for lookups and such.</span>
00097 <span class="comment">   **</span>
00098 <span class="comment">   ** !!! NOTE: Ensure that derivative classes ALWAYS contain a call to their</span>
00099 <span class="comment">   **  &lt;super_class&gt;::HandleConfigLine() in their own HandleConfigLine() method...</span>
00100 <span class="comment">   ** this ensures that all classes in the heirarchy get their shot at the</span>
00101 <span class="comment">   ** configuration line.</span>
00102 <span class="comment">   **</span>
00103 <span class="comment">   */</span>
00104    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classTModuleBase.html#b0">HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser );
00105 
00106    <span class="comment">/* CheckConfig() -- allows derivative classes to report the status of their</span>
00107 <span class="comment">   **                  the lookup values.</span>
00108 <span class="comment">   **</span>
00109 <span class="comment">   ** From within any deriving class, or further derivation, ALWAYS contain a call to</span>
00110 <span class="comment">   ** &lt;super_class&gt;::CheckConfig() in their own CheckConfig() method...</span>
00111 <span class="comment">   ** this ensures that all classes in the heirarchy get their chance to report status.</span>
00112 <span class="comment">   **</span>
00113 <span class="comment">   ** All implementations should set ConfigStatus value to WORM_STAT_BADSTATE if there</span>
00114 <span class="comment">   ** is a configuration problem, otherwise leave it alone.</span>
00115 <span class="comment">   */</span>
00116    <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b1">CheckConfig</a>();
00117 
00118 
00119    <span class="comment">// ----------------------------------------------------------------------</span>
00120    <span class="comment">//                         FOR TModuleBase</span>
00121 
00122    <span class="comment">/* Running -- Variable that all worker threads should check</span>
00123 <span class="comment">   **            in their execution loops to discover if they should</span>
00124 <span class="comment">   **            continue running or not.</span>
00125 <span class="comment">   **            Most commonly, the main thread will set this to false</span>
00126 <span class="comment">   **            if the shutdown flag is found in the command ring.</span>
00127 <span class="comment">   **            In theory, worker threads might set this to initiate</span>
00128 <span class="comment">   **            a shutdown upon error.</span>
00129 <span class="comment">   */</span>
<a name="l00130"></a><a class="code" href="classTModuleBase.html#n0">00130</a>    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> <a class="code" href="classTModuleBase.html#n0">Running</a>;
00131 
<a name="l00132"></a><a class="code" href="classTModuleBase.html#n1">00132</a>    <a class="code" href="worm__defs_8h.html#a14">WORM_LOGGING_LEVEL</a> <a class="code" href="classTModuleBase.html#n1">LoggingLevel</a>;
00133 
<a name="l00134"></a><a class="code" href="classTModuleBase.html#n2">00134</a>    <a class="code" href="classTGlobalUtils.html">TGlobalUtils</a> * <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a>;
00135 
00136    <a class="code" href="worm__types_8h.html#a27">WORM_MSGTYPE_ID</a> <a class="code" href="classTModuleBase.html#n3">TYPE_ERROR</a>
<a name="l00137"></a><a class="code" href="classTModuleBase.html#n4">00137</a>                  , <a class="code" href="classTModuleBase.html#n4">TYPE_HEARTBEAT</a>
00138                  ;
00139 
<a name="l00140"></a><a class="code" href="classTModuleBase.html#n5">00140</a>    <a class="code" href="worm__types_8h.html#a20">GEN_FILENAME</a> <a class="code" href="classTModuleBase.html#n5">ConfigFileName</a>;
00141 
00142    <span class="comment">// milliseconds to sleep between main loop executions (default: DEF_LOOP_SLEEP_MS, above)</span>
<a name="l00143"></a><a class="code" href="classTModuleBase.html#n6">00143</a>    <span class="keywordtype">int</span> <a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a>;
00144 
00145 
00146    <span class="comment">// Ring to check for shutdown flags, to post heartbeats, etc.</span>
<a name="l00147"></a><a class="code" href="classTModuleBase.html#n7">00147</a>    <a class="code" href="worm__types_8h.html#a30">WORM_RING_ID</a>   <a class="code" href="classTModuleBase.html#n7">CommandRingKey</a>;   <span class="comment">// key to transport ring</span>
<a name="l00148"></a><a class="code" href="classTModuleBase.html#n8">00148</a>    TRingWriter  * <a class="code" href="classTModuleBase.html#n8">CommandRing</a>;
00149 
00150    <span class="comment">/* SendStatus -- Standard method used to send TYPE_HEARTBEAT and</span>
00151 <span class="comment">   **               TYPE_ERROR messages to CommandRing (the ring).</span>
00152 <span class="comment">   **</span>
00153 <span class="comment">   ** PARAMETERS:</span>
00154 <span class="comment">   **      p_type = must be TYPE_HEARTBEAT or TYPE_ERROR</span>
00155 <span class="comment">   **      p_ierr = numberic error code (used only with TYPE_ERROR)</span>
00156 <span class="comment">   **      p_text = message text (used only with TYPE_ERROR)</span>
00157 <span class="comment">   **</span>
00158 <span class="comment">   ** Note: The default values make it possible to send a heartbeat with</span>
00159 <span class="comment">   **       only:  SendStatus(TYPE_HEARTBEAT)</span>
00160 <span class="comment">   */</span>
00161    <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b2">SendStatus</a>( WORM_MSGTYPE_ID   p_type
00162                   , <span class="keywordtype">short</span>             p_ierr = 0
00163                   , <span class="keyword">const</span> <span class="keywordtype">char</span>      * p_text = NULL
00164                   );
00165 
00166    <span class="comment">/*</span>
00167 <span class="comment">   ** Message objects used by SendStatus</span>
00168 <span class="comment">   */</span>
<a name="l00169"></a><a class="code" href="classTModuleBase.html#n9">00169</a>    THeartbeatMessage * <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a>;
<a name="l00170"></a><a class="code" href="classTModuleBase.html#n10">00170</a>    TErrorMessage     * <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>;
00171 
00172    <span class="comment">/* GetDefaultConfigFile -- returns the name of the default configuration file</span>
00173 <span class="comment">   **                         for the derivative module class.</span>
00174 <span class="comment">   */</span>
00175    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="classTModuleBase.html#b3">GetDefaultConfigFile</a>() <span class="keyword">const</span> = 0; <span class="comment">// { return ""; }</span>
00176 
00177    <span class="comment">/* Heartbeat -- sends a heartbeat at interval, but with no checking of</span>
00178 <span class="comment">   **              work thread status.</span>
00179 <span class="comment">   **</span>
00180 <span class="comment">   **  OVERRIDE as needed for derivative classes</span>
00181 <span class="comment">   */</span>
00182    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b4">Heartbeat</a>();
00183 
<a name="l00184"></a><a class="code" href="classTModuleBase.html#n11">00184</a>    <span class="keywordtype">long</span> <a class="code" href="classTModuleBase.html#n11">LastBeat</a>; <span class="comment">// second [time(NULL)] of last heartbeat</span>
00185 
00186 
00187    <span class="comment">/*  PrepareToRun -- Actions to take prior to starting the main thread looping.</span>
00188 <span class="comment">   **                  Called once prior to entering the loop.</span>
00189 <span class="comment">   **                  (See StartThreadFunc, below about starting worker threads.)</span>
00190 <span class="comment">   **</span>
00191 <span class="comment">   ** RETURNS:   true = preparations were good</span>
00192 <span class="comment">   **           false = preparations failed</span>
00193 <span class="comment">   **</span>
00194 <span class="comment">   **  OVERRIDE as needed for derivative classes</span>
00195 <span class="comment">   */</span>
<a name="l00196"></a><a class="code" href="classTModuleBase.html#b5">00196</a>    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTModuleBase.html#b5">PrepareToRun</a>()
00197    {
00198       LoggingLevel = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>();
00199       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00200    }
00201 
00202    <span class="comment">/* CheckForFatal -- allows the main loop to query derived classes</span>
00203 <span class="comment">   **                  if a fatal error has been encountered.</span>
00204 <span class="comment">   **</span>
00205 <span class="comment">   ** RETURNS:  true if an error occurred and must exit.</span>
00206 <span class="comment">   **          false if no fatal error has occurred.</span>
00207 <span class="comment">   */</span>
<a name="l00208"></a><a class="code" href="classTModuleBase.html#b6">00208</a>    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTModuleBase.html#b6">CheckForFatal</a>() { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
00209 
00210    <span class="comment">/* MainThreadActions -- Actions to be performed in a derived class</span>
00211 <span class="comment">   **                      with each pass through the main thread loop.</span>
00212 <span class="comment">   **                      Called by Run().</span>
00213 <span class="comment">   **</span>
00214 <span class="comment">   ** RETURN:</span>
00215 <span class="comment">   **     WORM_STAT_SUCCESS = good actions</span>
00216 <span class="comment">   **                         The main thread will immediately repeat its loop</span>
00217 <span class="comment">   **     WORM_STAT_NOMATCH = no actions to take (good return)</span>
00218 <span class="comment">   **                         The main thread will sleep before repeating its loop</span>
00219 <span class="comment">   **     WORM_STAT_FAILURE = actions resulted in, or encountered a fatal error</span>
00220 <span class="comment">   **                         The main thread will leave its loop and exit (-1)</span>
00221 <span class="comment">   **</span>
00222 <span class="comment">   **  OVERRIDE as needed for derivative classes</span>
00223 <span class="comment">   */</span>
00224    <span class="keyword">virtual</span> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classTModuleBase.html#b7">MainThreadActions</a>() = 0;
00225 
00226    <span class="comment">/*  FinishedRunning -- Actions to take prior after completing the main thread</span>
00227 <span class="comment">   **                     looping.  Called once, after exiting the loop.</span>
00228 <span class="comment">   **</span>
00229 <span class="comment">   **  OVERRIDE as needed for derivative classes, although clean up</span>
00230 <span class="comment">   **           may also be coded into derived classes destructor methods.</span>
00231 <span class="comment">   */</span>
<a name="l00232"></a><a class="code" href="classTModuleBase.html#b8">00232</a>    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTModuleBase.html#b8">FinishedRunning</a>() { <span class="keywordflow">return</span> <span class="keyword">true</span>; }
00233 
00234 
00235 <span class="keyword">public</span>:
00236 
00237    <span class="comment">// ----------------------------------------------------------------------</span>
00238    <span class="comment">//                        FOR  ThreadableObject</span>
00239 
00240    <span class="comment">/* StartThreadFunc() -- Method through which a newly-spawned</span>
00241 <span class="comment">   **                      thread returns to the "That" object</span>
00242 <span class="comment">   **                      to start execution.</span>
00243 <span class="comment">   **</span>
00244 <span class="comment">   **  If a derivative class needs to start a worker thread, it</span>
00245 <span class="comment">   **  should call StartThread() or StartThreadWithArg().  A new</span>
00246 <span class="comment">   **  thread will be started, and will return through this method</span>
00247 <span class="comment">   **  (which must be overridden in the derivative class).</span>
00248 <span class="comment">   **  Generally, this method will include a call to a specific</span>
00249 <span class="comment">   **  method for the handler to run.</span>
00250 <span class="comment">   **  The methods that are to be entered by newly spawned threads should</span>
00251 <span class="comment">   **  have the return type  THREAD_RETURN.  Furthermore, all</span>
00252 <span class="comment">   **  threads should exit loops and return if variable Running is false.</span>
00253 <span class="comment">   */</span>
<a name="l00254"></a><a class="code" href="classTModuleBase.html#a0">00254</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#a0">StartThreadFunc</a>( <span class="keywordtype">void</span> * p_argument ) { };
00255 
00256 
00257    <span class="comment">// ----------------------------------------------------------------------</span>
00258    <span class="comment">//                        FOR  TModuleBase</span>
00259 
00260 
00261 
00262    <span class="comment">/* ModuleBase -- constructor</span>
00263 <span class="comment">   **</span>
00264 <span class="comment">   ** ACTIONS:  Instantiates the global utilities object</span>
00265 <span class="comment">   **</span>
00266 <span class="comment">   ** Derivative classes be sure to call this by:</span>
00267 <span class="comment">   **</span>
00268 <span class="comment">   **     &lt;derivative_constructor&gt;(.....) : ModuleBase(p_programname, p_configfilename) { }</span>
00269 <span class="comment">   */</span>
00270    <a class="code" href="classTModuleBase.html#a1">TModuleBase</a>( <span class="keywordtype">char</span> * p_programname
00271               , <span class="keywordtype">char</span> * p_configfilename = NULL
00272               );
00273 
00274    <span class="comment">/* Destructor -- cleans up the global utilities and ring writer objects</span>
00275 <span class="comment">   **</span>
00276 <span class="comment">   */</span>
00277    <a class="code" href="classTModuleBase.html#a2">~TModuleBase</a>();
00278 
00279    <span class="comment">/* Run -- the entry point for the main function to start the module</span>
00280 <span class="comment">   **        running.</span>
00281 <span class="comment">   **</span>
00282 <span class="comment">   ** ACTIONS: Parses the command file (.d)</span>
00283 <span class="comment">   **          Check for good instantiation of the global utilities</span>
00284 <span class="comment">   **          Call IsReady() to check module configuration variables.</span>
00285 <span class="comment">   **          Instantiate the ring writer (for heartbeats and errors)</span>
00286 <span class="comment">   **          Set up Solaris signal handling</span>
00287 <span class="comment">   **          Call PrepareToRun() enabling derived classes to start</span>
00288 <span class="comment">   **             worker threads, etc.</span>
00289 <span class="comment">   **          Enter a loop that:</span>
00290 <span class="comment">   **             Calls CheckForFatal() to check for fatal errors</span>
00291 <span class="comment">   **             Looks for shutdown flag on command ring (sets Running = false if so)</span>
00292 <span class="comment">   **             Sends Heartbeat</span>
00293 <span class="comment">   **             Calls MainThreadActions() for derived classes to</span>
00294 <span class="comment">   **                 perform main thread actions.</span>
00295 <span class="comment">   **             Departs loop on CheckForFatal() == true</span>
00296 <span class="comment">   **                          or shutdown flag (-1)</span>
00297 <span class="comment">   **                          or worker thread sets Running = false</span>
00298 <span class="comment">   **          Calls FinishedRunning() for derived class clean up.</span>
00299 <span class="comment">   **</span>
00300 <span class="comment">   ** CAUTION: IT IS USUALLY NOT A GOOD IDEA TO OVERRIDE THIS METHOD.</span>
00301 <span class="comment">   */</span>
00302    <span class="keywordtype">int</span> <a class="code" href="classTModuleBase.html#a3">Run</a>();
00303 };
00304 
00305 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:05 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
