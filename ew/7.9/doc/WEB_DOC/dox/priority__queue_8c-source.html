<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>priority_queue.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>priority_queue.c</h1><a href="priority__queue_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">** priority_queue.c</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This implements a priority transfer queue.</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** Priority levels are defined in the .h file.</span>
00007 <span class="comment">**</span>
00008 <span class="comment">** The actual sorting is of the pointers in array queue-&gt;sorted.</span>
00009 <span class="comment">** Bear in mind these are pointers to the PRI_QUEUE elements in</span>
00010 <span class="comment">** queue-&gt;objects.</span>
00011 <span class="comment">** </span>
00012 <span class="comment">** The queue must first be initialized to a specified size</span>
00013 <span class="comment">** using the init_pri_queue function.  After that, the queue</span>
00014 <span class="comment">** is ready for use through add_item() and pop_next_item().</span>
00015 <span class="comment">** (pop_next_item always returns the next item of the highest</span>
00016 <span class="comment">** priority).</span>
00017 <span class="comment">**</span>
00018 <span class="comment">** SEE priority_queue.h for FUNCTION DESCRIPTIONS and RETURN CODES.</span>
00019 <span class="comment">**</span>
00020 <span class="comment">** CAUTION: This queue manages its own mutex, and thus the function</span>
00021 <span class="comment">**          calls do not need to be wrapped in such by the caller.</span>
00022 <span class="comment">*/</span>
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">platform.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;<a class="code" href="earthworm__complex__funcs_8h.html">earthworm_complex_funcs.h</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="priority__queue_8h.html">priority_queue.h</a>&gt;</span>
00029 
00030 <span class="comment">/* #define LOG_DEBUG 1  */</span>
00031 
00032 <span class="preprocessor">#ifdef LOG_DEBUG</span>
00033 <span class="preprocessor"></span><span class="comment">/* #define DEBUG_DETAILS 1 */</span>
00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00035 <span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 <span class="comment">/* Private definitions used to simplify the code by keeping the array</span>
00038 <span class="comment">** shifting in a single location.</span>
00039 <span class="comment">*/</span>
<a name="l00040"></a><a class="code" href="priority__queue_8c.html#a0">00040</a> <span class="preprocessor">#define EW_PRI_SHIFT_DOWN -1</span>
<a name="l00041"></a><a class="code" href="priority__queue_8c.html#a1">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define EW_PRI_SHIFT_NONE  0</span>
<a name="l00042"></a><a class="code" href="priority__queue_8c.html#a2">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define EW_PRI_SHIFT_UP    1</span>
00043 <span class="preprocessor"></span>
00044 
00045 <span class="comment">/*********************************************************</span>
00046 <span class="comment">**</span>
00047 <span class="comment">**********************************************************/</span>
<a name="l00048"></a><a class="code" href="priority__queue_8c.html#a3">00048</a> <span class="keywordtype">int</span> <a class="code" href="priority__queue_8c.html#a3">init_pri_queue</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a>   * p_queue
00049                   , <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> p_max_items
00050                   , <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> p_max_item_size )
00051 {
00052    <span class="keywordtype">int</span> r_status = <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a>;
00053 
00054    <span class="keywordflow">if</span> ( p_queue == NULL )
00055    {
00056       r_status = <a class="code" href="priority__queue_8h.html#a6">EW_PRI_RETQNULL</a>;   
00057    }
00058    <span class="keywordflow">else</span>
00059    {
00060       <span class="comment">/*</span>
00061 <span class="comment">      ** Initialize structure in case deallocation needed later</span>
00062 <span class="comment">      */</span>
00063       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> = 0;
00064       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a> = 0;
00065       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>    = NULL;
00066       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a>   = NULL;
00067       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a>      = NULL;
00068    }
00069 
00070    <span class="keywordflow">if</span> ( p_max_items &lt; 1 )
00071    {
00072       r_status = <a class="code" href="priority__queue_8h.html#a9">EW_PRI_RETPARAM</a>;
00073    }
00074 
00075    <span class="keywordflow">if</span> ( r_status == 0 )
00076    {
00077       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _idx;
00078 
00079       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> = p_max_items;
00080       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m2">itemmaxsize</a> = p_max_item_size;
00081 
00082       <span class="comment">/*</span>
00083 <span class="comment">      ** Allocate space for the sorted pointers to the object storage</span>
00084 <span class="comment">      */</span>
00085       <span class="keywordflow">if</span> ( r_status == <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00086       {
00087          <span class="keywordflow">if</span> ( ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> = (<a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> **) malloc( <span class="keyword">sizeof</span>(<a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a>*) * p_max_items) ) ==  NULL )
00088          {
00089             r_status = <a class="code" href="priority__queue_8h.html#a7">EW_PRI_RETMALLOC</a>;
00090          }
00091       }
00092 
00093       <span class="comment">/*</span>
00094 <span class="comment">      ** Allocate space for the object storage</span>
00095 <span class="comment">      */</span>
00096       <span class="keywordflow">if</span> ( r_status == <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00097       {
00098          <span class="keywordflow">if</span> ( ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a> = (<a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> *) malloc( <span class="keyword">sizeof</span>(<a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a>) * p_max_items) ) ==  NULL )
00099          {
00100             r_status = <a class="code" href="priority__queue_8h.html#a7">EW_PRI_RETMALLOC</a>;
00101          }
00102       }
00103 
00104 
00105       <span class="comment">/*</span>
00106 <span class="comment">      ** Allocate space for the object storage</span>
00107 <span class="comment">      */</span>
00108       <span class="keywordflow">if</span> ( r_status == <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00109       {
00110          <span class="keywordflow">if</span> ( ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a> = (<span class="keywordtype">char</span> *) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * p_max_item_size * p_max_items) ) ==  NULL )
00111          {
00112             r_status = <a class="code" href="priority__queue_8h.html#a7">EW_PRI_RETMALLOC</a>;
00113          }
00114       }
00115       
00116 
00117       <span class="comment">/*</span>
00118 <span class="comment">      ** Initialize the priority containers,</span>
00119 <span class="comment">      ** Load the container pointers into the sorted list</span>
00120 <span class="comment">      */</span>
00121       <span class="keywordflow">if</span> ( r_status == <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00122       {
00123          <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a>  * _entry  = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a>;
00124          <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> ** _sorted = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>;
00125          <span class="keywordflow">for</span> ( _idx = 0 ; _idx &lt; p_max_items ; _idx++, _entry++, _sorted++ ) 
00126          {
00127             <span class="comment">/* set priority to indicate no valid data */</span>
00128             _entry-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> = <a class="code" href="priority__queue_8h.html#a10">EW_PRIORITY_NONE</a>;
00129             _entry-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m2">length</a> = 0;
00130             <span class="comment">/* assign data storage location to queue entry */</span>
00131             _entry-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m3">data</a> = (<span class="keywordtype">char</span> *)(p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a> + (_idx * p_max_item_size));
00132             <span class="comment">/* grab storage pointer for sorted array */</span>
00133             *_sorted = _entry;
00134          }
00135       }
00136 
00137 
00138       <span class="comment">/*</span>
00139 <span class="comment">      ** Initialize priority index locations to point to the first (zero)</span>
00140 <span class="comment">      ** location in the sorted array</span>
00141 <span class="comment">      */</span>
00142       <span class="keywordflow">if</span> ( r_status == <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00143       {
00144          <span class="keywordflow">for</span> ( _idx = 0 ; _idx &lt; <a class="code" href="priority__queue_8h.html#a13">EW_PRIORITY_COUNT</a> ; _idx++ ) {
00145             p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] = 0;
00146          }
00147       }
00148       <a class="code" href="earthworm__complex__funcs_8h.html#a8">CreateSpecificMutex</a>( &amp;(p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a>) );
00149    }
00150 
00151 
00152    <span class="keywordflow">if</span> ( r_status != <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a> )
00153    {
00154       <a class="code" href="priority__queue_8c.html#a4">release_pri_queue</a>( p_queue );
00155    }
00156 <span class="preprocessor">#ifdef LOG_DEBUG</span>
00157 <span class="preprocessor"></span>   <span class="keywordflow">else</span>
00158    {
00159       <span class="keywordtype">char</span> dbgstr[120];
00160             sprintf( dbgstr
00161                    , <span class="stringliteral">"DEBUG init: %d  %d  %d\n"</span>
00162                    , p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>, p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a>, p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a>
00163                    );
00164             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span> 
00165                  , dbgstr
00166                  , <span class="stringliteral">"export_pri"</span>
00167                  , <span class="stringliteral">"MOD_EXPORT_SCN"</span>
00168                  );
00169    }
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span>   <span class="keywordflow">return</span> r_status;
00172 }
00173 
00174 
00175 <span class="comment">/*********************************************************</span>
00176 <span class="comment">**</span>
00177 <span class="comment">**********************************************************/</span>
<a name="l00178"></a><a class="code" href="priority__queue_8c.html#a4">00178</a> <span class="keywordtype">void</span> <a class="code" href="priority__queue_8c.html#a4">release_pri_queue</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a> * p_queue )
00179 {
00180    p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> = 0;
00181    p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a> = 0;
00182 
00183    <a class="code" href="earthworm__complex__funcs_8h.html#a9">CloseSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00184 
00185    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> != NULL )
00186    {
00187       free( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> );
00188       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> = NULL;
00189    }
00190 
00191    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a> != NULL )
00192    {
00193       free( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a> );
00194       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m5">entries</a> = NULL;
00195    }
00196 
00197    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a> != NULL )
00198    {
00199       free( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a> );
00200       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m6">data</a> = NULL;
00201    }
00202 }
00203 
00204 <span class="comment">/*********************************************************</span>
00205 <span class="comment">**</span>
00206 <span class="comment">**********************************************************/</span>
<a name="l00207"></a><a class="code" href="priority__queue_8c.html#a5">00207</a> <span class="keywordtype">int</span> <a class="code" href="priority__queue_8c.html#a5">getNumOfElementsInQueue</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a> * p_queue )
00208 {
00209    <span class="keywordflow">if</span> ( p_queue == NULL )
00210    {
00211       <span class="keywordflow">return</span> 0;
00212    }
00213    <span class="keywordflow">return</span> p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a>;
00214 }
00215 
00216 <span class="comment">/*********************************************************</span>
00217 <span class="comment">**</span>
00218 <span class="comment">**********************************************************/</span>
<a name="l00219"></a><a class="code" href="priority__queue_8c.html#a6">00219</a> <span class="keywordtype">int</span> <a class="code" href="priority__queue_8c.html#a6">add_item</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a> * p_queue
00220             , EW_PRIORITY p_priority
00221             , <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a>    p_logo
00222             , <span class="keywordtype">long</span>        p_size
00223             , PRI_DATA    p_data
00224             )
00225 {
00226 <span class="preprocessor">#ifdef LOG_DEBUG</span>
00227 <span class="preprocessor"></span>   <span class="keywordtype">char</span> dbgstr[120];
00228 <span class="preprocessor">#endif</span>
00229 <span class="preprocessor"></span>
00230    <span class="keywordtype">int</span> r_status = <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a>;
00231 
00232    <span class="keywordflow">if</span> ( p_queue == NULL )
00233    {
00234       <span class="keywordflow">return</span>( EW_PRI_RETQNULL );
00235    }
00236 
00237    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> &lt; 1 )
00238    {
00239       <span class="keywordflow">return</span>( EW_PRI_RETNOTREADY );
00240    }
00241 
00242    <a class="code" href="earthworm__complex__funcs_8h.html#a10">RequestSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00243 
00244    <span class="keywordflow">if</span> ( p_size &lt; 0 || p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m2">itemmaxsize</a> &lt; p_size )
00245    {
00246       <span class="keywordflow">return</span> ( EW_PRI_RETMSGSIZE );
00247    }
00248    <span class="keywordflow">else</span>
00249    {
00250       <a class="code" href="priority__queue_8h.html#a15">EW_PRIORITY</a> _usePri = p_priority;
00251 
00252       <span class="keywordtype">long</span> _queuesize = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a>
00253          , _ins_index = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> - 1 <span class="comment">/* array location to insert new object */</span>
00254          , _src_index   <span class="comment">/* array location to obtain container for insertion */</span>
00255          ;
00256       <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> * _wrk_pointer;  <span class="comment">/* item to be shifted */</span>
00257       <span class="keywordtype">int</span> _shift_direction = <a class="code" href="priority__queue_8c.html#a1">EW_PRI_SHIFT_NONE</a>
00258          , _shift_stt
00259          , _shift_end
00260          , _idx             <span class="comment">/* work index for loops */</span>
00261          ;
00262       <span class="keywordtype">int</span> _doSwap  = 0  <span class="comment">/* swap old object for new */</span>
00263       , _updateIdx = 0  <span class="comment">/* update the priority insert location indices */</span>
00264       ;
00265 
00266       <span class="keywordflow">if</span> ( p_priority &lt; <a class="code" href="priority__queue_8h.html#a11">EW_PRIORITY_MIN</a> || <a class="code" href="priority__queue_8h.html#a12">EW_PRIORITY_MAX</a> &lt; p_priority )
00267       {
00268          <span class="comment">/* priority out of range, fall back to default */</span>
00269          _usePri = <a class="code" href="priority__queue_8h.html#a14">EW_PRIORITY_DEF</a>;
00270          <span class="comment">/* keep this return status unless worse one arises */</span>
00271          r_status = <a class="code" href="priority__queue_8h.html#a8">EW_PRI_RETBADPRI</a>;
00272       }
00273 
00274 
00275       <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[p_priority] &lt; _queuesize )
00276       {
00277          <span class="comment">/*</span>
00278 <span class="comment">         ** The insert location is within the array</span>
00279 <span class="comment">         */</span>
00280          _ins_index = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[p_priority];
00281 
00282 
00283          <span class="comment">/* Check state of item at insert location */</span>
00284          _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_ins_index];
00285 
00286          <span class="keywordflow">if</span> (   _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> == 0           <span class="comment">/* container at insert location unused */</span>
00287              || _ins_index == (_queuesize - 1) <span class="comment">/* insert location is last position in the array */</span>
00288             )
00289          {
00290             <span class="comment">/*</span>
00291 <span class="comment">            ** Use the item at the insert location as the source container</span>
00292 <span class="comment">            **</span>
00293 <span class="comment">            ** _shift_direction = 0;</span>
00294 <span class="comment">            */</span>
00295             _doSwap = 1;
00296             _updateIdx = 1;
00297             <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a> &lt; _queuesize )
00298             {
00299                p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a>++;  <span class="comment">/* increment number of items used */</span>
00300             }
00301          }
00302          <span class="keywordflow">else</span>
00303          {  <span class="comment">/*</span>
00304 <span class="comment">            ** the insert location is within the array space</span>
00305 <span class="comment">            ** the item at the insert location is used</span>
00306 <span class="comment">            ** the insert location is not the last position in the array</span>
00307 <span class="comment">            */</span>
00308             
00309             <span class="comment">/* check if the array is full */</span>
00310             <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a> &lt; _queuesize )
00311             {
00312                <span class="comment">/*</span>
00313 <span class="comment">               ** The array is not full, therefore there is at least one</span>
00314 <span class="comment">               ** unused item in the array.</span>
00315 <span class="comment">               **</span>
00316 <span class="comment">               ** Shift items down from insert point to first unused item</span>
00317 <span class="comment">               */</span>
00318                _src_index = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a>++;  <span class="comment">/* increment number of items used */</span>
00319 
00320                <span class="comment">/* GET THE SOURCE CONTAINER */</span>
00321                _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_src_index];
00322 
00323                <span class="comment">/* SHIFT ITEMS DOWN */</span>
00324                _shift_end = _ins_index;
00325                _shift_stt = _src_index;
00326                _shift_direction = <a class="code" href="priority__queue_8c.html#a0">EW_PRI_SHIFT_DOWN</a>;
00327 
00328                _doSwap = 1;
00329                _updateIdx = 1;
00330             }
00331             <span class="keywordflow">else</span>
00332             {
00333                <span class="comment">/*</span>
00334 <span class="comment">               ** The array is full.</span>
00335 <span class="comment">               **</span>
00336 <span class="comment">               ** Since we've already ascertained that the insert point is within the array</span>
00337 <span class="comment">               ** we know that the item to be inserted is less than the highest priority</span>
00338 <span class="comment">               ** stored in the array because there is at least one item of a higher priority</span>
00339 <span class="comment">               ** following the items at the priority of the new item.</span>
00340 <span class="comment">               **</span>
00341 <span class="comment">               ** Get the priority of the last item in the array, use the earliest item</span>
00342 <span class="comment">               ** of that priority to make space for the new item.</span>
00343 <span class="comment">               ** This equates to shifting items from the insert location down to the</span>
00344 <span class="comment">               ** insert location of the priority before the last (the first item of</span>
00345 <span class="comment">               ** the last priority in the array).</span>
00346 <span class="comment">               */</span>
00347                _src_index = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[ p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_queuesize - 1]-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> - 1 ];
00348 
00349                <span class="comment">/* GET THE SOURCE CONTAINER */</span>
00350                _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_src_index];
00351 
00352                <span class="comment">/* SHIFT ITEMS DOWN */</span>
00353                _shift_end = _ins_index;
00354                _shift_stt = _src_index;
00355                _shift_direction = <a class="code" href="priority__queue_8c.html#a0">EW_PRI_SHIFT_DOWN</a>;
00356 
00357                _doSwap = 1;
00358                _updateIdx = 1;
00359 
00360                r_status = <a class="code" href="priority__queue_8h.html#a2">EW_PRI_RETDROP</a>;
00361             }
00362          }
00363       }  <span class="comment">/*  insert_indices[p_priority] &lt; _queuesize  */</span>
00364       <span class="keywordflow">else</span>
00365       {  <span class="comment">/*  insert_indices[p_priority] == _queuesize</span>
00366 <span class="comment">         **</span>
00367 <span class="comment">         ** Insert index for the priority of the new item is past the end of</span>
00368 <span class="comment">         ** the array.  (The array is full.)</span>
00369 <span class="comment">         **</span>
00370 <span class="comment">         ** Therefore, this item can only be inserted if this item has the</span>
00371 <span class="comment">         ** same priority as the last item in the array and the priority</span>
00372 <span class="comment">         ** of the last item in the array is not of the minimum priority.</span>
00373 <span class="comment">         **</span>
00374 <span class="comment">         ** In such a case, will drop the earliest item of the same priority,</span>
00375 <span class="comment">         ** shift all other of the priority up, and tack the new item on at the end.</span>
00376 <span class="comment">         **</span>
00377 <span class="comment">         ** (That way, if the bandwidth opens up again and no others of this</span>
00378 <span class="comment">         ** priority are dropped, we can send a continuous stream of this</span>
00379 <span class="comment">         ** priority from the earliest point at which there was sufficient</span>
00380 <span class="comment">         ** bandwidth).</span>
00381 <span class="comment">         */</span>
00382          <span class="keywordflow">if</span> (   p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_queuesize - 1]-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> != <a class="code" href="priority__queue_8h.html#a11">EW_PRIORITY_MIN</a>
00383              &amp;&amp; p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[p_priority - 1] &lt; _queuesize
00384             )
00385          {
00386             <span class="comment">/*</span>
00387 <span class="comment">            ** The insert point for the priority immediately prior to this one</span>
00388 <span class="comment">            ** is before the end of the array, indicating that this item is of</span>
00389 <span class="comment">            ** the same priority as the last priority in the array.</span>
00390 <span class="comment">            */</span>
00391             <span class="comment">/* GET THE SOURCE CONTAINER */</span>
00392             _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[ p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[p_priority - 1] ];
00393 
00394             <span class="comment">/* SHIFT ITEMS UP */</span>
00395             _shift_stt = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[p_priority - 1];
00396             _shift_end = _queuesize - 1;
00397             _shift_direction = <a class="code" href="priority__queue_8c.html#a2">EW_PRI_SHIFT_UP</a>;
00398 
00399             _doSwap = 1;
00400             _updateIdx = 1;
00401 
00402             r_status = <a class="code" href="priority__queue_8h.html#a2">EW_PRI_RETDROP</a>;
00403 
00404          }
00405          <span class="keywordflow">else</span>
00406          {
00407             r_status = <a class="code" href="priority__queue_8h.html#a1">EW_PRI_RETREJECT</a>;
00408          }
00409       }
00410 
00411 
00412       <span class="keywordflow">if</span> ( _doSwap == 1 )
00413       {
00414 
00415          _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a>           = p_priority;
00416          (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).type   = p_logo.<a class="code" href="structMSG__LOGO.html#m0">type</a>;
00417          (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).mod    = p_logo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>;
00418          (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).instid = p_logo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>;
00419          _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m2">length</a>        = p_size;
00420          <span class="comment">/*</span>
00421 <span class="comment">         ** copy message text</span>
00422 <span class="comment">         **/</span>
00423          <span class="keywordflow">if</span> ( _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m3">data</a> != NULL ) <span class="comment">/* avoid invalid write at termination */</span>
00424          {
00425             memcpy( _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m3">data</a>, p_data, p_size );
00426          }
00427       }
00428 
00429 
00430       <span class="keywordflow">if</span> ( _shift_direction != <a class="code" href="priority__queue_8c.html#a1">EW_PRI_SHIFT_NONE</a> &amp;&amp; p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> != NULL )
00431       {
00432          <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> * _temp = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_shift_stt];
00433 
00434 <span class="preprocessor">#ifdef DEBUG_DETAILS</span>
00435 <span class="preprocessor"></span>         sprintf( dbgstr
00436                 , <span class="stringliteral">"DEBUG add_item() shifting %d -&gt; %d (%d)\n"</span>
00437                 , _shift_stt, _shift_end, _shift_direction
00438                 );
00439          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span> 
00440               , dbgstr
00441               , <span class="stringliteral">"export_pri"</span>
00442               , <span class="stringliteral">"MOD_EXPORT_SCN"</span>
00443               );
00444 <span class="preprocessor">#endif</span>
00445 <span class="preprocessor"></span>         <span class="keywordflow">for</span> ( _idx = _shift_stt
00446              ; ( _shift_direction == <a class="code" href="priority__queue_8c.html#a2">EW_PRI_SHIFT_UP</a> ? _idx &lt; _shift_end : _idx &gt; _shift_end )
00447              ; _idx += _shift_direction
00448              )
00449          {
00450 <span class="preprocessor">#ifdef DEBUG_DETAILS</span>
00451 <span class="preprocessor"></span>            sprintf( dbgstr
00452                    , <span class="stringliteral">"DEBUG shifting [%d] = [%d]\n"</span>
00453                    , _idx, _idx + _shift_direction
00454                    );
00455             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span> 
00456                  , dbgstr
00457                  , <span class="stringliteral">"export_pri"</span>
00458                  , <span class="stringliteral">"MOD_EXPORT_SCN"</span>
00459                  );
00460 <span class="preprocessor">#endif</span>
00461 <span class="preprocessor"></span>            p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[ _idx ] = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[ _idx + _shift_direction ];
00462          }
00463          p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_shift_end] = _temp;
00464       }
00465 
00466 
00467       <span class="keywordflow">if</span> ( _updateIdx == 1 )
00468       {
00469          <span class="comment">/* Adjust insert indices */</span>
00470          <span class="keywordflow">for</span> ( _idx = p_priority ; _idx &lt; <a class="code" href="priority__queue_8h.html#a13">EW_PRIORITY_COUNT</a> ; _idx++ )
00471          {
00472             <span class="keywordflow">if</span> ( ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] + 1 ) &lt;= _queuesize )
00473             {
00474                p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] + 1;
00475             }
00476          }
00477       }
00478    }
00479 
00480    <a class="code" href="earthworm__complex__funcs_8h.html#a11">ReleaseSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00481 
00482    <span class="keywordflow">return</span> r_status;
00483 }
00484 
00485 
00486 <span class="comment">/*********************************************************</span>
00487 <span class="comment">**</span>
00488 <span class="comment">**********************************************************/</span>
<a name="l00489"></a><a class="code" href="priority__queue_8c.html#a7">00489</a> <span class="keywordtype">int</span> <a class="code" href="priority__queue_8c.html#a7">peek_next_item</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a>   * p_queue
00490                   , <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a>    * p_logoptr
00491                   , EW_PRIORITY * p_priptr
00492                   )
00493 {
00494    <span class="keywordtype">int</span> r_status = <a class="code" href="priority__queue_8h.html#a0">EW_PRI_NOITEM</a>;  <span class="comment">/* no items in queue */</span>
00495 
00496    <span class="keywordflow">if</span> ( p_queue == NULL )
00497    {
00498       <span class="keywordflow">return</span>( EW_PRI_RETQNULL );
00499    }
00500 
00501    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> &lt; 1  )
00502    {
00503       <span class="keywordflow">return</span>( EW_PRI_RETNOTREADY );
00504    }
00505 
00506    <a class="code" href="earthworm__complex__funcs_8h.html#a10">RequestSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00507 
00508    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a> != NULL )
00509    {
00510       <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> * _wrk_pointer;  <span class="comment">/* item to be shifted */</span>
00511       <span class="comment">/*</span>
00512 <span class="comment">      ** Check the priority of the object referenced by the</span>
00513 <span class="comment">      ** first pointer in the array.</span>
00514 <span class="comment">      **</span>
00515 <span class="comment">      ** If the priority is none, then there are no items in the list</span>
00516 <span class="comment">      */</span>
00517       _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[0];
00518 
00519       <span class="keywordflow">if</span> ( _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> != <a class="code" href="priority__queue_8h.html#a10">EW_PRIORITY_NONE</a> )
00520       {  
00521          <span class="comment">/* copy the logo */</span>
00522          p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m0">type</a>   = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).type;
00523          p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m1">mod</a>    = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).mod ;
00524          p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m2">instid</a> = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).instid;
00525   
00526          *p_priptr  = _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a>;  <span class="comment">/* message priority */</span>
00527 
00528          r_status = <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a>;
00529       }
00530    }
00531 
00532    <a class="code" href="earthworm__complex__funcs_8h.html#a11">ReleaseSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00533 
00534    <span class="keywordflow">return</span> r_status;
00535 }
00536 
00537 
00538 <span class="comment">/*********************************************************</span>
00539 <span class="comment">**</span>
00540 <span class="comment">**********************************************************/</span>
<a name="l00541"></a><a class="code" href="priority__queue_8c.html#a8">00541</a> <span class="keywordtype">int</span> <a class="code" href="priority__queue_8c.html#a8">pop_next_item</a>( <a class="code" href="structPRI__QUEUE.html">PRI_QUEUE</a> * p_queue
00542                  , <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a>  * p_logoptr
00543                  , <span class="keywordtype">long</span>      * p_sizeptr
00544                  , PRI_DATA    p_data
00545                  )
00546 {
00547 <span class="preprocessor">#ifdef LOG_DEBUG</span>
00548 <span class="preprocessor"></span>   <span class="keywordtype">char</span> dbgstr[120];
00549 <span class="preprocessor">#endif</span>
00550 <span class="preprocessor"></span>   
00551    <span class="keywordtype">int</span> r_status = <a class="code" href="priority__queue_8h.html#a0">EW_PRI_NOITEM</a>;  <span class="comment">/* no items in queue */</span>
00552 
00553    <a class="code" href="structPRI__QUEUE__ENTRY.html">PRI_QUEUE_ENTRY</a> * _wrk_pointer;  <span class="comment">/* item to be shifted */</span>
00554    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _idx
00555                , _sz
00556                ;
00557 
00558    <span class="keywordflow">if</span> ( p_queue == NULL )
00559    {
00560       <span class="keywordflow">return</span>( EW_PRI_RETQNULL );
00561    }
00562 
00563    <span class="keywordflow">if</span> ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> &lt; 1  )
00564    {
00565       <span class="keywordflow">return</span>( EW_PRI_RETNOTREADY );
00566    }
00567 
00568    <a class="code" href="earthworm__complex__funcs_8h.html#a10">RequestSpecificMutex</a>( &amp;(p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a>) );
00569 
00570 
00571    <span class="comment">/*</span>
00572 <span class="comment">   ** Check the priority of the object referenced by the</span>
00573 <span class="comment">   ** first pointer in the array.</span>
00574 <span class="comment">   **</span>
00575 <span class="comment">   ** If the priority is none, then there are no items in the list</span>
00576 <span class="comment">   */</span>
00577    _wrk_pointer = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[0];
00578 
00579    <span class="keywordflow">if</span> ( _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a> != <a class="code" href="priority__queue_8h.html#a10">EW_PRIORITY_NONE</a> )
00580    { 
00581       <span class="comment">/* copy the logo */</span>
00582       p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m0">type</a>   = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).type;
00583       p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m1">mod</a>    = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).mod ;
00584       p_logoptr-&gt;<a class="code" href="structMSG__LOGO.html#m2">instid</a> = (_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m1">logo</a>).instid;
00585   
00586       *p_sizeptr  = _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m2">length</a>;  <span class="comment">/* message length */</span>
00587 
00588       <span class="comment">/*</span>
00589 <span class="comment">      ** copy text of message to caller's memory </span>
00590 <span class="comment">      */</span>
00591       memcpy( p_data, _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m3">data</a>, (size_t)(_wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m2">length</a>) );
00592 
00593       <span class="comment">/* shift pointers to the other queue entries up */</span>
00594       <span class="keywordflow">for</span> ( _idx = 0, _sz = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> - 1 ; _idx &lt; _sz ; _idx++ )
00595       {
00596          p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_idx] = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[_idx + 1];
00597       }
00598 
00599       <span class="comment">/* clear the queue entry item */</span>
00600       _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m0">pri</a>    = <a class="code" href="priority__queue_8h.html#a10">EW_PRIORITY_NONE</a>;
00601       _wrk_pointer-&gt;<a class="code" href="structPRI__QUEUE__ENTRY.html#m2">length</a> = 0;
00602 
00603       <span class="comment">/*</span>
00604 <span class="comment">      ** Put the pointer to the now empty queue entry</span>
00605 <span class="comment">      ** at the end of the sorted array</span>
00606 <span class="comment">      */</span>
00607       p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m4">sorted</a>[p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a> - 1] = _wrk_pointer;
00608 
00609       <span class="comment">/* update the insert indices */</span>
00610       <span class="keywordflow">for</span> ( _idx = 0 ; _idx &lt; <a class="code" href="priority__queue_8h.html#a13">EW_PRIORITY_COUNT</a> ; _idx++ )
00611       {
00612          <span class="keywordflow">if</span> ( 0 &lt;= ( p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] - 1 ) )
00613          {
00614             p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] = p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m3">insert_indices</a>[_idx] - 1;
00615          }
00616       }
00617 
00618       <span class="comment">/* update the used count */</span>
00619       (p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a>)--;
00620       
00621       r_status = <a class="code" href="priority__queue_8h.html#a3">EW_PRI_RETNORMAL</a>;
00622    }
00623 
00624 <span class="preprocessor">#ifdef DEBUG_DETAILS</span>
00625 <span class="preprocessor"></span>   sprintf( dbgstr
00626           , <span class="stringliteral">"%%s(%%s): DEBUG pop_next_item() releasing mutex; q state: %d of %d\n"</span>
00627           , p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m1">itemsused</a>
00628           , p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m0">queuesize</a>
00629           );
00630    <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span> 
00631         , dbgstr
00632         , <span class="stringliteral">"export_pri"</span>
00633         , <span class="stringliteral">"MOD_EXPORT_SCN"</span>
00634         );
00635 <span class="preprocessor">#endif</span>
00636 <span class="preprocessor"></span>
00637    <a class="code" href="earthworm__complex__funcs_8h.html#a11">ReleaseSpecificMutex</a>( &amp;p_queue-&gt;<a class="code" href="structPRI__QUEUE.html#m7">lock</a> );
00638 
00639    <span class="keywordflow">return</span> r_status;
00640 }
00641 
00642 
00643 
00644 
00645 
00646 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:07 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
