<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dave_trig.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>dave_trig.c</h1><a href="dave__trig_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: dave__trig_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:01  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.6  2001/04/05 17:56:27  cjbryan</span>
00011 <span class="comment"> *     *** empty log message ***</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.5  2001/03/22 16:13:28  alex</span>
00014 <span class="comment"> *     *** empty log message ***</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *     Revision 1.4  2001/03/21 18:50:27  alex</span>
00017 <span class="comment"> *     subnet NULL fix as per Pete.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *     Revision 1.3  2001/03/21 02:20:04  alex</span>
00020 <span class="comment"> *     Alex 3/20/1 added .subnet stuff for CVO</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> *     Revision 1.2  2000/03/31 18:26:03  lucky</span>
00023 <span class="comment"> *     *** empty log message ***</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00026 <span class="comment"> *     Initial revision</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> */</span>
00030 
00031   <span class="comment">/************************************************************</span>
00032 <span class="comment">   *                       parse_trig.c                       *</span>
00033 <span class="comment">   *                                                          *</span>
00034 <span class="comment">   * 1/19/00 Alex: changed eventId from being an integer to   *</span>
00035 <span class="comment">   *  a string.                                               *</span>
00036 <span class="comment">   *                                                          *</span>
00037 <span class="comment">   * Mon Nov  2 11:02:23 MST 1998 lucky                       *</span>
00038 <span class="comment">   *  Y2K compliance:                                         *</span>
00039 <span class="comment">   *   SNIPPET struct has been modified to include 8 digit    *</span>
00040 <span class="comment">   *   date (YYYYMMDD), and corresponding changes have been   *</span>
00041 <span class="comment">   *   made in parse_Snippet().                               *</span>
00042 <span class="comment">   *                                                          *</span>
00043 <span class="comment">   *   t_atodbl() changed to reflect YYYYMMDD. Introduced     *</span>
00044 <span class="comment">   *   defines that hold string lengths in case these formats *</span>
00045 <span class="comment">   *   ever need to be changed in the future. Call to         *</span>
00046 <span class="comment">   *   epocchsec15() replaced by epochsec17().                *</span>
00047 <span class="comment">   *                                                          *</span>
00048 <span class="comment">   ************************************************************/</span>  
00049 
00050 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00051 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00052 <span class="preprocessor">#include &lt;string.h&gt;</span>
00053 <span class="preprocessor">#include &lt;time.h&gt;</span>
00054 
00055 <span class="preprocessor">#ifndef EARTHWORM_H</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="parse__trig_8h.html">parse_trig.h</a>&gt;</span>
00059 
00060 
<a name="l00061"></a><a class="code" href="dave__trig_8c.html#a0">00061</a> <span class="preprocessor">#define LINE_LEN         500</span>
<a name="l00062"></a><a class="code" href="dave__trig_8c.html#a1">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define BAD_TIME_VALUE   5</span>
00063 <span class="preprocessor"></span>
00064 <span class="comment">/* Function declarations */</span>
00065 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="chron3_8c.html#a11">epochsec17</a> (<span class="keywordtype">double</span> *, <span class="keywordtype">char</span> *);
00066 <span class="keywordtype">int</span> <a class="code" href="parse__trig_8c.html#a8">getNextLine</a> (<span class="keywordtype">char</span>**, <span class="keywordtype">char</span>*);
00067 <span class="keywordtype">int</span> <a class="code" href="parse__trig_8h.html#a3">t_atodbl</a> (<span class="keywordtype">char</span>*, <span class="keywordtype">char</span>*, <span class="keywordtype">double</span>*); 
00068 
00069 <span class="comment">/*</span>
00070 <span class="comment">Story:</span>
00071 <span class="comment">        parseSnippet() parses a trigger message. Inspired by, and uses,</span>
00072 <span class="comment">strtok. Therefore,   IT IS NOT MULTI-THREAD SAFE. It must be mutex</span>
00073 <span class="comment">protected against concurrent calls to strtok.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Arguments:</span>
00076 <span class="comment">        msg:    pointer to the trigger message.</span>
00077 <span class="comment">        pSnp:   pointer to a SNIPPET structure (see parse_trig.h)</span>
00078 <span class="comment">        nxtLine:running pointer to current line to be parsed.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Usage:</span>
00081 <span class="comment">For the first call, set nxtLine to msg. This tells parseSnippet that</span>
00082 <span class="comment">we're starting a new message. It will search for, and parse  the event</span>
00083 <span class="comment">id. It will also parse the first line, and stuff the elements of the</span>
00084 <span class="comment">SNIPPET structure.  It will then advance nxtLine to point to the next</span>
00085 <span class="comment">line to be parsed and return.  Subsequent calls, with the adjusted</span>
00086 <span class="comment">value of nxtLine, will result in the next line of the message being</span>
00087 <span class="comment">parsed.  When the last line has been parsed, a EW_FAILURE will be</span>
00088 <span class="comment">returned.  </span>
00089 <span class="comment">*/</span>
00090 
00091 
00092 <span class="comment">/***********************************************************************</span>
00093 <span class="comment"> *  parseSnippet() parses snippet parameters from next line of trigger *</span>
00094 <span class="comment"> *                 message. Returns EW_FAILURE when nothing left.      *</span>
00095 <span class="comment"> *                 Does its own error logging via logit.                       *</span>
00096 <span class="comment"> ***********************************************************************/</span>
<a name="l00097"></a><a class="code" href="dave__trig_8c.html#a10">00097</a> <span class="keywordtype">int</span> <a class="code" href="dave__trig_8c.html#a10">parseSnippet</a>( <span class="keywordtype">char</span>* msg, <a class="code" href="structSNIPPET.html">SNIPPET</a>* pSnp, <span class="keywordtype">char</span>** nxtLine)
00098 {
00099    <span class="keyword">static</span> <span class="keywordtype">char</span> terminators[] = <span class="stringliteral">" \t\n"</span>; <span class="comment">/* we accept space, newline, and tab as terminators */</span>
00100    <span class="keywordtype">char</span>* nxttok;
00101    <span class="keywordtype">char</span> line[<a class="code" href="dave__trig_8c.html#a0">LINE_LEN</a>];
00102    <span class="keyword">static</span> <span class="keywordtype">int</span> startFresh=0;
00103 
00104    <span class="comment">/* if pointer to next line points to start of message, start clean </span>
00105 <span class="comment">    *****************************************************************/</span>
00106    <span class="keywordflow">if</span> (*nxtLine == msg) startFresh  = 1;
00107    <span class="keywordflow">else</span> <span class="keywordflow">goto</span> GetNextStation;
00108 
00109    <span class="comment">/* if event id is negative, search for new EVENT ID</span>
00110 <span class="comment">    **************************************************/</span>
00111 
00112 
00113    GetNextEvent:    <span class="comment">/* we jump to here when we run off the end of an event (below) */</span>
00114 
00115    <span class="comment">/* we're looking for a line with the form shown below:</span>
00116 <span class="comment"> EVENT DETECTED     19970729 03:01:13.22 UTC  EVENT ID: 123ABC AUTHOR: Harry SUBNET: redoubt</span>
00117 <span class="comment">         *</span>
00118 <span class="comment">         *************************  Y2K  ************************/</span>
00119 
00120    <span class="keywordflow">if</span> ( startFresh == 1)
00121         {
00122         <span class="comment">/* get next non-zero length line from trigger message */</span>
00123         <span class="keywordflow">while</span> ( <a class="code" href="parse__trig_8c.html#a8">getNextLine</a>(nxtLine, line) &gt;= 0 ) <span class="comment">/* it returns number of chars in line */</span>
00124            {
00125            <span class="comment">/* skip this line if it doesn't start with EVENT */</span>
00126            <span class="comment">/*** MULTI-THREAD WARNING: strtok is not safe (but it is ubiquitus) ***/</span>
00127            <span class="keywordflow">if</span> ( strcmp( strtok( line, terminators), <span class="stringliteral">"EVENT"</span> ) != 0) <span class="keywordflow">continue</span>;
00128 
00129            <span class="comment">/* on this line, find "ID:" which is followed by the event id string */</span>
00130            <span class="keywordflow">while</span> ( (nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators)) != NULL ) <span class="comment">/* over tokens on this line */</span>
00131                 {
00132                 <span class="keywordflow">if</span> ( strcmp( nxttok, <span class="stringliteral">"ID:"</span> ) != 0) <span class="keywordflow">continue</span>;
00133                 nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* this had better be the event id */</span>
00134                 <span class="keywordflow">if</span> (nxttok == NULL) <span class="comment">/* oops - there was nothing after ID: */</span>
00135                    {
00136                    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00137                                <span class="stringliteral">" Cant find EVENT ID in:\n.%s.\n"</span>, line);
00138                    <span class="keywordflow">break</span>;
00139                    }
00140                 strncpy(pSnp-&gt;<a class="code" href="structSNIPPET.html#m2">eventId</a>, nxttok, EVENTID_SIZE);
00141                 pSnp-&gt;<a class="code" href="structSNIPPET.html#m2">eventId</a>[<a class="code" href="earthworm__defs_8h.html#a18">EVENTID_SIZE</a>-1] = <span class="charliteral">'\0'</span>;           <span class="comment">/* Ensure null termination */</span>
00142 
00143                 <span class="comment">/* Now search for author id */</span>
00144                 nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* this had better be "AUTHOR:" */</span>
00145                 <span class="keywordflow">if</span> ( strcmp( nxttok, <span class="stringliteral">"AUTHOR:"</span> ) != 0) 
00146                    {
00147                    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00148                                <span class="stringliteral">" Cant find AUTHOR:\n.%s.\n"</span>, line);
00149                    <span class="keywordflow">break</span>;
00150                    }
00151                 nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* this had better be author's name */</span>
00152                 strncpy(pSnp-&gt;<a class="code" href="structSNIPPET.html#m0">author</a>, nxttok, AUTHOR_FIELD_SIZE);
00153                 pSnp-&gt;<a class="code" href="structSNIPPET.html#m0">author</a>[<a class="code" href="earthworm__defs_8h.html#a17">AUTHOR_FIELD_SIZE</a>-1] = <span class="charliteral">'\0'</span>;           <span class="comment">/* Ensure null termination */</span>
00154 
00155                 <span class="comment">/* Now search for optional subnet */</span>
00156                 nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* this might be "SUBNET:" */</span>
00157                 <span class="keywordflow">if</span>(nxttok == NULL)
00158                         {
00159                         pSnp-&gt;<a class="code" href="structSNIPPET.html#m1">subnet</a>[0] = <span class="charliteral">'\0'</span>;
00160                         startFresh = 0;
00161                         <span class="keywordflow">goto</span> GotNextEvent;
00162                         }
00163                 <span class="keywordflow">if</span> ( strcmp( nxttok, <span class="stringliteral">"SUBNET:"</span> ) != 0) 
00164                    {
00165                         pSnp-&gt;<a class="code" href="structSNIPPET.html#m1">subnet</a>[0] = <span class="charliteral">'\0'</span>;
00166                         startFresh = 0; <span class="comment">/* SUBNET is optional; we're happy with the titile line. Ready for rest of message */</span>
00167                         <span class="keywordflow">goto</span> GotNextEvent;
00168                    }
00169                 nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* this had better be subnet name */</span>
00170                 <span class="keywordflow">if</span>(nxttok != NULL) strncpy(pSnp-&gt;<a class="code" href="structSNIPPET.html#m1">subnet</a>, nxttok, MAX_SUBNET_LEN); <span class="comment">/* as per Pete: if there's</span>
00171 <span class="comment">                                                nothing there, nxttok will be NULL, which is on Solaris fatal for strncpy */</span>
00172                 pSnp-&gt;<a class="code" href="structSNIPPET.html#m1">subnet</a>[<a class="code" href="earthworm__defs_8h.html#a19">MAX_SUBNET_LEN</a>-1] = <span class="charliteral">'\0'</span>;           <span class="comment">/* Ensure null termination */</span>
00173 
00174                 startFresh = 0; <span class="comment">/* we're happy with the titile line. Ready for rest of message */</span>
00175                 <span class="keywordflow">goto</span> GotNextEvent;
00176                 }       <span class="comment">/* end of loop over tokens in this line */</span>
00177            }            <span class="comment">/* end of loop over lines in message */</span>
00178            <span class="keywordflow">return</span>(EW_FAILURE);  <span class="comment">/* no more lines */</span>
00179         }               <span class="comment">/* end of search for event id */</span>
00180 
00181 
00182 
00183    GotNextEvent:
00184 
00185    <span class="comment">/* So we have an event id. Now parse and return snippet parameters until a blank line</span>
00186 <span class="comment">   *************************************************************************************/</span> 
00187    <a class="code" href="parse__trig_8c.html#a8">getNextLine</a>(nxtLine, line); <span class="comment">/* step over the blank line */</span>
00188    <a class="code" href="parse__trig_8c.html#a8">getNextLine</a>(nxtLine, line); <span class="comment">/* step over the column titles line */</span>
00189    <a class="code" href="parse__trig_8c.html#a8">getNextLine</a>(nxtLine, line); <span class="comment">/* step over the silly dashes line */</span>
00190 
00191    <span class="comment">/* Read the next station line</span>
00192 <span class="comment">   *****************************/</span>
00193    GetNextStation:
00194    <span class="keywordflow">if</span>( <a class="code" href="parse__trig_8c.html#a8">getNextLine</a>(nxtLine, line) &lt;= 0 ) <span class="comment">/* this should be a station trigger line */</span>
00195         {
00196         <span class="keywordflow">return</span>(EW_FAILURE);     <span class="comment">/* no more lines */</span>
00197         }
00198    <span class="keywordflow">if</span> ( ( nxttok=strtok(line, terminators) ) == NULL ) <span class="comment">/* first token should be station name */</span>
00199         {
00200         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"parse_trig: Bad syntax in trigger message:"</span>
00201                    <span class="stringliteral">"Strange station line - no tokens in: \n.&amp;s.\n"</span>,line);
00202         <span class="keywordflow">goto</span> GetNextEvent;
00203         }
00204 
00205    <span class="comment">/* Find SCN names</span>
00206 <span class="comment">    ****************/</span>
00207    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - should have been the station name */</span>
00208         {
00209         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00210                     <span class="stringliteral">" Cant find statio name in:\n.%s.\n"</span>, line);
00211         <span class="keywordflow">goto</span> GetNextStation;
00212         }
00213    strncpy( pSnp-&gt;<a class="code" href="structSNIPPET.html#m3">sta</a>, nxttok, 7);      <span class="comment">/* Put away the station name */</span>
00214    pSnp-&gt;<a class="code" href="structSNIPPET.html#m3">sta</a>[6] = <span class="charliteral">'\0'</span>;                 <span class="comment">/* Ensure null termination */</span>
00215 
00216    nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* should be the component */</span>
00217    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - there was nothing after station name */</span>
00218         {
00219         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00220                     <span class="stringliteral">" Cant find comp name in:\n.%s.\n"</span>, line);
00221         <span class="keywordflow">goto</span> GetNextStation;
00222         }
00223    strncpy( pSnp-&gt;<a class="code" href="structSNIPPET.html#m4">chan</a>, nxttok, 9 );    <span class="comment">/* Put away the component */</span>
00224    pSnp-&gt;<a class="code" href="structSNIPPET.html#m4">chan</a>[8] = <span class="charliteral">'\0'</span>;                <span class="comment">/* Ensure null termination */</span>
00225 
00226    nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* should be the net */</span>
00227    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - there was nothing after component name */</span>
00228         {
00229         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00230                     <span class="stringliteral">" Cant find net name in:\n.%s.\n"</span>, line);
00231         <span class="keywordflow">goto</span> GetNextStation;
00232         }
00233    strncpy( pSnp-&gt;<a class="code" href="structSNIPPET.html#m5">net</a>, nxttok, 9 );     <span class="comment">/* put away the net */</span>
00234    pSnp-&gt;<a class="code" href="structSNIPPET.html#m5">net</a>[8] = <span class="charliteral">'\0'</span>;                 <span class="comment">/* Ensure null termination */</span>
00235 
00236    <span class="comment">/* And now, find "save:"  </span>
00237 <span class="comment">   ***********************/</span>
00238    <span class="keywordflow">while</span> ( (nxttok=strtok((<span class="keywordtype">char</span>*)NULL, terminators) ) != NULL )         <span class="comment">/* run down the tokens */</span>
00239         {
00240         <span class="keywordflow">if</span> ( strcmp( nxttok, <span class="stringliteral">"save:"</span> ) == 0 ) <span class="keywordflow">goto</span> FoundSave; <span class="comment">/* looking for 'save:' */</span>
00241         }
00242    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"parse_trig: Bad syntax in trigger message:"</span>
00243            <span class="stringliteral">"Bad station line - no save token found: \n.%s.\n"</span>,line);
00244    <span class="keywordflow">goto</span> GetNextStation;      
00245    FoundSave:
00246                 
00247    <span class="comment">/* now find time strings</span>
00248 <span class="comment">    ***********************/</span>
00249    nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* should be the save start date */</span>
00250    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - there was nothing after save: */</span>
00251         {
00252         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00253                     <span class="stringliteral">" Cant find save date in:\n.%s.\n"</span>, line);
00254         <span class="keywordflow">goto</span> GetNextStation;
00255         }
00256    strcpy( pSnp-&gt;<a class="code" href="structSNIPPET.html#m6">startYYYYMMDD</a>, nxttok );       <span class="comment">/* put away the date string */</span>
00257 
00258    nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* sould be the save start time-of-day */</span>
00259    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - there was nothing after save: */</span>
00260         {
00261         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00262                     <span class="stringliteral">" Cant find save time of day in:\n.%s.\n"</span>, line);
00263         <span class="keywordflow">goto</span> GetNextStation;
00264         }
00265    strcpy( pSnp-&gt;<a class="code" href="structSNIPPET.html#m7">startHHMMSS</a>, nxttok );         <span class="comment">/* put away the time-of-day string */</span>
00266 
00267    <span class="comment">/* Convert start time to double </span>
00268 <span class="comment">    ******************************/</span>
00269    <span class="keywordflow">if</span>( <a class="code" href="parse__trig_8h.html#a3">t_atodbl</a>(pSnp-&gt;<a class="code" href="structSNIPPET.html#m6">startYYYYMMDD</a>, pSnp-&gt;<a class="code" href="structSNIPPET.html#m7">startHHMMSS</a>, &amp;(pSnp-&gt;<a class="code" href="structSNIPPET.html#m9">starttime</a>) ) &lt; 0)
00270         {
00271         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00272                     <span class="stringliteral">" Dont understand start-time in:\n.%s.\n"</span>, line);
00273         <span class="keywordflow">goto</span> GetNextStation;
00274         }
00275    <span class="keywordflow">if</span> ( pSnp-&gt;<a class="code" href="structSNIPPET.html#m9">starttime</a> &lt; <a class="code" href="dave__trig_8c.html#a1">BAD_TIME_VALUE</a> ) <span class="comment">/* unreasonable time value */</span>
00276         {
00277         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00278                     <span class="stringliteral">" Bad start time value in:\n.%s.\n"</span>, line);
00279         <span class="keywordflow">goto</span> GetNextStation;
00280         }
00281 
00282    <span class="comment">/* find duration to save</span>
00283 <span class="comment">    ***********************/</span>
00284    nxttok = strtok( (<span class="keywordtype">char</span>*)NULL, terminators); <span class="comment">/* should be the duration */</span>
00285    <span class="keywordflow">if</span> (nxttok ==NULL) <span class="comment">/* oops - there was nothing after save: */</span>
00286         {
00287         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00288                     <span class="stringliteral">" Cant find duration in:\n.%s.\n"</span>, line);
00289         <span class="keywordflow">goto</span> GetNextStation;
00290         }
00291    pSnp-&gt;<a class="code" href="structSNIPPET.html#m10">duration</a> = atol( nxttok );
00292    <span class="keywordflow">if</span> ( pSnp-&gt;<a class="code" href="structSNIPPET.html#m10">duration</a> &lt;= 0 )
00293         {
00294         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"parse_trig: Bad syntax in trigger message."</span>
00295                     <span class="stringliteral">" Bad duration value in:\n.%s.\n"</span>, line);
00296         <span class="keywordflow">goto</span> GetNextStation;
00297         }
00298 
00299    <span class="keywordflow">return</span>(EW_SUCCESS);
00300 }   
00301 <span class="comment">/* ----------------------------------- end of parseSnippet() -------------------------------------- */</span>
00302 
00303 <span class="comment">/**************************************************************************</span>
00304 <span class="comment"> *    getNextLine(msg, line) moves the next line from 'msg' into 'line    *</span>
00305 <span class="comment"> *                           returns the number of characters in the line *</span>
00306 <span class="comment"> *                           Returns negative if error.                   *</span>
00307 <span class="comment"> **************************************************************************/</span>
<a name="l00308"></a><a class="code" href="dave__trig_8c.html#a8">00308</a> <span class="keywordtype">int</span> <a class="code" href="parse__trig_8c.html#a8">getNextLine</a> ( <span class="keywordtype">char</span>** pNxtLine, <span class="keywordtype">char</span>* line)
00309 {
00310    <span class="keywordtype">int</span> i;
00311    <span class="keywordtype">char</span>* nxtLine;
00312 
00313    nxtLine=*pNxtLine;
00314 
00315    <span class="keywordflow">for</span> (i =0; i&lt; <a class="code" href="dave__trig_8c.html#a0">LINE_LEN</a>; i++)
00316         {
00317         line[i] = *nxtLine++;
00318         <span class="keywordflow">if</span> ( (int)line[i] == 0 )
00319                 {
00320                 <span class="keywordflow">return</span>(-1); <span class="comment">/*  Not good */</span>
00321                 }
00322         <span class="keywordflow">if</span> (line[i] == <span class="charliteral">'\n'</span>) <span class="keywordflow">goto</span> normal;
00323         }
00324    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>,<span class="stringliteral">"getNextLine error: line too long \n"</span>);
00325    <span class="keywordflow">return</span>(-1);
00326 
00327    normal:
00328    line[i+1]=0;
00329    *pNxtLine = nxtLine;
00330    <span class="keywordflow">return</span>(i);
00331    
00332 }
00333 <span class="comment">/* ----------------------------------- end of getNextLine() -------------------------------------- */</span>
00334 
00335 
00336 <span class="comment">/**************************************************************************</span>
00337 <span class="comment"> *    t_atodbl() takes date and time strings, and converts to double      *</span>
00338 <span class="comment"> *               seconds since 1970. Note  that the time of day string    *</span>
00339 <span class="comment"> *               is of the form "hh:mm:ss.ss"                             *</span>
00340 <span class="comment"> *               Returns negative if error.                               *</span>
00341 <span class="comment"> **************************************************************************/</span>
00342 
<a name="l00344"></a><a class="code" href="dave__trig_8c.html#a2">00344</a> <span class="preprocessor">#define TIMESTR_LEN             17      </span><span class="comment">/* whole string */</span>
<a name="l00345"></a><a class="code" href="dave__trig_8c.html#a3">00345</a> <span class="preprocessor">#define YMD_LEN                 8       </span><span class="comment">/* date part: YYYYMMDD */</span>
<a name="l00346"></a><a class="code" href="dave__trig_8c.html#a4">00346</a> <span class="preprocessor">#define HOUR_LEN                2       </span><span class="comment">/* hours from HH:MM:SS.SS */</span>
<a name="l00347"></a><a class="code" href="dave__trig_8c.html#a5">00347</a> <span class="preprocessor">#define MIN_LEN                 2       </span><span class="comment">/* minutes from HH:MM:SS.SS */</span>
<a name="l00348"></a><a class="code" href="dave__trig_8c.html#a6">00348</a> <span class="preprocessor">#define SEC_LEN                 5       </span><span class="comment">/* seconds from HH:MM:SS.SS */</span>
00349 
<a name="l00350"></a><a class="code" href="dave__trig_8c.html#a9">00350</a> <span class="keywordtype">int</span> <a class="code" href="parse__trig_8h.html#a3">t_atodbl</a>(<span class="keywordtype">char</span>* YYYYMMDD, <span class="keywordtype">char</span>* HHMMSS, <span class="keywordtype">double</span>* starttime) 
00351 {
00352    <span class="keywordtype">char</span> timestr[<a class="code" href="dave__trig_8c.html#a2">TIMESTR_LEN</a>+1]; <span class="comment">/* need space for the null-terminator */</span>
00353    <span class="keywordtype">int</span> ret;
00354    <span class="keywordtype">int</span> tgtind, srcind;  <span class="comment">/* indices for copying fields into timestr */</span>
00355 
00356         <span class="comment">/*************************  Y2K  ************************</span>
00357 <span class="comment">         *</span>
00358 <span class="comment">         * All instances of YYMMDD have been changed to YYYYMMDD</span>
00359 <span class="comment">         *</span>
00360 <span class="comment">         *************************  Y2K  ************************/</span>
00361 
00362    <span class="comment">/* we want a string of  the form yyyymmddhhmmss.ss */</span>
00363    <span class="comment">/*                               01234567890123456             */</span>
00364 
00365    tgtind = 0;
00366    srcind = 0;
00367 
00368    <span class="comment">/* Copy in the date */</span>
00369    strcpy(timestr,YYYYMMDD);
00370 
00371    <span class="comment">/* Append the hour */</span>
00372    tgtind = tgtind + <a class="code" href="dave__trig_8c.html#a3">YMD_LEN</a>;
00373    strncpy(&amp;timestr[tgtind], HHMMSS, HOUR_LEN);
00374 
00375    <span class="comment">/* Append the minute */</span>
00376    tgtind = tgtind + <a class="code" href="dave__trig_8c.html#a4">HOUR_LEN</a>;
00377    srcind = srcind + <a class="code" href="dave__trig_8c.html#a4">HOUR_LEN</a> + 1; 
00378    strncpy(&amp;timestr[tgtind] ,&amp;HHMMSS[srcind], MIN_LEN); 
00379 
00380    <span class="comment">/* Append the seconds */</span>
00381    tgtind = tgtind + <a class="code" href="dave__trig_8c.html#a5">MIN_LEN</a>;
00382    srcind = srcind + <a class="code" href="dave__trig_8c.html#a5">MIN_LEN</a> + 1; 
00383    strncpy(&amp;timestr[tgtind], &amp;HHMMSS[srcind], SEC_LEN); 
00384 
00385    <span class="comment">/* Null terminate the string */</span>
00386    tgtind = tgtind + <a class="code" href="dave__trig_8c.html#a6">SEC_LEN</a>;
00387    timestr[tgtind] = <span class="charliteral">'\0'</span>;
00388 
00389 
00390    <span class="comment">/* convert to double seconds */</span>
00391    ret = <a class="code" href="chron3_8c.html#a11">epochsec17</a>(starttime, timestr);
00392    <span class="keywordflow">if</span> (ret &lt; 0)
00393         {
00394         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"t"</span>,<span class="stringliteral">"bad return from epochsec17\n"</span>);
00395         <span class="keywordflow">return</span>(-1);
00396         } 
00397    <span class="keywordflow">return</span>(1);
00398 }
00399 <span class="comment">/* ----------------------------------- end of t_atodbl() ----------------------------------------- */</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:00 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
