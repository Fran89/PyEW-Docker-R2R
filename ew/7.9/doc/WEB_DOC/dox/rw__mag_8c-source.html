<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>rw_mag.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>rw_mag.c</h1><a href="rw__mag_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00003 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *    $Id: rw__mag_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *    Revision history:</span>
00008 <span class="comment"> *     $Log$
00008 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00008 <span class="comment"> *     first inclusion
00008 <span class="comment"> *</span>
00009 <span class="comment"> *     Revision 1.11  2002/06/28 21:03:57  lucky</span>
00010 <span class="comment"> *     Fixed reading of mag phases -- it would not properly read float</span>
00011 <span class="comment"> *     values for amplitude and period</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.10  2001/08/07 16:54:17  lucky</span>
00014 <span class="comment"> *     Pre v6.0 checkin</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *     Revision 1.9  2001/06/07 20:51:49  lucky</span>
00017 <span class="comment"> *     Modified wr_mag so that it checks for NULL strings. Before, if qid was null,</span>
00018 <span class="comment"> *     wr_mag would produce an invalid TYPE_MAGNITUDE message which could not</span>
00019 <span class="comment"> *     be parsed by rd_mag. This is not good, given that the qid is not known</span>
00020 <span class="comment"> *     in the review system.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> *     Revision 1.8  2001/06/07 19:48:28  lucky</span>
00023 <span class="comment"> *     rd_chan_mag_lucky renamed to rd_chan_mag. The old rd_chan_mag is still</span>
00024 <span class="comment"> *     available as rd_chan_mag_Pete.</span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> *     Revision 1.7  2001/05/31 21:09:02  lucky</span>
00027 <span class="comment"> *     Addedd rd_chan_mag_lucky; I don't think that rd_chan_mag in its original form</span>
00028 <span class="comment"> *     works. There are numerical comparisons of pointers, and other visible problems.</span>
00029 <span class="comment"> *</span>
00030 <span class="comment"> *     Revision 1.6  2001/05/26 21:04:59  lombard</span>
00031 <span class="comment"> *     Changed ML_INFO struct to MAG_CHAN_INFO struct to make it more</span>
00032 <span class="comment"> *     generic; now this struct should work with most mag types.</span>
00033 <span class="comment"> *     Fixed a number of obvious bugs and cleaned up the code.</span>
00034 <span class="comment"> *     But the parsers still have not been tested and this may not work.</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> *     Revision 1.5  2001/05/02 20:58:45  alex</span>
00037 <span class="comment"> *     *** empty log message ***</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> *     Revision 1.4  2001/05/01 22:38:48  davidk</span>
00040 <span class="comment"> *     moved the MagNames table out of the header file and into rw_mag.c</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> *     Revision 1.3  2001/05/01 20:26:02  davidk</span>
00043 <span class="comment"> *     Modified several new functions added by Alex, so that they compile and do not impede the</span>
00044 <span class="comment"> *     release.  The new functions have been added, but have not properly been tested and debugged,</span>
00045 <span class="comment"> *     at all.</span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> *     Revision 1.2  2001/04/29 00:15:29  alex</span>
00048 <span class="comment"> *     Alex: changes for mag type int and string, and added alternate parsing routines.</span>
00049 <span class="comment"> *</span>
00050 <span class="comment"> *     Revision 1.1  2001/03/31 00:44:58  lombard</span>
00051 <span class="comment"> *     Initial revision</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> *</span>
00055 <span class="comment"> */</span>
00056 
00057 <span class="comment">/* rw_mag.c</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> * Contains functions in that convert from a</span>
00060 <span class="comment"> * TYPE_MAGNITUDE message to a structure and visa versa.</span>
00061 <span class="comment"> *</span>
00062 <span class="comment"> * written by Pete Lombard   February, 2001</span>
00063 <span class="comment"> */</span>
00064 
00065 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00066 <span class="preprocessor">#include &lt;string.h&gt;</span>
00067 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00068 <span class="preprocessor">#include &lt;<a class="code" href="rw__mag_8h.html">rw_mag.h</a>&gt;</span>
00069 
00070 <span class="comment">/* Internal Function Prototypes */</span>
00071 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( <span class="keywordtype">char</span> *s1, <span class="keywordtype">int</span> s1max, <span class="keywordtype">char</span> *s2 );
00072 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( <span class="keywordtype">char</span> *begtok, <span class="keywordtype">char</span> c );
00073 
00074 <span class="comment">/********************************************************************</span>
00075 <span class="comment"> * rd_mag()                                                         *</span>
00076 <span class="comment"> * Reads an ascii TYPE_MAGNITUDE message and fills in a MAG_INFO    *</span>
00077 <span class="comment"> * structure which must be allocated by the caller                  *</span>
00078 <span class="comment"> * If, in addition, the caller allocates space for auxiliary        *</span>
00079 <span class="comment"> * structures at pMag-&gt;pMagAux (number of bytes in pMag-&gt;size_aux), *</span>
00080 <span class="comment"> * then rd_mag will call the appropriate function to decode the     *</span>
00081 <span class="comment"> * remainder of the message into appropriate structures.            *</span>
00082 <span class="comment"> * Currently supported magnitude types are: Ml                      *</span>
00083 <span class="comment"> * Returns 0 on success                                             *</span>
00084 <span class="comment"> *        -1 on parsing errors                                      *</span>
00085 <span class="comment"> *        -2 on insufficient space in pMagAux                       *</span>
00086 <span class="comment"> ********************************************************************/</span>
<a name="l00087"></a><a class="code" href="rw__mag_8c.html#a2">00087</a> <span class="keywordtype">int</span> <a class="code" href="rw__mag_8c.html#a2">rd_mag</a>( <span class="keywordtype">char</span> *msg, <span class="keywordtype">int</span> msgLen, <a class="code" href="struct__MAG__INFO.html">MAG_INFO</a> *pMag)
00088 {
00089   size_t size_aux;
00090   <span class="keywordtype">char</span> *pMagAux;
00091 
00092   size_aux = pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m16">size_aux</a>;
00093   pMagAux = (<span class="keywordtype">char</span> *)pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a>;
00094   memset(pMag, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__MAG__INFO.html">MAG_INFO</a>));
00095 
00096   <span class="keywordflow">switch</span> ( sscanf( msg
00097                  , <span class="stringliteral">"%s MAG %d %s %lf %s %d %d %lf %lf %lf %d %s %d %d"</span>
00098                  ,  pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m7">qid</a>
00099                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m11">imagtype</a>
00100                  ,  pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m12">szmagtype</a>
00101                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m0">mag</a>
00102                  ,  pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m13">algorithm</a>
00103                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m5">nstations</a>
00104                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m6">nchannels</a>
00105                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m1">error</a>
00106                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m2">quality</a>
00107                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m3">mindist</a>
00108                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m4">azimuth</a>
00109                  ,  pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m8">qauthor</a>
00110                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m9">origin_version</a>
00111                  , &amp;pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m10">qdds_version</a>
00112          )       )
00113   {
00114     <span class="keywordflow">case</span> 12:  <span class="comment">/* old-style, no origin version, qdds version numbers */</span>
00115          pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m9">origin_version</a> = 0;
00116          pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m10">qdds_version</a> = 0;
00117          <span class="keywordflow">break</span>;
00118     <span class="keywordflow">case</span> 13:  <span class="comment">/* new-style, with origin version, no qdds version */</span>
00119          pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m10">qdds_version</a> = 0;
00120          <span class="keywordflow">break</span>;
00121     <span class="keywordflow">case</span> 14:  <span class="comment">/* new-style, with both number */</span>
00122          <span class="keywordflow">break</span>;
00123     <span class="keywordflow">default</span>:
00124          <span class="keywordflow">return</span>( -1 );
00125   }
00126   
00127   <span class="keywordflow">if</span> (pMagAux &amp;&amp; size_aux &gt; 0)
00128   {
00129     pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m16">size_aux</a> = size_aux;
00130     pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a> = pMagAux;
00131     
00132     <span class="comment">/* Read the rest of a Mag message */</span>
00133     <span class="keywordflow">if</span> (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a> != NULL)
00134         {
00135          <span class="keywordflow">return</span>( <a class="code" href="rw__mag_8c.html#a3">rd_chan_mag</a>(msg, msgLen, (<a class="code" href="struct__MAG__CHAN__INFO.html">MAG_CHAN_INFO</a> *)pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a>,
00136                           pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m16">size_aux</a>) );
00137         }
00138   }
00139   
00140   <span class="keywordflow">return</span>( 0 );
00141 }
00142 
00143 <span class="comment">/*****************************************************************</span>
00144 <span class="comment"> * rd_chan_mag()                                                 *</span>
00145 <span class="comment"> * Reads an ascii TYPE_MAGNITUDE Ml message and fills in         *</span>
00146 <span class="comment"> * MAG_CHAN_INFO structures.                                     *</span>
00147 <span class="comment"> * This function can be called by rd_mag if sufficient space is  *</span>
00148 <span class="comment"> * allocated by its caller. Or it may be called after rd_mag     *</span>
00149 <span class="comment"> * when the caller has allocated space for `nchannels' of        *</span>
00150 <span class="comment"> * MAG_CHAN_INFO structures.                                     *</span>
00151 <span class="comment"> * Returns 0 on success                                          *</span>
00152 <span class="comment"> *        -1 on parsing errors                                   *</span>
00153 <span class="comment"> *        -2 on insufficient space in pMagAux                    *</span>
00154 <span class="comment"> *****************************************************************/</span>
<a name="l00155"></a><a class="code" href="rw__mag_8c.html#a3">00155</a> <span class="keywordtype">int</span> <a class="code" href="rw__mag_8c.html#a3">rd_chan_mag</a> ( <span class="keywordtype">char</span> *msg, <span class="keywordtype">int</span> msglen, <a class="code" href="struct__MAG__CHAN__INFO.html">MAG_CHAN_INFO</a> *pMci, <span class="keywordtype">int</span> size_ml)
00156 {
00157   <span class="keywordtype">char</span>     *line;
00158   <span class="keywordtype">char</span>     *begtok;
00159   <span class="keywordtype">char</span>     *tmpMsg;     <span class="comment">/* local copy of msg */</span>
00160   <span class="keywordtype">int</span>       len;       <span class="comment">/* length (bytes) of the next token */</span>
00161   <span class="keywordtype">int</span>       nchan;     <span class="comment">/* number of channels read from msg so far */</span>
00162   <span class="keywordtype">int</span>       nML;       <span class="comment">/* number of MAG_CHAN_INFO structures we can use */</span>
00163   <span class="keywordtype">int</span>       rc;
00164   <span class="keywordtype">int</span>           index;
00165   
00166   memset(pMci, 0, size_ml);
00167   nML = size_ml / <span class="keyword">sizeof</span>(MAG_CHAN_INFO);
00168 
00169   tmpMsg = (<span class="keywordtype">char</span> *) malloc (msglen);
00170   strcpy (tmpMsg, msg);
00171 
00172   nchan = 0;
00173 
00174   <span class="comment">/* Skip the first line */</span>
00175   len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a> (tmpMsg, <span class="charliteral">'\n'</span>); 
00176 
00177   index = len + 1;
00178 
00179   <span class="comment">/* Read next line from the message into working buffer */</span>
00180   <span class="keywordflow">while</span>(index &lt; (msglen-1))
00181   {
00182         <span class="comment">/* Process next line */</span>
00183         line = tmpMsg + index;
00184     len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>(line, <span class="charliteral">'\n'</span> ); 
00185         line[len] = <span class="charliteral">'\0'</span>;
00186     index = index + len + 1;
00187 
00188     begtok = line;
00189     <span class="keywordflow">while</span>( begtok[0] == <span class="charliteral">' '</span> &amp;&amp; begtok[0] != <span class="charliteral">'\0'</span>) begtok++;    <span class="comment">/* go to 1st non-blank char */</span>
00190     <span class="keywordflow">if</span>( begtok[0] == <span class="charliteral">'\0'</span> ) <span class="keywordflow">return</span>( -1 );
00191     len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'.'</span> );
00192     <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a1">TRACE_STA_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00193     strncpy( pMci[nchan].sta, begtok, len );
00194         pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m0">sta</a>[len] = <span class="charliteral">'\0'</span>;
00195     begtok += len + 1;
00196 
00197     len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'.'</span> );
00198     <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a2">TRACE_CHAN_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00199     strncpy( pMci[nchan].comp, begtok, len );
00200         pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m1">comp</a>[len] = <span class="charliteral">'\0'</span>;
00201     begtok += len + 1;
00202 
00203     len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">' '</span> );
00204     <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a3">TRACE_NET_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00205     strncpy( pMci[nchan].net, begtok, len );
00206         pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m2">net</a>[len] = <span class="charliteral">'\0'</span>;
00207     begtok += len + 1;
00208 
00209     <span class="keywordflow">while</span>( begtok[0] == <span class="charliteral">' '</span> &amp;&amp; begtok[0] != <span class="charliteral">'\0'</span> ) begtok++;    <span class="comment">/* go to next non-blank char */</span>
00210     <span class="keywordflow">if</span> ( (rc = sscanf(begtok, <span class="stringliteral">"%lf %lf %lf %E %lf %f %E %lf %f"</span>,
00211                       &amp;(pMci[nchan].mag), &amp;(pMci[nchan].dist), &amp;(pMci[nchan].corr),
00212                       &amp;(pMci[nchan].Amp1), &amp;(pMci[nchan].Time1), &amp;(pMci[nchan].Period1),
00213                       &amp;(pMci[nchan].Amp2), &amp;(pMci[nchan].Time2), 
00214                       &amp;(pMci[nchan].Period2))) != 9)
00215     {
00216       <span class="keywordflow">if</span> (rc == 6)
00217       {
00218         pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m10">Amp2</a> = pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m9">Time2</a> = pMci[nchan].<a class="code" href="struct__MAG__CHAN__INFO.html#m11">Period2</a> = -1.0;
00219         <span class="keywordflow">continue</span>;
00220       }
00221       <span class="keywordflow">return</span>( -1 );
00222     }
00223 
00224     nchan = nchan + 1;
00225 
00226   }
00227 
00228   <span class="keywordflow">return</span> 0;
00229 }
00230 
00231 
00232 
00233 <span class="comment">/*******************************************************************</span>
00234 <span class="comment"> * wr_mag()                                                        *</span>
00235 <span class="comment"> * Reads a MAG_INFO structure and writes an ascii TYPE_MAGNITUDE   *</span>
00236 <span class="comment"> * message (null terminated)                                       *</span>
00237 <span class="comment"> * Returns 0 on success, -1 on failure (potential buffer overflow) *</span>
00238 <span class="comment"> *******************************************************************/</span>
<a name="l00239"></a><a class="code" href="rw__mag_8c.html#a4">00239</a> <span class="keywordtype">int</span> <a class="code" href="rw__mag_8c.html#a4">wr_mag</a>( <a class="code" href="struct__MAG__INFO.html">MAG_INFO</a> *pMag, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen )
00240 {
00241   <span class="keywordtype">char</span>     tmp[256]; <span class="comment">/* working buffer */</span>
00242   <span class="keywordtype">char</span>     qid[256]; 
00243   <span class="keywordtype">char</span>     szmagtype[256]; 
00244   <span class="keywordtype">char</span>     algorithm[256]; 
00245   <span class="keywordtype">char</span>     qauthor[256]; 
00246 
00247   memset( buf, 0, (size_t)buflen );    <span class="comment">/* zero output buffer */</span>
00248 
00249   <span class="comment">/* </span>
00250 <span class="comment">   * We should check for null strings, if for nothing else than to </span>
00251 <span class="comment">   * avoid mis-formatted message trickling down the system. LV 6/2001</span>
00252 <span class="comment">   */</span>
00253         <span class="keywordflow">if</span> (strlen (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m7">qid</a>) == 0)
00254                 strcpy (qid, <span class="stringliteral">"UNKNOWN"</span>);
00255         <span class="keywordflow">else</span>
00256                 strcpy (qid, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m7">qid</a>);
00257  
00258         <span class="keywordflow">if</span> (strlen (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m12">szmagtype</a>) == 0)
00259                 strcpy (szmagtype, <span class="stringliteral">"UNKNOWN"</span>);
00260         <span class="keywordflow">else</span>
00261                 strcpy (szmagtype, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m12">szmagtype</a>);
00262  
00263         <span class="keywordflow">if</span> (strlen (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m13">algorithm</a>) == 0)
00264                 strcpy (algorithm, <span class="stringliteral">"UNKNOWN"</span>);
00265         <span class="keywordflow">else</span>
00266                 strcpy (algorithm, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m13">algorithm</a>);
00267  
00268         <span class="keywordflow">if</span> (strlen (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m8">qauthor</a>) == 0)
00269                 strcpy (qauthor, <span class="stringliteral">"UNKNOWN"</span>);
00270         <span class="keywordflow">else</span>
00271                 strcpy (qauthor, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m8">qauthor</a>);
00272  
00273   sprintf(tmp, <span class="stringliteral">"%s MAG %d %s %0.2f %s %d %d %0.2f %0.2f %0.2f %d %s %d %d\n"</span>,
00274           qid, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m11">imagtype</a>, szmagtype, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m0">mag</a>, algorithm, 
00275           pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m5">nstations</a>, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m6">nchannels</a>, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m1">error</a>, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m2">quality</a>,
00276           pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m3">mindist</a>, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m4">azimuth</a>, qauthor, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m9">origin_version</a>
00277           , pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m10">qdds_version</a>
00278           );
00279    
00280   <span class="keywordflow">if</span> ( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00281    
00282   <span class="keywordflow">if</span> (pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a> != NULL)
00283   {
00284       <span class="keywordflow">return</span>( <a class="code" href="rw__mag_8c.html#a5">wr_chan_mag</a>( (<a class="code" href="struct__MAG__CHAN__INFO.html">MAG_CHAN_INFO</a> *)pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m15">pMagAux</a>, pMag-&gt;<a class="code" href="struct__MAG__INFO.html#m6">nchannels</a>, 
00285                            buf, buflen) );
00286   }
00287    
00288   <span class="keywordflow">return</span>( 0 );
00289 }
00290 
00291 <span class="comment">/*******************************************************************</span>
00292 <span class="comment"> * wr_chan_mag()                                                   *</span>
00293 <span class="comment"> * Reads MAG_CHAN_INFO structures and appends to an ascii          *</span>
00294 <span class="comment"> * TYPE_MAGNITUDE message (null terminated)                        *</span>
00295 <span class="comment"> * Normally this would be called by wr_mag().                      *</span>
00296 <span class="comment"> * Returns 0 on success, -1 on failure (potential buffer overflow) *</span>
00297 <span class="comment"> *******************************************************************/</span>
<a name="l00298"></a><a class="code" href="rw__mag_8c.html#a5">00298</a> <span class="keywordtype">int</span> <a class="code" href="rw__mag_8c.html#a5">wr_chan_mag</a>( <a class="code" href="struct__MAG__CHAN__INFO.html">MAG_CHAN_INFO</a> *pMci, <span class="keywordtype">int</span> nchannels, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen )
00299 {
00300   <span class="keywordtype">int</span> i;
00301   <span class="keywordtype">char</span> line[256];
00302   
00303   <span class="keywordflow">for</span> (i = 0; i &lt; nchannels; i++)
00304   {
00305     sprintf(line, 
00306             <span class="stringliteral">"%s.%s.%s %.2f %.2f %.2f %9.2E %9.2f %9.2f %9.2E %9.2f %9.2f\n"</span>,
00307             <span class="comment">/*s  c  n mag  dist corr Amp1 Time1 Period1 Amp2 Time2 Period2 */</span>
00308             pMci[i].sta, pMci[i].comp, pMci[i].net, 
00309                         pMci[i].mag, pMci[i].dist, pMci[i].corr, 
00310             pMci[i].Amp1,
00311             ( (pMci[i].Time1 &lt; 0.0) ? -1.0 : pMci[i].Time1),
00312             ( (pMci[i].Period1 &lt; 0.0) ? -1.0 : pMci[i].Period1),
00313             pMci[i].Amp2,
00314             ( (pMci[i].Time2 &lt; 0.0) ? -1.0 : pMci[i].Time2),
00315             ( (pMci[i].Period2 &lt; 0.0) ? -1.0 : pMci[i].Period2));
00316     
00317       <span class="keywordflow">if</span> ( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>(buf, buflen, line))
00318         <span class="keywordflow">return</span>( -1 );
00319   }
00320   <span class="keywordflow">return</span>( 0 );
00321 }
00322 
00323  
00324 <span class="comment">/********************************************************************</span>
00325 <span class="comment"> * strappend() append second null-terminated character string to    *</span>
00326 <span class="comment"> * the first as long as there's enough room in the target buffer    * </span>
00327 <span class="comment"> * for both strings an the null-byte                                *</span>
00328 <span class="comment"> ********************************************************************/</span>
<a name="l00329"></a><a class="code" href="rw__mag_8c.html#a0">00329</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( <span class="keywordtype">char</span> *s1, <span class="keywordtype">int</span> s1max, <span class="keywordtype">char</span> *s2 )
00330 {
00331   <span class="keywordflow">if</span>( (int)strlen(s1)+(int)strlen(s2)+1 &gt; s1max ) <span class="keywordflow">return</span>( -1 );
00332   strcat( s1, s2 );
00333   <span class="keywordflow">return</span>( 0 );
00334 }
00335 
00336 <span class="comment">/********************************************************************</span>
00337 <span class="comment"> * tokenlength() given a null-terminated character string and a     *</span>
00338 <span class="comment"> * character that delimits the end of a token, tokenlength returns  * </span>
00339 <span class="comment"> * the length (in bytes) of the next token. If the character wasn't * </span>
00340 <span class="comment"> * found, tokenlength returns the length of the string.             *</span>
00341 <span class="comment"> ********************************************************************/</span>
<a name="l00342"></a><a class="code" href="rw__mag_8c.html#a1">00342</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( <span class="keywordtype">char</span> *begtok, <span class="keywordtype">char</span> c )
00343 {
00344   <span class="keywordtype">char</span>    *endtok;   <span class="comment">/* points to the end of this token */</span>
00345 
00346   endtok = strchr( begtok, c );
00347   <span class="keywordflow">if</span>( endtok == NULL ) <span class="keywordflow">return</span>( (int)strlen(begtok) );
00348   <span class="keywordflow">return</span>( (int)(endtok-begtok) );
00349 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:08 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
