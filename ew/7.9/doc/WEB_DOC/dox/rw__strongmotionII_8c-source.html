<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>rw_strongmotionII.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>rw_strongmotionII.c</h1><a href="rw__strongmotionII_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00003 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *    $Id: rw__strongmotionII_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *    Revision history:</span>
00008 <span class="comment"> *     $Log$
00008 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00008 <span class="comment"> *     first inclusion
00008 <span class="comment"> *</span>
00009 <span class="comment"> *     Revision 1.3  2001/06/19 17:26:02  dietz</span>
00010 <span class="comment"> *     Fixed wr_strongmotionII to print SM_NULL values properly (it had been</span>
00011 <span class="comment"> *     taking the absolute value of them by mistake)</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.2  2001/04/18 17:56:27  dietz</span>
00014 <span class="comment"> *     wr_strongmotionII: made sure pga,pgv,pgd are written as absolute values</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *     Revision 1.1  2001/04/17 17:25:46  davidk</span>
00017 <span class="comment"> *     Initial revision</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="comment">/* rw_strongmotionII.c</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> * Contains functions in that convert from a</span>
00026 <span class="comment"> * TYPE_STRONGMOTION message to a structure and visa versa.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> * written by Lynn Dietz   October, 1999</span>
00029 <span class="comment"> */</span>
00030 
00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
00033 <span class="preprocessor">#include &lt;time.h&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="chron3_8h.html">chron3.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="time__ew_8h.html">time_ew.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="rw__strongmotionII_8h.html">rw_strongmotionII.h</a>&gt;</span>
00037 
<a name="l00038"></a><a class="code" href="rw__strongmotionII_8c.html#a0">00038</a> <span class="preprocessor">#define ABS(X) (((X) &gt;= 0) ? (X) : -(X))</span>
00039 <span class="preprocessor"></span>
00040 <span class="keywordtype">void</span> <a class="code" href="logit_8c.html#a18">logit</a>( <span class="keywordtype">char</span> *, <span class="keywordtype">char</span> *, ... );   <span class="comment">/* logit.c      sys-independent  */</span>
00041 <span class="keyword">static</span> <span class="keywordtype">int</span>   <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( <span class="keywordtype">char</span> *s1, <span class="keywordtype">int</span> s1max, <span class="keywordtype">char</span> *s2 );
00042 <span class="keyword">static</span> <span class="keywordtype">int</span>   <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( <span class="keywordtype">char</span> *begtok, <span class="keywordtype">char</span> c );
00043 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( <span class="keywordtype">double</span> t, <span class="keywordtype">char</span> *pbuf, <span class="keywordtype">int</span> len );
00044 <span class="keyword">static</span> <span class="keywordtype">int</span>   <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen, <span class="keywordtype">double</span> t );
00045 
<a name="l00046"></a><a class="code" href="rw__strongmotionII_8c.html#a1">00046</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rw__strongmotionII_8c.html#a1">sNullDate</a> = <span class="stringliteral">"0000/00/00 00:00:00.000"</span>;
<a name="l00047"></a><a class="code" href="rw__strongmotionII_8c.html#a2">00047</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rw__strongmotionII_8c.html#a2">sUnknown</a>  = <span class="stringliteral">"?"</span>;
00048 
00049 <span class="comment">/********************************************************************</span>
00050 <span class="comment"> * rd_strongmotionII()                                              *</span>
00051 <span class="comment"> * Reads an ascii TYPE_STRONGMOTION2 message and fills in a SM_INFO *</span>
00052 <span class="comment"> * structure.                                                       *</span>
00053 <span class="comment"> * Returns 0 on success, -1 on failure                              *</span>
00054 <span class="comment"> ********************************************************************/</span>
<a name="l00055"></a><a class="code" href="rw__strongmotionII_8c.html#a8">00055</a> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a8">rd_strongmotionII</a>( <span class="keywordtype">char</span> *msg, <span class="keywordtype">int</span> msglen, <a class="code" href="struct__SM__INFO.html">SM_INFO</a> *sm )
00056 {
00057    <span class="keywordtype">char</span>     *line;      <span class="comment">/* pointer to current line in msg */</span>
00058    <span class="keywordtype">char</span>     *nextline;  <span class="comment">/* working pointer into msg */</span>
00059    <span class="keywordtype">char</span>     *begtok;    <span class="comment">/* points to the beginning of this token */</span>
00060    <span class="keywordtype">char</span>     *endline;   <span class="comment">/* points at end of line */</span>
00061    <span class="keywordtype">int</span>       len;       <span class="comment">/* length (bytes) of the next token */</span>
00062    <span class="keywordtype">int</span>       nline;     <span class="comment">/* number of lines read from msg so far */</span>
00063    <span class="keywordtype">int</span>       nfreq;
00064    <span class="keywordtype">int</span>       i;
00065    <span class="keyword">struct </span>tm stm;       <span class="comment">/* time structure for timestamp */</span>
00066    time_t    tsec;      <span class="comment">/* timestamp in whole sec since 1970 */</span>    
00067    <span class="keywordtype">int</span>       msec;      <span class="comment">/* thousandths of seconds field of timestamp */</span>
00068 
00069 
00070    memset( sm, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__SM__INFO.html">SM_INFO</a>) );     <span class="comment">/* zero output structure */</span>
00071    nextline = msg;
00072    nline = 0;
00073    nfreq = 0;
00074 
00075 
00076 <span class="comment">/* Read next line from the message into working buffer */</span>
00077    <span class="keywordflow">while</span>( nextline &lt; (msg+msglen-1) )
00078    {
00079      line    = nextline;
00080      len     = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( line, <span class="charliteral">'\n'</span> ); 
00081      endline = line + len;
00082      nline++;
00083      nextline += len + 1;
00084 
00085  <span class="comment">/* First line = SCNL name */</span>
00086      <span class="keywordflow">if</span>( nline == 1 )
00087      {
00088        <span class="keywordflow">if</span>( strncmp(line,<span class="stringliteral">"SCNL:"</span>, 5) != 0 ) <span class="keywordflow">return</span>( -1 );
00089        begtok = line + 5;
00090 
00091        <span class="keywordflow">while</span>( begtok[0] == <span class="charliteral">' '</span> ) begtok++;    <span class="comment">/* go to 1st non-blank char */</span>
00092        <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00093        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'.'</span> );
00094        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a1">TRACE_STA_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00095        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m0">sta</a>, begtok, len ); 
00096        begtok += len + 1;
00097 
00098        <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00099        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'.'</span> );
00100        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a2">TRACE_CHAN_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00101        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m1">comp</a>, begtok, len ); 
00102        begtok += len + 1;
00103 
00104        <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00105        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'.'</span> );
00106        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a3">TRACE_NET_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00107        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m2">net</a>, begtok, len ); 
00108        begtok += len + 1;
00109 
00110        <span class="keywordflow">if</span>( begtok &gt; endline ) <span class="keywordflow">return</span>( -1 );
00111        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'\n'</span> );
00112        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="trace__buf_8h.html#a4">TRACE_LOC_LEN</a> ) <span class="keywordflow">return</span>( -1 );
00113        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m3">loc</a>, begtok, len ); 
00114      }
00115 
00116   <span class="comment">/* Second line = timestamp from field unit */</span>
00117      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 2 )
00118      {
00119        memset( &amp;stm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm) ); <span class="comment">/* zero the time structure */</span>
00120        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"TIME: %d/%d/%d %d:%d:%d.%d"</span>, 
00121                   &amp;stm.tm_year, &amp;stm.tm_mon, &amp;stm.tm_mday, &amp;stm.tm_hour,
00122                   &amp;stm.tm_min, &amp;stm.tm_sec, &amp;msec ) != 7 ) <span class="keywordflow">return</span>( -1 );
00123        stm.tm_year -= 1900;  <span class="comment">/* to convert to definition of struct tm */</span>
00124        stm.tm_mon  -= 1;     <span class="comment">/* to convert to definition of struct tm */</span>
00125        tsec  = <a class="code" href="chron3_8c.html#a12">timegm</a>( &amp;stm );
00126        sm-&gt;<a class="code" href="struct__SM__INFO.html#m6">t</a> = (double)tsec + 0.001*(double)msec;
00127      }
00128 
00129   <span class="comment">/* Third line = alternate timestamp and its code */</span>
00130      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 3 )
00131      {
00132        memset( &amp;stm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm) ); <span class="comment">/* zero the time structure */</span>
00133        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"ALT: %d/%d/%d %d:%d:%d.%d CODE: %d"</span>, 
00134                   &amp;stm.tm_year, &amp;stm.tm_mon, &amp;stm.tm_mday, &amp;stm.tm_hour,
00135                   &amp;stm.tm_min, &amp;stm.tm_sec, &amp;msec, &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m8">altcode</a>) ) != 8 ) 
00136                   <span class="keywordflow">return</span>( -1 );
00137        <span class="keywordflow">if</span>( stm.tm_year == 0 ) {
00138          sm-&gt;<a class="code" href="struct__SM__INFO.html#m7">talt</a> = 0.0;
00139        } <span class="keywordflow">else</span> {
00140          stm.tm_year -= 1900;  <span class="comment">/* to convert to definition of struct tm */</span>
00141          stm.tm_mon  -= 1;     <span class="comment">/* to convert to definition of struct tm */</span>
00142          tsec  = <a class="code" href="chron3_8c.html#a12">timegm</a>( &amp;stm );
00143          sm-&gt;<a class="code" href="struct__SM__INFO.html#m7">talt</a> = (double)tsec + 0.001*(double)msec;
00144        }
00145      }
00146 
00147   <span class="comment">/* Fourth line = peak acceleration values */</span>
00148      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 4 )
00149      {
00150        memset( &amp;stm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm) ); <span class="comment">/* zero the time structure */</span>
00151        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"PGA: %lf TPGA: %d/%d/%d %d:%d:%d.%d"</span>, 
00152                   &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m9">pga</a>), &amp;stm.tm_year, &amp;stm.tm_mon, &amp;stm.tm_mday,
00153                   &amp;stm.tm_hour, &amp;stm.tm_min, &amp;stm.tm_sec, &amp;msec ) != 8 ) 
00154                   <span class="keywordflow">return</span>( -1 );
00155        <span class="keywordflow">if</span>( stm.tm_year == 0 ) {
00156          sm-&gt;<a class="code" href="struct__SM__INFO.html#m10">tpga</a> = 0.0;
00157        } <span class="keywordflow">else</span> {
00158          stm.tm_year -= 1900;  <span class="comment">/* to convert to definition of struct tm */</span>
00159          stm.tm_mon  -= 1;     <span class="comment">/* to convert to definition of struct tm */</span>
00160          tsec  = <a class="code" href="chron3_8c.html#a12">timegm</a>( &amp;stm );
00161          sm-&gt;<a class="code" href="struct__SM__INFO.html#m10">tpga</a> = (double)tsec + 0.001*(double)msec;
00162        }
00163      }
00164 
00165   <span class="comment">/* Fifth line = peak velocity values */</span>
00166      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 5 )
00167      {
00168        memset( &amp;stm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm) ); <span class="comment">/* zero the time structure */</span>
00169        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"PGV: %lf TPGV: %d/%d/%d %d:%d:%d.%d"</span>, 
00170                   &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m11">pgv</a>), &amp;stm.tm_year, &amp;stm.tm_mon, &amp;stm.tm_mday,
00171                   &amp;stm.tm_hour, &amp;stm.tm_min, &amp;stm.tm_sec, &amp;msec ) != 8 ) 
00172                   <span class="keywordflow">return</span>( -1 );
00173        <span class="keywordflow">if</span>( stm.tm_year == 0 ) {
00174          sm-&gt;<a class="code" href="struct__SM__INFO.html#m12">tpgv</a> = 0.0;
00175        } <span class="keywordflow">else</span> {
00176          stm.tm_year -= 1900;  <span class="comment">/* to convert to definition of struct tm */</span>
00177          stm.tm_mon  -= 1;     <span class="comment">/* to convert to definition of struct tm */</span>
00178          tsec  = <a class="code" href="chron3_8c.html#a12">timegm</a>( &amp;stm );
00179          sm-&gt;<a class="code" href="struct__SM__INFO.html#m12">tpgv</a> = (double)tsec + 0.001*(double)msec;
00180        }
00181      }
00182 
00183   <span class="comment">/* Sixth line = peak displacement values */</span>
00184      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 6 )
00185      {
00186        memset( &amp;stm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm) ); <span class="comment">/* zero the time structure */</span>
00187        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"PGD: %lf TPGD: %d/%d/%d %d:%d:%d.%d"</span>, 
00188                   &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m13">pgd</a>), &amp;stm.tm_year, &amp;stm.tm_mon, &amp;stm.tm_mday,
00189                   &amp;stm.tm_hour, &amp;stm.tm_min, &amp;stm.tm_sec, &amp;msec ) != 8 ) 
00190                   <span class="keywordflow">return</span>( -1 );
00191        <span class="keywordflow">if</span>( stm.tm_year == 0 ) {
00192          sm-&gt;<a class="code" href="struct__SM__INFO.html#m14">tpgd</a> = 0.0;
00193        } <span class="keywordflow">else</span> {
00194          stm.tm_year -= 1900;  <span class="comment">/* to convert to definition of struct tm */</span>
00195          stm.tm_mon  -= 1;     <span class="comment">/* to convert to definition of struct tm */</span>
00196          tsec  = <a class="code" href="chron3_8c.html#a12">timegm</a>( &amp;stm );
00197          sm-&gt;<a class="code" href="struct__SM__INFO.html#m14">tpgd</a> = (double)tsec + 0.001*(double)msec;
00198        }
00199      }
00200 
00201   <span class="comment">/* Seventh line = response spectral acceleration */</span>
00202      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 7 )
00203      {
00204        <span class="keywordflow">if</span>( sscanf( line, <span class="stringliteral">"RSA: %d"</span>, &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a>) ) != 1 ) <span class="keywordflow">return</span>( -1 );
00205        <span class="keywordflow">if</span>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a> &gt; <a class="code" href="rw__strongmotion_8h.html#a7">SM_MAX_RSA</a> ) <span class="keywordflow">return</span>( -1 );
00206        begtok = line;
00207        <span class="keywordflow">for</span>( i=0; i&lt;sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a>; i++ )
00208        {
00209          begtok += <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'/'</span> ) + 1;
00210          <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00211          <span class="keywordflow">if</span>( sscanf( begtok, <span class="stringliteral">"%lf %lf"</span>, 
00212                     &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m16">pdrsa</a>[i]), &amp;(sm-&gt;<a class="code" href="struct__SM__INFO.html#m17">rsa</a>[i]) ) != 2 ) <span class="keywordflow">return</span>( -1 );
00213        } 
00214      }
00215 
00216   <span class="comment">/* Eighth line = eventid and author */</span>
00217      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nline == 8 )
00218      {
00219        <span class="keywordflow">if</span>( strncmp(line,<span class="stringliteral">"QID:"</span>, 4) != 0 ) <span class="keywordflow">return</span>( -1 );
00220        begtok = line + 4;
00221 
00222        <span class="keywordflow">while</span>( begtok[0] == <span class="charliteral">' '</span> ) begtok++;    <span class="comment">/* go to 1st non-blank char */</span>
00223        <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00224        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">' '</span> );
00225        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="earthworm__defs_8h.html#a18">EVENTID_SIZE</a> ) <span class="keywordflow">return</span>( -1 );
00226        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m4">qid</a>, begtok, len ); 
00227        <span class="keywordflow">if</span>( strcmp( sm-&gt;<a class="code" href="struct__SM__INFO.html#m4">qid</a>, sUnknown ) == 0 ) sm-&gt;<a class="code" href="struct__SM__INFO.html#m4">qid</a>[0] = <span class="charliteral">'\0'</span>;
00228        begtok += len + 1;
00229 
00230        <span class="keywordflow">while</span>( begtok[0] == <span class="charliteral">' '</span> ) begtok++;    <span class="comment">/* go to 1st non-blank char */</span>
00231        <span class="keywordflow">if</span>( begtok &gt;= endline ) <span class="keywordflow">return</span>( -1 );
00232        len = <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( begtok, <span class="charliteral">'\n'</span> );
00233        <span class="keywordflow">if</span>( len &gt;= <a class="code" href="earthworm__defs_8h.html#a17">AUTHOR_FIELD_SIZE</a> ) <span class="keywordflow">return</span>( -1 );
00234        strncpy( sm-&gt;<a class="code" href="struct__SM__INFO.html#m5">qauthor</a>, begtok, len ); 
00235        <span class="keywordflow">if</span>( strcmp( sm-&gt;<a class="code" href="struct__SM__INFO.html#m5">qauthor</a>, sUnknown ) == 0 ) sm-&gt;<a class="code" href="struct__SM__INFO.html#m5">qauthor</a>[0] = <span class="charliteral">'\0'</span>;
00236      }
00237 
00238    } <span class="comment">/*end while*/</span>
00239 
00240 
00241    <span class="keywordflow">return</span>( 0 );
00242 }
00243 
00244 <span class="comment">/********************************************************************</span>
00245 <span class="comment"> * wr_strongmotionII()                                              *</span>
00246 <span class="comment"> * Reads a SM_INFO structure and writes an ascii TYPE_STRONGMOTION2 *</span>
00247 <span class="comment"> * message (null terminated)                                        *</span>
00248 <span class="comment"> * Returns 0 on success, -1 on failure (buffer overflow)            *</span>
00249 <span class="comment"> ********************************************************************/</span>
<a name="l00250"></a><a class="code" href="rw__strongmotionII_8c.html#a9">00250</a> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a9">wr_strongmotionII</a>( <a class="code" href="struct__SM__INFO.html">SM_INFO</a> *sm, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen )
00251 {
00252    <span class="keywordtype">char</span>     tmp[256]; <span class="comment">/* working buffer */</span>
00253    <span class="keywordtype">char</span>    *qid;
00254    <span class="keywordtype">char</span>    *qauthor;
00255    <span class="keywordtype">int</span>      i;
00256 
00257    memset( buf, 0, (size_t)buflen );    <span class="comment">/* zero output buffer */</span>
00258 
00259 <span class="comment">/* channel codes */</span>
00260    sprintf( buf, <span class="stringliteral">"SCNL: %s.%s.%s.%s"</span>, 
00261             sm-&gt;<a class="code" href="struct__SM__INFO.html#m0">sta</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m1">comp</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m2">net</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m3">loc</a> );
00262 
00263 <span class="comment">/* field time */</span>
00264    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, <span class="stringliteral">"\nTIME: "</span> ) ) <span class="keywordflow">return</span> ( -1 );
00265    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m6">t</a>, tmp, 256 );  
00266    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00267 
00268 <span class="comment">/* alternate time &amp; its code */</span>
00269    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, <span class="stringliteral">"\nALT: "</span> ) ) <span class="keywordflow">return</span> ( -1 );
00270    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( buf, buflen, sm-&gt;<a class="code" href="struct__SM__INFO.html#m7">talt</a> ) ) <span class="keywordflow">return</span> ( -1 );
00271    sprintf( tmp, <span class="stringliteral">" CODE: %d"</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m8">altcode</a> );
00272    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00273 
00274 <span class="comment">/* Print peak acceleration value &amp; time */</span>
00275    sprintf( tmp, <span class="stringliteral">"\nPGA: %.6lf TPGA: "</span>, (sm-&gt;<a class="code" href="struct__SM__INFO.html#m9">pga</a>!=SM_NULL ? <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(sm-&gt;<a class="code" href="struct__SM__INFO.html#m9">pga</a>) : sm-&gt;<a class="code" href="struct__SM__INFO.html#m9">pga</a>) );
00276    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00277    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( buf, buflen, sm-&gt;<a class="code" href="struct__SM__INFO.html#m10">tpga</a> ) ) <span class="keywordflow">return</span> ( -1 );
00278       
00279 <span class="comment">/* Print peak velocity value &amp; time */</span>
00280    sprintf( tmp, <span class="stringliteral">"\nPGV: %.6lf TPGV: "</span>, (sm-&gt;<a class="code" href="struct__SM__INFO.html#m11">pgv</a>!=SM_NULL ? <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(sm-&gt;<a class="code" href="struct__SM__INFO.html#m11">pgv</a>) : sm-&gt;<a class="code" href="struct__SM__INFO.html#m11">pgv</a>) );
00281    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00282    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( buf, buflen, sm-&gt;<a class="code" href="struct__SM__INFO.html#m12">tpgv</a> ) ) <span class="keywordflow">return</span> ( -1 );
00283       
00284 <span class="comment">/* Print peak displacement value &amp; time */</span>
00285    sprintf( tmp, <span class="stringliteral">"\nPGD: %.6lf TPGD: "</span>, (sm-&gt;<a class="code" href="struct__SM__INFO.html#m13">pgd</a>!=SM_NULL ? <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(sm-&gt;<a class="code" href="struct__SM__INFO.html#m13">pgd</a>) : sm-&gt;<a class="code" href="struct__SM__INFO.html#m13">pgd</a>) );
00286    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00287    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( buf, buflen, sm-&gt;<a class="code" href="struct__SM__INFO.html#m14">tpgd</a> ) ) <span class="keywordflow">return</span> ( -1 );
00288 
00289 <span class="comment">/* Print the response spectrum */</span>
00290    sprintf( tmp, <span class="stringliteral">"\nRSA: %d"</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a> );
00291    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00292    <span class="keywordflow">for</span>( i=0; i&lt;sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a>; i++ )
00293    {
00294      sprintf( tmp, <span class="stringliteral">"/%.2lf %.6lf"</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m16">pdrsa</a>[i], sm-&gt;<a class="code" href="struct__SM__INFO.html#m17">rsa</a>[i] );
00295      <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00296    }   
00297 
00298 <span class="comment">/* Print the eventid &amp; event author */</span>
00299    qid     = sm-&gt;<a class="code" href="struct__SM__INFO.html#m4">qid</a>;
00300    qauthor = sm-&gt;<a class="code" href="struct__SM__INFO.html#m5">qauthor</a>;
00301    <span class="keywordflow">if</span>( strlen(qid)     == 0 ) qid     = <a class="code" href="rw__strongmotionII_8c.html#a2">sUnknown</a>;
00302    <span class="keywordflow">if</span>( strlen(qauthor) == 0 ) qauthor = <a class="code" href="rw__strongmotionII_8c.html#a2">sUnknown</a>;
00303    sprintf( tmp, <span class="stringliteral">"\nQID: %s %s\n"</span>, qid, qauthor );
00304    <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00305 
00306    <span class="keywordflow">return</span>( 0 );
00307 }
00308 
00309 
00310 
00311 <span class="comment">/********************************************************************</span>
00312 <span class="comment"> * log_strongmotionII()                                             *</span>
00313 <span class="comment"> * Writes the contents of a SM_INFO structure to an Earthworm       *</span>
00314 <span class="comment"> * log file                                                         *</span>
00315 <span class="comment"> ********************************************************************/</span>
<a name="l00316"></a><a class="code" href="rw__strongmotionII_8c.html#a10">00316</a> <span class="keywordtype">void</span> <a class="code" href="rw__strongmotionII_8c.html#a10">log_strongmotionII</a>( <a class="code" href="struct__SM__INFO.html">SM_INFO</a> *sm )
00317 {
00318    <span class="keywordtype">char</span> date[30];
00319    <span class="keywordtype">int</span>  i;
00320 
00321    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"SCNL: %s.%s.%s.%s\n"</span>, 
00322            sm-&gt;<a class="code" href="struct__SM__INFO.html#m0">sta</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m1">comp</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m2">net</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m3">loc</a> );
00323   
00324 <span class="comment">/* Log time values */</span>
00325    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m6">t</a>, date, 30 );
00326    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"Time: %s  (%.3lf)\n"</span>, date, sm-&gt;<a class="code" href="struct__SM__INFO.html#m6">t</a> );
00327    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m7">talt</a>, date, 30 );
00328    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"Alt:  %s  (%.3lf)  code: %d\n"</span>, 
00329             date, sm-&gt;<a class="code" href="struct__SM__INFO.html#m7">talt</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m8">altcode</a> );
00330 
00331 
00332 <span class="comment">/* Print peak acceleration values */</span>
00333    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m10">tpga</a>, date, 30 );
00334    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"PGA: %.6lf  TGPA: %s (%.3lf)\n"</span>,
00335             sm-&gt;<a class="code" href="struct__SM__INFO.html#m9">pga</a>, date, sm-&gt;<a class="code" href="struct__SM__INFO.html#m10">tpga</a> );
00336       
00337 <span class="comment">/* Print peak velocity values */</span>
00338    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m12">tpgv</a>, date, 30 );
00339    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"PGV: %.6lf  TGPV: %s (%.3lf)\n"</span>,
00340             sm-&gt;<a class="code" href="struct__SM__INFO.html#m11">pgv</a>, date, sm-&gt;<a class="code" href="struct__SM__INFO.html#m12">tpgv</a> );
00341 
00342 <span class="comment">/* Print peak displacement values */</span>
00343    <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( sm-&gt;<a class="code" href="struct__SM__INFO.html#m14">tpgd</a>, date, 30 );
00344    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"PGD: %.6lf  TGPD: %s (%.3lf)\n"</span>,
00345             sm-&gt;<a class="code" href="struct__SM__INFO.html#m13">pgd</a>, date, sm-&gt;<a class="code" href="struct__SM__INFO.html#m14">tpgd</a> );
00346 
00347 
00348 <span class="comment">/* Print number of points in the response spectrum */</span>
00349    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>,<span class="stringliteral">"RSA: %d "</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a> );
00350    <span class="keywordflow">for</span>( i=0; i&lt;sm-&gt;<a class="code" href="struct__SM__INFO.html#m15">nrsa</a>; i++ )
00351    {
00352       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">" /%.2lf %.6lf"</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m16">pdrsa</a>[i], sm-&gt;<a class="code" href="struct__SM__INFO.html#m17">rsa</a>[i] );
00353    }   
00354 
00355 <span class="comment">/* Print eventid &amp; author */</span>
00356    <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>,<span class="stringliteral">"\nQID: %s %s\n"</span>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m4">qid</a>, sm-&gt;<a class="code" href="struct__SM__INFO.html#m5">qauthor</a>);
00357 
00358    <span class="keywordflow">return</span>;
00359 }
00360 
00361 
00362 <span class="comment">/**********************************************************</span>
00363 <span class="comment"> * Converts time (double, seconds since 1970:01:01) to    *</span>
00364 <span class="comment"> * a 23-character, null-terminated string in the form of  *</span>
00365 <span class="comment"> *            yyyy/mm/dd hh:mm:ss.sss                     *</span>
00366 <span class="comment"> * Time is displayed in UTC                               *</span>
00367 <span class="comment"> * Target buffer must be 24-chars long to have room for   *</span>
00368 <span class="comment"> * null-character                                         *</span>
00369 <span class="comment"> **********************************************************/</span>
<a name="l00370"></a><a class="code" href="rw__strongmotionII_8c.html#a6">00370</a> <span class="keywordtype">char</span> *<a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( <span class="keywordtype">double</span> t, <span class="keywordtype">char</span> *pbuf, <span class="keywordtype">int</span> len )
00371 {
00372    time_t    tt;       <span class="comment">/* time as time_t                  */</span>
00373    <span class="keyword">struct </span>tm stm;      <span class="comment">/* time as struct tm               */</span>
00374    <span class="keywordtype">int</span>       t_msec;   <span class="comment">/* milli-seconds part of time      */</span>
00375 
00376 <span class="comment">/* Make sure target is big enough</span>
00377 <span class="comment"> ********************************/</span>
00378    <span class="keywordflow">if</span>( len &lt; 24 ) <span class="keywordflow">return</span>( (<span class="keywordtype">char</span> *)NULL );
00379 
00380 <span class="comment">/* Convert double time to other formats</span>
00381 <span class="comment"> **************************************/</span>
00382    t += 0.0005;  <span class="comment">/* prepare to round to the nearest 1000th */</span>
00383    tt     = (time_t) t;
00384    t_msec = (int)( (t - tt) * 1000. );
00385    <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a>( &amp;tt, &amp;stm );
00386 
00387 <span class="comment">/* Build character string</span>
00388 <span class="comment"> ************************/</span>
00389    sprintf( pbuf,
00390            <span class="stringliteral">"%04d/%02d/%02d %02d:%02d:%02d.%03d"</span>,
00391             stm.tm_year+1900,
00392             stm.tm_mon+1,
00393             stm.tm_mday,
00394             stm.tm_hour,
00395             stm.tm_min,
00396             stm.tm_sec,
00397             t_msec );
00398 
00399    <span class="keywordflow">return</span>( pbuf );
00400 }
00401 
00402 
00403 <span class="comment">/********************************************************************</span>
00404 <span class="comment"> * addtimestr() append a date string to the end of existing string  *</span>
00405 <span class="comment"> *   Return -1 if result would overflow the target,                 *</span>
00406 <span class="comment"> *           0 if everything went OK                                *</span>
00407 <span class="comment"> ********************************************************************/</span>
<a name="l00408"></a><a class="code" href="rw__strongmotionII_8c.html#a7">00408</a> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a7">addtimestr</a>( <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen, <span class="keywordtype">double</span> t )
00409 {
00410    <span class="keywordtype">char</span> tmp[30];
00411 
00412    <span class="keywordflow">if</span>( t == 0.0 )
00413    {
00414      <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, sNullDate ) ) <span class="keywordflow">return</span>( -1 );
00415    } <span class="keywordflow">else</span> {
00416      <a class="code" href="rw__strongmotionII_8c.html#a6">datestr24</a>( t, tmp, 30 );  
00417      <span class="keywordflow">if</span>( <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( buf, buflen, tmp ) ) <span class="keywordflow">return</span>( -1 );
00418    }
00419    <span class="keywordflow">return</span>( 0 );
00420 }
00421 
00422 <span class="comment">/********************************************************************</span>
00423 <span class="comment"> * strappend() append second null-terminated character string to    *</span>
00424 <span class="comment"> * the first as long as there's enough room in the target buffer    * </span>
00425 <span class="comment"> * for both strings and the null-byte                               *</span>
00426 <span class="comment"> ********************************************************************/</span>
<a name="l00427"></a><a class="code" href="rw__strongmotionII_8c.html#a4">00427</a> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a4">strappend</a>( <span class="keywordtype">char</span> *s1, <span class="keywordtype">int</span> s1max, <span class="keywordtype">char</span> *s2 )
00428 {
00429    <span class="keywordflow">if</span>( (int)strlen(s1)+(int)strlen(s2)+1 &gt; s1max ) <span class="keywordflow">return</span>( -1 );
00430    strcat( s1, s2 );
00431    <span class="keywordflow">return</span>( 0 );
00432 }
00433 
00434 <span class="comment">/********************************************************************</span>
00435 <span class="comment"> * tokenlength() given a null-terminated character string and a     *</span>
00436 <span class="comment"> * character that delimits the end of a token, tokenlength returns  * </span>
00437 <span class="comment"> * the length (in bytes) of the next token. If the character wasn't * </span>
00438 <span class="comment"> * found, tokenlength returns the length of the string.             *</span>
00439 <span class="comment"> ********************************************************************/</span>
<a name="l00440"></a><a class="code" href="rw__strongmotionII_8c.html#a5">00440</a> <span class="keywordtype">int</span> <a class="code" href="rw__strongmotionII_8c.html#a5">tokenlength</a>( <span class="keywordtype">char</span> *begtok, <span class="keywordtype">char</span> c )
00441 {
00442    <span class="keywordtype">char</span>    *endtok;   <span class="comment">/* points to the end of this token */</span>
00443 
00444    endtok = strchr( begtok, c );
00445    <span class="keywordflow">if</span>( endtok == NULL ) <span class="keywordflow">return</span>( (int)strlen(begtok) );
00446    <span class="keywordflow">return</span>( (int)(endtok-begtok) );
00447 }
00448 
00449 
00450 <span class="comment">/* Sample TYPE_STRONGMOTION2 message (between ------):</span>
00451 <span class="comment">------------------------------------------------</span>
00452 <span class="comment">SCNL: CMB.BHZ.BK.</span>
00453 <span class="comment">TIME: 2001/02/25 02:37:00.000</span>
00454 <span class="comment">ALT:  2001/02/25 02:40:40.000 CODE: 1</span>
00455 <span class="comment">PGA: 6.846210 TPGA: 2001/02/25 02:37:00.000</span>
00456 <span class="comment">PGV: 0.140000 TPGV: 2001/02/25 02:37:00.000</span>
00457 <span class="comment">PGD: 0.000000 TPGD: 2001/02/25 02:37:00.000</span>
00458 <span class="comment">RSA: 3/0.30 4.415404/1.00 0.925639/3.00 0.297907</span>
00459 <span class="comment">QID: 41059467 014024003:UCB</span>
00460 <span class="comment">------------------------------------------------</span>
00461 <span class="comment">*/</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:08 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
