<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>truetime.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>truetime.c</h1><a href="truetime_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: truetime_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00011 <span class="comment"> *     Initial revision</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> */</span>
00015 
00016   <span class="comment">/*******************************************************************</span>
00017 <span class="comment">   *                            truetime.c                           *</span>
00018 <span class="comment">   *                                                                 *</span>
00019 <span class="comment">   *       Function to get time from the True-Time PC-SG board,      *</span>
00020 <span class="comment">   *     using the device driver written by Tod Morcott, Mar 1996.   *</span>
00021 <span class="comment">   *     Runs on OS/2 version 3.                                     *</span>
00022 <span class="comment">   *******************************************************************/</span>
00023 
<a name="l00024"></a><a class="code" href="truetime_8c.html#a0">00024</a> <span class="preprocessor">#define INCL_DOSFILEMGR                       </span>
<a name="l00025"></a><a class="code" href="truetime_8c.html#a1">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define INCL_DOSPROCESS</span>
<a name="l00026"></a><a class="code" href="truetime_8c.html#a2">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define INCL_DOSDEVICES</span>
<a name="l00027"></a><a class="code" href="truetime_8c.html#a3">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define INCL_DOSPROFILE</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include &lt;os2.h&gt;</span>
00029 <span class="preprocessor">#include &lt;bsedos.h&gt;</span>
00030 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
00033 <span class="preprocessor">#include &lt;process.h&gt;</span>
00034 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="truetime_8h.html">truetime.h</a>&gt;</span>
00037 
<a name="l00038"></a><a class="code" href="truetime_8c.html#a4">00038</a> <span class="preprocessor">#define TB_CATEGORY  0x80</span>
<a name="l00039"></a><a class="code" href="truetime_8c.html#a5">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define TB_FREEZE    0x41</span>
<a name="l00040"></a><a class="code" href="truetime_8c.html#a6">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define TB_RELEASE   0x42</span>
<a name="l00041"></a><a class="code" href="truetime_8c.html#a7">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define TB_GET_TIME  0X43</span>
<a name="l00042"></a><a class="code" href="truetime_8c.html#a8">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_READY   0x80</span>
00043 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="truetime_8c.html#a9">00044</a> <span class="keyword">static</span> <span class="keywordtype">int</span>   <a class="code" href="truetime_8c.html#a9">MaxPassCnt</a>;
<a name="l00045"></a><a class="code" href="truetime_8c.html#a10">00045</a> <span class="keyword">static</span> <span class="keywordtype">int</span>   <a class="code" href="truetime_8c.html#a10">MaxPass</a> = 0;
<a name="l00046"></a><a class="code" href="truetime_8c.html#a11">00046</a> <span class="keyword">static</span> <span class="keywordtype">char</span>  <a class="code" href="truetime_8c.html#a11">buffer</a>[32];
<a name="l00047"></a><a class="code" href="truetime_8c.html#a12">00047</a> <span class="keyword">static</span> <span class="keywordtype">char</span>  *<a class="code" href="truetime_8c.html#a12">pszFileName</a>;
<a name="l00048"></a><a class="code" href="truetime_8c.html#a16">00048</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a13">ulActionTaken</a>, <a class="code" href="truetime_8c.html#a14">ulFileAttribute</a>, <a class="code" href="truetime_8c.html#a15">ulOpenFlag</a>, <a class="code" href="truetime_8c.html#a16">ulOpenMode</a>, <a class="code" href="truetime_8c.html#a17">ulFileSize</a>;
<a name="l00049"></a><a class="code" href="truetime_8c.html#a18">00049</a> <span class="keyword">static</span> HFILE <a class="code" href="truetime_8c.html#a18">hFileHandle</a>;
<a name="l00050"></a><a class="code" href="truetime_8c.html#a19">00050</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a19">ulCategory</a>;
<a name="l00051"></a><a class="code" href="truetime_8c.html#a20">00051</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a20">ulFunction</a>;
<a name="l00052"></a><a class="code" href="truetime_8c.html#a21">00052</a> <span class="keyword">static</span> VOID  *<a class="code" href="truetime_8c.html#a21">pParmList</a>;
<a name="l00053"></a><a class="code" href="truetime_8c.html#a22">00053</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a22">ulParmLengthMax</a>;
<a name="l00054"></a><a class="code" href="truetime_8c.html#a23">00054</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a23">ulParmLengthInOut</a>;
<a name="l00055"></a><a class="code" href="truetime_8c.html#a24">00055</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a24">ulDataLengthMax</a>;
<a name="l00056"></a><a class="code" href="truetime_8c.html#a25">00056</a> <span class="keyword">static</span> ULONG <a class="code" href="truetime_8c.html#a25">ulDataLengthInOut</a>;
<a name="l00057"></a><a class="code" href="truetime_8c.html#a26">00057</a> <span class="keyword">static</span> APIRET <a class="code" href="truetime_8c.html#a26">rc</a>;
00058 
00059 
00060 
00061   <span class="comment">/***************************************************************</span>
00062 <span class="comment">   *                         OpenTrueTime()                      *</span>
00063 <span class="comment">   *                                                             *</span>
00064 <span class="comment">   *              Open the True-Time PC-SG clock card            *</span>
00065 <span class="comment">   *                                                             *</span>
00066 <span class="comment">   *  Argument:                                                  *</span>
00067 <span class="comment">   *     MaxPassCount = Number of times the data ready bit is    *</span>
00068 <span class="comment">   *     polled before an error is reported.  MaxPassCount must  *</span>
00069 <span class="comment">   *     be larger for faster processors, and for TrueTime       *</span>
00070 <span class="comment">   *     PC-SG boards with different characteristics.  A value   *</span>
00071 <span class="comment">   *     of 100 was large enough, but 20 was not large enough    *</span>
00072 <span class="comment">   *     (7/11/96)                                               *</span>
00073 <span class="comment">   ***************************************************************/</span>
00074 
<a name="l00075"></a><a class="code" href="truetime_8c.html#a27">00075</a> <span class="keywordtype">int</span> <a class="code" href="truetime_8c.html#a27">OpenTrueTime</a>( <span class="keywordtype">int</span> MaxPassCount )
00076 {
00077    <a class="code" href="truetime_8c.html#a9">MaxPassCnt</a> = MaxPassCount;
00078 
00079    <a class="code" href="truetime_8c.html#a19">ulCategory</a>      = <a class="code" href="truetime_8c.html#a4">TB_CATEGORY</a>;
00080    <a class="code" href="truetime_8c.html#a14">ulFileAttribute</a> = FILE_NORMAL;
00081    <a class="code" href="truetime_8c.html#a15">ulOpenFlag</a>      = OPEN_ACTION_FAIL_IF_NEW |
00082                      OPEN_ACTION_OPEN_IF_EXISTS;
00083    <a class="code" href="truetime_8c.html#a16">ulOpenMode</a>      = OPEN_FLAGS_FAIL_ON_ERROR |
00084                      OPEN_FLAGS_NO_CACHE |
00085                      OPEN_SHARE_DENYNONE |
00086                      OPEN_ACCESS_READWRITE;
00087    <a class="code" href="truetime_8c.html#a12">pszFileName</a>     = <span class="stringliteral">"TimeBas$"</span>;
00088 
00089    <a class="code" href="truetime_8c.html#a26">rc</a> = DosOpen( pszFileName,
00090                  &amp;hFileHandle, 
00091                  &amp;ulActionTaken,
00092                  ulFileSize,
00093                  ulFileAttribute,
00094                  ulOpenFlag, 
00095                  ulOpenMode,
00096                  NULL );
00097    <span class="keywordflow">if</span> ( <a class="code" href="truetime_8c.html#a26">rc</a> != 0 )
00098    {
00099       printf( <span class="stringliteral">"Could not open %s\n"</span>, pszFileName );
00100       <span class="keywordflow">return</span> -1;
00101    }
00102    <span class="keywordflow">return</span> 0;
00103 }
00104 
00105 
<a name="l00106"></a><a class="code" href="truetime_8c.html#a28">00106</a> <span class="keywordtype">int</span> <a class="code" href="truetime_8c.html#a28">CloseTrueTime</a>( <span class="keywordtype">void</span> )
00107 {
00108    DosClose( hFileHandle );
00109    <span class="keywordflow">return</span> <a class="code" href="truetime_8c.html#a10">MaxPass</a>;
00110 }
00111 
00112 
<a name="l00113"></a><a class="code" href="truetime_8c.html#a29">00113</a> BOOL <a class="code" href="truetime_8c.html#a29">FreezeTime</a>( <span class="keywordtype">void</span> )
00114 {
00115    <a class="code" href="truetime_8c.html#a20">ulFunction</a>        = <a class="code" href="truetime_8c.html#a5">TB_FREEZE</a>;
00116    <a class="code" href="truetime_8c.html#a21">pParmList</a>         = NULL;
00117    <a class="code" href="truetime_8c.html#a22">ulParmLengthMax</a>   = 0;
00118    <a class="code" href="truetime_8c.html#a23">ulParmLengthInOut</a> = 0;
00119    <a class="code" href="truetime_8c.html#a24">ulDataLengthMax</a>   = <span class="keyword">sizeof</span>(int);
00120    <a class="code" href="truetime_8c.html#a25">ulDataLengthInOut</a> = <span class="keyword">sizeof</span>(int);
00121 
00122    <a class="code" href="truetime_8c.html#a26">rc</a> = DosDevIOCtl( hFileHandle,
00123                      ulCategory,
00124                      ulFunction,
00125                      pParmList,
00126                      ulParmLengthMax,
00127                      &amp;ulParmLengthInOut,
00128                      buffer,
00129                      ulDataLengthMax,
00130                      &amp;ulDataLengthInOut );
00131    <span class="keywordflow">if</span> ( <a class="code" href="truetime_8c.html#a26">rc</a> != 0 )
00132    {
00133       printf( <span class="stringliteral">"%s DosDevIOCtl = %d\n"</span>, __FUNCTION__, rc );
00134       DosClose( hFileHandle );
00135       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00136    }
00137    <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00138 }
00139 
00140 
00141 
<a name="l00142"></a><a class="code" href="truetime_8c.html#a30">00142</a> BOOL <a class="code" href="truetime_8c.html#a30">ReleaseTime</a>( <span class="keywordtype">void</span> )
00143 {
00144    <a class="code" href="truetime_8c.html#a20">ulFunction</a> = <a class="code" href="truetime_8c.html#a6">TB_RELEASE</a>;
00145 
00146    <a class="code" href="truetime_8c.html#a26">rc</a> = DosDevIOCtl( hFileHandle,
00147                      ulCategory,
00148                      ulFunction,
00149                      pParmList,
00150                      ulParmLengthMax,
00151                      &amp;ulParmLengthInOut,
00152                      buffer,
00153                      ulDataLengthMax,
00154                      &amp;ulDataLengthInOut );
00155    <span class="keywordflow">if</span> ( <a class="code" href="truetime_8c.html#a26">rc</a> != 0 )
00156    {
00157       printf( <span class="stringliteral">"%s DosDevIOCtl = %d\n"</span>, __FUNCTION__, rc );
00158       DosClose( hFileHandle );
00159       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00160    }
00161    <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00162 }
00163 
00164 
00165 
<a name="l00166"></a><a class="code" href="truetime_8c.html#a31">00166</a> <span class="keywordtype">int</span> <a class="code" href="truetime_8c.html#a31">GetTime</a>( <a class="code" href="struct__TrueTimeStruct.html">TrueTimeStruct</a> *pTrueTime )
00167 {
00168    <span class="keywordtype">int</span> PassCount = 0;
00169    UCHAR data_ready;
00170 
00171    <a class="code" href="truetime_8c.html#a20">ulFunction</a>        = <a class="code" href="truetime_8c.html#a7">TB_GET_TIME</a>;
00172    <a class="code" href="truetime_8c.html#a21">pParmList</a>         = NULL;
00173    <a class="code" href="truetime_8c.html#a22">ulParmLengthMax</a>   = 0;
00174    <a class="code" href="truetime_8c.html#a23">ulParmLengthInOut</a> = 0;
00175    <a class="code" href="truetime_8c.html#a24">ulDataLengthMax</a>   = <span class="keyword">sizeof</span>( TrueTimeStruct );
00176    <a class="code" href="truetime_8c.html#a25">ulDataLengthInOut</a> = <span class="keyword">sizeof</span>( TrueTimeStruct );
00177 
00178    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m1">UnitMillisecs</a>     = (UCHAR)0xff;
00179    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m2">TensMillisecs</a>     = (UCHAR)0xff;
00180    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m3">HundredsMillisecs</a> = (UCHAR)0xff;
00181    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m4">UnitSeconds</a>       = (UCHAR)0xff;
00182    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m5">TensSeconds</a>       = (UCHAR)0xff;
00183    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m6">UnitMinutes</a>       = (UCHAR)0xff;
00184    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m7">TensMinutes</a>       = (UCHAR)0xff;
00185    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m8">UnitHours</a>         = (UCHAR)0xff;  
00186    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m9">TensHours</a>         = (UCHAR)0xff;  
00187    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m10">UnitDays</a>          = (UCHAR)0xff;   
00188    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m11">TensDays</a>          = (UCHAR)0xff;   
00189    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m12">HundredsDays</a>      = (UCHAR)0xff;
00190    pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m13">Status</a>            = (UCHAR)0xff;
00191 
00192 <span class="comment">/* Make several attempts to get the time from the True-Time clock</span>
00193 <span class="comment">   **************************************************************/</span>
00194    <span class="keywordflow">do</span>
00195    {
00196       <a class="code" href="truetime_8c.html#a26">rc</a> = DosDevIOCtl( hFileHandle,
00197                         ulCategory,
00198                         ulFunction,
00199                         pParmList,
00200                         ulParmLengthMax,
00201                         &amp;ulParmLengthInOut,
00202                         pTrueTime,
00203                         ulDataLengthMax,
00204                         &amp;ulDataLengthInOut );
00205       <span class="keywordflow">if</span> ( <a class="code" href="truetime_8c.html#a26">rc</a> != 0 )
00206       {
00207          printf( <span class="stringliteral">"%s DosDevIOCtl = %d\n"</span>, __FUNCTION__, rc );
00208          <span class="keywordflow">return</span> -1;
00209       }
00210 
00211       <span class="keywordflow">if</span> ( ++PassCount == <a class="code" href="truetime_8c.html#a9">MaxPassCnt</a> )     <span class="comment">/* Error. Too many passes. */</span>
00212          <span class="keywordflow">return</span> -2;
00213 
00214       data_ready = pTrueTime-&gt;<a class="code" href="struct__TrueTimeStruct.html#m0">DataReady</a> &amp; <a class="code" href="truetime_8c.html#a8">READ_READY</a>;
00215 
00216    } <span class="keywordflow">while</span> ( !data_ready );
00217 
00218    <a class="code" href="truetime_8c.html#a10">MaxPass</a> = (PassCount &gt; <a class="code" href="truetime_8c.html#a10">MaxPass</a>) ? PassCount : <a class="code" href="truetime_8c.html#a10">MaxPass</a>;
00219    <span class="keywordflow">return</span> 0;
00220 }
00221 
00222 
<a name="l00223"></a><a class="code" href="truetime_8c.html#a32">00223</a> <span class="keywordtype">int</span> <a class="code" href="truetime_8c.html#a32">GetTrueTime</a>( <a class="code" href="struct__TrueTimeStruct.html">TrueTimeStruct</a> *pTrueTime )
00224 {
00225    <span class="keywordtype">int</span> <a class="code" href="truetime_8c.html#a26">rc</a>;
00226 
00227    <a class="code" href="truetime_8c.html#a29">FreezeTime</a>();
00228    <a class="code" href="truetime_8c.html#a26">rc</a> = <a class="code" href="truetime_8c.html#a31">GetTime</a>( pTrueTime );
00229    <a class="code" href="truetime_8c.html#a30">ReleaseTime</a>();
00230    <span class="keywordflow">return</span> <a class="code" href="truetime_8c.html#a26">rc</a>;
00231 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:12 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
