<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>globalutils.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>globalutils.cpp</h1><a href="globalutils_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>  <span class="comment">// getenv</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>  <span class="comment">// strcmp, strcpy, strcat</span>
00004 <span class="comment">//#include &lt;stdio.h&gt;   // fprintf</span>
00005 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00006 <span class="preprocessor"></span><span class="preprocessor">#include &lt;time.h&gt;</span>    <span class="comment">// _tzset -- to set the timezone related to GMT</span>
00007 <span class="preprocessor">#endif</span>
00008 <span class="preprocessor"></span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="worm__environ_8h.html">worm_environ.h</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="worm__exceptions_8h.html">worm_exceptions.h</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="comfile_8h.html">comfile.h</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="globalutils_8h.html">globalutils.h</a>&gt;</span>
00014 
00015 <span class="comment">//---------------------------------------------------------------------------</span>
00016 <span class="comment">// Borland pragma, ignored by other compilers</span>
00017 <span class="preprocessor">#pragma package(smart_init)</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">//---------------------------------------------------------------------------</span>
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment">** STATIC VARIABLES</span>
00023 <span class="comment">*/</span>
<a name="l00024"></a><a class="code" href="classTGlobalUtils.html#q0">00024</a> <a class="code" href="worm__types_8h.html#a18">PROGRAM_NAME</a> <a class="code" href="classTGlobalUtils.html#q0">TGlobalUtils::ProgramName</a> = { <span class="stringliteral">"Uninitialized"</span> };
<a name="l00025"></a><a class="code" href="classTGlobalUtils.html#q2">00025</a> <a class="code" href="worm__types_8h.html#a21">WORM_INSTALLATION_ID</a> <a class="code" href="classTGlobalUtils.html#q2">TGlobalUtils::ThisInstallation</a> = <a class="code" href="worm__types_8h.html#a5">WORM_INSTALLATION_INVALID</a>;
<a name="l00026"></a><a class="code" href="classTGlobalUtils.html#q1">00026</a> <a class="code" href="worm__types_8h.html#a24">WORM_MODULE_ID</a> <a class="code" href="classTGlobalUtils.html#q1">TGlobalUtils::ThisModuleId</a> = <a class="code" href="worm__types_8h.html#a7">WORM_MODULE_INVALID</a>;
<a name="l00027"></a><a class="code" href="classTGlobalUtils.html#q3">00027</a> <a class="code" href="worm__types_8h.html#a19">LOG_DIRECTORY</a> <a class="code" href="classTGlobalUtils.html#q3">TGlobalUtils::HomeDirectory</a>;
<a name="l00028"></a><a class="code" href="classTGlobalUtils.html#q4">00028</a> <span class="keywordtype">char</span> <a class="code" href="classTGlobalUtils.html#q4">TGlobalUtils::Version</a>[12];
<a name="l00029"></a><a class="code" href="classTGlobalUtils.html#q7">00029</a> <span class="keywordtype">long</span> <a class="code" href="classTGlobalUtils.html#q7">TGlobalUtils::HeartBeatInt</a> = -1;
00030 
00031 <span class="comment">// don't set this to WORM_LOG_NONE here</span>
<a name="l00032"></a><a class="code" href="classTGlobalUtils.html#q6">00032</a> <a class="code" href="worm__defs_8h.html#a14">WORM_LOGGING_LEVEL</a> <a class="code" href="classTGlobalUtils.html#q6">TGlobalUtils::LogLevel</a> = <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a>;
<a name="l00033"></a><a class="code" href="classTGlobalUtils.html#q5">00033</a> <span class="keywordtype">bool</span> <a class="code" href="classTGlobalUtils.html#q5">TGlobalUtils::DoLogFile</a> = <span class="keyword">true</span>;
00034 
<a name="l00035"></a><a class="code" href="classTGlobalUtils.html#r0">00035</a> std::vector&lt;std::string&gt; <a class="code" href="classTGlobalUtils.html#r0">TGlobalUtils::ConfigFiles</a>;
<a name="l00036"></a><a class="code" href="classTGlobalUtils.html#r1">00036</a> <span class="keywordtype">int</span>  <a class="code" href="classTGlobalUtils.html#r1">TGlobalUtils::ConfigFileCount</a>  = 0;
00037 
<a name="l00038"></a><a class="code" href="classTGlobalUtils.html#q9">00038</a> <a class="code" href="worm__types_8h.html#a22">INSTALLATION_MAP</a> <a class="code" href="classTGlobalUtils.html#q9">TGlobalUtils::InstallIds</a>;
<a name="l00039"></a><a class="code" href="classTGlobalUtils.html#q10">00039</a> <a class="code" href="worm__types_8h.html#a31">RING_MAP</a> <a class="code" href="classTGlobalUtils.html#q10">TGlobalUtils::RingIds</a>;
<a name="l00040"></a><a class="code" href="classTGlobalUtils.html#q11">00040</a> <a class="code" href="worm__types_8h.html#a25">MODULE_MAP</a> <a class="code" href="classTGlobalUtils.html#q11">TGlobalUtils::ModuleIds</a>;
<a name="l00041"></a><a class="code" href="classTGlobalUtils.html#q12">00041</a> <a class="code" href="worm__types_8h.html#a28">MESSAGETYPE_MAP</a> <a class="code" href="classTGlobalUtils.html#q12">TGlobalUtils::MessageTypeIds</a>;
00042 
<a name="l00043"></a><a class="code" href="classTGlobalUtils.html#q8">00043</a> <span class="keyword">volatile</span> <span class="keywordtype">bool</span> <a class="code" href="classTGlobalUtils.html#q8">TGlobalUtils::TerminateFlag</a> = <span class="keyword">false</span>;
00044 
00045 
00046 <span class="comment">//---------------------------------------------------------------------------</span>
00047 
00048 
00049 <span class="comment">//---------------------------------------------------------------------------</span>
00050 <span class="comment">/*</span>
00051 <span class="comment">**  p_programname is expected as argv[0], so the path and extension will be</span>
00052 <span class="comment">**  stripped off.</span>
00053 <span class="comment">*/</span>
<a name="l00054"></a><a class="code" href="classTGlobalUtils.html#a0">00054</a> <a class="code" href="classTGlobalUtils.html#a0">TGlobalUtils::TGlobalUtils</a>( <span class="keywordtype">char</span>* p_programname )
00055 {
00056    <span class="comment">// only one bite at the configuration apple</span>
00057    <span class="keywordflow">if</span> ( <a class="code" href="classTConfigurable.html#n0">ConfigState</a> == <a class="code" href="worm__statuscode_8h.html#a22a7">WORM_STAT_NOTINIT</a> )
00058    {
00059       <span class="keywordflow">if</span> ( p_programname == NULL )
00060       {
00061          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00062                        , <span class="stringliteral">"TGlobalUtils(): program name is NULL\n"</span>
00063                        );
00064       }
00065 
00066 
00067       <span class="comment">// Get the config directory from the environment</span>
00068       <span class="comment">//</span>
00069       <a class="code" href="worm__types_8h.html#a20">GEN_FILENAME</a> _configdir
00070                  , _configfilename
00071                  ;
00072 
00073       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"WORM_HOME_KEY"</span>) == NULL )
00074       {
00075          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"EW_HOME_KEY"</span>) == NULL )
00076          {
00077             strcpy( HomeDirectory, <span class="stringliteral">""</span> );
00078          }
00079          <span class="keywordflow">else</span>
00080          {
00081             strcpy( HomeDirectory, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"EW_HOME_KEY"</span>) );
00082          }
00083       }
00084       <span class="keywordflow">else</span>
00085       {
00086          strcpy( HomeDirectory, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"WORM_HOME_KEY"</span>) );
00087       }
00088 
00089 
00090       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"WORM_VERSION_KEY"</span>) == NULL )
00091       {
00092          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"EW_VERSION_KEY"</span>) == NULL )
00093          {
00094             strcpy( Version, <span class="stringliteral">""</span> );
00095          }
00096          <span class="keywordflow">else</span>
00097          {
00098             strcpy( Version, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"EW_VERSION_KEY"</span>) );
00099          }
00100       }
00101       <span class="keywordflow">else</span>
00102       {
00103          strcpy( Version, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(<span class="stringliteral">"WORM_HOME_KEY"</span>) );
00104       }
00105 
00106 
00107 
00108       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>( WORM_CONFIG_DIR ) == NULL )
00109       {
00110          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>( EW_CONFIG_DIR ) == NULL )
00111          {
00112             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00113                           , <span class="stringliteral">"TGlobalUtils(): Neither environment variable &lt;%s&gt; nor &lt;%s&gt; are defined\n                using current directory"</span>
00114                           , WORM_CONFIG_DIR
00115                           , EW_CONFIG_DIR
00116                           );
00117             strcpy( _configdir, <span class="stringliteral">"."</span> );
00118          }
00119          <span class="keywordflow">else</span>
00120          {
00121             strcpy( _configdir, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>( EW_CONFIG_DIR ) );
00122          }
00123       }
00124       <span class="keywordflow">else</span>
00125       {
00126          strcpy( _configdir, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>( WORM_CONFIG_DIR ) );
00127       }
00128 
00129       <span class="keywordtype">int</span> _len = strlen( _configdir );
00130 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00131 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( 0 &lt; _len &amp;&amp; _configdir[_len-1] != <span class="charliteral">'\\'</span> )
00132       {
00133          strcat( _configdir, <span class="stringliteral">"\\"</span> );
00134       }
00135 <span class="preprocessor">#else</span>
00136 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( 0 &lt; _len &amp;&amp; _configdir[_len-1] != <span class="charliteral">'/'</span> )
00137       {
00138          strcat( _configdir, <span class="stringliteral">"/"</span> );
00139       }
00140 <span class="preprocessor">#endif</span>
00141 <span class="preprocessor"></span>
00142          <span class="comment">// Get the config file names, these are later used by</span>
00143          <span class="comment">// LoadFiles() and CheckConfig()</span>
00144          <span class="comment">//</span>
00145          <span class="comment">// NOTE: if the worm configuration files are not specified in</span>
00146          <span class="comment">//       the environment, then if the EW params directory is</span>
00147          <span class="comment">//       in the environment this is assumed to be an</span>
00148          <span class="comment">//       earthworm installation and the earthworm fixed filenames</span>
00149          <span class="comment">//       are used.</span>
00150          <span class="comment">//</span>
00151          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_CONFIG_GLOBAL) == NULL )
00152          {
00153             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(EW_CONFIG_DIR) != NULL )
00154             {
00155                 strcpy( _configfilename, _configdir );
00156                 strcat( _configfilename, <span class="stringliteral">"earthworm_global.d"</span> );
00157                 <a class="code" href="classTGlobalUtils.html#r0">ConfigFiles</a>.push_back(_configfilename);
00158                 <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a>++;
00159             }
00160          }
00161          <span class="keywordflow">else</span>
00162          {
00163              strcpy( _configfilename, _configdir );
00164              strcat( _configfilename, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_CONFIG_GLOBAL) );
00165              <a class="code" href="classTGlobalUtils.html#r0">ConfigFiles</a>.push_back(_configfilename);
00166              <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a>++;
00167          }
00168 
00169          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_CONFIG_SITE) == NULL )
00170          {
00171             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(EW_CONFIG_DIR) != NULL )
00172             {
00173                 strcpy( _configfilename, _configdir );
00174                 strcat( _configfilename, <span class="stringliteral">"earthworm.d"</span> );
00175                 <a class="code" href="classTGlobalUtils.html#r0">ConfigFiles</a>.push_back(_configfilename);
00176                 <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a>++;
00177             }
00178          }
00179          <span class="keywordflow">else</span>
00180          {
00181              strcpy( _configfilename, _configdir );
00182              strcat( _configfilename, <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_CONFIG_SITE) );
00183              <a class="code" href="classTGlobalUtils.html#r0">ConfigFiles</a>.push_back(_configfilename);
00184              <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a>++;
00185          }
00186 
00187          <span class="keywordtype">char</span>* _ptr;
00188 
00189          <span class="comment">// Skip over path if included</span>
00190 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00191 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_TIME_ZONE) != NULL ) _tzset();
00192 
00193          <span class="keywordflow">if</span> ((_ptr = strrchr(p_programname, <span class="charliteral">'\\'</span>)) != NULL)
00194 <span class="preprocessor">#else</span>
00195 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ((_ptr = strrchr(p_programname, <span class="charliteral">'/'</span>)) != NULL)
00196 <span class="preprocessor">#endif</span>
00197 <span class="preprocessor"></span>         {
00198             strcpy(ProgramName, _ptr + 1);
00199          }
00200          <span class="keywordflow">else</span>
00201          {
00202             strcpy(ProgramName, p_programname);
00203          }
00204 
00205          <span class="comment">// eliminate extension if present</span>
00206          _ptr = strchr(ProgramName, <span class="charliteral">'.'</span>);
00207          <span class="keywordflow">if</span> (_ptr != NULL)
00208          {
00209             *_ptr = <span class="charliteral">'\0'</span>;
00210          }
00211       }
00212 
00213       <a class="code" href="classTGlobalUtils.html#c0">LoadFiles</a>();
00214 
00215 
00216       <span class="comment">// Get the institution id from environment</span>
00217       <span class="keywordtype">char</span> * _installname = NULL;
00218 
00219       <span class="keywordtype">short</span> _installsource = 0;
00220 
00221       <span class="keywordflow">if</span> ( (_installname = <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(WORM_INSTALLATION_KEY)) == NULL )
00222       {
00223          _installsource = 1;
00224          _installname = <a class="code" href="classTGlobalUtils.html#d2">GetEnvironmentValue</a>(EW_INSTALLATION_KEY);
00225       }
00226 
00227       <span class="keywordflow">if</span> ( _installname == NULL )
00228       {
00229          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00230                        , <span class="stringliteral">"TGlobalUtils(): Neither environment variable &lt;%s&gt; nor &lt;%s&gt; is defined\n"</span>
00231                        , WORM_INSTALLATION_KEY
00232                        , EW_INSTALLATION_KEY
00233                        );
00234       }
00235       <span class="keywordflow">else</span>
00236       {
00237          <span class="keywordflow">if</span> ( strlen(_installname) == 0 )
00238          {
00239             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00240                           , <span class="stringliteral">"TGlobalUtils(): Environment variable &lt;%s&gt; is defined but empty\n"</span>
00241                           , ( _installsource == 0 ? WORM_INSTALLATION_KEY : EW_INSTALLATION_KEY )
00242                           );
00243          }
00244          <span class="keywordflow">else</span>
00245          {
00246             <span class="keywordflow">if</span> ( (<a class="code" href="classTGlobalUtils.html#q2">ThisInstallation</a> = <a class="code" href="classTGlobalUtils.html#d13">LookupInstallationId</a>(_installname)) == <a class="code" href="worm__types_8h.html#a5">WORM_INSTALLATION_INVALID</a>)
00247             {
00248                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00249                              , <span class="stringliteral">"TGlobalUtils(): Installation name &lt;%s&gt; not found in global configuration file\n"</span>
00250                              , _installname
00251                              );
00252             }
00253          }
00254       }
00255 
00256 }
00257 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00258"></a><a class="code" href="classTGlobalUtils.html#d2">00258</a> <span class="keywordtype">char</span>* <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* p_key )
00259 {
00260    <span class="keywordflow">return</span> getenv(p_key);
00261 }
00262 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00263"></a><a class="code" href="classTGlobalUtils.html#a1">00263</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classTGlobalUtils.html#a1">TGlobalUtils::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00264 {
00265    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_status = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00266 
00267    <span class="keywordflow">try</span>
00268    {
00269 
00270       <span class="keywordflow">do</span>
00271       {
00272          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>( <span class="stringliteral">"TruncLogOnStartup"</span> ) )
00273          {
00274             <a class="code" href="classTLogger.html#d0">TLogger::TruncateOnOpen</a>();
00275          }
00276 
00277          <span class="comment">//                    WORM                           EARTHWORM</span>
00278          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>( <span class="stringliteral">"ThisModule"</span> ) || p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>( <span class="stringliteral">"MyModuleId"</span> ) )
00279          {
00280             <span class="keywordtype">char</span> * _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00281 
00282             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00283             {
00284                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing both &lt;ThisModule&gt; and &lt;MyModuleId&gt; values"</span>);
00285             }
00286 
00287             <span class="keywordflow">if</span> ( (<a class="code" href="classTGlobalUtils.html#q1">ThisModuleId</a> = <a class="code" href="classTGlobalUtils.html#d14">LookupModuleId</a>(_token)) == <a class="code" href="worm__types_8h.html#a7">WORM_MODULE_INVALID</a> )
00288             {
00289                <span class="keywordtype">char</span> _emsg[70];
00290                sprintf( _emsg
00291                       , <span class="stringliteral">"ModuleId '%s' not found in lookup tables for &lt;ThisModule/MyModuleId&gt; command"</span>
00292                       , _token
00293                       );
00294                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(_emsg);
00295             }
00296 
00297             <span class="keywordflow">continue</span>;
00298          }
00299 
00300          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"HeartBeatInt"</span>) )
00301          {
00302             <span class="keywordflow">if</span> ( (<a class="code" href="classTGlobalUtils.html#q7">HeartBeatInt</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a16">Long</a>()) == <a class="code" href="classConfigSource.html#p1">ConfigSource::INVALID_LONG</a> )
00303             {
00304                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;HeartBeatInt&gt; value"</span>);
00305             }
00306             <span class="keywordflow">continue</span>;
00307          }
00308 
00309          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"NoLogFile"</span>) )
00310          {
00311             <a class="code" href="classTGlobalUtils.html#q5">DoLogFile</a> = <span class="keyword">false</span>;
00312             <span class="keywordflow">continue</span>;
00313          }
00314 
00315          <span class="comment">// Allow the global logging level (set through LoadFiles() --&gt; ParseCommand())</span>
00316          <span class="comment">// to be overridden by the &lt;module&gt;.d file</span>
00317          <span class="comment">//</span>
00318          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"LogLevel"</span>) )
00319          {
00320             <span class="keywordtype">int</span> _level;
00321             <span class="keywordflow">if</span> ( (_level = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00322             {
00323                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;LogLevel&gt; value"</span>);
00324             }
00325 
00326             <a class="code" href="classTGlobalUtils.html#q6">LogLevel</a> = (WORM_LOGGING_LEVEL)_level;
00327             <span class="keywordflow">continue</span>;
00328          }
00329 
00330          r_status = <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a>;
00331 
00332       } <span class="keywordflow">while</span>( false );
00333    }
00334    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00335    {
00336       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00337                     , <span class="stringliteral">"TGlobalUtils::HandleConfigLine(): %s from line\n%s\n"</span>
00338                     , _we.what()
00339                     , p_parser-&gt;<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00340                     );
00341    }
00342 
00343    <span class="keywordflow">return</span> r_status;
00344 }
00345 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00346"></a><a class="code" href="classTGlobalUtils.html#b1">00346</a> <span class="keywordtype">void</span> <a class="code" href="classTGlobalUtils.html#b1">TGlobalUtils::CheckConfig</a>()
00347 {
00348    <span class="comment">// After all files are closed, check init flags for missed commands</span>
00349 
00350    <span class="keywordtype">bool</span> _command_missed = <span class="keyword">false</span>;
00351    <span class="keywordflow">if</span> (   <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>.size() == 0
00352        || <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>.size() == 0
00353        || <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>.size() == 0
00354        || <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>.size() == 0
00355 <span class="comment">//       || ThisModuleId == WORM_MODULE_INVALID</span>
00356       )
00357    {
00358       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00359       _command_missed = <span class="keyword">true</span>;
00360    }
00361    <span class="keywordflow">if</span> ( _command_missed )
00362    {
00363          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00364                        , <span class="stringliteral">"TGlobalUtils::CheckConfig(): found no"</span>
00365                        );
00366       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>.size() == 0 )
00367          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, <span class="stringliteral">" &lt;Ring&gt;"</span> );
00368       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>.size() == 0 )
00369          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, <span class="stringliteral">" &lt;Module&gt;"</span> );
00370       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>.size() == 0 )
00371          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, <span class="stringliteral">" &lt;Message&gt;"</span> );
00372       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>.size() == 0 )
00373          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, <span class="stringliteral">" &lt;Installation&gt;"</span> );
00374 <span class="comment">//      if ( ThisModuleId == WORM_MODULE_INVALID )</span>
00375 <span class="comment">//         TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, " &lt;ThisModule/MyModuleId&gt;" );</span>
00376 
00377          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR, <span class="stringliteral">"line(s) in file(s):\n"</span> );
00378       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> _f = 0 ; _f &lt; <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a> ; _f++ )
00379       {
00380          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00381                        , <span class="stringliteral">"   &lt;%s&gt;\n"</span>
00382                        , ConfigFiles[_f].c_str()
00383                        );
00384       }
00385    }
00386 
00387    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q2">ThisInstallation</a> == <a class="code" href="worm__types_8h.html#a5">WORM_INSTALLATION_INVALID</a> )
00388    {
00389       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00390                     , <span class="stringliteral">"TGlobalUtils::CheckConfig(): Neither &lt;%s&gt; nor &lt;%s&gt; environment value set\n"</span>
00391                     , WORM_INSTALLATION_KEY
00392                     , EW_INSTALLATION_KEY
00393                     );
00394       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00395    }
00396 
00397    <span class="keywordflow">if</span> ( strlen(HomeDirectory) == 0 )
00398    {
00399       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00400                     , <span class="stringliteral">"TGlobalUtils::CheckConfig(): Neither &lt;%s&gt; nor &lt;%s&gt; environment value set\n"</span>
00401                     , WORM_HOME_KEY
00402                     , EW_HOME_KEY
00403                     );
00404       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00405    }
00406 
00407    <span class="keywordflow">if</span> ( strlen(Version) == 0 )
00408    {
00409       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00410                     , <span class="stringliteral">"TGlobalUtils::CheckConfig(): Neither &lt;%s&gt; nor &lt;%s&gt; environment value set\n"</span>
00411                     , WORM_VERSION_KEY
00412                     , EW_VERSION_KEY
00413                     );
00414       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00415    }
00416 }
00417 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00418"></a><a class="code" href="classTGlobalUtils.html#b0">00418</a> <span class="keywordtype">bool</span> <a class="code" href="classTGlobalUtils.html#b0">TGlobalUtils::ParseLookupLine</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_filename, <a class="code" href="classConfigSource.html">ConfigSource</a> &amp; p_parser )
00419 {
00420    <span class="keywordtype">bool</span> r_foundit = <span class="keyword">false</span>;
00421 
00422    std::string _name;
00423    <a class="code" href="worm__types_8h.html#a30">WORM_RING_ID</a> _ringkey;
00424    <span class="keywordtype">int</span> _wrkid;
00425 
00426    <span class="comment">// this is a loop solely to allow use of the continue statement</span>
00427    <span class="comment">// to make the code cleaner</span>
00428 
00429    <span class="keywordflow">do</span>
00430    {
00431       <span class="keywordflow">if</span> ( p_parser.<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Installation"</span>) )
00432       {
00433          <span class="comment">// get installation key</span>
00434          _name = p_parser.<a class="code" href="classConfigSource.html#a12">String</a>();
00435 
00436          <span class="keywordflow">if</span> ( _name.size() == 0 )
00437          {
00438             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00439                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Installation name missing in &lt;%s&gt;\n"</span>
00440                           , p_filename
00441                           );
00442             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00443          }
00444 
00445          <span class="keywordflow">if</span> ( <a class="code" href="worm__types_8h.html#a12">MAX_INSTALLNAME_LEN</a> &lt; _name.size() )
00446          {
00447             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00448                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Installation name &lt;%s&gt; too long in &lt;%s&gt; max=%d chars\n"</span>
00449                           , _name.c_str()
00450                           , p_filename
00451                           , <a class="code" href="worm__types_8h.html#a12">MAX_INSTALLNAME_LEN</a>
00452                           );
00453             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00454          }
00455 
00456          <span class="keywordflow">if</span> ( (_wrkid = p_parser.<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00457          {
00458             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00459                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Installation &lt;%s&gt;'s id missing in &lt;%s&gt;\n"</span>
00460                           , _name.c_str()
00461                           , p_filename
00462                           );
00463             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00464          }
00465 
00466          <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>.count(_name) )
00467          {
00468             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00469                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Duplicate entry for Installation key &lt;%s&gt;\nin file %s\nvalues old: %d new: %d, %s\n"</span>
00470                           , _name.c_str()
00471                           , p_filename
00472                           , (int)<a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>[_name]
00473                           , (int)_wrkid
00474                           , <span class="stringliteral">"new setting ignored"</span>
00475                           );
00476             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00477          }
00478 
00479          <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>[_name] = (WORM_INSTALLATION_ID)_wrkid;
00480          r_foundit = <span class="keyword">true</span>;
00481          <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00482       }
00483 
00484       <span class="comment">// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</span>
00485 
00486       <span class="keywordflow">if</span> ( p_parser.<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Ring"</span>) )
00487       {
00488          <span class="comment">// get ring name</span>
00489          _name = p_parser.<a class="code" href="classConfigSource.html#a12">String</a>();
00490 
00491          <span class="keywordflow">if</span> ( _name.size() == 0 )
00492          {
00493             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00494                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Ring name missing in &lt;%s&gt;\n"</span>
00495                           , p_filename
00496                           );
00497             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00498          }
00499 
00500          <span class="keywordflow">if</span> ( <a class="code" href="worm__types_8h.html#a13">MAX_RINGNAME_LEN</a> &lt; _name.size() )
00501          {
00502             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00503                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Ring name &lt;%s&gt; too long in &lt;%s&gt; max=%d chars\n"</span>
00504                           , _name.c_str()
00505                           , p_filename
00506                           , <a class="code" href="worm__types_8h.html#a13">MAX_RINGNAME_LEN</a>
00507                           );
00508             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00509          }
00510 
00511          <span class="keywordflow">if</span> ( (_ringkey = p_parser.<a class="code" href="classConfigSource.html#a16">Long</a>()) == <a class="code" href="classConfigSource.html#p1">ConfigSource::INVALID_LONG</a> )
00512          {
00513             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00514                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Ring &lt;%s&gt;'s id missing in &lt;%s&gt;\n"</span>
00515                           , _name.c_str()
00516                           , p_filename
00517                           );
00518             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00519          }
00520 
00521          <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>.count(_name) )
00522          {
00523             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00524                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Duplicate entry for Ring key &lt;%s&gt;\nin file %s\nvalues old: %d new: %d, %s\n"</span>
00525                           , _name.c_str()
00526                           , p_filename
00527                           , (int)<a class="code" href="classTGlobalUtils.html#q10">RingIds</a>[_name]
00528                           , (int)_ringkey
00529                           , <span class="stringliteral">"new setting ignored"</span>
00530                           );
00531             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00532          }
00533 
00534          <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>[_name] = (WORM_RING_ID)_ringkey;
00535          r_foundit = <span class="keyword">true</span>;
00536          <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00537       }
00538 
00539       <span class="comment">// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</span>
00540 
00541       <span class="keywordflow">if</span> ( p_parser.<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Module"</span>) )
00542       {
00543          _name = p_parser.<a class="code" href="classConfigSource.html#a5">NextToken</a>(); <span class="comment">// module name</span>
00544 
00545          <span class="keywordflow">if</span> ( _name.size() == 0 )
00546          {
00547             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00548                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Module name missing in &lt;%s&gt;\n"</span>
00549                           , p_filename
00550                           );
00551             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00552          }
00553 
00554          <span class="keywordflow">if</span> ( <a class="code" href="worm__types_8h.html#a14">MAX_MODNAME_LEN</a> &lt; _name.size() )
00555          {
00556             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00557                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Module name &lt;%s&gt; too long in &lt;%s&gt; max=%d chars\n"</span>
00558                           , _name.c_str()
00559                           , p_filename
00560                           , <a class="code" href="worm__types_8h.html#a14">MAX_MODNAME_LEN</a>
00561                           );
00562             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00563          }
00564 
00565          <span class="keywordflow">if</span> ( (_wrkid = p_parser.<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00566          {
00567             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00568                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Module &lt;%s&gt;'s id missing in &lt;%s&gt;\n"</span>
00569                           , _name.c_str()
00570                           , p_filename
00571                           );
00572             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00573          }
00574 
00575          <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>.count(_name) )
00576          {
00577             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00578                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Duplicate entry for Module key &lt;%s&gt;\nin file %s\nvalues old: %d new: %d, %s\n"</span>
00579                           , _name.c_str()
00580                           , p_filename
00581                           , (int)<a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>[_name]
00582                           , (int)_wrkid
00583                           , <span class="stringliteral">"new setting ignored"</span>
00584                           );
00585             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00586          }
00587 
00588          <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>[_name] = (WORM_MODULE_ID)_wrkid;
00589          r_foundit = <span class="keyword">true</span>;
00590          <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00591       }
00592 
00593       <span class="comment">// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</span>
00594 
00595       <span class="keywordflow">if</span> ( p_parser.<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Message"</span>) )
00596       {
00597          _name = p_parser.<a class="code" href="classConfigSource.html#a5">NextToken</a>(); <span class="comment">// module name</span>
00598 
00599          <span class="keywordflow">if</span> ( _name.size() == 0 )
00600          {
00601             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00602                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Message type name missing in &lt;%s&gt;\n"</span>
00603                           , p_filename
00604                           );
00605             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00606          }
00607 
00608          <span class="keywordflow">if</span> ( <a class="code" href="worm__types_8h.html#a15">MAX_MSGTYPENAME_LEN</a> &lt; _name.size() )
00609          {
00610             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00611                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Message type name &lt;%s&gt; too long in &lt;%s&gt; max=%d chars\n"</span>
00612                           , _name.c_str()
00613                           , p_filename
00614                           , <a class="code" href="worm__types_8h.html#a15">MAX_MSGTYPENAME_LEN</a>
00615                           );
00616             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00617          }
00618 
00619          <span class="keywordflow">if</span> ( (_wrkid = p_parser.<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00620          {
00621             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00622                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Message type &lt;%s&gt;'s id missing in &lt;%s&gt;\n"</span>
00623                           , _name.c_str()
00624                           , p_filename
00625                           );
00626             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00627          }
00628 
00629          <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>.count(_name) )
00630          {
00631             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00632                           , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): Duplicate entry for Message type &lt;%s&gt;\nin file %s\nvalues old: %d new: %d, %s\n"</span>
00633                           , _name.c_str()
00634                           , p_filename
00635                           , (int)<a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>[_name]
00636                           , (int)_wrkid
00637                           , <span class="stringliteral">"new setting ignored"</span>
00638                           );
00639             <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00640          }
00641 
00642          <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>[_name] = (WORM_MSGTYPE_ID)_wrkid;
00643          r_foundit = <span class="keyword">true</span>;
00644          <span class="keywordflow">continue</span>; <span class="comment">// next line</span>
00645       }
00646 
00647 <span class="comment">/*</span>
00648 <span class="comment">      if ( p_parser.Its("ThisInstallId") )</span>
00649 <span class="comment">      {</span>
00650 <span class="comment">         r_foundit = true;</span>
00651 <span class="comment"></span>
00652 <span class="comment">         _name = p_parser.String();</span>
00653 <span class="comment"></span>
00654 <span class="comment">         if ( (ThisInstallation = LookupInstallationId(_name.c_str())) == WORM_INSTALLATION_INVALID )</span>
00655 <span class="comment">         {</span>
00656 <span class="comment">            TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR</span>
00657 <span class="comment">                          , "TGlobalUtils::ParseLookupLine(): &lt;ThisInstallId&gt; value missing in &lt;%s&gt; \n%s\n"</span>
00658 <span class="comment">                          , p_filename</span>
00659 <span class="comment">                          , _name.c_str()</span>
00660 <span class="comment">                          );</span>
00661 <span class="comment">            continue; // next line</span>
00662 <span class="comment">         }</span>
00663 <span class="comment"></span>
00664 <span class="comment">         continue; // next line</span>
00665 <span class="comment">      }</span>
00666 <span class="comment">*/</span>
00667 
00668       <span class="keywordflow">if</span> ( p_parser.<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"LogLevel"</span>) )
00669       {
00670          <span class="comment">// Although standard practice directs that TGlobalUtils</span>
00671          <span class="comment">// should be instantiated and initialized (thus arriving here</span>
00672          <span class="comment">// to set the logging level at the global setting)</span>
00673          <span class="comment">// before the module reads its own configuration file</span>
00674          <span class="comment">// (possibly overriding the global setting), some might</span>
00675          <span class="comment">// inappropriately call the local configuration before the global.</span>
00676          <span class="comment">// Thus the reason for WORM_LOG_MU, which is used to distinguish</span>
00677          <span class="comment">// "haven't seen it yet" from "no logging" (WORM_LOG_NONE).</span>
00678          <span class="comment">//</span>
00679          <span class="comment">// Don't set debug level from here if previously set from the</span>
00680          <span class="comment">// the &lt;module&gt;.d file [through HandleConfigLine()]</span>
00681          r_foundit = <span class="keyword">true</span>;
00682          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#q6">LogLevel</a> != <a class="code" href="worm__defs_8h.html#a14a7">WORM_LOG_MU</a> )
00683          {
00684             <span class="keywordtype">int</span> _level;
00685             <span class="keywordflow">if</span> ( (_level = p_parser.<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00686             {
00687                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00688                              , <span class="stringliteral">"TGlobalUtils::ParseLookupLine(): missing &lt;LogLevel&gt; value in &lt;%s&gt;\n"</span>
00689                              , p_filename
00690                              );
00691                <span class="keywordflow">continue</span>;
00692             }
00693             <a class="code" href="classTGlobalUtils.html#q6">LogLevel</a> = (WORM_LOGGING_LEVEL)_level;
00694          }
00695          <span class="keywordflow">continue</span>;
00696       }
00697 
00698    }
00699    <span class="keywordflow">while</span>( false );
00700 
00701    <span class="keywordflow">return</span> r_foundit;
00702 }
00703 <span class="comment">//---------------------------------------------------------------------------</span>
00704 
<a name="l00705"></a><a class="code" href="classTGlobalUtils.html#c0">00705</a> <span class="keywordtype">void</span> <a class="code" href="classTGlobalUtils.html#c0">TGlobalUtils::LoadFiles</a>()
00706 {
00707    <span class="keywordflow">if</span> ( <a class="code" href="classTConfigurable.html#n0">ConfigState</a> != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00708    {
00709 
00710       <a class="code" href="classTComFileParser.html">TComFileParser</a> _parser;
00711 
00712       <span class="comment">// Loop thru the specified configuration files</span>
00713 
00714       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> _file = 0 ; _file &lt; <a class="code" href="classTGlobalUtils.html#r1">ConfigFileCount</a> ; _file++ )
00715       {
00716 
00717          <span class="keywordflow">if</span> ( ! _parser.<a class="code" href="classTComFileParser.html#a2">Open</a>(ConfigFiles[_file].c_str()) )
00718          {
00719             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00720                           , <span class="stringliteral">"TGlobalUtils::LoadFiles(): Error opening config file\n%s\n"</span>
00721                           , ConfigFiles[_file].c_str()
00722                           );
00723             <span class="keywordflow">continue</span>; <span class="comment">// try next file</span>
00724          }
00725 
00726          <span class="keywordtype">bool</span> _reading = <span class="keyword">true</span>;
00727 
00728          <span class="keywordflow">do</span>
00729          {
00730 
00731             <span class="keywordtype">int</span> _read_status = _parser.<a class="code" href="classTComFileParser.html#a5">ReadLine</a>();
00732 
00733             <span class="keywordflow">switch</span>( _read_status )
00734             {
00735               <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>:
00736                    {
00737                       <span class="comment">// Error</span>
00738                       <span class="keywordtype">char</span> * _errtext;
00739                       _parser.<a class="code" href="classConfigSource.html#a10">Error</a>( &amp;_errtext );
00740                       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00741                                     , <span class="stringliteral">"TGlobalUtils::LoadFiles(): Error reading line\n%s\nfrom config file: %s\n"</span>
00742                                     , _errtext
00743                                     , ConfigFiles[_file].c_str()
00744                                     );
00745 <span class="comment">//                      _file = ConfigFileCount; // leave [outer] for() loop</span>
00746                    }
00747                    _reading = <span class="keyword">false</span>;
00748                    <span class="keywordflow">break</span>; <span class="comment">// leave [inner] while() loop (may attempt subsequent file)</span>
00749 
00750               <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>:
00751 
00752                    _reading = <span class="keyword">false</span>;
00753                    <span class="keywordflow">break</span>;
00754 
00755               <span class="keywordflow">case</span> 0: <span class="comment">// empty line</span>
00756                    <span class="keywordflow">break</span>;
00757 
00758               <span class="keywordflow">default</span>:
00759                    <span class="comment">// line read from file okay, get command tag string</span>
00760                    <span class="comment">//</span>
00761                    _parser.<a class="code" href="classConfigSource.html#a5">NextToken</a>();
00762 
00763                    <span class="keywordflow">if</span> ( ! _parser.<a class="code" href="classConfigSource.html#a11">IsTokenNull</a>() )
00764                    {
00765                       <span class="keywordflow">if</span> ( ! <a class="code" href="classTGlobalUtils.html#b0">ParseLookupLine</a>( ConfigFiles[_file].c_str(), _parser ) )
00766                       {
00767                          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00768                                        , <span class="stringliteral">"TGlobalUtils::LoadFiles(): Invalid command line in file: %s\n%s\n"</span>
00769                                        , ConfigFiles[_file].c_str()
00770                                        , _parser.<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00771                                        );
00772                          _reading = <span class="keyword">false</span>; <span class="comment">// on error, leave the loop</span>
00773                       }
00774                    }
00775                    <span class="keywordflow">break</span>;
00776             }   <span class="comment">// read status</span>
00777          } <span class="keywordflow">while</span>( _reading );  <span class="comment">// each line in opened file</span>
00778 
00779          _parser.<a class="code" href="classTComFileParser.html#a4">Close</a>();
00780 
00781       } <span class="comment">// each file</span>
00782 
00783    } <span class="comment">// not yet configured</span>
00784 }
00785 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00786"></a><a class="code" href="classTGlobalUtils.html#d13">00786</a> <span class="keyword">const</span> <a class="code" href="worm__types_8h.html#a21">WORM_INSTALLATION_ID</a> <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* p_name )
00787 {
00788    <a class="code" href="worm__types_8h.html#a21">WORM_INSTALLATION_ID</a> r_install = <a class="code" href="worm__types_8h.html#a5">WORM_INSTALLATION_INVALID</a>;
00789    <span class="keywordflow">if</span> ( p_name == NULL )
00790    {
00791       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00792                     , <span class="stringliteral">"TGlobalUtils::LookupInstallationId(): requested name is NULL\n"</span>
00793                     );
00794    }
00795    <span class="keywordflow">else</span>
00796    {
00797       <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>.count(p_name) )
00798       {
00799          r_install = <a class="code" href="classTGlobalUtils.html#q9">InstallIds</a>[p_name];
00800       }
00801    }
00802    <span class="keywordflow">return</span> r_install;
00803 }
00804 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00805"></a><a class="code" href="classTGlobalUtils.html#d16">00805</a> <span class="keyword">const</span> <a class="code" href="worm__types_8h.html#a30">WORM_RING_ID</a> <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* p_name )
00806 {
00807    <a class="code" href="worm__types_8h.html#a30">WORM_RING_ID</a> r_rkey = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00808    <span class="keywordflow">if</span> ( p_name == NULL )
00809    {
00810       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00811                     , <span class="stringliteral">"TGlobalUtils::LookupRingKey(): requested name is NULL\n"</span>
00812                     );
00813    }
00814    <span class="keywordflow">else</span>
00815    {
00816       <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>.count(p_name) )
00817       {
00818          r_rkey = <a class="code" href="classTGlobalUtils.html#q10">RingIds</a>[p_name];
00819       }
00820    }
00821    <span class="keywordflow">return</span> r_rkey;
00822 }
00823 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00824"></a><a class="code" href="classTGlobalUtils.html#d14">00824</a> <span class="keyword">const</span> <a class="code" href="worm__types_8h.html#a24">WORM_MODULE_ID</a> <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* p_name )
00825 {
00826    <a class="code" href="worm__types_8h.html#a24">WORM_MODULE_ID</a> r_mod = <a class="code" href="worm__types_8h.html#a7">WORM_MODULE_INVALID</a>;
00827    <span class="keywordflow">if</span> ( p_name == NULL )
00828    {
00829       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00830                     , <span class="stringliteral">"TGlobalUtils::LookupModuleId(): requested name is NULL\n"</span>
00831                     );
00832    }
00833    <span class="keywordflow">else</span>
00834    {
00835       <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>.count(p_name) )
00836       {
00837          r_mod = <a class="code" href="classTGlobalUtils.html#q11">ModuleIds</a>[p_name];
00838       }
00839    }
00840    <span class="keywordflow">return</span> r_mod;
00841 }
00842 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00843"></a><a class="code" href="classTGlobalUtils.html#d15">00843</a> <span class="keyword">const</span> <a class="code" href="worm__types_8h.html#a27">WORM_MSGTYPE_ID</a> <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* p_name )
00844 {
00845    <a class="code" href="worm__types_8h.html#a27">WORM_MSGTYPE_ID</a> r_mtyp = <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a>;
00846    <span class="keywordflow">if</span> ( p_name == NULL )
00847    {
00848       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00849                     , <span class="stringliteral">"TGlobalUtils::LookupMessageTypeId(): requested name is NULL\n"</span>
00850                     );
00851    }
00852    <span class="keywordflow">else</span>
00853    {
00854       <span class="keywordflow">if</span> ( 0 &lt; <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>.count(p_name) )
00855       {
00856          r_mtyp = <a class="code" href="classTGlobalUtils.html#q12">MessageTypeIds</a>[p_name];
00857       }
00858    }
00859    <span class="keywordflow">return</span> r_mtyp;
00860 }
00861 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:03 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
