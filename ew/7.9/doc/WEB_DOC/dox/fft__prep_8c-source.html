<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>fft_prep.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>fft_prep.c</h1><a href="fft__prep_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00003 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *    $Id: </span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *    Revision history:</span>
00008 <span class="comment"> *     $Log:</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> */</span>
00013 
00014 <span class="comment">/*</span>
00015 <span class="comment"> * fft_prep.c: routines for setting up the structures needed for the </span>
00016 <span class="comment"> * Temperton FFT99 package.</span>
00017 <span class="comment"> */</span>
00018 
00019 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="fft__prep_8h.html">fft_prep.h</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;<a class="code" href="fft99_8h.html">fft99.h</a>&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00024 
<a name="l00025"></a><a class="code" href="fft__prep_8c.html#a0">00025</a> <span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> = 1;
<a name="l00026"></a><a class="code" href="fft__prep_8c.html#a1">00026</a> <span class="keyword">static</span> <a class="code" href="struct__FACT.html">FACT</a> *<a class="code" href="fft__prep_8c.html#a1">fft_list</a> = (<a class="code" href="struct__FACT.html">FACT</a> *)NULL;
<a name="l00027"></a><a class="code" href="fft__prep_8c.html#a2">00027</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fft__prep_8c.html#a2">prime</a>[3] = {2, 3, 5};
<a name="l00028"></a><a class="code" href="fft__prep_8c.html#a3">00028</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fft__prep_8c.html#a3">Debug</a> = 0;
00029 
00030 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fft__prep_8c.html#a4">makeTrigs</a>( <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span> );
00031 
00032 <span class="comment">/*</span>
00033 <span class="comment"> * fftPrepDebug: set the debug level for all functions in fft_prep.c</span>
00034 <span class="comment"> *        Debug levels: 0 no debug output</span>
00035 <span class="comment"> *                      1 dump FAClist on logic errors.</span>
00036 <span class="comment"> */</span>
<a name="l00037"></a><a class="code" href="fft__prep_8c.html#a5">00037</a> <span class="keywordtype">void</span> <a class="code" href="fft__prep_8c.html#a5">fftPrepDebug</a>( <span class="keywordtype">int</span> level )
00038 {
00039   <a class="code" href="fft__prep_8c.html#a3">Debug</a> = level;
00040   <span class="keywordflow">return</span>;
00041 }
00042 
00043 
00044 <span class="comment">/* buildFacList: build a linked list of FFT factor structures. This list is</span>
00045 <span class="comment"> * used to decide the size of FFT to use. The FFT routines can handle </span>
00046 <span class="comment"> * sizes that are multiples of powers of 2, 3, and 5. This provides greater</span>
00047 <span class="comment"> * flexibility than sizes that are only powers of 2.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> * argument: new_nfft: the largest fft size required for this list.</span>
00050 <span class="comment"> *   This function may be called again to extend the list further.</span>
00051 <span class="comment"> * returns: 0 on success</span>
00052 <span class="comment"> *         -1 on failure (out of memory; not logged here)</span>
00053 <span class="comment"> *         -2 on logic errors (logged here)</span>
00054 <span class="comment"> */</span>
00055 
<a name="l00056"></a><a class="code" href="fft__prep_8c.html#a6">00056</a> <span class="keywordtype">long</span> <a class="code" href="fft__prep_8c.html#a6">buildFacList</a>( <span class="keywordtype">long</span> new_nfft )
00057 {
00058   <span class="keywordtype">long</span> i, j, next_nfft;
00059   <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span>, *next, *ins_before;
00060 
00061   <span class="comment">/*</span>
00062 <span class="comment">   * The idea is to start at `last_nfft' and multiply it by 2, 3, and 5, </span>
00063 <span class="comment">   * creating a new FACT element on the list for each one. After this is</span>
00064 <span class="comment">   * done, then we advance on the list ONE element (not the three that we </span>
00065 <span class="comment">   * just created. From this next list element, we set `last_nfft' to the</span>
00066 <span class="comment">   * nfft value of the element. In this way, the list contains an ordered</span>
00067 <span class="comment">   * set of all the multiples of powers of 2, 3, and 5.</span>
00068 <span class="comment">   */</span>
00069 
00070   <span class="comment">/* First time through is a special case: there are no elements on the </span>
00071 <span class="comment">   * list, so we have to create one. We'll assume that new_nfft &gt; 5</span>
00072 <span class="comment">   * though it really doesn't matter */</span>
00073   <span class="keywordflow">if</span> (<a class="code" href="fft__prep_8c.html#a0">last_nfft</a> == 1)
00074   {
00075     <span class="keywordflow">if</span> ( (<a class="code" href="fft__prep_8c.html#a1">fft_list</a> = (<a class="code" href="struct__FACT.html">FACT</a> *)calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct__FACT.html">FACT</a>))) == (<a class="code" href="struct__FACT.html">FACT</a> *)NULL)
00076       <span class="keywordflow">return</span> -1;
00077     <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00078     this-&gt;nfft = <a class="code" href="fft__prep_8c.html#a2">prime</a>[0];
00079     this-&gt;fact_power[0] = 1;
00080     next = <span class="keyword">this</span>;
00081     <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="fft__prep_8h.html#a1">N_RADIX</a>; i++)
00082     {
00083       <span class="comment">/* Get the next factor structure and fill it in */</span>
00084       <span class="keywordflow">if</span> ( (next-&gt;<a class="code" href="struct__FACT.html#m4">next</a> = (<a class="code" href="struct__FACT.html">FACT</a> *)calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct__FACT.html">FACT</a>))) == (<a class="code" href="struct__FACT.html">FACT</a> *)NULL)
00085         <span class="keywordflow">return</span> -1;
00086       next = next-&gt;<a class="code" href="struct__FACT.html#m4">next</a>;
00087       next-&gt;<a class="code" href="struct__FACT.html#m0">nfft</a> = <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> * <a class="code" href="fft__prep_8c.html#a2">prime</a>[i];
00088       next-&gt;<a class="code" href="struct__FACT.html#m1">fact_power</a>[i]++;
00089     }
00090   } 
00091   <span class="keywordflow">else</span>
00092   {
00093     <span class="comment">/* Walk the list to the last (newest, largest) entry */</span>
00094     <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00095     <span class="keywordflow">while</span> (this-&gt;nfft &lt; <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> )
00096     {
00097       <span class="comment">/* DEBUG; shouldn't happen if logic is correct */</span>
00098       <span class="keywordflow">if</span> (this-&gt;next == (<a class="code" href="struct__FACT.html">FACT</a> *) NULL)
00099       {
00100         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"buildFacList: Walked off end of list this %ld last %ld\n"</span>,
00101               this-&gt;nfft, last_nfft);
00102         <span class="keywordflow">if</span> (<a class="code" href="fft__prep_8c.html#a3">Debug</a> &gt; 0)
00103           <a class="code" href="fft__prep_8c.html#a8">printFacList</a>();
00104         <span class="keywordflow">return</span> -2;
00105       }
00106       <span class="keyword">this</span> = this-&gt;next;
00107     }
00108     <span class="keywordflow">if</span> (this-&gt;nfft != <a class="code" href="fft__prep_8c.html#a0">last_nfft</a>)
00109     {
00110       <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"buildFacList: last %ld does not match this %ld\n"</span>, 
00111             last_nfft, this-&gt;nfft);
00112       <span class="keywordflow">if</span> (<a class="code" href="fft__prep_8c.html#a3">Debug</a> &gt; 0)
00113         <a class="code" href="fft__prep_8c.html#a8">printFacList</a>();
00114       <span class="keywordflow">return</span> -2;
00115     }
00116   }
00117   <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> = this-&gt;nfft;
00118   
00119   <span class="comment">/* Add new entries to the list up to the requested "new_nfft" */</span>
00120   <span class="keywordflow">while</span> (this-&gt;nfft &lt;= new_nfft)
00121   {
00122     ins_before = <span class="keyword">this</span>;
00123     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fft__prep_8h.html#a1">N_RADIX</a>; i++)
00124     {
00125       next_nfft = <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> * <a class="code" href="fft__prep_8c.html#a2">prime</a>[i];
00126       <span class="comment">/* Walk the list to see where the next element will go, or if it </span>
00127 <span class="comment">       * is a dupe */</span>
00128       <span class="keywordflow">while</span>( ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a> != (<a class="code" href="struct__FACT.html">FACT</a> *)NULL &amp;&amp; 
00129              ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a>-&gt;<a class="code" href="struct__FACT.html#m0">nfft</a> &lt; next_nfft)
00130         ins_before = ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a>;
00131       <span class="keywordflow">if</span> (ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a> != (<a class="code" href="struct__FACT.html">FACT</a> *)NULL &amp;&amp; 
00132           ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a>-&gt;<a class="code" href="struct__FACT.html#m0">nfft</a> == next_nfft)
00133       {  <span class="comment">/* Found a dupe; skip it */</span>
00134         <span class="keywordflow">continue</span>;
00135       }
00136       <span class="comment">/* Get the next factor structure and fill it in */</span>
00137       <span class="keywordflow">if</span> ( ( next = (<a class="code" href="struct__FACT.html">FACT</a> *)calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct__FACT.html">FACT</a>))) == (<a class="code" href="struct__FACT.html">FACT</a> *)NULL)
00138         <span class="keywordflow">return</span> -1;
00139       next-&gt;<a class="code" href="struct__FACT.html#m0">nfft</a> = next_nfft;
00140       <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="fft__prep_8h.html#a1">N_RADIX</a>; j++)
00141         next-&gt;<a class="code" href="struct__FACT.html#m1">fact_power</a>[j] = this-&gt;fact_power[j];
00142       next-&gt;<a class="code" href="struct__FACT.html#m1">fact_power</a>[i]++;
00143       <span class="comment">/* Insert in the list */</span>
00144       next-&gt;<a class="code" href="struct__FACT.html#m4">next</a> = ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a>;
00145       ins_before-&gt;<a class="code" href="struct__FACT.html#m4">next</a> = next;
00146     }
00147     <span class="comment">/* don't need current factor anymore, move to next one */</span>
00148     <span class="keyword">this</span> = this-&gt;next;
00149     <a class="code" href="fft__prep_8c.html#a0">last_nfft</a> = this-&gt;nfft;
00150   }
00151   <span class="keywordflow">return</span> 0;
00152 }
00153 
00154 
00155 <span class="comment">/*</span>
00156 <span class="comment"> * prepFFT: find a `suitable' FFT size for proposed size n, and return</span>
00157 <span class="comment"> * a pointer to the FACT structure that has been prepared for this FFT.</span>
00158 <span class="comment"> * Currently `suitable' is defined as the next even nfft value larger than n.</span>
00159 <span class="comment"> * In the future, a more intelligent sizing algorithm may be employed.</span>
00160 <span class="comment"> *</span>
00161 <span class="comment"> * Arguments: n   the proposed FFT size</span>
00162 <span class="comment"> *           *pf  pointer to the FACT structure that will be filled in</span>
00163 <span class="comment"> *                by prepFFT for this FFT.</span>
00164 <span class="comment"> * returns:  size of FFT on success, </span>
00165 <span class="comment"> *           -1 on failure (out of memory; not logged)</span>
00166 <span class="comment"> *           -2 on other errors, logged here</span>
00167 <span class="comment"> */</span>
00168 
<a name="l00169"></a><a class="code" href="fft__prep_8c.html#a7">00169</a> <span class="keywordtype">long</span> <a class="code" href="fft__prep_8c.html#a7">prepFFT</a>( <span class="keywordtype">long</span> n, <a class="code" href="struct__FACT.html">FACT</a> **pf )
00170 {
00171   <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span>;
00172   <span class="keywordtype">int</span> rc;
00173   
00174   <span class="comment">/* Make sure we have enough entries in the list of FACT structures */</span>
00175   <span class="keywordflow">if</span> ( n &gt; <a class="code" href="fft__prep_8c.html#a0">last_nfft</a>)
00176   {
00177     <span class="keywordflow">if</span> ( (rc = <a class="code" href="fft__prep_8c.html#a6">buildFacList</a>( n )) &lt; 0 ) 
00178       <span class="keywordflow">return</span> rc;
00179   }
00180   
00181   <span class="comment">/* Walk the list, looking for `suitable', even nfft value */</span>
00182   <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00183   <span class="keywordflow">while</span>( (this-&gt;nfft &lt; n || this-&gt;nfft % 2 == 1) &amp;&amp; 
00184          this-&gt;next != (<a class="code" href="struct__FACT.html">FACT</a> *)NULL )
00185     <span class="keyword">this</span> = this-&gt;next;
00186 
00187   <span class="keywordflow">if</span> ( this-&gt;trigs == (<span class="keywordtype">double</span> *)NULL)
00188   {
00189     <span class="keywordflow">if</span> (<a class="code" href="fft__prep_8c.html#a4">makeTrigs</a>( <span class="keyword">this</span> ) &lt; 0)
00190       <span class="keywordflow">return</span> -1;
00191   }
00192   
00193   *pf = <span class="keyword">this</span>;
00194   <span class="keywordflow">return</span> this-&gt;nfft;
00195 }
00196 
00197   
<a name="l00198"></a><a class="code" href="fft__prep_8c.html#a8">00198</a> <span class="keywordtype">void</span> <a class="code" href="fft__prep_8c.html#a8">printFacList</a>( )
00199 {
00200   <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span>;
00201 
00202   <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00203   
00204   <span class="keywordflow">while</span>( <span class="keyword">this</span> != (<a class="code" href="struct__FACT.html">FACT</a> *)NULL)
00205   {
00206     <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">""</span>, <span class="stringliteral">"%6ld %2ld %2ld %2ld\n"</span>, this-&gt;nfft, this-&gt;fact_power[0], 
00207            this-&gt;fact_power[1], this-&gt;fact_power[2]);
00208     <span class="keyword">this</span> = this-&gt;next;
00209   }
00210   <span class="keywordflow">return</span>;
00211 }
00212 
00213 <span class="comment">/* trimFacList: remove unwanted entries from the beginning of the FFT list. */</span>
<a name="l00214"></a><a class="code" href="fft__prep_8c.html#a9">00214</a> <span class="keywordtype">void</span> <a class="code" href="fft__prep_8c.html#a9">trimFacList</a>( <span class="keywordtype">long</span> n )
00215 {
00216   <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span>;
00217   
00218   <span class="keywordflow">if</span> (n &gt;= <a class="code" href="fft__prep_8c.html#a0">last_nfft</a>)
00219     <span class="keywordflow">return</span>;
00220   
00221   <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00222   
00223   <span class="keywordflow">while</span>(this-&gt;nfft &lt; n)
00224   {
00225     <a class="code" href="fft__prep_8c.html#a1">fft_list</a> = this-&gt;next;
00226     free( <span class="keyword">this</span> );
00227     <span class="keyword">this</span> = <a class="code" href="fft__prep_8c.html#a1">fft_list</a>;
00228   }
00229   <span class="keywordflow">return</span>;
00230 }
00231 
00232 <span class="comment">/*</span>
00233 <span class="comment"> * makeTrigs: Set up the trigs and ifax arrays for fft99. </span>
00234 <span class="comment"> *    Returns: 0 on success</span>
00235 <span class="comment"> *            -1 when out of memory</span>
00236 <span class="comment"> */</span>
<a name="l00237"></a><a class="code" href="fft__prep_8c.html#a4">00237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fft__prep_8c.html#a4">makeTrigs</a>( <a class="code" href="struct__FACT.html">FACT</a> *<span class="keyword">this</span> )
00238 {
00239   <span class="keywordtype">long</span> ntrigs;
00240   
00241   ntrigs = 3 * this-&gt;nfft / 2 + 1;
00242   <span class="keywordflow">if</span> ( (this-&gt;trigs = (<span class="keywordtype">double</span> *)calloc(ntrigs, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>))) ==
00243        (<span class="keywordtype">double</span> *)NULL)
00244     <span class="keywordflow">return</span> -1;
00245   <span class="keywordflow">if</span> ( (this-&gt;ifax = (<span class="keywordtype">long</span> *)calloc(13, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))) == (<span class="keywordtype">long</span> *)NULL)
00246   {
00247     free(this-&gt;<a class="code" href="struct__FACT.html#m2">trigs</a>);
00248     this-&gt;trigs = (<span class="keywordtype">double</span> *)NULL;
00249     <span class="keywordflow">return</span> -1;
00250   }
00251   <a class="code" href="fft99_8c.html#a11">fftfax</a>(this-&gt;<a class="code" href="struct__FACT.html#m0">nfft</a>, this-&gt;<a class="code" href="struct__FACT.html#m3">ifax</a>, this-&gt;<a class="code" href="struct__FACT.html#m2">trigs</a>);
00252 
00253   <span class="keywordflow">return</span> 0;
00254 } 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:01 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
