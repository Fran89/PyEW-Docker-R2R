<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>sendmail.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>sendmail.c</h1><a href="sendmail_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: sendmail_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.3  2001/10/02 18:15:18  dietz</span>
00011 <span class="comment"> *     Changed to use COMPUTERNAME in the email sender field</span>
00012 <span class="comment"> *     instead of Earthworm.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *     Revision 1.2  2000/05/23 18:05:31  dietz</span>
00015 <span class="comment"> *     Changed blat sender to root@&lt;MailHost&gt;</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00018 <span class="comment"> *     Initial revision</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> */</span>
00022 
00023      <span class="comment">/*****************************************************************</span>
00024 <span class="comment">      *                            sendmail                           *</span>
00025 <span class="comment">      *                                                               *</span>
00026 <span class="comment">      *         Function to send email.  Windows NT version.          *</span>
00027 <span class="comment">      *                                                               *</span>
00028 <span class="comment">      *  This function requires a mail server computer.               *</span>
00029 <span class="comment">      *                                                               *</span>
00030 <span class="comment">      *  person:     List of email recipients                         *</span>
00031 <span class="comment">      *  nmail:      The number of recipients                         *</span>
00032 <span class="comment">      *  mailProg:   Mail program to use - for solaris compatibility  *</span>
00033 <span class="comment">      *  subject:    Subject of the message                           *</span>
00034 <span class="comment">      *  msg  :      The body of the email message                    *</span>
00035 <span class="comment">      *  msgPrefix : Prefix to the body of the message                *</span>
00036 <span class="comment">      *  msgSuffix : Suffix to the body of the message                *</span>
00037 <span class="comment">      *  mailServer: Computer that sends the mail message.            *</span>
00038 <span class="comment">      *                                                               *</span>
00039 <span class="comment">      *  Returns -1 if an error occurred, 0 otherwise                 *</span>
00040 <span class="comment">      *                                                               *</span>
00041 <span class="comment">      *  mailProg, subject, msgPrefix, and msgSuffix added by         *</span>
00042 <span class="comment">      *    Lucky Vidmar  Tue Jan 19 16:17:01 MST 1999                 *</span>
00043 <span class="comment">      *                                                               *</span>
00044 <span class="comment">      *****************************************************************/</span>
00045 
00046 <span class="preprocessor">#include &lt;string.h&gt;</span>
00047 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00048 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00049 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00050 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00051 
<a name="l00052"></a><a class="code" href="sendmail_8c.html#a0">00052</a> <span class="preprocessor">#define BUFFSIZE 200</span>
00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="sendmail_8c.html#a1">00054</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="sendmail_8c.html#a1">Sender</a> = NULL;
00055 
<a name="l00056"></a><a class="code" href="sendmail_8c.html#a2">00056</a> <span class="keywordtype">int</span> <a class="code" href="sendmail_8c.html#a2">SendMail</a>( <span class="keywordtype">char</span> person[][60], <span class="keywordtype">int</span> nmail, <span class="keywordtype">char</span> *mailProg, <span class="keywordtype">char</span> *subject, 
00057               <span class="keywordtype">char</span> *msg, <span class="keywordtype">char</span> *msgPrefix, <span class="keywordtype">char</span> *msgSuffix, <span class="keywordtype">char</span> *mailServer )
00058 {
00059    FILE                *fp;
00060    DWORD               pathSize;
00061    <span class="keywordtype">char</span>                tmp[<a class="code" href="sendmail_8c.html#a0">BUFFSIZE</a>];
00062    <span class="keywordtype">char</span>                pathBuffer[<a class="code" href="sendmail_8c.html#a0">BUFFSIZE</a>];
00063    <span class="keywordtype">char</span>                tempFilename[MAX_PATH];
00064    <span class="keywordtype">char</span>                commandLine[<a class="code" href="sendmail_8c.html#a0">BUFFSIZE</a>];
00065    STARTUPINFO         startUpInfo;
00066    BOOL                success;
00067    DWORD               priorityClass;
00068    PROCESS_INFORMATION procInfo;
00069    DWORD               exitCode;
00070    DWORD               rc;
00071    <span class="keywordtype">int</span>                 i;
00072 
00073 <span class="comment">/* Check arguments</span>
00074 <span class="comment">   ***************/</span>
00075    <span class="keywordflow">if</span> ( nmail &lt; 1 )
00076       <span class="keywordflow">return</span> -1;
00077 
00078 <span class="comment">/* Have Sender point to this computer's name</span>
00079 <span class="comment">   *****************************************/</span>
00080    <span class="keywordflow">if</span> ( <a class="code" href="sendmail_8c.html#a1">Sender</a> == NULL )  <a class="code" href="sendmail_8c.html#a1">Sender</a> = getenv( <span class="stringliteral">"COMPUTERNAME"</span> );
00081 
00082 <span class="comment">/* Get the path of the temporary file directory</span>
00083 <span class="comment">   ********************************************/</span>
00084    pathSize = GetTempPath( BUFFSIZE, pathBuffer );
00085    <span class="keywordflow">if</span> ( pathSize &lt; <a class="code" href="sendmail_8c.html#a0">BUFFSIZE</a> )
00086       pathBuffer[pathSize] = 0;
00087    <span class="keywordflow">else</span>
00088    {
00089       printf( <span class="stringliteral">"Error getting path of temporary file directory."</span> );
00090       <span class="keywordflow">return</span> -1;
00091    }
00092 
00093 <span class="comment">/* Create a unique file in the temporary file directory</span>
00094 <span class="comment">   ****************************************************/</span>
00095    <span class="keywordflow">if</span> ( GetTempFileName( pathBuffer, <span class="stringliteral">"mai"</span>, 0, tempFilename ) == 0 )
00096    {
00097       printf( <span class="stringliteral">"Error getting name of temporary file.\n"</span> );
00098       <span class="keywordflow">return</span> -1;
00099    }
00100 
00101 <span class="comment">/* Write the mail message to the temporary file</span>
00102 <span class="comment">   ********************************************/</span>
00103    fp = fopen( tempFilename, <span class="stringliteral">"w"</span> );
00104    <span class="keywordflow">if</span> ( fp == NULL )
00105    {
00106       printf( <span class="stringliteral">"Error opening the temporary file.\n"</span> );
00107       <span class="keywordflow">return</span> -1;
00108    }
00109  
00110    <span class="keywordflow">if</span> (msgPrefix != NULL)
00111        fputs( msgPrefix, fp );
00112 
00113    fputs( msg, fp );
00114 
00115    <span class="keywordflow">if</span> (msgSuffix != NULL)
00116        fputs( msgSuffix, fp );
00117 
00118    fclose( fp );
00119 
00120 <span class="comment">/* Build a command line for the Blat program, which sends</span>
00121 <span class="comment">   the temporary file to the mail server computer.</span>
00122 <span class="comment">   ******************************************************/</span>
00123    strcpy( commandLine, <span class="stringliteral">"blat "</span> );
00124    strcat( commandLine, tempFilename );
00125 
00126    <span class="keywordflow">if</span> (subject != NULL)
00127    {
00128        sprintf ( tmp, <span class="stringliteral">" -s \"%s\""</span>, subject );
00129        strcat( commandLine, tmp );
00130    }
00131 
00132    strcat( commandLine, <span class="stringliteral">" -f root@"</span> );
00133    strcat( commandLine, mailServer );
00134    strcat( commandLine, <span class="stringliteral">" -i "</span> );
00135    strcat( commandLine, Sender );
00136    strcat( commandLine, <span class="stringliteral">" -server "</span> );
00137    strcat( commandLine, mailServer );
00138    strcat( commandLine, <span class="stringliteral">" -t "</span> );
00139    strcat( commandLine, &amp;person[0][0] );
00140 
00141    <span class="keywordflow">for</span> ( i = 1; i &lt; nmail; i++ )
00142    {
00143       strcat( commandLine, <span class="stringliteral">","</span> );
00144       strcat( commandLine, &amp;person[i][0] );
00145    }
00146 
00147 <span class="comment">/* Invoked the Blat program</span>
00148 <span class="comment">   ************************/</span>
00149    GetStartupInfo( &amp;startUpInfo );
00150 
00151    priorityClass = GetPriorityClass( GetCurrentProcess() );
00152 
00153    success = CreateProcess( 0,
00154                             commandLine,      <span class="comment">/* Command line to invoke child */</span>
00155                             0, 0,                   <span class="comment">/* No security attributes */</span>
00156                             FALSE,                    <span class="comment">/* No inherited handles */</span>
00157                             0 |                <span class="comment">/* Child does not get a window */</span>
00158                             priorityClass,      <span class="comment">/* Same as priority of parent */</span>
00159                             0,              <span class="comment">/* Not passing environmental vars */</span>
00160                             0,                  <span class="comment">/* Current dir same as parent */</span>
00161                             &amp;startUpInfo,     <span class="comment">/* Attributes of process window */</span>
00162                             &amp;procInfo );       <span class="comment">/* Attributes of child process */</span>
00163    <span class="keywordflow">if</span> ( !success )
00164    {
00165       printf( <span class="stringliteral">"Error starting Blat: %d\n"</span>, GetLastError() );
00166       <span class="keywordflow">return</span> -1;
00167    }
00168 
00169 <span class="comment">/* Wait 5 minutes for Blat to complete.</span>
00170 <span class="comment">   Check the process exit code for abnormal termination.</span>
00171 <span class="comment">   ****************************************************/</span>
00172    rc = WaitForSingleObject( procInfo.hProcess, 300000 );
00173 
00174    <span class="keywordflow">if</span> ( rc == WAIT_FAILED )
00175    {
00176       printf( <span class="stringliteral">"Blat WaitForSingleObject() failed with error: %d\n"</span>, GetLastError() );
00177       <span class="keywordflow">return</span> -1;
00178    }
00179    <span class="keywordflow">if</span> ( rc == WAIT_TIMEOUT )
00180    {
00181       printf( <span class="stringliteral">"Error. Blat not completed within 5 minutes.\n"</span> );
00182       <span class="keywordflow">return</span> -1;
00183    }
00184    success = GetExitCodeProcess( procInfo.hProcess, &amp;exitCode );
00185    <span class="keywordflow">if</span> ( !success )
00186    {
00187       printf( <span class="stringliteral">"Error getting the Blat exit code: %d\n"</span>, GetLastError() );
00188       <span class="keywordflow">return</span> -1;
00189    }
00190    <span class="keywordflow">if</span> ( exitCode != 0 )
00191    {
00192       printf( <span class="stringliteral">"Blat failed.\n"</span> );
00193       <span class="keywordflow">return</span> -1;
00194    }
00195 
00196 <span class="comment">/* Delete the mail file</span>
00197 <span class="comment">   ********************/</span>
00198    success = DeleteFile( tempFilename );
00199    <span class="keywordflow">if</span> ( !success )
00200    {
00201       printf( <span class="stringliteral">"Error deleting temporary file: %s\n"</span>, tempFilename );
00202       <span class="keywordflow">return</span> -1;
00203    }
00204 
00205 <span class="comment">/* Everything went smoothly</span>
00206 <span class="comment">   ************************/</span>
00207    <span class="keywordflow">return</span> 0;
00208 }
00209 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:09 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
