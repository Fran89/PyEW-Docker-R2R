<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wave_client.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>wave_client.c</h1><a href="wave__client_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: wave__client_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.2  2001/04/17 17:30:42  davidk</span>
00011 <span class="comment"> *     added an explicit typecast to get rid of a compiler warning on NT.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00014 <span class="comment"> *     Initial revision</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> */</span>
00018 
00019 <span class="comment">/*</span>
00020 <span class="comment">   wave_client.c</span>
00021 <span class="comment"></span>
00022 <span class="comment">   Contains functions for connecting to a wave_server's socket, making</span>
00023 <span class="comment">   a request for a time-chunk of waveforms, and writing the requested</span>
00024 <span class="comment">   data to a disk file.  </span>
00025 <span class="comment">   Library routines for talking to the original "wave_server".</span>
00026 <span class="comment"></span>
00027 <span class="comment">   Returns the number of waveform messages received.</span>
00028 <span class="comment">*/</span>
00029 
00030 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00031 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="kom_8h.html">kom.h</a>&gt;</span>
00036 <span class="preprocessor">#include "<a class="code" href="wave__client_8h.html">wave_client.h</a>"</span>
00037 
<a name="l00038"></a><a class="code" href="wave__client_8c.html#a0">00038</a> <span class="preprocessor">#define MAX_MSG_LEN  126</span>
00039 <span class="preprocessor"></span>
00040 <span class="comment">/* Global variables</span>
00041 <span class="comment"> ******************/</span>
<a name="l00042"></a><a class="code" href="wave__client_8c.html#a1">00042</a> <span class="keyword">static</span> <span class="keywordtype">int</span>      <a class="code" href="wave__client_8c.html#a1">Config_Init</a> = 0;      <span class="comment">/* 1=config file has been read        */</span>
<a name="l00043"></a><a class="code" href="wave__client_8c.html#a2">00043</a> <span class="keyword">static</span> <span class="keyword">struct </span>hostent    *<a class="code" href="wave__client_8c.html#a2">Host</a>;       <span class="comment">/* Contains host ip address           */</span>
<a name="l00044"></a><a class="code" href="wave__client_8c.html#a3">00044</a> <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in <a class="code" href="wave__client_8c.html#a3">Sin</a>;        <span class="comment">/* Server's socket address stucture   */</span>
<a name="l00045"></a><a class="code" href="wave__client_8c.html#a4">00045</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      <a class="code" href="wave__client_8c.html#a4">Addr</a>;       <span class="comment">/* binary form of server's ip address */</span>
00046 
00047 <span class="comment">/*********************************************************</span>
00048 <span class="comment"> *                       wave_request                    *</span>
00049 <span class="comment"> *     Connects to socket, requests data, writes file    *</span>
00050 <span class="comment"> *********************************************************/</span>
<a name="l00051"></a><a class="code" href="wave__client_8c.html#a5">00051</a> <span class="keywordtype">int</span> <a class="code" href="wave__client_8c.html#a5">wave_request</a>( <span class="keywordtype">double</span>  ton,       <span class="comment">/* start-time of requested waveforms */</span>
00052                   <span class="keywordtype">double</span>  toff,      <span class="comment">/* end-time of requested waveforms   */</span>
00053                   <span class="keywordtype">char</span>   *pathfile ) <span class="comment">/* where to write file of waveforms  */</span>
00054 {
00055    <span class="keywordtype">char</span>          request[<a class="code" href="wave__client_8c.html#a0">MAX_MSG_LEN</a>];
00056    <span class="keywordtype">char</span>         *buf, *bufptr;
00057    FILE         *fp;
00058    <span class="keywordtype">long</span>          maxbuflen;
00059    <span class="keywordtype">long</span>          databuflen;
00060    <span class="keywordtype">long</span>          ntoget;
00061    <span class="keywordtype">long</span>          getatonce;
00062    <span class="keywordtype">int</span>           sd;                   <span class="comment">/* Socket descriptor */</span>
00063    <span class="keywordtype">int</span>           ir, nr;
00064    <span class="keywordtype">int</span>           ndatabuf, nbufrec;
00065    <span class="keywordtype">int</span>           length;
00066    <span class="keywordtype">int</span>           ret;
00067    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> inst, module, <a class="code" href="getutil_8c.html#a16">type</a>;   <span class="comment">/* logo of incoming waveform messages */</span>
00068    <span class="keywordtype">char</span>          c;
00069    <span class="keywordtype">int</span>           i, m, t;
00070 
00071 <span class="comment">/* Make sure configuration file has been read</span>
00072 <span class="comment"> ********************************************/</span>
00073    <span class="keywordflow">if</span> ( !<a class="code" href="wave__client_8c.html#a1">Config_Init</a> )
00074    {
00075       <span class="comment">/*printf("wave_request: Config file has not been read.\n" );*/</span> <span class="comment">/*DEBUG*/</span>
00076       <span class="keywordflow">return</span>( ERR_NOCONFIG );
00077    }
00078 
00079 <span class="comment">/* Open the file that will contain the trace data</span>
00080 <span class="comment"> ************************************************/</span>
00081    fp = fopen( pathfile, <span class="stringliteral">"wb"</span> );
00082    <span class="keywordflow">if</span> ( fp == NULL )
00083    {
00084       <span class="comment">/*printf("wave_request: Error opening output file &lt;%s&gt;\n",</span>
00085 <span class="comment">              pathfile );*/</span> <span class="comment">/*DEBUG*/</span>
00086       <span class="keywordflow">return</span>( ERR_FILEIO );
00087    }
00088 
00089 <span class="comment">/* Set up socket connection here</span>
00090 <span class="comment"> *******************************/</span>
00091    <span class="keywordflow">if</span> ( (sd = socket( AF_INET, SOCK_STREAM, 0 ) ) == -1 )
00092    {
00093       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_request: Socket call failed.\n"</span> );
00094       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_request: Socket call failed"</span> );
00095       fclose( fp );
00096       <span class="keywordflow">return</span>( ERR_SOCKET );
00097    }
00098 
00099    <span class="keywordflow">if</span> ( connect( sd, (<span class="keyword">struct</span> sockaddr *)&amp;Sin, <span class="keyword">sizeof</span>(Sin) ) == -1 )
00100    {
00101       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_request: Connect to wave_server host failed.\n"</span> );
00102       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_request: Connect to wave_server host failed"</span> );
00103       ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00104       <span class="keywordflow">goto</span> done;
00105    }
00106 
00107 <span class="comment">/* Build and send a request to the wave_server</span>
00108 <span class="comment"> *********************************************/</span>
00109    sprintf( request, <span class="stringliteral">"REQ: %15.2f %15.2f\n"</span>, ton, toff );
00110    length = (int) strlen(request);
00111    <span class="keywordflow">if</span> ( send( sd, request, length, 0 ) == -1 )
00112    {
00113       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_request: Error sending waveform request.\n"</span> );
00114       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_request: Error sending waveform request"</span> );
00115       ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00116       <span class="keywordflow">goto</span> done;
00117    }
00118 
00119 <span class="comment">/* Start reading the socket, one character at a time</span>
00120 <span class="comment"> ***************************************************/</span>
00121    ir = 0;
00122    <span class="keywordflow">do</span>
00123    {
00124       <span class="keywordflow">if</span> ( ir == <a class="code" href="wave__client_8c.html#a0">MAX_MSG_LEN</a> ) {        <span class="comment">/* stop if there's no more room */</span>
00125          <span class="comment">/*printf("wave_request: wave_server reply too long.\n ");*/</span> <span class="comment">/*DEBUG*/</span>
00126          ret = <a class="code" href="wave__client_8h.html#a5">ERR_OVRFLW</a>;
00127          <span class="keywordflow">goto</span> done;
00128       }
00129       nr = recv( sd, &amp;c, 1, 0 );        <span class="comment">/* try to get a char from socket*/</span>
00130       <span class="keywordflow">if</span> ( nr == 1 ) {                  <span class="comment">/* got a character; save it     */</span>
00131          request[ir++] = c;             
00132       }
00133       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( nr == -1 ) {            <span class="comment">/* trouble reading socket       */</span>
00134          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: Error on socket recv\n"</span> );
00135          ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00136          <span class="keywordflow">goto</span> done;
00137       }
00138    } <span class="keywordflow">while</span>( c != <span class="charliteral">'\n'</span> );                <span class="comment">/* last char of reply           */</span>
00139    request[ir] = <span class="charliteral">'\0'</span>;                  <span class="comment">/* null-terminate the reply     */</span>
00140 
00141 <span class="comment">/* Process inquiry reply from wave_server</span>
00142 <span class="comment"> ****************************************/</span>
00143    <span class="keywordflow">if</span>( sscanf( request, <span class="stringliteral">"%d %d %d %ld %d"</span>,
00144                &amp;i, &amp;m, &amp;t, &amp;maxbuflen, &amp;ndatabuf ) &lt; 5 )
00145    {
00146         <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>,<span class="stringliteral">"wave_request: error decoding wave_server reply:\n%s\n"</span>,
00147                request );
00148         inst     = 0;
00149         module   = 0;
00150         <a class="code" href="getutil_8c.html#a16">type</a>     = 0;
00151         ndatabuf = 0;
00152         ret      = <a class="code" href="wave__client_8h.html#a7">ERR_STRIO</a>;
00153         <span class="keywordflow">goto</span> done;
00154    }
00155    <span class="keywordflow">if</span> ( i&lt;256 &amp;&amp; i&gt;0 ) {
00156         inst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) i;
00157    }
00158    <span class="keywordflow">else</span> {
00159         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: invalid installation id &lt;%d&gt;\n"</span>, i );
00160         inst = 0;
00161    }
00162    <span class="keywordflow">if</span> ( m&lt;256 &amp;&amp; m&gt;0 ) {
00163         module = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) m;
00164    }
00165    <span class="keywordflow">else</span> {
00166         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: invalid module id &lt;%d&gt;\n"</span>, m );
00167         module = 0;
00168    }
00169    <span class="keywordflow">if</span> ( t&lt;256 &amp;&amp; t&gt;0 ) {
00170         <a class="code" href="getutil_8c.html#a16">type</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) t;
00171    }
00172    <span class="keywordflow">else</span> {
00173         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: invalid msg type &lt;%d&gt;\n"</span>, t );
00174         <a class="code" href="getutil_8c.html#a16">type</a> = 0;
00175    }
00176    <span class="comment">/*printf("wave_request: accepting %d msg(s) of logo Inst:%d Mod:%d Type:%d\n",</span>
00177 <span class="comment">           ndatabuf, (int) inst, (int) module, (int) type );*/</span> <span class="comment">/*DEBUG*/</span>
00178 
00179 <span class="comment">/* Bail out if there's no data coming</span>
00180 <span class="comment"> ************************************/</span>
00181    <span class="keywordflow">if</span> ( ndatabuf == 0 )
00182    {
00183       <span class="comment">/*printf("wave_request: Requested time period not in tank\n");*/</span> <span class="comment">/*DEBUG*/</span>
00184       ret = <a class="code" href="wave__client_8h.html#a4">ERR_NODATA</a>;
00185       <span class="keywordflow">goto</span> done;
00186    }
00187 
00188 <span class="comment">/* Allocate memory for incoming messages</span>
00189 <span class="comment"> ***************************************/</span>
00190    buf = (<span class="keywordtype">char</span> *) malloc( (size_t) maxbuflen );
00191    <span class="keywordflow">if</span> ( buf == (<span class="keywordtype">char</span> *)NULL )
00192    {
00193       <span class="comment">/*printf("wave_request: Error allocating memory buffer.\n");*/</span> <span class="comment">/*DEBUG*/</span>
00194       ret = <a class="code" href="wave__client_8h.html#a0">ERR_ALLOC</a>;
00195       <span class="keywordflow">goto</span> done;
00196    }
00197 
00198 <span class="comment">/* Loop reading messages from socket</span>
00199 <span class="comment"> ***********************************/</span>
00200    nbufrec = 0;
00201    <span class="keywordflow">do</span>
00202    {
00203 
00204    <span class="comment">/* Read the size of the next message from the socket</span>
00205 <span class="comment">    ***************************************************/</span>
00206       ir = 0;
00207       <span class="keywordflow">do</span>
00208       {
00209          <span class="keywordflow">if</span> ( ir == maxbuflen ) {       <span class="comment">/* stop if there's no more room */</span>
00210              ret = <a class="code" href="wave__client_8h.html#a5">ERR_OVRFLW</a>;
00211              <span class="keywordflow">goto</span> almostdone;
00212          }
00213          nr = recv( sd, &amp;c, 1, 0 );     <span class="comment">/* try to get a char from socket*/</span>
00214          <span class="keywordflow">if</span> ( nr == 1 ) {               <span class="comment">/* got a character; save it     */</span>
00215              buf[ir++] = c;             
00216          }
00217          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( nr == -1 ) {         <span class="comment">/* trouble reading socket       */</span>
00218              <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: Error on socket recv\n"</span> );
00219              ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00220              <span class="keywordflow">goto</span> almostdone;
00221          }
00222       } <span class="keywordflow">while</span>( c != <span class="charliteral">'\n'</span> );             <span class="comment">/* last char of reply           */</span>
00223       buf[ir] = <span class="charliteral">'\0'</span>;                   <span class="comment">/* null-terminate the reply     */</span>
00224 
00225       sscanf( buf, <span class="stringliteral">"%ld"</span>, &amp;databuflen );
00226       <span class="comment">/*printf( "wave_request: incoming msg[%ld]\n", databuflen );*/</span> <span class="comment">/*DEBUG*/</span>
00227 
00228       <span class="keywordflow">if</span>( databuflen &gt; maxbuflen )
00229       {
00230           <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,
00231                  <span class="stringliteral">"wave_request: Data_buffer:%ld bytes &gt; max_size:%ld\n"</span>,
00232                   databuflen, maxbuflen );
00233           ret = <a class="code" href="wave__client_8h.html#a5">ERR_OVRFLW</a>;
00234           <span class="keywordflow">goto</span> almostdone;
00235       }
00236 
00237    <span class="comment">/* Read one waveform message from the server</span>
00238 <span class="comment">    *******************************************/</span>
00239       ntoget = databuflen;
00240       bufptr = buf;
00241       <span class="keywordflow">while</span> ( ntoget &gt; 0 )
00242       {
00243       <span class="comment">/* warning: trouble trying to recv 32 kbytes or more at once */</span>
00244       <span class="comment">/*          (recv dies with an "invalid argument" error)     */</span>
00245          getatonce = ( (ntoget&lt;32000) ? ntoget : 32000 );
00246          nr = recv( sd, bufptr, getatonce, 0 );
00247          <span class="keywordflow">if</span> ( nr == -1 )
00248          {
00249             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_request: Error reading socket.\n"</span> );
00250             <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_request: Error reading socket"</span> );
00251             ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00252             <span class="keywordflow">goto</span> almostdone;
00253          }
00254          bufptr += nr;
00255          ntoget -= nr;
00256       }
00257 
00258    <span class="comment">/* Get end-of-message flag; make sure it's a newline!</span>
00259 <span class="comment">    ****************************************************/</span>
00260       nr = recv( sd, &amp;c, 1, 0 );
00261       <span class="keywordflow">if</span> ( nr != 1  ||  c != <span class="charliteral">'\n'</span> )
00262       {
00263          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_request: Error on recv end-of-message flag\n"</span> );
00264          ret = <a class="code" href="wave__client_8h.html#a2">ERR_SOCKET</a>;
00265          <span class="keywordflow">goto</span> almostdone;
00266       }
00267 
00268    <span class="comment">/* Write this data buffer to the disk file</span>
00269 <span class="comment">    *****************************************/</span>
00270       <span class="keywordflow">if</span> ( fwrite( buf, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), databuflen, fp ) != (size_t)databuflen )
00271       {
00272          <span class="comment">/*printf("wave_request: Error writing to file.\n");*/</span> <span class="comment">/*DEBUG*/</span>
00273          ret = <a class="code" href="wave__client_8h.html#a3">ERR_FILEIO</a>;
00274          <span class="keywordflow">goto</span> almostdone;
00275       }
00276 
00277    } <span class="keywordflow">while</span> ( ++nbufrec &lt; ndatabuf );
00278 
00279 <span class="comment">/* Received all the data we requested</span>
00280 <span class="comment"> ************************************/</span>
00281    ret = nbufrec;
00282 
00283 almostdone:
00284    free( buf );
00285 
00286 done:
00287    <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00288    fclose( fp );
00289    <span class="keywordflow">return</span>( ret );
00290 }
00291 
00292 
00293 <span class="comment">/********************************************************</span>
00294 <span class="comment"> *                       wave_inquire                   *</span>
00295 <span class="comment"> *     Asks the wave_server for the time range and      *</span>
00296 <span class="comment"> *     and the logo (installation, module and message   *</span>
00297 <span class="comment"> *     type) of the data that's stored in the tank      *</span>
00298 <span class="comment"> ********************************************************/</span>
<a name="l00299"></a><a class="code" href="wave__client_8c.html#a6">00299</a> <span class="keywordtype">int</span> <a class="code" href="wave__client_8c.html#a6">wave_inquire</a>( <span class="keywordtype">double</span>        *tstart, <span class="comment">/* start-time of first buffer in tank */</span>
00300                   <span class="keywordtype">double</span>        *tend,   <span class="comment">/* start-time of last buffer in tank  */</span>
00301                   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *inst,   <span class="comment">/* source installation of served data */</span>
00302                   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *module, <span class="comment">/* source module of served waveforms  */</span>
00303                   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *type )  <span class="comment">/* type of waveform msg being served  */</span>
00304 {
00305    <span class="keywordtype">int</span>     sd;                   <span class="comment">/* Socket descriptor */</span>
00306    <span class="keywordtype">int</span>     i, m, t;
00307    <span class="keywordtype">char</span>    msg[<a class="code" href="wave__client_8c.html#a0">MAX_MSG_LEN</a>];
00308    <span class="keywordtype">char</span>    c;
00309    <span class="keywordtype">int</span>     length, nrec;
00310    <span class="keywordtype">int</span>     ir;
00311 
00312 <span class="comment">/* Make sure configuration file has been read</span>
00313 <span class="comment"> ********************************************/</span>
00314    <span class="keywordflow">if</span> ( !<a class="code" href="wave__client_8c.html#a1">Config_Init</a> )
00315    {
00316       <span class="comment">/*printf("wave_inquire: Configuration file has not been read.\n");*/</span> <span class="comment">/*DEBUG*/</span>
00317       <span class="keywordflow">return</span>( ERR_NOCONFIG );
00318    }
00319 
00320 <span class="comment">/* Set up socket connection here</span>
00321 <span class="comment"> *******************************/</span>
00322    <span class="keywordflow">if</span> ( (sd = socket( AF_INET, SOCK_STREAM, 0 ) ) == -1 )
00323    {
00324       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_inquire: Socket call failed.\n"</span> );
00325       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_inquire: Socket call failed"</span> );
00326       <span class="keywordflow">return</span>( ERR_SOCKET );
00327    }
00328 
00329    <span class="keywordflow">if</span> ( connect( sd, (<span class="keyword">struct</span> sockaddr *)&amp;Sin, <span class="keyword">sizeof</span>(Sin) ) == -1 )
00330    {
00331       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_inquire: Connect to wave_server host failed.\n"</span> );
00332       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_inquire: Connect to wave_server host failed"</span> );
00333       <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00334       <span class="keywordflow">return</span>( ERR_SOCKET );
00335    }
00336 
00337 <span class="comment">/* Send an inquiry to the wave_server</span>
00338 <span class="comment"> ************************************/</span>
00339    sprintf( msg, <span class="stringliteral">"INQ:\n\0"</span> );
00340    length = (int) strlen( msg );
00341    <span class="keywordflow">if</span> ( send( sd, msg, length, 0 ) == -1 )
00342    {
00343       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_inquire: Error sending inquiry.\n"</span> );
00344       <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_inquire: Error sending inquiry"</span> );
00345       <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00346       <span class="keywordflow">return</span>( ERR_SOCKET );
00347    }
00348 
00349 <span class="comment">/* Start reading the socket.</span>
00350 <span class="comment"> ***************************/</span>
00351    nrec = 0;
00352    <span class="keywordflow">do</span>
00353    {
00354       <span class="keywordflow">if</span> ( nrec == <a class="code" href="wave__client_8c.html#a0">MAX_MSG_LEN</a> ) {      <span class="comment">/* stop if there's no more room */</span>
00355          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_inquire: wave_server reply too long.\n "</span> );
00356          <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00357          <span class="keywordflow">return</span>( ERR_OVRFLW );
00358       }
00359       ir = recv( sd, &amp;c, 1, 0 );        <span class="comment">/* try to get a char from socket*/</span>
00360       <span class="keywordflow">if</span> ( ir == 1 ) {                  <span class="comment">/* got a character; save it     */</span>
00361          msg[nrec++] = c;       
00362       }
00363       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ir == -1 ) {            <span class="comment">/* trouble reading socket       */</span>
00364          <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"t"</span>, <span class="stringliteral">"wave_inquire: Error on socket recv\n"</span> );
00365          <a class="code" href="socket__ew_8c.html#a4">SocketPerror</a>( <span class="stringliteral">"wave_inquire: Error on socket recv"</span> );
00366          <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00367          <span class="keywordflow">return</span>( ERR_SOCKET );
00368       }
00369    } <span class="keywordflow">while</span>( c != <span class="charliteral">'\n'</span> );                <span class="comment">/* last char of reply           */</span>
00370    msg[nrec] = <span class="charliteral">'\0'</span>;                    <span class="comment">/* null-terminate reply         */</span>
00371 
00372 <span class="comment">/* Process inquiry reply from wave_server</span>
00373 <span class="comment"> ****************************************/</span>
00374    <span class="keywordflow">if</span>( sscanf( msg, <span class="stringliteral">"%lf %lf %d %d %d"</span>, tstart, tend, &amp;i, &amp;m, &amp;t ) &lt; 5 )
00375    {
00376         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_inquire: error decoding wave_server reply:\n%s\n"</span>,
00377                msg );
00378        *tstart = 0.;
00379        *tend   = 0.;
00380        *inst   = 0;
00381        *module = 0;
00382        *<a class="code" href="getutil_8c.html#a16">type</a>   = 0;
00383         <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00384         <span class="keywordflow">return</span>( ERR_STRIO );
00385    }
00386    <span class="keywordflow">if</span> ( i&lt;256 &amp;&amp; i&gt;0 ) {
00387        *inst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) i;
00388    }
00389    <span class="keywordflow">else</span> {
00390         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_inquire: invalid installation id &lt;%d&gt;\n"</span>, i );
00391        *inst = 0;
00392    }
00393    <span class="keywordflow">if</span> ( m&lt;256 &amp;&amp; m&gt;0 ) {
00394        *module = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) m;
00395    }
00396    <span class="keywordflow">else</span> {
00397         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_inquire: invalid module id &lt;%d&gt;\n"</span>, m );
00398        *module = 0;
00399    }
00400    <span class="keywordflow">if</span> ( t&lt;256 &amp;&amp; t&gt;0 ) {
00401        *<a class="code" href="getutil_8c.html#a16">type</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) t;
00402    }
00403    <span class="keywordflow">else</span> {
00404         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wave_inquire: invalid msg type &lt;%d&gt;\n"</span>, t );
00405        *<a class="code" href="getutil_8c.html#a16">type</a> = 0;
00406    }
00407    <a class="code" href="socket__ew_8c.html#a3">SocketClose</a>( sd );
00408    <span class="keywordflow">return</span>( 0 );
00409 }
00410 
00411 
00412 <span class="comment">/***********************************************************************</span>
00413 <span class="comment"> * wave_client_config()  processes command file using kom.c functions  *</span>
00414 <span class="comment"> *                    exits if any errors are encountered              *</span>
00415 <span class="comment"> ***********************************************************************/</span>
<a name="l00416"></a><a class="code" href="wave__client_8c.html#a7">00416</a> <span class="keywordtype">void</span> <a class="code" href="wave__client_8c.html#a7">wave_client_config</a>( <span class="keywordtype">char</span> *configfile )
00417 {
00418    <span class="keywordtype">int</span>      ncommand;   <span class="comment">/* # of required commands you expect to process   */</span>
00419    <span class="keywordtype">char</span>     init[10];   <span class="comment">/* init flags, one byte for each required command */</span>
00420    <span class="keywordtype">int</span>      nmiss;      <span class="comment">/* number of required commands that were missed   */</span>
00421    <span class="keywordtype">char</span>    *<a class="code" href="kom_8c.html#a2">com</a>;
00422    <span class="keywordtype">char</span>    *str;
00423    <span class="keywordtype">int</span>      nfiles;
00424    <span class="keywordtype">int</span>      success;
00425    <span class="keywordtype">int</span>      i;
00426 
00427 <span class="comment">/* Set to zero one init flag for each required command</span>
00428 <span class="comment"> *****************************************************/</span>
00429    ncommand = 2;
00430    <span class="keywordflow">for</span>( i=0; i&lt;ncommand; i++ )  init[i] = 0;
00431 
00432 <span class="comment">/* Open the main configuration file</span>
00433 <span class="comment"> **********************************/</span>
00434    nfiles = <a class="code" href="kom_8c.html#a5">k_open</a>( configfile );
00435    <span class="keywordflow">if</span> ( nfiles == 0 ) {
00436         fprintf( stderr,
00437                 <span class="stringliteral">"wave_client: Error opening command file &lt;%s&gt;; exitting!\n"</span>,
00438                  configfile );
00439         exit( -1 );
00440    }
00441 
00442 <span class="comment">/* Process all command files</span>
00443 <span class="comment"> ***************************/</span>
00444    <span class="keywordflow">while</span>(nfiles &gt; 0)   <span class="comment">/* While there are command files open */</span>
00445    {
00446         <span class="keywordflow">while</span>(<a class="code" href="kom_8c.html#a14">k_rd</a>())        <span class="comment">/* Read next line from active file  */</span>
00447         {
00448             <a class="code" href="kom_8c.html#a2">com</a> = <a class="code" href="kom_8c.html#a16">k_str</a>();         <span class="comment">/* Get the first token from line */</span>
00449 
00450         <span class="comment">/* Ignore blank lines &amp; comments</span>
00451 <span class="comment">         *******************************/</span>
00452             <span class="keywordflow">if</span>( !<a class="code" href="kom_8c.html#a2">com</a> )           <span class="keywordflow">continue</span>;
00453             <span class="keywordflow">if</span>( <a class="code" href="kom_8c.html#a2">com</a>[0] == <span class="charliteral">'#'</span> )  <span class="keywordflow">continue</span>;
00454 
00455         <span class="comment">/* Open a nested configuration file</span>
00456 <span class="comment">         **********************************/</span>
00457             <span class="keywordflow">if</span>( <a class="code" href="kom_8c.html#a2">com</a>[0] == <span class="charliteral">'@'</span> ) {
00458                success = nfiles+1;
00459                nfiles  = <a class="code" href="kom_8c.html#a5">k_open</a>(&amp;com[1]);
00460                <span class="keywordflow">if</span> ( nfiles != success ) {
00461                   fprintf( stderr,
00462                           <span class="stringliteral">"wave_client: Error opening command file &lt;%s&gt;; exitting!\n"</span>,
00463                            &amp;com[1] );
00464                   exit( -1 );
00465                }
00466                <span class="keywordflow">continue</span>;
00467             }
00468 
00469         <span class="comment">/* Process anything else as a command</span>
00470 <span class="comment">         ************************************/</span>
00471             <span class="comment">/* Read the wave_server's host name</span>
00472 <span class="comment">             **********************************/</span>
00473    <span class="comment">/*0*/</span>    <span class="keywordflow">if</span>( <a class="code" href="kom_8c.html#a11">k_its</a>( <span class="stringliteral">"ServerIPAdr"</span> ) )
00474             {
00475                 str = <a class="code" href="kom_8c.html#a16">k_str</a>();
00476                 <span class="keywordflow">if</span>(str) strcpy( ServerIPAdr, str );
00477                 init[0] = 1;
00478             }
00479             <span class="comment">/* Read the port number to find waveform data on</span>
00480 <span class="comment">             ***********************************************/</span>
00481    <span class="comment">/*1*/</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="kom_8c.html#a11">k_its</a>( <span class="stringliteral">"ServerPort"</span> ) )
00482             {
00483                 ServerPort = <a class="code" href="kom_8c.html#a10">k_int</a>();
00484                 init[1] = 1;
00485             }
00486             <span class="comment">/* Command not recognized</span>
00487 <span class="comment">             ************************/</span>
00488             <span class="keywordflow">else</span>
00489             {
00490                 fprintf(stderr,
00491                        <span class="stringliteral">"wave_client: &lt;%s&gt; unknown command in &lt;%s&gt;.\n"</span>,
00492                         com, configfile );
00493                 <span class="keywordflow">continue</span>;
00494             }
00495 
00496         <span class="comment">/* See if there were any errors processing the command</span>
00497 <span class="comment">         *****************************************************/</span>
00498             <span class="keywordflow">if</span>( <a class="code" href="kom_8c.html#a9">k_err</a>() ) {
00499                fprintf( stderr,
00500                        <span class="stringliteral">"wave_client: Bad &lt;%s&gt; command in &lt;%s&gt;; exitting!\n"</span>,
00501                         com, configfile );
00502                exit( -1 );
00503             }
00504         }
00505         nfiles = <a class="code" href="kom_8c.html#a6">k_close</a>();
00506    }
00507 
00508 <span class="comment">/* After all files are closed, check init flags for missed commands</span>
00509 <span class="comment"> ******************************************************************/</span>
00510    nmiss = 0;
00511    <span class="keywordflow">for</span> ( i=0; i&lt;ncommand; i++ )  <span class="keywordflow">if</span>( !init[i] ) nmiss++;
00512    <span class="keywordflow">if</span> ( nmiss ) {
00513        fprintf( stderr, <span class="stringliteral">"wave_client: ERROR, no "</span> );
00514        <span class="keywordflow">if</span> ( !init[0] )  fprintf( stderr, <span class="stringliteral">"&lt;ServerIPAdr&gt; "</span> );
00515        <span class="keywordflow">if</span> ( !init[1] )  fprintf( stderr, <span class="stringliteral">"&lt;ServerPort&gt; "</span>   );
00516        fprintf( stderr, <span class="stringliteral">"command(s) in &lt;%s&gt;; exitting!\n"</span>, configfile );
00517        exit( -1 );
00518    }
00519 
00520 <span class="comment">/* Set up socket address structure for wave_server's machine</span>
00521 <span class="comment"> ***********************************************************/</span>
00522    <span class="keywordflow">if</span>((int)(<a class="code" href="wave__client_8c.html#a4">Addr</a> = inet_addr(ServerIPAdr)) == -1)
00523    {
00524       fprintf( stderr,
00525               <span class="stringliteral">"wave_client: inet_addr failed for ServerIPAdr &lt;%s&gt;\n"</span>,
00526               ServerIPAdr );
00527       exit( -1 );
00528    }
00529 
00530    <a class="code" href="wave__client_8c.html#a2">Host</a> = gethostbyaddr((<span class="keywordtype">char</span> *)&amp;Addr, <span class="keyword">sizeof</span>(Addr), AF_INET);
00531    <span class="keywordflow">if</span>(<a class="code" href="wave__client_8c.html#a2">Host</a> == NULL)
00532    {
00533       fprintf( stderr,
00534               <span class="stringliteral">"wave_client: gethostbyaddr failed for ServerIPAdr &lt;%s&gt;\n"</span>,
00535                ServerIPAdr );
00536       exit( -1 );
00537    }
00538    memset( (<span class="keywordtype">char</span> *) &amp;Sin, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(Sin) );
00539    memcpy( (<span class="keywordtype">char</span> *) &amp;<a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_addr, <a class="code" href="wave__client_8c.html#a2">Host</a>-&gt;h_addr, <a class="code" href="wave__client_8c.html#a2">Host</a>-&gt;h_length );
00540    <a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_family = AF_INET;
00541    <a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_port   = htons( (<span class="keywordtype">short</span>)ServerPort );
00542 
00543 <span class="comment">/* Set configuration flag</span>
00544 <span class="comment"> ************************/</span>
00545    <a class="code" href="wave__client_8c.html#a1">Config_Init</a> = 1;
00546 
00547    <span class="keywordflow">return</span>;
00548 }
00549 
00550 <span class="comment">/***********************************************************************</span>
00551 <span class="comment"> * wave_client_setup()  Initializes or resets the global variables     *</span>
00552 <span class="comment"> *                      ServerIPAdr &amp; ServerPort used by wave_client   *</span>
00553 <span class="comment"> *                      routines to connect to a wave_server           *</span>
00554 <span class="comment"> ***********************************************************************/</span>
<a name="l00555"></a><a class="code" href="wave__client_8c.html#a8">00555</a> <span class="keywordtype">int</span> <a class="code" href="wave__client_8c.html#a8">wave_client_setup</a>( <span class="keywordtype">char</span> *ipadr,    <span class="comment">/* server's IP address    */</span>
00556                        <span class="keywordtype">int</span>   port )    <span class="comment">/* server's port number   */</span>
00557 {
00558 <span class="comment">/* Transfer arguments to wave_client globals</span>
00559 <span class="comment"> *******************************************/</span>
00560      strcpy( ServerIPAdr, ipadr );
00561      ServerPort = port;
00562 
00563 <span class="comment">/* Set up socket address structure for wave_server's machine</span>
00564 <span class="comment"> ***********************************************************/</span>
00565    <span class="keywordflow">if</span>((int)(<a class="code" href="wave__client_8c.html#a4">Addr</a> = inet_addr(ServerIPAdr)) == -1)
00566    {
00567       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>,
00568              <span class="stringliteral">"wave_client: inet_addr failed for ServerIPAdr &lt;%s&gt;\n"</span>,
00569               ServerIPAdr );
00570       <span class="keywordflow">return</span>( -1 );
00571    }
00572 
00573    <a class="code" href="wave__client_8c.html#a2">Host</a> = gethostbyaddr((<span class="keywordtype">char</span> *)&amp;Addr, <span class="keyword">sizeof</span>(Addr), AF_INET);
00574    <span class="keywordflow">if</span>(<a class="code" href="wave__client_8c.html#a2">Host</a> == NULL)
00575    {
00576       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"et"</span>,
00577              <span class="stringliteral">"wave_client: gethostbyaddr failed for ServerIPAdr &lt;%s&gt;\n"</span>,
00578               ServerIPAdr );
00579       <span class="keywordflow">return</span>( -1 );
00580    }
00581    memset( (<span class="keywordtype">char</span> *) &amp;Sin, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(Sin) );
00582    memcpy( (<span class="keywordtype">char</span> *) &amp;<a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_addr, <a class="code" href="wave__client_8c.html#a2">Host</a>-&gt;h_addr, <a class="code" href="wave__client_8c.html#a2">Host</a>-&gt;h_length );
00583    <a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_family = AF_INET;
00584    <a class="code" href="wave__client_8c.html#a3">Sin</a>.sin_port   = htons( (<span class="keywordtype">short</span>)ServerPort );
00585 
00586 <span class="comment">/* Set configuration flag</span>
00587 <span class="comment"> ************************/</span>
00588    <a class="code" href="wave__client_8c.html#a1">Config_Init</a> = 1;
00589 
00590    <span class="keywordflow">return</span>( 0 );
00591 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:13 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
