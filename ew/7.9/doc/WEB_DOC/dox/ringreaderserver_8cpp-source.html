<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ringreaderserver.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ringreaderserver.cpp</h1><a href="ringreaderserver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#include "<a class="code" href="ringreaderserver_8h.html">ringreaderserver.h</a>"</span>
00003 
00004 <span class="comment">//---------------------------------------------------------------------------</span>
00005 
00006 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="worm__exceptions_8h.html">worm_exceptions.h</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="comfile_8h.html">comfile.h</a>&gt;</span>
00009 
00010 <span class="preprocessor">#pragma package(smart_init)</span>
00011 <span class="preprocessor"></span>
00012 
00013 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00014"></a><a class="code" href="classRingReaderServer.html#a1">00014</a> <a class="code" href="classRingReaderServer.html#a1">RingReaderServer::RingReaderServer</a>()
00015 {
00016    <a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00017    <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00018    <a class="code" href="classRingReaderServer.html#o0">MaxMessageLength</a> = 0;
00019    <a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a> = NULL;
00020    <a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a> = 0;
00021 }
00022 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00023"></a><a class="code" href="classRingReaderServer.html#a2">00023</a> <a class="code" href="classRingReaderServer.html#a2">RingReaderServer::~RingReaderServer</a>()
00024 {
00025    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> != <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> )
00026    {
00027       <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00028       {
00029          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;InputRegion );
00030          <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00031       }
00032    }
00033    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a> != NULL )
00034    {
00035       <span class="keyword">delete</span>( MessageBuffer );
00036    }
00037 }
00038 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00039"></a><a class="code" href="classRingReaderServer.html#a0">00039</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classRingReaderServer.html#a0">RingReaderServer::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00040 {
00041    <span class="comment">// Do not manipulate ConfigState herein.</span>
00042    <span class="comment">//</span>
00043    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_handled = <a class="code" href="classWormServerBase.html#a0">WormServerBase::HandleConfigLine</a>(p_parser);
00044 
00045    <span class="keywordflow">if</span> ( r_handled == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00046    {
00047       <span class="comment">// base class didn't use it, check if this class does</span>
00048 
00049       <span class="keywordtype">char</span> * _token;
00050 
00051       <span class="keywordflow">try</span>
00052       {
00053          <span class="keywordflow">do</span>
00054          {
00055 
00056             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"ServeLogo"</span>) )
00057             {
00058                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00059 
00060                <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a> == <a class="code" href="mfc__dlog__modl__base_8h.html#a6">SERVE_MAX_LOGOS</a> )
00061                {
00062                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Attempt to load too many &lt;ServeLogo&gt; lines"</span>);
00063                }
00064 
00065                <span class="comment">// ServeLogo     INST_WILDCARD   MOD_GLASS       TYPE_WILDCARD</span>
00066 
00067                <span class="comment">// INSTALLATION</span>
00068 
00069                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00070 
00071                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00072                {
00073                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;ServeLogo&gt; line (no installation)"</span>);
00074                }
00075 
00076                <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].instid = <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(_token);
00077 
00078                <span class="keywordflow">if</span> (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].type == <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(<span class="stringliteral">"INST_WILDCARD"</span>)
00079                    &amp;&amp; strcmp(_token, <span class="stringliteral">"INST_WILDCARD"</span>) != 0
00080                   )
00081                {
00082                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized installation id: "</span>);
00083                   _expt += _token;
00084                   _expt += <span class="stringliteral">" in &lt;ServeLogo&gt; line"</span>;
00085                   <span class="keywordflow">throw</span> _expt;
00086                }
00087 
00088                <span class="comment">// MODULE</span>
00089 
00090                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00091 
00092                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00093                {
00094                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;ServeLogo&gt; line (no module)"</span>);
00095                }
00096 
00097                <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].mod = <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(_token);
00098 
00099                <span class="keywordflow">if</span> (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].mod == <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(<span class="stringliteral">"MOD_WILDCARD"</span>)
00100                    &amp;&amp; strcmp(_token, <span class="stringliteral">"MOD_WILDCARD"</span>) != 0
00101                   )
00102                {
00103                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized module id: "</span>);
00104                   _expt += _token;
00105                   _expt += <span class="stringliteral">" in &lt;ServeLogo&gt; line"</span>;
00106                   <span class="keywordflow">throw</span> _expt;
00107                }
00108 
00109                <span class="comment">// MESSAGE TYPE</span>
00110 
00111                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00112 
00113                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00114                {
00115                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;ServeLogo&gt; line (no message type)"</span>);
00116                }
00117 
00118                <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].type = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(_token);
00119 
00120                <span class="keywordflow">if</span> (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[<a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>].type == <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_WILDCARD"</span>)
00121                    &amp;&amp; strcmp(_token, <span class="stringliteral">"TYPE_WILDCARD"</span>) != 0
00122                   )
00123                {
00124                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized message type id: "</span>);
00125                   _expt += _token;
00126                   _expt += <span class="stringliteral">" in &lt;ServeLogo&gt; line"</span>;
00127                   <span class="keywordflow">throw</span> _expt;
00128                }
00129 
00130                <a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a>++;
00131 
00132                <span class="keywordflow">continue</span>;
00133             }
00134 
00135             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"InputRing"</span>) )
00136             {
00137                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00138                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00139                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00140                {
00141                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;InputRing&gt; for input messages"</span>);
00142                }
00143                strncpy( InputRingName, _token, MAX_RINGNAME_LEN );
00144 
00145                <span class="keywordflow">if</span> ( (<a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(InputRingName)) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00146                {
00147                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;InputRing&gt;"</span>);
00148                }
00149                <span class="keywordflow">continue</span>;
00150             }
00151 
00152             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"MaxMsgSize"</span>) )
00153             {
00154                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00155                <span class="keywordtype">int</span> _maxmsglen = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>();
00156                <span class="keywordflow">if</span> ( _maxmsglen &lt;= 0 )
00157                {
00158                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;MaxMsgSize&gt; for input messages"</span>);
00159                }
00160                <a class="code" href="classRingReaderServer.html#o0">MaxMessageLength</a> = _maxmsglen;
00161                <span class="keywordflow">continue</span>;
00162             }
00163 
00164          } <span class="keywordflow">while</span>( false );
00165       }
00166       <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _rte )
00167       {
00168          r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00169          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00170                        , <span class="stringliteral">"RingReaderServer::HandleConfigLine(): configuration error:\n%s\n"</span>
00171                        , _rte.what()
00172                        );
00173          r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00174       }
00175    }
00176    <span class="keywordflow">return</span> r_handled;
00177 }
00178 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00179"></a><a class="code" href="classRingReaderServer.html#b0">00179</a> <span class="keywordtype">void</span> <a class="code" href="classRingReaderServer.html#b0">RingReaderServer::CheckConfig</a>()
00180 {
00181    <a class="code" href="classWormServerBase.html#b1">WormServerBase::CheckConfig</a>();
00182 
00183    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a> == 0 )
00184    {
00185       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00186                     , <span class="stringliteral">"RingReaderServer::HaveMyConfigs(): No &lt;ServeLogo&gt; lines found in the config file\n"</span>
00187                     );
00188       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00189    }
00190 
00191    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00192    {
00193       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00194                     , <span class="stringliteral">"RingReaderServer::HaveMyConfigs(): No &lt;InputRing&gt; found in the config file\n"</span>
00195                     );
00196       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00197    }
00198 
00199    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#o0">MaxMessageLength</a> &lt;= 1 )
00200    {
00201       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00202                     , <span class="stringliteral">"RingReaderServer::HaveMyConfigs(): No valid &lt;MaxMsgSize&gt; found in the config file\n"</span>
00203                     );
00204       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00205    }
00206 }
00207 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00208"></a><a class="code" href="classRingReaderServer.html#b1">00208</a> <span class="keywordtype">bool</span> <a class="code" href="classRingReaderServer.html#b1">RingReaderServer::PrepareToRun</a>()
00209 {
00210    <span class="keywordtype">bool</span> r_state = <span class="keyword">true</span>;
00211    <span class="keywordflow">try</span>
00212    {
00213       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_ERROR"</span>) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00214       {
00215          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"RingReaderServer::PrepareToRun(): message type TYPE_ERROR not found in lookups"</span>);
00216       }
00217 
00218       <span class="keywordflow">if</span> ( (<a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="classRingReaderServer.html#o0">MaxMessageLength</a>+1]) == NULL )
00219       {
00220          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"RingReaderServer::PrepareToRun(): failed allocating message buffer"</span>);
00221       }
00222 
00223        
00224       <span class="keywordflow">if</span> ( (<a class="code" href="classRingReaderServer.html#n0">LoggingLevel</a> = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>()) == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00225       {
00226          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT
00227                        , <span class="stringliteral">"RingReaderServer::PrepareToRun(): A  %s  %d  %d  (%d + 1)\n"</span>
00228                        , InputRingName
00229                        , InputRingKey
00230                        , <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a>
00231                        , MaxMessageLength
00232                        );
00233       }
00234 
00235       <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> != <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> )
00236       {
00237          <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;InputRegion, InputRingKey );
00238       }
00239       <span class="keywordflow">else</span>
00240       {
00241          memcpy( (<span class="keywordtype">void</span> *)&amp;InputRegion , (<span class="keywordtype">void</span> *)&amp;CommandRegion, <span class="keyword">sizeof</span>(InputRegion) );
00242       }
00243 
00244       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00245       {
00246          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT
00247                        , <span class="stringliteral">"RingReaderServer::PrepareToRun(): B  %s  %d  %d\n"</span>
00248                        , InputRingName
00249                        , InputRingKey
00250                        , <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a>
00251                        );
00252       }
00253    }
00254    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _rte )
00255    {
00256       r_state = <span class="keyword">false</span>;
00257    }
00258    <span class="keywordflow">return</span> r_state;
00259 }
00260 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00261"></a><a class="code" href="classRingReaderServer.html#b2">00261</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classRingReaderServer.html#b2">RingReaderServer::MainThreadActions</a>()
00262 {
00263    <span class="keyword">static</span> <span class="keywordtype">int</span>      _getmsg_status;
00264         <span class="keyword">static</span> <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a> _arrivelogo;      <span class="comment">// logo of arriving message</span>
00265    <span class="keyword">static</span> <span class="keywordtype">long</span>     _arr_msg_len;     <span class="comment">// length of arriving message</span>
00266    <span class="keyword">static</span> <span class="keywordtype">bool</span>     _msg_ready;
00267    <span class="keyword">static</span> <span class="keywordtype">char</span>     _errormsg[300];   <span class="comment">//</span>
00268 
00269    <span class="keyword">static</span> InstallWildcard = <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(<span class="stringliteral">"INST_WILDCARD"</span>);
00270    <span class="keyword">static</span> ModuleWildcard  = <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(<span class="stringliteral">"MOD_WILDCARD"</span>);
00271    <span class="keyword">static</span> MessageWildcard = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_WILDCARD"</span>);
00272 
00273    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00274 
00275    <span class="keywordflow">try</span>
00276    {
00277       _msg_ready = <span class="keyword">true</span>;
00278 
00279       <span class="comment">// Get a message from transport ring</span>
00280       _getmsg_status = <a class="code" href="transport_8c.html#a20">tport_getmsg</a>( &amp;InputRegion
00281                                    ,  ServeLogo
00282                                    ,  ServeLogoCount
00283                                    , &amp;_arrivelogo
00284                                    , &amp;_arr_msg_len
00285                                    ,  MessageBuffer
00286                                    ,  MaxMessageLength
00287                                    );
00288 
00289       <span class="keywordflow">switch</span>( _getmsg_status )
00290       {
00291         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a8">GET_OK</a>:
00292              <span class="keywordflow">break</span>;
00293 
00294         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a10">GET_MISS</a>:
00295         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a13">GET_MISS_LAPPED</a>:
00296              <span class="comment">// report error, handle message</span>
00297              <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), ERR_MISSMSG, <span class="stringliteral">"missed messages"</span> );
00298              <span class="keywordflow">break</span>;
00299 
00300         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a14">GET_MISS_SEQGAP</a>:
00301              <span class="comment">// report error, handle message</span>
00302              <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), ERR_MISSMSG, <span class="stringliteral">"saw sequence gap"</span> );
00303              <span class="keywordflow">break</span>;
00304 
00305         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a11">GET_NOTRACK</a>:
00306              <span class="comment">// report error, handle message</span>
00307              sprintf( _errormsg
00308                     , <span class="stringliteral">"no tracking for logo i%d m%d t%d in %s"</span>
00309                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00310                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00311                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
00312                     , InputRingName
00313                     );
00314              <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), ERR_NOTRACK, _errormsg );
00315              <span class="keywordflow">break</span>;
00316 
00317         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a12">GET_TOOBIG</a>:
00318              <span class="comment">// report error, return to main loop to sleep</span>
00319              sprintf( _errormsg
00320                     , <span class="stringliteral">"tport msg[%ld] i%d m%d t%d too big. Max is %ld"</span>
00321                     , _arr_msg_len
00322                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00323                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00324                     , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
00325                     , MaxMessageLength
00326                     );
00327              <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), ERR_TOOBIG, _errormsg );
00328 
00329              <span class="comment">// fall - through</span>
00330 
00331         <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a9">GET_NONE</a>:
00332              _msg_ready = <span class="keyword">false</span>;
00333 
00334              <span class="comment">// no message ready, return to main loop to sleep</span>
00335              <span class="keywordflow">break</span>;
00336       }
00337 
00338       <span class="keywordflow">if</span> ( _msg_ready )
00339       {
00340          <span class="comment">// NULL-terminate string buffer</span>
00341          <a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
00342          <span class="comment">// truncate end-of-line if present</span>
00343          <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a>[_arr_msg_len-1] == <span class="charliteral">'\n'</span> )
00344          {
00345             _arr_msg_len--;
00346             <a class="code" href="classRingReaderServer.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
00347          }
00348 
00349          <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i = 0, _sz = <a class="code" href="classRingReaderServer.html#n5">ServeLogoCount</a> ; _i &lt; _sz ; _i++ )
00350          {
00351             <span class="keywordflow">if</span> (   (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a> == InstallWildcard
00352                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == InstallWildcard
00353                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00354                    )
00355                 &amp;&amp; (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a> == ModuleWildcard
00356                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == ModuleWildcard
00357                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00358                    )
00359                 &amp;&amp; (   <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a> == MessageWildcard
00360                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == MessageWildcard
00361                     || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == <a class="code" href="classRingReaderServer.html#n4">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a>
00362                    )
00363                )
00364             {
00365                <span class="keywordflow">if</span> ( ! <a class="code" href="classRingReaderServer.html#b4">MessageFromRing</a>(_arrivelogo, MessageBuffer) )
00366                {
00367                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"MessageFromRing() reported failure"</span>);
00368                }
00369                <span class="keywordflow">break</span>;
00370             }
00371          }
00372       }
00373    }
00374    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _rte )
00375    {
00376       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00377    }
00378 
00379    <span class="keywordflow">return</span> r_status;
00380 }
00381 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00382"></a><a class="code" href="classRingReaderServer.html#b3">00382</a> <span class="keywordtype">void</span> <a class="code" href="classRingReaderServer.html#b3">RingReaderServer::FinishedRunning</a>()
00383 {
00384    <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00385    {
00386       <span class="keywordflow">if</span> ( <a class="code" href="classRingReaderServer.html#n2">InputRingKey</a> != <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> )
00387       {
00388          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;InputRegion );
00389       }
00390       <a class="code" href="classRingReaderServer.html#n3">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00391    }
00392 }
00393 <span class="comment">//---------------------------------------------------------------------------</span>
00394 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:08 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
