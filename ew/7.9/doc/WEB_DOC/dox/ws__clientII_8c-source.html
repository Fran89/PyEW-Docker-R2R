<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ws_clientII.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ws_clientII.c</h1><a href="ws__clientII_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: ws__clientII_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:03  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.5  2002/03/19 22:15:15  davidk</span>
00011 <span class="comment"> *     Fixed bug reported by IlyaDricker in wsGetTraceBin() where the function</span>
00012 <span class="comment"> *     was not correctly handling the return code from wsParseBinHeaderReply().</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *     Revision 1.4  2001/04/17 17:31:41  davidk</span>
00015 <span class="comment"> *     Added explicit (SOCKET) typecasts in FD_SET to get rid of compiler warnings on NT.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> *     Revision 1.3  2000/09/17 18:37:57  lombard</span>
00018 <span class="comment"> *     wsSearchSCN now really returns the first menu with matching scn.</span>
00019 <span class="comment"> *     wsGetTraceBin will now try another server if the first returns a gap.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *     Revision 1.2  2000/03/08 18:14:06  luetgert</span>
00022 <span class="comment"> *     fixed memmove problem in wsParseAsciiHeaderReply.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00025 <span class="comment"> *     Initial revision</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00030 <span class="comment">/* Version II of WaveServerIV client utility routines. This file contains</span>
00031 <span class="comment"> * various routines useful for dealing with WaveServerIV and beyond. */</span>
00032 
00033 <span class="comment">/* 5/17/98: Fixed bug in wsWaitAscii: it would fill reply buffer but never</span>
00034 <span class="comment"> * report overflow. PNL */</span>
00035 
00036 <span class="comment">/* The philosophy behind the version II changes is:</span>
00037 <span class="comment"> * - Leave sockets open unless there is an error on the socket; calling </span>
00038 <span class="comment"> *   progam should ensure all sockets are closed before it quits.</span>
00039 <span class="comment"> * - Routines are thread-safe. However, the calling thread must ensure its</span>
00040 <span class="comment"> *   socket descriptors are unique or mutexed so that requests and replies</span>
00041 <span class="comment"> *   can't overlap.</span>
00042 <span class="comment"> * - Routines are layered on top of Dave Kragness's socket wrappers and thus</span>
00043 <span class="comment"> *   do no timing themselves. Exceptions to this are wsWaitAscii and </span>
00044 <span class="comment"> *   wsWaitBinHeader which need special timing of recv().</span>
00045 <span class="comment"> * Pete Lombard, University of Washington Geophysics; 1/4/98</span>
00046 <span class="comment"> */</span>
00047 
00048 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00049 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00050 <span class="preprocessor">#include &lt;string.h&gt;</span>
00051 <span class="preprocessor">#include &lt;time.h&gt;</span>
00052 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00053 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00054 <span class="preprocessor">#include &lt;<a class="code" href="ws__clientII_8h.html">ws_clientII.h</a>&gt;</span>
00055 <span class="preprocessor">#include &lt;<a class="code" href="socket__ew_8h.html">socket_ew.h</a>&gt;</span>
00056 <span class="preprocessor">#include &lt;<a class="code" href="time__ew_8h.html">time_ew.h</a>&gt;</span>
00057 
<a name="l00058"></a><a class="code" href="ws__clientII_8c.html#a0">00058</a> <span class="preprocessor">#define WS_MAX_RECV_BUF_LEN 4096</span>
00059 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="ws__clientII_8c.html#a1">00060</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a1">menu_reqid</a> = 0;
<a name="l00061"></a><a class="code" href="ws__clientII_8c.html#a2">00061</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a2">WS_CL_DEBUG</a> = 0;
00062 
00063 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="socket__ew__common_8c.html#a11">recv_all</a> (SOCKET, <span class="keywordtype">char</span> FAR*,<span class="keywordtype">int</span>,<span class="keywordtype">int</span>,<span class="keywordtype">int</span>);
00064 
00065 
00066 <span class="comment">/* Protoypes for internal functions */</span>
00067 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="ws__clientII_8c.html#a4">wsWaitAscii</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a>, <span class="keywordtype">char</span>*, <span class="keywordtype">int</span>, <span class="keywordtype">int</span> );
00068 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="ws__clientII_8c.html#a5">wsWaitBinHeader</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a>, <span class="keywordtype">char</span>*, <span class="keywordtype">int</span>, <span class="keywordtype">int</span> );
00069 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="ws__clientII_8c.html#a6">wsParseMenuReply</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a>, <span class="keywordtype">char</span>* );
00070 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="ws__clientII_8c.html#a7">wsParseBinHeaderReply</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>*, <span class="keywordtype">char</span>* );
00071 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="ws__clientII_8c.html#a8">wsParseAsciiHeaderReply</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>*, <span class="keywordtype">char</span>* );
00072 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( <span class="keywordtype">char</span>*, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>* );
00073 <span class="keyword">struct </span>timeval FAR * <a class="code" href="socket__ew__common_8c.html#a4">resetTimeout</a>(struct timeval FAR *);
00074 Time_ew <a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(<span class="keywordtype">int</span> timeout_msec);
00075 
00076 <span class="comment">/**************************************************************************</span>
00077 <span class="comment"> *      wsAppendMenu: builds a combined menu from many waveservers.       *</span>
00078 <span class="comment"> *      Called with the address and port of one waveserver.               *</span>
00079 <span class="comment"> *      On the first call it creates a linked list to store the 'menu'    *</span>
00080 <span class="comment"> *      reply from the indicated waveserver.                              *</span>
00081 <span class="comment"> *      On subsequent calls, it appends the menu replies to the list.     *</span>
00082 <span class="comment"> **************************************************************************/</span>
00083 
<a name="l00084"></a><a class="code" href="ws__clientII_8c.html#a12">00084</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a12">wsAppendMenu</a>( <span class="keywordtype">char</span>* ipAdr, <span class="keywordtype">char</span>* port, <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue, 
00085                   <span class="keywordtype">int</span> timeout )
00086      <span class="comment">/*</span>
00087 <span class="comment">Arguments:</span>
00088 <span class="comment">         ipAdr:  is the dot form of the IP address as a char string.</span>
00089 <span class="comment">          port:  TCP port number as a char string.</span>
00090 <span class="comment">    menu_queue:  caller-supplied pointer to the list of menus.</span>
00091 <span class="comment">       timeout:  timeout interval in milliseconds,</span>
00092 <span class="comment">        return:  WS_ERR_NONE:  if all went well.</span>
00093 <span class="comment">                 WS_ERR_NO_CONNECTION: if we could not get a connection.</span>
00094 <span class="comment">                 WS_ERR_SOCKET: if we could not create a socket.</span>
00095 <span class="comment">                 WS_ERR_BROKEN_CONNECTION:  if the connection broke.</span>
00096 <span class="comment">                 WS_ERR_TIMEOUT: if a timeout occured.</span>
00097 <span class="comment">                 WS_ERR_MEMORY: if out of memory.</span>
00098 <span class="comment">                 WS_ERR_INPUT: if bad input parameters.</span>
00099 <span class="comment">                 WS_ERR_PARSE: if parser failed.</span>
00100 <span class="comment">*/</span>
00101 {
00102   <span class="keywordtype">int</span> ret, len, err;
00103   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu = NULL;
00104   <span class="keywordtype">char</span> request[<a class="code" href="ws__client_8h.html#a14">wsREQLEN</a>];
00105   <span class="keywordtype">char</span>* reply = NULL;
00106 
00107   <span class="keywordflow">if</span> ( !ipAdr || !port ||
00108        (strlen(ipAdr) &gt;= <a class="code" href="ws__client_8h.html#a13">wsADRLEN</a>) || (strlen(port) &gt;= <a class="code" href="ws__client_8h.html#a13">wsADRLEN</a>) )
00109     {
00110       ret = <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
00111       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>,<span class="stringliteral">"wsAppendMenu: bad address: %s port: %s\n"</span>,
00112                              ipAdr, port);
00113       <span class="keywordflow">goto</span> Abort;
00114     }
00115 
00116   menu = ( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU_REC</a>* )calloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__WS__MENU__REC.html">WS_MENU_REC</a>),1);
00117   reply = ( <span class="keywordtype">char</span>* )malloc( wsREPLEN );
00118   <span class="keywordflow">if</span> ( !menu || !reply )
00119     {
00120       ret = <a class="code" href="ws__client_8h.html#a3">WS_ERR_MEMORY</a>;
00121       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAppendMenu: memory allocation error\n"</span>);
00122       <span class="keywordflow">goto</span> Abort;
00123     }
00124 
00125   strcpy( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, ipAdr );
00126   strcpy( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a>, port );
00127   <span class="keywordflow">if</span> ( <a class="code" href="ws__clientII_8c.html#a19">wsAttachServer</a>( menu, timeout ) != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> )
00128     {
00129       ret = <a class="code" href="ws__client_8h.html#a1">WS_ERR_NO_CONNECTION</a>;
00130       <span class="keywordflow">goto</span> Abort;
00131     }
00132 
00133   sprintf( request, <span class="stringliteral">"MENU: %d \n"</span>, menu_reqid++ );
00134   len = strlen(request);
00135   <span class="keywordflow">if</span> ( ( ret =  <a class="code" href="socket__ew__common_8c.html#a14">send_ew</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, request, len, 0, timeout ) ) != len ) {
00136     <span class="keywordflow">if</span> (ret &lt; 0 )
00137     {
00138       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAppendMenu: connection broke to server %s:%s\n"</span>,
00139                              ipAdr, port);
00140       ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00141     } <span class="keywordflow">else</span> {
00142       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAppendMenu: server %s:%s timed out\n"</span>,
00143                              ipAdr, port);
00144       ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00145     }
00146     <span class="keywordflow">goto</span> Abort;
00147   }
00148 
00149   ret = <a class="code" href="ws__clientII_8c.html#a4">wsWaitAscii</a>( menu, reply, wsREPLEN, timeout );
00150   <span class="keywordflow">if</span> ( ret != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> &amp;&amp; ret != <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a> )
00151     <span class="comment">/* we might have received some useful data in spite of the overflow */</span>
00152     {
00153       <span class="keywordflow">goto</span> Abort;
00154     }
00155 
00156   <span class="keywordflow">if</span> ( ( err = <a class="code" href="ws__clientII_8c.html#a6">wsParseMenuReply</a>( menu, reply ) ) != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> )
00157     {
00158       <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a> &amp;&amp; err == <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a> )
00159         {
00160           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAppendMenu: buffer overflow; parse failure\n"</span>);
00161         } 
00162       <span class="keywordflow">else</span>
00163         {
00164           ret = err;
00165         }
00166       <span class="keywordflow">goto</span> Abort;
00167     }
00168 
00169   <span class="keywordflow">if</span> ( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a> == NULL )
00170     {
00171       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAppendMenu: no SCN at server %s:%s\n"</span>,
00172                              menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a>);
00173       ret = <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a>;
00174       <span class="keywordflow">goto</span> Abort;
00175     }
00176   
00177   <span class="comment">/* Add the menu to the possibly empty menu queue */</span>
00178   <span class="keywordflow">if</span> ( !menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> )
00179     {
00180       menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m1">tail</a> = menu;
00181     }
00182   <span class="keywordflow">else</span>
00183     {
00184       menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m1">tail</a>-&gt;<a class="code" href="struct__WS__MENU__REC.html#m4">next</a> = menu;
00185       menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m1">tail</a> = menu;
00186     }
00187   <span class="keywordflow">if</span> ( reply ) free( reply );
00188   <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00189 
00190 Abort:
00191   <span class="comment">/* An error occured, so clean up the mess */</span>
00192   <a class="code" href="ws__clientII_8c.html#a20">wsDetachServer</a>( menu );
00193   <span class="keywordflow">if</span> ( reply ) free( reply );
00194   <span class="keywordflow">if</span> ( menu )
00195     {
00196       <a class="code" href="ws__clientII_8c.html#a16">wsKillPSCN</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a> );
00197       free( menu );
00198     }
00199   <span class="keywordflow">return</span> ret;
00200 }
00201 
00202 
00203 <span class="comment">/************************************************************************** </span>
00204 <span class="comment"> * wsKillMenu: Gracefully closes all the server sockets and releases the  *</span>
00205 <span class="comment"> *             linked list of menus created by wsAppendMenu               *</span>
00206 <span class="comment"> **************************************************************************/</span>
<a name="l00207"></a><a class="code" href="ws__clientII_8c.html#a13">00207</a> <span class="keywordtype">void</span> <a class="code" href="ws__client_8h.html#a23">wsKillMenu</a>( <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue )
00208      <span class="comment">/*</span>
00209 <span class="comment">Arguments:</span>
00210 <span class="comment">    menu_queue:  caller-supplied pointer to the list of menus.</span>
00211 <span class="comment">    */</span>
00212 {
00213   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a>;
00214 
00215   <span class="keywordflow">while</span> ( menu )
00216     {
00217       <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> next = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m4">next</a>;
00218 
00219       <span class="keywordflow">if</span> ( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> != -1 )
00220         <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, SOCKET_CLOSE_GRACEFULLY_EW );
00221       <a class="code" href="ws__clientII_8c.html#a16">wsKillPSCN</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a> );
00222       free( menu );
00223       menu = next;
00224     }
00225   menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m1">tail</a> = NULL;
00226   <a class="code" href="ws__clientII_8c.html#a1">menu_reqid</a> = 0;
00227 
00228   <span class="keywordflow">return</span>;
00229 }
00230 
00231 
00232 <span class="comment">/*********************************************************************</span>
00233 <span class="comment"> * wsGetTraceBin: retrieves the piece of raw trace data specified in *</span>
00234 <span class="comment"> * the structure 'getThis': The current menu list, as built by the   *</span>
00235 <span class="comment"> * routines above will be searched for a matching SCN. If a match    *</span>
00236 <span class="comment"> * is found, the associated wave server will be contacted, and a     *</span>
00237 <span class="comment"> * request for the trace snippet will be made.                       *</span>
00238 <span class="comment"> *********************************************************************/</span>
<a name="l00239"></a><a class="code" href="ws__clientII_8c.html#a14">00239</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a14">wsGetTraceBin</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>* getThis, <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue,
00240                    <span class="keywordtype">int</span> timeout )
00241      <span class="comment">/*</span>
00242 <span class="comment">Arguments:</span>
00243 <span class="comment">        getThis:   a TRACE_REQ structure (see ws_client.h), with the</span>
00244 <span class="comment">                   request portion filled in.</span>
00245 <span class="comment">     menu_queue:   pointer to the list of server menus.</span>
00246 <span class="comment">        timeout:   Time in milliseconds to wait for reply</span>
00247 <span class="comment">         return:   WS_ERR_NONE: all went well.</span>
00248 <span class="comment">                   WS_WRN_FLAGGED: wave server returned error flag instead</span>
00249 <span class="comment">                      of trace data.</span>
00250 <span class="comment">                   WS_ERR_EMPTY_MENU: No menu list found.</span>
00251 <span class="comment">                   WS_ERR_SCN_NOT_IN_MENU: SCN not found in menu list.</span>
00252 <span class="comment">                   WS_ERR_NO_CONNECTION: if socket was already closed</span>
00253 <span class="comment">          The socket will be closed for the following:</span>
00254 <span class="comment">                   WS_ERR_BUFFER_OVERFLOW: trace buffer supplied too small.</span>
00255 <span class="comment">                   WS_ERR_TIMEOUT: if a timeout occured</span>
00256 <span class="comment">                   WS_ERR_BROKEN_CONNECTION: if a connection broke.</span>
00257 <span class="comment">                   WS_ERR_SOCKET: problem changing socket options.</span>
00258 <span class="comment">     */</span>
00259 {
00260   <span class="keywordtype">int</span> ret, len, err = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00261   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu = NULL;
00262   <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> pscn = NULL;
00263   <span class="keywordtype">char</span> request[<a class="code" href="ws__client_8h.html#a14">wsREQLEN</a>];
00264 
00265   <span class="keywordflow">if</span> ( menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> == NULL )
00266     {
00267       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceBin: empty menu\n"</span>);
00268       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a>;
00269     }
00270 
00271  next_menu:
00272   <span class="keywordflow">if</span> ( ( ret = <a class="code" href="ws__clientII_8c.html#a18">wsSearchSCN</a>( getThis, &amp;menu, &amp;pscn, menu_queue )) != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> )
00273     {
00274       <span class="keywordflow">if</span> (err != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>)
00275         <span class="keywordflow">return</span> err;
00276       <span class="keywordflow">else</span>
00277         <span class="keywordflow">return</span> ret;  <span class="comment">/* WS_ERR_SCN_NOT_IN_MENU */</span>
00278     }
00279 
00280   <span class="keywordflow">if</span> (menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> &lt; 0) 
00281     {
00282       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceBin: no socket for %s:%s\n"</span>, 
00283                              menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a> );
00284       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a1">WS_ERR_NO_CONNECTION</a>;
00285     }
00286 
00287   sprintf( request, <span class="stringliteral">"GETSCNRAW: %d %s %s %s %lf %lf\n"</span>,
00288            menu_reqid++, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m0">sta</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m1">chan</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m2">net</a>,
00289            getThis-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a> );
00290 
00291   len = strlen(request);
00292   <span class="keywordflow">if</span> ( (ret = <a class="code" href="socket__ew__common_8c.html#a14">send_ew</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, request, len, 0, timeout )) != len )
00293     {
00294       <span class="keywordflow">if</span> (ret &lt; 0 )
00295         {
00296           ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00297         } <span class="keywordflow">else</span> {
00298           ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00299         }
00300       <span class="keywordflow">goto</span> Abort;
00301     }
00302 
00303   ret = <a class="code" href="ws__clientII_8c.html#a5">wsWaitBinHeader</a>( menu, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m8">bufLen</a>, timeout );
00304   <span class="keywordflow">switch</span> (ret) {
00305   <span class="keywordflow">case</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>:
00306     <span class="keywordflow">return</span> ret;
00307     <span class="keywordflow">break</span>;
00308   <span class="keywordflow">case</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>:
00309     <span class="keywordflow">break</span>;
00310   <span class="keywordflow">default</span>:
00311     <span class="comment">/* buffer overflow, timeout, socket error, or broken connection */</span>
00312       <span class="keywordflow">goto</span> Abort;
00313   }
00314 
00315   err = <a class="code" href="ws__clientII_8c.html#a7">wsParseBinHeaderReply</a>( getThis, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a> );
00316   <span class="keywordflow">switch</span> (err) {
00317   <span class="keywordflow">case</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>:
00318   <span class="keywordflow">case</span> <a class="code" href="ws__clientII_8h.html#a0">WS_WRN_FLAGGED</a>:  <span class="comment">/* no trace data to get */</span>
00319     <span class="keywordflow">goto</span> next_menu;
00320     <span class="keywordflow">break</span>;
00321   <span class="keywordflow">case</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>:  <span class="comment">/* can't get pending trace data, so close socket */</span>
00322     <span class="comment">/* DK 03192002 setting ret due to bug reported by Ilya Dricker */</span>
00323     <span class="keywordflow">if</span>(ret == <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>)
00324       ret = err;
00325     <span class="comment">/* end DK 0319 change */</span>
00326     <span class="keywordflow">goto</span> Abort;
00327     <span class="keywordflow">break</span>;
00328   <span class="keywordflow">default</span>:  <span class="comment">/* no error, so continue */</span>
00329     <span class="keywordflow">break</span>;
00330   }
00331   
00332   <span class="keywordflow">if</span> ( getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a> )
00333     {
00334       <span class="keywordtype">long</span> <span class="keywordtype">int</span> binLen = getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a>;
00335       
00336       <span class="keywordflow">if</span> ( (int)getThis-&gt;<a class="code" href="structTRACE__REQ.html#m8">bufLen</a> &lt; binLen )
00337         binLen = (int)getThis-&gt;<a class="code" href="structTRACE__REQ.html#m8">bufLen</a>;
00338       ret = <a class="code" href="socket__ew__common_8c.html#a11">recv_all</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a>, binLen, 0, timeout );
00339       
00340       <span class="keywordflow">if</span> ( ret != binLen ) 
00341         {
00342           <span class="keywordflow">if</span> ( ret &lt; 0 )
00343             {
00344               ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00345             } 
00346           <span class="keywordflow">else</span> 
00347             {
00348               ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00349             }
00350           <span class="keywordflow">goto</span> Abort;
00351         }
00352       
00353       <span class="keywordflow">if</span> ( binLen &lt; getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a> ) 
00354         {
00355           getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a> = binLen;
00356           ret = <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a>;
00357           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a> ( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceBin(): buffer full, trace truncated\n"</span> );
00358           <span class="keywordflow">goto</span> Abort;
00359         }
00360     }
00361   <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00362   
00363 Abort:
00364   <a class="code" href="ws__clientII_8c.html#a20">wsDetachServer</a>( menu );
00365   <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00366     {
00367       <span class="keywordflow">if</span>  ( ret == <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a> ) {
00368         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsGetTraceBin(): server %s:%s timed out\n"</span>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>,
00369                menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> );
00370       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a> ) {
00371         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsGetTraceBin(): broken connection to server %s:%s\n"</span>,
00372                menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a>);
00373       }
00374     }
00375   
00376   <span class="keywordflow">return</span> ret;
00377 }
00378 
00379 <span class="comment">/**************************************************************************</span>
00380 <span class="comment"> *      wsGetTraceAscii: retrieves the ascii trace data specified in      *</span>
00381 <span class="comment"> *      the structure 'getThis': The current menu list, as buit by the    *</span>
00382 <span class="comment"> *      routines above will be searched for a matching SCN. If a match    *</span>
00383 <span class="comment"> *      is found, the associated wave server will be contacted, and a     *</span>
00384 <span class="comment"> *      request for the trace snippet will be made.                       *</span>
00385 <span class="comment"> **************************************************************************/</span>
00386 
<a name="l00387"></a><a class="code" href="ws__clientII_8c.html#a15">00387</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a15">wsGetTraceAscii</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>* getThis, <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue, 
00388                      <span class="keywordtype">int</span> timeout )
00389      <span class="comment">/*</span>
00390 <span class="comment">Arguments:</span>
00391 <span class="comment">        getThis:   a TRACE_REQ structure (see ws_client.h), with the</span>
00392 <span class="comment">                   request portion filled in.</span>
00393 <span class="comment">     menu_queue:   pointer to list of menues.</span>
00394 <span class="comment">        timeout:   timeout interval in milliseconds.</span>
00395 <span class="comment">        return:    WS_ERR_NONE: all went well.</span>
00396 <span class="comment">                   WS_ERR_EMPTY_MENU: No menu list found.</span>
00397 <span class="comment">                   WS_ERR_SCN_NOT_IN_MENU: SCN not found in menu list.</span>
00398 <span class="comment">                   WS_ERR_BUFFER_OVERFLOW: buffer too small for reply</span>
00399 <span class="comment">                   WS_ERR_BROKEN_CONNECTION: couldn't talk to server</span>
00400 <span class="comment">                   WS_ERR_TIMEOUT: if a timeout occured</span>
00401 <span class="comment">                   WS_ERR_NO_CONNECTION: There was no connection for the server</span>
00402 <span class="comment">                   WS_WRN_FLAGGED: wave server returned flag warning.</span>
00403 <span class="comment">                     the flag character is in the TRACE_REQ structure.</span>
00404 <span class="comment">                     */</span>
00405 {
00406   <span class="keywordtype">int</span> ret, len, err;
00407   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu = NULL;
00408   <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> pscn = NULL;
00409   <span class="keywordtype">char</span> request[<a class="code" href="ws__client_8h.html#a14">wsREQLEN</a>];
00410   <span class="keywordtype">double</span> expire = (double) 0.0;
00411   
00412   <span class="keywordflow">if</span> ( menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> == NULL )
00413     {
00414       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceAscii: empty menu\n"</span>);
00415       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a>;
00416     }
00417   
00418   <span class="keywordflow">if</span> ( (ret = <a class="code" href="ws__clientII_8c.html#a18">wsSearchSCN</a>( getThis, &amp;menu, &amp;pscn, menu_queue  )) != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> )
00419     {
00420       <span class="keywordflow">return</span> ret; <span class="comment">/* WS_ERR_SCN_NOT_IN_MENU */</span>
00421     }
00422                      
00423   <span class="keywordflow">if</span> ( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> &lt; 0 )
00424     {
00425       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceAscii: no socket for %s:%s\n"</span>,
00426                              menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a> );
00427       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a1">WS_ERR_NO_CONNECTION</a>;
00428     }
00429   
00430   sprintf( request, <span class="stringliteral">"GETSCN: %d %s %s %s %lf %lf %d\n"</span>,
00431            menu_reqid++, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m0">sta</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m1">chan</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m2">net</a>,
00432            getThis-&gt;<a class="code" href="structTRACE__REQ.html#m4">reqStarttime</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m5">reqEndtime</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m10">fill</a> );
00433   len = strlen( request );
00434   
00435   <span class="keywordflow">if</span> ( ( ret = <a class="code" href="socket__ew__common_8c.html#a14">send_ew</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, request, len, 0, timeout )) != len )
00436     {
00437       <span class="keywordflow">if</span> (ret &lt; 0 )
00438         {
00439           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00440             <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceAscii: connection broke to server %s:%s\n"</span>, 
00441                   menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a> );
00442           ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00443         } <span class="keywordflow">else</span> {
00444           <span class="keywordflow">if</span> (WS_CL_DEBUG)
00445             <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceAscii: server %s:%s timed out\n"</span>, 
00446                   menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a> );
00447           ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00448         }
00449       <span class="keywordflow">goto</span> Abort;
00450     }
00451   
00452   ret = <a class="code" href="ws__clientII_8c.html#a4">wsWaitAscii</a>( menu, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a>, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m8">bufLen</a>, timeout );
00453   <span class="keywordflow">if</span> ( ret != <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> &amp;&amp; ret != <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a> )
00454     {
00455       <span class="keywordflow">goto</span> Abort;
00456     }
00457   <span class="keywordflow">else</span>
00458     {
00459     err = <a class="code" href="ws__clientII_8c.html#a8">wsParseAsciiHeaderReply</a>( getThis, getThis-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a> );
00460     <span class="keywordflow">if</span> ( err &lt; <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a> )
00461         {
00462           <span class="keywordflow">if</span> ( ( ret == <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a> ) &amp;&amp; <a class="code" href="ws__clientII_8c.html#a2">WS_CL_DEBUG</a> )
00463             <a class="code" href="logit_8c.html#a18">logit</a> ( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsGetTraceAscii(): buffer overflow; parse error\n"</span> );
00464           <span class="keywordflow">return</span> err;
00465         }
00466     }
00467   <span class="comment">/* wsParseAsciiReply puts the trace data into getThis, so now we're done */</span>
00468   <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00469   
00470 Abort:
00471   <a class="code" href="ws__clientII_8c.html#a20">wsDetachServer</a>( menu );
00472   <span class="keywordflow">return</span> ret;
00473 }
00474 
00475 <span class="comment">/*******************************************</span>
00476 <span class="comment"> *  wsKillPSCN: Deallocates the PSCN list  *</span>
00477 <span class="comment"> *******************************************/</span>
<a name="l00478"></a><a class="code" href="ws__clientII_8c.html#a16">00478</a> <span class="keywordtype">void</span> <a class="code" href="ws__clientII_8c.html#a16">wsKillPSCN</a>( <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> pscn )
00479      <span class="comment">/*</span>
00480 <span class="comment">Arguments:</span>
00481 <span class="comment">       pscn: pointer to a list of scn structures</span>
00482 <span class="comment">       */</span>
00483 {
00484   <span class="keywordflow">while</span> ( pscn )
00485     {
00486       <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> next = pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m6">next</a>;
00487 
00488       free( pscn );
00489       pscn = next;
00490     }
00491   <span class="keywordflow">return</span>;
00492 }
00493 
00494 <span class="comment">/*****************************************************************************</span>
00495 <span class="comment"> * wsGetServerPSCN: Return the pscn list for this server from the menu queue *</span>
00496 <span class="comment"> *****************************************************************************/</span>
<a name="l00497"></a><a class="code" href="ws__clientII_8c.html#a17">00497</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a17">wsGetServerPSCN</a>( <span class="keywordtype">char</span>* addr, <span class="keywordtype">char</span>* port, <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a>* pscnp,
00498                      <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue )
00499      <span class="comment">/*</span>
00500 <span class="comment">Arguments: </span>
00501 <span class="comment">       addr: IP address of the server</span>
00502 <span class="comment">       port: port number of the server</span>
00503 <span class="comment">      pscnp: pointer to the pscn list to be returned</span>
00504 <span class="comment"> menu_queue: pointer to list of menus.</span>
00505 <span class="comment">     return: WS_ERR_NONE: all went well</span>
00506 <span class="comment">             WS_ERR_EMPTY_MENU: no menu in the queue</span>
00507 <span class="comment">             WS_ERR_SERVER_NOT_IN_MENU: server's menu not in the queue</span>
00508 <span class="comment">             */</span>
00509 {
00510   <span class="keywordtype">int</span> ret = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a> ? <a class="code" href="ws__client_8h.html#a7">WS_ERR_SERVER_NOT_IN_MENU</a> : <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a>;
00511   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a>;
00512 
00513   *pscnp = NULL;
00514   <span class="keywordflow">while</span> ( menu )
00515     {
00516       <span class="keywordflow">if</span> ( strcmp( addr, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a> ) == 0 &amp;&amp;
00517            strcmp( port, menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a> ) == 0 )
00518         {
00519           ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00520           *pscnp = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a>;
00521           <span class="keywordflow">break</span>;
00522         }
00523       menu = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m4">next</a>;
00524     }
00525 
00526     <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00527       {
00528         <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a7">WS_ERR_SERVER_NOT_IN_MENU</a> )
00529           <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsGetServerPSCN(): WS_ERR_SERVER_NOT_IN_MENU\n"</span> );
00530         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a> )
00531           <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsGetServerPSCN(): WS_ERR_EMPTY_MENU\n"</span> );
00532       }
00533     
00534   <span class="keywordflow">return</span> ret;
00535 }
00536 
00537 
00538 <span class="comment">/***********************************************************************</span>
00539 <span class="comment"> * wsSearchSCN: Find menu and PSCN in queue which will serve this scn  *</span>
00540 <span class="comment"> *              If menup points to a menu in the menu_queue, search    *</span>
00541 <span class="comment"> *              starts at the next menu after *menup; otherwise,       *</span>
00542 <span class="comment"> *              search starts at menu_queue-&gt;head.                     *</span>
00543 <span class="comment"> *              If the SCN is listed more than once in the queue, only *</span>
00544 <span class="comment"> *              the first menu and PSCN will be returned.              *</span>
00545 <span class="comment"> ***********************************************************************/</span>
<a name="l00546"></a><a class="code" href="ws__clientII_8c.html#a18">00546</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a18">wsSearchSCN</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>* getThis, <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a>* menup, <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a>* pscnp,
00547                         <a class="code" href="structWS__MENU__QUEUE__REC.html">WS_MENU_QUEUE_REC</a>* menu_queue )
00548      <span class="comment">/*</span>
00549 <span class="comment">Arguments:</span>
00550 <span class="comment">      getThis: a TRACE_REQ structure with the SCN to search for.</span>
00551 <span class="comment">        menup: pointer to the menu to return.</span>
00552 <span class="comment">        pscnp: pointer to the pscn list to return.</span>
00553 <span class="comment">      returns: WS_ERR_NONE: if all went well</span>
00554 <span class="comment">               WS_ERR_EMPTY_MENU: no menus in the queue</span>
00555 <span class="comment">               WS_ERR_SERVER_NOT_IN_MENU: scn not in the queue</span>
00556 <span class="comment">               */</span>
00557 {
00558   <span class="keywordtype">int</span> ret;
00559   <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu;
00560 
00561   <span class="keywordflow">if</span> ( *menup != NULL)
00562     menu = (*menup)-&gt;<a class="code" href="struct__WS__MENU__REC.html#m4">next</a>;
00563   <span class="keywordflow">else</span>
00564     menu  = menu_queue-&gt;<a class="code" href="structWS__MENU__QUEUE__REC.html#m0">head</a>;
00565   ret = menu ? <a class="code" href="ws__client_8h.html#a6">WS_ERR_SCN_NOT_IN_MENU</a> : <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a>;
00566   *pscnp = NULL;
00567 
00568   <span class="keywordflow">while</span> ( menu )
00569     {
00570       <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> pscn = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a>;
00571       <span class="keywordflow">while</span> ( pscn )
00572         {
00573           <span class="keywordflow">if</span> ( strcmp( getThis-&gt;<a class="code" href="structTRACE__REQ.html#m0">sta</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m0">sta</a> ) == 0 &amp;&amp;
00574                strcmp( getThis-&gt;<a class="code" href="structTRACE__REQ.html#m1">chan</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m1">chan</a> ) == 0 &amp;&amp;
00575                strcmp( getThis-&gt;<a class="code" href="structTRACE__REQ.html#m2">net</a>, pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m2">net</a> ) == 0 )
00576             {
00577               ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00578               *menup = menu;
00579               *pscnp = pscn;
00580               <span class="keywordflow">goto</span> exit;
00581             }
00582           pscn = pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m6">next</a>;
00583         }
00584       menu = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m4">next</a>;
00585     }
00586 
00587  exit:
00588   <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00589     {
00590       <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a6">WS_ERR_SCN_NOT_IN_MENU</a> )
00591         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsSearchSCN(): WS_ERR_SCN_NOT_IN_MENU\n"</span> );
00592       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ret == <a class="code" href="ws__client_8h.html#a5">WS_ERR_EMPTY_MENU</a> )
00593         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsSearchSCN(): WS_ERR_EMPTY_MENU\n"</span> );
00594     }
00595   
00596   <span class="keywordflow">return</span> ret;
00597 }
00598 
00599 <span class="comment">/***********************************************************************</span>
00600 <span class="comment"> *  wsAttachServer: Open a connection to a server. The timeout starts  *</span>
00601 <span class="comment"> *    when connect() is called by connect_ew() in socket_ew_common.c   *</span>
00602 <span class="comment"> ***********************************************************************/</span>
<a name="l00603"></a><a class="code" href="ws__clientII_8c.html#a19">00603</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a19">wsAttachServer</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu, <span class="keywordtype">int</span> timeout )
00604      <span class="comment">/*</span>
00605 <span class="comment">Arguemnts:</span>
00606 <span class="comment">       menu: pointer to the menu of the server</span>
00607 <span class="comment">    timeout: time interval in milliseconds; use -1 for no timeout.</span>
00608 <span class="comment">    returns: WS_ERR_NONE: if all went well.</span>
00609 <span class="comment">             WS_ERR_INPUT: if menu is missing.</span>
00610 <span class="comment">             WS_ERR_SOCKET: if a socket error occurred.</span>
00611 <span class="comment">             WS_ERR_NO_CONNECTION: if a connection could not be established</span>
00612 <span class="comment">             */</span>
00613 {
00614   <span class="keywordtype">int</span>                ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00615   <span class="keywordtype">int</span>                sock = 0;   <span class="comment">/* Socket descriptor                  */</span>
00616   <span class="keyword">struct </span>sockaddr_in s_in ;      <span class="comment">/* Server's socket address stucture   */</span>
00617 
00618   <span class="keywordflow">if</span> ( !menu )
00619     {
00620       ret = <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
00621       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAttachServer(): WS_ERR_INPUT\n"</span>);
00622       <span class="keywordflow">goto</span> Abort;
00623     }
00624   <span class="keywordflow">if</span> ( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> &gt; 0 )  <span class="comment">/* maybe already connected, so disconnect first */</span>
00625     {
00626       <a class="code" href="ws__clientII_8c.html#a20">wsDetachServer</a>( menu );
00627     }
00628 
00629   <span class="comment">/* open a non_blocking socket</span>
00630 <span class="comment">  *****************************/</span>
00631   <span class="keywordflow">if</span> ( ( sock = <a class="code" href="socket__ew__common_8c.html#a6">socket_ew</a>( AF_INET, SOCK_STREAM, 0 ) ) == -1 )
00632     {
00633       ret = <a class="code" href="ws__clientII_8h.html#a11">WS_ERR_SOCKET</a>;
00634       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00635         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAttachServer(): socket_ew() call failed\n"</span> );
00636       <span class="keywordflow">goto</span> Abort;
00637     }
00638 
00639   <span class="comment">/* Stuff address and port into socket structure</span>
00640 <span class="comment">  ********************************************/</span>
00641   memset( (<span class="keywordtype">char</span> *)&amp;s_in, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(s_in) );
00642   s_in.sin_family = AF_INET;
00643   s_in.sin_port   = htons( (<span class="keywordtype">short</span>)atoi(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m1">port</a>) );
00644 
00645 <span class="preprocessor">#ifdef _LINUX</span>
00646 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((int)(s_in.sin_addr.s_addr = inet_addr(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>)) == -1)
00647 <span class="preprocessor">#else</span>
00648 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((int)(s_in.sin_addr.S_un.S_addr = inet_addr(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a>)) == -1)
00649 <span class="preprocessor">#endif</span>
00650 <span class="preprocessor"></span>    {
00651       ret = <a class="code" href="ws__client_8h.html#a1">WS_ERR_NO_CONNECTION</a>;
00652       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00653         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAttachServer(): inet_addr failed on &lt;%s&gt;\n"</span>,
00654                menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m0">addr</a> );
00655       <span class="keywordflow">goto</span> Abort;
00656     }
00657 
00658   <span class="keywordflow">if</span> ( <a class="code" href="socket__ew__common_8c.html#a7">connect_ew</a>( sock, (<span class="keyword">struct</span> sockaddr *)&amp;s_in, <span class="keyword">sizeof</span>(s_in), timeout) == -1 )
00659     {
00660       ret = <a class="code" href="ws__client_8h.html#a1">WS_ERR_NO_CONNECTION</a>;
00661       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00662         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsAttachServer(): connect() call failed\n"</span> );
00663       <span class="keywordflow">goto</span> Abort;
00664     }
00665   menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> = sock;
00666 
00667   ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00668   <span class="keywordflow">return</span> ret;
00669 
00670   <span class="comment">/* An error occured;</span>
00671 <span class="comment">   * don't blab about here since we already did earlier. */</span>
00672 Abort:
00673   menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> = -1; <span class="comment">/* mark the socket as dead */</span>
00674   <span class="keywordflow">return</span> ret;
00675 }
00676 
00677 
00678 <span class="comment">/*********************************************************************</span>
00679 <span class="comment"> * wsDetachServer: Immediately disconnect from a socket if it's open *</span>
00680 <span class="comment"> *********************************************************************/</span>
<a name="l00681"></a><a class="code" href="ws__clientII_8c.html#a20">00681</a> <span class="keywordtype">void</span> <a class="code" href="ws__clientII_8c.html#a20">wsDetachServer</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu )
00682      <span class="comment">/*  </span>
00683 <span class="comment">Arguments:</span>
00684 <span class="comment">           menu: menu of server to be detached</span>
00685 <span class="comment">      */</span>
00686 {
00687   <span class="keywordflow">if</span> ( !menu || menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> == -1 )
00688     <span class="keywordflow">return</span>;
00689   <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, SOCKET_CLOSE_IMMEDIATELY_EW );
00690   menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> = -1;
00691 }
00692 
00693 
00694 <span class="comment">/*********************************************************************</span>
00695 <span class="comment"> * wsWaitBinHeader: Retrieve the ASCII header of a binary message.   *</span>
00696 <span class="comment"> * The header will be terminated by a newline, but binary characters *</span>
00697 <span class="comment"> * will follow in the same message. Thus this routine must read one  *</span>
00698 <span class="comment"> * character at a time. Since the header is relatively short, this   *</span>
00699 <span class="comment"> * should not be much a performance hit.                             *</span>
00700 <span class="comment"> * Returns after newline is read, when timeout expires if set,       *</span>
00701 <span class="comment"> * or on error.                                                      *</span>
00702 <span class="comment"> *********************************************************************/</span>
<a name="l00703"></a><a class="code" href="ws__clientII_8c.html#a5">00703</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a5">wsWaitBinHeader</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu, <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> buflen,
00704                             <span class="keywordtype">int</span> timeout_msec )
00705      <span class="comment">/*  </span>
00706 <span class="comment">Arguments:</span>
00707 <span class="comment">           menu: menu of server from which message is received</span>
00708 <span class="comment">            buf: buffer in which to place the message, terminated by null.</span>
00709 <span class="comment">         buflen: number of bytes in the buffer.</span>
00710 <span class="comment">   timeout_msec: timout interval in milliseconds. </span>
00711 <span class="comment">         return: WS_ERR_NONE: all went well.</span>
00712 <span class="comment">                 WS_ERR_BUFFER_OVERFLOW: ran out of space before the message</span>
00713 <span class="comment">                  end; calling program will have to decide how serious this is.</span>
00714 <span class="comment">                 WS_ERR_INPUT: missing input parameters.</span>
00715 <span class="comment">                 WS_ERR_SOCKET: error setting socket options.</span>
00716 <span class="comment">                 WS_ERR_TIMEOUT: time expired before we read everything.</span>
00717 <span class="comment">                 WS_ERR_BROKEN_CONNECTION: if the connection failed.</span>
00718 <span class="comment">                 */</span>
00719 {
00720   <span class="keywordtype">int</span> ir = 0;
00721   <span class="keywordtype">int</span> nr = 0;
00722   <span class="keywordtype">char</span> c = <span class="charliteral">'\0'</span>;
00723   <span class="keywordtype">int</span> ret, ioctl_ret;
00724   fd_set ReadableSockets;
00725   Time_ew StartTime;
00726   <span class="keyword">struct </span>timeval SelectTimeout;
00727   Time_ew timeout = <a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00728   <span class="keywordtype">long</span> lOnOff;
00729     
00730   <span class="keywordflow">if</span> ( !buf || buflen &lt;= 0 )
00731     {
00732       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitBinHeader(): no input buffer\n"</span>);
00733       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
00734     }
00735   
00736   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00737   <span class="keywordflow">if</span> (timeout_msec == -1)
00738     {
00739       timeout = 0;
00740       lOnOff = 0;
00741       ioctl_ret = ioctlsocket(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, FIONBIO, &amp;lOnOff);
00742       <span class="keywordflow">if</span> (ioctl_ret == SOCKET_ERROR)
00743         {
00744           ret = <a class="code" href="ws__clientII_8h.html#a11">WS_ERR_SOCKET</a>;
00745           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00746             <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitBinHeader: error %s occurred during change to blocking\n"</span>,
00747                 <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>());
00748           <span class="keywordflow">goto</span> Done;
00749         }
00750     }
00751 
00752   StartTime = <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>(); <span class="comment">/* the timer starts here */</span>
00753   <span class="comment">/* Start reading the socket, one character at a time */</span>
00754   <span class="keywordflow">while</span> ( c != <span class="charliteral">'\n'</span> )
00755     {
00756       <span class="keywordflow">if</span> ((timeout) &amp;&amp; (<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime )
00757         {
00758           ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00759           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitBinHeader timed out\n"</span>);
00760           <span class="keywordflow">goto</span> Done;
00761         }
00762       <span class="keywordflow">if</span> ( ir == buflen - 1 )
00763         {
00764           <span class="comment">/* stop if there's no more room  */</span>
00765           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00766             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitBinHeader(): reply buffer overflows\n"</span> );
00767           ret = <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a>;
00768           <span class="keywordflow">goto</span> Done;
00769         }
00770 
00771       <span class="comment">/* try to get a char from socket */</span>
00772       nr = recv( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, &amp;c, 1, 0 );
00773       <span class="keywordflow">if</span> ( nr == -1 &amp;&amp; <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW ) 
00774         {
00775           FD_ZERO( &amp;ReadableSockets );
00776           FD_SET( (SOCKET)(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>), &amp;ReadableSockets );
00777           <span class="keywordflow">while</span> (( !select(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> + 1, &amp;ReadableSockets, 0, 0,
00778                            <a class="code" href="socket__ew__common_8c.html#a4">resetTimeout</a>( &amp;SelectTimeout)))) 
00779             {
00780               <span class="keywordflow">if</span> ((timeout) &amp;&amp; (<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime ) 
00781                 {
00782                   ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00783                   <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitBinHeader timed out\n"</span>);
00784                   <span class="keywordflow">goto</span> Done;
00785                 }
00786               FD_ZERO( &amp;ReadableSockets );
00787               FD_SET( (SOCKET)(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>), &amp;ReadableSockets );
00788               <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100); <span class="comment">/* wait a little and try again */</span>
00789             }
00790           <span class="comment">/* select() says won't block */</span>
00791           nr = recv( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, &amp;c, 1, 0 ); 
00792         }
00793       <span class="keywordflow">if</span> ( nr == 1 &amp;&amp; c != 0 )
00794         {
00795           <span class="comment">/* got a character; save it      */</span>
00796           buf[ir++] = c;
00797         }
00798       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( nr == -1 )
00799         {
00800           <span class="comment">/* trouble reading socket        */</span>
00801           ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00802           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00803             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitBinHeader(): Error on socket recv()\n"</span> );
00804           <span class="keywordflow">goto</span> Done;
00805         }
00806     }
00807   buf[ir] = <span class="charliteral">'\0'</span>;                   <span class="comment">/* null-terminate the buf      */</span>
00808 
00809   ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00810 
00811 Done:
00812   buf[ir] = <span class="charliteral">'\0'</span>;                 <span class="comment">/* null-terminate the buf      */</span>
00813   <span class="comment">/* If there was no timeout, then change the socket back to non-blocking */</span>
00814   <span class="keywordflow">if</span> (timeout_msec == -1) 
00815     {
00816       lOnOff = 1;
00817       ioctl_ret = ioctlsocket( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, FIONBIO, &amp;lOnOff);
00818       <span class="keywordflow">if</span> (ioctl_ret == SOCKET_ERROR)
00819         {
00820           
00821           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
00822             <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,<span class="stringliteral">"wsWaitBinHeader: error %s occurred during change to non-blocking\n"</span>, 
00823               <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() );
00824           ret = <a class="code" href="ws__clientII_8h.html#a11">WS_ERR_SOCKET</a>;
00825         }
00826     }
00827   <span class="keywordflow">return</span> ret;
00828 }
00829 
00830 
00831 <span class="comment">/*******************************************************************</span>
00832 <span class="comment"> * wsWaitAscii: Retrieve an ASCII message.                         *</span>
00833 <span class="comment"> * The message will be terminated by a newline; nothing else is    *</span>
00834 <span class="comment"> * expected after the newline, so we can read several characters   *</span>
00835 <span class="comment"> * at a time without fear of reading past the newline.             *</span>
00836 <span class="comment"> * This message may have internal nulls which will be converted to *</span>
00837 <span class="comment"> * spaces.                                                         *</span>
00838 <span class="comment"> * Returns after newline is read, when timeout expires if set,     *</span>
00839 <span class="comment"> * or on error.                                                    *</span>
00840 <span class="comment"> *******************************************************************/</span>
<a name="l00841"></a><a class="code" href="ws__clientII_8c.html#a4">00841</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a4">wsWaitAscii</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu, <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> buflen, <span class="keywordtype">int</span> timeout_msec )
00842      <span class="comment">/*</span>
00843 <span class="comment">Arguments:</span>
00844 <span class="comment">           menu: menu of server from which message is received</span>
00845 <span class="comment">            buf: buffer in which to place the message, terminated by null.</span>
00846 <span class="comment">         buflen: number of bytes in the buffer.</span>
00847 <span class="comment">   timeout_msec: timout interval in milliseconds. </span>
00848 <span class="comment">         return: WS_ERR_NONE: all went well.</span>
00849 <span class="comment">                 WS_ERR_BUFFER_OVERFLOW: ran out of space before the message</span>
00850 <span class="comment">                  end; calling program will have to decide how serious this is.</span>
00851 <span class="comment">                 WS_ERR_INPUT: missing input parameters.</span>
00852 <span class="comment">                 WS_ERR_SOCKET: error setting socket options.</span>
00853 <span class="comment">                 WS_ERR_TIMEOUT: time expired before we read everything.</span>
00854 <span class="comment">                 WS_ERR_BROKEN_CONNECTION: if the connection failed.</span>
00855 <span class="comment">                 */</span>
00856 {
00857   <span class="keywordtype">int</span> ii, ir = 0;  <span class="comment">/* character counters */</span>
00858   <span class="keywordtype">int</span> nr = 0;
00859   <span class="keywordtype">char</span> c = <span class="charliteral">'\0'</span>;
00860   <span class="keywordtype">int</span> len = 0;
00861   <span class="keywordtype">int</span> ret, ioctl_ret;
00862   fd_set ReadableSockets;
00863   Time_ew StartTime;
00864   <span class="keyword">struct </span>timeval SelectTimeout;
00865   Time_ew timeout = <a class="code" href="socket__ew_8c.html#a8">adjustTimeoutLength</a>(timeout_msec);
00866   <span class="keywordtype">long</span> lOnOff;
00867   
00868   <span class="keywordflow">if</span> ( !buf || buflen &lt;= 0 )
00869     {
00870       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitAscii(): no input buffer\n"</span>);
00871       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
00872     }
00873 
00874   <span class="comment">/* If there is no timeout, make the socket blocking */</span>
00875   <span class="keywordflow">if</span> (timeout_msec == -1)
00876     {
00877       timeout = 0;
00878       lOnOff = 0;
00879       ioctl_ret = ioctlsocket(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, FIONBIO, &amp;lOnOff);
00880       <span class="keywordflow">if</span> (ioctl_ret == SOCKET_ERROR)
00881         {
00882           ret = <a class="code" href="ws__clientII_8h.html#a11">WS_ERR_SOCKET</a>;
00883           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>,
00884                 <span class="stringliteral">"wsWaitAscii: error %s occurred during change to blocking\n"</span>,
00885                                  <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>());
00886         <span class="keywordflow">goto</span> Done;
00887         }
00888     }
00889 
00890   StartTime = <a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>(); <span class="comment">/* the timer starts here */</span>
00891   <span class="keywordflow">while</span> ( c != <span class="charliteral">'\n'</span> )
00892     {
00893       <span class="keywordflow">if</span> ((timeout) &amp;&amp; (<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime ) 
00894         {
00895           ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00896           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitAscii timed out\n"</span>);
00897           <span class="keywordflow">goto</span> Done;
00898         }
00899       <span class="keywordflow">if</span> ( ir &gt;= buflen - 2 )
00900         {
00901           <span class="keywordflow">if</span> (WS_CL_DEBUG)
00902             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitAscii(): reply buffer overflows\n"</span> );
00903           ret = <a class="code" href="ws__client_8h.html#a4">WS_ERR_BUFFER_OVERFLOW</a>;
00904           <span class="keywordflow">goto</span> Done;
00905         }
00906       len = <a class="code" href="ws__clientII_8c.html#a0">WS_MAX_RECV_BUF_LEN</a>;
00907       <span class="keywordflow">if</span> ( ir + len &gt;= buflen - 1 )
00908         len = buflen - ir - 2; <span class="comment">/* leave room for the terminating null */</span>
00909       nr = recv( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, &amp;buf[ir], len, 0 );
00910       <span class="keywordflow">if</span> ( nr == -1 &amp;&amp; <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() == WOULDBLOCK_EW ) 
00911         {
00912           FD_ZERO( &amp;ReadableSockets );
00913           FD_SET( (SOCKET)(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>), &amp;ReadableSockets );
00914           <span class="keywordflow">while</span> (( !select(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a> + 1, &amp;ReadableSockets, 0, 0,
00915                            <a class="code" href="socket__ew__common_8c.html#a4">resetTimeout</a>( &amp;SelectTimeout)))) 
00916             {
00917               <span class="keywordflow">if</span> ((timeout) &amp;&amp; (<a class="code" href="socket__ew_8c.html#a7">GetTime_ew</a>() - timeout) &gt; StartTime ) 
00918                 {
00919                   ret = <a class="code" href="ws__client_8h.html#a9">WS_ERR_TIMEOUT</a>;
00920                   <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitAscii timed out\n"</span>);
00921                   <span class="keywordflow">goto</span> Done;
00922                 }
00923               FD_ZERO( &amp;ReadableSockets );
00924               FD_SET( (SOCKET)(menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>), &amp;ReadableSockets );
00925               <a class="code" href="sleep__ew_8c.html#a0">sleep_ew</a>(100); <span class="comment">/* wait a little and try again */</span>
00926             }
00927           <span class="comment">/* poll() says won't block */</span>
00928           nr = recv( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, &amp;buf[ir], len, 0 ); 
00929         }
00930       
00931       <span class="keywordflow">if</span> ( nr == -1 || nr &gt; len )
00932         {
00933           <span class="comment">/* trouble reading socket        */</span>
00934           ret = <a class="code" href="ws__client_8h.html#a2">WS_ERR_BROKEN_CONNECTION</a>;
00935           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsWaitAscii(): Error on socket recv()\n"</span> );
00936           <span class="keywordflow">goto</span> Done;
00937         }
00938       <span class="keywordflow">if</span> ( nr &gt; 0 )
00939         {
00940           ii = 0;
00941           <span class="comment">/* got something, adjust ir and c  */</span>
00942           ir += nr;
00943           c = buf[ir-1];
00944           
00945           <span class="comment">/* replace NULL char in ascii string with SPACE char */</span>
00946           <span class="keywordflow">while</span> ( ii &lt; nr ) 
00947             {
00948               <span class="keywordflow">if</span> ( !buf[ir-nr+ii] ) buf[ir-nr+ii] = <span class="charliteral">' '</span>;
00949               ++ii;
00950             }
00951         }
00952     }
00953   
00954   ret = <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
00955 Done:
00956   buf[ir] = <span class="charliteral">'\0'</span>;                 <span class="comment">/* null-terminate the reply      */</span>
00957   <span class="comment">/* If there was no timeout, then change the socket back to non-blocking */</span>
00958   <span class="keywordflow">if</span> (timeout_msec == -1) 
00959     {
00960       lOnOff = 1;
00961       ioctl_ret = ioctlsocket( menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m2">sock</a>, FIONBIO, &amp;lOnOff);
00962       <span class="keywordflow">if</span> (ioctl_ret == SOCKET_ERROR) 
00963         {
00964           
00965           <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"et"</span>, <span class="stringliteral">"wsWaitAScii: error %s occurred during change to non-blocking\n"</span>, 
00966                                  <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>() );
00967           ret = <a class="code" href="ws__clientII_8h.html#a11">WS_ERR_SOCKET</a>;
00968         }
00969     }
00970   <span class="keywordflow">return</span> ret;
00971 }
00972 
00973 <span class="comment">/***********************************************************************</span>
00974 <span class="comment"> * wsParseMenuReply: parse the reply we got from the waveserver into   *</span>
00975 <span class="comment"> * a menu list. Handles replies to MENU, MENUPIN and MENUSCN requests. *</span>
00976 <span class="comment"> ***********************************************************************/</span>
<a name="l00977"></a><a class="code" href="ws__clientII_8c.html#a6">00977</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a6">wsParseMenuReply</a>( <a class="code" href="struct__WS__MENU__REC.html">WS_MENU</a> menu, <span class="keywordtype">char</span>* reply )
00978 {
00979   <span class="comment">/* Arguments:</span>
00980 <span class="comment">   *       menu: pointer to menu structure to be allocated and filled in.</span>
00981 <span class="comment">   *      reply: pointer to reply to be parsed.</span>
00982 <span class="comment">   *   Returns: WS_ERR_NONE:  if all went well</span>
00983 <span class="comment">   *            WS_ERR_INPUT: if bad input parameters</span>
00984 <span class="comment">   *            WS_ERR_PARSE: if we couldn't parse the reply</span>
00985 <span class="comment">   *            WS_ERR_MEMORY: if out of memory</span>
00986 <span class="comment">   */</span>
00987   <span class="keywordtype">int</span> reqid = 0;
00988   <span class="keywordtype">int</span> pinno = 0;
00989   <span class="keywordtype">char</span> sta[7];
00990   <span class="keywordtype">char</span> chan[9];
00991   <span class="keywordtype">char</span> net[9];
00992   <span class="keywordtype">double</span> tankStarttime = 0.0, tankEndtime = 0.0;
00993   <span class="keywordtype">char</span> datatype[3];
00994   <span class="keywordtype">int</span> scn_pos = 0;
00995 
00996   <span class="keywordflow">if</span> ( !reply || !menu )
00997     {
00998       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsParseMenuReply: WS_ERR_INPUT\n"</span>);
00999       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
01000     }
01001 
01002   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%d"</span>, &amp;reqid ) &lt; 1 )
01003     {
01004       <span class="keywordflow">if</span> (WS_CL_DEBUG)
01005         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseMenuReply(): error parsing reqid\n"</span> );
01006       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01007     }
01008   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01009   <span class="keywordflow">while</span> ( reply[scn_pos] &amp;&amp; reply[scn_pos] != <span class="charliteral">'\n'</span> )
01010     {
01011       <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN</a> pscn = NULL;
01012       <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%d %s %s %s %lf %lf %s"</span>,
01013                    &amp;pinno, sta, chan, net,
01014                    &amp;tankStarttime, &amp;tankEndtime, datatype ) &lt; 7 )
01015         {
01016           <span class="keywordflow">if</span> (WS_CL_DEBUG)
01017             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseMenuReply(): error decoding reply&lt;%s&gt;\n"</span>,
01018                  &amp;reply[scn_pos] );
01019           <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01020         }
01021       pscn = ( <a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN_REC</a>* )calloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__WS__PSCN__REC.html">WS_PSCN_REC</a>),1);
01022       <span class="keywordflow">if</span> ( !pscn )
01023         {
01024           <span class="keywordflow">if</span> (WS_CL_DEBUG)
01025             <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"wsParseMenuReply(): error allocating memory\n"</span>);
01026           <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a3">WS_ERR_MEMORY</a>;
01027         }
01028 
01029       pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m6">next</a> = menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a>;
01030       pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m3">pinno</a> = pinno;
01031       strcpy( pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m0">sta</a>, sta );
01032       strcpy( pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m1">chan</a>, chan );
01033       strcpy( pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m2">net</a>, net );
01034       pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m4">tankStarttime</a> = tankStarttime;
01035       pscn-&gt;<a class="code" href="struct__WS__PSCN__REC.html#m5">tankEndtime</a> = tankEndtime;
01036       menu-&gt;<a class="code" href="struct__WS__MENU__REC.html#m3">pscn</a> = pscn;
01037       <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 7, &amp;scn_pos );
01038     }
01039 
01040   <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
01041 }
01042 
01043 <span class="comment">/***********************************************************************</span>
01044 <span class="comment"> * wsParseBinHeaderReply: parse the reply we got from the waveserver   *</span>
01045 <span class="comment"> * into a TRACE_REQ structure. Handles the header for replies reply to *</span>
01046 <span class="comment"> * GETSCNRAW requests.                                                 *</span>
01047 <span class="comment"> ***********************************************************************/</span>
<a name="l01048"></a><a class="code" href="ws__clientII_8c.html#a7">01048</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a7">wsParseBinHeaderReply</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>* getThis, <span class="keywordtype">char</span>* reply )
01049 {
01050   <span class="comment">/* Arguments:</span>
01051 <span class="comment">   *    getThis: pointer to TRACE_REQ structure to be filled with reply info</span>
01052 <span class="comment">   *      reply: pointer to reply to be parsed.</span>
01053 <span class="comment">   *   Returns: WS_ERR_NONE:  if all went well</span>
01054 <span class="comment">   *            WS_ERR_INPUT: if bad input parameters</span>
01055 <span class="comment">   *            WS_ERR_PARSE: if we couldn't parse part of the reply</span>
01056 <span class="comment">   *            WS_WRN_FLAGGED: server sent us a no-data flag</span>
01057 <span class="comment">   */</span>
01058   <span class="keywordtype">int</span> reqid = 0;
01059   <span class="keywordtype">int</span> pinno = 0;
01060   <span class="keywordtype">char</span> sta[7];
01061   <span class="keywordtype">char</span> chan[9];
01062   <span class="keywordtype">char</span> net[9];
01063   <span class="keywordtype">char</span> flag[9];
01064   <span class="keywordtype">char</span> datatype[3];
01065   <span class="keywordtype">double</span> tankStarttime = 0.0, tankEndtime = 0.0;
01066   <span class="keywordtype">int</span> bin_len = 0;
01067   <span class="keywordtype">int</span> scn_pos = 0;
01068   <span class="keywordtype">char</span> *buf = NULL;
01069 
01070   <span class="keywordflow">if</span> ( !reply || !getThis )
01071     {
01072       <span class="keywordflow">if</span> (WS_CL_DEBUG)
01073         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsParseBinHeaderReply(): bad input parameters\n"</span>);
01074       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
01075     }
01076 
01077   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%d %d"</span>, &amp;reqid, &amp;pinno ) &lt; 2 )
01078     {
01079       <span class="keywordflow">if</span> (WS_CL_DEBUG)
01080         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing reqid/pinno\n"</span> );
01081       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01082     }
01083   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01084 
01085   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%s %s %s"</span>, sta, chan, net ) &lt; 3 )
01086     {
01087       <span class="keywordflow">if</span> (WS_CL_DEBUG) <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing SCN\n"</span> );
01088       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01089     }
01090   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 3, &amp;scn_pos );
01091 
01092   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%s %s"</span>, flag, datatype ) &lt; 2 )
01093     {
01094       <span class="keywordflow">if</span> (WS_CL_DEBUG)
01095         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing flag/datatype\n"</span> );
01096       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01097     }
01098   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01099 
01100   <span class="keywordflow">if</span> ( strlen(flag) == 1 )
01101     {
01102       <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf %lf"</span>, &amp;tankStarttime, 
01103                    &amp;tankEndtime ) &lt; 2 )
01104         {
01105           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01106             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing starttime/endtime\n"</span> );
01107           <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01108         }
01109       <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01110 
01111       <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%d"</span>, &amp;bin_len ) &lt; 1 )
01112         {
01113           <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01114             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing bin_len\n"</span> );
01115           <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01116         }
01117       <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01118 
01119     }
01120   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strlen(flag) == 2 )
01121     {
01122       tankStarttime = 0.0;
01123       tankEndtime = 0.0;
01124       bin_len = 0;
01125       <span class="keywordflow">if</span> ( strcmp(flag,<span class="stringliteral">"FL"</span>) == 0 )
01126         {
01127           <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf"</span>, &amp;tankStarttime) &lt; 1 )
01128             {
01129               <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01130                 <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing starttime\n"</span> );
01131               <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01132             }
01133           <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01134         }
01135       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp(flag,<span class="stringliteral">"FR"</span>) == 0 )
01136         {
01137           <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf"</span>, &amp;tankEndtime) &lt; 1 )
01138             {
01139               <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01140                 <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): error parsing endtime\n"</span> );
01141               <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01142             }
01143           <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01144         }
01145     }
01146   <span class="keywordflow">else</span>
01147     {
01148       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01149         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseBinHeaderReply(): bad flag[%s]\n"</span>, flag );
01150       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01151     }
01152 
01153   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m3">pinno</a> = pinno;
01154   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m13">actStarttime</a> = tankStarttime;
01155   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m14">actEndtime</a> = tankEndtime;
01156   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m16">samprate</a> = (double) 0.0; <span class="comment">/* server doesn't send this */</span>
01157   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a> = bin_len;
01158   <span class="keywordflow">if</span> ( strlen( flag ) &gt;= 2 ) {
01159     getThis-&gt;<a class="code" href="structTRACE__REQ.html#m11">retFlag</a> = flag[1];
01160     <span class="keywordflow">return</span> <a class="code" href="ws__clientII_8h.html#a0">WS_WRN_FLAGGED</a>;
01161   } <span class="keywordflow">else</span> {
01162     getThis-&gt;<a class="code" href="structTRACE__REQ.html#m11">retFlag</a> = <span class="charliteral">'\0'</span>;
01163     <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
01164   }
01165 }
01166 
01167 
01168 <span class="comment">/***********************************************************************</span>
01169 <span class="comment"> * wsParseAsciiHeaderReply: parse the reply we got from the waveserver *</span>
01170 <span class="comment"> * into a TRACE_REQ structure. Handles the header for replies reply to *</span>
01171 <span class="comment"> * GETSCN and GETPIN requests.                                         *</span>
01172 <span class="comment"> ***********************************************************************/</span>
<a name="l01173"></a><a class="code" href="ws__clientII_8c.html#a8">01173</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a8">wsParseAsciiHeaderReply</a>( <a class="code" href="structTRACE__REQ.html">TRACE_REQ</a>* getThis, <span class="keywordtype">char</span>* reply )
01174 {
01175   <span class="comment">/* Arguments:</span>
01176 <span class="comment">   *    getThis: pointer to TRACE_REQ structure to be filled with reply info</span>
01177 <span class="comment">   *      reply: pointer to reply to be parsed.</span>
01178 <span class="comment">   *   Returns: WS_ERR_NONE:  if all went well</span>
01179 <span class="comment">   *            WS_ERR_INPUT: if bad input parameters</span>
01180 <span class="comment">   *            WS_ERR_PARSE: if we couldn't parse part of the reply</span>
01181 <span class="comment">   *            WS_WRN_FLAGGED: server sent us a no-data flag</span>
01182 <span class="comment">   */</span>
01183   <span class="keywordtype">int</span> reqid = 0;
01184   <span class="keywordtype">int</span> pinno = 0;
01185   <span class="keywordtype">char</span> sta[7];
01186   <span class="keywordtype">char</span> chan[9];
01187   <span class="keywordtype">char</span> net[9];
01188   <span class="keywordtype">char</span> flag[9];
01189   <span class="keywordtype">char</span> datatype[3];
01190   <span class="keywordtype">double</span> tankStarttime = 0.0, samprate = 0.0;
01191   <span class="keywordtype">int</span> scn_pos = 0;
01192 
01193   <span class="keywordflow">if</span> ( !reply )
01194     {
01195       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01196         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"wsParseAsciiHeaderReply(): bad input parameters\n"</span>);
01197       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a8">WS_ERR_INPUT</a>;
01198     }
01199 
01200   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%d %d"</span>, &amp;reqid, &amp;pinno ) &lt; 2 )
01201     {
01202       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01203         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing reqid/pinno\n"</span> );
01204       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01205     }
01206   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01207 
01208   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%s %s %s"</span>, sta, chan, net ) &lt; 3 )
01209     {
01210       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01211         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing SCN\n"</span> );
01212       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01213     }
01214   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 3, &amp;scn_pos );
01215 
01216   <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%s %s"</span>, flag, datatype ) &lt; 2 )
01217     {
01218       <span class="keywordflow">if</span> (WS_CL_DEBUG) 
01219         <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing flag/datatype\n"</span> );
01220       <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01221     }
01222   <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01223 
01224   <span class="keywordflow">if</span> ( strlen(flag) == 1 || strcmp(flag,<span class="stringliteral">"FG"</span>) == 0 )
01225     {
01226       <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf %lf"</span>, &amp;tankStarttime, &amp;samprate ) &lt; 2 )
01227         {
01228           <span class="keywordflow">if</span> (WS_CL_DEBUG)
01229             <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing startT/samprate\n"</span> );
01230           <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01231         }
01232       <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 2, &amp;scn_pos );
01233     }
01234   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strlen(flag) == 2 )
01235     {
01236       tankStarttime = 0.0;
01237       samprate = 0.0;
01238       <span class="keywordflow">if</span> ( strcmp(flag,<span class="stringliteral">"FL"</span>) == 0 )
01239         {
01240           <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf"</span>, &amp;tankStarttime) &lt; 1 )
01241             {
01242               <span class="keywordflow">if</span> (WS_CL_DEBUG)
01243                 <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing startTime\n"</span> );
01244               <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01245             }
01246           <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01247         }
01248       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp(flag,<span class="stringliteral">"FR"</span>) == 0 )
01249         {
01250           <span class="keywordflow">if</span> ( sscanf( &amp;reply[scn_pos], <span class="stringliteral">"%lf"</span>, &amp;samprate) &lt; 1 )
01251             {
01252               <span class="keywordflow">if</span> (WS_CL_DEBUG)
01253                 <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>,<span class="stringliteral">"wsParseAsciiHeaderReply(): error parsing samprate\n"</span> );
01254               <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a11">WS_ERR_PARSE</a>;
01255             }
01256           <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( reply, 1, &amp;scn_pos );
01257         }
01258     }
01259 
01260   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m3">pinno</a> = pinno;
01261   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m13">actStarttime</a> = tankStarttime;
01262   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m14">actEndtime</a> = (double) 0.0;
01263   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m16">samprate</a> = samprate;
01264   getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a> = strlen( reply ) - scn_pos;
01265   memmove(reply, &amp;reply[scn_pos], getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a>);
01266   reply[getThis-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a>] = 0;
01267   
01268   <span class="keywordflow">if</span> ( strlen( flag ) &gt;= 2 ) {
01269     getThis-&gt;<a class="code" href="structTRACE__REQ.html#m11">retFlag</a> = flag[1];
01270     <span class="keywordflow">return</span> <a class="code" href="ws__clientII_8h.html#a0">WS_WRN_FLAGGED</a>;
01271   } <span class="keywordflow">else</span> {
01272     getThis-&gt;<a class="code" href="structTRACE__REQ.html#m11">retFlag</a> = <span class="charliteral">'\0'</span>;
01273     <span class="keywordflow">return</span> <a class="code" href="ws__client_8h.html#a0">WS_ERR_NONE</a>;
01274   }
01275 }
01276 
01277 
01278 <span class="comment">/**************************************************************************</span>
01279 <span class="comment"> *      wsSkipN: moves forward the pointer *posp in buf by moving forward *</span>
01280 <span class="comment"> *      cnt words.  Words are delimited by either space or horizontal     *</span>
01281 <span class="comment"> *      tabs; newline marks the end of the buffer.                        *</span>
01282 <span class="comment"> **************************************************************************/</span>
<a name="l01283"></a><a class="code" href="ws__clientII_8c.html#a9">01283</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ws__clientII_8c.html#a9">wsSkipN</a>( <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> cnt, <span class="keywordtype">int</span>* posp )
01284 {
01285   <span class="keywordtype">int</span> pos = *posp;
01286 
01287   <span class="keywordflow">while</span> ( cnt )
01288     {
01289       <span class="keywordflow">while</span> ( buf[pos] != <span class="charliteral">' '</span> &amp;&amp; buf[pos] != <span class="charliteral">'\t'</span> )
01290         {
01291           <span class="keywordflow">if</span> ( !buf[pos] )
01292             {
01293               <span class="keywordflow">goto</span> done;
01294             }
01295           <span class="keywordflow">if</span> ( buf[pos] == <span class="charliteral">'\n'</span> )
01296             {
01297               ++pos;
01298               <span class="keywordflow">goto</span> done;
01299             }
01300           ++pos;
01301         }
01302       --cnt;
01303       <span class="keywordflow">while</span> ( buf[pos] == <span class="charliteral">' '</span> || buf[pos] == <span class="charliteral">'\t'</span> )
01304         {
01305           ++pos;
01306         }
01307     }
01308 done:
01309   *posp = pos;
01310 }
01311 
<a name="l01312"></a><a class="code" href="ws__clientII_8c.html#a21">01312</a> <span class="keywordtype">int</span> <a class="code" href="ws__clientII_8c.html#a21">setWsClient_ewDebug</a>(<span class="keywordtype">int</span> debug)
01313 {
01314   <span class="comment">/* setWsClient_ewDebug() turns debugging on or off for </span>
01315 <span class="comment">     the ws_clientII routines</span>
01316 <span class="comment">     */</span>
01317   <a class="code" href="ws__clientII_8c.html#a2">WS_CL_DEBUG</a>=debug;
01318   <span class="keywordflow">return</span>(0);
01319 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:13 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
