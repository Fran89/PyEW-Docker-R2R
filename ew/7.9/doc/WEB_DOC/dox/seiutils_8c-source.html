<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>seiutils.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>seiutils.c</h1><a href="seiutils_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment"> * seiutils.c - routines for writing seisan waveform files</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * NB - the general parts of this file are also used by the GSE</span>
00005 <span class="comment"> *      put away routines</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Seisan file format synopsis:</span>
00008 <span class="comment"> * </span>
00009 <span class="comment"> * Record | Size | Description</span>
00010 <span class="comment"> * -------+------+--------------------------------------------------</span>
00011 <span class="comment"> * 1      | 80   | Network name, number of stations, event time</span>
00012 <span class="comment"> * 2      | 80   | Not used</span>
00013 <span class="comment"> * 3      | 80   | 1st, 2nd, 3rd channel details</span>
00014 <span class="comment"> * 4-N    | 80   | Other channel details, 3 per record - there is</span>
00015 <span class="comment"> *        |      | a minimum of 12 channel headers, so N has</span>
00016 <span class="comment"> *        |      | a minimum value of 6 (but no maximum value)</span>
00017 <span class="comment"> * N+1    | 1040 | Channel 1 header - time and response data</span>
00018 <span class="comment"> * N+2    | X    | Channel 1 data - entire data is written</span>
00019 <span class="comment"> *        |      | as a single record</span>
00020 <span class="comment"> * ...    |      | Channel 2,3,... header/data follow</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * Sizes are in bytes. Each record is written with its length as</span>
00023 <span class="comment"> * a 4 byte integer immediately before and after the data:</span>
00024 <span class="comment"> *   &lt;length (4 bytes)&gt; &lt;record (x bytes)&gt; &lt;length (4 bytes)&gt;</span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> * To work correctly, you must call the routines in this file in the</span>
00027 <span class="comment"> * following order:</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *      open_seisan_file()</span>
00030 <span class="comment"> *      foreach channel</span>
00031 <span class="comment"> *              add_seisan_channel()</span>
00032 <span class="comment"> *      foreach channel</span>
00033 <span class="comment"> *              start_seisan_channel()</span>
00034 <span class="comment"> *              add_seisan_channel_data()</span>
00035 <span class="comment"> *              end_seisan_channel()</span>
00036 <span class="comment"> *      close_seisan_file()</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * S. Flower, Oct 2001</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> ***************************************************************************/</span>
00041 
00042 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00043 <span class="preprocessor">#include &lt;time.h&gt;</span>
00044 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00045 <span class="preprocessor">#include &lt;string.h&gt;</span>
00046 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00047 <span class="preprocessor">#include &lt;math.h&gt;</span>
00048 <span class="preprocessor">#include &lt;float.h&gt;</span>
00049 
00050 <span class="comment">/* operating system specific includes */</span>
00051 <span class="preprocessor">#if defined (_WINNT)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#include &lt;direct.h&gt;</span>
00053 <span class="preprocessor">#include &lt;io.h&gt;</span>
00054 <span class="preprocessor">#elif defined  (_SOLARIS)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00056 <span class="preprocessor">#else</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#error "_WINNT or _SOLARIS must be set before compiling"</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00059 <span class="preprocessor"></span>
00060 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00061 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00062 
00063 <span class="preprocessor">#include "<a class="code" href="earthworm_8h.html">earthworm.h</a>"</span>
00064 <span class="preprocessor">#include "<a class="code" href="trace__buf_8h.html">trace_buf.h</a>"</span>
00065 <span class="preprocessor">#include "<a class="code" href="swap_8h.html">swap.h</a>"</span>
00066 <span class="preprocessor">#include "<a class="code" href="ws__clientII_8h.html">ws_clientII.h</a>"</span>
00067 <span class="preprocessor">#include "<a class="code" href="site_8h.html">site.h</a>"</span>
00068 <span class="preprocessor">#include "<a class="code" href="time__ew_8h.html">time_ew.h</a>"</span>
00069 
00070 <span class="preprocessor">#include "<a class="code" href="seihead_8h.html">seihead.h</a>"</span>
00071 
00072 <span class="comment">/* private global variables */</span>
<a name="l00073"></a><a class="code" href="seiutils_8c.html#a0">00073</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="seiutils_8c.html#a0">output_dir</a> [<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];   <span class="comment">/* directory to use for output file */</span>
<a name="l00074"></a><a class="code" href="seiutils_8c.html#a1">00074</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="seiutils_8c.html#a1">tmp_dirname</a> [<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];  <span class="comment">/* name of the temporary directory for this request */</span>
<a name="l00075"></a><a class="code" href="seiutils_8c.html#a2">00075</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="seiutils_8c.html#a2">network_name</a> [50];          <span class="comment">/* name of the network for this request */</span>
<a name="l00076"></a><a class="code" href="seiutils_8c.html#a3">00076</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="seiutils_8c.html#a3">start_time</a>;               <span class="comment">/* start time of requested data */</span>
<a name="l00077"></a><a class="code" href="seiutils_8c.html#a4">00077</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="seiutils_8c.html#a4">duration</a>;                 <span class="comment">/* duration of requested data */</span>
<a name="l00078"></a><a class="code" href="seiutils_8c.html#a5">00078</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a5">n_channels</a>;                  <span class="comment">/* number of channels in this request */</span>
<a name="l00079"></a><a class="code" href="seiutils_8c.html#a6">00079</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structSei__channel__details.html">Sei_channel_details</a> *<a class="code" href="seiutils_8c.html#a6">channels</a>;            <span class="comment">/* channel details for this request */</span>
<a name="l00080"></a><a class="code" href="seiutils_8c.html#a7">00080</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structSei__channel__details.html">Sei_channel_details</a> *<a class="code" href="seiutils_8c.html#a7">current_channel</a>;     <span class="comment">/* channel currently being processed */</span>
<a name="l00081"></a><a class="code" href="seiutils_8c.html#a8">00081</a> <span class="keyword">static</span> FILE *<a class="code" href="seiutils_8c.html#a8">channel_fp</a>;                <span class="comment">/* currently open data file */</span>
<a name="l00082"></a><a class="code" href="seiutils_8c.html#a9">00082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>;       <span class="comment">/* if TRUE write numbers without byte swapping */</span>
<a name="l00083"></a><a class="code" href="seiutils_8c.html#a10">00083</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a10">tmp_dir_count</a> = 0;           <span class="comment">/* count of temporary directories */</span>
00084 
00085 <span class="comment">/* private forward declarations */</span>
00086 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (FILE *fp, <span class="keywordtype">long</span> length, <span class="keywordtype">void</span> *data);
00087 
00088 
00089 <span class="comment">/***************************************************************************</span>
00090 <span class="comment"> * open_seisan_file</span>
00091 <span class="comment"> *</span>
00092 <span class="comment"> * Description: open a Seisan file and write the start of the header</span>
00093 <span class="comment"> *</span>
00094 <span class="comment"> * Input parameters: od - the directory for seisan files</span>
00095 <span class="comment"> *                   nn - the network name</span>
00096 <span class="comment"> *                   st - the start time for the data</span>
00097 <span class="comment"> *                   dur - length of data in seconds</span>
00098 <span class="comment"> *                   onn - if TRUE write numbers without byte swapping</span>
00099 <span class="comment"> * Output parameters: channel details </span>
00100 <span class="comment"> * Returns: TRUE on success, FALSE on error</span>
00101 <span class="comment"> *</span>
00102 <span class="comment"> * Comments:</span>
00103 <span class="comment"> *</span>
00104 <span class="comment"> ***************************************************************************/</span>
<a name="l00105"></a><a class="code" href="seiutils_8c.html#a12">00105</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a12">open_seisan_file</a> (<span class="keywordtype">char</span> *od, <span class="keywordtype">char</span> *nn, <span class="keywordtype">double</span> st, <span class="keywordtype">double</span> dur, <span class="keywordtype">int</span> onn)
00106 
00107 {
00108 
00109   <span class="comment">/* create a temporary directory for the parts of the seisan file */</span>
00110   sprintf (tmp_dirname, <span class="stringliteral">"%s%c%d_%d_sei.tmp"</span>,
00111            od, DIR_DELIM, getpid (), tmp_dir_count ++);
00112   <span class="keywordflow">if</span> (<a class="code" href="dirops__ew_8c.html#a1">CreateDir</a> (tmp_dirname) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00113 
00114   <span class="comment">/* reset global variables */</span>
00115   strcpy (output_dir, od);
00116   strcpy (network_name, nn);
00117   <a class="code" href="seiutils_8c.html#a3">start_time</a> = st;
00118   <a class="code" href="seiutils_8c.html#a4">duration</a> = dur;
00119   <a class="code" href="seiutils_8c.html#a5">n_channels</a> = 0;
00120   <a class="code" href="seiutils_8c.html#a6">channels</a> = <a class="code" href="seiutils_8c.html#a7">current_channel</a> = 0;
00121   <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a> = onn;
00122 
00123   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00124 
00125 }
00126 
00127 <span class="comment">/***************************************************************************</span>
00128 <span class="comment"> * add_seisan_channel</span>
00129 <span class="comment"> *</span>
00130 <span class="comment"> * Description: add a channel to the current seisan file</span>
00131 <span class="comment"> *</span>
00132 <span class="comment"> * Input parameters: chan_name, type - the channel name and type</span>
00133 <span class="comment"> *                                     (e.g. EKR1, SZ)</span>
00134 <span class="comment"> * Output parameters: none</span>
00135 <span class="comment"> * Returns: TRUE if channel added OK, FALSE otherwise</span>
00136 <span class="comment"> *</span>
00137 <span class="comment"> * Comments: all channels must be added using this routine before any</span>
00138 <span class="comment"> * channel data is written - channels that are not added will be</span>
00139 <span class="comment"> * ignored</span>
00140 <span class="comment"> *</span>
00141 <span class="comment"> ***************************************************************************/</span>
<a name="l00142"></a><a class="code" href="seiutils_8c.html#a13">00142</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a13">add_seisan_channel</a> (<span class="keywordtype">char</span> *chan_name, <span class="keywordtype">char</span> *chan_type)
00143 
00144 {
00145 
00146   <span class="keyword">struct </span><a class="code" href="structSei__channel__details.html">Sei_channel_details</a> *channel_ptr;
00147 
00148 
00149   <span class="comment">/* allocate memory for this channel */</span>
00150   channel_ptr = realloc (channels, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structSei__channel__details.html">Sei_channel_details</a>) * (n_channels +1));
00151   <span class="keywordflow">if</span> (! channel_ptr) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00152   <a class="code" href="seiutils_8c.html#a6">channels</a> = channel_ptr;
00153   <a class="code" href="seiutils_8c.html#a5">n_channels</a> ++;
00154 
00155   <span class="comment">/* fill out the new channel details - fill these in so that if a channel is</span>
00156 <span class="comment">   * completely missing it will appear as a 1hz trace of the same duration as</span>
00157 <span class="comment">   * the complete request */</span>
00158   channel_ptr = <a class="code" href="seiutils_8c.html#a6">channels</a> + <a class="code" href="seiutils_8c.html#a5">n_channels</a> -1;
00159   strcpy (channel_ptr-&gt;chan_name, chan_name);
00160   strcpy (channel_ptr-&gt;chan_type, chan_type);
00161   channel_ptr-&gt;start_time = <a class="code" href="seiutils_8c.html#a3">start_time</a>;
00162   channel_ptr-&gt;n_samples = (long) <a class="code" href="seiutils_8c.html#a4">duration</a>;
00163   channel_ptr-&gt;n_written = 0;
00164   channel_ptr-&gt;sample_rate = 1.0;
00165   channel_ptr-&gt;channel_count = <a class="code" href="seiutils_8c.html#a5">n_channels</a> -1;
00166   strcpy (channel_ptr-&gt;filename, <span class="stringliteral">""</span>);
00167 
00168   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00169 
00170 }
00171 
00172 <span class="comment">/***************************************************************************</span>
00173 <span class="comment"> * start_seisan_channel</span>
00174 <span class="comment"> *</span>
00175 <span class="comment"> * Description: start writing data for the next channel</span>
00176 <span class="comment"> *</span>
00177 <span class="comment"> * Input parameters: chan_name, type - the channel name and type</span>
00178 <span class="comment"> *                                     (e.g. EKR1, SZ)</span>
00179 <span class="comment"> *                   start_time - start time of data for this channel</span>
00180 <span class="comment"> *                   sample_rate - the sample rate for the data</span>
00181 <span class="comment"> *                   n_samples - the number of samples</span>
00182 <span class="comment"> * Output parameters: none</span>
00183 <span class="comment"> * Returns: TRUE if write succeeded, FALSE otherwise</span>
00184 <span class="comment"> *</span>
00185 <span class="comment"> * Comments: call this before add_seisan_channel_data() to start writing</span>
00186 <span class="comment"> *           the next channel</span>
00187 <span class="comment"> *</span>
00188 <span class="comment"> ***************************************************************************/</span>
<a name="l00189"></a><a class="code" href="seiutils_8c.html#a14">00189</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a14">start_seisan_channel</a> (<span class="keywordtype">char</span> *chan_name, <span class="keywordtype">char</span> *chan_type,
00190                           <span class="keywordtype">double</span> start_time, <span class="keywordtype">double</span> sample_rate,
00191                                                   <span class="keywordtype">long</span> n_samples)
00192 
00193 {
00194 
00195   <span class="keywordtype">int</span> count;
00196   <span class="keywordtype">long</span> value;
00197   <span class="keyword">struct </span><a class="code" href="structSei__channel__details.html">Sei_channel_details</a> *channel_ptr;
00198 
00199 
00200   <span class="comment">/* find the correpsonding channel details - if they don't exist</span>
00201 <span class="comment">   * then return without error - this will cause the channel to</span>
00202 <span class="comment">   * be ignored */</span>
00203   <a class="code" href="seiutils_8c.html#a7">current_channel</a> = 0;
00204   <span class="keywordflow">for</span> (count=0, channel_ptr=<a class="code" href="seiutils_8c.html#a6">channels</a>; count&lt;<a class="code" href="seiutils_8c.html#a5">n_channels</a>; count++, channel_ptr++)
00205   {
00206     <span class="keywordflow">if</span> ((! strcmp (channel_ptr-&gt;chan_name, chan_name)) &amp;&amp;
00207         (! strcmp (channel_ptr-&gt;chan_type, chan_type)))
00208     {
00209       <a class="code" href="seiutils_8c.html#a7">current_channel</a> = channel_ptr;
00210       <span class="keywordflow">break</span>;
00211     }
00212   }
00213   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a7">current_channel</a>) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00214 
00215   <span class="comment">/* fill in the channel details */</span>
00216   <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m2">start_time</a> = <a class="code" href="seiutils_8c.html#a3">start_time</a>;
00217   <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m5">sample_rate</a> = sample_rate;
00218   <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m3">n_samples</a> = n_samples;
00219   sprintf (<a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m7">filename</a>, <span class="stringliteral">"%s%c%d.tmp"</span>, tmp_dirname, DIR_DELIM, <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m6">channel_count</a>);
00220 
00221   <span class="comment">/* open a file for this channel */</span>
00222   <a class="code" href="seiutils_8c.html#a8">channel_fp</a> = fopen (<a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m7">filename</a>, <span class="stringliteral">"wb"</span>);
00223   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a8">channel_fp</a>)
00224   {
00225     strcpy (channel_ptr-&gt;filename, <span class="stringliteral">""</span>);
00226     <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00227   }
00228 
00229   <span class="comment">/* write the length of the data at the start of the block */</span>
00230   value = <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m3">n_samples</a> * <span class="keyword">sizeof</span> (long);
00231   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00232   fwrite (&amp;value, <span class="keyword">sizeof</span> (<span class="keywordtype">long</span>), 1, channel_fp);
00233 
00234   <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00235 
00236 }
00237 
00238 <span class="comment">/***************************************************************************</span>
00239 <span class="comment"> * add_seisan_channel_data</span>
00240 <span class="comment"> * </span>
00241 <span class="comment"> * Input parameters: data_len - the number of samples to add</span>
00242 <span class="comment"> *                   data - the data as an array</span>
00243 <span class="comment"> * Output parameters: none</span>
00244 <span class="comment"> * Returns: none</span>
00245 <span class="comment"> *</span>
00246 <span class="comment"> * Comments:</span>
00247 <span class="comment"> *</span>
00248 <span class="comment"> ***************************************************************************/</span>
<a name="l00249"></a><a class="code" href="seiutils_8c.html#a15">00249</a> <span class="keywordtype">void</span> <a class="code" href="seiutils_8c.html#a15">add_seisan_channel_data</a> (<span class="keywordtype">long</span> data_len, <span class="keywordtype">long</span> *data)
00250 
00251 {
00252 
00253   <span class="keywordtype">int</span> count;
00254   <span class="keywordtype">long</span> value;
00255 
00256 
00257   <span class="comment">/* output the data */</span>
00258   <span class="keywordflow">for</span> (count=0; count&lt;data_len; count++)
00259   {
00260     <span class="keywordflow">if</span> (<a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m4">n_written</a> &gt;= <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m3">n_samples</a>) <span class="keywordflow">break</span>;
00261 
00262     value = *(data + count);
00263     <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00264     fwrite (&amp;value, 4, 1, channel_fp);
00265 
00266     <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m4">n_written</a> ++;
00267   }
00268 
00269 }
00270 
00271 <span class="comment">/***************************************************************************</span>
00272 <span class="comment"> * end_seisan_channel</span>
00273 <span class="comment"> *</span>
00274 <span class="comment"> * Description: call this to complete writing data to a channel</span>
00275 <span class="comment"> *</span>
00276 <span class="comment"> * Input parameters: none</span>
00277 <span class="comment"> * Output parameters: none</span>
00278 <span class="comment"> * Returns: TRUE if channel completed OK, FALSE otherwise</span>
00279 <span class="comment"> *</span>
00280 <span class="comment"> * Comments:</span>
00281 <span class="comment"> *</span>
00282 <span class="comment"> ***************************************************************************/</span>
<a name="l00283"></a><a class="code" href="seiutils_8c.html#a16">00283</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a16">end_seisan_channel</a> (<span class="keywordtype">void</span>)
00284 
00285 {
00286 
00287   <span class="keywordtype">int</span> ret_val;
00288   <span class="keywordtype">long</span> value;
00289 
00290 
00291   <span class="comment">/* add any gap data to the end of the file */</span>
00292   value = <a class="code" href="seihead_8h.html#a0">SEISAN_MISSING_DATA_FLAG</a>;
00293   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00294   <span class="keywordflow">while</span> (<a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m4">n_written</a> &lt; <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m3">n_samples</a>)
00295   {
00296     fwrite (&amp;value, 4, 1, channel_fp);
00297     <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m4">n_written</a> ++;
00298   }
00299   
00300   <span class="comment">/* write the length of the data at the end of the block */</span>
00301   value = <a class="code" href="seiutils_8c.html#a7">current_channel</a>-&gt;<a class="code" href="structSei__channel__details.html#m3">n_samples</a> * <span class="keyword">sizeof</span> (long);
00302   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00303   fwrite (&amp;value, <span class="keyword">sizeof</span> (<span class="keywordtype">long</span>), 1, channel_fp);
00304 
00305   <span class="comment">/* check the file, close it and return */</span>
00306   <span class="keywordflow">if</span> (ferror (channel_fp)) ret_val = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00307   <span class="keywordflow">else</span> ret_val = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00308   fclose (channel_fp);
00309   <span class="keywordflow">return</span> ret_val;
00310 
00311 }
00312 
00313 <span class="comment">/***************************************************************************</span>
00314 <span class="comment"> * close_seisan_file</span>
00315 <span class="comment"> *</span>
00316 <span class="comment"> * Description: check and close a Seisan event file</span>
00317 <span class="comment"> *</span>
00318 <span class="comment"> * Input parameters: none</span>
00319 <span class="comment"> * Output parameters: none</span>
00320 <span class="comment"> * Returns: TRUE/FALSE</span>
00321 <span class="comment"> *</span>
00322 <span class="comment"> * Comments:</span>
00323 <span class="comment"> *</span>
00324 <span class="comment"> ***************************************************************************/</span>
<a name="l00325"></a><a class="code" href="seiutils_8c.html#a17">00325</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a17">close_seisan_file</a> (<span class="keywordtype">void</span>)
00326 
00327 {
00328 
00329   <span class="keywordtype">int</span> channel_count, ret_val, length, end, channel_pos, century_code, count;
00330   <span class="keywordtype">long</span> value;
00331   <span class="keywordtype">char</span> padded_chan_name [50], padded_network_name [50], sei_filename [<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];
00332   <span class="keyword">struct </span><a class="code" href="structSei__channel__details.html">Sei_channel_details</a> *channel_ptr;
00333   FILE *sei_fp, *tmp_fp;
00334   time_t ltime;
00335   <span class="keyword">struct </span>tm conv_time;
00336 
00337   <span class="keyword">static</span> <span class="keywordtype">char</span> string [1500];
00338 
00339 
00340   ret_val = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00341 
00342   <span class="comment">/* work out the seisan style network name */</span>
00343   length = strlen (network_name);
00344   <span class="keywordflow">for</span> (count=0; count&lt;5; count++)
00345   {
00346     padded_network_name [count] = <span class="charliteral">'_'</span>;
00347     <span class="keywordflow">if</span> (count &lt; length)
00348     {
00349       <span class="keywordflow">if</span> (isprint (*(network_name + count)))
00350         padded_network_name [count] = *(<a class="code" href="seiutils_8c.html#a2">network_name</a> + count);
00351     }
00352   }
00353   padded_network_name [5] = <span class="charliteral">'\0'</span>;
00354 
00355   <span class="comment">/* open the main seisan file */</span>
00356   ltime = (time_t) <a class="code" href="seiutils_8c.html#a3">start_time</a>;
00357   <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a> (&amp;ltime, &amp;conv_time);
00358   sprintf (sei_filename, <span class="stringliteral">"%s%c%04d-%02d-%02d-%02d%02d-%02dS.%s_%03d"</span>,
00359            output_dir, DIR_DELIM, conv_time.tm_year + 1900, conv_time.tm_mon +1,
00360            conv_time.tm_mday, conv_time.tm_hour, conv_time.tm_min,
00361            conv_time.tm_sec, padded_network_name, n_channels);
00362   sei_fp = fopen (sei_filename, <span class="stringliteral">"wb"</span>);
00363   <span class="keywordflow">if</span> (! sei_fp) <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00364 
00365   <span class="comment">/* write the first two lines to the event file */</span>
00366   ltime = (time_t) <a class="code" href="seiutils_8c.html#a3">start_time</a>;
00367   <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a> (&amp;ltime, &amp;conv_time);
00368   sprintf (string, <span class="stringliteral">" %-29.29s%3d%03d %03d %02d %02d %02d %02d %6.3lf %9.3f           "</span>,
00369                    network_name, n_channels,
00370            conv_time.tm_year, conv_time.tm_yday +1, conv_time.tm_mon +1,
00371            conv_time.tm_mday, conv_time.tm_hour, conv_time.tm_min,
00372            (<span class="keywordtype">double</span>) conv_time.tm_sec + (<span class="keywordtype">double</span>) ltime - start_time, duration);
00373   <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (sei_fp, 80, string);
00374   memset (string, <span class="charliteral">' '</span>, 80);
00375   <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (sei_fp, 80, string);
00376 
00377   <span class="comment">/* write the station details, minimum 12 records, 3 records per line */</span>
00378   <span class="keywordflow">if</span> (<a class="code" href="seiutils_8c.html#a5">n_channels</a> &gt; 30) end = <a class="code" href="seiutils_8c.html#a5">n_channels</a>;
00379   <span class="keywordflow">else</span> end = 30;
00380   <span class="keywordflow">if</span> (end % 3) end += 3 - (end % 3);
00381   <span class="keywordflow">for</span> (channel_count=0, channel_ptr = <a class="code" href="seiutils_8c.html#a6">channels</a>; channel_count&lt;end;
00382        channel_count++, channel_ptr ++)
00383   {
00384     channel_pos = channel_count %3;
00385     <span class="keywordflow">if</span> (channel_pos == 0) memset (string, <span class="charliteral">' '</span>, 80);
00386 
00387     <span class="keywordflow">if</span> (channel_count &lt; <a class="code" href="seiutils_8c.html#a5">n_channels</a>)
00388     {
00389       strcpy (padded_chan_name, channel_ptr-&gt;chan_name);
00390       <span class="keywordflow">while</span> (strlen (padded_chan_name) &lt; 5) strcat (padded_chan_name, <span class="stringliteral">" "</span>);
00391       sprintf (&amp;string[channel_pos * 26], <span class="stringliteral">" %-4.4s%-4.4s%c%7.2f %8.2f"</span>,
00392                padded_chan_name, channel_ptr-&gt;chan_type, *(padded_chan_name + 4),
00393                channel_ptr-&gt;start_time - start_time, channel_ptr-&gt;n_samples / channel_ptr-&gt;sample_rate);
00394           string [(channel_pos +1) * 26] = <span class="charliteral">' '</span>;
00395     }
00396 
00397     <span class="keywordflow">if</span> (channel_pos == 2) <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (sei_fp, 80, string);
00398   }
00399 
00400   <span class="comment">/* for each channel ... */</span>
00401   <span class="keywordflow">for</span> (channel_count=0, channel_ptr = <a class="code" href="seiutils_8c.html#a6">channels</a>; channel_count&lt;<a class="code" href="seiutils_8c.html#a5">n_channels</a>;
00402        channel_count++, channel_ptr ++)
00403   {
00404     <span class="comment">/* write the channel header information */</span>
00405     ltime = (time_t) channel_ptr-&gt;start_time;
00406     <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a> (&amp;ltime, &amp;conv_time);
00407     century_code = conv_time.tm_year / 100;
00408     sprintf (string, <span class="stringliteral">"%-5.5s%-4.4s%d%02d %03d %02d %02d %02d %02d %6.3lf %7.2lf %6ld                          4"</span>,
00409              channel_ptr-&gt;chan_name, channel_ptr-&gt;chan_type, century_code, conv_time.tm_year % 100, 
00410              conv_time.tm_yday +1, conv_time.tm_mon +1,
00411              conv_time.tm_mday, conv_time.tm_hour, conv_time.tm_min,
00412              ((<span class="keywordtype">double</span>) conv_time.tm_sec) + (channel_ptr-&gt;start_time - (<span class="keywordtype">double</span>) ltime),
00413              channel_ptr-&gt;sample_rate, channel_ptr-&gt;n_samples);
00414     length = strlen (string);
00415     memset (&amp;string[length], <span class="charliteral">' '</span>, 1040 - length);
00416     <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (sei_fp, 1040, string);
00417 
00418     <span class="comment">/* was the channel written OK by an earlier call to </span>
00419 <span class="comment">     * add_seisan_channel_data() ?? */</span>
00420     <span class="keywordflow">if</span> (channel_ptr-&gt;n_written == channel_ptr-&gt;n_samples)
00421     {
00422       <span class="comment">/* yes - copy the data from the temporary file */</span>
00423       tmp_fp = fopen (channel_ptr-&gt;filename, <span class="stringliteral">"rb"</span>);
00424       <span class="keywordflow">if</span> (! tmp_fp) ret_val = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00425       <span class="keywordflow">else</span>
00426       {
00427         <span class="keywordflow">while</span> ((length = fread (string, 1, <span class="keyword">sizeof</span> (string), tmp_fp)) &gt; 0)
00428           fwrite (string, 1, length, sei_fp);
00429         <span class="keywordflow">if</span> (ferror (tmp_fp)) ret_val = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00430                 fclose (tmp_fp);
00431       }
00432     }
00433     <span class="keywordflow">else</span>
00434     {
00435       <span class="comment">/* no - invent missing data for the channel - we create a 1Hz data set</span>
00436 <span class="comment">       * containing missing data, starting at the event start time */</span>
00437       value = channel_ptr-&gt;n_samples * <span class="keyword">sizeof</span> (long);
00438       <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00439       fwrite (&amp;value, 4, 1, sei_fp);
00440       value = <a class="code" href="seihead_8h.html#a0">SEISAN_MISSING_DATA_FLAG</a>;
00441       <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00442       <span class="keywordflow">for</span> (count=0; count&lt;channel_ptr-&gt;n_samples; count++)
00443         fwrite (&amp;value, 4, 1, sei_fp);
00444       value = channel_ptr-&gt;n_samples * <span class="keyword">sizeof</span> (long);
00445       <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00446       fwrite (&amp;value, 4, 1, sei_fp);
00447     }
00448 
00449     <span class="comment">/* delete the temporary file for this channel */</span>
00450     <span class="keywordflow">if</span> (channel_ptr-&gt;filename [0]) remove (channel_ptr-&gt;filename);
00451   }
00452 
00453   <span class="comment">/* check and close the seisan file */</span>
00454   <span class="keywordflow">if</span> (ferror (sei_fp)) ret_val = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00455   fclose (sei_fp);
00456 
00457   <span class="comment">/* free the channel details */</span>
00458   free (channels);
00459   <a class="code" href="seiutils_8c.html#a6">channels</a> = 0;
00460   <a class="code" href="seiutils_8c.html#a5">n_channels</a> = 0;
00461 
00462   <span class="comment">/* remove the temporary directory */</span>
00463   rmdir (tmp_dirname);
00464 
00465   <span class="comment">/* if there was an error remove the seisan output file */</span>
00466   <span class="keywordflow">if</span> (! ret_val) remove (sei_filename);
00467 
00468   <span class="keywordflow">return</span> ret_val;
00469 
00470 }
00471 
00472 <span class="comment">/********************************************************************</span>
00473 <span class="comment"> * write_seisan</span>
00474 <span class="comment"> *</span>
00475 <span class="comment"> * Description: write a FORTRAN unformatted record (!)</span>
00476 <span class="comment"> *</span>
00477 <span class="comment"> * Input parameters: fp - file to write to</span>
00478 <span class="comment"> *                   length - the length of the record in bytes</span>
00479 <span class="comment"> *                   data - the data to write</span>
00480 <span class="comment"> * Output parameters: none</span>
00481 <span class="comment"> * Returns: none</span>
00482 <span class="comment"> *</span>
00483 <span class="comment"> * Comments:</span>
00484 <span class="comment"> *</span>
00485 <span class="comment"> ********************************************************************/</span>
<a name="l00486"></a><a class="code" href="seiutils_8c.html#a11">00486</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="seiutils_8c.html#a11">write_seisan</a> (FILE *fp, <span class="keywordtype">long</span> length, <span class="keywordtype">void</span> *data)
00487 
00488 {
00489 
00490   <span class="keywordtype">long</span> value;
00491 
00492 
00493   value = length;
00494   <span class="keywordflow">if</span> (! <a class="code" href="seiutils_8c.html#a9">output_native_numbers</a>) <a class="code" href="swap_8c.html#a2">SwapLong</a> (&amp;value);
00495   fwrite (&amp;value, 4, 1, fp);
00496   fwrite (data, length, 1, fp);
00497   fwrite (&amp;value, 4, 1, fp);
00498 
00499 }
00500 
00501 
00502 <span class="comment">/* --------------------------------------------------------------------</span>
00503 <span class="comment"> * ------ General routines used by non-seisan putaway routines --------</span>
00504 <span class="comment"> * -------------------------------------------------------------------- */</span>
00505 
00506 <span class="comment">/************************************************************************</span>
00507 <span class="comment"> * pa_find_data</span>
00508 <span class="comment"> *</span>
00509 <span class="comment"> * Description: find data in the earthworm data message</span>
00510 <span class="comment"> *</span>
00511 <span class="comment"> * Input parameters: trace_req - the trace request structure</span>
00512 <span class="comment"> *                                       start_time - start time for the data</span>
00513 <span class="comment"> * Output parameters: data - the data found</span>
00514 <span class="comment"> * Returns: one of the following codes:</span>
00515 <span class="comment"> * FD_FOUND_REQUESTED   data was found starting at the requested time</span>
00516 <span class="comment"> * FD_FOUND_GAP                 there is no data for the requested time, but</span>
00517 <span class="comment"> *                                              there is data for a later time</span>
00518 <span class="comment"> * FD_NO_MORE_DATA              the start time is after all data in the</span>
00519 <span class="comment"> *                                              request structure</span>
00520 <span class="comment"> * FD_BAD_DATATYPE              found an unreconisable data type code</span>
00521 <span class="comment"> * FD_CHANGED_SRATE             sample rate changes between snippets</span>
00522 <span class="comment"> *</span>
00523 <span class="comment"> * Comments: This is how the data structures work (I think - if this comment</span>
00524 <span class="comment"> * is wrong, then so is the code):</span>
00525 <span class="comment"> *</span>
00526 <span class="comment"> * The TRACE_REQ structure is in ws_clientii.h</span>
00527 <span class="comment"> *   trace_req-&gt;pBuf points to the data buffer</span>
00528 <span class="comment"> *   trace_req-&gt;bufLen is the length of the buffer</span>
00529 <span class="comment"> *</span>
00530 <span class="comment"> * The data buffer starts with a TRACE_HEADER structure (trace_buf.h)</span>
00531 <span class="comment"> *   trace_header-&gt;starttime, endtime, samprate hold the obvious things</span>
00532 <span class="comment"> *   trace_header-&gt;datatype[0] holds 's' or 'i' for integer data</span>
00533 <span class="comment"> *                             or    'f' or 't' for real data</span>
00534 <span class="comment"> *   trace_header-&gt;datatype[1] holds the number of bytes/sample (coded in ASCII)</span>
00535 <span class="comment"> * Immediately after the TRACE_HEADER structure is the data as an array.</span>
00536 <span class="comment"> * Another TRACE_HEADER and data block may then follow - trace_req-&gt;bufLen</span>
00537 <span class="comment"> * can be used to determine how many of these header/data pairs there are.</span>
00538 <span class="comment"> *</span>
00539 <span class="comment"> ************************************************************************/</span>
<a name="l00540"></a><a class="code" href="seiutils_8c.html#a18">00540</a> <span class="keywordtype">int</span> <a class="code" href="seiutils_8c.html#a18">pa_find_data</a> (<a class="code" href="structTRACE__REQ.html">TRACE_REQ</a> *trace_req, <span class="keywordtype">double</span> sample_time,
00541                                   <span class="keyword">struct</span> <a class="code" href="structFound__data.html">Found_data</a> *data)
00542 
00543 {
00544 
00545   <span class="keywordtype">int</span> bytes_per_sample, data_type_code;
00546   <span class="keywordtype">long</span> n_samples, offset;
00547   <span class="keywordtype">double</span> <a class="code" href="seiutils_8c.html#a3">start_time</a>, end_time, sample_rate, first_sample_rate;
00548   <span class="keywordtype">char</span> *msg_ptr;
00549   <a class="code" href="structTRACE__HEADER.html">TRACE_HEADER</a> *trace_hdr;
00550 
00551 
00552   <span class="comment">/* walk the header/data array, looking for the given time */</span>
00553   first_sample_rate = -1.0;
00554   msg_ptr = trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a>;
00555   <span class="keywordflow">if</span> (! msg_ptr) <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a3">FD_NO_MORE_DATA</a>;
00556   <span class="keywordflow">while</span> (msg_ptr &lt; (trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m7">pBuf</a> + trace_req-&gt;<a class="code" href="structTRACE__REQ.html#m15">actLen</a>))
00557   {
00558         <span class="comment">/* extract details for this trace */</span>
00559     trace_hdr = (<a class="code" href="structTRACE__HEADER.html">TRACE_HEADER</a> *) msg_ptr;
00560 
00561         <span class="comment">/* swap bytes on incoming data if necessary (cjb 2/20/2002) */</span>
00562         <span class="keywordflow">if</span> (<a class="code" href="swap_8c.html#a4">WaveMsgMakeLocal</a>(trace_hdr) &lt; 0)
00563         {
00564                 <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"pa_find_next: unknown trace data type: %s\n"</span>,
00565                         trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m8">datatype</a>);
00566                 <span class="keywordflow">return</span>( EW_FAILURE );
00567         }
00568 
00569     bytes_per_sample  = atoi (&amp;trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m8">datatype</a>[1]);
00570     n_samples = trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m1">nsamp</a>;
00571     <a class="code" href="seiutils_8c.html#a3">start_time</a> = trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m2">starttime</a>;
00572     end_time = trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m3">endtime</a>;
00573     sample_rate = trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m4">samprate</a>;
00574 
00575     <span class="keywordflow">if</span> (fabs (sample_rate) &lt; 0.000001) sample_rate = 100.0;
00576 
00577     <span class="comment">/* check the sample rate */</span>
00578         <span class="keywordflow">if</span> (first_sample_rate &lt; 0.0) first_sample_rate = sample_rate;
00579         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sample_rate != first_sample_rate) <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a5">FD_CHANGED_SRATE</a>;
00580 
00581     <span class="comment">/* check the data type codes */</span>
00582     <span class="keywordflow">switch</span> (trace_hdr-&gt;<a class="code" href="structTRACE__HEADER.html#m8">datatype</a> [0])
00583         {
00584         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00585     <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00586           <span class="keywordflow">switch</span> (bytes_per_sample)
00587           {
00588           <span class="keywordflow">case</span> 2: data_type_code = <a class="code" href="seihead_8h.html#a6">FD_SHORT_INT</a>; <span class="keywordflow">break</span>;
00589           <span class="keywordflow">case</span> 4: data_type_code = <a class="code" href="seihead_8h.html#a7">FD_LONG_INT</a>; <span class="keywordflow">break</span>;
00590           <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a4">FD_BAD_DATATYPE</a>;
00591           }
00592           <span class="keywordflow">break</span>;
00593         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00594         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00595           <span class="keywordflow">switch</span> (bytes_per_sample)
00596           {
00597           <span class="keywordflow">case</span> 4: data_type_code = <a class="code" href="seihead_8h.html#a8">FD_FLOAT</a>; <span class="keywordflow">break</span>;
00598           <span class="keywordflow">case</span> 8: data_type_code = <a class="code" href="seihead_8h.html#a9">FD_DOUBLE</a>; <span class="keywordflow">break</span>;
00599           <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a4">FD_BAD_DATATYPE</a>;
00600           }
00601           <span class="keywordflow">break</span>;
00602         <span class="keywordflow">default</span>:
00603           <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a4">FD_BAD_DATATYPE</a>;
00604         }
00605 
00606     <span class="comment">/* work out if this is the trace that we want */</span>
00607         <span class="keywordflow">if</span> ((sample_time &gt;= <a class="code" href="seiutils_8c.html#a3">start_time</a>) &amp;&amp; (sample_time &lt;= end_time))
00608         {
00609           <span class="comment">/* found the data we want - work out what to tell the caller */</span>
00610           offset = (long) (sample_rate * (sample_time - <a class="code" href="seiutils_8c.html#a3">start_time</a>));
00611           data-&gt;<a class="code" href="structFound__data.html#m0">n_samples</a> = n_samples - offset;
00612           data-&gt;<a class="code" href="structFound__data.html#m2">data</a> = msg_ptr + <span class="keyword">sizeof</span> (TRACE_HEADER) + (offset * bytes_per_sample);
00613           data-&gt;<a class="code" href="structFound__data.html#m3">data_type_code</a> = data_type_code;
00614           data-&gt;<a class="code" href="structFound__data.html#m1">sample_rate</a> = sample_rate;
00615           data-&gt;<a class="code" href="structFound__data.html#m4">trace_hdr</a> = trace_hdr;
00616           <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a1">FD_FOUND_REQUESTED</a>;
00617         }
00618 
00619     <span class="comment">/* is there a gap between the given time and this trace */</span>
00620         <span class="keywordflow">if</span> (sample_time &lt; <a class="code" href="seiutils_8c.html#a3">start_time</a>)
00621         {
00622           <span class="comment">/* calculate the gap size */</span>
00623           data-&gt;<a class="code" href="structFound__data.html#m0">n_samples</a> = (long) (sample_rate * (<a class="code" href="seiutils_8c.html#a3">start_time</a> - sample_time));
00624           data-&gt;<a class="code" href="structFound__data.html#m1">sample_rate</a> = sample_rate;
00625           <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a2">FD_FOUND_GAP</a>;
00626         }
00627 
00628         <span class="comment">/* set up msg_ptr for the next header/data array */</span>
00629     msg_ptr += <span class="keyword">sizeof</span> (TRACE_HEADER) + (n_samples * bytes_per_sample);
00630   }
00631 
00632   <span class="comment">/* if you get here, then the data was not found */</span>
00633   <span class="keywordflow">return</span> <a class="code" href="seihead_8h.html#a3">FD_NO_MORE_DATA</a>;
00634 
00635 }
00636 
00637 
00638 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:09 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
