<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dbmutableserver.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>dbmutableserver.cpp</h1><a href="dbmutableserver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * dbmutableserverbase.cpp -- definition of a class which extends</span>
00003 <span class="comment"> *                            MutableServerBase with basic database</span>
00004 <span class="comment"> *                            functionality.</span>
00005 <span class="comment"> */</span>
00006 
00007 <span class="preprocessor">#include "<a class="code" href="dbmutableserver_8h.html">dbmutableserver.h</a>"</span>
00008 
00009 <span class="preprocessor">#include &lt;<a class="code" href="oracleconfigsource_8h.html">oracleconfigsource.h</a>&gt;</span>
00010 
00011 
00012 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00013"></a><a class="code" href="classDBMutableServer.html#a0">00013</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classDBMutableServer.html#a0">DBMutableServer::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00014 {
00015    <span class="comment">// BASE CLASSES MUST BE GIVEN THE CHANCE TO GET CONFIG VARIABLES:</span>
00016    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_status = <a class="code" href="classMutableServerBase.html#a0">MutableServerBase::HandleConfigLine</a>(p_parser);
00017    
00018    
00019    <span class="keywordflow">if</span> ( r_status == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00020    {
00021       <span class="comment">// Base class didn't use it, then it might belong to this</span>
00022       <span class="comment">// derivative class</span>
00023     
00024       <span class="keywordflow">try</span>
00025       {
00026          <span class="comment">// this do-while is solely to allow a single return point,</span>
00027          <span class="comment">// thus simplifying the code.</span>
00028          
00029          <span class="keywordflow">do</span>
00030          {
00031             <span class="keywordtype">char</span> * _token;
00032             
00033 
00034             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"DBConnection"</span>) )
00035             {
00036                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00037                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00038                {
00039                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing &lt;DBConnection&gt; User value"</span>);
00040                }
00041                <a class="code" href="classDBMutableServer.html#n0">DB_User</a> = _token;
00042 
00043                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00044                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00045                {
00046                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing &lt;DBConnection&gt; Password value"</span>);
00047                }
00048                <a class="code" href="classDBMutableServer.html#n1">DB_Password</a> = _token;
00049 
00050                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00051                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00052                {
00053                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing &lt;DBConnection&gt; Servicevalue"</span>);
00054                }
00055                <a class="code" href="classDBMutableServer.html#n2">DB_Service</a> = _token;
00056 
00057                r_status = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00058 
00059                <span class="keywordflow">continue</span>;
00060             }
00061             
00062          } <span class="keywordflow">while</span> ( false ) ;
00063       }
00064       <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00065       {
00066          r_status = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00067          <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
00068          {
00069             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00070                          , <span class="stringliteral">"MLServer::HandleConfigLine(): configuration error:\n%s\n"</span>
00071                          , _we.what()
00072                          );
00073          }
00074       }
00075    }
00076    
00077    <span class="keywordflow">return</span> r_status;
00078 }
00079 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00080"></a><a class="code" href="classDBMutableServer.html#b0">00080</a> <span class="keywordtype">void</span> <a class="code" href="classDBMutableServer.html#b0">DBMutableServer::CheckConfig</a>()
00081 {
00082    <a class="code" href="classMutableServerBase.html#b0">MutableServerBase::CheckConfig</a>();
00083 
00084    <span class="keywordflow">if</span> (   <a class="code" href="classDBMutableServer.html#n0">DB_User</a>.length() == 0
00085        || <a class="code" href="classDBMutableServer.html#n1">DB_Password</a>.length() == 0
00086        || <a class="code" href="classDBMutableServer.html#n2">DB_Service</a>.length() == 0
00087       )
00088    {
00089       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00090                     , <span class="stringliteral">"DBMutableServer::CheckConfig(): &lt;DBConnection&gt; not complete for %s mode\n"</span>
00091                     , MSB_MODE_NAME[Mode]
00092                     );
00093       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00094    }
00095 }
00096 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00097"></a><a class="code" href="classDBMutableServer.html#b1">00097</a> <span class="keywordtype">bool</span> <a class="code" href="classDBMutableServer.html#b1">DBMutableServer::PrepareToRun</a>()
00098 {
00099    <span class="keywordtype">bool</span> r_status = <span class="keyword">false</span>;
00100 
00101    <span class="keywordflow">try</span>
00102    {
00103       <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#b1">MutableServerBase::PrepareToRun</a>() )
00104       {
00105          r_status = <a class="code" href="classDBMutableServer.html#b2">InitializeDB</a>();
00106       }
00107    }
00108    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00109    {
00110       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
00111       {
00112          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00113                        , <span class="stringliteral">"DBMutableServer::PrepareToRun() Error: %s\n"</span>
00114                        , _we.what()
00115                        );
00116       }
00117       
00118       r_status = <span class="keyword">false</span>;
00119    }
00120    <span class="keywordflow">return</span> r_status;
00121 }
00122 
00123 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00124"></a><a class="code" href="classDBMutableServer.html#b2">00124</a> <span class="keywordtype">bool</span> <a class="code" href="classDBMutableServer.html#b2">DBMutableServer::InitializeDB</a>()
00125 {
00126    <span class="keywordtype">bool</span> r_status = <span class="keyword">false</span>;
00127    
00128    <span class="keywordflow">try</span>
00129    {
00130       <span class="keywordflow">if</span> (   <a class="code" href="classDBMutableServer.html#n0">DB_User</a>.length()     == 0 || 39 &lt; <a class="code" href="classDBMutableServer.html#n0">DB_User</a>.length()
00131           || <a class="code" href="classDBMutableServer.html#n1">DB_Password</a>.length() == 0 || 19 &lt; <a class="code" href="classDBMutableServer.html#n1">DB_Password</a>.length()
00132           || <a class="code" href="classDBMutableServer.html#n2">DB_Service</a>.length()  == 0 || 19 &lt; <a class="code" href="classDBMutableServer.html#n2">DB_Service</a>.length()
00133          )
00134       {
00135          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Database connection parameter missing or too long"</span>);
00136       }
00137 
00138 
00139       <span class="keywordtype">char</span> _user[40]
00140          , _passwd[20]
00141          , _service[20]
00142          ;
00143 
00144       strcpy( _user    , <a class="code" href="classDBMutableServer.html#n0">DB_User</a>.c_str() ); 
00145       strcpy( _passwd  , <a class="code" href="classDBMutableServer.html#n1">DB_Password</a>.c_str() ); 
00146       strcpy( _service , <a class="code" href="classDBMutableServer.html#n2">DB_Service</a>.c_str() ); 
00147       
00148       <span class="comment">//</span>
00149       <span class="comment">// Initialize the Ora_API</span>
00150       <span class="comment">//</span>
00151       <span class="keywordflow">if</span> ( ewdb_base_Init( _user, _passwd, _service ) == EWDB_RETURN_FAILURE )
00152       {
00153          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Database connection initialization failed"</span>);
00154       }
00155       
00156       r_status = <span class="keyword">true</span>;
00157       
00158    }
00159    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00160    {
00161       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
00162       {
00163          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00164                        , <span class="stringliteral">"DBMutableServer::InitializeDB() Error: %s\n"</span>
00165                        , _we.what()
00166                        );
00167       }
00168    }
00169    
00170    <span class="keywordflow">return</span> r_status;
00171 }
00172 
00173 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00174"></a><a class="code" href="classDBMutableServer.html#b3">00174</a> <span class="keywordtype">bool</span> <a class="code" href="classDBMutableServer.html#b3">DBMutableServer::GetDefaultsFromDB</a>( <span class="keywordtype">void</span> * p_parmstruct )
00175 {
00176    <span class="keywordtype">bool</span> r_status = <span class="keyword">true</span>;
00177 
00178    <a class="code" href="classOracleConfigSource.html">OracleConfigSource</a> * _defaults = NULL;
00179 
00180    <span class="keywordflow">try</span>
00181    {
00182       <span class="comment">//</span>
00183       <span class="comment">// Get Default Parameters from the database</span>
00184       <span class="comment">//</span>
00185 <span class="comment">/*</span>
00186 <span class="comment">      if ( (_defaults = new OracleConfigSource()) == NULL )</span>
00187 <span class="comment">      {</span>
00188 <span class="comment">         throw worm_exception("Failed creating Oracle configuration datasource");</span>
00189 <span class="comment">      }</span>
00190 <span class="comment"></span>
00191 <span class="comment">// EXACTLY HOW PASSPORTS ARE TO BE QUERIED FROM THE DATABASE HAS NOT YET BEEN</span>
00192 <span class="comment">// DETERMINED</span>
00193 <span class="comment"></span>
00194 <span class="comment">static const int SERVER_TYPE_ID = 47;</span>
00195 <span class="comment"></span>
00196 <span class="comment">      _defaults-&gt;LoadFromDB( SERVER_TYPE_ID );</span>
00197 <span class="comment"></span>
00198 <span class="comment">      HandleParameterLine( _defaults, p_parmstruct );</span>
00199 <span class="comment">      </span>
00200 <span class="comment">*/</span>
00201 
00202   }
00203    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00204    {
00205       r_status = <span class="keyword">false</span>;
00206       
00207       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
00208       {
00209          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00210                        , <span class="stringliteral">"DBMutableServer::GetDefaultsFromDB() Error: %s\n"</span>
00211                        , _we.what()
00212                        );
00213       }
00214    }
00215 
00216    <span class="keywordflow">if</span> ( _defaults != NULL )
00217    {
00218       <span class="keyword">delete</span> _defaults;
00219    }
00220    
00221    <span class="keywordflow">return</span> r_status;
00222 }
00223 
00224 <span class="comment">//------------------------------------------------------------------------------</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:00 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
