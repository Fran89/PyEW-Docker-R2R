<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pipe.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>pipe.c</h1><a href="pipe_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: pipe_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00011 <span class="comment"> *     Initial revision</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> */</span>
00015 
00016 <span class="comment">/***************************************************************</span>
00017 <span class="comment"> *                            pipe.c                           *</span>
00018 <span class="comment"> *                                                             *</span>
00019 <span class="comment"> *      Routines for writing to and reading from a pipe        *</span>
00020 <span class="comment"> *      under Windows NT.                                      *</span>
00021 <span class="comment"> ***************************************************************/</span>
00022 
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00025 <span class="preprocessor">#include &lt;string.h&gt;</span>
00026 
<a name="l00027"></a><a class="code" href="pipe_8c.html#a1">00027</a> <span class="keyword">static</span> FILE  *<a class="code" href="pipe_8c.html#a1">Pipe</a>;  <span class="comment">/* "write-handle" to pipe to "child" process */</span>
00028 
00029 
00030 <span class="comment">/*****************************************************************/</span>
00031 <span class="comment">/* pipe_init() starts a process and opens a pipe to it.  The     */</span>
00032 <span class="comment">/*             pipe replaces stdin of the new process.           */</span>
00033 <span class="comment">/*    Returns:   0 on success                                    */</span>
00034 <span class="comment">/*              -1 on failure                                    */</span>
00035 <span class="comment">/*****************************************************************/</span>
<a name="l00036"></a><a class="code" href="pipe_8c.html#a2">00036</a> <span class="keywordtype">int</span> <a class="code" href="pipe_8c.html#a2">pipe_init</a>( <span class="keywordtype">char</span>  *nextproc,  <span class="comment">/* command to start new process */</span>
00037       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   pipesize ) <span class="comment">/* how big (bytes) to make pipe */</span>
00038                                  <span class="comment">/* NOT USED under Solaris       */</span>
00039 {
00040    <a class="code" href="pipe_8c.html#a1">Pipe</a> = _popen( nextproc, <span class="stringliteral">"w"</span> );
00041    <span class="keywordflow">if</span> ( <a class="code" href="pipe_8c.html#a1">Pipe</a> == (FILE *) NULL ) <span class="keywordflow">return</span> (-1);
00042    <span class="keywordflow">return</span> ( 0 );
00043 }
00044 
00045 
00046 <span class="comment">/*****************************************************************/</span>
00047 <span class="comment">/* pipe_put() writes a msg to a pipe, terminating with null byte */</span>
00048 <span class="comment">/* Returns 0 if there were no errors,                            */</span>
00049 <span class="comment">/*        some number if there were errors                       */</span>
00050 <span class="comment">/*****************************************************************/</span>
<a name="l00051"></a><a class="code" href="pipe_8c.html#a0">00051</a> <span class="preprocessor">#define MAXWRITE 500</span>
00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="pipe_8c.html#a3">00053</a> <span class="keywordtype">int</span> <a class="code" href="pipe_8c.html#a3">pipe_put</a>( <span class="keywordtype">char</span> *msg,        <span class="comment">/* null-terminated char string  */</span>
00054               <span class="keywordtype">int</span>   msgtype )   <span class="comment">/* type of message (0-255)      */</span>
00055 {
00056    <span class="keywordtype">char</span>     str[4];
00057    <span class="keywordtype">char</span>     *m;
00058    <span class="keywordtype">unsigned</span> n;
00059    <span class="keywordtype">unsigned</span> nwrite;
00060    <span class="keywordtype">unsigned</span> nwritten;    <span class="comment">/* Number of chars written to pipe    */</span>
00061 
00062 <span class="comment">/* Write message type to pipe</span>
00063 <span class="comment">   **************************/</span>
00064    <span class="keywordflow">if</span> ( (msgtype &gt; 255) || (msgtype &lt; 0) )
00065    {
00066       fprintf( stderr, <span class="stringliteral">"msgtype out of range.  msgtype: %d\n"</span>, msgtype );
00067       <span class="keywordflow">return</span>( -1 );
00068    }
00069    sprintf( str, <span class="stringliteral">"%3d"</span>, msgtype );
00070    nwritten = fwrite( str, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), (size_t)3, Pipe );
00071 <span class="comment">/* printf("pipe_put:  type:%3d.   msg:\n%s\n", msgtype, msg ); */</span>
00072    <span class="keywordflow">if</span> ( nwritten &lt; 3 )
00073    {
00074       fprintf( stderr, <span class="stringliteral">"Write error. nwritten: %d  Should be 3.\n"</span>, nwritten );
00075       <span class="keywordflow">return</span>( -1 );
00076    }
00077 
00078 <span class="comment">/* Write message string to pipe, including the null character</span>
00079 <span class="comment">   **********************************************************/</span>
00080    m        = msg;
00081    nwrite   = strlen( msg ) + 1;
00082    nwritten = 0;
00083 
00084    <span class="keywordflow">while</span> ( nwrite &gt; 0 )
00085    {
00086       n = fwrite( m, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), ( nwrite &gt; MAXWRITE ) ?
00087                   (size_t)MAXWRITE : (size_t)nwrite, Pipe );
00088       <span class="keywordflow">if</span> ( n == 0 )
00089       {
00090          fprintf( stderr, <span class="stringliteral">"pipe_put(): Write error!\n"</span> );
00091          <span class="keywordflow">return</span>( -1 );
00092       }
00093       nwritten += n;
00094       nwrite -= n;
00095       m += n;
00096       fflush( Pipe );
00097    }
00098 
00099    <span class="keywordflow">if</span> ( nwritten != strlen( msg ) + 1 )
00100    {
00101       fprintf( stderr, <span class="stringliteral">"Pipe write error. nwritten != strlen(msg)+1\n"</span> );
00102       <span class="keywordflow">return</span>( -1 );
00103    }
00104 
00105    <span class="keywordflow">return</span>( 0 );
00106 }
00107 
00108 <span class="comment">/*****************************************************************</span>
00109 <span class="comment"> * pipe_get() reads a msg from a pipe (stdin) and writes it as a *</span>
00110 <span class="comment"> *            null-terminated char string to the given address   *</span>
00111 <span class="comment"> * Returns  # of chars written to msg (not including null-byte)  *</span>
00112 <span class="comment"> *         -1 if the message was longer than maxlen              *</span>
00113 <span class="comment"> *         -2 if EOF encountered reading message type            *</span>
00114 <span class="comment"> *****************************************************************/</span>
00115 
<a name="l00116"></a><a class="code" href="pipe_8c.html#a4">00116</a> <span class="keywordtype">int</span> <a class="code" href="pipe_8c.html#a4">pipe_get</a>( <span class="keywordtype">char</span> *msg,        <span class="comment">/* address to copy msg to       */</span>
00117               <span class="keywordtype">int</span>   maxlen,     <span class="comment">/* size of msg buffer           */</span>
00118               <span class="keywordtype">int</span>  *type )      <span class="comment">/* type of message returned     */</span>
00119 {
00120    <span class="keywordtype">char</span>  typestr[4];
00121    <span class="keywordtype">char</span> *m;
00122    <span class="keywordtype">char</span>  ch;
00123    <span class="keywordtype">int</span>   i;
00124 
00125 <span class="comment">/* Start by reading message type from pipe</span>
00126 <span class="comment"> *****************************************/</span>
00127    m = typestr;     <span class="comment">/* Use a working copy of the target address */</span>
00128 
00129    <span class="keywordflow">for</span> ( i = 0; i &lt; 3; i++ )
00130    {
00131       *m = fgetc( stdin );
00132       <span class="keywordflow">if</span> ( *m == <span class="charliteral">'\0'</span> )
00133       {
00134          *m = <span class="charliteral">'\0'</span>;
00135          <span class="keywordflow">return</span> ( -2 );
00136       }
00137       <span class="keywordflow">if</span> ( *m == (char)EOF )
00138       {
00139          *m = <span class="charliteral">'\0'</span>;
00140          <span class="keywordflow">return</span> ( -3 );
00141       }
00142       m++;
00143    }
00144    typestr[i] = <span class="charliteral">'\0'</span>;
00145   *<a class="code" href="getutil_8c.html#a16">type</a> = atoi(typestr);
00146 
00147 <span class="comment">/* Now read the message (terminated by null byte)</span>
00148 <span class="comment"> ************************************************/</span>
00149    m = msg;     <span class="comment">/* Use a working copy of the target address */</span>
00150 
00151    <span class="keywordflow">for</span> ( i = 0; i &lt; maxlen; i++ )
00152    {
00153       *m = fgetc( stdin );
00154       <span class="keywordflow">if</span> ( *m == <span class="charliteral">'\0'</span> || *m == (char)EOF )
00155       {
00156          *m = <span class="charliteral">'\0'</span>;
00157          <span class="keywordflow">return</span> ( i );
00158       }
00159       m++;
00160    }
00161 
00162 <span class="comment">/* If you got here, the message was too long!  Skip to the end of it</span>
00163 <span class="comment"> *******************************************************************/</span>
00164    <span class="keywordflow">while</span>( 1 )
00165    {
00166       ch = fgetc( stdin );
00167       <span class="keywordflow">if</span> ( ch == <span class="charliteral">'\0'</span> || ch == (char)EOF )
00168          <span class="keywordflow">break</span>;
00169    }
00170    <span class="keywordflow">return</span>( -1 );
00171 }
00172 
00173 
00174 <span class="comment">/*****************************************************************/</span>
00175 <span class="comment">/* pipe_close()  Closes the pipe                                 */</span>
00176 <span class="comment">/*****************************************************************/</span>
<a name="l00177"></a><a class="code" href="pipe_8c.html#a5">00177</a> <span class="keywordtype">void</span> <a class="code" href="pipe_8c.html#a5">pipe_close</a>( <span class="keywordtype">void</span> )
00178 {
00179    _pclose( Pipe );
00180 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:07 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
