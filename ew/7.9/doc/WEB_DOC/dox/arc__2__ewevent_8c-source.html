<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>arc_2_ewevent.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>arc_2_ewevent.c</h1><a href="arc__2__ewevent_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00003 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *    $Id: arc__2__ewevent_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *    Revision history:</span>
00008 <span class="comment"> *     $Log$
00008 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:01  paulf
00008 <span class="comment"> *     first inclusion
00008 <span class="comment"> *</span>
00009 <span class="comment"> *     Revision 1.7  2001/07/20 17:40:05  lucky</span>
00010 <span class="comment"> *     State of the code after much of v6.0 testing and debugging</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *     Revision 1.6  2001/07/01 21:55:20  davidk</span>
00013 <span class="comment"> *     Cleanup of the Earthworm Database API and the applications that utilize it.</span>
00014 <span class="comment"> *     The "ewdb_api" was cleanup in preparation for Earthworm v6.0, which is</span>
00015 <span class="comment"> *     supposed to contain an API that will be backwards compatible in the</span>
00016 <span class="comment"> *     future.  Functions were removed, parameters were changed, syntax was</span>
00017 <span class="comment"> *     rewritten, and other stuff was done to try to get the code to follow a</span>
00018 <span class="comment"> *     general format, so that it would be easier to read.</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *     Applications were modified to handle changed API calls and structures.</span>
00021 <span class="comment"> *     They were also modified to be compiler warning free on WinNT.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> *     Revision 1.5  2001/06/26 19:55:31  lucky</span>
00024 <span class="comment"> *     Fixed a bug where the number of stamags was not correctly incremented</span>
00025 <span class="comment"> *     in the conversion from Arc msg to Event struct.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> *     Revision 1.4  2001/06/21 21:25:00  lucky</span>
00028 <span class="comment"> *     State of the code after LocalMag review was implemented and partially tested.</span>
00029 <span class="comment"> *</span>
00030 <span class="comment"> *     Revision 1.3  2001/06/06 20:54:46  lucky</span>
00031 <span class="comment"> *     Changes made to support multitude magnitudes, as well as amplitude picks. This is w</span>
00032 <span class="comment"> *     in progress - checkin in for the sake of safety.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> *     Revision 1.2  2001/05/21 22:33:42  davidk</span>
00035 <span class="comment"> *     removed internal definition of MAGTYPE_DURATION.  Using the one from rw_mag.h</span>
00036 <span class="comment"> *     instead.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> *     Revision 1.1  2001/05/15 02:15:27  davidk</span>
00039 <span class="comment"> *     Initial revision</span>
00040 <span class="comment"> *</span>
00041 <span class="comment"> *     Revision 1.4  2001/04/17 17:22:36  davidk</span>
00042 <span class="comment"> *     Removed some unneeded local variables to get rid of compiler warnings</span>
00043 <span class="comment"> *     on NT.</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> *     Revision 1.2  2001/01/18 21:26:58  lucky</span>
00046 <span class="comment"> *     Cleaned up debug messages</span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> *     Revision 1.1  2000/12/18 18:55:12  lucky</span>
00049 <span class="comment"> *     Initial revision</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> *     Revision 1.12  2000/12/06 17:50:47  lucky</span>
00052 <span class="comment"> *     We now correctly keep track of the pick onset</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> *     Revision 1.11  2000/09/20 19:50:09  lucky</span>
00055 <span class="comment"> *     Do not over-write coda length when filling in S-pick information -- it gets</span>
00056 <span class="comment"> *     the wrong duration in the Arc file.</span>
00057 <span class="comment"> *</span>
00058 <span class="comment"> *     Revision 1.10  2000/09/13 15:36:51  lucky</span>
00059 <span class="comment"> *     Fixed FirstMotion character handling;</span>
00060 <span class="comment"> *     Fixed handling of the coda length</span>
00061 <span class="comment"> *</span>
00062 <span class="comment"> *     Revision 1.7  2000/09/07 21:17:45  lucky</span>
00063 <span class="comment"> *     Final version after the Review pages have been demonstrated.</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> *     Revision 1.4  2000/08/30 17:41:57  lucky</span>
00066 <span class="comment"> *     InitEWEvent has been changed to include optional allocation of</span>
00067 <span class="comment"> *     pChanInfo space. This must be optional because GetEWEventInfo mallocs</span>
00068 <span class="comment"> *     space on the fly.</span>
00069 <span class="comment"> *</span>
00070 <span class="comment"> *     Revision 1.3  2000/08/28 15:41:10  lucky</span>
00071 <span class="comment"> *     get_EW_event_info.h -&gt; EW_event_info.h</span>
00072 <span class="comment"> *</span>
00073 <span class="comment"> *     Revision 1.2  2000/08/25 18:23:42  lucky</span>
00074 <span class="comment"> *     Made to work with P and S waves, as well as the new pChanInfo struct.</span>
00075 <span class="comment"> *</span>
00076 <span class="comment"> *     Revision 1.1  2000/08/16 17:18:11  lucky</span>
00077 <span class="comment"> *     Initial revision</span>
00078 <span class="comment"> *</span>
00079 <span class="comment"> *     Revision 1.13  2000/06/29 17:24:42  lucky</span>
00080 <span class="comment"> *     Added to Sac2EWEvent the translation of the coda duration from the sac header.</span>
00081 <span class="comment"> *     The coda duration is written to EW structs.</span>
00082 <span class="comment"> *</span>
00083 <span class="comment"> *     Revision 1.12  2000/06/28 22:53:07  lucky</span>
00084 <span class="comment"> *     Increased the maximum number of Phases per event to 1000 to accomodate</span>
00085 <span class="comment"> *     extremely large Dewey-type events.</span>
00086 <span class="comment"> *     If BuildPhs fails, we record the failure, but do not exit. This way,</span>
00087 <span class="comment"> *     even if one arrival writing fails we still get the remaining ones</span>
00088 <span class="comment"> *     in the arc message.</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> *     Revision 1.11  2000/06/28 22:22:34  lucky</span>
00091 <span class="comment"> *     Added a check in EWEvent2ArcMsg so that only the arrival-type channels</span>
00092 <span class="comment"> *     are written to Arc message. Recall:channels may be arrivals, station</span>
00093 <span class="comment"> *     magnitudes, or even just waveform data.</span>
00094 <span class="comment"> *</span>
00095 <span class="comment"> *     Revision 1.10  2000/06/26 18:14:42  lucky</span>
00096 <span class="comment"> *     Fixed creation of hypoinverse arc files with NSN locations.</span>
00097 <span class="comment"> *</span>
00098 <span class="comment"> *     Revision 1.9  2000/06/22 23:29:11  lucky</span>
00099 <span class="comment"> *     Fixed BuildPhs to work with USNSN messages'</span>
00100 <span class="comment"> *</span>
00101 <span class="comment"> *     Revision 1.8  2000/06/20 21:42:51  lucky</span>
00102 <span class="comment"> *     *** empty log message ***</span>
00103 <span class="comment"> *</span>
00104 <span class="comment"> *     Revision 1.7  2000/06/16 17:23:36  lucky</span>
00105 <span class="comment"> *     Set tObsPhase to be same as tCalcPhase when read from sac headers.</span>
00106 <span class="comment"> *</span>
00107 <span class="comment"> *     Revision 1.6  2000/06/13 19:05:58  lucky</span>
00108 <span class="comment"> *     Fixed to work with the new hypo2ora, as well as the review stuff.</span>
00109 <span class="comment"> *</span>
00110 <span class="comment"> *     Revision 1.5  2000/06/07 22:09:52  lucky</span>
00111 <span class="comment"> *     Added ArcMsg2EWEvent calls</span>
00112 <span class="comment"> *</span>
00113 <span class="comment"> *</span>
00114 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00115 <span class="comment"> *     Initial revision</span>
00116 <span class="comment"> *</span>
00117 <span class="comment"> *</span>
00118 <span class="comment"> */</span>
00119 
00120 
00121 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00122 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00123 <span class="preprocessor">#include &lt;string.h&gt;</span>
00124 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00125 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00126 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00127 <span class="preprocessor">#include &lt;<a class="code" href="ws__clientII_8h.html">ws_clientII.h</a>&gt;</span>
00128 <span class="preprocessor">#include &lt;<a class="code" href="chron3_8h.html">chron3.h</a>&gt;</span>
00129 <span class="preprocessor">#include &lt;ewdb_ora_api.h&gt;</span>
00130 <span class="preprocessor">#include &lt;ew_event_info.h&gt;</span>
00131 <span class="preprocessor">#include &lt;<a class="code" href="read__arc_8h.html">read_arc.h</a>&gt;</span>
00132 
00133 
00134 <span class="comment">/* Define max lengths of various lines in the Hypoinverse archive format</span>
00135 <span class="comment">   (includes space for a newline &amp; null-terminator on each line )</span>
00136 <span class="comment"> ************************************************************************/</span>
<a name="l00137"></a><a class="code" href="arc__2__ewevent_8c.html#a0">00137</a> <span class="preprocessor">#define ARC_HYP_LEN   500</span>
<a name="l00138"></a><a class="code" href="arc__2__ewevent_8c.html#a1">00138</a> <span class="preprocessor"></span><span class="preprocessor">#define ARC_SHYP_LEN  500</span>
<a name="l00139"></a><a class="code" href="arc__2__ewevent_8c.html#a2">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define ARC_PHS_LEN   500</span>
<a name="l00140"></a><a class="code" href="arc__2__ewevent_8c.html#a3">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define ARC_SPHS_LEN  500</span>
<a name="l00141"></a><a class="code" href="arc__2__ewevent_8c.html#a4">00141</a> <span class="preprocessor"></span><span class="preprocessor">#define ARC_TRM_LEN    74</span>
<a name="l00142"></a><a class="code" href="arc__2__ewevent_8c.html#a5">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define ARC_STRM_LEN   74</span>
00143 <span class="preprocessor"></span>
00144 
00145 <span class="comment">/* Define some simple "functions"</span>
00146 <span class="comment"> ********************************/</span>
00147 <span class="preprocessor">#ifndef MIN</span>
<a name="l00148"></a><a class="code" href="arc__2__ewevent_8c.html#a6">00148</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN(a,b) (((a)&lt;(b)) ? (a) : (b))        </span><span class="comment">/* Smaller value  */</span>
00149 <span class="preprocessor">#endif</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#ifndef ABS</span>
<a name="l00151"></a><a class="code" href="arc__2__ewevent_8c.html#a7">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define ABS(a) ((a) &gt; 0 ? (a) : -(a))           </span><span class="comment">/* Absolute value */</span>
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154 
00155 <span class="keyword">extern</span>          time_t <a class="code" href="time__ew_8c.html#a5">timegm_ew</a> (<span class="keyword">struct</span> tm *);
00156 
00157 <span class="keywordtype">int</span>     <a class="code" href="arc__2__ewevent_8c.html#a9">EWEvent2ArcMsg</a> (EWEventInfoStruct *, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00158 <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a10">BuildHyp</a> (EWEventInfoStruct *, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00159 <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a11">BuildPhs</a> (EWEventInfoStruct *, <span class="keywordtype">int</span>, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00160 <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a12">BuildTerm</a> (<span class="keywordtype">int</span>, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00161 
00162 
00163 
00164 
00165 
00166 
00167 <span class="comment">/********************************************************</span>
00168 <span class="comment">*</span>
00169 <span class="comment">*  EWEvent2ArcMsg:</span>
00170 <span class="comment">*     Creates a Hypoinverse Archive message, stored in </span>
00171 <span class="comment">*     string pArc, from the data passed in the </span>
00172 <span class="comment">*     pEWEvent structure and its substructures.</span>
00173 <span class="comment">*</span>
00174 <span class="comment">*</span>
00175 <span class="comment">*      Returns EW_SUCCESS if everything went OK, </span>
00176 <span class="comment">*       EW_FAILURE otherwise.</span>
00177 <span class="comment">*</span>
00178 <span class="comment">*</span>
00179 <span class="comment">*   Author: Lucky Vidmar    04/2000</span>
00180 <span class="comment">*</span>
00181 <span class="comment">********************************************************/</span>
<a name="l00182"></a><a class="code" href="arc__2__ewevent_8c.html#a9">00182</a> <span class="keywordtype">int</span>     <a class="code" href="arc__2__ewevent_8c.html#a9">EWEvent2ArcMsg</a> (EWEventInfoStruct *pEWEvent, <span class="keywordtype">char</span> *pArc, <span class="keywordtype">int</span> ArcLen)
00183 {
00184 
00185         <span class="keywordtype">int</span>             i;
00186 
00187         <span class="keywordflow">if</span> ((pEWEvent == NULL) || (pArc == NULL) || (ArcLen &lt; 0))
00188         {
00189                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00190                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00191         }
00192 
00193         <span class="keywordflow">if</span> (<a class="code" href="arc__2__ewevent_8c.html#a10">BuildHyp</a> (pEWEvent, pArc, ArcLen) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00194         {
00195                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to BuildHyp failed.\n"</span>);
00196                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00197         }
00198 
00199         <span class="keywordflow">for</span> (i = 0; i &lt; pEWEvent-&gt;iNumChans; i++)
00200         {
00201                 <span class="keywordflow">if</span> (pEWEvent-&gt;pChanInfo[i].iNumArrivals &gt; 0)
00202                 {
00203                         <span class="keywordflow">if</span> (<a class="code" href="arc__2__ewevent_8c.html#a11">BuildPhs</a> (pEWEvent, i, pArc, ArcLen) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00204                         {
00205                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to BuildPhs failed for channel %d.\n"</span>, i);
00206                         }
00207                 }
00208         }
00209 
00210         <span class="keywordflow">if</span> (<a class="code" href="arc__2__ewevent_8c.html#a12">BuildTerm</a> (pEWEvent-&gt;PrefOrigin.idEvent, pArc, ArcLen) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00211         {
00212                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to BuildTerm failed.\n"</span>);
00213                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00214         }
00215 
00216         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00217 
00218 }
00219 
00220 
00221 <span class="comment">/********************************************************</span>
00222 <span class="comment">*</span>
00223 <span class="comment">*  ArcMsg2EWEvent:</span>
00224 <span class="comment">*     Given a Hypoinverse Archive message stored in </span>
00225 <span class="comment">*     string pArc, fill the pEWEvent structure</span>
00226 <span class="comment">*     and its substructures.</span>
00227 <span class="comment">*</span>
00228 <span class="comment">*</span>
00229 <span class="comment">*      Returns EW_SUCCESS if everything went OK, </span>
00230 <span class="comment">*       EW_FAILURE otherwise.</span>
00231 <span class="comment">*</span>
00232 <span class="comment">*</span>
00233 <span class="comment">*   Author: Lucky Vidmar    06/2000</span>
00234 <span class="comment">*</span>
00235 <span class="comment">********************************************************/</span>
<a name="l00236"></a><a class="code" href="arc__2__ewevent_8c.html#a13">00236</a> <span class="keywordtype">int</span>     <a class="code" href="arc__2__ewevent_8c.html#a13">ArcMsg2EWEvent</a> (EWEventInfoStruct *pEWEvent, <span class="keywordtype">char</span> *pArc, <span class="keywordtype">int</span> ArcLen)
00237 {
00238 
00239         <span class="keywordtype">int</span>                                     j, rc, index;
00240         <span class="keywordtype">int</span>                                     nline, tmp, toalloc;
00241         <span class="keywordtype">char</span>                            *in;
00242         <span class="keywordtype">char</span>                            line[<a class="code" href="arc__2__ewevent_8c.html#a0">ARC_HYP_LEN</a>];
00243         <span class="keywordtype">char</span>                            shdw[<a class="code" href="arc__2__ewevent_8c.html#a1">ARC_SHYP_LEN</a>];
00244         EWDB_EventStruct        *pEvent;
00245         EWDB_OriginStruct       *pOrigin;
00246         EWDB_MagStruct          *pMagnitude;
00247         EWDB_ArrivalStruct      *pArrival;
00248         EWDB_StationMagStruct   *pStaMag;
00249         EWDB_StationStruct      *pStation;
00250   EWChannelDataStruct   *pOldChan;
00251         <span class="keyword">struct </span><a class="code" href="structHsum.html">Hsum</a>             HSum;
00252         <span class="keyword">struct </span><a class="code" href="structHpck.html">Hpck</a>             HPck;
00253         <span class="comment">/* EWDB_CodaAmplitudeStruct     *pCodaAmp; */</span>
00254 
00255 
00256         <span class="keywordflow">if</span> ((pEWEvent == NULL) || (pArc == NULL) || (ArcLen &lt;= 0))
00257         {
00258                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"ArcMsg2EWEvent: Invalid arguments passed in.\n"</span>);
00259                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00260         }
00261 
00262 
00263         <span class="comment">/* Initialize the Event structure */</span>
00264         <span class="keywordflow">if</span> (<a class="code" href="init__ewevent_8c.html#a0">InitEWEvent</a> (pEWEvent) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00265         {
00266                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Call to InitEWEvent failed.\n"</span>);
00267                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00268         }
00269 
00270 
00271         <span class="comment">/* Initialize other stuff</span>
00272 <span class="comment">         ***********************/</span>
00273         nline  = 0;
00274         in     = pArc;
00275 
00276         memset (&amp;HSum, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structHsum.html">Hsum</a>));
00277         
00278         pEvent = &amp;pEWEvent-&gt;Event;
00279         memset (pEvent, 0, <span class="keyword">sizeof</span> (EWDB_EventStruct));
00280         pEWEvent-&gt;iNumChans = 0;
00281 
00282 
00283         pOrigin = &amp;pEWEvent-&gt;PrefOrigin;
00284         memset (pOrigin, 0, <span class="keyword">sizeof</span> (EWDB_OriginStruct));
00285         
00286         pMagnitude = &amp;pEWEvent-&gt;Mags[0];
00287         memset (pMagnitude, 0, <span class="keyword">sizeof</span> (EWDB_MagStruct));
00288 
00289 
00290         <span class="comment">/* Read one data line and its shadow at a time from arcmsg; process them</span>
00291 <span class="comment">         ***********************************************************************/</span>
00292         index = 0;
00293         <span class="keywordflow">while</span> (index &lt; ArcLen)
00294         {
00295                 j = 0;
00296         <span class="keywordflow">while</span> (in[index] != <span class="charliteral">'\n'</span>)
00297         {
00298             line[j] = in[index];
00299             index = index + 1;
00300             j = j + 1;
00301         }
00302         <span class="keywordflow">if</span> (in[index] == <span class="charliteral">'\n'</span>)
00303         {
00304             line[j] = <span class="charliteral">'\0'</span>;
00305         }
00306                 <span class="keywordflow">else</span>
00307                 {
00308                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Max hyp length reached without newline\n"</span>);
00309                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00310                 }
00311 
00312                 j = 0;
00313                 index = index + 1;
00314         <span class="keywordflow">while</span> ((in[index] != <span class="charliteral">'\n'</span>) &amp;&amp; (j &lt;  <a class="code" href="arc__2__ewevent_8c.html#a3">ARC_SPHS_LEN</a>))
00315         {
00316             shdw[j] = in[index];
00317             index = index + 1;
00318             j = j + 1;
00319         }
00320         <span class="keywordflow">if</span> (in[index] == <span class="charliteral">'\n'</span>)
00321         {
00322             shdw[j] = <span class="charliteral">'\0'</span>;
00323         }
00324                 <span class="keywordflow">else</span>
00325                 {
00326                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Max hyp length reached without newline\n"</span>);
00327                         <span class="keywordflow">break</span>;
00328                 }
00329 
00330                 index = index + 1;
00331 
00332                 nline++;
00333 
00334                 <span class="comment">/* Process the hypocenter card (1st line of msg) &amp; its shadow</span>
00335 <span class="comment">                ************************************************************/</span>
00336                 <span class="keywordflow">if</span> (nline == 1) 
00337                 {                  <span class="comment">/* hypocenter */</span>
00338                         rc = <a class="code" href="read__arc_8c.html#a5">read_hyp</a> (line, NULL, &amp;HSum); 
00339         
00340                         pEvent-&gt;idEvent=HSum.<a class="code" href="structHsum.html#m0">qid</a>;
00341             
00342                         <span class="comment">/* Fill in the Origin Struct */</span>
00343                         pOrigin-&gt;BindToEvent = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00344                         pOrigin-&gt;idEvent = pEvent-&gt;idEvent;
00345                         pOrigin-&gt;SetPreferred = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00346                         pOrigin-&gt;tOrigin = HSum.<a class="code" href="structHsum.html#m1">ot</a> - <a class="code" href="chron3_8h.html#a0">GSEC1970</a>; 
00347         
00348                         pOrigin-&gt;dLat = HSum.<a class="code" href="structHsum.html#m2">lat</a>;
00349                         pOrigin-&gt;dLon = HSum.<a class="code" href="structHsum.html#m3">lon</a>;
00350                         pOrigin-&gt;dDepth = HSum.<a class="code" href="structHsum.html#m4">z</a>;
00351                         pOrigin-&gt;dErrLat = HSum.<a class="code" href="structHsum.html#m16">erh</a>;
00352                         pOrigin-&gt;dErrLon = HSum.<a class="code" href="structHsum.html#m16">erh</a>;
00353                         pOrigin-&gt;dErZ = HSum.<a class="code" href="structHsum.html#m17">erz</a>;
00354                         pOrigin-&gt;iGap = HSum.<a class="code" href="structHsum.html#m6">gap</a>;
00355                         pOrigin-&gt;dDmin = (float)(HSum.<a class="code" href="structHsum.html#m7">dmin</a>);
00356                         pOrigin-&gt;dRms = HSum.<a class="code" href="structHsum.html#m8">rms</a>;
00357                         pOrigin-&gt;iUsedPh = HSum.<a class="code" href="structHsum.html#m5">nph</a>;
00358                         pOrigin-&gt;iE1Azm = HSum.<a class="code" href="structHsum.html#m12">e1az</a>;
00359                         pOrigin-&gt;iE1Dip = HSum.<a class="code" href="structHsum.html#m13">e1dp</a>;
00360                         pOrigin-&gt;iE2Azm = HSum.<a class="code" href="structHsum.html#m9">e0az</a>;
00361                         pOrigin-&gt;iE2Dip = HSum.<a class="code" href="structHsum.html#m10">e0dp</a>;
00362                         pOrigin-&gt;dE0 = HSum.<a class="code" href="structHsum.html#m11">e0</a>;
00363                         pOrigin-&gt;dE1 = HSum.<a class="code" href="structHsum.html#m14">e1</a>;
00364                         pOrigin-&gt;dE2 = HSum.<a class="code" href="structHsum.html#m15">e2</a>;
00365                         pOrigin-&gt;iFixedDepth = <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00366         
00367         
00368                         <span class="comment">/* Since the Event/Origin insert succeeded, </span>
00369 <span class="comment">                           insert the associated Magnitude </span>
00370 <span class="comment">                           *******************************************/</span>
00371         
00372                         <span class="comment">/* Fill in the Magnitude Struct */</span>
00373                         pMagnitude-&gt;iMagType = <a class="code" href="earthworm__defs_8h.html#a34">MAGTYPE_DURATION</a>;
00374                         pMagnitude-&gt;dMagAvg  = HSum.<a class="code" href="structHsum.html#m18">Md</a>;
00375                         pMagnitude-&gt;iNumMags = (int)(HSum.<a class="code" href="structHsum.html#m26">mdwt</a> + 0.9);
00376                         pMagnitude-&gt;dMagErr  = HSum.<a class="code" href="structHsum.html#m25">mdmad</a>;
00377                         pMagnitude-&gt;idEvent  = pEvent-&gt;idEvent;
00378                         pMagnitude-&gt;bBindToEvent = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00379                         pMagnitude-&gt;bSetPreferred = <a class="code" href="earthworm__defs_8h.html#a8">TRUE</a>;
00380 
00381                         pEWEvent-&gt;iNumMags = 1;
00382                         pEWEvent-&gt;iPrefMag = 0;
00383                         pEWEvent-&gt;iMd = 0;
00384 
00385                 }
00386                 <span class="keywordflow">else</span>
00387                 {
00388                         <span class="comment">/* Process all the phase cards &amp; their shadows</span>
00389 <span class="comment">                           *********************************************/</span>
00390                         <span class="keywordflow">if</span> (strlen (line) &lt; (size_t) 75)  <span class="comment">/* found the terminator line      */</span>
00391                                 <span class="keywordflow">break</span>;  
00392 
00393                         <span class="comment">/* re-blank the pick struct */</span>
00394                         memset (&amp;HPck, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structHpck.html">Hpck</a>));
00395 
00396                         <span class="keywordflow">if</span> (pEWEvent-&gt;iNumChans &gt;= pEWEvent-&gt;iNumAllocChans)
00397                         {
00398 
00399                                 toalloc = (int) (pEWEvent-&gt;iNumAllocChans + CHAN_ALLOC_INCR);
00400 
00401                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Max Channels (%d) reached. Alloc to %d\n"</span>,
00402                                                                                                 pEWEvent-&gt;iNumAllocChans, toalloc);
00403 
00404                                 pOldChan = pEWEvent-&gt;pChanInfo;
00405                                 <span class="keywordflow">if</span> ((pEWEvent-&gt;pChanInfo = (EWChannelDataStruct *) malloc
00406                                                                 (toalloc * <span class="keyword">sizeof</span> (EWChannelDataStruct))) == NULL)
00407                                 {
00408                                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>,  <span class="stringliteral">"Could not malloc %d pChanInfo entries.\n"</span>, toalloc);
00409                                         <span class="keywordflow">return</span>  (EW_FAILURE);
00410                                 }
00411 
00412                                 memcpy (pEWEvent-&gt;pChanInfo, pOldChan,
00413                                                 (pEWEvent-&gt;iNumAllocChans * sizeof (EWChannelDataStruct)));
00414 
00415                                 <span class="keywordflow">for</span> (tmp = pEWEvent-&gt;iNumChans; tmp &lt; toalloc; tmp++)
00416                                         <a class="code" href="init__ewevent_8c.html#a1">InitEWChan</a>(&amp;pEWEvent-&gt;pChanInfo[tmp]);
00417 
00418                                 pEWEvent-&gt;iNumAllocChans = toalloc;
00419 
00420                                 free (pOldChan);
00421                         }
00422 
00423 
00424 
00425                         <span class="comment">/* load info into Pck structure   */</span>
00426                         rc = <a class="code" href="read__arc_8c.html#a6">read_phs</a> (line, shdw, &amp;HPck);
00427 
00428                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals = 0;
00429                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumStaMags = 0;
00430 
00431                         pStation = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].Station;
00432                         memset(pStation, 0, <span class="keyword">sizeof</span>(EWDB_StationStruct));
00433 
00434 
00435                         <span class="comment">/* Fill in the common information */</span>
00436                         strncpy (pStation-&gt;Sta, HPck.<a class="code" href="structHpck.html#m0">site</a>, sizeof (pStation-&gt;Sta)-1);
00437                         strncpy (pStation-&gt;Comp, HPck.<a class="code" href="structHpck.html#m2">comp</a>, sizeof (pStation-&gt;Comp)-1);
00438                         strncpy (pStation-&gt;Net, HPck.<a class="code" href="structHpck.html#m1">net</a>, sizeof (pStation-&gt;Net)-1);
00439 
00440                         <span class="comment">/* Do we have a P-pick?? */</span>
00441                         <span class="keywordflow">if</span> ((HPck.<a class="code" href="structHpck.html#m3">Plabel</a> == <span class="charliteral">'P'</span>) || (HPck.<a class="code" href="structHpck.html#m3">Plabel</a> == <span class="charliteral">'p'</span>))
00442                         {
00443                                 <span class="comment">/* Fill in the P-pick information */</span>
00444 
00445                                 rc = pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals;
00446 
00447                                 pArrival = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].Arrivals[rc];
00448                                 memset(pArrival, 0, <span class="keyword">sizeof</span>(EWDB_ArrivalStruct));
00449         
00450                                 pStaMag = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].Stamags[rc];
00451                                 memset(pStaMag, 0, <span class="keyword">sizeof</span>(EWDB_StationMagStruct));
00452         
00453 
00454                                 <span class="comment">/* Fill in the Arrival record */</span>
00455                                 pArrival-&gt;idOrigin = pOrigin-&gt;idOrigin;
00456 
00457                                 pArrival-&gt;tObsPhase = HPck.<a class="code" href="structHpck.html#m7">Pat</a> -  <a class="code" href="chron3_8h.html#a0">GSEC1970</a>; 
00458                                 pArrival-&gt;tCalcPhase = pArrival-&gt;tObsPhase - HPck.<a class="code" href="structHpck.html#m9">Pres</a>;
00459 
00460                                 <span class="keywordflow">if</span> (pArrival-&gt;dWeight &gt; 1000.0)
00461                                         pArrival-&gt;dWeight = 0.0;
00462 
00463                                 pArrival-&gt;dAzm = (float) HPck.<a class="code" href="structHpck.html#m20">azm</a>;
00464                                 pArrival-&gt;dTakeoff = (float) HPck.<a class="code" href="structHpck.html#m21">takeoff</a>;
00465                                 pArrival-&gt;tResPick = HPck.<a class="code" href="structHpck.html#m9">Pres</a>;
00466                                 pArrival-&gt;szObsPhase[0] = <span class="charliteral">'P'</span>;
00467                                 pArrival-&gt;cMotion = HPck.<a class="code" href="structHpck.html#m15">Pfm</a>;
00468                                 pArrival-&gt;cOnset = HPck.<a class="code" href="structHpck.html#m5">Ponset</a>;
00469                                 pArrival-&gt;dDist = HPck.<a class="code" href="structHpck.html#m22">dist</a>;
00470                                 pArrival-&gt;dWeight = HPck.<a class="code" href="structHpck.html#m23">Pwt</a>;
00471         
00472                                 <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m11">Pqual</a> == 3)
00473                                         pArrival-&gt;dSigma = 0.08;
00474                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m11">Pqual</a> == 2)
00475                                         pArrival-&gt;dSigma = 0.05;
00476                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m11">Pqual</a> == 1)
00477                                         pArrival-&gt;dSigma = 0.03;
00478                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m11">Pqual</a> == 0)
00479                                         pArrival-&gt;dSigma = 0.02;
00480                                 <span class="keywordflow">else</span>
00481                                         pArrival-&gt;dSigma = 99.99;
00482         
00483                                 <span class="comment">/* create phase label */</span>
00484                                 sprintf (pArrival-&gt;szCalcPhase, <span class="stringliteral">"P"</span>);
00485 
00486                                 pStaMag-&gt;idChan = pArrival-&gt;idChan;
00487                                 pStaMag-&gt;StaMagUnion.CodaDur.idPick = pArrival-&gt;idPick;
00488                                 pStaMag-&gt;idMagnitude = pMagnitude-&gt;idMag;
00489                                 pStaMag-&gt;iMagType = <a class="code" href="earthworm__defs_8h.html#a34">MAGTYPE_DURATION</a>;
00490                                 pStaMag-&gt;dMag = HPck.<a class="code" href="structHpck.html#m19">Md</a>;
00491                                 pStaMag-&gt;dWeight = (float) HPck.<a class="code" href="structHpck.html#m14">codawt</a>;
00492                                 pStaMag-&gt;StaMagUnion.CodaDur.tCodaTermObs = pArrival-&gt;tObsPhase + HPck.<a class="code" href="structHpck.html#m26">codalenObs</a>;
00493                                 pStaMag-&gt;StaMagUnion.CodaDur.tCodaTermXtp = pArrival-&gt;tObsPhase + HPck.<a class="code" href="structHpck.html#m13">codalen</a>;
00494         
00495                                 pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals = 
00496                                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals + 1;
00497 
00498                                 pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumStaMags = 
00499                                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumStaMags + 1;
00500 
00501                         }
00502 
00503                         <span class="comment">/* Do we have an S-pick */</span>
00504                         <span class="keywordflow">if</span> ((HPck.<a class="code" href="structHpck.html#m4">Slabel</a> == <span class="charliteral">'S'</span>) || (HPck.<a class="code" href="structHpck.html#m4">Slabel</a> == <span class="charliteral">'s'</span>))
00505                         {
00506 
00507                                 <span class="comment">/* Fill in the S-pick information */</span>
00508 
00509                                 rc = pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals;
00510 
00511                                 pArrival = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].Arrivals[rc];
00512                                 memset(pArrival, 0, <span class="keyword">sizeof</span>(EWDB_ArrivalStruct));
00513         
00514                                 pStaMag = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].Stamags[rc];
00515                                 memset(pStaMag, 0, <span class="keyword">sizeof</span>(EWDB_StationMagStruct));
00516         
00517                                 <span class="comment">/* pPhaseAmp = &amp;pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].PhaseAmps[rc];</span>
00518 <span class="comment">                                 * memset(pPhaseAmp, 0, sizeof(EWDB_PhaseAmpStruct)); */</span>
00519                                 
00520                                 <span class="comment">/* Fill in the Arrival record */</span>
00521                                 pArrival-&gt;idOrigin = pOrigin-&gt;idOrigin;
00522 
00523                                 pArrival-&gt;tObsPhase = HPck.<a class="code" href="structHpck.html#m8">Sat</a> -  <a class="code" href="chron3_8h.html#a0">GSEC1970</a>; 
00524                                 pArrival-&gt;tCalcPhase = pArrival-&gt;tObsPhase - HPck.<a class="code" href="structHpck.html#m10">Sres</a>;
00525 
00526                                 <span class="keywordflow">if</span> (pArrival-&gt;dWeight &gt; 1000.0)
00527                                         pArrival-&gt;dWeight = 0.0;
00528 
00529                                 pArrival-&gt;dAzm = (float) HPck.<a class="code" href="structHpck.html#m20">azm</a>;
00530                                 pArrival-&gt;dTakeoff = (float) HPck.<a class="code" href="structHpck.html#m21">takeoff</a>;
00531                                 pArrival-&gt;tResPick = HPck.<a class="code" href="structHpck.html#m10">Sres</a>;
00532                                 pArrival-&gt;szObsPhase[0] = <span class="charliteral">'S'</span>;
00533                                 pArrival-&gt;cMotion = HPck.<a class="code" href="structHpck.html#m16">Sfm</a>;
00534                                 pArrival-&gt;cOnset = HPck.<a class="code" href="structHpck.html#m6">Sonset</a>;
00535                                 pArrival-&gt;dDist = HPck.<a class="code" href="structHpck.html#m22">dist</a>;
00536                                 pArrival-&gt;dWeight = HPck.<a class="code" href="structHpck.html#m24">Swt</a>;
00537         
00538                                 <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m12">Squal</a> == 3)
00539                                         pArrival-&gt;dSigma = 0.08;
00540                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m12">Squal</a> == 2)
00541                                         pArrival-&gt;dSigma = 0.05;
00542                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m12">Squal</a> == 1)
00543                                         pArrival-&gt;dSigma = 0.03;
00544                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HPck.<a class="code" href="structHpck.html#m12">Squal</a> == 0)
00545                                         pArrival-&gt;dSigma = 0.02;
00546                                 <span class="keywordflow">else</span>
00547                                         pArrival-&gt;dSigma = 99.99;
00548         
00549                                 <span class="comment">/* create phase label */</span>
00550                                 sprintf (pArrival-&gt;szCalcPhase, <span class="stringliteral">"S"</span>);
00551 
00552         <span class="comment">/* This is horse pucky, you can't have a duration magnitude calc'd off </span>
00553 <span class="comment">           an S wave!  CLEANUP! DavidK */</span>
00554                                 pStaMag-&gt;idChan = pArrival-&gt;idChan;
00555                                 pStaMag-&gt;StaMagUnion.CodaDur.idPick = pArrival-&gt;idPick;
00556                                 pStaMag-&gt;idMagnitude = pMagnitude-&gt;idMag;
00557                                 pStaMag-&gt;iMagType = <a class="code" href="earthworm__defs_8h.html#a34">MAGTYPE_DURATION</a>;
00558                                 pStaMag-&gt;dMag = HPck.<a class="code" href="structHpck.html#m19">Md</a>;
00559                                 pStaMag-&gt;dWeight = (float) HPck.<a class="code" href="structHpck.html#m14">codawt</a>;
00560                                 pStaMag-&gt;StaMagUnion.CodaDur.tCodaTermObs = pArrival-&gt;tObsPhase + HPck.<a class="code" href="structHpck.html#m26">codalenObs</a>;
00561                                 pStaMag-&gt;StaMagUnion.CodaDur.tCodaTermXtp = pArrival-&gt;tObsPhase + HPck.<a class="code" href="structHpck.html#m13">codalen</a>;
00562 
00563                                 pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals = 
00564                                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumArrivals + 1;
00565 
00566                                 pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumStaMags = 
00567                                         pEWEvent-&gt;pChanInfo[pEWEvent-&gt;iNumChans].iNumStaMags + 1;
00568 
00569                         }
00570 
00571 
00572                         pEWEvent-&gt;iNumChans = pEWEvent-&gt;iNumChans + 1;
00573 
00574                 }   <span class="comment">/* else(line==1) */</span>
00575 
00576         } <span class="comment">/*end while over reading message*/</span>
00577 
00578         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00579 
00580 }
00581 
00582 
00583 <span class="comment">/***************************************************************</span>
00584 <span class="comment"> * BuildHyp () builds a hypoinverse summary card &amp; its shadow  *</span>
00585 <span class="comment"> ***************************************************************/</span>
<a name="l00586"></a><a class="code" href="arc__2__ewevent_8c.html#a10">00586</a> <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a10">BuildHyp</a> (EWEventInfoStruct *pEvent, <span class="keywordtype">char</span> *arcmsg, <span class="keywordtype">int</span> maxlen)
00587 {
00588 
00589         <span class="keywordtype">char</span>            line[<a class="code" href="arc__2__ewevent_8c.html#a0">ARC_HYP_LEN</a>];   <span class="comment">/* temporary working place */</span>
00590         <span class="keywordtype">char</span>            shdw[<a class="code" href="arc__2__ewevent_8c.html#a1">ARC_SHYP_LEN</a>];  <span class="comment">/* temporary shadow card   */</span>
00591         <span class="keyword">struct </span>tm       *otm;
00592         time_t          ott;
00593         <span class="keywordtype">int</span>             tmp;
00594         <span class="keywordtype">int</span>             i;
00595         EWDB_OriginStruct       *pOrig;
00596         EWDB_MagStruct          *pMag;
00597 
00598 
00599         <span class="keywordflow">if</span> ((pEvent == NULL) || (arcmsg == NULL))
00600         {
00601                 fprintf (stderr, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00602                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00603         }
00604 
00605 
00606         <span class="keywordflow">if</span> ((pOrig = &amp;(pEvent-&gt;PrefOrigin)) == NULL)
00607         {
00608                 fprintf (stderr, <span class="stringliteral">"Invalid pEvent -- can't get PrefOrigin.\n"</span>);
00609                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00610         }
00611 
00612         <span class="keywordflow">if</span> ((pMag = &amp;(pEvent-&gt;Mags[pEvent-&gt;iPrefMag])) == NULL)
00613         {
00614                 fprintf (stderr, <span class="stringliteral">"Invalid pEvent -- can't get Pref Magnitude.\n"</span>);
00615                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00616         }
00617 
00618 <span class="comment">/* Put all blanks into line and shadow card</span>
00619 <span class="comment"> ******************************************/</span>
00620    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="arc__2__ewevent_8c.html#a0">ARC_HYP_LEN</a>; i++)
00621                 line[i] = <span class="charliteral">' '</span>;
00622 
00623    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="arc__2__ewevent_8c.html#a1">ARC_SHYP_LEN</a>; i++)
00624                 shdw[i] = <span class="charliteral">' '</span>;
00625 
00626 <span class="comment">/*----------------------------------------------------------------------------------</span>
00627 <span class="comment">Sample HYPOINVERSE 2000 hypocenter and shadow card.  Event id from binder is stored in</span>
00628 <span class="comment">  cols 129-138.  Many fields are blank due to lack of information from binder.</span>
00629 <span class="comment">  (summary is 165 chars, including newline; shadow is 95 chars, including newline):</span>
00630 <span class="comment">199912312359492936 2810120 2596  851    27 78 19  15                                                                                         10154                1 \n</span>
00631 <span class="comment">$1                                                                              \n   </span>
00632 <span class="comment">0123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123</span>
00633 <span class="comment">-----------------------------------------------------------------------------------*/</span>
00634 
00635         <span class="comment">/* Origin time </span>
00636 <span class="comment">         *************/</span>
00637         ott = (time_t) pOrig-&gt;tOrigin;
00638         otm = gmtime( &amp;ott );
00639 
00640         sprintf( line, <span class="stringliteral">"%04d%02d%02d%02d%02d%02d%02d"</span>,  
00641               (otm-&gt;tm_year + 1900),
00642               otm-&gt;tm_mon+1,
00643               otm-&gt;tm_mday,
00644               otm-&gt;tm_hour,
00645               otm-&gt;tm_min,
00646               otm-&gt;tm_sec,
00647               (<span class="keywordtype">int</span>)((pOrig-&gt;tOrigin-(<span class="keywordtype">double</span>)ott+.005)*100.) );
00648         line[16]=<span class="charliteral">' '</span>;
00649 
00650         <span class="comment">/* Latitude, convert from decimal degrees to degrees/minutes*100 */</span>
00651         if (pOrig-&gt;dLat &gt;= 0)
00652                 sprintf (line+16, <span class="stringliteral">"%2d "</span>,  (<span class="keywordtype">int</span>)pOrig-&gt;dLat);
00653         <span class="keywordflow">else</span>
00654                 sprintf (line+16, <span class="stringliteral">"%2d%c"</span>, -(<span class="keywordtype">int</span>)pOrig-&gt;dLat, <span class="charliteral">'S'</span>);
00655 
00656         tmp = (<span class="keywordtype">int</span>) ((pOrig-&gt;dLat - (<span class="keywordtype">int</span>)pOrig-&gt;dLat) * 6000.);   
00657         sprintf( line+19,  <span class="stringliteral">"%4d"</span>,     (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(tmp), 9999 ));
00658         line[23]=<span class="charliteral">' '</span>;
00659 
00660         <span class="comment">/* Longitude, convert from decimal degrees to degrees/minutes*100 */</span>
00661         <span class="keywordflow">if</span> (pOrig-&gt;dLon &gt;= 0)
00662                 sprintf( line+23, <span class="stringliteral">"%2d%c"</span>,  (<span class="keywordtype">int</span>)pOrig-&gt;dLon, <span class="charliteral">'E'</span> );
00663         <span class="keywordflow">else</span>
00664                 sprintf( line+23, <span class="stringliteral">"%2d "</span>, (<span class="keywordtype">int</span>) (-1.0 * pOrig-&gt;dLon));
00665     line[26] = <span class="charliteral">' '</span>;
00666 
00667         tmp = (<span class="keywordtype">int</span>)( (pOrig-&gt;dLon - (<span class="keywordtype">int</span>)pOrig-&gt;dLon) * 6000.);   
00668         sprintf( line+27, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(tmp), 9999 ) );
00669         line[31]=<span class="charliteral">' '</span>;
00670 
00671         <span class="comment">/* Depth */</span>
00672         <span class="keywordflow">if</span> (pOrig-&gt;dDepth != 0.0)
00673         {
00674                 tmp = (<span class="keywordtype">int</span>) (pOrig-&gt;dDepth * 100.0);
00675                 sprintf( line+31,  <span class="stringliteral">"%5d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( <a class="code" href="arc__2__ewevent_8c.html#a7">ABS</a>(tmp), 99999 ) );
00676                 line[36]=<span class="charliteral">' '</span>;
00677         }
00678 
00679 
00680         <span class="comment">/* All the other stuff */</span>
00681 
00682         <span class="keywordflow">if</span> (pOrig-&gt;iUsedPh != 0)
00683         {
00684                 sprintf( line+39, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iUsedPh, 999 ) );
00685                 line[42] = <span class="charliteral">' '</span>;
00686         }
00687 
00688         <span class="keywordflow">if</span> (pOrig-&gt;iGap != 0)
00689         {
00690                 sprintf( line+42, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iGap, 999 ) );
00691                 line[45] = <span class="charliteral">' '</span>;
00692         }
00693 
00694         <span class="keywordflow">if</span> (pOrig-&gt;dDmin != 0.0)
00695         {
00696                 sprintf( line+45, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;dDmin, 999 ) );
00697                 line[48] = <span class="charliteral">' '</span>;
00698         }
00699 
00700         <span class="keywordflow">if</span> (pOrig-&gt;dRms != 0.0)
00701         {
00702                 tmp = (int) (pOrig-&gt;dRms*100.);
00703                 sprintf( line+48,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00704                 line[52]  = <span class="charliteral">' '</span>;
00705         }
00706 
00707         <span class="comment">/* azimuth of largest principal error */</span>
00708         <span class="keywordflow">if</span> (pOrig-&gt;iE2Azm != 0.0)
00709         {
00710                 sprintf( line+52,  <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iE2Azm, 999 ) );
00711                 line[55]  = <span class="charliteral">' '</span>;
00712         }
00713 
00714         <span class="comment">/* dip of largest principal error  */</span>
00715         <span class="keywordflow">if</span> (pOrig-&gt;iE2Dip != 0.0)
00716         {
00717                 sprintf( line+55,  <span class="stringliteral">"%2d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iE2Dip, 99 ) );
00718                 line[57]  = <span class="charliteral">' '</span>;
00719         }
00720 
00721         <span class="comment">/* magnitude (km) of largest principal error */</span>
00722         <span class="keywordflow">if</span> (pOrig-&gt;dE0 != 0.0)
00723         {
00724                 tmp = (int) (pOrig-&gt;dE0 * 100.);
00725                 sprintf( line+57,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00726                 line[61]  = <span class="charliteral">' '</span>;
00727         }
00728 
00729         <span class="comment">/* azimuth of intermediate principal error */</span>
00730         <span class="keywordflow">if</span> (pOrig-&gt;iE1Azm != 0.0)
00731         {
00732                 sprintf( line+61,  <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iE1Azm, 999 ) );
00733                 line[64]  = <span class="charliteral">' '</span>;
00734         }
00735 
00736         <span class="comment">/* dip of intermediate principal error  */</span>
00737         <span class="keywordflow">if</span> (pOrig-&gt;iE1Dip != 0.0)
00738         {
00739                 sprintf( line+64,  <span class="stringliteral">"%2d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pOrig-&gt;iE1Dip, 99 ) );
00740                 line[66]  = <span class="charliteral">' '</span>;
00741         }
00742 
00743         <span class="comment">/* magnitude (km) of intermed principal error */</span>
00744         <span class="keywordflow">if</span> (pOrig-&gt;dE1 != 0.0)
00745         {
00746                 tmp = (int) (pOrig-&gt;dE1 * 100.);
00747                 sprintf( line+66,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00748                 line[70]  = <span class="charliteral">' '</span>;
00749         }
00750  
00751 
00752         <span class="keywordflow">if</span> (pMag-&gt;dMagAvg != 0.0)
00753         {
00754                 tmp = (int) (pMag-&gt;dMagAvg*100.);
00755                 sprintf( line+70,  <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) MIN (tmp, 999));
00756                 line[73]  = <span class="charliteral">' '</span>;
00757         }
00758 
00759 
00761         sprintf (line+73, <span class="stringliteral">"   "</span>);
00762         line[76] = <span class="charliteral">' '</span>;
00763         
00764 
00765         <span class="comment">/* magnitude (km) of smallest principal error */</span>
00766         <span class="keywordflow">if</span> (pOrig-&gt;dE2 != 0.0)
00767         {
00768                 tmp = (int) (pOrig-&gt;dE2 * 100.);
00769                 sprintf( line+76,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00770                 line[80]  = <span class="charliteral">' '</span>;
00771         }
00772 
00773         <span class="keywordflow">if</span> (pOrig-&gt;dErrLon != 0.0)
00774         {
00775                 tmp = (int) (pOrig-&gt;dErrLon*100.);
00776                 sprintf( line+85,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00777                 line[89]  = <span class="charliteral">' '</span>;
00778         }
00779 
00780         <span class="keywordflow">if</span> (pOrig-&gt;dErZ != 0.0)
00781         {
00782                 tmp = (int) (pOrig-&gt;dErZ*100.);
00783                 sprintf( line+89,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( tmp, 9999 ) );
00784                 line[93]  = <span class="charliteral">' '</span>;
00785         }
00786 
00787         <span class="keywordflow">if</span> (pMag-&gt;iNumMags != 0)
00788         {
00789                 sprintf( line+100, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) MIN (pMag-&gt;iNumMags, 9999));
00790                 line[104] = <span class="charliteral">' '</span>;
00791         }
00792 
00793         <span class="keywordflow">if</span> (pMag-&gt;dMagErr != 0)
00794         {
00795                 sprintf( line+107, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) MIN (pMag-&gt;dMagErr, 999));
00796                 line[110] = <span class="charliteral">' '</span>;
00797         }
00798 
00799 
00800         <span class="keywordflow">if</span> (pEvent-&gt;Event.idEvent != 0)
00801         {
00802                 sprintf( line+136, <span class="stringliteral">"%10ld"</span>,   pEvent-&gt;Event.idEvent);
00803                 line[146] = <span class="charliteral">' '</span>;
00804         }
00805 
00806 
00807         sprintf (line+164, <span class="stringliteral">"\n\0"</span>);
00808 
00809 <span class="comment">/* Write out summary shadow card</span>
00810 <span class="comment"> *******************************/</span>
00811         sprintf( shdw,     <span class="stringliteral">"$1"</span>);
00812         shdw[2]= <span class="charliteral">' '</span>;
00813         sprintf (shdw+94,  <span class="stringliteral">"\n\0"</span>);
00814 
00815 <span class="comment">/* Copy both to the target address if there's room</span>
00816 <span class="comment"> *************************************************/</span>
00817         <span class="keywordflow">if</span> ((strlen (arcmsg) + strlen (line) + strlen (shdw) + 1) &gt; (size_t)maxlen ) 
00818         {
00819                 fprintf (stderr, <span class="stringliteral">"Max arcmsg length exceeded\n"</span>);
00820                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00821         }
00822 
00823         strcpy (arcmsg, line);
00824         strcat (arcmsg, shdw);
00825 
00826         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00827 
00828 }
00829 
00830 
00831 
00832 
00833 <span class="comment">/***********************************************************************</span>
00834 <span class="comment"> * BuildPhs() builds a hypoinverse archive phase card &amp; its shadow     *</span>
00835 <span class="comment"> ***********************************************************************/</span>
<a name="l00836"></a><a class="code" href="arc__2__ewevent_8c.html#a11">00836</a> <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a11">BuildPhs</a> (EWEventInfoStruct *pEvent, <span class="keywordtype">int</span> NumPhs, <span class="keywordtype">char</span> *arcmsg, <span class="keywordtype">int</span> maxlen)
00837 {
00838 
00839         <span class="keywordtype">char</span>            line[<a class="code" href="arc__2__ewevent_8c.html#a2">ARC_PHS_LEN</a>];     <span class="comment">/* temporary phase card    */</span>
00840         <span class="keywordtype">char</span>            shdw[<a class="code" href="arc__2__ewevent_8c.html#a3">ARC_SPHS_LEN</a>];    <span class="comment">/* temporary shadow card   */</span>
00841         <span class="keywordtype">char</span>            otime[50]; 
00842         <span class="keywordtype">int</span>             i, j;
00843         <span class="keyword">struct </span>tm       *otm;
00844         time_t          ott;
00845         <span class="keywordtype">int</span>             tmpint, slen, clen, nlen, plen;
00846         <span class="keywordtype">double</span>          Cat;
00847         EWDB_ArrivalStruct      *pArr;
00848         EWDB_StationStruct      *pStation;
00849         EWDB_StationMagStruct   *pStaMag;
00850 
00851 
00852 
00853         <span class="keywordflow">if</span> ((pEvent == NULL) || (NumPhs &lt; 0) || (arcmsg == NULL))
00854         {
00855                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00856                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00857         }
00858 
00859         <span class="keywordflow">if</span> ((pStation = &amp;pEvent-&gt;pChanInfo[NumPhs].Station) == NULL)
00860         {
00861                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid EWEvent passed in -- can't get Station.\n"</span>);
00862                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00863         }
00864 
00865         <span class="comment">/* Compute the common arrival time - yyyymmddhhmm */</span>
00866         ott = (time_t) pEvent-&gt;PrefOrigin.tOrigin;
00867         otm = gmtime( &amp;ott );
00868 
00869         sprintf (otime, <span class="stringliteral">"%04d%02d%02d%02d%02d00.00"</span>, 
00870                             (otm-&gt;tm_year + 1900),
00871                             otm-&gt;tm_mon+1,
00872                             otm-&gt;tm_mday,
00873                             otm-&gt;tm_hour,
00874                             otm-&gt;tm_min);
00875 
00876         <a class="code" href="chron3_8c.html#a11">epochsec17</a> (&amp;Cat, otime);
00877 
00878 
00879 
00880         <span class="comment">/* Put all blanks into line and shadow card</span>
00881 <span class="comment">         ******************************************/</span>
00882         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arc__2__ewevent_8c.html#a2">ARC_PHS_LEN</a>; i++ )
00883                 line[i] = <span class="charliteral">' '</span>;
00884 
00885         <span class="keywordflow">for</span> (i = 0; i &lt; pEvent-&gt;pChanInfo[NumPhs].iNumArrivals; i++)
00886         {
00887                 <span class="keywordflow">if</span> ((pArr = &amp;pEvent-&gt;pChanInfo[NumPhs].Arrivals[i]) == NULL)
00888                 {
00889                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid EWEvent passed in -- can't get Arrivals.\n"</span>);
00890                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00891                 }
00892 
00893 
00894                 <span class="keywordflow">if</span> ((pStaMag = &amp;pEvent-&gt;pChanInfo[NumPhs].Stamags[i]) == NULL)
00895                 {
00896                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Invalid EWEvent passed in -- can't get StaMags.\n"</span>);
00897                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00898                 }
00899 
00900 
00901 
00902 <span class="comment">/*----------------------------------------------------------------------------------------------------</span>
00903 <span class="comment">Sample HYPOINVERSE station archive card and its shadow card.</span>
00904 <span class="comment">  Many fields are blank due to lack of information from binder.</span>
00905 <span class="comment">  (phase is 101 chars, including newline; shadow is 93 chars, including newline):</span>
00906 <span class="comment">PWM  NC  VHZ  PD0199912312359 5341                                                0      77                 W  \n</span>
00907 <span class="comment">0123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 1</span>
00908 <span class="comment">$   6 5.49 1.80 7.91 3.30 0.10 PSN0   77 PHP3 1853 39 340 47 245 55 230 63  86 71  70 77  48           \n</span>
00909 <span class="comment">-----------------------------------------------------------------------------------------------------*/</span>
00910 
00911 
00912 
00913                 plen = strlen (pArr-&gt;szObsPhase);
00914                 slen = strlen (pStation-&gt;Sta);
00915                 clen = strlen (pStation-&gt;Comp);
00916                 nlen = strlen (pStation-&gt;Net);
00917 
00918                 <span class="comment">/* Fill in the common parts */</span>
00919 
00920                 <span class="comment">/* Station site code */</span>
00921                 <span class="keywordflow">if</span> (slen &gt;= 5) 
00922                         strncpy (line, pStation-&gt;Sta, 5);
00923                 <span class="keywordflow">else</span>
00924                         strncpy (line, pStation-&gt;Sta, slen );
00925 
00926                 <span class="comment">/* Network code */</span>
00927                 <span class="keywordflow">if</span> (nlen &gt;= 2) 
00928                         strncpy (line+5, pStation-&gt;Net, 2);
00929                 <span class="keywordflow">else</span>
00930                         strncpy (line+5, pStation-&gt;Net, nlen);
00931 
00932                 line[7] = <span class="charliteral">' '</span>;
00933 
00934                 <span class="comment">/* Component Code */</span>
00935                 <span class="keywordflow">if</span> (clen == 1)
00936                         strncpy(line+8, pStation-&gt;Comp, clen);
00937                 <span class="keywordflow">else</span> 
00938                         line[8] = <span class="charliteral">' '</span>;
00939 
00940                 <span class="keywordflow">if</span> (clen &gt;= 3)
00941                         strncpy (line+9, pStation-&gt;Comp, 3);
00942                 <span class="keywordflow">else</span>
00943                         strncpy (line+9, pStation-&gt;Comp, clen);
00944 
00945                 line[12] = <span class="charliteral">' '</span>;
00946 
00947                 <span class="comment">/* Common time  - yyyymmddhhmm */</span>
00948                 sprintf (line+17, <span class="stringliteral">"%04d%02d%02d%02d%02d"</span>,
00949                                                         (otm-&gt;tm_year + 1900),
00950                                                         otm-&gt;tm_mon+1,
00951                                                         otm-&gt;tm_mday,
00952                                                         otm-&gt;tm_hour,
00953                                                         otm-&gt;tm_min);
00954                 line[29] = <span class="charliteral">' '</span>;
00955                                                                 
00956 
00957                 <span class="keywordflow">if</span> ((pArr-&gt;szObsPhase[0] == <span class="charliteral">'P'</span>) || (pArr-&gt;szObsPhase[0] == <span class="charliteral">'p'</span>)) 
00958                 { 
00959                         <span class="comment">/* Fill in the P-wave information */</span>
00960         
00961                         <span class="comment">/* Make sure there's a pick</span>
00962 <span class="comment">                         **************************/</span>
00963                         <span class="keywordflow">if</span> (pArr-&gt;tObsPhase == 0.0) 
00964                         {
00965                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"No pick time found\n"</span>);
00966                                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00967                         }
00968         
00969                         <span class="comment">/* P onset (if any) */</span>
00970                         <span class="keywordflow">if</span> (pArr-&gt;cOnset != <span class="charliteral">'\0'</span> ) 
00971                                 line[13] = pArr-&gt;cOnset;
00972         
00973                         <span class="comment">/* P label */</span>
00974                         line[14] = <span class="charliteral">'P'</span>;
00975 
00976                         <span class="comment">/* P first motion */</span>
00977                         <span class="keywordflow">if</span> (pArr-&gt;cMotion != <span class="charliteral">'\0'</span> ) 
00978                                 line[15] = pArr-&gt;cMotion;
00979         
00980                         <span class="comment">/* Assigned P weight code */</span>
00981                         <span class="keywordflow">if</span> (pArr-&gt;dSigma &gt;= 0)
00982                         {
00983                                 <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.02)
00984                                         tmpint = 0;
00985                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.03)
00986                                         tmpint = 1;
00987                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.05)
00988                                         tmpint = 2;
00989                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.08)
00990                                         tmpint = 3;
00991                                 <span class="keywordflow">else</span> 
00992                                         tmpint = 4;
00993         
00994                                 line[16] = tmpint + <span class="charliteral">'0'</span>;
00995                         }
00996         
00997                         <span class="comment">/* Seconds of P arrival */</span>
00998                         sprintf (line+29, <span class="stringliteral">"%5d"</span>, (<span class="keywordtype">int</span>) (100.0 * (pArr-&gt;tObsPhase - Cat)));
00999                         line[34] = <span class="charliteral">' '</span>;
01000         
01001                         <span class="comment">/* P travel time residual */</span>
01002                         sprintf (line+34, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0* pArr-&gt;tResPick), 9999));
01003                         line[38] = <span class="charliteral">' '</span>;
01004         
01005                         <span class="comment">/* P weight actually used */</span>
01006                         sprintf (line+38, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0 * pArr-&gt;dWeight), 999));
01007                         line[41] = <span class="charliteral">' '</span>;
01008         
01009                         <span class="comment">/* epicentral distance */</span>
01010                         <span class="keywordflow">if</span> (pArr-&gt;dDist != 0.0)
01011                         {
01012                                 sprintf (line+74, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((10.0 * pArr-&gt;dDist), 9999));
01013                                 line[78] = <span class="charliteral">' '</span>;
01014                         }
01015         
01016                         <span class="comment">/* emergence angle at source */</span>
01017                         <span class="keywordflow">if</span> (pArr-&gt;dTakeoff != 0.0)
01018                         {
01019                                 sprintf (line+78, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dTakeoff, 999));
01020                                 line[81] = <span class="charliteral">' '</span>;
01021                         }
01022         
01023                         <span class="comment">/* duration magnitude weight code */</span>
01024                         sprintf (line+82, <span class="stringliteral">"%1d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pStaMag-&gt;dWeight, 9));
01025                         line[83] = <span class="charliteral">' '</span>;
01026         
01027         
01028                         <span class="comment">/* coda duration in seconds */</span>
01029                         <span class="keywordflow">if</span> (pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp != 0.0)
01030                         {
01031                                 sprintf( line+87,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp, 9999 ) );
01032                                 line[91] = <span class="charliteral">' '</span>;
01033                         }
01034         
01035                         <span class="comment">/* azimuth to station */</span>
01036                         <span class="keywordflow">if</span> (pArr-&gt;dAzm != 0.0)
01037                         {
01038                                 sprintf (line+91, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dAzm, 999));
01039                                 line[94] = <span class="charliteral">' '</span>;
01040                         }
01041         
01042                         <span class="comment">/* duration magnitude for this station */</span>
01043                         <span class="keywordflow">if</span> (pStaMag-&gt;dMag != 0.0)
01044                         {
01045                                 sprintf (line+94, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0* pStaMag-&gt;dMag), 999));
01046                                 line[97] = <span class="charliteral">' '</span>;
01047                         }
01048         
01049                         <span class="comment">/* data source code */</span>
01050                         sprintf( line+108,  <span class="stringliteral">"%c"</span>,   <span class="charliteral">' '</span>);
01051                         line[109] = <span class="charliteral">' '</span>;
01052         
01053                         sprintf( line+111, <span class="stringliteral">"\n\0"</span> );
01054         
01055         
01056         
01057                         <span class="comment">/* Build the shadow card</span>
01058 <span class="comment">                         ***********************/</span>
01059                         <span class="keywordflow">for</span>( j=0; j&lt;<a class="code" href="arc__2__ewevent_8c.html#a3">ARC_SPHS_LEN</a>; j++ )
01060                                 shdw[j] = <span class="charliteral">' '</span>;
01061         
01062                         strncpy (shdw, <span class="stringliteral">"$"</span>, 1);
01063         
01064                         <span class="keywordflow">if</span> (pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp != 0.0)
01065                         {
01066                                 sprintf (shdw+35, <span class="stringliteral">"%5d"</span>,  (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp, 99999 ) );
01067                                 shdw[40] = <span class="charliteral">' '</span>;
01068                         }
01069                 
01070                         sprintf (shdw+92, <span class="stringliteral">"\n\0"</span>);
01071         
01072                 } 
01073                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pArr-&gt;szObsPhase[0] == <span class="charliteral">'S'</span>) || (pArr-&gt;szObsPhase[0] == <span class="charliteral">'s'</span>)) 
01074                 {
01075 
01076                         <span class="comment">/* Fill in the S-wave information */</span>
01077 
01078                         <span class="comment">/* Make sure there's a pick</span>
01079 <span class="comment">                         **************************/</span>
01080                         <span class="keywordflow">if</span> (pArr-&gt;tObsPhase == 0.0) 
01081                         {
01082                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"No pick time found\n"</span>);
01083                                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01084                         }
01085         
01086                         <span class="comment">/* Seconds of S arrival */</span>
01087                         sprintf (line+41, <span class="stringliteral">"%5d"</span>, (<span class="keywordtype">int</span>) (100.0 * (pArr-&gt;tObsPhase - Cat)));
01088                         line[41+5] = <span class="charliteral">' '</span>;
01089 
01090                         <span class="comment">/* S onset (if any) */</span>
01091                         <span class="keywordflow">if</span> (pArr-&gt;cOnset != <span class="charliteral">'\0'</span> ) 
01092                                 line[46] = pArr-&gt;cOnset;
01093         
01094                         <span class="comment">/* S label */</span>
01095                         line[47] = <span class="charliteral">'S'</span>;
01096 
01097                         <span class="comment">/* blank  (first motion???) */</span>
01098                         line[48] = <span class="charliteral">' '</span>;
01099 
01100                         <span class="comment">/* Assigned S weight code */</span>
01101                         <span class="keywordflow">if</span> (pArr-&gt;dSigma &gt;= 0)
01102                         {
01103                                 <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.02)
01104                                         tmpint = 0;
01105                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.03)
01106                                         tmpint = 1;
01107                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.05)
01108                                         tmpint = 2;
01109                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.08)
01110                                         tmpint = 3;
01111                                 <span class="keywordflow">else</span> 
01112                                         tmpint = 4;
01113         
01114                                 line[49] = tmpint + <span class="charliteral">'0'</span>;
01115                         }
01116         
01117         
01118                         <span class="comment">/* S travel time residual */</span>
01119                         sprintf (line+50, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0* pArr-&gt;tResPick), 9999));
01120                         line[50+4] = <span class="charliteral">' '</span>;
01121         
01122                         <span class="comment">/* S weight actually used */</span>
01123                         sprintf (line+63, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0 * pArr-&gt;dWeight), 999));
01124                         line[63+3] = <span class="charliteral">' '</span>;
01125         
01126                         <span class="comment">/* epicentral distance */</span>
01127                         <span class="keywordflow">if</span> (pArr-&gt;dDist != 0.0)
01128                         {
01129                                 sprintf (line+74, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((10.0 * pArr-&gt;dDist), 9999));
01130                                 line[78] = <span class="charliteral">' '</span>;
01131                         }
01132         
01133                         <span class="comment">/* emergence angle at source */</span>
01134                         <span class="keywordflow">if</span> (pArr-&gt;dTakeoff != 0.0)
01135                         {
01136                                 sprintf (line+78, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dTakeoff, 999));
01137                                 line[81] = <span class="charliteral">' '</span>;
01138                         }
01139         
01140                         <span class="comment">/* duration magnitude weight code */</span>
01141                         sprintf (line+82, <span class="stringliteral">"%1d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pStaMag-&gt;dWeight, 9));
01142                         line[83] = <span class="charliteral">' '</span>;
01143         
01144         
01145                         <span class="comment">/* azimuth to station */</span>
01146                         <span class="keywordflow">if</span> (pArr-&gt;dAzm != 0.0)
01147                         {
01148                                 sprintf (line+91, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dAzm, 999));
01149                                 line[94] = <span class="charliteral">' '</span>;
01150                         }
01151         
01152                         <span class="comment">/* data source code */</span>
01153                         sprintf( line+108,  <span class="stringliteral">"%c"</span>,   <span class="charliteral">' '</span>);
01154                         line[109] = <span class="charliteral">' '</span>;
01155         
01156                         sprintf( line+111, <span class="stringliteral">"\n\0"</span> );
01157         
01158                 } <span class="comment">/* S-wave portion */</span>
01159                 <span class="keywordflow">else</span>
01160                 {
01161 
01162                         <span class="comment">/* Fill in the UNKNOWN wave portion */</span>
01163                         <span class="comment">/* THIS IS A HACK: to accomodate weird NSN </span>
01164 <span class="comment">                         * picks. In real life, we will not be using </span>
01165 <span class="comment">                         * the hypoinverse file format to do this</span>
01166 <span class="comment">                         */</span>
01167         
01168                         <span class="comment">/* Make sure there's a pick</span>
01169 <span class="comment">                         **************************/</span>
01170                         <span class="keywordflow">if</span> (pArr-&gt;tObsPhase == 0.0) 
01171                         {
01172                                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"No pick time found\n"</span>);
01173                                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01174                         }
01175         
01176         
01177                         <span class="comment">/* P remark such as "IP" */</span>
01178                         <span class="keywordflow">if</span> (plen &gt;= 2 )
01179                                 strncpy( line+13, pArr-&gt;szObsPhase, 2 );
01180                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plen == 1)
01181                                 strncpy( line+14, pArr-&gt;szObsPhase, plen );
01182 
01183         
01184                         <span class="comment">/* P first motion */</span>
01185                         <span class="keywordflow">if</span> (pArr-&gt;cMotion != <span class="charliteral">'\0'</span> ) 
01186                                 line[15] = pArr-&gt;cMotion;
01187         
01188                         <span class="comment">/* Assigned P weight code */</span>
01189                         <span class="keywordflow">if</span> (pArr-&gt;dSigma &gt;= 0)
01190                         {
01191                                 <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.02)
01192                                         tmpint = 0;
01193                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.03)
01194                                         tmpint = 1;
01195                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.05)
01196                                         tmpint = 2;
01197                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pArr-&gt;dSigma &lt;= 0.08)
01198                                         tmpint = 3;
01199                                 <span class="keywordflow">else</span> 
01200                                         tmpint = 4;
01201         
01202                                 line[16] = tmpint + <span class="charliteral">'0'</span>;
01203                         }
01204         
01205                         <span class="comment">/* Seconds of P arrival */</span>
01206                         sprintf (line+29, <span class="stringliteral">"%5d"</span>, (<span class="keywordtype">int</span>) (100.0 * (pArr-&gt;tObsPhase - Cat)));
01207                         line[34] = <span class="charliteral">' '</span>;
01208         
01209                         <span class="comment">/* P travel time residual */</span>
01210                         sprintf (line+34, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0* pArr-&gt;tResPick), 9999));
01211                         line[38] = <span class="charliteral">' '</span>;
01212         
01213                         <span class="comment">/* P weight actually used */</span>
01214                         sprintf (line+38, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0 * pArr-&gt;dWeight), 999));
01215                         line[41] = <span class="charliteral">' '</span>;
01216         
01217                         <span class="comment">/* epicentral distance */</span>
01218                         <span class="keywordflow">if</span> (pArr-&gt;dDist != 0.0)
01219                         {
01220                                 sprintf (line+74, <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((10.0 * pArr-&gt;dDist), 9999));
01221                                 line[78] = <span class="charliteral">' '</span>;
01222                         }
01223         
01224                         <span class="comment">/* emergence angle at source */</span>
01225                         <span class="keywordflow">if</span> (pArr-&gt;dTakeoff != 0.0)
01226                         {
01227                                 sprintf (line+78, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dTakeoff, 999));
01228                                 line[81] = <span class="charliteral">' '</span>;
01229                         }
01230         
01231                         <span class="comment">/* duration magnitude weight code */</span>
01232                         sprintf (line+82, <span class="stringliteral">"%1d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pStaMag-&gt;dWeight, 9));
01233                         line[83] = <span class="charliteral">' '</span>;
01234         
01235         
01236                         <span class="comment">/* coda duration in seconds */</span>
01237                         <span class="keywordflow">if</span> (pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp != 0.0)
01238                         {
01239                                 sprintf( line+87,  <span class="stringliteral">"%4d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp, 9999 ) );
01240                                 line[91] = <span class="charliteral">' '</span>;
01241                         }
01242         
01243                         <span class="comment">/* azimuth to station */</span>
01244                         <span class="keywordflow">if</span> (pArr-&gt;dAzm != 0.0)
01245                         {
01246                                 sprintf (line+91, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>(pArr-&gt;dAzm, 999));
01247                                 line[94] = <span class="charliteral">' '</span>;
01248                         }
01249         
01250                         <span class="comment">/* duration magnitude for this station */</span>
01251                         <span class="keywordflow">if</span> (pStaMag-&gt;dMag != 0.0)
01252                         {
01253                                 sprintf (line+94, <span class="stringliteral">"%3d"</span>, (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>((100.0* pStaMag-&gt;dMag), 999));
01254                                 line[97] = <span class="charliteral">' '</span>;
01255                         }
01256         
01257                         <span class="comment">/* data source code */</span>
01258                         sprintf( line+108,  <span class="stringliteral">"%c"</span>,   <span class="charliteral">' '</span>);
01259                         line[109] = <span class="charliteral">' '</span>;
01260         
01261                         sprintf( line+111, <span class="stringliteral">"\n\0"</span> );
01262         
01263         
01264                         <span class="comment">/* Build the shadow card</span>
01265 <span class="comment">                         ***********************/</span>
01266                         <span class="keywordflow">for</span>( j=0; j&lt;<a class="code" href="arc__2__ewevent_8c.html#a3">ARC_SPHS_LEN</a>; j++ )
01267                                 shdw[j] = <span class="charliteral">' '</span>;
01268         
01269                         strncpy (shdw, <span class="stringliteral">"$"</span>, 1);
01270         
01271                         <span class="keywordflow">if</span> (pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp != 0.0)
01272                         {
01273                                 sprintf (shdw+35, <span class="stringliteral">"%5d"</span>,  (<span class="keywordtype">int</span>) <a class="code" href="ahputaway_8c.html#a11">MIN</a>( pStaMag-&gt;StaMagUnion.CodaDur.tCodaDurXtp, 99999 ) );
01274                                 shdw[40] = <span class="charliteral">' '</span>;
01275                         }
01276                 
01277                         sprintf (shdw+92, <span class="stringliteral">"\n\0"</span>);
01278                 }
01279 
01280         } <span class="comment">/* loop over arrivals */</span>
01281 
01282          
01283         
01284         
01285         <span class="comment">/* Copy both to the target address if there's room</span>
01286 <span class="comment">         *************************************************/</span>
01287         <span class="keywordflow">if</span> ((strlen (arcmsg) + strlen (line) + strlen (shdw) + 1) &gt; (size_t)maxlen) 
01288         {
01289                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Max arcmsg length exceeded.\n"</span>);
01290                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01291         }
01292 
01293         strcat (arcmsg, line);
01294         strcat (arcmsg, shdw);
01295 
01296         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
01297 
01298 }
01299 
01300 
01301 
01302 
01303 
01304 <span class="comment">/***************************************************************************/</span>
01305 <span class="comment">/* BuildTerm() builds a hypoinverse event terminator card &amp; its shadow     */</span>
01306 <span class="comment">/***************************************************************************/</span>
<a name="l01307"></a><a class="code" href="arc__2__ewevent_8c.html#a12">01307</a> <span class="keywordtype">int</span>             <a class="code" href="arc__2__ewevent_8c.html#a12">BuildTerm</a> (<span class="keywordtype">int</span> eventid, <span class="keywordtype">char</span> *arcmsg, <span class="keywordtype">int</span> maxlen)
01308 {
01309    <span class="keywordtype">char</span> line[<a class="code" href="arc__2__ewevent_8c.html#a4">ARC_TRM_LEN</a>];   <span class="comment">/* temporary working place */</span>
01310    <span class="keywordtype">char</span> shdw[<a class="code" href="arc__2__ewevent_8c.html#a5">ARC_STRM_LEN</a>];   <span class="comment">/* temporary shadow card   */</span>
01311    <span class="keywordtype">int</span>  i;
01312 
01313 <span class="comment">/* Put all blanks into line and shadow card</span>
01314 <span class="comment"> ******************************************/</span>
01315         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="arc__2__ewevent_8c.html#a4">ARC_TRM_LEN</a>; i++)
01316                 line[i] = <span class="charliteral">' '</span>;
01317         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="arc__2__ewevent_8c.html#a5">ARC_STRM_LEN</a>; i++)
01318                 shdw[i] = <span class="charliteral">' '</span>;
01319 
01320 <span class="comment">/* Build terminator</span>
01321 <span class="comment"> ******************/</span>
01322         <span class="keywordflow">if</span> (eventid != 0) 
01323                 sprintf (line+62, <span class="stringliteral">"%10ld\n\0"</span>,  eventid );
01324         <span class="keywordflow">else</span>
01325                 sprintf (line+72, <span class="stringliteral">"\n\0"</span>);
01326 
01327 <span class="comment">/* Build shadow card</span>
01328 <span class="comment"> *******************/</span>
01329         sprintf (shdw, <span class="stringliteral">"$"</span>);
01330         shdw[1] = <span class="charliteral">' '</span>;
01331         <span class="keywordflow">if</span> (eventid != 0) 
01332                 sprintf (shdw+62, <span class="stringliteral">"%10ld\n\0"</span>,  eventid);
01333         <span class="keywordflow">else</span>
01334                 sprintf (shdw+72, <span class="stringliteral">"\n\0"</span>);
01335 
01336 <span class="comment">/* Copy both to the target address if there's room</span>
01337 <span class="comment"> *************************************************/</span>
01338         <span class="keywordflow">if</span> ((strlen (arcmsg) + strlen (line) + strlen (shdw) + 1) &gt; (size_t)maxlen) 
01339         {
01340                 <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">""</span>, <span class="stringliteral">"Max length (%d) of ARC message exceeded.\n"</span>, maxlen);
01341                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
01342         }
01343 
01344         strcat (arcmsg, line);
01345         strcat (arcmsg, shdw);
01346         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
01347 
01348 }
01349 
01350 
01351 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:15:59 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
