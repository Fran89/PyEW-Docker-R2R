<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>logger.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>logger.cpp</h1><a href="logger_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">logger.h</a>"</span>
00003 <span class="preprocessor">#include &lt;ios&gt;</span>      <span class="comment">// ios_base</span>
00004 <span class="preprocessor">#include &lt;time.h&gt;</span>   <span class="comment">// _tzset()</span>
00005 <span class="preprocessor">#include &lt;string.h&gt;</span>   <span class="comment">// strcpy(), strcat()</span>
00006 <span class="preprocessor">#include &lt;string&gt;</span>
00007 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>   <span class="comment">// va_list, et.al.</span>
00008 <span class="preprocessor">#include &lt;stdio.h&gt;</span>    <span class="comment">// error reporting</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="globalutils_8h.html">globalutils.h</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="worm__environ_8h.html">worm_environ.h</a>&gt;</span>
00011 
00012 <span class="comment">//---------------------------------------------------------------------------</span>
00013 <span class="preprocessor">#pragma package(smart_init)</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="classTLogger.html#q0">00015</a> <a class="code" href="classTMutex.html">TMutex</a> * <a class="code" href="classTLogger.html#q0">TLogger::AccessLock</a> = NULL;
<a name="l00016"></a><a class="code" href="classTLogger.html#q1">00016</a> std::fstream <a class="code" href="classTLogger.html#q1">TLogger::OutStream</a>;
<a name="l00017"></a><a class="code" href="classTLogger.html#q2">00017</a> <span class="keywordtype">char</span> <a class="code" href="classTLogger.html#q2">TLogger::PreviousDate</a>[<a class="code" href="timefuncs_8h.html#a0">WORM_TIMESTR_LENGTH</a>+1] = { <span class="stringliteral">""</span> };
<a name="l00018"></a><a class="code" href="classTLogger.html#q3">00018</a> <span class="keywordtype">bool</span> <a class="code" href="classTLogger.html#q3">TLogger::TruncOnOpen</a> = <span class="keyword">false</span>;
<a name="l00019"></a><a class="code" href="classTLogger.html#q4">00019</a> <span class="keywordtype">int</span> <a class="code" href="classTLogger.html#q4">TLogger::MaxTooLongLength</a> = 0;
00020 
00021 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00022"></a><a class="code" href="classTLogger.html#e0">00022</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classTLogger.html#e0">TLogger::OpenFile</a>()
00023 {
00024    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00025 
00026    <span class="keywordtype">char</span> _timbuf[<a class="code" href="timefuncs_8h.html#a0">WORM_TIMESTR_LENGTH</a>];
00027 
00028    <span class="comment">// request time in format YYYYMMDD</span>
00029    <a class="code" href="classTTimeFuncs.html#d1">TTimeFuncs::DateString</a>(_timbuf, WORM_TIMEFMT_8, WORM_LOCAL_TIME );
00030 
00031    <span class="keywordflow">if</span> (   strncmp(_timbuf, PreviousDate, strlen(PreviousDate)) != 0
00032        || (! <a class="code" href="classTLogger.html#q1">OutStream</a>.is_open())
00033       )
00034    {
00035       <span class="comment">// date has changed, open a new file</span>
00036       strcpy( PreviousDate, _timbuf );
00037 
00038       <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#q1">OutStream</a>.is_open() )
00039       {
00040          <a class="code" href="classTLogger.html#q1">OutStream</a>.close();
00041       }
00042 
00043       <span class="keywordtype">char</span> _logname[256];
00044 
00045       <span class="keywordtype">bool</span> _nodirectory = <span class="keyword">false</span>;
00046 
00047       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>(WORM_LOG_DIR) == NULL )
00048       {
00049          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>(EW_LOG_DIR) == NULL )
00050          {
00051             _nodirectory = <span class="keyword">true</span>;
00052             strcpy( _logname, <span class="stringliteral">""</span> );
00053          }
00054          <span class="keywordflow">else</span>
00055          {
00056             strcpy( _logname, TGlobalUtils::GetEnvironmentValue(EW_LOG_DIR) );
00057          }
00058       }
00059       <span class="keywordflow">else</span>
00060       {
00061          strcpy( _logname, TGlobalUtils::GetEnvironmentValue(WORM_LOG_DIR) );
00062       }
00063       strcat( _logname, TGlobalUtils::GetProgramName() );
00064       strcat( _logname, <span class="stringliteral">"_"</span> );
00065       strcat( _logname, _timbuf );
00066       strcat( _logname, <span class="stringliteral">".log"</span> );
00067 
00068       <span class="keywordflow">try</span>
00069       {
00070          <span class="keywordflow">if</span> ( TruncOnOpen )
00071          {
00072             <a class="code" href="classTLogger.html#q1">OutStream</a>.open( _logname, std::ios_base::out|std::ios_base::trunc );
00073          }
00074          <span class="keywordflow">else</span>
00075          {
00076             <a class="code" href="classTLogger.html#q1">OutStream</a>.open( _logname, std::ios_base::out|std::ios_base::app );
00077          }
00078 
00079          <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#q1">OutStream</a>.fail() )
00080          {
00081             <span class="keywordflow">throw</span> std::ios_base::failure( <span class="stringliteral">"Failed opening Log file"</span> );
00082          }
00083          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! <a class="code" href="classTLogger.html#q1">OutStream</a>.is_open() )
00084          {
00085             <span class="keywordflow">throw</span> std::ios_base::failure( <span class="stringliteral">"OutStream Log file"</span> );
00086          }
00087 
00088 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00089 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>(WORM_TIME_ZONE) == NULL )
00090          {
00091             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"=================================================="</span> &lt;&lt; std::endl;
00092             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"WARNING: The environment variable "</span> <a class="code" href="worm__environ_8h.html#a12">WORM_TIME_ZONE</a> &lt;&lt; std::endl;
00093             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"         (time zone) is not set."</span> &lt;&lt; std::endl;
00094             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"         UTC times in log messages may be bogus."</span> &lt;&lt; std::endl;
00095             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"=================================================="</span> &lt;&lt; std::endl;
00096          }
00097          <span class="keywordflow">else</span>
00098          {
00099             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"Notice: Using environment variable "</span> <a class="code" href="worm__environ_8h.html#a12">WORM_TIME_ZONE</a>;
00100             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">"="</span> &lt;&lt; <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>(WORM_TIME_ZONE);
00101             <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; <span class="stringliteral">" for time zone."</span> &lt;&lt; std::endl;
00102             _tzset();
00103          }
00104 <span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106          <span class="keywordflow">if</span> ( _nodirectory )
00107          {
00108             <a class="code" href="classTLogger.html#d1">Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00109                  , <span class="stringliteral">"Neither environment variable &lt;%s&gt; nor &lt;%s&gt; defined, writing logs to execution directory\n"</span>
00110                  , WORM_LOG_DIR
00111                  , EW_LOG_DIR
00112                  );
00113          }
00114       }
00115       <span class="keywordflow">catch</span>( std::ios_base::failure ex )
00116       {
00117          <a class="code" href="classTLogger.html#q1">OutStream</a>.close();
00118          fprintf( stderr
00119                 , <span class="stringliteral">"TLogger::OpenFile() File: %s\nError: %s"</span>
00120                 , _logname
00121                 , ex.what()
00122                 );
00123          r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00124       }
00125 
00126    }
00127    <span class="keywordflow">return</span> r_status;
00128 }
00129 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00130"></a><a class="code" href="classTLogger.html#d2">00130</a> <span class="keywordtype">void</span> <a class="code" href="classTLogger.html#d2">TLogger::Close</a>()
00131 {
00132    <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#q1">OutStream</a>.is_open() )
00133    {
00134       <a class="code" href="classTLogger.html#q1">OutStream</a>.close();
00135    }
00136    <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#q0">AccessLock</a> != NULL )
00137    {
00138       <span class="keyword">delete</span>( AccessLock );
00139       <a class="code" href="classTLogger.html#q0">AccessLock</a> = NULL;
00140    }
00141 }
00142 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00143"></a><a class="code" href="classTLogger.html#d1">00143</a> <span class="keywordtype">int</span> <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_FLAGS p_flags, <span class="keyword">const</span> <span class="keywordtype">char</span>* p_format, ... )
00144 {
00145    <span class="keywordtype">int</span> r_count = 0;
00146 
00147    <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#q0">AccessLock</a> == NULL )
00148    {
00149       <span class="keywordflow">if</span> ( (<a class="code" href="classTLogger.html#q0">AccessLock</a> = <span class="keyword">new</span> <a class="code" href="classTMutex.html">TMutex</a>(<span class="stringliteral">"logmutex"</span>)) == NULL )
00150       {
00151          fprintf( stderr, <span class="stringliteral">"TLogger::Logit(): Failed creating log file mutex\n"</span> );
00152          <span class="keywordflow">return</span> -1;
00153       }
00154    }
00155 
00156    <a class="code" href="classTLogger.html#q0">AccessLock</a>-&gt;<a class="code" href="classTMutex.html#a2">RequestLock</a>();
00157 
00158    <span class="comment">// The vast majority of the time, this space will not be used, but</span>
00159    <span class="comment">// at least the startstop status message's max size is apx 15K.</span>
00160    <span class="comment">// (actually, there are rumors of one message that is apx 65K).</span>
00161    <span class="keyword">static</span> <span class="keywordtype">char</span> _buff[16384];
00162    <span class="keyword">static</span> <span class="keywordtype">char</span> _args[16384];
00163 
00164    strcpy( _buff, <span class="stringliteral">""</span> );
00165 
00166    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a3">WORM_LOG_TIMESTAMP</a> )
00167    {
00168       <a class="code" href="classTTimeFuncs.html#d1">TTimeFuncs::DateString</a>(_buff, WORM_TIMEFMT_UTC21);
00169       strcat( _buff, <span class="stringliteral">" "</span> );
00170    }
00171 
00172    <span class="comment">/* TODO : Doesn't really make sense to add program filename to error file */</span>
00173 
00174    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a5">WORM_LOG_NAMESTAMP</a> )
00175    {
00176       strcat( _buff, TGlobalUtils::GetProgramName() );
00177       strcat( _buff, <span class="stringliteral">" "</span> );
00178    }
00179 
00180    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a4">WORM_LOG_PIDSTAMP</a> )
00181    {
00182       <span class="keywordtype">char</span> _pids[10];
00183       sprintf( _pids, <span class="stringliteral">" %d"</span>, TGlobalUtils::GetPID() );
00184       strcat( _buff, _pids );
00185       strcat( _buff, <span class="stringliteral">" "</span> );
00186    }
00187 
00188    strcpy( _args, <span class="stringliteral">""</span> );
00189    va_list _argptr;
00190    va_start(_argptr, p_format);
00191    r_count = vsprintf(_args, p_format, _argptr);
00192    va_end(_argptr);
00193 
00194 
00195    <span class="keywordflow">if</span> ( 0 &lt; r_count )
00196    {
00197       strcat( _buff, _args );
00198    }
00199 
00200    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a1">WORM_LOG_TOSTDOUT</a> )
00201    {
00202       fprintf( stdout, <span class="stringliteral">"%s"</span>, _buff );
00203    }
00204 
00205    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a2">WORM_LOG_TOSTDERR</a> )
00206    {
00207       fprintf( stderr, <span class="stringliteral">"%s"</span>, _buff );
00208    }
00209 
00210 
00211    <span class="keywordflow">if</span> ( p_flags &amp; <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a> &amp;&amp; <a class="code" href="classTGlobalUtils.html#d10">TGlobalUtils::WriteLogFile</a>() )
00212    {
00213 <span class="comment">//fprintf( stdout, "DEBUG Logit() V\n" );</span>
00214 
00215       <span class="keywordflow">if</span> ( <a class="code" href="classTLogger.html#e0">OpenFile</a>() == <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00216       {
00217 <span class="comment">//fprintf( stdout, "DEBUG Logit() W -1\n" );</span>
00218 <span class="comment">//fprintf( stdout, "DEBUG Logit() W:  &gt;%s&lt;\n", _buff );</span>
00219 <span class="comment">//fprintf( stdout, "DEBUG Logit() W  1\n" );</span>
00220 
00221          <span class="keywordflow">if</span> ( ! <a class="code" href="classTLogger.html#q1">OutStream</a>.is_open() )
00222          {
00223             fprintf( stderr
00224                    , <span class="stringliteral">"TLogger::Logit() OutStream is not open\n"</span>
00225                    );
00226          }
00227          <span class="keywordflow">else</span>
00228          {
00229 <span class="comment">//fprintf( stdout, "DEBUG Logit() X -1\n" );</span>
00230             <span class="keywordflow">try</span>
00231             {
00232                 <a class="code" href="classTLogger.html#q1">OutStream</a> &lt;&lt; _buff;
00233             }
00234             <span class="keywordflow">catch</span>( ... ) <span class="comment">//            catch( ios_base::failure _ioex )</span>
00235             {
00236 <span class="comment">//fprintf( stdout, "TLogger::Logit() OutStream &lt;&lt; resulted in exception\n" );</span>
00237             }
00238 <span class="comment">//fprintf( stdout, "DEBUG Logit() X\n" );</span>
00239             <a class="code" href="classTLogger.html#q1">OutStream</a>.flush();
00240          }
00241 <span class="comment">//fprintf( stdout, "DEBUG Logit() Y\n" );</span>
00242       }
00243       <span class="keywordflow">else</span>
00244       {
00245          fprintf( stderr
00246                 , <span class="stringliteral">"TLogger::Logit() FAILED OPENING LOG FILE FOR MESSAGE\n%s\n"</span>
00247                 , _buff
00248                 );
00249       }
00250    }
00251 
00252    <a class="code" href="classTLogger.html#q0">AccessLock</a>-&gt;<a class="code" href="classTMutex.html#a3">ReleaseLock</a>();
00253 
00254 <span class="comment">//fprintf( stdout, "DEBUG Logit() Z\n" );</span>
00255 
00256    <span class="keywordflow">return</span> r_count;
00257 }
00258 <span class="comment">//---------------------------------------------------------------------------</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:04 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
