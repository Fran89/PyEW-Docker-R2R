<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>magserverresult.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>magserverresult.cpp</h1><a href="magserverresult_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// magserverresult.cpp: implementation of the MagServerResult class.</span>
00002 <span class="comment">//</span>
00004 <span class="comment"></span>
00005 <span class="preprocessor">#include "<a class="code" href="magserverresult_8h.html">magserverresult.h</a>"</span>
00006 
00007 <span class="comment">//  0123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789</span>
00008 <span class="comment">//            1         2         3         4         5         6         7         8         9         0         1         2         3         4         5         6</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//  EEEEEEE OOOOOOO T M.MMMMM EE.EEEE AAAAAAAAA\n</span>
00011 <span class="comment">//</span>
00012 <span class="comment">//  IDIDIDIDID  CHCHCHCHCH CPCPCPCP SSSS CCC NNN LLLL la.ttttt lon.nnnnn elev.vvv azm.mm dip.ppp T AA.AAAA amp1.DDDD AMP1TIMEEEE AMP1PERIOD amp2.DDDD AMP2TIMEEEE AMP2PERIOD</span>
00013 <span class="comment">// </span>
<a name="l00014"></a><a class="code" href="magserverresult_8cpp.html#a0">00014</a> <span class="preprocessor">#define MSR_HEADER_LINE_SZ_EST  50</span>
<a name="l00015"></a><a class="code" href="magserverresult_8cpp.html#a1">00015</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_CHAN_LINE_SZ_EST   180</span>
00016 <span class="preprocessor"></span>
00018 <span class="comment">// Construction/Destruction</span>
00020 <span class="comment"></span>
<a name="l00021"></a><a class="code" href="classMagServerResult.html#a0">00021</a> <a class="code" href="classMagServerResult.html#a0">MagServerResult::MagServerResult</a>()
00022 {
00023    <a class="code" href="classMagServerResult.html#n0">EventId</a>    = 0L;
00024    <a class="code" href="classMagServerResult.html#n1">OriginId</a>   = 0L;
00025    <a class="code" href="classMagServerResult.html#n2">MagType</a>    = <a class="code" href="earthworm__defs_8h.html#a28">MAGTYPE_UNDEFINED</a>;
00026    <a class="code" href="classMagServerResult.html#n3">MagAverage</a> = 0.0;
00027    <a class="code" href="classMagServerResult.html#n4">MagError</a>   = 0.0;
00028 
00029    <a class="code" href="classMagServerResult.html#n5">Author</a>     = <span class="stringliteral">"000000000"</span>;
00030 }
00031 <span class="comment">//</span>
00032 <span class="comment">//-------------------------------------------------------------------</span>
00033 <span class="comment">//</span>
<a name="l00034"></a><a class="code" href="classMagServerResult.html#a1">00034</a> <span class="keywordtype">void</span> <a class="code" href="classMagServerResult.html#a1">MagServerResult::SetMagnitudeInfo</a>(       <span class="keywordtype">long</span>    p_eventid
00035                                       ,       <span class="keywordtype">long</span>    p_originid
00036                                       ,       <span class="keywordtype">int</span>     p_magtype
00037                                       ,       <span class="keywordtype">float</span>   p_average
00038                                       ,       <span class="keywordtype">float</span>   p_error
00039                                       , <span class="keyword">const</span> <span class="keywordtype">char</span>  * p_author
00040                                       )
00041 {
00042    <a class="code" href="classMagServerResult.html#n0">EventId</a>    = p_eventid;
00043    <a class="code" href="classMagServerResult.html#n1">OriginId</a>   = p_originid;
00044    <a class="code" href="classMagServerResult.html#n2">MagType</a>    = p_magtype;
00045    <a class="code" href="classMagServerResult.html#n3">MagAverage</a> = p_average;
00046    <a class="code" href="classMagServerResult.html#n4">MagError</a>   = p_error;
00047 
00048    <a class="code" href="classMagServerResult.html#n5">Author</a>     = ( p_author == NULL ? <span class="stringliteral">"000000000"</span> : p_author );
00049 }
00050 <span class="comment">//</span>
00051 <span class="comment">//-------------------------------------------------------------------</span>
00052 <span class="comment">//</span>
<a name="l00053"></a><a class="code" href="classMagServerResult.html#a2">00053</a> <span class="keywordtype">void</span> <a class="code" href="classMagServerResult.html#a2">MagServerResult::ClearChannels</a>()
00054 {
00055    <a class="code" href="classMagServerResult.html#n6">Channels</a>.clear();
00056 }
00057 <span class="comment">//</span>
00058 <span class="comment">//-------------------------------------------------------------------</span>
00059 <span class="comment">//</span>
<a name="l00060"></a><a class="code" href="classMagServerResult.html#a3">00060</a> <span class="keywordtype">void</span> <a class="code" href="classMagServerResult.html#a3">MagServerResult::AddChannel</a>( <a class="code" href="struct__MAG__SRVR__CHANNEL.html">MAG_SRVR_CHANNEL</a> p_channelinfo )
00061 {
00062    <a class="code" href="classMagServerResult.html#n6">Channels</a>.push_back( p_channelinfo );
00063 }
00064 <span class="comment">//</span>
00065 <span class="comment">//-------------------------------------------------------------------</span>
00066 <span class="comment">//</span>
<a name="l00067"></a><a class="code" href="classMagServerResult.html#a4">00067</a> <span class="keyword">const</span> <span class="keywordtype">long</span> <a class="code" href="classMagServerResult.html#a4">MagServerResult::GetEventId</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n0">EventId</a>; }
00068 <span class="comment">//</span>
00069 <span class="comment">//-------------------------------------------------------------------</span>
00070 <span class="comment">//</span>
<a name="l00071"></a><a class="code" href="classMagServerResult.html#a5">00071</a> <span class="keyword">const</span> <span class="keywordtype">long</span> <a class="code" href="classMagServerResult.html#a5">MagServerResult::GetOriginId</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n1">OriginId</a>; }
00072 <span class="comment">//</span>
00073 <span class="comment">//-------------------------------------------------------------------</span>
00074 <span class="comment">//</span>
<a name="l00075"></a><a class="code" href="classMagServerResult.html#a6">00075</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classMagServerResult.html#a6">MagServerResult::GetMagType</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n2">MagType</a>; }
00076 <span class="comment">//</span>
00077 <span class="comment">//-------------------------------------------------------------------</span>
00078 <span class="comment">//</span>
<a name="l00079"></a><a class="code" href="classMagServerResult.html#a7">00079</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="classMagServerResult.html#a7">MagServerResult::GetAverage</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n3">MagAverage</a>; }
00080 <span class="comment">//</span>
00081 <span class="comment">//-------------------------------------------------------------------</span>
00082 <span class="comment">//</span>
<a name="l00083"></a><a class="code" href="classMagServerResult.html#a8">00083</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="classMagServerResult.html#a8">MagServerResult::GetError</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n4">MagError</a>; }
00084 <span class="comment">//</span>
00085 <span class="comment">//-------------------------------------------------------------------</span>
00086 <span class="comment">//</span>
<a name="l00087"></a><a class="code" href="classMagServerResult.html#a9">00087</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="classMagServerResult.html#a9">MagServerResult::GetAuthor</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n5">Author</a>.c_str(); }
00088 <span class="comment">//</span>
00089 <span class="comment">//-------------------------------------------------------------------</span>
00090 <span class="comment">//</span>
<a name="l00091"></a><a class="code" href="classMagServerResult.html#a10">00091</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classMagServerResult.html#a10">MagServerResult::GetChannelCount</a>() { <span class="keywordflow">return</span> <a class="code" href="classMagServerResult.html#n6">Channels</a>.size(); }
00092 <span class="comment">//</span>
00093 <span class="comment">//-------------------------------------------------------------------</span>
00094 <span class="comment">//</span>
<a name="l00095"></a><a class="code" href="classMagServerResult.html#a11">00095</a> <span class="keywordtype">bool</span> <a class="code" href="classMagServerResult.html#a11">MagServerResult::GetChannel</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       p_index
00096                                 , <a class="code" href="struct__MAG__SRVR__CHANNEL.html">MAG_SRVR_CHANNEL</a> * r_channel
00097                                 )<span class="keyword"> const</span>
00098 <span class="keyword"></span>{
00099    <span class="keywordflow">if</span> (   <a class="code" href="classMagServerResult.html#n6">Channels</a>.size() &lt;= p_index
00100        || r_channel == NULL
00101       )
00102    {
00103       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00104    }
00105 
00106    *r_channel = <a class="code" href="classMagServerResult.html#n6">Channels</a>[p_index];
00107 
00108    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00109 }
00110 <span class="comment">//</span>
00111 <span class="comment">//-------------------------------------------------------------------</span>
00112 <span class="comment">//</span>
<a name="l00113"></a><a class="code" href="classMagServerResult.html#b0">00113</a> <span class="keywordtype">long</span> <a class="code" href="classMagServerResult.html#b0">MagServerResult::BufferInitAlloc</a>()
00114 {
00115    <span class="comment">// add estimated sizes for the magnitude and</span>
00116    <span class="comment">// and channel lines.</span>
00117    <span class="keywordflow">return</span> <a class="code" href="classMutableServerResult.html#b0">MutableServerResult::BufferInitAlloc</a>()
00118         + <a class="code" href="magserverresult_8cpp.html#a0">MSR_HEADER_LINE_SZ_EST</a>
00119         + <a class="code" href="classMagServerResult.html#n6">Channels</a>.size() * <a class="code" href="magserverresult_8cpp.html#a1">MSR_CHAN_LINE_SZ_EST</a>
00120         ;
00121 }
00122 <span class="comment">//</span>
00123 <span class="comment">//-------------------------------------------------------------------</span>
00124 <span class="comment">//</span>
<a name="l00125"></a><a class="code" href="classMagServerResult.html#b1">00125</a> <span class="keywordtype">void</span> <a class="code" href="classMagServerResult.html#b1">MagServerResult::FormatDerivativeData</a>()
00126 {
00127    <a class="code" href="classMutableServerResult.html#b1">MutableServerResult::FormatDerivativeData</a>();
00128 
00129    <span class="keywordtype">char</span> _wrk[240];
00130 
00131    <span class="comment">// Build the header line</span>
00132    <span class="comment">//</span>
00133    <span class="comment">// EEEEEEE OOOOOOO T M.MMMMM EE.EEEE AAAAAAAAA\n</span>
00134    <span class="comment">//</span>
00135    sprintf( _wrk
00136           , <span class="stringliteral">"%d %d %d %f %f %f %s\n"</span>
00137           , EventId
00138           , OriginId
00139           , MagType
00140           , MagAverage
00141           , MagError
00142           , <a class="code" href="classMagServerResult.html#n5">Author</a>.c_str()
00143           );
00144 
00145    <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a> += _wrk;
00146 
00147    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _c = 0 ; _c &lt; <a class="code" href="classMagServerResult.html#n6">Channels</a>.size() ; _c++ )
00148    {
00149       <span class="comment">// build a channel line</span>
00150       <span class="comment">//</span>
00151       sprintf( _wrk
00152              , <span class="stringliteral">"%d %d %d %s %s %s %s %f %f %f %f %f %d %f %f %f %f %f %f\n"</span>
00153              , Channels[_c].ampid
00154              , Channels[_c].channelid
00155              , Channels[_c].componentid
00156              , Channels[_c].sta
00157              , Channels[_c].comp
00158              , Channels[_c].net
00159              , Channels[_c].loc
00160              , Channels[_c].lat
00161              , Channels[_c].lon
00162              , Channels[_c].elev
00163              , Channels[_c].azm
00164              , Channels[_c].dip
00165              , Channels[_c].magnitude
00166              , Channels[_c].amp1
00167              , Channels[_c].amp1time
00168              , Channels[_c].amp1period
00169              , Channels[_c].amp2
00170              , Channels[_c].amp2time
00171              , Channels[_c].amp2period
00172              );
00173 
00174       <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a> += _wrk;
00175    }
00176 
00177 }
00178 <span class="comment">//</span>
00179 <span class="comment">//-------------------------------------------------------------------</span>
00180 <span class="comment">//</span>
<a name="l00181"></a><a class="code" href="classMagServerResult.html#b2">00181</a> <span class="keywordtype">void</span> <a class="code" href="classMagServerResult.html#b2">MagServerResult::ParseDerivativeData</a>()
00182 {
00183    <a class="code" href="classMutableServerResult.html#b2">MutableServerResult::ParseDerivativeData</a>();
00184 
00185    <span class="keywordtype">long</span> _index;
00186 
00187    <span class="keywordflow">if</span> ( (_index = <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.find(<span class="stringliteral">"\n"</span>)) == <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.npos )
00188    {
00189       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Unterminated message while parsing MagServerResult header"</span>);
00190    }
00191 
00192    <span class="keywordflow">if</span> ( _index &lt; 2 ) 
00193    {
00194       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete header line while parsing MagServerResult"</span>);
00195    }
00196 
00197    std::string _readline = <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.substr( 0 , _index );
00198 
00199    <span class="comment">// Remove this line from the buffer</span>
00200 
00201    <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.erase( 0 , _index + 1 );
00202 
00203    <span class="comment">// parse the header line</span>
00204 
00205    <span class="keywordtype">char</span> _author[60];
00206 
00207    <span class="keywordflow">if</span> ( sscanf( _readline.c_str()
00208               , <span class="stringliteral">"%ld %ld %d %f %f %f %s\n"</span>
00209               , &amp;<a class="code" href="classMagServerResult.html#n0">EventId</a>
00210               , &amp;<a class="code" href="classMagServerResult.html#n1">OriginId</a>
00211               , &amp;<a class="code" href="classMagServerResult.html#n2">MagType</a>
00212               , &amp;<a class="code" href="classMagServerResult.html#n3">MagAverage</a>
00213               , &amp;<a class="code" href="classMagServerResult.html#n4">MagError</a>
00214               ,  _author
00215               ) != 6 )
00216    {
00217       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Invalid header line while parsing MagServerResult"</span>);
00218    }
00219 
00220 
00221    <span class="comment">// parse the channel lines</span>
00222 
00223    <a class="code" href="struct__MAG__SRVR__CHANNEL.html">MAG_SRVR_CHANNEL</a> _channel;
00224 
00225    <span class="keywordflow">do</span>
00226    {
00227       <span class="keywordflow">if</span> ( (_index = <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.find(<span class="stringliteral">"\n"</span>)) == <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.npos )
00228       {
00229          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Unterminated message while parsing MagServerResult channel"</span>);
00230       }
00231 
00232       <span class="keywordflow">if</span> ( 0 &lt; _index ) 
00233       {
00234          _readline = <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.substr( 0 , _index );
00235 
00236          <span class="comment">// Remove this line from the buffer</span>
00237 
00238          <a class="code" href="classMutableServerMessage.html#n0">MessageBuffer</a>.erase( 0 , _index + 1 );
00239 
00240          <span class="comment">// parse the channel line</span>
00241 
00242          <span class="keywordflow">if</span> ( sscanf( _readline.c_str()
00243                     , <span class="stringliteral">"%ld %ld %s %s %s %s %f %f %f %f %f %d %f %f %lf %f %f %lf %f\n"</span>
00244                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m0">ampid</a>
00245                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m1">channelid</a>
00246                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m2">componentid</a>
00247                     ,  _channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m3">sta</a>
00248                     ,  _channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m4">comp</a>
00249                     ,  _channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m5">net</a>
00250                     ,  _channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m6">loc</a>
00251                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m7">lat</a>
00252                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m8">lon</a>
00253                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m9">elev</a>
00254                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m10">azm</a>
00255                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m11">dip</a>
00256                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m12">magnitude</a>
00257                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m13">amp1</a>
00258                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m14">amp1time</a>
00259                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m15">amp1period</a>
00260                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m16">amp2</a>
00261                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m17">amp2time</a>
00262                     , &amp;_channel.<a class="code" href="struct__MAG__SRVR__CHANNEL.html#m18">amp2period</a>
00263                     ) != 19 )
00264          {
00265             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Invalid channel line while parsing MagServerResult"</span>);
00266          }
00267 
00268       } <span class="comment">//  have a line with content </span>
00269 
00270    } <span class="keywordflow">while</span> ( 0 &lt; _index );
00271 
00272 }
00273 <span class="comment">//</span>
00274 <span class="comment">//-------------------------------------------------------------------</span>
00275 <span class="comment">//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:04 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
