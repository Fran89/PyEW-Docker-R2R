<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>site.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>site.c</h1><a href="site_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: site_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.2  2000/08/15 00:50:41  dietz</span>
00011 <span class="comment"> *     Fixed NT bug in site_read() where the 'E' longitude designator was being</span>
00012 <span class="comment"> *     read as scientific notation instead of East-West.  Caused east longitudes</span>
00013 <span class="comment"> *     to show up as negative longitudes.</span>
00014 <span class="comment"> *</span>
00015 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00016 <span class="comment"> *     Initial revision</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> */</span>
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment"> * site.c : Station parameter routines.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *$ 95Aug31 LDD Added "site_file" command to site_com()</span>
00025 <span class="comment"> *$ 95Sep01 LDD Added 2nd &amp; 3rd args to site_index()</span>
00026 <span class="comment"> *$ 95Oct19 LDD Explicitly declared return types for all functions.</span>
00027 <span class="comment"> *              Added function prototypes to site.h</span>
00028 <span class="comment"> */</span>
00029 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00030 <span class="preprocessor">#include &lt;string.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="kom_8h.html">kom.h</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="site_8h.html">site.h</a>&gt;</span>
00035 
00036 <span class="comment">/* Initialization constants</span>
00037 <span class="comment"> **************************/</span>
<a name="l00038"></a><a class="code" href="site_8c.html#a0">00038</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="site_8c.html#a0">initSite</a> = 0;
00039 
00040 <span class="comment">/* Changed from 1000 to 1800 by WMK 2/12/96 */</span>
<a name="l00041"></a><a class="code" href="site_8c.html#a1">00041</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="site_8c.html#a1">maxSite</a>  = 1800;     <span class="comment">/* Change to alter size of mem allocation */</span>
00042 
00043 
00044 <span class="comment">/**************************************************************************</span>
00045 <span class="comment"> * site_init()  Allocate the site table                                   *</span>
00046 <span class="comment"> **************************************************************************/</span>
<a name="l00047"></a><a class="code" href="site_8c.html#a2">00047</a> <span class="keywordtype">void</span> <a class="code" href="site_8c.html#a2">site_init</a>(<span class="keywordtype">void</span>)
00048 {
00049         <span class="keywordflow">if</span>(initSite)
00050                 <span class="keywordflow">return</span>;
00051         <a class="code" href="site_8c.html#a0">initSite</a> = 1;
00052         <a class="code" href="site_8h.html#a0">nSite</a> = 0;
00053         <a class="code" href="site_8h.html#a1">Site</a> = (<a class="code" href="structSITE.html">SITE</a> *)calloc(maxSite, <span class="keyword">sizeof</span>(<a class="code" href="structSITE.html">SITE</a>));
00054         <span class="keywordflow">if</span>(!<a class="code" href="site_8h.html#a1">Site</a>) {
00055                 fprintf(stderr, <span class="stringliteral">"site_init:  Could not allocate site table; exiting!\n"</span>);
00056                 exit(0);
00057         }
00058         <span class="keywordflow">return</span>;
00059 }
00060 
00061 
00062 <span class="comment">/**************************************************************************</span>
00063 <span class="comment"> * site_load(name)  Process a kom.c-style command file that contains only *</span>
00064 <span class="comment"> *                  commands recognized by site_com                       *</span>
00065 <span class="comment"> **************************************************************************/</span>
00066 
<a name="l00067"></a><a class="code" href="site_8c.html#a3">00067</a> <span class="keywordtype">int</span> <a class="code" href="site_8c.html#a3">site_load</a>(<span class="keywordtype">char</span> *name)
00068 {
00069         <span class="keywordtype">char</span> *<a class="code" href="kom_8c.html#a2">com</a>;
00070 
00071         <span class="keywordflow">if</span>(!<a class="code" href="kom_8c.html#a5">k_open</a>(name)) {
00072                 fprintf(stderr, <span class="stringliteral">"site_load:  Cannot open site file &lt;%s&gt;\n"</span>, name);
00073                 <span class="keywordflow">return</span> 0;
00074         }
00075         <span class="keywordflow">while</span>(<a class="code" href="kom_8c.html#a14">k_rd</a>()) {
00076                 <a class="code" href="kom_8c.html#a2">com</a> = <a class="code" href="kom_8c.html#a16">k_str</a>();
00077                 <span class="keywordflow">if</span> ( !<a class="code" href="kom_8c.html#a2">com</a> )       <span class="keywordflow">continue</span>;
00078                 <span class="keywordflow">if</span> ( <a class="code" href="site_8c.html#a5">site_com</a>() ) <span class="keywordflow">continue</span>;
00079                 fprintf(stderr, <span class="stringliteral">"site_load:  &lt;%s&gt; Unknown command\n"</span>, com);
00080         }
00081         <a class="code" href="kom_8c.html#a6">k_close</a>();
00082 <span class="comment">/*      fprintf(stderr, "Site file &lt;%s&gt; loaded, nSite = %d\n", name, nSite); */</span>
00083         <span class="keywordflow">return</span> 1;
00084 }
00085 
00086 
00087 <span class="comment">/**************************************************************************</span>
00088 <span class="comment"> *  site_read(name)  Read in a HYPOINVERSE format, universal station      *</span>
00089 <span class="comment"> *                   code file                                            *</span>
00090 <span class="comment"> **************************************************************************/</span>
00091 
00092 <span class="comment">/* Sample station line:</span>
00093 <span class="comment">R8075 MN  BHZ  41 10.1000N121 10.1000E   01.0     0.00  0.00  0.00  0.00 1  0.00</span>
00094 <span class="comment">0123456789 123456789 123456789 123456789 123456789 123456789 123456789 123456789 </span>
00095 <span class="comment">*/</span>
00096 
<a name="l00097"></a><a class="code" href="site_8c.html#a4">00097</a> <span class="keywordtype">void</span> <a class="code" href="site_8c.html#a4">site_read</a>(<span class="keywordtype">char</span> *name)
00098 {
00099         FILE  *stafile;
00100         <span class="keywordtype">char</span>   line[256];
00101         <span class="keywordtype">int</span>    dlat, dlon, elev;
00102         <span class="keywordtype">float</span>  mlat, mlon;
00103         <span class="keywordtype">char</span>   comp, ns, ew;
00104         <span class="keywordtype">int</span>    n;
00105 
00106 <span class="comment">/* initialize site table</span>
00107 <span class="comment">   *********************/</span>
00108         <a class="code" href="site_8c.html#a2">site_init</a>();
00109 
00110 <span class="comment">/* open station file</span>
00111 <span class="comment">   *****************/</span>
00112         <span class="keywordflow">if</span>( (stafile = fopen( name, <span class="stringliteral">"r"</span> )) == (FILE *) NULL ) {
00113                 fprintf(stderr,
00114                        <span class="stringliteral">"site_read: Cannot open site file &lt;%s&gt;; exiting!\n"</span>, name);
00115                 exit(0);
00116         }
00117 
00118 <span class="comment">/* read in one line of the site file at a time</span>
00119 <span class="comment">   *******************************************/</span>
00120         <span class="keywordflow">while</span>( fgets( line, <span class="keyword">sizeof</span>(line), stafile ) != (<span class="keywordtype">char</span> *) NULL )
00121         {
00122 
00123         <span class="comment">/* see if internal site table has room left */</span>
00124                 <span class="keywordflow">if</span>( <a class="code" href="site_8h.html#a0">nSite</a> &gt;= <a class="code" href="site_8c.html#a1">maxSite</a> ) {
00125                    fprintf( stderr,
00126                         <span class="stringliteral">"site_read: Site table full; cannot load entire file &lt;%s&gt;\n"</span>, name );
00127                    fprintf( stderr,
00128                         <span class="stringliteral">"site_read: Use &lt;maxsite&gt; command to increase table size; exiting!\n"</span> );
00129                    exit(0);
00130                 }
00131 
00132         <span class="comment">/* decode each line of the file */</span>
00133 
00134                 strncpy( Site[nSite].name, &amp;line[0],  5);
00135                 strncpy( Site[nSite].net,  &amp;line[6],  2);
00136                 strncpy( Site[nSite].comp, &amp;line[10], 3);
00137                 comp = line[9];
00138 
00139                 line[42] = <span class="charliteral">'\0'</span>;
00140                 n = sscanf( &amp;line[38], <span class="stringliteral">"%d"</span>, &amp;elev );
00141                 <span class="keywordflow">if</span>( n &lt; 1 ) {
00142                    fprintf( stderr,
00143                           <span class="stringliteral">"site_read: Error reading elevation from line in station file\n%s\n"</span>,
00144                            line );
00145                    <span class="keywordflow">continue</span>;
00146                 }
00147 
00148                 ew       = line[37];
00149                 line[37] = <span class="charliteral">'\0'</span>;
00150                 n = sscanf( &amp;line[26], <span class="stringliteral">"%d %f"</span>, &amp;dlon, &amp;mlon );
00151                 <span class="keywordflow">if</span>( n &lt; 2 ) {
00152                    fprintf( stderr,
00153                           <span class="stringliteral">"site_read: Error reading longitude from line in station file\n%s\n"</span>,
00154                            line );
00155                    <span class="keywordflow">continue</span>;
00156                 }
00157 
00158                 ns       = line[25];
00159                 line[25] = <span class="charliteral">'\0'</span>;
00160                 n = sscanf( &amp;line[15], <span class="stringliteral">"%d %f"</span>, &amp;dlat, &amp;mlat );
00161                 <span class="keywordflow">if</span> ( n &lt; 2 ) {
00162                    fprintf( stderr,
00163                           <span class="stringliteral">"site_read: Error reading latitude from line in station file\n%s\n"</span>,
00164                            line );
00165                    <span class="keywordflow">continue</span>;
00166                 }
00167 
00168         <span class="comment">/*      printf( "%-5s %-2s %-3s %d %.4f%c%d %.4f%c%4d\n",</span>
00169 <span class="comment">                         Site[nSite].name, Site[nSite].net, Site[nSite].comp,</span>
00170 <span class="comment">                         dlat, mlat, ns,</span>
00171 <span class="comment">                         dlon, mlon, ew, elev ); */</span> <span class="comment">/*DEBUG*/</span>
00172 
00173         <span class="comment">/* use one-letter component if there is no 3-letter component given */</span>
00174                 <span class="keywordflow">if</span> ( !strcmp(Site[nSite].comp, <span class="stringliteral">"   "</span>) ) sprintf( Site[nSite].comp, <span class="stringliteral">"%c  "</span>, comp );
00175 
00176         <span class="comment">/* convert to decimal degrees */</span>
00177                 <span class="keywordflow">if</span> ( dlat &lt; 0 ) dlat = -dlat;
00178                 <span class="keywordflow">if</span> ( dlon &lt; 0 ) dlon = -dlon;
00179                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lat = (double) dlat + (mlat/60.0);
00180                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lon = (double) dlon + (mlon/60.0);
00181 
00182         <span class="comment">/* make south-latitudes and west-longitudes negative */</span>
00183                 <span class="keywordflow">if</span> ( ns==<span class="charliteral">'s'</span> || ns==<span class="charliteral">'S'</span> )
00184                         <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lat = -<a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lat;
00185                 <span class="keywordflow">if</span> ( ew==<span class="charliteral">'w'</span> || ew==<span class="charliteral">'W'</span> || ew==<span class="charliteral">' '</span> )
00186                         <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lon = -<a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lon;
00187                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].elev = (double) elev/1000.;
00188 
00189         <span class="comment">/*      printf("%-5s %-2s %-3s %.4f %.4f %.0f\n\n",</span>
00190 <span class="comment">                       Site[nSite].name, Site[nSite].net, Site[nSite].comp,</span>
00191 <span class="comment">                       Site[nSite].lat, Site[nSite].lon, Site[nSite].elev ); */</span> <span class="comment">/*DEBUG*/</span>
00192 
00193        <span class="comment">/* update the total number of stations loaded */</span>
00194                 <span class="keywordflow">if</span>(<a class="code" href="site_8h.html#a0">nSite</a> &lt; <a class="code" href="site_8c.html#a1">maxSite</a>) ++<a class="code" href="site_8h.html#a0">nSite</a>;
00195 
00196         } <span class="comment">/*end while*/</span>
00197 
00198         fclose( stafile );
00199         <span class="keywordflow">return</span>;
00200 }
00201 
00202 
00203   <span class="comment">/**********************************************************************</span>
00204 <span class="comment">   * site_com(): Process all recognized commands.                       *</span>
00205 <span class="comment">   *             Return 1 on success, 0 if command was not recognized   *</span>
00206 <span class="comment">   **********************************************************************/</span>
00207 
<a name="l00208"></a><a class="code" href="site_8c.html#a5">00208</a> <span class="keywordtype">int</span> <a class="code" href="site_8c.html#a5">site_com</a>( <span class="keywordtype">void</span> )
00209 {
00210         <span class="keywordtype">char</span> *<a class="code" href="getutil_8c.html#a10">name</a>;
00211 
00212         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"site"</span>)) {
00213                 <a class="code" href="site_8c.html#a2">site_init</a>();
00214                 <span class="keywordflow">if</span>(<a class="code" href="site_8h.html#a0">nSite</a> &gt;= <a class="code" href="site_8c.html#a1">maxSite</a>)
00215                         <span class="keywordflow">return</span> 1;
00216                 <a class="code" href="getutil_8c.html#a10">name</a> = <a class="code" href="kom_8c.html#a16">k_str</a>();
00217                 <span class="keywordflow">if</span>(!<a class="code" href="getutil_8c.html#a10">name</a>) <span class="keywordflow">return</span> 1;
00218                 strcpy(Site[nSite].name, name);
00219                 strcpy(Site[nSite].net, <span class="stringliteral">""</span>);    <span class="comment">/*added 950901:ldd*/</span>
00220                 strcpy(Site[nSite].comp, <span class="stringliteral">""</span>);   <span class="comment">/*added 950901:ldd*/</span>
00221                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lat = <a class="code" href="kom_8c.html#a17">k_val</a>();
00222                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].lon = <a class="code" href="kom_8c.html#a17">k_val</a>();
00223                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].elev = 0.0;
00224                 <a class="code" href="site_8h.html#a1">Site</a>[<a class="code" href="site_8h.html#a0">nSite</a>].elev = <a class="code" href="kom_8c.html#a17">k_val</a>();
00225                 <span class="keywordflow">if</span>(<a class="code" href="site_8h.html#a0">nSite</a> &lt; <a class="code" href="site_8c.html#a1">maxSite</a>)
00226                         <a class="code" href="site_8h.html#a0">nSite</a>++;
00227                 <span class="keywordflow">return</span> 1;
00228         }
00229 
00230         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"maxsite"</span>)) {
00231                 <span class="keywordflow">if</span>(initSite) {
00232                      fprintf( stderr, <span class="stringliteral">"site_com:  Error: site table already allocated.\n"</span> );
00233                      fprintf( stderr,
00234                            <span class="stringliteral">"site_com:  Use &lt;maxsite&gt; before any &lt;site&gt; or &lt;site_file&gt; commands"</span> );
00235                      fprintf( stderr, <span class="stringliteral">"; exiting!\n"</span> );
00236                      exit( 0 );
00237                 }
00238                 <a class="code" href="site_8c.html#a1">maxSite</a> = <a class="code" href="kom_8c.html#a10">k_int</a>();
00239                 <span class="keywordflow">return</span> 1;
00240         }
00241 
00242         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"site_file"</span>)) {    <span class="comment">/* added command to read in a HYPOINVERSE format */</span>
00243                 <a class="code" href="getutil_8c.html#a10">name</a> = <a class="code" href="kom_8c.html#a16">k_str</a>();     <span class="comment">/* "universal code" station file.     950831:ldd */</span>
00244                 <span class="keywordflow">if</span>(!<a class="code" href="getutil_8c.html#a10">name</a>) <span class="keywordflow">return</span> 1;
00245                 <a class="code" href="site_8c.html#a4">site_read</a>(name);
00246                 <span class="keywordflow">return</span> 1;
00247         }
00248 
00249         <span class="keywordflow">return</span> 0;
00250 }
00251 
00252 
00253 <span class="comment">/***************************************************************************</span>
00254 <span class="comment"> * site_index(site, net, comp) : Returns index of site, or -1 if not found *</span>
00255 <span class="comment"> * 950901:ldd  added 2nd &amp; 3rd arguments to handle "universal" station     *</span>
00256 <span class="comment"> *             naming convention                                           *</span>
00257 <span class="comment"> ***************************************************************************/</span>
00258 
<a name="l00259"></a><a class="code" href="site_8c.html#a6">00259</a> <span class="keywordtype">int</span> <a class="code" href="site_8c.html#a6">site_index</a>(<span class="keywordtype">char</span> *site, <span class="keywordtype">char</span> *net, <span class="keywordtype">char</span> *comp)
00260 {
00261         <span class="keywordtype">int</span> i;
00262 
00263         <a class="code" href="site_8c.html#a2">site_init</a>();
00264         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="site_8h.html#a0">nSite</a>; i++) {
00265                 <span class="keywordflow">if</span>( !strcmp(Site[i].name, site ) &amp;&amp;
00266                     !strcmp(Site[i].net,  net  ) &amp;&amp;
00267                     !strcmp(Site[i].comp, comp )    )  <span class="keywordflow">return</span> i;
00268         }
00269         <span class="keywordflow">return</span> -1;
00270 }
00271 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:10 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
