<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>remote_copy.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>remote_copy.c</h1><a href="remote__copy_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: remote__copy_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00011 <span class="comment"> *     Initial revision</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> */</span>
00015 
00016 <span class="comment">/***************************************************************************</span>
00017 <span class="comment"> *                                remote_copy.c                            *</span>
00018 <span class="comment"> *                              Windows NT version                         *</span>
00019 <span class="comment"> *                                                                         *</span>
00020 <span class="comment"> *     Copies a file from local machine to a remote machine using rcp.     *</span>
00021 <span class="comment"> *                                                                         *</span>
00022 <span class="comment"> *  NOTE: This has been modified from the library version of copyfile !!!  *</span>
00023 <span class="comment"> *        The destination path is constructed externally and the file is   *</span>
00024 <span class="comment"> *        copied with  a name change following the copy.  The file names   *</span>
00025 <span class="comment"> *        are all given with directory paths to provide greater            *</span>
00026 <span class="comment"> *        versatility. This routine is used primarily to copy GIF and html *</span>
00027 <span class="comment"> *        files to webservers.                                             *</span>
00028 <span class="comment"> *************************************************************************** </span>
00029 <span class="comment"> *     For this function to work, make sure that the following files are   *</span>
00030 <span class="comment"> *     set up properly on the remote machine:                              *</span>
00031 <span class="comment"> *       /etc/hosts         must contain address and localhostname         *</span>
00032 <span class="comment"> *       /etc/hosts.equiv   must contain local_hostname                    *</span>
00033 <span class="comment"> *       .rhosts            in &lt;userid&gt;'s home directory must contain a    *</span>
00034 <span class="comment"> *                          line: local_hostname local_username            *</span>
00035 <span class="comment"> *                          describing who is running this program.        *</span>
00036 <span class="comment"> *                                                                         *</span>
00037 <span class="comment"> *                                                                         *</span>
00038 <span class="comment"> * fullname   full name of file to copy. /dir/filename                     *</span>
00039 <span class="comment"> * tname      temporary name of file to copy. /dir/filename                *</span>
00040 <span class="comment"> * fname      final name of file to copy. /dir/filename                    *</span>
00041 <span class="comment"> * host       remote machine to copy file to                               *</span>
00042 <span class="comment"> * userid     use this user name on remote machine                         *</span>
00043 <span class="comment"> * passwd     userid's password on remote machine (not needed by NT)       *</span>
00044 <span class="comment"> *                                                                         *</span>
00045 <span class="comment"> * errtxt     string to return error message in                            *</span>
00046 <span class="comment"> * mypid      external process id to preserve re-entrancy                  *</span>
00047 <span class="comment"> * mystat     external status variable to preserve re-entrancy             *</span>
00048 <span class="comment"> *                                                                         *</span>
00049 <span class="comment"> *     Also make sure that entries for the remote host are in the          *</span>
00050 <span class="comment"> *     local machine's \winnt\system32\drivers\etc\hosts file.             *</span>
00051 <span class="comment"> *                                                                         *</span>
00052 <span class="comment"> *     Returns 0 if all is ok                                              *</span>
00053 <span class="comment"> *             1 if error creating the child process                       *</span>
00054 <span class="comment"> *             2 if error waiting for the child process to complete        *</span>
00055 <span class="comment"> *             3 if the child process ended abnormally                     *</span>
00056 <span class="comment"> ***************************************************************************/</span>
00057 
00058 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00059 <span class="preprocessor">#include &lt;string.h&gt;</span>
00060 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00061 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00062 
00063 
<a name="l00064"></a><a class="code" href="remote__copy_8c.html#a0">00064</a> <span class="keywordtype">int</span> <a class="code" href="remote__copy_8c.html#a0">remote_copy</a>( <span class="keywordtype">char</span>  *fullname, <span class="comment">/* Name of /dir/file to copy               */</span>
00065                  <span class="keywordtype">char</span>  *tname,    <span class="comment">/* Temporary remote file name              */</span>
00066                  <span class="keywordtype">char</span>  *fname,    <span class="comment">/* Final remote file name                  */</span>
00067                  <span class="keywordtype">char</span>  *host,     <span class="comment">/* Remote machine to copy file to          */</span>
00068                  <span class="keywordtype">char</span>  *dir,      <span class="comment">/* Directory on remote machine             */</span>
00069                  <span class="keywordtype">char</span>  *userid,   <span class="comment">/* Use this user name on remote machine    */</span>
00070                  <span class="keywordtype">char</span>  *passwd,   <span class="comment">/* Userid's password on remote machine     */</span>
00071                  <span class="keywordtype">char</span>  *errtxt,   <span class="comment">/* String to return error message in       */</span>
00072                  pid_t *mypid,    <span class="comment">/* ext. process id to preserve re-entrancy */</span>
00073                  <span class="keywordtype">int</span>   *mystat )  <span class="comment">/* ext. status variable for re-entrancy    */</span>
00074 
00075 
00076 {
00077    <span class="keywordtype">char</span>        rcpPath[175];         <span class="comment">/* Copy the file to this path           */</span>
00078    <span class="keywordtype">char</span>        tmpName[100];         <span class="comment">/* Temporary file name                  */</span>
00079    <span class="keywordtype">char</span>        finalName[100];       <span class="comment">/* Final name for the copied file       */</span>
00080    <span class="keywordtype">char</span>        commandLine[100];     <span class="comment">/* Command that invokes the child proc  */</span>
00081    DWORD       display;
00082    BOOL        success;
00083    DWORD       priorityClass;
00084    DWORD       rc;
00085    DWORD       exitCode;
00086 
00087    STARTUPINFO         startUpInfo;
00088    PROCESS_INFORMATION procInfo;
00089 
00090 <span class="comment">/* Build temporary and final path names on the target system</span>
00091 <span class="comment">   *********************************************************/</span>
00092    sprintf( rcpPath,  <span class="stringliteral">"%s.%s:%s%s"</span>,  host, userid, dir, tname );
00093    sprintf( tmpName,  <span class="stringliteral">"%s%s"</span>,        dir, tname );
00094    sprintf( finalName, <span class="stringliteral">"%s%s"</span>,       dir, fname );
00095 
00096 <span class="comment">/* Retrieve the STARTUPINFOR structure for the current process.</span>
00097 <span class="comment">   Use this structure for the child processes.</span>
00098 <span class="comment">   ***********************************************************/</span>
00099    GetStartupInfo( &amp;startUpInfo );
00100 
00101 <span class="comment">/* Copy the file using rcp</span>
00102 <span class="comment">   ***********************/</span>
00103    display = 0;                                <span class="comment">/* Do not create a new console window */</span>
00104 
00105    priorityClass = GetPriorityClass( GetCurrentProcess() );
00106 
00107    sprintf( commandLine, <span class="stringliteral">"rcp %s %s"</span>, fullname, rcpPath );
00108 
00109    success = CreateProcess( 0,
00110                             commandLine,       <span class="comment">/* Command line to invoke child   */</span>
00111                             0, 0,              <span class="comment">/* No security attributes         */</span>
00112                             FALSE,             <span class="comment">/* No inherited handles           */</span>
00113                             display |          <span class="comment">/* Child does not get a window    */</span>
00114                             priorityClass,     <span class="comment">/* Same as priority of parent     */</span>
00115                             0,                 <span class="comment">/* Not passing environmental vars */</span>
00116                             0,                 <span class="comment">/* Current dir same as parent     */</span>
00117                             &amp;startUpInfo,      <span class="comment">/* Attributes of process window   */</span>
00118                             &amp;procInfo );       <span class="comment">/* Attributes of child process    */</span>
00119    <span class="keywordflow">if</span> ( !success ) {
00120       sprintf( errtxt, <span class="stringliteral">"Error starting the rcp command: %d"</span>, GetLastError() );
00121       <span class="keywordflow">return</span> 1;
00122    }
00123 
00124 <span class="comment">/* Wait 2 minutes for the remote copy to complete.</span>
00125 <span class="comment">   Check the process exit code for abnormal termination.</span>
00126 <span class="comment">   ****************************************************/</span>
00127    rc = WaitForSingleObject( procInfo.hProcess, 120000 );
00128 
00129    <span class="keywordflow">if</span> ( rc == WAIT_FAILED ) {
00130       sprintf( errtxt, <span class="stringliteral">"rcp WaitForSingleObject() failed with error: %d"</span>, GetLastError() );
00131       <span class="keywordflow">return</span> 2;
00132    }
00133    <span class="keywordflow">if</span> ( rc == WAIT_TIMEOUT ) {
00134       sprintf( errtxt, <span class="stringliteral">"Error. Remote copy not completed within 2 minutes."</span> );
00135       <span class="keywordflow">return</span> 2;
00136    }
00137    success = GetExitCodeProcess( procInfo.hProcess, &amp;exitCode );
00138    <span class="keywordflow">if</span> ( !success ) {
00139       sprintf( errtxt, <span class="stringliteral">"Error getting the rcp exit code: %d"</span>, GetLastError() );
00140       <span class="keywordflow">return</span> 3;
00141    }
00142    <span class="keywordflow">if</span> ( exitCode != 0 ) {
00143       strcpy( errtxt, <span class="stringliteral">"Remote copy failed."</span> );
00144       <span class="keywordflow">return</span> 3;
00145    }
00146 
00147 <span class="comment">/* Close the process and thread handles for rcp</span>
00148 <span class="comment">   ********************************************/</span>
00149    success = CloseHandle( procInfo.hProcess );
00150    <span class="keywordflow">if</span> ( !success ) {
00151       sprintf( errtxt, <span class="stringliteral">"Error closing the rcp process handle: %d"</span>, GetLastError() );
00152       <span class="keywordflow">return</span> 3;
00153    }
00154    success = CloseHandle( procInfo.hThread );
00155    <span class="keywordflow">if</span> ( !success ) {
00156       sprintf( errtxt, <span class="stringliteral">"Error closing the rcp thread handle: %d"</span>, GetLastError() );
00157       <span class="keywordflow">return</span> 3;
00158    }
00159 
00160 <span class="comment">/* Rename the remote file using rsh</span>
00161 <span class="comment">   ********************************/</span>
00162    sprintf( commandLine, <span class="stringliteral">"rsh %s -l %s /usr/bin/mv %s %s"</span>,
00163                           host, userid, tmpName, finalName );
00164 
00165    success = CreateProcess( 0,
00166                             commandLine,       <span class="comment">/* Command line to invoke child   */</span>
00167                             0, 0,              <span class="comment">/* No security attributes         */</span>
00168                             FALSE,             <span class="comment">/* No inherited handles           */</span>
00169                             display |          <span class="comment">/* Child does not get a window    */</span>
00170                             priorityClass,     <span class="comment">/* Same as priority of parent     */</span>
00171                             0,                 <span class="comment">/* Not passing environmental vars */</span>
00172                             0,                 <span class="comment">/* Current dir same as parent     */</span>
00173                             &amp;startUpInfo,      <span class="comment">/* Attributes of process window   */</span>
00174                             &amp;procInfo );       <span class="comment">/* Attributes of child process    */</span>
00175    <span class="keywordflow">if</span> ( !success ) {
00176       sprintf( errtxt, <span class="stringliteral">"Error starting the rsh command: %d"</span>, GetLastError() );
00177       <span class="keywordflow">return</span> 1;
00178    }
00179 
00180 <span class="comment">/* Wait 2 minutes for the remote move command to complete.</span>
00181 <span class="comment">   Check the process exit code for abnormal termination.</span>
00182 <span class="comment">   ******************************************************/</span>
00183    rc = WaitForSingleObject( procInfo.hProcess, 120000 );
00184 
00185    <span class="keywordflow">if</span> ( rc == WAIT_FAILED ) {
00186       sprintf( errtxt, <span class="stringliteral">"rsh WaitForSingleObject() failed with error: %d"</span>, GetLastError() );
00187       <span class="keywordflow">return</span> 2;
00188    }
00189    <span class="keywordflow">if</span> ( rc == WAIT_TIMEOUT ) {
00190       sprintf( errtxt, <span class="stringliteral">"Error. Remote mv command not completed within 2 minutes."</span> );
00191       <span class="keywordflow">return</span> 2;
00192    }
00193    success = GetExitCodeProcess( procInfo.hProcess, &amp;exitCode );
00194    <span class="keywordflow">if</span> ( !success ) {
00195       sprintf( errtxt, <span class="stringliteral">"Error getting the rsh exit code: %d"</span>, GetLastError() );
00196       <span class="keywordflow">return</span> 3;
00197    }
00198    <span class="keywordflow">if</span> ( exitCode != 0 ) {
00199       strcpy( errtxt, <span class="stringliteral">"Remote mv command failed."</span> );
00200       <span class="keywordflow">return</span> 3;
00201    }
00202 
00203 <span class="comment">/* Close the process and thread handles for rsh</span>
00204 <span class="comment">   ********************************************/</span>
00205    success = CloseHandle( procInfo.hProcess );
00206    <span class="keywordflow">if</span> ( !success ) {
00207       sprintf( errtxt, <span class="stringliteral">"Error closing the rsh process handle: %d"</span>, GetLastError() );
00208       <span class="keywordflow">return</span> 3;
00209    }
00210    success = CloseHandle( procInfo.hThread );
00211    <span class="keywordflow">if</span> ( !success ) {
00212       sprintf( errtxt, <span class="stringliteral">"Error closing the rsh thread handle: %d"</span>, GetLastError() );
00213       <span class="keywordflow">return</span> 3;
00214    }
00215 
00216 <span class="comment">/* Everything went smoothly</span>
00217 <span class="comment">   ************************/</span>
00218    <span class="keywordflow">return</span> 0;
00219 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:07 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
