<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>copyfile.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>copyfile.c</h1><a href="copyfile_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: copyfile_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:01  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00011 <span class="comment"> *     Initial revision</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> */</span>
00015 
00016    <span class="comment">/***********************************************************************</span>
00017 <span class="comment">    *                               copyfile.c                            *</span>
00018 <span class="comment">    *                           Windows NT version                        *</span>
00019 <span class="comment">    *                                                                     *</span>
00020 <span class="comment">    *  Copies a file from local machine to a remote machine using rcp.    *</span>
00021 <span class="comment">    *                                                                     *</span>
00022 <span class="comment">    *  For this function to work, make sure that the following files are  *</span>
00023 <span class="comment">    *  set up properly on the remote machine:                             *</span>
00024 <span class="comment">    *    /etc/hosts         must contain address and localhostname        *</span>
00025 <span class="comment">    *    /etc/hosts.equiv   must contain local_hostname                   *</span>
00026 <span class="comment">    *    .rhosts            in &lt;userid&gt;'s home directory must contain a   *</span>
00027 <span class="comment">    *                       line: local_hostname local_username           *</span>
00028 <span class="comment">    *                       describing who is running this program.       *</span>
00029 <span class="comment">    *                                                                     *</span>
00030 <span class="comment">    *  Also make sure that entries for the remote host are in the         *</span>
00031 <span class="comment">    *  local machine's \winnt\system32\drivers\etc\hosts file.            *</span>
00032 <span class="comment">    *                                                                     *</span>
00033 <span class="comment">    *  Returns 0 if all is ok                                             *</span>
00034 <span class="comment">    *          1 if error creating the child process                      *</span>
00035 <span class="comment">    *          2 if error waiting for the child process to complete       *</span>
00036 <span class="comment">    *          3 if the child process ended abnormally                    *</span>
00037 <span class="comment">    ***********************************************************************/</span>
00038 
00039 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00040 <span class="preprocessor">#include &lt;string.h&gt;</span>
00041 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00043 
00044 
<a name="l00045"></a><a class="code" href="copyfile_8c.html#a0">00045</a> <span class="keywordtype">int</span> <a class="code" href="copyfile_8c.html#a0">copyfile</a>( <span class="keywordtype">char</span> *fname,         <span class="comment">/* Name of file to copy                 */</span>
00046               <span class="keywordtype">char</span> *tname,         <span class="comment">/* Temporary remote file name           */</span>
00047               <span class="keywordtype">char</span> *host,          <span class="comment">/* Remote machine to copy file to       */</span>
00048               <span class="keywordtype">char</span> *dir,           <span class="comment">/* Directory on remote machine          */</span>
00049               <span class="keywordtype">char</span> *userid,        <span class="comment">/* Use this user name on remote machine */</span>
00050               <span class="keywordtype">char</span> *passwd,        <span class="comment">/* Userid's password on remote machine  */</span>
00051               <span class="keywordtype">char</span> *errtxt )       <span class="comment">/* String to return error message in    */</span>
00052 
00053 
00054 {
00055    <span class="keywordtype">char</span>        rcpPath[175];       <span class="comment">/* Copy the file to this path           */</span>
00056    <span class="keywordtype">char</span>        tmpName[100];       <span class="comment">/* Temporary file name                  */</span>
00057    <span class="keywordtype">char</span>        finalName[100];     <span class="comment">/* Final name for the copied file       */</span>
00058    <span class="keywordtype">char</span>        commandLine[100];   <span class="comment">/* Command that invokes the child proc  */</span>
00059    DWORD       display;
00060    BOOL        success;
00061    DWORD       priorityClass;
00062    DWORD       rc;
00063    DWORD       exitCode;
00064 
00065    STARTUPINFO         startUpInfo;
00066    PROCESS_INFORMATION procInfo;
00067 
00068 <span class="comment">/* Build temporary and final path names on the target system</span>
00069 <span class="comment">   *********************************************************/</span>
00070    <span class="keywordflow">if</span> ( dir[strlen(dir)-1] == <span class="charliteral">'/'</span> )
00071    {
00072       sprintf( rcpPath,  <span class="stringliteral">"%s.%s:%s%s"</span>,  host, userid, dir, tname );
00073       sprintf( tmpName,  <span class="stringliteral">"%s%s"</span>,        dir, tname );
00074       sprintf( finalName, <span class="stringliteral">"%s%s"</span>,       dir, fname );
00075    }
00076    <span class="keywordflow">else</span>
00077    {
00078       sprintf( rcpPath,  <span class="stringliteral">"%s.%s:%s/%s"</span>, host, userid, dir, tname );
00079       sprintf( tmpName,  <span class="stringliteral">"%s/%s"</span>,       dir, tname );
00080       sprintf( finalName, <span class="stringliteral">"%s/%s"</span>,      dir, fname );
00081    }
00082 
00083 <span class="comment">/* Retrieve the STARTUPINFOR structure for the current process.</span>
00084 <span class="comment">   Use this structure for the child processes.</span>
00085 <span class="comment">   ***********************************************************/</span>
00086    GetStartupInfo( &amp;startUpInfo );
00087 
00088 <span class="comment">/* Copy the file using rcp</span>
00089 <span class="comment">   ***********************/</span>
00090    display = 0;                                <span class="comment">/* Do not create a new console window */</span>
00091 
00092    priorityClass = GetPriorityClass( GetCurrentProcess() );
00093 
00094    sprintf( commandLine, <span class="stringliteral">"rcp %s %s"</span>, fname, rcpPath );
00095 
00096    success = CreateProcess( 0,
00097                             commandLine,             <span class="comment">/* Command line to invoke child */</span>
00098                             0, 0,                          <span class="comment">/* No security attributes */</span>
00099                             FALSE,                           <span class="comment">/* No inherited handles */</span>
00100                             display |                 <span class="comment">/* Child does not get a window */</span>
00101                             priorityClass,             <span class="comment">/* Same as priority of parent */</span>
00102                             0,                     <span class="comment">/* Not passing environmental vars */</span>
00103                             0,                         <span class="comment">/* Current dir same as parent */</span>
00104                             &amp;startUpInfo,            <span class="comment">/* Attributes of process window */</span>
00105                             &amp;procInfo );              <span class="comment">/* Attributes of child process */</span>
00106    <span class="keywordflow">if</span> ( !success )
00107    {
00108       sprintf( errtxt, <span class="stringliteral">"Error starting the rcp command: %d"</span>, GetLastError() );
00109       <span class="keywordflow">return</span> 1;
00110    }
00111 
00112 <span class="comment">/* Wait 2 minutes for the remote copy to complete.</span>
00113 <span class="comment">   Check the process exit code for abnormal termination.</span>
00114 <span class="comment">   ****************************************************/</span>
00115    rc = WaitForSingleObject( procInfo.hProcess, 120000 );
00116 
00117    <span class="keywordflow">if</span> ( rc == WAIT_FAILED )
00118    {
00119       sprintf( errtxt, <span class="stringliteral">"rcp WaitForSingleObject() failed with error: %d"</span>, GetLastError() );
00120       <span class="keywordflow">return</span> 2;
00121    }
00122    <span class="keywordflow">if</span> ( rc == WAIT_TIMEOUT )
00123    {
00124       sprintf( errtxt, <span class="stringliteral">"Error. Remote copy not completed within 2 minutes."</span> );
00125       <span class="keywordflow">return</span> 2;
00126    }
00127    success = GetExitCodeProcess( procInfo.hProcess, &amp;exitCode );
00128    <span class="keywordflow">if</span> ( !success )
00129    {
00130       sprintf( errtxt, <span class="stringliteral">"Error getting the rcp exit code: %d"</span>, GetLastError() );
00131       <span class="keywordflow">return</span> 3;
00132    }
00133    <span class="keywordflow">if</span> ( exitCode != 0 )
00134    {
00135       strcpy( errtxt, <span class="stringliteral">"Remote copy failed."</span> );
00136       <span class="keywordflow">return</span> 3;
00137    }
00138 
00139 <span class="comment">/* Close the process and thread handles for rcp</span>
00140 <span class="comment">   ********************************************/</span>
00141    success = CloseHandle( procInfo.hProcess );
00142    <span class="keywordflow">if</span> ( !success )
00143    {
00144       sprintf( errtxt, <span class="stringliteral">"Error closing the rcp process handle: %d"</span>, GetLastError() );
00145       <span class="keywordflow">return</span> 3;
00146    }
00147    success = CloseHandle( procInfo.hThread );
00148    <span class="keywordflow">if</span> ( !success )
00149    {
00150       sprintf( errtxt, <span class="stringliteral">"Error closing the rcp thread handle: %d"</span>, GetLastError() );
00151       <span class="keywordflow">return</span> 3;
00152    }
00153 
00154 <span class="comment">/* Rename the remote file using rsh</span>
00155 <span class="comment">   ********************************/</span>
00156    sprintf( commandLine, <span class="stringliteral">"rsh %s -l %s /usr/bin/mv %s %s"</span>,
00157                           host, userid, tmpName, finalName );
00158 
00159    success = CreateProcess( 0,
00160                             commandLine,             <span class="comment">/* Command line to invoke child */</span>
00161                             0, 0,                          <span class="comment">/* No security attributes */</span>
00162                             FALSE,                           <span class="comment">/* No inherited handles */</span>
00163                             display |                 <span class="comment">/* Child does not get a window */</span>
00164                             priorityClass,             <span class="comment">/* Same as priority of parent */</span>
00165                             0,                     <span class="comment">/* Not passing environmental vars */</span>
00166                             0,                         <span class="comment">/* Current dir same as parent */</span>
00167                             &amp;startUpInfo,            <span class="comment">/* Attributes of process window */</span>
00168                             &amp;procInfo );              <span class="comment">/* Attributes of child process */</span>
00169    <span class="keywordflow">if</span> ( !success )
00170    {
00171       sprintf( errtxt, <span class="stringliteral">"Error starting the rsh command: %d"</span>, GetLastError() );
00172       <span class="keywordflow">return</span> 1;
00173    }
00174 
00175 <span class="comment">/* Wait 2 minutes for the remote move command to complete.</span>
00176 <span class="comment">   Check the process exit code for abnormal termination.</span>
00177 <span class="comment">   ******************************************************/</span>
00178    rc = WaitForSingleObject( procInfo.hProcess, 120000 );
00179 
00180    <span class="keywordflow">if</span> ( rc == WAIT_FAILED )
00181    {
00182       sprintf( errtxt, <span class="stringliteral">"rsh WaitForSingleObject() failed with error: %d"</span>, GetLastError() );
00183       <span class="keywordflow">return</span> 2;
00184    }
00185    <span class="keywordflow">if</span> ( rc == WAIT_TIMEOUT )
00186    {
00187       sprintf( errtxt, <span class="stringliteral">"Error. Remote mv command not completed within 2 minutes."</span> );
00188       <span class="keywordflow">return</span> 2;
00189    }
00190    success = GetExitCodeProcess( procInfo.hProcess, &amp;exitCode );
00191    <span class="keywordflow">if</span> ( !success )
00192    {
00193       sprintf( errtxt, <span class="stringliteral">"Error getting the rsh exit code: %d"</span>, GetLastError() );
00194       <span class="keywordflow">return</span> 3;
00195    }
00196    <span class="keywordflow">if</span> ( exitCode != 0 )
00197    {
00198       strcpy( errtxt, <span class="stringliteral">"Remote mv command failed."</span> );
00199       <span class="keywordflow">return</span> 3;
00200    }
00201 
00202 <span class="comment">/* Close the process and thread handles for rsh</span>
00203 <span class="comment">   ********************************************/</span>
00204    success = CloseHandle( procInfo.hProcess );
00205    <span class="keywordflow">if</span> ( !success )
00206    {
00207       sprintf( errtxt, <span class="stringliteral">"Error closing the rsh process handle: %d"</span>, GetLastError() );
00208       <span class="keywordflow">return</span> 3;
00209    }
00210    success = CloseHandle( procInfo.hThread );
00211    <span class="keywordflow">if</span> ( !success )
00212    {
00213       sprintf( errtxt, <span class="stringliteral">"Error closing the rsh thread handle: %d"</span>, GetLastError() );
00214       <span class="keywordflow">return</span> 3;
00215    }
00216 
00217 <span class="comment">/* Everything went smoothly</span>
00218 <span class="comment">   ************************/</span>
00219    <span class="keywordflow">return</span> 0;
00220 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:00 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
