<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>logit.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>logit.c</h1><a href="logit_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: logit_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.9  2001/09/24 21:51:38  patton</span>
00011 <span class="comment"> *     Added capability to change logging</span>
00012 <span class="comment"> *     level by calling logit_init again.</span>
00013 <span class="comment"> *     Part of the logit changeover.</span>
00014 <span class="comment"> *     JMP 9/24/2001</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *     Revision 1.8  2001/08/21 00:23:55  patton</span>
00017 <span class="comment"> *     Modified the logfile name to match the new format:</span>
00018 <span class="comment"> *     program_name_date.log.  Also removed the need for mid</span>
00019 <span class="comment"> *     in logit_init, but left it in the call for backwards</span>
00020 <span class="comment"> *     compatibility reasons.  JMP 8/20/2001.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> *     Revision 1.7  2000/07/08 19:11:42  lombard</span>
00023 <span class="comment"> *     Added value 2 to logflag argument of logit_init(), to turn off globally</span>
00024 <span class="comment"> *     logging to standard error and standard output.</span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> *     Revision 1.6  2000/06/21 16:32:29  lucky</span>
00027 <span class="comment"> *     Added html_logit: same as logit but it is suitable for routines that produce html.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *     Revision 1.5  2000/06/02 21:57:51  davidk</span>
00030 <span class="comment"> *     Added logit to prevent "Message too long" errors from being logged to</span>
00031 <span class="comment"> *     stderr more than once.  This should allow notification, but prevent</span>
00032 <span class="comment"> *     stderr from being flooded with messages and becoming unreadable.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> *     Revision 1.4  2000/06/02 21:40:39  davidk</span>
00035 <span class="comment"> *     added code to check for buffer overflow in logit().  Used vsnprintf()</span>
00036 <span class="comment"> *     to fill the buffer without overflowing it.  Had to add a line to the</span>
00037 <span class="comment"> *     WINNT portion of platform.h in order to get vsnprintf() to work for NT.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> *     Revision 1.3  2000/06/01 00:36:10  dietz</span>
00040 <span class="comment"> *     logit_init: moved CreateSpecificMutex earlier in the function so that it's</span>
00041 <span class="comment"> *     always created regardless of the log/nolog switch value.</span>
00042 <span class="comment"> *</span>
00043 <span class="comment"> *     Revision 1.2  2000/03/13 23:22:09  davidk</span>
00044 <span class="comment"> *     modified the LOGIT_MT ifdef so that the entire logit() function is executed as</span>
00045 <span class="comment"> *     a single critical section (mutex protected).  This was done to fix a problem</span>
00046 <span class="comment"> *     experienced on a Dual-Processor Ultra 60 running ew5-getlist, where one thread</span>
00047 <span class="comment"> *     was overwriting the logit buffer of another thread before the original thread</span>
00048 <span class="comment"> *     could write the buffer out to file.</span>
00049 <span class="comment"> *</span>
00050 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00051 <span class="comment"> *     Initial revision</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> */</span>
00055 
00056 
00057      <span class="comment">/*************************************************************</span>
00058 <span class="comment">      *                          logit.c                          *</span>
00059 <span class="comment">      *                                                           *</span>
00060 <span class="comment">      *            Functions for maintaining log files.           *</span>
00061 <span class="comment">      *                                                           *</span>
00062 <span class="comment">      *        First, call logit_init.  Then, call logit.         *</span>
00063 <span class="comment">      *                                                           *</span>
00064 <span class="comment">      *  If the environmental variable _LOGITMT is defined,       *</span>
00065 <span class="comment">      *  the resulting object file will be MT-safe.               *</span>
00066 <span class="comment">      *                                                           *</span>
00067 <span class="comment">      *  If _LOGITMT is not defined, the program must link to     *</span>
00068 <span class="comment">      *  time_ew.o.                                               *</span>
00069 <span class="comment">      *                                                           *</span>
00070 <span class="comment">      *  If _LOGITMT is defined, the program must link to         *</span>
00071 <span class="comment">      *  time_ew.o and sema_ew.o.                                 *</span>
00072 <span class="comment">      *                                                           *</span>
00073 <span class="comment">      *  In Solaris, the program must also link to the posix      *</span>
00074 <span class="comment">      *  library (-lposix4)                                       *</span>
00075 <span class="comment">      *                                                           *</span>
00076 <span class="comment">      *************************************************************/</span>
00077 <span class="comment">/*</span>
00078 <span class="comment"> * 8/17/2001 Changed log file names to the format: programname_date.log.</span>
00079 <span class="comment"> * Also modified logitinit so that the mid is not used.  Mid was left</span>
00080 <span class="comment"> * in the call however, for backwards compatibility purposes.</span>
00081 <span class="comment"> * John Patton</span>
00082 <span class="comment"> *</span>
00083 <span class="comment"> * 7/7/99 Removed 2 lines "res.tm_year %= 100" which were causing</span>
00084 <span class="comment"> *   years 2000+ to be printed as 1900+.  Lynn Dietz</span>
00085 <span class="comment"> *</span>
00086 <span class="comment"> * Changed lines 69-73 to allow logit to work under the Solaris Workshop</span>
00087 <span class="comment"> * debugger: Pete Lombard, 8/5/98</span>
00088 <span class="comment"> *</span>
00089 <span class="comment"> * Mon Oct 26 14:22:09 MST 1998 lucky</span>
00090 <span class="comment"> *  Created a new routine get_prog_name which extracts the</span>
00091 <span class="comment"> *  name of the program by truncating the path to it as well as</span>
00092 <span class="comment"> *  any extensions</span>
00093 <span class="comment"> *</span>
00094 <span class="comment"> * Mon Oct 26 15:15:12 MST 1998 lucky</span>
00095 <span class="comment"> *  Y2K compliance:</span>
00096 <span class="comment"> *    - use 4 digits for years in file names</span>
00097 <span class="comment"> *    - use 4 digits for years in status messages</span>
00098 <span class="comment"> *</span>
00099 <span class="comment"> * Wed Oct 28 16:19:45 MST 1998 lucky</span>
00100 <span class="comment"> *  Added the YYYYMMDD date filed to the log message that</span>
00101 <span class="comment"> *  are being produced. New format is now:</span>
00102 <span class="comment"> *</span>
00103 <span class="comment"> *      YYYYMMDD_UTC_HH:MM:SS</span>
00104 <span class="comment"> *</span>
00105 <span class="comment"> * 19990217 DavidK </span>
00106 <span class="comment"> *  Increased the lengths of logName, logpath, and Template to allow for</span>
00107 <span class="comment"> *   longer logfile names, based on config file names.  Longest progname</span>
00108 <span class="comment"> *   accepted should now be 58, with a max path length of 127</span>
00109 <span class="comment"> *  Removed or atleast placed in and "#if EW_DEBUG" section code to</span>
00110 <span class="comment"> *   print to stderr a message that says logit_init() opened the logfile.</span>
00111 <span class="comment"> *  Changed the 2-digit year to a 4-digit year in the date printout in</span>
00112 <span class="comment"> *  the logfile.</span>
00113 <span class="comment"> */</span>
00114 
00115 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00116 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00117 <span class="preprocessor">#include &lt;string.h&gt;</span>
00118 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00119 <span class="preprocessor">#include &lt;time.h&gt;</span>
00120 <span class="preprocessor">#include &lt;<a class="code" href="time__ew_8h.html">time_ew.h</a>&gt;</span>
00121 
00122 
00123 <span class="preprocessor">#ifndef EARTHWORM_H</span>
00124 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00125 <span class="preprocessor">#endif</span>
00126 <span class="preprocessor"></span>
00127 <span class="comment">/* 020625 dbh -- added this to compile in C++ */</span>
00128 <span class="preprocessor">#ifdef __BORLANDC__</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#ifdef getpid</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#undef getpid</span>
00131 <span class="preprocessor"></span><span class="comment">//extern "C" int getpid();</span>
00132 <span class="preprocessor">#include &lt;process.h&gt;</span>  <span class="comment">// getpid()</span>
00133 <span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00135 <span class="preprocessor"></span>
00136 
<a name="l00137"></a><a class="code" href="logit_8c.html#a0">00137</a> <span class="preprocessor">#define         DATE_LEN                10   </span>
<a name="l00139"></a><a class="code" href="logit_8c.html#a1">00139</a> <span class="preprocessor">static FILE   *fp = NULL;</span>
<a name="l00140"></a><a class="code" href="logit_8c.html#a2">00140</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span>   <a class="code" href="logit_8c.html#a2">date</a>[<a class="code" href="logit_8c.html#a0">DATE_LEN</a>];
<a name="l00141"></a><a class="code" href="logit_8c.html#a3">00141</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   <a class="code" href="logit_8c.html#a3">date_prev</a>[<a class="code" href="logit_8c.html#a0">DATE_LEN</a>];
<a name="l00142"></a><a class="code" href="logit_8c.html#a4">00142</a> <span class="keyword">static</span> time_t <a class="code" href="logit_8c.html#a4">now</a>;
<a name="l00143"></a><a class="code" href="logit_8c.html#a5">00143</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   <a class="code" href="logit_8c.html#a5">logName</a>[256]; <span class="comment">/* Increased 19990217 DK */</span>
<a name="l00144"></a><a class="code" href="logit_8c.html#a6">00144</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   <a class="code" href="logit_8c.html#a6">logpath</a>[128]; <span class="comment">/* Increased 19990217 DK */</span>
<a name="l00145"></a><a class="code" href="logit_8c.html#a7">00145</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   <span class="keyword">template</span>[64]; <span class="comment">/* Increased 19990217 DK */</span>
<a name="l00146"></a><a class="code" href="logit_8c.html#a8">00146</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   <a class="code" href="logit_8c.html#a8">extension</a>[12]; <span class="comment">/* JMP ADDED, for .log extension */</span>
<a name="l00147"></a><a class="code" href="logit_8c.html#a9">00147</a> <span class="keyword">static</span> <span class="keywordtype">char</span>   *<a class="code" href="logit_8c.html#a9">buf</a>;
<a name="l00148"></a><a class="code" href="logit_8c.html#a10">00148</a> <span class="keyword">static</span> <span class="keyword">struct </span>tm <a class="code" href="logit_8c.html#a10">res</a>;
<a name="l00149"></a><a class="code" href="logit_8c.html#a11">00149</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a11">init</a>  = 0;           <span class="comment">/* 1 if logit_init has been called */</span>
<a name="l00150"></a><a class="code" href="logit_8c.html#a12">00150</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a12">disk</a>  = 1;           <span class="comment">/* 1 if output goes to disk file   */</span>
<a name="l00151"></a><a class="code" href="logit_8c.html#a13">00151</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a13">soe</a>   = 1;           <span class="comment">/* 1 of output goes to stdout/stderr */</span>
<a name="l00152"></a><a class="code" href="logit_8c.html#a14">00152</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a14">pid</a>;
00153 
00154 <span class="comment">/* DK 2000/06/02  Added logbuffersize variable to track </span>
00155 <span class="comment">   the size of the allocated logit buffer. </span>
00156 <span class="comment">*******************************************************/</span>
<a name="l00157"></a><a class="code" href="logit_8c.html#a15">00157</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a15">logbuffersize</a>;
00158 
00159 <span class="comment">/* DK 2000/06/02  Added bErrorIssuedToStderr variable to </span>
00160 <span class="comment">   prevent the overloading of stderr with </span>
00161 <span class="comment">   "Message Too Long" error messages.</span>
00162 <span class="comment">*******************************************************/</span>
<a name="l00163"></a><a class="code" href="logit_8c.html#a16">00163</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>=0;
00164 
00165 <span class="preprocessor">#ifdef _LOGITMT</span>
00166 <span class="preprocessor"></span><span class="keyword">static</span> mutex_t mutsem;
00167 <span class="preprocessor">#endif</span>
00168 <span class="preprocessor"></span>
00169 
00170    <span class="comment">/*************************************************************************</span>
00171 <span class="comment">    *                             logit_init                                *</span>
00172 <span class="comment">    *                                                                       *</span>
00173 <span class="comment">    *      Call this function once before the other logit routines.         *</span>
00174 <span class="comment">    *                                                                       *</span>
00175 <span class="comment">    *   prog    : Name of the calling program (argv[0] to main()).          *</span>
00176 <span class="comment">    *             On OS2, prog has the suffix ".exe"                        *</span>
00177 <span class="comment">    *                                                                       *</span>
00178 <span class="comment">    *   mid     : Module id number of the calling program.  NOTE: No        *</span>
00179 <span class="comment">        *             longer used but left in the call for backwards            *</span>
00180 <span class="comment">        *             compatiblity.                                             *</span>
00181 <span class="comment">    *                                                                       *</span>
00182 <span class="comment">    *   bufSize : Size of buffer to be allocated by logit_init.             *</span>
00183 <span class="comment">    *             This buffer must be large enough to accomodate the        *</span>
00184 <span class="comment">    *             largest log message to be written.                        *</span>
00185 <span class="comment">    *             11/13/1998, DavidK, added the ability to write the        *</span>
00186 <span class="comment">    *             process id, to the logit message, which would extend      *</span>
00187 <span class="comment">    *             a message by up to 6 chars.  So messages that were        *</span>
00188 <span class="comment">    *             borderline length before, will now be too long, if the    *</span>
00189 <span class="comment">    *             pid is included.                                          *</span>
00190 <span class="comment">    *                                                                       *</span>
00191 <span class="comment">    *   logflag : Switch to turn disk-file and stderr/stdout logging        *</span>
00192 <span class="comment">    *             on or off globally.                                       *</span>
00193 <span class="comment">    *                                                                       *</span>
00194 <span class="comment">        *   If logit_init is called again, it will set the output flags         *</span>
00195 <span class="comment">        *   according to the new value in logflag.                              *</span>
00196 <span class="comment">    *************************************************************************/</span>
00197 
<a name="l00198"></a><a class="code" href="logit_8c.html#a17">00198</a> <span class="keywordtype">void</span> <a class="code" href="logit_8c.html#a17">logit_init</a>( <span class="keywordtype">char</span> *prog, <span class="keywordtype">short</span> mid, <span class="keywordtype">int</span> bufSize, <span class="keywordtype">int</span> logflag )
00199 {
00200    <span class="keywordtype">char</span> *str;
00201    <span class="keywordtype">char</span> progName[50];
00202 
00203 <span class="comment">/* Set time zone using the TZ environmental variable.</span>
00204 <span class="comment">   This is not required under Solaris.</span>
00205 <span class="comment">   In OS2 v2 or v3.0, use _tzset().</span>
00206 <span class="comment">   In OS2 v3.0, use tzset().</span>
00207 <span class="comment">   *************************************************/</span>
00208 <span class="preprocessor">#if defined(_OS2) || defined(_WINNT)</span>
00209 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( getenv( <span class="stringliteral">"TZ"</span> ) != NULL ) _tzset();
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>
00212 <span class="comment">/* Truncate in front of and including "/", everything beyond and</span>
00213 <span class="comment">   including "." in the program name</span>
00214 <span class="comment">   *********************************/</span>
00215    <span class="keywordflow">if</span> (<a class="code" href="logit_8c.html#a19">get_prog_name</a> (prog, progName) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00216    {
00217       fprintf( stderr, <span class="stringliteral">"Call to get_prog_name failed.\n"</span>);
00218       <span class="keywordflow">return</span>;
00219    }
00220 
00221 <span class="comment">/* Set Disk logging to new level</span>
00222 <span class="comment">   (assumes that logit_init has </span>
00223 <span class="comment">   allready been called once)</span>
00224 <span class="comment">   JMP 9/5/2001</span>
00225 <span class="comment">   *******************************/</span>
00226 
00227 <span class="comment">/* Check init flag, if we have been</span>
00228 <span class="comment">   already called, just reset the </span>
00229 <span class="comment">   logflag to the new value, and</span>
00230 <span class="comment">   return. JMP 9-18-2001</span>
00231 <span class="comment">   *********************************/</span>
00232    <span class="keywordflow">if</span> ( init )
00233    {
00234      <span class="comment">/* Check the disk log/nolog switch</span>
00235 <span class="comment">     ***********************************/</span>
00236      <span class="keywordflow">if</span> ( logflag == 0 )
00237        {
00238          <a class="code" href="logit_8c.html#a12">disk</a> = 0;
00239          <span class="keywordflow">if</span> ( <a class="code" href="logit_8c.html#a1">fp</a> != NULL )
00240          {
00241            fclose( fp );
00242          }
00243          <span class="keywordflow">return</span>;
00244        }
00245 
00246      <span class="comment">/* check the SOE log/nolog switch */</span>
00247      <span class="keywordflow">if</span> (logflag == 2)
00248        <a class="code" href="logit_8c.html#a13">soe</a> = 0;
00249     <span class="keywordflow">return</span>;      
00250    }
00251    <a class="code" href="logit_8c.html#a11">init</a> = 1;
00252 
00253    <span class="comment">/* DK 2000/06/02  copy the desired logit buffer size </span>
00254 <span class="comment">      into the static "logbuffersize" variable.</span>
00255 <span class="comment">   *******************************************************/</span>
00256    <span class="comment">/* copy bufSize into the "logbuffersize" static variable */</span>
00257    <a class="code" href="logit_8c.html#a15">logbuffersize</a>=bufSize;
00258 
00259 <span class="comment">/* Allocate buffer from heap</span>
00260 <span class="comment">   *************************/</span>
00261    <a class="code" href="logit_8c.html#a9">buf</a> = (<span class="keywordtype">char</span> *) malloc( (size_t)logbuffersize );
00262    <span class="keywordflow">if</span> ( <a class="code" href="logit_8c.html#a9">buf</a> == (<span class="keywordtype">char</span> *)NULL )
00263    {
00264      <span class="comment">/* DK 2000/06/02 Added the size of the malloc, to the message */</span>
00265      fprintf( stderr, <span class="stringliteral">"%s logit_init: malloc error for %d bytes. Exiting\n"</span>,
00266              progName, logbuffersize );
00267      exit( 0 );
00268    }
00269 
00270 <span class="comment">/* Create a mutex</span>
00271 <span class="comment">   **************/</span>
00272 <span class="preprocessor">#ifdef _LOGITMT</span>
00273 <span class="preprocessor"></span>   <a class="code" href="earthworm__complex__funcs_8h.html#a8">CreateSpecificMutex</a>( &amp;mutsem );
00274 <span class="preprocessor">#endif</span>
00275 <span class="preprocessor"></span>
00276 <span class="comment">/* Check the disk log/nolog switch</span>
00277 <span class="comment">   *******************************/</span>
00278    <span class="keywordflow">if</span> ( logflag == 0 )
00279    {
00280      <a class="code" href="logit_8c.html#a12">disk</a> = 0;
00281      <span class="keywordflow">return</span>;
00282    }
00283 
00284    <span class="comment">/* check the SOE log/nolog switch */</span>
00285    <span class="keywordflow">if</span> (logflag == 2)
00286      <a class="code" href="logit_8c.html#a13">soe</a> = 0;
00287    
00288 <span class="comment">/* Get path to log directory from environment variable EW_LOG</span>
00289 <span class="comment">   **********************************************************/</span>
00290    str = getenv( <span class="stringliteral">"EW_LOG"</span> );
00291 
00292    <span class="keywordflow">if</span> ( str == NULL )
00293    {
00294       fprintf( stderr, <span class="stringliteral">"Environment variable EW_LOG not defined; "</span> );
00295       fprintf( stderr, <span class="stringliteral">"%s exiting.\n"</span>, progName );
00296       exit( -1 );
00297    }
00298 
00299 <span class="comment">/* Save the log-directory path and program name.</span>
00300 <span class="comment">   *******************************************************/</span>
00301    strcpy ( logpath, str );
00302    sprintf( <span class="keyword">template</span>, <span class="stringliteral">"%s_"</span>, progName );
00303 
00304 <span class="comment">/* Build date stamp</span>
00305 <span class="comment">   *****************/</span>
00306    time( &amp;now );
00307    <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a>( &amp;now, &amp;res );
00308 
00309    <span class="comment">/******************* Y2K *********************</span>
00310 <span class="comment">    * Add 1900 to tm_year since it represents   *</span>
00311 <span class="comment">    * number of years since 1900                *</span>
00312 <span class="comment">    ******************* Y2K *********************/</span>
00313    sprintf( date, <span class="stringliteral">"%04d%02d%02d"</span>, (<a class="code" href="logit_8c.html#a10">res</a>.tm_year + TM_YEAR_CORR),
00314             (<a class="code" href="logit_8c.html#a10">res</a>.tm_mon + 1), <a class="code" href="logit_8c.html#a10">res</a>.tm_mday );
00315 
00316 <span class="comment">/* Build extension</span>
00317 <span class="comment">   *****************/</span>
00318    sprintf( extension, <span class="stringliteral">".log"</span> );
00319 
00320 <span class="comment">/* Build logfile name</span>
00321 <span class="comment">   *******************/</span>
00322    strcpy( logName, logpath );
00323    strcat( logName, <span class="keyword">template</span> );
00324    strcat( logName, date );
00325    strcat( logName, extension );
00326    strcpy( date_prev, date );
00327 
00328 
00329 <span class="preprocessor">#if EW_DEBUG</span>
00330 <span class="preprocessor"></span> fprintf (stderr, <span class="stringliteral">"Opening %s\n"</span>, logName); 
00331 <span class="comment">/* this was commented by DK on 990208, because</span>
00332 <span class="comment">   it was writing data to the webserver on stderr,</span>
00333 <span class="comment">   which gets processed first, and causes things to</span>
00334 <span class="comment">   blow up, because the webserver is trying to parse</span>
00335 <span class="comment">   a header from it.  I think this should be a debug</span>
00336 <span class="comment">   statement any way. */</span>
00337 <span class="preprocessor">#endif </span><span class="comment">/* EW_DEBUG */</span>
00338 
00339 <span class="comment">/* Open log file</span>
00340 <span class="comment">   *************/</span>
00341    <a class="code" href="logit_8c.html#a1">fp</a> = fopen( logName, <span class="stringliteral">"a"</span> );
00342    <span class="keywordflow">if</span> ( <a class="code" href="logit_8c.html#a1">fp</a> == NULL )
00343    {
00344       fprintf( stderr, <span class="stringliteral">"%s: Error opening log file &lt;%s%s%s&gt;. Exiting\n"</span>,
00345                progName, <span class="keyword">template</span>, date, extension );
00346       exit( 0 );
00347    }
00348 
00349 <span class="comment">/* Print startup message to log file</span>
00350 <span class="comment">   *********************************/</span>
00351    fprintf( fp, <span class="stringliteral">"\n-------------------------------------------------------\n"</span> );
00352    fprintf( fp, <span class="stringliteral">"%s: startup at UTC_%s_%02d:%02d:%02d\n"</span>,
00353             progName, date, <a class="code" href="logit_8c.html#a10">res</a>.tm_hour, <a class="code" href="logit_8c.html#a10">res</a>.tm_min, <a class="code" href="logit_8c.html#a10">res</a>.tm_sec );
00354       
00355 <span class="preprocessor">#ifdef _LOGITMT</span>
00356 <span class="preprocessor"></span>   fprintf( fp, <span class="stringliteral">"This program is using the MT-Safe version of logit.\n"</span> );
00357 <span class="preprocessor">#else</span>
00358 <span class="preprocessor"></span>   fprintf( fp, <span class="stringliteral">"This program is using the non-MT-Safe version of logit.\n"</span> );
00359 <span class="preprocessor">#endif</span>
00360 <span class="preprocessor"></span>
00361    fprintf( fp, <span class="stringliteral">"-------------------------------------------------------\n"</span> );
00362 
00363    fflush ( fp );
00364 
00365 <span class="comment">/* Log a warning message</span>
00366 <span class="comment">   *********************/</span>
00367 <span class="preprocessor">#if defined(_OS2) || defined(_WINNT)</span>
00368 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( getenv( <span class="stringliteral">"TZ"</span> ) == NULL )
00369    {
00370       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"WARNING: The TZ environmental variable is not set.\n"</span> );
00371       <a class="code" href="logit_8c.html#a18">logit</a>( <span class="stringliteral">"e"</span>, <span class="stringliteral">"         UTC times in log messages may be bogus.\n"</span> );
00372    }
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span>
00375    <span class="comment">/* get the process id for use by logit("p",""); </span>
00376 <span class="comment">      davidk 11/13/1998 */</span>
00377    <a class="code" href="logit_8c.html#a14">pid</a>=getpid();
00378    <span class="keywordflow">return</span>;
00379 }
00380 
00381 
00382    <span class="comment">/*****************************************************************</span>
00383 <span class="comment">    *                            logit                              *</span>
00384 <span class="comment">    *                                                               *</span>
00385 <span class="comment">    *          Function to log a message to a disk file.            *</span>
00386 <span class="comment">    *                                                               *</span>
00387 <span class="comment">    *  flag: A string controlling where output is written:          *</span>
00388 <span class="comment">    *        If any character is 'e', output is written to stderr.  *</span>
00389 <span class="comment">    *        If any character is 'o', output is written to stdout.  *</span>
00390 <span class="comment">    *        If any character is 't', output is time stamped.       *</span>
00391 <span class="comment">    *        If any character is 'p', output is ProcessID stamped.  *</span>
00392 <span class="comment">    *                                                               *</span>
00393 <span class="comment">    *  The rest of calling sequence is identical to printf.         *</span>
00394 <span class="comment">    *****************************************************************/</span>
00395 
<a name="l00396"></a><a class="code" href="logit_8c.html#a18">00396</a> <span class="keywordtype">void</span> <a class="code" href="logit_8c.html#a18">logit</a>( <span class="keywordtype">char</span> *flag, <span class="keywordtype">char</span> *format, ... )
00397 {
00398    <span class="keyword">auto</span> va_list ap;
00399    <span class="keyword">static</span> <span class="keywordtype">char</span>   *fl;
00400    <span class="keywordtype">int</span>    stout      = 0;      <span class="comment">/* 1 if output is also to stdout   */</span>
00401    <span class="keywordtype">int</span>    sterr      = 0;      <span class="comment">/* 1 if output is also to stderr   */</span>
00402    <span class="keywordtype">int</span>    time_stamp = 0;      <span class="comment">/* 1 if output is time-stamped     */</span>
00403    <span class="keywordtype">int</span>    pid_stamp  = 0;      <span class="comment">/* 1 if output is pid-stamped      */</span>
00404    <span class="keywordtype">int</span>    retcode;             <span class="comment">/* DK 2000/06/02 used to check the</span>
00405 <span class="comment">                                  return code from vsnprintf()    */</span>
00406    <span class="keywordtype">int</span>    basebufferlen;       <span class="comment">/* DK 2000/06/02 used to store the</span>
00407 <span class="comment">                                  length of the header string </span>
00408 <span class="comment">                                  prepended to the guts of the log</span>
00409 <span class="comment">                                  message                         */</span>
00410 
00411 <span class="comment">/* Check init flag</span>
00412 <span class="comment">   ***************/</span>
00413    <span class="keywordflow">if</span> ( !<a class="code" href="logit_8c.html#a11">init</a> )
00414    {
00415       fprintf( stderr, <span class="stringliteral">"WARNING: Call logit_init before logit.\n"</span> );
00416       <span class="keywordflow">return</span>;
00417    }
00418 
00419 <span class="preprocessor">#ifdef _LOGITMT</span>
00420 <span class="preprocessor"></span>      <a class="code" href="earthworm__complex__funcs_8h.html#a10">RequestSpecificMutex</a>( &amp;mutsem );
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423 <span class="comment">/* Check flag argument</span>
00424 <span class="comment">   *******************/</span>
00425    fl = flag;
00426    <span class="keywordflow">while</span> ( *fl != <span class="charliteral">'\0'</span> )
00427    {
00428       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'o'</span> &amp;&amp; <a class="code" href="logit_8c.html#a13">soe</a> == 1 ) stout      = 1;
00429       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'e'</span> &amp;&amp; <a class="code" href="logit_8c.html#a13">soe</a> == 1 ) sterr      = 1;
00430       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'t'</span> ) time_stamp = 1;
00431       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'d'</span> ) pid_stamp  = 1;
00432       fl++;
00433    }
00434 
00435 <span class="comment">/* Get current system time</span>
00436 <span class="comment">   ***********************/</span>
00437    time( &amp;now );
00438    <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a>( &amp;now, &amp;res );
00439 
00440    <span class="comment">/******************* Y2K *********************</span>
00441 <span class="comment">    * Add 1900 to tm_year since it represents   *</span>
00442 <span class="comment">    * number of years since 1900                *</span>
00443 <span class="comment">    ******************* Y2K *********************/</span>
00444    sprintf (date, <span class="stringliteral">"%4d%02d%02d"</span>, (<a class="code" href="logit_8c.html#a10">res</a>.tm_year + TM_YEAR_CORR),
00445             (<a class="code" href="logit_8c.html#a10">res</a>.tm_mon + 1), <a class="code" href="logit_8c.html#a10">res</a>.tm_mday);
00446 
00447 
00448 <span class="comment">/* If we are writing to a disk file...</span>
00449 <span class="comment">   ***********************************/</span>
00450    <span class="keywordflow">if</span> ( disk )
00451    {
00452 
00453 
00454 <span class="comment">/* See if the date has changed.</span>
00455 <span class="comment">   If so, create a new log file.</span>
00456 <span class="comment">   *****************************/</span>
00457       <span class="keywordflow">if</span> ( strcmp( date, date_prev ) != 0 )
00458       {
00459          fprintf( fp,
00460                  <span class="stringliteral">"UTC date changed; log output continues in file &lt;%s%s%s&gt;\n"</span>,
00461                   <span class="keyword">template</span>, date, extension );
00462          fclose( fp );
00463 
00464          <span class="comment">/* Build new logfile name</span>
00465 <span class="comment">         **************************/</span>
00466          strcpy( logName, logpath );
00467          strcat( logName, <span class="keyword">template</span> );
00468          strcat( logName, date );
00469          strcat( logName, extension );
00470 
00471          <a class="code" href="logit_8c.html#a1">fp</a> = fopen( logName, <span class="stringliteral">"a"</span> );
00472          <span class="keywordflow">if</span> ( <a class="code" href="logit_8c.html#a1">fp</a> == NULL )
00473          {
00474             fprintf( stderr, <span class="stringliteral">"Error opening log file &lt;%s%s%s&gt;. Exiting\n"</span>,
00475                      <span class="keyword">template</span>, date, extension );
00476             exit( 0 );
00477          }
00478          fprintf( fp,
00479                  <span class="stringliteral">"UTC date changed; log output continues from file &lt;%s%s%s&gt;\n"</span>,
00480                   <span class="keyword">template</span>, date_prev, extension );
00481          strcpy( date_prev, date );
00482 
00483 <span class="comment">/* Send a warning message to the new log file</span>
00484 <span class="comment">   ******************************************/</span>
00485 <span class="preprocessor">#if defined(_OS2) || defined(_WINNT)</span>
00486 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( getenv( <span class="stringliteral">"TZ"</span> ) == NULL )
00487          {
00488             fprintf( fp, <span class="stringliteral">"WARNING: The TZ environmental variable is not set.\n"</span> );
00489             fprintf( fp, <span class="stringliteral">"         UTC times in log messages may be bogus.\n"</span> );
00490          }
00491 <span class="preprocessor">#endif</span>
00492 <span class="preprocessor"></span>      }
00493    }
00494 
00495 <span class="comment">/* Write UTC time and argument list to buffer</span>
00496 <span class="comment"> *</span>
00497 <span class="comment"> * Wed Oct 28 16:19:45 MST 1998 lucky</span>
00498 <span class="comment"> *   Added date to the log message</span>
00499 <span class="comment">   ******************************************/</span>
00500    va_start( ap, format );
00501    <a class="code" href="logit_8c.html#a9">buf</a>[0] = 0;  <span class="comment">/* NULL terminate the empty buf */</span>
00502 
00503    <span class="comment">/* DavidK 11/13/1998, changed the format of the conditionals</span>
00504 <span class="comment">      for writing the variable argument stuff to buffer.</span>
00505 <span class="comment">      Changed from if..else for time stamp to if(time_stamp),</span>
00506 <span class="comment">      if(pid_stamp), then after all headers have been written,</span>
00507 <span class="comment">      concatenate the variable argument list to end.</span>
00508 <span class="comment">   */</span>
00509    <span class="comment">/* Write UTC time stamp to buffer if desired */</span>
00510    <span class="keywordflow">if</span> ( time_stamp )
00511    {
00512       sprintf( buf+strlen(buf), <span class="stringliteral">"%s_UTC_%02d:%02d:%02d "</span>,
00513                date, <a class="code" href="logit_8c.html#a10">res</a>.tm_hour, <a class="code" href="logit_8c.html#a10">res</a>.tm_min, <a class="code" href="logit_8c.html#a10">res</a>.tm_sec );
00514    }
00515 
00516    <span class="comment">/* Write Process ID stamp to buffer if desired */</span>
00517    <span class="keywordflow">if</span> ( pid_stamp )
00518    {
00519       sprintf( buf+strlen(buf), <span class="stringliteral">"(%d) "</span>, pid);
00520    }
00521 
00522    <span class="comment">/* Record the strlen() of the buffer after the header has been created */</span>
00523    basebufferlen=strlen(buf);
00524 
00525    <span class="comment">/* Write argument list to buffer */</span>
00526 
00527    <span class="comment">/* DK 2000/06/02 replaced the following vsprintf() call with </span>
00528 <span class="comment">      a vsnprintf() call that puts a limit on the number of </span>
00529 <span class="comment">      bytes written to the buffer, thus preventing buffer overflow</span>
00530 <span class="comment">   ***************************************************************/</span>
00531    <span class="comment">/* vsprintf( buf+strlen(buf), format, ap);  */</span>
00532 
00533    retcode=vsnprintf(buf+basebufferlen, logbuffersize-basebufferlen,
00534                      format, ap);
00535 
00536    <span class="comment">/* check the return code from vsnprintf().  It returns the number</span>
00537 <span class="comment">      of characters written to the buffer unless there is an error,</span>
00538 <span class="comment">      upon error, -1 is returned.  Note:  on most unix systems,</span>
00539 <span class="comment">      if the buffer is not long enough for the message, vsnprintf()</span>
00540 <span class="comment">      will write "buffer length" characters to the buffer, and </span>
00541 <span class="comment">      return "message length".  On NT, -1 is returned if the </span>
00542 <span class="comment">      "message length" exceeds the "buffer length".</span>
00543 <span class="comment">   ***************************************************************/</span>
00544    <span class="keywordflow">if</span>(retcode &gt; <a class="code" href="logit_8c.html#a15">logbuffersize</a>-basebufferlen)
00545    {
00546      <span class="comment">/* The buffer wasn't long enough for the message and we know how long </span>
00547 <span class="comment">        the message was.                              </span>
00548 <span class="comment">     *********************************************************************/</span>
00549 
00550      <span class="keywordflow">if</span> ( disk )
00551      {
00552        fprintf( fp, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00553                 <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00554                 <span class="stringliteral">"is %d bytes!\n"</span>, <span class="keyword">template</span>, logbuffersize,
00555                 retcode + basebufferlen);      
00556        <span class="comment">/* If fprintf fails, we won't know it */</span>
00557         
00558      }
00559      <span class="keywordflow">else</span>
00560      {
00561        <span class="keywordflow">if</span>(!<a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>)
00562        {
00563          fprintf( stderr, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00564                   <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00565                   <span class="stringliteral">"is %d bytes!\n"</span>, <span class="keyword">template</span>, logbuffersize,
00566                   retcode + basebufferlen);      
00567          <a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>=1;
00568        }
00569      }
00570      <span class="comment">/* DK 2000/06/02 this buffer was long, and it probably had a \n at</span>
00571 <span class="comment">        the end that got truncated.  So add one in there.  Don't add it</span>
00572 <span class="comment">        to the very end of the buffer, because that's where the null</span>
00573 <span class="comment">        terminator goes.</span>
00574 <span class="comment">     ***************************************************************/</span>
00575      <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-2]=<span class="charliteral">'\n'</span>;
00576    }
00577    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(retcode == -1)
00578    {
00579      <span class="comment">/* The buffer wasn't long enough for the message but we don't know how</span>
00580 <span class="comment">        long the message was.</span>
00581 <span class="comment">     *********************************************************************/</span>
00582 
00583      <span class="keywordflow">if</span> ( disk )
00584      {
00585        fprintf( fp, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00586                 <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00587                 <span class="stringliteral">"is more!\n"</span>, <span class="keyword">template</span>, logbuffersize);     
00588        <span class="comment">/* If fprintf fails, we won't know it */</span>
00589      }
00590      <span class="keywordflow">else</span>
00591      {
00592        <span class="keywordflow">if</span>(!<a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>)
00593        {
00594          fprintf( stderr, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00595                   <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00596                   <span class="stringliteral">"is more!\n"</span>, <span class="keyword">template</span>, logbuffersize); 
00597          <a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>=1;
00598        }
00599      }
00600      <span class="comment">/* DK 2000/06/02 this buffer was long, and it probably had a \n at</span>
00601 <span class="comment">        the end that got truncated.  So add one in there.  Don't add it</span>
00602 <span class="comment">        to the very end of the buffer, because that's where the null</span>
00603 <span class="comment">        terminator goes.</span>
00604 <span class="comment">     ***************************************************************/</span>
00605      <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-2]=<span class="charliteral">'\n'</span>;
00606    }
00607 
00608    <span class="comment">/* ensure that the buffer is null terminated */</span>
00609    <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-1]=0;
00610 
00611    va_end( ap );
00612 
00613 <span class="comment">/* Write buffer to standard output and standard error</span>
00614 <span class="comment">   **************************************************/</span>
00615    <span class="keywordflow">if</span> ( stout )
00616       printf( <span class="stringliteral">"%s"</span>, buf );
00617 
00618    <span class="keywordflow">if</span> ( sterr )
00619       fprintf( stderr, <span class="stringliteral">"%s"</span>, buf );
00620 
00621 <span class="comment">/* Write buffer to disk file</span>
00622 <span class="comment">   *************************/</span>
00623    <span class="keywordflow">if</span> ( disk )
00624    {
00625       fprintf( fp, <span class="stringliteral">"%s"</span>, buf );      <span class="comment">/* If fprintf fails, we won't know it */</span>
00626       fflush( fp );
00627    }
00628 
00629 <span class="preprocessor">#ifdef _LOGITMT</span>
00630 <span class="preprocessor"></span>      <a class="code" href="earthworm__complex__funcs_8h.html#a11">ReleaseSpecificMutex</a>( &amp;mutsem );
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>
00633    <span class="keywordflow">return</span>;
00634 }
00635 
00636 
00637 <span class="comment">/*************************************************************************</span>
00638 <span class="comment"> *                         get_prog_name                                 *</span>
00639 <span class="comment"> *                                                                       *</span>
00640 <span class="comment"> *   extracts program name from the full path by ignoring everything     *</span>
00641 <span class="comment"> *   before the first / and after the . (extension)                      *</span>
00642 <span class="comment"> *                                                                       *</span>
00643 <span class="comment"> *   full_name Name of the calling program (argv[0] to main()).          *</span>
00644 <span class="comment"> *             On OS2, prog has the suffix ".exe"                        *</span>
00645 <span class="comment"> *                                                                       *</span>
00646 <span class="comment"> *   prog_name Truncated program name. Array must be allocated before    *</span>
00647 <span class="comment"> *             calling this routine                                      *</span>
00648 <span class="comment"> *                                                                       *</span>
00649 <span class="comment"> *************************************************************************/</span>
<a name="l00650"></a><a class="code" href="logit_8c.html#a19">00650</a> <span class="keywordtype">int</span> <a class="code" href="logit_8c.html#a19">get_prog_name</a> (<span class="keywordtype">char</span> *full_name, <span class="keywordtype">char</span> *prog_name)
00651 {
00652 
00653         <span class="keywordtype">char</span>    *str;
00654 
00655         <span class="keywordflow">if</span> ((full_name == NULL) || (prog_name == NULL))
00656         {
00657                 fprintf (stderr, <span class="stringliteral">"Invalid arguments passed in.\n"</span>);
00658                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00659         }
00660 
00661         <span class="comment">/* Truncate in front of and including "/", everything beyond and</span>
00662 <span class="comment">           including "." in the program name</span>
00663 <span class="comment">         *********************************/</span>
00664         <span class="keywordflow">if</span> ((str = strrchr (full_name, <span class="charliteral">'/'</span>)) != NULL)
00665                 strcpy (prog_name, str + 1);
00666         <span class="keywordflow">else</span>
00667                 strcpy (prog_name, full_name);
00668 
00669         str = strchr (prog_name, <span class="charliteral">'.'</span>);
00670         <span class="keywordflow">if</span> (str != NULL)
00671                 *str = <span class="charliteral">'\0'</span>;
00672 
00673         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00674 
00675 }
00676 
00677 
00678 
00679    <span class="comment">/*****************************************************************</span>
00680 <span class="comment">    *                         html_logit                            *</span>
00681 <span class="comment">    *                                                               *</span>
00682 <span class="comment">    *          Function to log a message to a disk file, and        *</span>
00683 <span class="comment">    *       also html suitable output to stderr.                    *</span>
00684 <span class="comment">    *                                                               *</span>
00685 <span class="comment">    *  flag: A string controlling where output is written:          *</span>
00686 <span class="comment">    *        If any character is 't', output is time stamped.       *</span>
00687 <span class="comment">    *        If any character is 'p', output is ProcessID stamped.  *</span>
00688 <span class="comment">    *                                                               *</span>
00689 <span class="comment">    *  The rest of calling sequence is identical to printf.         *</span>
00690 <span class="comment">    *****************************************************************/</span>
00691 
<a name="l00692"></a><a class="code" href="logit_8c.html#a20">00692</a> <span class="keywordtype">void</span> <a class="code" href="logit_8c.html#a20">html_logit</a>( <span class="keywordtype">char</span> *flag, <span class="keywordtype">char</span> *format, ... )
00693 {
00694    <span class="keyword">auto</span> va_list ap;
00695    <span class="keyword">static</span> <span class="keywordtype">char</span>   *fl;
00696    <span class="keywordtype">int</span>    time_stamp = 0;      <span class="comment">/* 1 if output is time-stamped     */</span>
00697    <span class="keywordtype">int</span>    pid_stamp  = 0;      <span class="comment">/* 1 if output is pid-stamped      */</span>
00698    <span class="keywordtype">int</span>    retcode;             <span class="comment">/* DK 2000/06/02 used to check the</span>
00699 <span class="comment">                                  return code from vsnprintf()    */</span>
00700    <span class="keywordtype">int</span>    basebufferlen;       <span class="comment">/* DK 2000/06/02 used to store the</span>
00701 <span class="comment">                                  length of the header string </span>
00702 <span class="comment">                                  prepended to the guts of the log</span>
00703 <span class="comment">                                  message                         */</span>
00704 
00705 
00706         <span class="comment">/* Put up the initial HTML */</span>
00707         printf (<span class="stringliteral">"&lt;CENTER&gt;&lt;HR&gt;&lt;PRE&gt;&lt;STRONG&gt;&lt;BR&gt;&lt;BR&gt;\n"</span>);
00708 
00709 
00710 <span class="comment">/* Check init flag</span>
00711 <span class="comment">   ***************/</span>
00712    <span class="keywordflow">if</span> ( !<a class="code" href="logit_8c.html#a11">init</a> )
00713    {
00714       printf (<span class="stringliteral">"WARNING: Call logit_init before logit.\n"</span>);
00715       <span class="keywordflow">goto</span> done;
00716    }
00717 
00718 <span class="preprocessor">#ifdef _LOGITMT</span>
00719 <span class="preprocessor"></span>      <a class="code" href="earthworm__complex__funcs_8h.html#a10">RequestSpecificMutex</a>( &amp;mutsem );
00720 <span class="preprocessor">#endif</span>
00721 <span class="preprocessor"></span>
00722 <span class="comment">/* Check flag argument</span>
00723 <span class="comment">   *******************/</span>
00724    fl = flag;
00725    <span class="keywordflow">while</span> ( *fl != <span class="charliteral">'\0'</span> )
00726    {
00727       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'t'</span> ) time_stamp = 1;
00728       <span class="keywordflow">if</span> ( *fl == <span class="charliteral">'d'</span> ) pid_stamp  = 1;
00729       fl++;
00730    }
00731 
00732 <span class="comment">/* Get current system time</span>
00733 <span class="comment">   ***********************/</span>
00734    time( &amp;now );
00735    <a class="code" href="time__ew_8c.html#a0">gmtime_ew</a>( &amp;now, &amp;res );
00736 
00737    <span class="comment">/******************* Y2K *********************</span>
00738 <span class="comment">    * Add 1900 to tm_year since it represents   *</span>
00739 <span class="comment">    * number of years since 1900                *</span>
00740 <span class="comment">    ******************* Y2K *********************/</span>
00741    sprintf (date, <span class="stringliteral">"%4d%02d%02d"</span>, (<a class="code" href="logit_8c.html#a10">res</a>.tm_year + TM_YEAR_CORR),
00742             (<a class="code" href="logit_8c.html#a10">res</a>.tm_mon + 1), <a class="code" href="logit_8c.html#a10">res</a>.tm_mday);
00743 
00744 
00745 <span class="comment">/* If we are writing to a disk file...</span>
00746 <span class="comment">   ***********************************/</span>
00747    <span class="keywordflow">if</span> ( disk )
00748    {
00749 
00750 
00751 <span class="comment">/* See if the date has changed.</span>
00752 <span class="comment">   If so, create a new log file.</span>
00753 <span class="comment">   *****************************/</span>
00754       <span class="keywordflow">if</span> ( strcmp( date, date_prev ) != 0 )
00755       {
00756          fprintf( fp,
00757                  <span class="stringliteral">"UTC date changed; log output continues in file &lt;%s%s%s&gt;\n"</span>,
00758                   <span class="keyword">template</span>, date, extension );
00759          fclose( fp );
00760 
00761          <span class="comment">/* Build new logfile name</span>
00762 <span class="comment">         **************************/</span>
00763          strcpy( logName, logpath );
00764          strcat( logName, <span class="keyword">template</span> );
00765          strcat( logName, date );
00766          strcat( logName, extension );
00767 
00768          <a class="code" href="logit_8c.html#a1">fp</a> = fopen( logName, <span class="stringliteral">"a"</span> );
00769          <span class="keywordflow">if</span> ( <a class="code" href="logit_8c.html#a1">fp</a> == NULL )
00770          {
00771             fprintf( stderr, <span class="stringliteral">"Error opening log file &lt;%s%s%s&gt;. Exiting\n"</span>,
00772                      <span class="keyword">template</span>, date, extension );
00773             exit( 0 );
00774          }
00775          fprintf( fp,
00776                  <span class="stringliteral">"UTC date changed; log output continues from file &lt;%s%s%s&gt;\n"</span>,
00777                   <span class="keyword">template</span>, date_prev, extension );
00778          strcpy( date_prev, date );
00779 
00780 <span class="comment">/* Send a warning message to the new log file</span>
00781 <span class="comment">   ******************************************/</span>
00782 <span class="preprocessor">#if defined(_OS2) || defined(_WINNT)</span>
00783 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( getenv( <span class="stringliteral">"TZ"</span> ) == NULL )
00784          {
00785             fprintf( fp, <span class="stringliteral">"WARNING: The TZ environmental variable is not set.\n"</span> );
00786             fprintf( fp, <span class="stringliteral">"         UTC times in log messages may be bogus.\n"</span> );
00787          }
00788 <span class="preprocessor">#endif</span>
00789 <span class="preprocessor"></span>      }
00790    }
00791 
00792 <span class="comment">/* Write UTC time and argument list to buffer</span>
00793 <span class="comment"> *</span>
00794 <span class="comment"> * Wed Oct 28 16:19:45 MST 1998 lucky</span>
00795 <span class="comment"> *   Added date to the log message</span>
00796 <span class="comment">   ******************************************/</span>
00797    va_start( ap, format );
00798    <a class="code" href="logit_8c.html#a9">buf</a>[0] = 0;  <span class="comment">/* NULL terminate the empty buf */</span>
00799 
00800    <span class="comment">/* DavidK 11/13/1998, changed the format of the conditionals</span>
00801 <span class="comment">      for writing the variable argument stuff to buffer.</span>
00802 <span class="comment">      Changed from if..else for time stamp to if(time_stamp),</span>
00803 <span class="comment">      if(pid_stamp), then after all headers have been written,</span>
00804 <span class="comment">      concatenate the variable argument list to end.</span>
00805 <span class="comment">   */</span>
00806    <span class="comment">/* Write UTC time stamp to buffer if desired */</span>
00807    <span class="keywordflow">if</span> ( time_stamp )
00808    {
00809       sprintf( buf+strlen(buf), <span class="stringliteral">"%s_UTC_%02d:%02d:%02d "</span>,
00810                date, <a class="code" href="logit_8c.html#a10">res</a>.tm_hour, <a class="code" href="logit_8c.html#a10">res</a>.tm_min, <a class="code" href="logit_8c.html#a10">res</a>.tm_sec );
00811    }
00812 
00813    <span class="comment">/* Write Process ID stamp to buffer if desired */</span>
00814    <span class="keywordflow">if</span> ( pid_stamp )
00815    {
00816       sprintf( buf+strlen(buf), <span class="stringliteral">"(%d) "</span>, pid);
00817    }
00818 
00819    <span class="comment">/* Record the strlen() of the buffer after the header has been created */</span>
00820    basebufferlen=strlen(buf);
00821 
00822    <span class="comment">/* Write argument list to buffer */</span>
00823 
00824    <span class="comment">/* DK 2000/06/02 replaced the following vsprintf() call with </span>
00825 <span class="comment">      a vsnprintf() call that puts a limit on the number of </span>
00826 <span class="comment">      bytes written to the buffer, thus preventing buffer overflow</span>
00827 <span class="comment">   ***************************************************************/</span>
00828    <span class="comment">/* vsprintf( buf+strlen(buf), format, ap);  */</span>
00829 
00830    retcode=vsnprintf(buf+basebufferlen, logbuffersize-basebufferlen,
00831                      format, ap);
00832 
00833    <span class="comment">/* check the return code from vsnprintf().  It returns the number</span>
00834 <span class="comment">      of characters written to the buffer unless there is an error,</span>
00835 <span class="comment">      upon error, -1 is returned.  Note:  on most unix systems,</span>
00836 <span class="comment">      if the buffer is not long enough for the message, vsnprintf()</span>
00837 <span class="comment">      will write "buffer length" characters to the buffer, and </span>
00838 <span class="comment">      return "message length".  On NT, -1 is returned if the </span>
00839 <span class="comment">      "message length" exceeds the "buffer length".</span>
00840 <span class="comment">   ***************************************************************/</span>
00841    <span class="keywordflow">if</span>(retcode &gt; <a class="code" href="logit_8c.html#a15">logbuffersize</a>-basebufferlen)
00842    {
00843      <span class="comment">/* The buffer wasn't long enough for the message and we know how long </span>
00844 <span class="comment">        the message was.                              </span>
00845 <span class="comment">     *********************************************************************/</span>
00846 
00847      <span class="keywordflow">if</span> ( disk )
00848      {
00849        fprintf( fp, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00850                 <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00851                 <span class="stringliteral">"is %d bytes!\n"</span>, <span class="keyword">template</span>, logbuffersize,
00852                 retcode + basebufferlen);      
00853        <span class="comment">/* If fprintf fails, we won't know it */</span>
00854         
00855      }
00856      <span class="keywordflow">else</span>
00857      {
00858        <span class="keywordflow">if</span>(!<a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>)
00859        {
00860          printf (<span class="stringliteral">"html_logit(%s): ERROR!!! Attempting to log too large "</span>
00861                   <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00862                   <span class="stringliteral">"is %d bytes!\n"</span>, <span class="keyword">template</span>, logbuffersize,
00863                   retcode + basebufferlen);      
00864          
00865          <a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>=1;
00866        }
00867      }
00868      <span class="comment">/* DK 2000/06/02 this buffer was long, and it probably had a \n at</span>
00869 <span class="comment">        the end that got truncated.  So add one in there.  Don't add it</span>
00870 <span class="comment">        to the very end of the buffer, because that's where the null</span>
00871 <span class="comment">        terminator goes.</span>
00872 <span class="comment">     ***************************************************************/</span>
00873      <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-2]=<span class="charliteral">'\n'</span>;
00874    }
00875    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(retcode == -1)
00876    {
00877      <span class="comment">/* The buffer wasn't long enough for the message but we don't know how</span>
00878 <span class="comment">        long the message was.</span>
00879 <span class="comment">     *********************************************************************/</span>
00880 
00881      <span class="keywordflow">if</span> ( disk )
00882      {
00883        fprintf( fp, <span class="stringliteral">"logit(%s): ERROR!!! Attempting to log too large "</span>
00884                 <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00885                 <span class="stringliteral">"is more!\n"</span>, <span class="keyword">template</span>, logbuffersize);     
00886        <span class="comment">/* If fprintf fails, we won't know it */</span>
00887      }
00888      <span class="keywordflow">else</span>
00889      {
00890        <span class="keywordflow">if</span>(!<a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>)
00891        {
00892          printf (<span class="stringliteral">"html_logit(%s): ERROR!!! Attempting to log too large "</span>
00893                   <span class="stringliteral">"of a message!!!\n  Logit buffer is %d bytes, message "</span>
00894                   <span class="stringliteral">"is more!\n"</span>, <span class="keyword">template</span>, logbuffersize); 
00895          <a class="code" href="logit_8c.html#a16">bErrorIssuedToStderr</a>=1;
00896        }
00897      }
00898      <span class="comment">/* DK 2000/06/02 this buffer was long, and it probably had a \n at</span>
00899 <span class="comment">        the end that got truncated.  So add one in there.  Don't add it</span>
00900 <span class="comment">        to the very end of the buffer, because that's where the null</span>
00901 <span class="comment">        terminator goes.</span>
00902 <span class="comment">     ***************************************************************/</span>
00903      <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-2]=<span class="charliteral">'\n'</span>;
00904    }
00905 
00906    <span class="comment">/* ensure that the buffer is null terminated */</span>
00907    <a class="code" href="logit_8c.html#a9">buf</a>[<a class="code" href="logit_8c.html#a15">logbuffersize</a>-1]=0;
00908 
00909    va_end( ap );
00910 
00911 <span class="comment">/* Write buffer to html</span>
00912 <span class="comment">   *******************************/</span>
00913    printf( <span class="stringliteral">"ERROR: %s"</span>, buf );
00914 
00915 
00916 <span class="comment">/* Write buffer to disk file</span>
00917 <span class="comment">   *************************/</span>
00918    <span class="keywordflow">if</span> ( disk )
00919    {
00920       fprintf( fp, <span class="stringliteral">"%s"</span>, buf );      <span class="comment">/* If fprintf fails, we won't know it */</span>
00921       fflush( fp );
00922    }
00923 
00924 <span class="preprocessor">#ifdef _LOGITMT</span>
00925 <span class="preprocessor"></span>      <a class="code" href="earthworm__complex__funcs_8h.html#a11">ReleaseSpecificMutex</a>( &amp;mutsem );
00926 <span class="preprocessor">#endif</span>
00927 <span class="preprocessor"></span>
00928 done:
00929    printf (<span class="stringliteral">"&lt;/CENTER&gt;&lt;HR&gt;&lt;/PRE&gt;&lt;/STRONG&gt;\n"</span>);
00930    <span class="keywordflow">return</span>;
00931 }
00932 
00933 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:04 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
