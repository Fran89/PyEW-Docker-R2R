<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dirops_ew.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>dirops_ew.c</h1><a href="dirops__ew_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: dirops__ew_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:01  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.4  2001/04/05 18:19:31  cjbryan</span>
00011 <span class="comment"> *     added RecursiveCreateDir function to recursively create all</span>
00012 <span class="comment"> *     directories in a specifed path</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *     Revision 1.3  2000/09/28 23:19:38  dietz</span>
00015 <span class="comment"> *     added function rename_ew</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> *     Revision 1.2  2000/03/10 23:36:48  davidk</span>
00018 <span class="comment"> *     added an include of &lt;direct.h&gt; to resolve a compiler warning about</span>
00019 <span class="comment"> *     Create_dir()</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *     Revision 1.1  2000/02/14 18:53:30  lucky</span>
00022 <span class="comment"> *     Initial revision</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> */</span>
00026 
00027          <span class="comment">/************************************************************</span>
00028 <span class="comment">          *            dirops_ew.c  Windows NT version               *</span>
00029 <span class="comment">          *                                                          *</span>
00030 <span class="comment">          *  Contains system-specific functions for dealing with     *</span>
00031 <span class="comment">          *  directories                                             *</span>
00032 <span class="comment">          ************************************************************/</span>
00033 
00034 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00036 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="earthworm_8h.html">earthworm.h</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00039 <span class="preprocessor">#include &lt;direct.h&gt;</span>
00040 
00041 
00042            <span class="comment">/*******************************************************</span>
00043 <span class="comment">            *  chdir_ew( )  changes current working directory     *</span>
00044 <span class="comment">            *                                                     *</span>
00045 <span class="comment">            *  Returns 0 if all went well                         *</span>
00046 <span class="comment">            *         -1 if an error occurred                     *</span>
00047 <span class="comment">            *******************************************************/</span>
00048 
<a name="l00049"></a><a class="code" href="dirops__ew_8c.html#a0">00049</a> <span class="keywordtype">int</span> <a class="code" href="dirops__ew_8c.html#a0">chdir_ew</a>( <span class="keywordtype">char</span> *path )
00050 {
00051    BOOL success;
00052 
00053    success = SetCurrentDirectory( path );
00054 
00055    <span class="keywordflow">if</span> ( success )
00056       <span class="keywordflow">return</span> 0;
00057    <span class="keywordflow">else</span>
00058       <span class="keywordflow">return</span> -1;
00059 }
00060 
00061 
00062 
00063 <span class="comment">/*****************************************************************************</span>
00064 <span class="comment"> *  CreateDir ()  Creates a directory. Solaris version.                      *</span>
00065 <span class="comment"> *                                                                           *</span>
00066 <span class="comment"> *  if dirname exists and is accessible, EW_SUCCESS is returned. Otherwise,  *</span>
00067 <span class="comment"> *  we attempt to create it. If it all goes well, we return EW_SUCCESS,      *</span>
00068 <span class="comment"> *  otherwise we report error and return EW_FAILURE.                         *</span>
00069 <span class="comment"> *       LV 8/16/1999                                                        *</span>
00070 <span class="comment"> *****************************************************************************/</span>
<a name="l00071"></a><a class="code" href="dirops__ew_8c.html#a1">00071</a> <span class="keywordtype">int</span> <a class="code" href="dirops__ew_8c.html#a1">CreateDir</a> (<span class="keywordtype">char</span> *dirname)
00072 {
00073    <span class="keyword">struct </span>stat buf;
00074 
00075    <span class="keywordflow">if</span> (dirname == NULL)
00076    {
00077       <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"Invalid argument passed in; exiting!\n"</span>);
00078       <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00079    }
00080 
00081 <span class="comment">/* does it already exist? */</span>
00082    <span class="keywordflow">if</span> (stat (dirname, &amp;buf) != 0)
00083    {
00084       <span class="keywordflow">if</span> (errno == ENOENT)
00085       {
00086          <span class="keywordflow">if</span> (mkdir (dirname) != 0)
00087          {
00088             <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"CreateDir: Cannot create %s: %s\n"</span>,
00089                     dirname, strerror(errno) );
00090             <span class="keywordflow">return</span>( EW_FAILURE);
00091          }
00092       }
00093       <span class="keywordflow">else</span>
00094       {
00095          <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"CreateDir: Cannot stat %s - %s \n"</span>, 
00096                  dirname, strerror (errno));
00097          <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00098       }
00099 
00100    }
00101    <span class="keywordflow">else</span>
00102    {
00103       <span class="comment">/* do nothing - hope that this is a directory */</span>
00104    }
00105 
00106    <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00107 
00108 }
00109 
00110 <span class="comment">/*****************************************************************************</span>
00111 <span class="comment"> *  Recursive CreateDir ()  Recursively creates all directories in a         *</span>
00112 <span class="comment"> *  specified path. First checks to see if only directory to create is last  *</span>
00113 <span class="comment"> *  one in path; if not creates directories one at a time through calls to   *</span>
00114 <span class="comment"> *  to CreateDir().             </span>
00115 <span class="comment"> *                                                                           *</span>
00116 <span class="comment"> *  if dirname exists and is accessible, EW_SUCCESS is returned. Otherwise,  *</span>
00117 <span class="comment"> *  we attempt to create it. If it all goes well, we return EW_SUCCESS,      *</span>
00118 <span class="comment"> *  otherwise we report error and return EW_FAILURE.                         *</span>
00119 <span class="comment"> *       CJB 3/29/01                                                         *</span>
00120 <span class="comment"> *****************************************************************************/</span>
<a name="l00121"></a><a class="code" href="dirops__ew_8c.html#a2">00121</a> <span class="keywordtype">int</span> <a class="code" href="dirops__ew_8c.html#a2">RecursiveCreateDir</a>(<span class="keywordtype">char</span> *dirname) {
00122         
00123         <span class="keyword">struct  </span>stat    buf;
00124         <span class="keywordtype">char</span>            *dname;
00125         <span class="keywordtype">char</span>            *where;
00126         <span class="keywordtype">int</span>             place;
00127         <span class="keywordtype">int</span>             len;
00128         <span class="keywordtype">int</span>             find = <span class="charliteral">'\\'</span>;
00129         <span class="keywordtype">char</span>            directory[<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a>];
00130 
00131         <span class="comment">/* check to make sure directory name is not too long */</span>
00132         <span class="keywordflow">if</span> (strlen(dirname) &gt; (<a class="code" href="earthworm__defs_8h.html#a20">MAX_DIR_LEN</a> - 1)) 
00133         {
00134                 <a class="code" href="logit_8c.html#a18">logit</a>(<span class="stringliteral">"e"</span>, <span class="stringliteral">"RecursiveCreateDir: directory name %s exceeds allowed length %d \n"</span>,
00135                                 dirname, MAX_DIR_LEN);
00136                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00137         }
00138 
00139         strcpy(directory, <span class="stringliteral">""</span>);
00140         <span class="keywordflow">if</span> (dirname == NULL)
00141         {
00142                 <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00143         }
00144 
00145         <span class="comment">/* does it already exist? */</span>
00146         <span class="keywordflow">if</span> (stat (dirname, &amp;buf) != 0)
00147         {
00148                 <span class="keywordflow">if</span> (errno == ENOENT)
00149                 {
00150                         <span class="comment">/* first lets just try and make it; if this doesn't work</span>
00151 <span class="comment">                                we'll start at the beginning and make each subdirectory */</span>
00152                         <span class="keywordflow">if</span> (mkdir (dirname) != 0)
00153                         {
00154                                 dname = dirname;
00155                                 <span class="keywordflow">while</span> ((where = strchr(dname, find)) != NULL) {
00156                                         place = where - dname;
00157                                         len = strlen(directory);
00158                                         strncat(directory, dname, place);
00159                                         directory[len + place] = <span class="charliteral">'\0'</span>;
00160                                         <span class="keywordflow">if</span> (directory[strlen(directory) - 1] != <span class="charliteral">':'</span>)
00161                                         {
00162                                                 <span class="keywordflow">if</span>(<a class="code" href="dirops__ew_8c.html#a1">CreateDir</a>(directory) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00163                                                 {
00164                                                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"RecursiveCreateDir: Cannot create %s\n"</span>,
00165                                                                 directory);
00166                                                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00167                                                 }
00168                                         }
00169                                         <span class="comment">/* add directory delimiter '\'  */</span>
00170                                         strcat(directory, <span class="stringliteral">"\\"</span>);
00171                                         dname += place + 1;
00172                                         
00173                                 } <span class="comment">/* end of while */</span>
00174                                 <span class="comment">/* finally add name of final subdirectory */</span>
00175                                 strcat(directory, dname);
00176                                 <span class="keywordflow">if</span>(<a class="code" href="dirops__ew_8c.html#a1">CreateDir</a>(directory) != <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>)
00177                                 {
00178                                         <a class="code" href="logit_8c.html#a18">logit</a> (<span class="stringliteral">"e"</span>, <span class="stringliteral">"RecursiveCreateDir: Cannot create %s\n"</span>,
00179                                                 directory);
00180                                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00181                                 }
00182                         }
00183                 }
00184                 <span class="keywordflow">else</span>
00185                 {
00186                         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a6">EW_FAILURE</a>;
00187                 }
00188 
00189         }
00190         <span class="keywordflow">else</span>
00191         {
00192                 <span class="comment">/* do nothing - hope that this is a directory */</span>
00193         }
00194 
00195    <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a5">EW_SUCCESS</a>;
00196 }
00197 
00198 <span class="comment">/***************************************************************</span>
00199 <span class="comment"> *  GetFileName   (from Will Kohler's sendfile)                *</span>
00200 <span class="comment"> *                                                             *</span>
00201 <span class="comment"> *  Function to get the name of a file in directory "Path".    *</span>
00202 <span class="comment"> *                                                             *</span>
00203 <span class="comment"> *  Returns 0 if all ok                                        *</span>
00204 <span class="comment"> *          1 if no files were found                           *</span>
00205 <span class="comment"> ***************************************************************/</span>
00206 
<a name="l00207"></a><a class="code" href="dirops__ew_8c.html#a3">00207</a> <span class="keywordtype">int</span> <a class="code" href="earthworm__simple__funcs_8h.html#a15">GetFileName</a>( <span class="keywordtype">char</span> fname[] )
00208 {
00209    <span class="keyword">extern</span> <span class="keywordtype">char</span> Path[80];     <span class="comment">/* Directory containing files to be sent */</span>
00210    <span class="keywordtype">char</span>            fileMask[] = <span class="stringliteral">"*"</span>;
00211    WIN32_FIND_DATA findData;
00212    HANDLE          fileHandle;
00213    FILE            *fp;
00214 
00215    strcpy( fileMask, <span class="stringliteral">"*"</span> );
00216 
00217 <span class="comment">/* Get the name of the first file.</span>
00218 <span class="comment">   The file may be a directory or a partially-written file.</span>
00219 <span class="comment">   If so, skip this file and look for others.</span>
00220 <span class="comment">   *******************************************************/</span>
00221    fileHandle = FindFirstFile( fileMask, &amp;findData );
00222    <span class="keywordflow">if</span> ( fileHandle == INVALID_HANDLE_VALUE )         <span class="comment">/* No files found */</span>
00223       <span class="keywordflow">return</span> 1;
00224 
00225    fp = fopen( findData.cFileName, <span class="stringliteral">"rb"</span> );
00226    <span class="keywordflow">if</span> ( fp != NULL )                 <span class="comment">/* File can be opened */</span>
00227    {
00228       fclose( fp );
00229       strcpy( fname, findData.cFileName );
00230       FindClose( fileHandle );
00231       <span class="keywordflow">return</span> 0;
00232    }
00233 
00234 <span class="comment">/* First file is a directory or it is otherwise unopenable.</span>
00235 <span class="comment">   Find another file, if any.</span>
00236 <span class="comment">   *******************************************************/</span>
00237    <span class="keywordflow">while</span> ( FindNextFile( fileHandle, &amp;findData ) )
00238    {
00239       fp = fopen( findData.cFileName, <span class="stringliteral">"rb"</span> );
00240 
00241       <span class="keywordflow">if</span> ( fp != NULL )                 <span class="comment">/* File can be opened */</span>
00242       {
00243          fclose( fp );
00244          strcpy( fname, findData.cFileName );       <span class="comment">/* Found a file */</span>
00245          FindClose( fileHandle );
00246          <span class="keywordflow">return</span> 0;
00247       }
00248    }
00249 
00250    FindClose( fileHandle );          <span class="comment">/* No files found */</span>
00251    <span class="keywordflow">return</span> 1;
00252 }
00253 
00254 
00255 <span class="comment">/**********************************************************************</span>
00256 <span class="comment"> *  rename_ew( )  Moves a file                   Windows version      *</span>
00257 <span class="comment"> *  path1 = name of file to be moved.  path2 = destination name       *</span>
00258 <span class="comment"> *  Returns -1 if an error occurred; 0 otherwise                      *</span>
00259 <span class="comment"> **********************************************************************/</span>
00260 
<a name="l00261"></a><a class="code" href="dirops__ew_8c.html#a4">00261</a> <span class="keywordtype">int</span> <a class="code" href="dirops__ew_8c.html#a4">rename_ew</a>( <span class="keywordtype">char</span> *path1, <span class="keywordtype">char</span> *path2 )
00262 {
00263    <span class="keywordflow">if</span> ( MoveFileEx( path1, path2, MOVEFILE_REPLACE_EXISTING ) == 0 )
00264       <span class="keywordflow">return</span> -1;
00265 
00266    <span class="keywordflow">return</span> 0;
00267 }
00268 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:00 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
