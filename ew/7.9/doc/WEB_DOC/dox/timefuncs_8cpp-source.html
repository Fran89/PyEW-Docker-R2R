<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>timefuncs.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>timefuncs.cpp</h1><a href="timefuncs_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#if defined(_Windows) || defined(_WINNT)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys\timeb.h&gt;</span>  <span class="comment">// ftime</span>
00004 <span class="preprocessor">#include &lt;windows.h&gt;</span> <span class="comment">// Sleep()</span>
00005 <span class="preprocessor">#else</span>
00006 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span> <span class="comment">// fprintf -- DELETE THIS LINE AFTER UNIX CODE TESTED</span>
00007 <span class="preprocessor">#include &lt;errno.h&gt;</span>  <span class="comment">// errno</span>
00008 <span class="preprocessor">#endif</span>
00009 <span class="preprocessor"></span>
00010 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00011 <span class="preprocessor">#include &lt;time.h&gt;</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="timefuncs_8h.html">timefuncs.h</a>"</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="worm__exceptions_8h.html">worm_exceptions.h</a>&gt;</span>
00015 
00016 <span class="comment">//---------------------------------------------------------------------------</span>
00017 
00018 <span class="preprocessor">#pragma package(smart_init)</span>
00019 <span class="preprocessor"></span>
<a name="l00020"></a><a class="code" href="classTTimeFuncs.html#p0">00020</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classTTimeFuncs.html#p0">TTimeFuncs::DOW</a>[7][4] = { <span class="stringliteral">"Sun"</span>, <span class="stringliteral">"Mon"</span>, <span class="stringliteral">"Tue"</span>, <span class="stringliteral">"Wed"</span>, <span class="stringliteral">"Thu"</span>, <span class="stringliteral">"Fri"</span>, <span class="stringliteral">"Sat"</span> };
00021 
<a name="l00022"></a><a class="code" href="classTTimeFuncs.html#p1">00022</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classTTimeFuncs.html#p1">TTimeFuncs::MOY</a>[12][4] = { <span class="stringliteral">"Jan"</span>, <span class="stringliteral">"Feb"</span>, <span class="stringliteral">"Mar"</span>, <span class="stringliteral">"Apr"</span>, <span class="stringliteral">"May"</span>, <span class="stringliteral">"Jun"</span>, <span class="stringliteral">"Jul"</span>, <span class="stringliteral">"Aug"</span>, <span class="stringliteral">"Sep"</span>, <span class="stringliteral">"Oct"</span>, <span class="stringliteral">"Nov"</span>, <span class="stringliteral">"Dec"</span> };
00023 
<a name="l00024"></a><a class="code" href="classTTimeFuncs.html#q0">00024</a> <span class="keyword">const</span> <span class="keywordtype">short</span> <a class="code" href="classTTimeFuncs.html#q0">TTimeFuncs::MONTH_STARTS</a>[2][12] =
00025 {
00026    { 1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335 }
00027   ,{ 1, 32, 61, 92, 122, 153, 183, 214, 245, 275, 306, 336 }
00028 };
00029 
00030 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00031"></a><a class="code" href="classTTimeFuncs.html#d0">00031</a> <a class="code" href="timefuncs_8h.html#a3">HIGHRES_TIME</a> <a class="code" href="classTTimeFuncs.html#d0">TTimeFuncs::GetHighResTime</a>()
00032 {
00033    <a class="code" href="timefuncs_8h.html#a3">HIGHRES_TIME</a> r_time;
00034 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00035 <span class="preprocessor"></span>   timeb _tb;
00036    ftime(&amp;_tb);
00037    r_time = (double)_tb.time + (double)_tb.millitm / 1000.0;
00038 <span class="preprocessor">#else</span>
00039 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> _needdebugwarning = <span class="keyword">true</span>;
00040 <span class="keywordflow">if</span> ( _needdebugwarning )
00041 {
00042    fprintf( stdout, <span class="stringliteral">"TTimeFuncs::GetHighResTime() NOT YET TESTED ON UNIX"</span> );
00043    _needdebugwarning = <span class="keyword">false</span>;
00044 }
00045    <span class="keyword">struct </span>timespec _ts;
00046 
00047    <span class="keywordflow">if</span>( clock_gettime( CLOCK_REALTIME, &amp;_ts ) == 0 )
00048    {
00049       r_time = (double) _ts.tv_sec + (double)_ts.tv_nsec*0.000000001;
00050    }
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>   <span class="keywordflow">return</span> r_time;
00053 }
00054 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00055"></a><a class="code" href="classTTimeFuncs.html#d1">00055</a> <span class="keywordtype">char</span>* <a class="code" href="classTTimeFuncs.html#d1">TTimeFuncs::DateString</a>( <span class="keywordtype">char</span>* r_buffer
00056                             , WORM_TIME_FORMAT p_format
00057                             , WORM_TIME_LOCALE p_locale <span class="comment">/* = WORM_GMT_TIME */</span>
00058                             , <span class="keywordtype">double</span> p_time             <span class="comment">/* = -1.0, means 'now' */</span>
00059                             )
00060 {
00061    time_t   _lowtime;
00062    <span class="keywordtype">int</span>      _millis = 0;
00063 
00064    <span class="comment">// Only use high-resolution time for those formats that require it</span>
00065    <span class="keywordflow">switch</span> ( p_format )
00066    {
00067      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a6">WORM_TIMEFMT_8</a>:
00068      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a7">WORM_TIMEFMT_14</a>:
00069      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a10">WORM_TIMEFMT_16</a>:
00070      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a9">WORM_TIMEFMT_UTC21</a>:
00071      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a11">WORM_TIMEFMT_19</a>:
00072      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a13">WORM_TIMEFMT_26</a>:
00073           <span class="keywordflow">if</span> ( p_time == -1.0 )
00074           {
00075              _lowtime = time(NULL);
00076           }
00077           <span class="keywordflow">else</span>
00078           {
00079              _lowtime = (int)p_time;
00080           }
00081           <span class="keywordflow">break</span>;
00082      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a8">WORM_TIMEFMT_18</a>:
00083      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a12">WORM_TIMEFMT_23</a>:
00084           <span class="keywordflow">if</span> ( p_time == -1.0 )
00085           {
00086              <span class="comment">// add .005 to prep for rounding to milliseconds</span>
00087              <span class="keywordtype">double</span> _hrtime = <a class="code" href="classTTimeFuncs.html#d0">GetHighResTime</a>() + 0.005;
00088              <span class="comment">// get the standard time type for structure conversion</span>
00089              _lowtime = (time_t)_hrtime;  <span class="comment">// strip off decimal portion</span>
00090              _millis  = (int)((_hrtime - _lowtime) * 100.0 );
00091           }
00092           <span class="keywordflow">else</span>
00093           {
00094              _lowtime = (time_t)p_time;  <span class="comment">// strip off decimal portion</span>
00095              _millis  = (int)((p_time - _lowtime) * 100.0 );
00096           }
00097           <span class="keywordflow">break</span>;
00098    }
00099 
00100    <span class="keyword">struct </span>tm* _tmstruct;
00101 
00102    <span class="keywordflow">switch</span>( p_locale )
00103    {
00104      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a14a4">WORM_GMT_TIME</a>:
00105           _tmstruct = gmtime(&amp;_lowtime);
00106           <span class="keywordflow">break</span>;
00107      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a14a5">WORM_LOCAL_TIME</a>:
00108           _tmstruct = localtime(&amp;_lowtime);
00109           <span class="keywordflow">break</span>;
00110    }
00111 
00112    <span class="keywordflow">switch</span>( p_format )
00113    {
00114      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a8">WORM_TIMEFMT_18</a>:  <span class="comment">// YYYYMMDDhhmmss.sss</span>
00115           sprintf( r_buffer
00116                  , <span class="stringliteral">"%4d%02d%02d%02d%02d%02d.%03d"</span>
00117                  ,  _tmstruct-&gt;tm_year + 1900
00118                  ,  _tmstruct-&gt;tm_mon  + 1
00119                  ,  _tmstruct-&gt;tm_mday
00120                  ,  _tmstruct-&gt;tm_hour
00121                  ,  _tmstruct-&gt;tm_min
00122                  ,  _tmstruct-&gt;tm_sec
00123                  , _millis
00124                  );
00125           <span class="keywordflow">break</span>;
00126      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a9">WORM_TIMEFMT_UTC21</a>:  <span class="comment">// YYYYMMDD_UTC_hh:mm:ss</span>
00127           sprintf( r_buffer
00128                  , <span class="stringliteral">"%4d%02d%02d_UTC_%02d:%02d:%02d"</span>
00129                  ,  _tmstruct-&gt;tm_year + 1900
00130                  ,  _tmstruct-&gt;tm_mon  + 1
00131                  ,  _tmstruct-&gt;tm_mday
00132                  ,  _tmstruct-&gt;tm_hour
00133                  ,  _tmstruct-&gt;tm_min
00134                  ,  _tmstruct-&gt;tm_sec
00135                  );
00136           <span class="keywordflow">break</span>;
00137      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a6">WORM_TIMEFMT_8</a>:  <span class="comment">// YYYYMMDD</span>
00138           sprintf( r_buffer
00139                  , <span class="stringliteral">"%4d%02d%02d"</span>
00140                  ,  _tmstruct-&gt;tm_year + 1900
00141                  ,  _tmstruct-&gt;tm_mon  + 1
00142                  ,  _tmstruct-&gt;tm_mday
00143                  );
00144           <span class="keywordflow">break</span>;
00145      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a7">WORM_TIMEFMT_14</a>:  <span class="comment">// YYYYMMDDhhmmss</span>
00146           sprintf( r_buffer
00147                  , <span class="stringliteral">"%4d%02d%02d%02d%02d%02d"</span>
00148                  ,  _tmstruct-&gt;tm_year + 1900
00149                  ,  _tmstruct-&gt;tm_mon  + 1
00150                  ,  _tmstruct-&gt;tm_mday
00151                  ,  _tmstruct-&gt;tm_hour
00152                  ,  _tmstruct-&gt;tm_min
00153                  ,  _tmstruct-&gt;tm_sec
00154                  );
00155           <span class="keywordflow">break</span>;
00156      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a10">WORM_TIMEFMT_16</a>:  <span class="comment">// YYYY/MM/DD hh:mm</span>
00157           sprintf( r_buffer
00158                  , <span class="stringliteral">"%4d/%02d/%02d %02d:%02d"</span>
00159                  ,  _tmstruct-&gt;tm_year + 1900
00160                  ,  _tmstruct-&gt;tm_mon  + 1
00161                  ,  _tmstruct-&gt;tm_mday
00162                  ,  _tmstruct-&gt;tm_hour
00163                  ,  _tmstruct-&gt;tm_min
00164                  );
00165           <span class="keywordflow">break</span>;
00166      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a11">WORM_TIMEFMT_19</a>:  <span class="comment">// YYYY/MM/DD hh:mm:ss</span>
00167           sprintf( r_buffer
00168                  , <span class="stringliteral">"%4d/%02d/%02d %02d:%02d:%02d"</span>
00169                  ,  _tmstruct-&gt;tm_year + 1900
00170                  ,  _tmstruct-&gt;tm_mon  + 1
00171                  ,  _tmstruct-&gt;tm_mday
00172                  ,  _tmstruct-&gt;tm_hour
00173                  ,  _tmstruct-&gt;tm_min
00174                  ,  _tmstruct-&gt;tm_sec
00175                  );
00176           <span class="keywordflow">break</span>;
00177      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a12">WORM_TIMEFMT_23</a>:  <span class="comment">// YYYY/MM/DD hh:mm:ss.sss</span>
00178           sprintf( r_buffer
00179                  , <span class="stringliteral">"%4d/%02d/%02d %02d:%02d:%02d.%03d"</span>
00180                  ,  _tmstruct-&gt;tm_year + 1900
00181                  ,  _tmstruct-&gt;tm_mon  + 1
00182                  ,  _tmstruct-&gt;tm_mday
00183                  ,  _tmstruct-&gt;tm_hour
00184                  ,  _tmstruct-&gt;tm_min
00185                  ,  _tmstruct-&gt;tm_sec
00186                  , _millis
00187                  );
00188           <span class="keywordflow">break</span>;
00189 
00190      <span class="keywordflow">case</span> <a class="code" href="timefuncs_8h.html#a15a13">WORM_TIMEFMT_26</a>:
00191           sprintf( r_buffer
00192                  , <span class="stringliteral">"%s %s %02d %02d:%02d:%02d %04d\n"</span>
00193                  , DOW[_tmstruct-&gt;tm_wday]
00194                  , MOY[_tmstruct-&gt;tm_mon]
00195                  ,  _tmstruct-&gt;tm_mday
00196                  ,  _tmstruct-&gt;tm_hour
00197                  ,  _tmstruct-&gt;tm_min
00198                  ,  _tmstruct-&gt;tm_sec
00199                  ,  _tmstruct-&gt;tm_year + 1900
00200                  );
00201           <span class="keywordflow">break</span>;
00202    }
00203 
00204    <span class="keywordflow">return</span> r_buffer;
00205 }
00206 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00207"></a><a class="code" href="classTTimeFuncs.html#d2">00207</a> <span class="keywordtype">double</span> <a class="code" href="classTTimeFuncs.html#d2">TTimeFuncs::TimeToDouble</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_buffer )
00208 {
00209    <span class="keywordtype">double</span> r_dbl;
00210 
00211    <span class="keywordflow">if</span> ( p_buffer == NULL )
00212    {
00213       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TTimeFuncs::TimeToDouble(): string parameter was NULL"</span>);
00214    }
00215 
00216    <span class="comment">// expecting "YYYYMMDDHHMMSS.sss"</span>
00217    <span class="comment">//            0123456789012345678</span>
00218    <span class="keywordflow">if</span> ( strlen(p_buffer) != 18 )
00219    {
00220       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TTimeFuncs::TimeToDouble(): string parameter invalid length"</span>);
00221    }
00222 
00223    <span class="keywordtype">char</span> _timestr[18];
00224    <span class="keywordtype">char</span> _work[5];
00225    <span class="keywordtype">char</span> * _stringptr;
00226    <span class="keyword">struct </span>tm time_check;
00227 
00228 
00229    strcpy( _timestr, p_buffer );
00230 
00231    _stringptr = _timestr;
00232 
00233    <span class="comment">// year</span>
00234    strncpy( _work, _stringptr, 4 );
00235    _work[4] = <span class="charliteral">'\0'</span>;
00236    time_check.tm_year = atoi(_work) - 1900;
00237 
00238    <span class="comment">// month</span>
00239    _stringptr += 4;
00240    strncpy( _work, _stringptr, 2 );
00241    _work[2] = <span class="charliteral">'\0'</span>;
00242    time_check.tm_mon  = atoi(_work) - 1;
00243 
00244    <span class="comment">// day</span>
00245    _stringptr += 2;
00246    strncpy( _work, _stringptr, 2 );
00247    time_check.tm_mday = atoi(_work);
00248 
00249    <span class="comment">// hour</span>
00250    _stringptr += 2;
00251    strncpy( _work, _stringptr, 2 );
00252    time_check.tm_hour = atoi(_work);
00253 
00254    <span class="comment">// minute</span>
00255    _stringptr += 2;
00256    strncpy( _work, _stringptr, 2 );
00257    time_check.tm_min = atoi(_work);
00258 
00259    <span class="comment">// second</span>
00260    _stringptr += 2;
00261    strncpy( _work, _stringptr, 2 );
00262    time_check.tm_sec = atoi(_work);
00263 
00264    time_check.tm_isdst = -1;
00265 
00266 
00267    <span class="comment">// millisecond</span>
00268    _stringptr += 3;
00269    strncpy( _work, _stringptr, 3 );
00270 
00271 
00272    r_dbl = (double)mktime(&amp;time_check) + ((double)atoi(_work) / 1000.0);
00273 
00274    <span class="keywordflow">return</span> r_dbl;
00275 }
00276 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00277"></a><a class="code" href="classTTimeFuncs.html#d3">00277</a> <span class="keywordtype">void</span> <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p_msec )
00278 {
00279 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00280 <span class="preprocessor"></span>   Sleep(p_msec);
00281 <span class="preprocessor">#else</span>
00282 <span class="preprocessor"></span>   <span class="keyword">struct </span>timespec sleeptime;
00283    <span class="keyword">struct </span>timespec timeleft;
00284    <span class="keywordtype">int</span> err;
00285 
00286    sleeptime.tv_sec = (time_t) p_msec / 1000;
00287    sleeptime.tv_nsec = (long) (1000000 * (p_msec % 1000));
00288 
00289    <span class="keywordflow">while</span>( nanosleep(&amp;sleeptime, &amp;timeleft) != 0 )
00290    {
00291       <span class="keywordflow">if</span> ( (err = errno) == EINTR)
00292       {
00293         <span class="comment">/*printf( "sleep_ew: interrupted by signal;" );*/</span><span class="comment">/*DEBUG*/</span> 
00294         <span class="comment">/*printf( " %d msec left\n",</span>
00295 <span class="comment">                (int) (timeleft.tv_sec*1000 + timeleft.tv_nsec/1000000) );*/</span><span class="comment">/*DEBUG*/</span>
00296         sleeptime = timeleft;
00297       }
00298       <span class="keywordflow">else</span>
00299       {
00300          fprintf(stderr, <span class="stringliteral">"sleep_ew: error from nanosleep: %s\n"</span>,
00301                  strerror(err));
00302          fprintf(stderr,<span class="stringliteral">"\ttime requested = %.3f sec, time left = %.3f sec\n"</span>,
00303                  sleeptime.tv_sec + sleeptime.tv_nsec*1.e-9,
00304                  timeleft.tv_sec + timeleft.tv_nsec*1.e-9);
00305        }
00306    }
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>}
00309 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00310"></a><a class="code" href="classTTimeFuncs.html#d4">00310</a> <span class="keywordtype">bool</span> <a class="code" href="classTTimeFuncs.html#d4">TTimeFuncs::IsLeapyear</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p_year )
00311 {
00312    <span class="keywordflow">if</span> ( p_year % 4 != 0 )
00313    {
00314       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00315    }
00316 
00317    <span class="keywordflow">if</span> ( p_year % 400 == 0 )
00318    {
00319       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00320    }
00321 
00322    <span class="keywordflow">if</span> ( p_year % 100 == 0 )
00323    {
00324       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00325    }
00326 
00327    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00328 }
00329 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00330"></a><a class="code" href="classTTimeFuncs.html#d5">00330</a> <span class="keywordtype">bool</span> <a class="code" href="classTTimeFuncs.html#d5">TTimeFuncs::YearJulianToMonDay</a>( <span class="keywordtype">short</span>   p_year
00331                                    , <span class="keywordtype">short</span>   p_julday
00332                                    , <span class="keywordtype">short</span> * r_monthnum
00333                                    , <span class="keywordtype">short</span> * r_monthday
00334                                    )
00335 {
00336    <span class="keywordflow">if</span> (   p_julday &lt; 1
00337        || r_monthnum == NULL
00338        || r_monthday == NULL
00339       )
00340    {
00341       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00342    }
00343 
00344    <span class="comment">// get MONTH_STARTS[x][] index</span>
00345    <span class="keywordtype">int</span> _yt =  ( <a class="code" href="classTTimeFuncs.html#d4">IsLeapyear</a>(p_year) ? 1 : 0 );
00346    <span class="keywordtype">int</span> _mi = 0;
00347 
00348    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _m = 0 ; _m &lt; 12 ; _m++ )
00349    {
00350       <span class="keywordflow">if</span> ( <a class="code" href="classTTimeFuncs.html#q0">MONTH_STARTS</a>[_yt][_m] &lt;= p_julday )
00351       {
00352          _mi = _m;
00353          <span class="keywordflow">continue</span>;
00354       }
00355       <span class="keywordflow">break</span>;
00356    }
00357 
00358    *r_monthday = p_julday - <a class="code" href="classTTimeFuncs.html#q0">MONTH_STARTS</a>[_yt][_mi] + 1;
00359 
00360    *r_monthnum = _mi + 1;
00361 
00362    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00363 }
00364 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00365"></a><a class="code" href="classTTimeFuncs.html#d6">00365</a> <span class="keywordtype">bool</span> <a class="code" href="classTTimeFuncs.html#d6">TTimeFuncs::CrackDate</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_buffer    <span class="comment">// "YYYYMMDD...."</span>
00366                           , <span class="keywordtype">short</span>      * r_year      <span class="comment">// 1900....</span>
00367                           , <span class="keywordtype">short</span>      * r_monthnum  <span class="comment">// 1 - 12</span>
00368                           , <span class="keywordtype">short</span>      * r_monthday  <span class="comment">// 1 - 31</span>
00369                           , <span class="keywordtype">short</span>      * r_year2     <span class="comment">// 0....</span>
00370                           , <span class="keywordtype">short</span>      * r_julday    <span class="comment">// 1 - 366</span>
00371                           , <span class="keywordtype">bool</span>       * r_isleap    <span class="comment">// is it a leap year</span>
00372                           )
00373 {
00374    <span class="keywordflow">if</span> (   p_buffer == NULL || strlen(p_buffer) &lt; 8
00375        || r_year     == NULL
00376        || r_monthnum == NULL
00377        || r_monthday == NULL
00378       )
00379    {
00380       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00381    }
00382 
00383    <span class="keywordtype">bool</span> _isleap;
00384 
00385    <span class="keywordtype">char</span> _wrk[9];
00386 
00387    <span class="comment">//  YYYYMMDD....</span>
00388    <span class="comment">//  012345678</span>
00389 
00390    strncpy( _wrk, p_buffer, 8 );
00391    _wrk[8] = <span class="charliteral">'\0'</span>;
00392 
00393    *r_monthday = atoi( _wrk + 6 );
00394 
00395 
00396    _wrk[6] = <span class="charliteral">'\0'</span>;
00397 
00398    *r_monthnum = atoi( _wrk + 4 );
00399 
00400 
00401    _wrk[4] = <span class="charliteral">'\0'</span>;
00402 
00403    *r_year = atoi( _wrk );
00404 
00405    <span class="keywordflow">if</span> ( r_year2 != NULL )
00406    {
00407       *r_year2 = atoi( _wrk + 2 );
00408    }
00409 
00410    <span class="keywordflow">if</span> ( r_julday != NULL )
00411    {
00412       _isleap = <a class="code" href="classTTimeFuncs.html#d4">IsLeapyear</a>( *r_year );
00413 
00414       <span class="keywordflow">if</span> ( r_isleap != NULL )
00415       {
00416          *r_isleap = _isleap;
00417       }
00418 
00419       *r_julday = <a class="code" href="classTTimeFuncs.html#q0">TTimeFuncs::MONTH_STARTS</a>[(_isleap ? 1 : 0)][(*r_monthnum) - 1]
00420                 + *r_monthday
00421                 - 1
00422               ;
00423    }
00424 
00425    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00426 }
00427 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00428"></a><a class="code" href="classTTimeFuncs.html#d7">00428</a> <span class="keywordtype">bool</span> <a class="code" href="classTTimeFuncs.html#d7">TTimeFuncs::CrackTime</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_buffer <span class="comment">// "HHMMSS.sss" or "........HHMMSS.sss"</span>
00429                           , <span class="keywordtype">short</span>      * r_hour
00430                           , <span class="keywordtype">short</span>      * r_min
00431                           , <span class="keywordtype">short</span>      * r_sec
00432                           , <span class="keywordtype">short</span>      * r_msec
00433                           , <span class="keywordtype">double</span>     * r_fpsec
00434                           )
00435 {
00436    <span class="keywordflow">if</span> ( p_buffer == NULL || r_hour == NULL || r_min == NULL )
00437    {
00438       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00439    }
00440 
00441    <span class="keywordflow">if</span> ( strlen(p_buffer) != 10 &amp;&amp; strlen(p_buffer) != 18 )
00442    {
00443       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00444    }
00445 
00446    <span class="keyword">const</span> <span class="keywordtype">char</span>  * _pointer = ( strlen(p_buffer) == 10 ? p_buffer : (p_buffer + 8) );
00447 
00448    <span class="keywordtype">char</span>   _wrk[4];
00449 
00450    <span class="keywordflow">if</span> ( _pointer[6] != <span class="charliteral">'.'</span> )
00451    {
00452       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00453    }
00454 
00455    _wrk[0] = _pointer[0];
00456    _wrk[1] = _pointer[1];
00457    _wrk[2] = <span class="charliteral">'\0'</span>;
00458    *r_hour = atoi(_wrk);
00459 
00460 
00461    _wrk[0] = _pointer[2];
00462    _wrk[1] = _pointer[3];
00463    _wrk[2] = <span class="charliteral">'\0'</span>;
00464    *r_min = atoi(_wrk);
00465 
00466    <span class="keywordflow">if</span> ( r_sec != NULL )
00467    {
00468       <span class="keywordtype">int</span> _sec
00469         , _msec
00470         ;
00471 
00472       _wrk[0] = _pointer[4];
00473       _wrk[1] = _pointer[5];
00474       _wrk[2] = <span class="charliteral">'\0'</span>;
00475       _sec = atoi(_wrk);
00476 
00477       <span class="keywordflow">if</span> ( r_sec != 0 )
00478       {
00479          *r_sec = _sec;
00480       }
00481 
00482       _wrk[0] = _pointer[7];
00483       _wrk[1] = _pointer[8];
00484       _wrk[2] = _pointer[9];
00485       _wrk[3] = <span class="charliteral">'\0'</span>;
00486       _msec = atoi(_wrk);
00487 
00488       <span class="keywordflow">if</span> ( r_msec != 0 )
00489       {
00490          *r_msec = _msec;
00491       }
00492 
00493       <span class="keywordflow">if</span> ( r_fpsec != NULL &amp;&amp; r_msec != 0 )
00494       {
00495          *r_msec = (double)_sec + ((double)_msec) / 1000.0;
00496       }
00497    }
00498 
00499    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00500 }
00501 <span class="comment">//---------------------------------------------------------------------------</span>
00502 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:11 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
