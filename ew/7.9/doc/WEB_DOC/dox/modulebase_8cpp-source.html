<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>modulebase.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>modulebase.cpp</h1><a href="modulebase_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#pragma hdrstop</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00005 <span class="preprocessor"></span>
00006 <span class="preprocessor">#include &lt;windows.h&gt;</span>  <span class="comment">// SetCurrentDirectory</span>
00007 
00008 <span class="preprocessor">#elif defined(SOLARIS)</span>
00009 <span class="preprocessor"></span>
00010 <span class="preprocessor">#include &lt;unistd.h&gt;</span>  <span class="comment">// chdir()</span>
00011 
00012 <span class="preprocessor">#else</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#error modulemase.cpp not completed for this O/S</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00015 <span class="preprocessor"></span>
00016 
00017 <span class="preprocessor">#include "<a class="code" href="modulebase_8h.html">modulebase.h</a>"</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="worm__environ_8h.html">worm_environ.h</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="worm__exceptions_8h.html">worm_exceptions.h</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="timefuncs_8h.html">timefuncs.h</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;<a class="code" href="comfile_8h.html">comfile.h</a>&gt;</span>
00023 
00024 
00025 
00026 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00027"></a><a class="code" href="classTModuleBase.html#a1">00027</a> <a class="code" href="classTModuleBase.html#a1">TModuleBase::TModuleBase</a>( <span class="keywordtype">char</span> * p_programname
00028                         , <span class="keywordtype">char</span> * p_configfilename
00029                         )
00030                         : <a class="code" href="classTConfigurable.html">TConfigurable</a>()
00031                         , <a class="code" href="classThreadableObject.html">ThreadableObject</a>()
00032 {
00033 
00034    <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00035    <a class="code" href="classTModuleBase.html#n11">LastBeat</a> = 0;
00036 
00037    <a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a> = <a class="code" href="modulebase_8h.html#a0">DEF_LOOP_SLEEP_MS</a>;
00038 
00039    <a class="code" href="classTModuleBase.html#n7">CommandRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00040    <a class="code" href="classTModuleBase.html#n8">CommandRing</a>    = NULL;
00041 
00042    <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a> = NULL;
00043 
00044    <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a> = NULL;
00045    <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>     = NULL;
00046 
00047    <span class="keywordflow">try</span>
00048    {
00049       <span class="keywordflow">if</span> ( p_configfilename == NULL )
00050       {
00051          strcpy ( ConfigFileName, <span class="stringliteral">""</span> );
00052       }
00053       <span class="keywordflow">else</span>
00054       {
00055          strcpy ( ConfigFileName, p_configfilename );
00056       }
00057 
00058 
00059       <span class="comment">// ----- Get the global utilites and parse the command file -----------</span>
00060 
00061       <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a> = <span class="keyword">new</span> <a class="code" href="classTGlobalUtils.html">TGlobalUtils</a>(p_programname)) == NULL )
00062       {
00063          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating global utilities object"</span>);
00064       }
00065 
00066 
00067       <span class="comment">// Change working directory to environment variable EW_PARAMS value</span>
00068       <span class="keywordtype">char</span> * runPath;
00069 
00070       <span class="keywordtype">bool</span> _isEW = <span class="keyword">false</span>;
00071 
00072       <span class="keywordflow">if</span> ( (runPath = <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>( WORM_CONFIG_DIR )) == NULL )
00073       {
00074          _isEW = <span class="keyword">true</span>;
00075          runPath = <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>( EW_CONFIG_DIR );
00076       }
00077 
00078       <span class="keywordflow">if</span> ( runPath == NULL )
00079       {
00080          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Neither environment variable &lt;"</span> );
00081          _expt += <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>;
00082          _expt += <span class="stringliteral">"&gt; nor &lt;"</span>;
00083          _expt += <a class="code" href="worm__environ_8h.html#a7">EW_CONFIG_DIR</a>;
00084          _expt += <span class="stringliteral">"&gt; is defined"</span>;
00085          <span class="keywordflow">throw</span> _expt;
00086       }
00087 
00088       <span class="keywordflow">if</span> ( *runPath == <span class="charliteral">'\0'</span> )
00089       {
00090          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Environment variable "</span> );
00091          _expt += (_isEW ? <a class="code" href="worm__environ_8h.html#a7">EW_CONFIG_DIR</a> : <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>);
00092          _expt += <span class="stringliteral">" defined, but has no value"</span>;
00093          <span class="keywordflow">throw</span> _expt;
00094       }
00095 
00096 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00097 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( ! SetCurrentDirectory( runPath ) )
00098 <span class="preprocessor">#elif defined(SOLARIS)</span>
00099 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( chdir( runPath ) == -1 )
00100 <span class="preprocessor">#else</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#error TModuleBase() changing directory not implemented for this O/S</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00103 <span class="preprocessor"></span>      {
00104          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Params directory not found: "</span> );
00105          _expt += runPath;
00106          _expt += <span class="stringliteral">"\nPlease set environment variable "</span>;
00107          _expt += <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>;
00108          <span class="keywordflow">throw</span> _expt;
00109       }
00110 
00111    }
00112    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00113    {
00114       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00115                     , <span class="stringliteral">"TModuleBase() ERROR:  %s\n"</span>
00116                     , _we.what()
00117                     );
00118       <span class="keywordflow">throw</span> _we;
00119    }
00120    <span class="keywordflow">catch</span>( ... )
00121    {
00122       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00123                     , <span class="stringliteral">"TModuleBase(): Unidentifed Exception\n"</span>
00124                     );
00125       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TModuleBase(): unidentified exception"</span>);
00126    }
00127 }
00128 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00129"></a><a class="code" href="classTModuleBase.html#a2">00129</a> <a class="code" href="classTModuleBase.html#a2">TModuleBase::~TModuleBase</a>()
00130 {
00131    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n8">CommandRing</a> != NULL )
00132    {
00133       <span class="keyword">delete</span>( CommandRing );
00134       <a class="code" href="classTModuleBase.html#n8">CommandRing</a> = NULL;
00135    }
00136    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a> != NULL )
00137    {
00138       <span class="keyword">delete</span>( MyGlobalUtils );
00139       <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a> = NULL;
00140    }
00141    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a> != NULL )
00142    {
00143       <span class="keyword">delete</span>( HeartbeatMsg );
00144       <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a> = NULL;
00145    }
00146    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a> != NULL )
00147    {
00148       <span class="keyword">delete</span>( ErrorMsg );
00149       <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a> = NULL;
00150    }
00151 }
00152 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00153"></a><a class="code" href="classTModuleBase.html#b0">00153</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classTModuleBase.html#b0">TModuleBase::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00154 {
00155    <span class="comment">// Do not manipulate ConfigState herein.</span>
00156 
00157    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_handled = <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a>-&gt;<a class="code" href="classTGlobalUtils.html#a1">HandleConfigLine</a>(p_parser);
00158 
00159    <span class="keywordflow">if</span> ( r_handled == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00160    {
00161       <span class="keywordflow">try</span>
00162       {
00163          <span class="keywordtype">char</span> * _token;
00164 
00165          r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00166 
00167          <span class="keywordflow">do</span>
00168          {
00169 
00170             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"CmdRingName"</span>) )
00171             {
00172                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00173                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00174                {
00175                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;CmdRingName&gt; value"</span>);
00176                }
00177 
00178                <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n7">CommandRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(_token)) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00179                {
00180                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;CmdRingName&gt; value"</span>);
00181                }
00182 
00183                <span class="keywordflow">continue</span>;
00184             }
00185 
00186             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"LoopSleepMS"</span>) )
00187             {
00188                <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00189                {
00190                   <a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a> = <a class="code" href="modulebase_8h.html#a0">DEF_LOOP_SLEEP_MS</a>;
00191                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;LoopSleepMS&gt; value"</span>);
00192                }
00193                <span class="keywordflow">continue</span>;
00194             }
00195 
00196             r_handled = <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a>;
00197 
00198          } <span class="keywordflow">while</span> ( false );
00199       }
00200       <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00201       {
00202          r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00203          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00204                       , <span class="stringliteral">"TModuleBase::HandleConfigLine(): configuration error: %s\nin line: %s\n"</span>                      , _we.what()
00205                       , p_parser-&gt;<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00206                       );
00207       }
00208    }
00209 
00210    <span class="keywordflow">return</span> r_handled;
00211 }
00212 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00213"></a><a class="code" href="classTModuleBase.html#b1">00213</a> <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b1">TModuleBase::CheckConfig</a>()
00214 {
00215 
00216    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a> == NULL )
00217    {
00218       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00219                     , <span class="stringliteral">"TModuleBase::CheckConfig(): Global Configurations object not created\n"</span>
00220                     );
00221       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00222    }
00223    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! <a class="code" href="classTModuleBase.html#n2">MyGlobalUtils</a>-&gt;<a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00224    {
00225       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00226                     , <span class="stringliteral">"TModuleBase::CheckConfig(): Global Configurations object not configured\n"</span>
00227                     );
00228       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00229    }
00230 
00231    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00232    {
00233       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00234                     , <span class="stringliteral">"TModuleBase::CheckConfig(): No &lt;HeartBeatInt&gt; value from the config file\n"</span>
00235                     );
00236       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00237    }
00238 
00239    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n7">CommandRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00240    {
00241       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00242                     , <span class="stringliteral">"TModuleBase::CheckConfig(): No &lt;CmdRingName&gt; value from the config file\n"</span>
00243                     );
00244       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00245    }
00246 
00247    <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a> &lt; 10 || 30000 &lt; <a class="code" href="classTModuleBase.html#n6">LoopSleepMS</a> )
00248    {
00249       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00250                     , <span class="stringliteral">"TModuleBase::CheckConfig(): &lt;LoopSleepMS&gt; value (%d) must be in range 10 - 30000\n"</span>
00251                     , LoopSleepMS
00252                     );
00253       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00254    }
00255 
00256    <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n3">TYPE_ERROR</a> = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_ERROR"</span>)) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00257    {
00258       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00259                     , <span class="stringliteral">"TModuleBase::CheckConfig(): TYPE_ERROR not found in config files\n"</span>
00260                     , LoopSleepMS
00261                     );
00262       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00263    }
00264 
00265    <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n4">TYPE_HEARTBEAT</a> = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_HEARTBEAT"</span>)) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00266    {
00267       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00268                     , <span class="stringliteral">"TModuleBase::CheckConfig(): TYPE_HEARTBEAT not found in config files\n"</span>
00269                     , LoopSleepMS
00270                     );
00271       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00272    }
00273 }
00274 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00275"></a><a class="code" href="classTModuleBase.html#b2">00275</a> <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b2">TModuleBase::SendStatus</a>( WORM_MSGTYPE_ID   p_type
00276                             , <span class="keywordtype">short</span>             p_ierr
00277                             , <span class="keyword">const</span> <span class="keywordtype">char</span>      * p_text
00278                             )
00279 {
00280    TMessageBase * _msg = NULL;
00281 
00282    <span class="keywordflow">try</span>
00283    {
00284       <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n8">CommandRing</a> == NULL )
00285       {
00286          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Command Ring is NULL"</span>);
00287       }
00288 
00289       <span class="keywordflow">if</span>      ( p_type == <a class="code" href="classTModuleBase.html#n4">TYPE_HEARTBEAT</a> )
00290       {
00291          <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a>-&gt;SetTime();
00292          _msg = <a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a>;
00293       }
00294       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( p_type == <a class="code" href="classTModuleBase.html#n3">TYPE_ERROR</a> )
00295       {
00296          <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>-&gt;SetTime();
00297          <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>-&gt;SetErrorCode(p_ierr);
00298          <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>-&gt;SetText(p_text);
00299          _msg = <a class="code" href="classTModuleBase.html#n10">ErrorMsg</a>;
00300       }
00301       <span class="keywordflow">else</span>
00302       {
00303          <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"invalid message type "</span>):
00304                         _expt += (int)p_type;
00305          <span class="keywordflow">throw</span> _expt;
00306       }
00307 
00308       <span class="keywordflow">if</span> ( _msg != NULL )
00309       {
00310          <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#n8">CommandRing</a>-&gt;PutMessage(*_msg) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00311          {
00312             <span class="keywordflow">if</span>( p_type == <a class="code" href="classTModuleBase.html#n4">TYPE_HEARTBEAT</a> )
00313             {
00314                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Error sending heartbeat."</span> );
00315             }
00316             <span class="keywordflow">else</span> <span class="comment">// if( p_type == TYPE_ERROR )</span>
00317             {
00318                <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Error sending error: "</span>); 
00319                               _expt += (int)p_ierr;
00320                <span class="keywordflow">throw</span> _expt;
00321             }
00322          }
00323       }
00324    }
00325    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00326    {
00327       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00328                     , <span class="stringliteral">"TModuleBase::SendStatus() Error: %s\n"</span>
00329                     , _we.what()
00330                     );
00331    }
00332    <span class="keywordflow">catch</span>( ... )
00333    {
00334       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00335                     , <span class="stringliteral">"TModuleBase::SendStatus() Error\n"</span>
00336                     );
00337       <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00338    }
00339 }
00340 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00341"></a><a class="code" href="classTModuleBase.html#b4">00341</a> <span class="keywordtype">void</span> <a class="code" href="classTModuleBase.html#b4">TModuleBase::Heartbeat</a>()
00342 {
00343    <span class="keyword">static</span> <span class="keywordtype">long</span> _interval = <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>();
00344 
00345    <span class="keywordflow">if</span> ( 0 &lt; _interval )
00346    {
00347       <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n11">LastBeat</a> + _interval) &lt; time(NULL) )
00348       {
00349          <a class="code" href="classTModuleBase.html#b2">SendStatus</a>(TYPE_HEARTBEAT);
00350          <a class="code" href="classTModuleBase.html#n11">LastBeat</a> = time(NULL);
00351       }
00352    }
00353 }
00354 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00355"></a><a class="code" href="classTModuleBase.html#a3">00355</a> <span class="keywordtype">int</span> <a class="code" href="classTModuleBase.html#a3">TModuleBase::Run</a>()
00356 {
00357    <span class="keywordtype">int</span> r_status = 0;
00358 
00359    <a class="code" href="classTComFileParser.html">TComFileParser</a> * _parser = NULL;
00360 
00361    <span class="keywordflow">try</span>
00362    {
00363 
00364       <span class="comment">// check for this module's configuration file</span>
00365       <span class="keywordflow">if</span> ( (_parser = <span class="keyword">new</span> <a class="code" href="classTComFileParser.html">TComFileParser</a>()) == NULL )
00366       {
00367          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating parser for configuration file"</span>);
00368       }
00369 
00370 
00371       <span class="keywordflow">if</span> ( strlen(ConfigFileName) == 0 )
00372       {
00373          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00374                        , <span class="stringliteral">"%s.main(): using default configuration file %s\n"</span>
00375                        , TGlobalUtils::GetProgramName()
00376                        , <a class="code" href="classTModuleBase.html#b3">GetDefaultConfigFile</a>()
00377                        );
00378          strcpy ( ConfigFileName, <a class="code" href="classTModuleBase.html#b3">GetDefaultConfigFile</a>() );
00379       }
00380 
00381 
00382       <span class="keywordflow">if</span> ( ! _parser-&gt;<a class="code" href="classTComFileParser.html#a2">Open</a>(ConfigFileName) )
00383       {
00384          <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"failed opening configuration file: "</span>);
00385          _expt += <a class="code" href="classTModuleBase.html#n5">ConfigFileName</a>;
00386          <span class="keywordflow">throw</span> _expt;
00387       }
00388 
00389 
00390       <span class="keywordtype">bool</span> _parsing = <span class="keyword">true</span>;
00391 
00392       <span class="keywordflow">do</span>
00393       {
00394          <span class="keywordflow">switch</span> ( _parser-&gt;<a class="code" href="classTComFileParser.html#a5">ReadLine</a>() )
00395          {
00396            <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>:
00397                 {
00398                    <span class="keywordtype">char</span> * _errortxt;
00399                    _parser-&gt;<a class="code" href="classConfigSource.html#a10">Error</a>( &amp;_errortxt );
00400                    <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Error while parsing config file "</span> );
00401                    _expt += <a class="code" href="classTModuleBase.html#n5">ConfigFileName</a>;
00402                    _expt += <span class="stringliteral">"\n"</span>;
00403                    _expt += _errortxt;
00404                    <span class="keywordflow">throw</span> _expt;
00405                 }
00406 
00407            <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>:
00408                 _parsing = <span class="keyword">false</span>;
00409                 <span class="keywordflow">break</span>;
00410 
00411            <span class="keywordflow">default</span>:
00412 
00413                 (<span class="keywordtype">void</span> *)_parser-&gt;<a class="code" href="classConfigSource.html#a5">NextToken</a>();
00414 
00415                 <span class="comment">// check if the derivative class uses the configuration line</span>
00416                 <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#b0">HandleConfigLine</a>(_parser) == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00417                 {
00418                    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT
00419                                  , <span class="stringliteral">"unrecognized command in line:\n%s\n%s\n%s\n"</span>
00420                                  , _parser-&gt;<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00421                                  , <span class="stringliteral">"while parsing config file:"</span>
00422                                  , <a class="code" href="classTModuleBase.html#n5">ConfigFileName</a>
00423                                  );
00424                 }
00425                 
00426                 <span class="keywordflow">break</span>;
00427 
00428          } <span class="comment">// switch()</span>
00429 
00430       } <span class="keywordflow">while</span>(_parsing);
00431 
00432 
00433       <span class="keyword">delete</span>( _parser );
00434       _parser = NULL;
00435 
00436 
00437       <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n9">HeartbeatMsg</a> = <span class="keyword">new</span> THeartbeatMessage( TGlobalUtils::GetThisInstallationId()
00438                                                 , TGlobalUtils::GetThisModuleId()
00439                                                 ) ) == NULL )
00440       {
00441          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating heartbeat message object"</span>);
00442       }
00443 
00444 
00445       <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n10">ErrorMsg</a> = <span class="keyword">new</span> TErrorMessage( TGlobalUtils::GetThisInstallationId()
00446                                         , TGlobalUtils::GetThisModuleId()
00447                                         ) ) == NULL )
00448       {
00449          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating error message object"</span>);
00450       }
00451 
00452       <span class="keywordflow">if</span> ( ! <a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00453       {
00454          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>( <span class="stringliteral">"Module is not configured, must exit"</span>);
00455       }
00456 
00457       <span class="comment">// global logging level might have been overriden in config file</span>
00458       <span class="comment">//</span>
00459       <a class="code" href="classTModuleBase.html#n1">LoggingLevel</a> = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>();
00460 
00461 <span class="preprocessor">#ifdef SOLARIS</span>
00462 <span class="preprocessor"></span>      <span class="comment">// Set our "nice" value back to the default value.</span>
00463       <span class="comment">// This does nothing if you started at the default.</span>
00464       <span class="comment">// Requested by D. Chavez, University of Utah.</span>
00465       <span class="comment">//</span>
00466       nice( -nice( 0 ) );
00467 
00468       <span class="comment">// Catch process termination signals</span>
00469       <span class="comment">//</span>
00470       sigignore( SIGINT );             <span class="comment">/* Control-c */</span>
00471       sigignore( SIGQUIT );            <span class="comment">/* Control-\ */</span>
00472       sigset( SIGTERM, SigtermHandler );
00473 
00474       <span class="comment">// Catch tty input signal, in case we are in background</span>
00475       sigignore( SIGTTIN );
00476 <span class="preprocessor">#endif</span>
00477 <span class="preprocessor"></span>
00478 
00479       <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n0">Running</a> = <a class="code" href="classTModuleBase.html#b5">PrepareToRun</a>()) == <span class="keyword">true</span> )
00480       {
00481          <span class="keywordflow">if</span> ( (<a class="code" href="classTModuleBase.html#n8">CommandRing</a> = <span class="keyword">new</span> TRingWriter(CommandRingKey)) == NULL )
00482          {
00483             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>( <span class="stringliteral">"Failed creating command ring writer, must exit"</span>);
00484          }
00485       }
00486 
00487       <span class="keywordtype">int</span> _flag;
00488 
00489       <span class="keywordflow">while</span>( Running )
00490       {
00491          <span class="keywordflow">if</span> ( <a class="code" href="classTModuleBase.html#b6">CheckForFatal</a>() )
00492          {
00493             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00494             {
00495                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00496                              , <span class="stringliteral">"TModuleBase::Run(): Worker thread reported fatal error\n"</span>
00497                              );
00498             }
00499             <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00500          }
00501          <span class="keywordflow">else</span>
00502          {
00503             _flag = <a class="code" href="classTModuleBase.html#n8">CommandRing</a>-&gt;GetFlag();
00504 
00505             <span class="keywordflow">if</span> (   _flag == WORM_STOP_ALL_MODULES
00506                 || _flag == <a class="code" href="classTGlobalUtils.html#d7">TGlobalUtils::GetThisModuleId</a>()
00507                )
00508             {
00509                <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a10">WORM_LOG_STATUS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00510                {
00511                   <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT|WORM_LOG_TIMESTAMP
00512                                 , <span class="stringliteral">"TModuleBase::Run(): Shutting down\n"</span>
00513                                 );
00514                }
00515                <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00516             }
00517             <span class="keywordflow">else</span>
00518             {
00519                <a class="code" href="classTModuleBase.html#b4">Heartbeat</a>();
00520 
00521                <span class="keywordflow">switch</span> ( <a class="code" href="classTModuleBase.html#b7">MainThreadActions</a>() )
00522                {
00523                  <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a8">WORM_STAT_NOMATCH</a>:
00524                       <span class="comment">// No actions to take at this time, sleep for a bit</span>
00525                       <span class="comment">// waiting for the situation to change.</span>
00526                       <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(LoopSleepMS);
00527 
00528                  <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>:
00529                       <span class="comment">// Commonly, successful processing indicates that an</span>
00530                       <span class="comment">// incoming message was handled.  Since there might</span>
00531                       <span class="comment">// be other messages pending, don't sleep, return to</span>
00532                       <span class="comment">// look for another one.</span>
00533                       <span class="keywordflow">break</span>;
00534 
00535                  <span class="keywordflow">case</span> <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>:
00536                       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00537                       {
00538                          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00539                                        , <span class="stringliteral">"TModuleBase::Run(): Main thread reported fatal error\n"</span>
00540                                        );
00541                       }
00542                       r_status = -1;
00543                       <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00544                       <span class="keywordflow">break</span>;
00545                }
00546             }
00547          }
00548 
00549       }
00550 
00551       <a class="code" href="classTModuleBase.html#b8">FinishedRunning</a>();
00552 
00553    }
00554    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00555    {
00556       <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00557       {
00558          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00559                        , <span class="stringliteral">"TModuleBase::Run() Error: %s\n"</span>
00560                        , _we.what()
00561                        );
00562       }
00563       r_status = -1;
00564       <span class="comment">// Some lower-level exceptions might end up here without</span>
00565       <span class="comment">// adjusting Running state</span>
00566       <span class="keywordflow">if</span> ( Running )
00567       {
00568          <a class="code" href="classTModuleBase.html#n0">Running</a> = <span class="keyword">false</span>;
00569          <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(750);
00570          <a class="code" href="classTModuleBase.html#b8">FinishedRunning</a>();
00571       }
00572    }
00573 
00574    <span class="keywordflow">if</span> ( _parser != NULL )
00575    {
00576       <span class="keyword">delete</span>( _parser );
00577       _parser = NULL;
00578    }
00579 
00580    <span class="keywordflow">return</span> r_status;
00581 }
00582 <span class="comment">//---------------------------------------------------------------------------</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:05 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
