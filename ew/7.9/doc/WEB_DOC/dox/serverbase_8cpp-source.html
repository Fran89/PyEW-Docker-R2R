<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>serverbase.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>serverbase.cpp</h1><a href="serverbase_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="preprocessor">#include "<a class="code" href="serverbase_8h.html">serverbase.h</a>"</span>
00003 
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="worm__signal_8h.html">worm_signal.h</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="worm__exceptions_8h.html">worm_exceptions.h</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">logger.h</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="timefuncs_8h.html">timefuncs.h</a>&gt;</span> <span class="comment">// MSecSleep()</span>
00009 
00010 
00011 <span class="comment">// A Borland pragma, ignored by other compilers</span>
00012 <span class="preprocessor">#pragma package(smart_init)</span>
00013 <span class="preprocessor"></span>
00014 
<a name="l00015"></a><a class="code" href="serverbase_8cpp.html#a0">00015</a> <span class="preprocessor">#define ACCEPTABLE_SEC_TO_WAIT_FOR_SERVICE_THREAD_TO_START 10</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">//---------------------------------------------------------------------------</span>
00018 <span class="comment">//---------------------------------------------------------------------------</span>
00019 <span class="comment">//---------------------------------------------------------------------------</span>
00020 
<a name="l00021"></a><a class="code" href="classWormServerBase.html#e0">00021</a> <span class="keywordtype">bool</span> <a class="code" href="classWormServerBase.html#e0">WormServerBase::DoSCNLsMatch</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * p_s1
00022                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_c1
00023                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_n1
00024                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_l1
00025                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_s2
00026                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_c2
00027                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_n2
00028                                  , <span class="keyword">const</span> <span class="keywordtype">char</span> * p_l2
00029                                  )
00030 {
00031    <span class="comment">// For each descriptor type (S, C, N, L)</span>
00032    <span class="comment">// a match is: either string starts with '*'</span>
00033    <span class="comment">//             an exact string match</span>
00034    <span class="comment">//</span>
00035    <span class="keywordflow">if</span> ( ! (   p_s1[0] == <span class="charliteral">'*'</span>
00036            || p_s2[0] == <span class="charliteral">'*'</span>
00037            || strcmp( p_s1, p_s2 ) == 0
00038       )   )
00039    {
00040       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00041    }
00042 
00043    <span class="keywordflow">if</span> ( ! (   p_c1[0] == <span class="charliteral">'*'</span>
00044            || p_c2[0] == <span class="charliteral">'*'</span>
00045            || strcmp( p_c1, p_c2 ) == 0
00046       )   )
00047    {
00048       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00049    }
00050 
00051    <span class="keywordflow">if</span> ( ! (   p_n1[0] == <span class="charliteral">'*'</span>
00052            || p_n2[0] == <span class="charliteral">'*'</span>
00053            || strcmp( p_n1, p_n2 ) == 0
00054       )   )
00055    {
00056       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00057    }
00058 
00059    <span class="keywordflow">if</span> ( ! (   p_l1[0] == <span class="charliteral">'-'</span>
00060            || p_l2[0] == <span class="charliteral">'-'</span>
00061            || strcmp( p_l1, p_l2 ) == 0
00062       )   )
00063    {
00064       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00065    }
00066 
00067    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00068 }
00069 
00070 <span class="comment">//---------------------------------------------------------------------------</span>
00071 <span class="comment">//---------------------------------------------------------------------------</span>
00072 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00073"></a><a class="code" href="classWormServerBase.html#a2">00073</a> <a class="code" href="classWormServerBase.html#a2">WormServerBase::WormServerBase</a>()
00074 {
00075    <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00076    <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00077    <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00078    strcpy( ServerIPAddr, <span class="stringliteral">""</span> );
00079    <a class="code" href="classWormServerBase.html#n2">ServerPort</a> = -1;
00080    <a class="code" href="classWormServerBase.html#n0">SocketDebug</a> = <span class="keyword">false</span>;
00081    <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = INVALID_SOCKET;
00082    <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> = 10;
00083    <a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a> = -2;
00084    <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> = -1;
00085 
00086    <span class="keywordflow">try</span>
00087    {
00088       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_HEARTBEAT"</span>) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00089       {
00090          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"message type &lt;TYPE_HEARTBEAT&gt; not defined"</span>);
00091       }
00092 
00093       <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_ERROR"</span>) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00094       {
00095          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"message type &lt;TYPE_ERROR&gt; not defined"</span>);
00096       }
00097 
00098       <a class="code" href="socket__ew_8c.html#a2">SocketSysInit</a>();
00099    }
00100    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00101    {
00102       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00103                     , <span class="stringliteral">"WormServerBase(): error: %s\n"</span>
00104                     , _we.what()
00105                     );
00106    }
00107 }
00108 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00109"></a><a class="code" href="classWormServerBase.html#a3">00109</a> <a class="code" href="classWormServerBase.html#a3">WormServerBase::~WormServerBase</a>()
00110 {
00111    <span class="comment">// tell all threads to quit</span>
00112    <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00113    <span class="comment">// give accept_ew a chance to return before closing socketing system</span>
00114    <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(1000);
00115    WSACleanup();
00116 }
00117 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00118"></a><a class="code" href="classWormServerBase.html#b3">00118</a> <span class="keywordtype">int</span> <a class="code" href="classWormServerBase.html#b3">WormServerBase::ListenForMsg</a>( SOCKET  p_descriptor
00119                                 , <span class="keywordtype">char</span> *  p_rcv_buffer
00120                                 , <span class="keywordtype">int</span> *   p_length <span class="comment">// in = max read ; out = actually read</span>
00121                                 , <span class="keywordtype">int</span>     p_timeoutms
00122                                 )
00123 {
00124 <span class="comment">//   if ( TGlobalUtils::GetLoggingLevel() == WORM_LOG_DEBUG )</span>
00125 <span class="comment">//   {</span>
00126 <span class="comment">//      TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP</span>
00127 <span class="comment">//                    , "WormServerBase.ListenForMsg(): listening at the socket %d...\n"</span>
00128 <span class="comment">//                    , p_descriptor</span>
00129 <span class="comment">//                    );</span>
00130 <span class="comment">//   }</span>
00131 
00132    <span class="keywordtype">int</span> r_status = 0;
00133 
00134    <span class="keywordtype">int</span> r_readcount = 0;
00135 
00136    <span class="keywordtype">int</span> _readmax = *p_length;
00137 
00138    <span class="comment">// if p_timeoutms greater than zero, then use it for the</span>
00139    <span class="comment">// timeout, otherwise use RecvTimeoutMS.  (In the method</span>
00140    <span class="comment">// declaration, p_timeoutms is defaulted to -1 -- so it</span>
00141    <span class="comment">// will be ignored).</span>
00142    <span class="comment">//</span>
00143    <span class="keywordtype">int</span> _timeoutms = ( p_timeoutms &lt; 1 ? <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> : p_timeoutms );
00144 
00145    <span class="comment">// report actual number read</span>
00146    *p_length = 0;
00147 
00148    <span class="keywordtype">bool</span> _stillreading = <span class="keyword">true</span>;
00149 
00150    <span class="keywordflow">try</span>
00151    {
00152       <span class="keywordflow">if</span> ( _timeoutms == -1 )
00153       {
00154          <span class="comment">// tell the main thread that we're entering a potentially</span>
00155          <span class="comment">// blocked state so it will not kill this thread during a</span>
00156          <span class="comment">// long block.</span>
00157          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[p_descriptor].status = <a class="code" href="serverbase_8h.html#a22a19">THREAD_BLOCKINGSOCKET</a>;
00158       }
00159 
00160       <span class="comment">// Listen to the socket for incoming characters until our buffer is full</span>
00161       <span class="comment">// or '\n' encountered....</span>
00162       <span class="comment">//</span>
00163       <span class="keywordflow">do</span>
00164       {
00165 
00166          <span class="keywordflow">if</span> ( r_readcount == _readmax )
00167          {
00168             <span class="comment">// buffer is maxed-out, can't read anymore.</span>
00169             r_status = -4;
00170             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"message buffer overflow"</span>);
00171          }
00172 
00173          <span class="comment">// tell the main thread this thread still alive</span>
00174          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[p_descriptor].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
00175 
00176          <span class="comment">// although this single-char read is inefficient, messages from the clients</span>
00177          <span class="comment">// tend to be relatively rare and this method allows us to identify</span>
00178          <span class="comment">// the end-of-messge char easily.</span>
00179          <span class="comment">//</span>
00180          <span class="comment">// In addition, the handling for a socket time-out is optimistic,</span>
00181          <span class="comment">// specifically, it only cleanly handles the case of a timeout between</span>
00182          <span class="comment">// messages, not in the middle of one.</span>
00183          <span class="comment">//</span>
00184          <span class="comment">// Ultimately, this should be supplemented with an additional buffering</span>
00185          <span class="comment">// area that receives a larger amount from the socket, and can be manipulated</span>
00186          <span class="comment">// to identify message termination.</span>
00187          <span class="comment">//</span>
00188 <span class="comment">//         if ( TGlobalUtils::GetLoggingLevel() == WORM_LOG_DEBUG )</span>
00189 <span class="comment">//         {</span>
00190 <span class="comment">//            TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT|WORM_LOG_TIMESTAMP</span>
00191 <span class="comment">//                          , "WormServerBase.ListenForMsg(): calling recv_ew( %d , %d )\n"</span>
00192 <span class="comment">//                          , (int)p_descriptor</span>
00193 <span class="comment">//                          , _timeoutms</span>
00194 <span class="comment">//                          );</span>
00195 <span class="comment">//         }</span>
00196 
00197          <span class="keywordtype">int</span> _err;
00198          <span class="keywordflow">switch</span>( <a class="code" href="socket__ew__common_8c.html#a12">recv_ew</a>( p_descriptor, &amp;p_rcv_buffer[r_readcount], 1, 0, _timeoutms ) )
00199          {
00200            <span class="keywordflow">case</span> 1:
00201                 <span class="keywordflow">if</span> ( p_rcv_buffer[r_readcount] == <span class="charliteral">'\n'</span> )
00202                 {
00203                    <span class="comment">/* If we got a newline, we're done gathering */</span>
00204                    <span class="comment">/* replace the \n with a zero */</span>
00205                    p_rcv_buffer[r_readcount] = <span class="charliteral">'\0'</span>;
00206                    _stillreading = <span class="keyword">false</span>;
00207                 }
00208                 (*p_length)++;
00209                 r_readcount++;
00210                 <span class="keywordflow">break</span>;
00211 
00212            <span class="keywordflow">case</span> 0:
00213                 r_status = -2;
00214                 <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a12">WORM_LOG_DETAILS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00215                 {
00216                    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00217                                  , <span class="stringliteral">"WormServerBase.ListenForMsg(): Client closed socket %d\n"</span>
00218                                  , p_descriptor
00219                                  );
00220                 }
00221                 _stillreading = <span class="keyword">false</span>;
00222                 <span class="keywordflow">break</span>;
00223 
00224            <span class="keywordflow">case</span> SOCKET_ERROR:
00225 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
00226 <span class="preprocessor"></span>                <span class="keywordflow">switch</span>( (_err = WSAGetLastError()) )
00227                 {
00228                   <span class="keywordflow">case</span> WSAEWOULDBLOCK:
00229                        <span class="comment">// timed out -- nothing now available on non-blocking socket</span>
00230                        r_status = -1;
00231                        _stillreading = <span class="keyword">false</span>;
00232                        <span class="keywordflow">break</span>;
00233 
00234                   <span class="keywordflow">case</span> WSAECONNRESET:
00235                        r_status = -2;
00236                        <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a12">WORM_LOG_DETAILS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00237                        {
00238                           <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00239                                         , <span class="stringliteral">"WormServerBase.ListenForMsg(): Other end closed socket %d\n"</span>
00240                                         , p_descriptor
00241                                         );
00242                        }
00243                        _stillreading = <span class="keyword">false</span>;
00244                        <span class="keywordflow">break</span>;
00245 
00246                   <span class="keywordflow">default</span>:
00247                        r_status = -3;
00248                        <span class="keywordflow">throw</span> <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a>( WSF_RECV
00249                                                   , _err
00250                                                   , <span class="stringliteral">"Socket error from recv()"</span>
00251                                                   );
00252                 }
00253                 <span class="keywordflow">break</span>;
00254 <span class="preprocessor">#endif</span>
00255 <span class="preprocessor"></span><span class="comment">/* TODO : CHECK FOR TIMED-OUT ON NON_WINDOWS OS */</span>
00256 
00257          } <span class="comment">// switch recv_ew()</span>
00258 
00259       } <span class="keywordflow">while</span>( _stillreading );  <span class="comment">// for 0 --&gt; (p_maxlen - 1)</span>
00260    }
00261    <span class="keywordflow">catch</span>( <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a> &amp; _se )
00262    {
00263       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00264                     , <span class="stringliteral">"WormServerBase::ListenForMsg(): socket exception:\n%s\n"</span>
00265                     , _se.DecodeError()
00266                     );
00267    }
00268    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00269    {
00270       <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00271       {
00272          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00273                        , <span class="stringliteral">"WormServerBase.ListenForMsg(): Error - %s\n"</span>
00274                        , _we.what()
00275                        );
00276       }
00277    }
00278 
00279    <span class="comment">// tell the main thread this thread still alive</span>
00280    <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[p_descriptor].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
00281    <span class="keywordflow">if</span> ( _timeoutms == -1 )
00282    {
00283       <span class="comment">// tell the main thread that we're entering a potentially</span>
00284       <span class="comment">// blocked state so it will not kill this thread during a</span>
00285       <span class="comment">// long block.</span>
00286       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[p_descriptor].status = <a class="code" href="serverbase_8h.html#a22a18">THREAD_PROCESSING</a>;
00287    }
00288 
00289    <span class="keywordflow">return</span> r_status;
00290 }
00291 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00292"></a><a class="code" href="classWormServerBase.html#b4">00292</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#b4">WormServerBase::SendMessage</a>( <span class="keyword">const</span> SOCKET  p_descriptor
00293                                             , <span class="keyword">const</span> <span class="keywordtype">char</span> *  p_msg
00294                                             , <span class="keywordtype">int</span>        *  p_length
00295                                             )
00296 {
00297    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00298 
00299    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00300    {
00301       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00302                     , <span class="stringliteral">"WormServerBase.SendMessage(): sending message to %s  (timeout %d):\n%s&lt;\n"</span>
00303                     , ThreadsInfo[p_descriptor].ipaddr
00304                     , SendTimeoutMS
00305                     , p_msg
00306                     );
00307    }
00308 
00309 
00310    <span class="keywordflow">try</span>
00311    {
00312       <span class="keywordflow">if</span> ( p_msg == NULL )
00313       {
00314          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>( <span class="stringliteral">"WormServerBase.SendMessage(): message string is NULL"</span> );
00315       }
00316 
00317       <span class="keywordtype">int</span> _sendcount = *p_length;
00318       <span class="keywordflow">if</span> ( (*p_length = <a class="code" href="socket__ew__common_8c.html#a14">send_ew</a>(p_descriptor, p_msg, _sendcount, 0, SendTimeoutMS)) == SOCKET_ERROR )
00319       {
00320          <span class="keywordflow">throw</span> <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a>( WSF_SEND
00321                                     , <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>()
00322                                     , <span class="stringliteral">"send_ew returned error"</span>
00323                                     );
00324       }
00325 
00326       <span class="keywordflow">if</span> ( _sendcount != *p_length )
00327       {
00328          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"bytes sent does not match message size"</span>);
00329       }
00330    }
00331    <span class="keywordflow">catch</span>( <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a>&amp; _se )
00332    {
00333       <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00334       {
00335          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00336                        , <span class="stringliteral">"WormServerBase.SendMessage(): failed sending message to %s:\n  %s\n"</span>
00337                        , ThreadsInfo[p_descriptor].ipaddr
00338                        , _se.DecodeError()
00339                        );
00340       }
00341       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00342    }
00343    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00344    {
00345       <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00346       {
00347          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00348                        , <span class="stringliteral">"WormServerBase.SendMessage(): Error - %s\n"</span>
00349                        , _we.what()
00350                        );
00351       }
00352       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00353    }
00354    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00355    {
00356       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00357                     , <span class="stringliteral">"WormServerBase.SendMessage(): exiting\n"</span>
00358                     );
00359    }
00360    <span class="keywordflow">return</span> r_status;
00361 }
00362 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00363"></a><a class="code" href="classWormServerBase.html#b1">00363</a> <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b1">WormServerBase::CheckConfig</a>()
00364 {
00365 
00366    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() &lt; 1 )
00367    {
00368       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00369                     , <span class="stringliteral">"WormServerBase::CheckConfig(): No &lt;HeartBeatInt&gt; value from the config file\n"</span>
00370                     );
00371       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00372    }
00373 
00374    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> &lt; <a class="code" href="serverbase_8h.html#a8">MIN_RECV_TIMEOUT_MS</a> )
00375    {
00376       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00377                     , <span class="stringliteral">"WormServerBase::CheckConfig(): &lt;RecvTimeoutMSecs&gt; too low in config file, using %d\n"</span>
00378                     , MIN_RECV_TIMEOUT_MS
00379                     );
00380       <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> = <a class="code" href="serverbase_8h.html#a8">MIN_RECV_TIMEOUT_MS</a>;
00381    }
00382 
00383    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00384    {
00385       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00386                     , <span class="stringliteral">"WormServerBase::CheckConfig(): No &lt;CmdRingName&gt; value from the config file\n"</span>
00387                     );
00388       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00389    }
00390 
00391    <span class="keywordflow">if</span> ( strlen(ServerIPAddr) == 0 )
00392    {
00393       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00394                     , <span class="stringliteral">"WormServerBase::CheckConfig(): No &lt;ServerIPAddr&gt; value from the config file\n"</span>
00395                     );
00396       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00397    }
00398 
00399    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n2">ServerPort</a> == -1 )
00400    {
00401       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00402                     , <span class="stringliteral">"WormServerBase::CheckConfig(): No &lt;ServerPort&gt; value from the config file\n"</span>
00403                     );
00404       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00405    }
00406 
00407    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a> == -2 )
00408    {
00409       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00410                     , <span class="stringliteral">"WormServerBase::CheckConfig(): No &lt;SendTimeoutMSecs&gt; value from the config file\n"</span>
00411                     );
00412       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00413    }
00414 }
00415 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00416"></a><a class="code" href="classWormServerBase.html#a0">00416</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classWormServerBase.html#a0">WormServerBase::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00417 {
00418    <span class="comment">// Do not manipulate ConfigState herein.</span>
00419    <span class="comment">//</span>
00420    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00421 
00422    <span class="keywordflow">try</span>
00423    {
00424       <span class="keywordtype">char</span> * _token;
00425 
00426       <span class="keywordflow">do</span>
00427       {
00428 
00429          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"CmdRingName"</span>) )
00430          {
00431             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00432             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00433             {
00434                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;CmdRingName&gt; value"</span>);
00435             }
00436             strncpy( CommandRingName, _token, MAX_RINGNAME_LEN );
00437 
00438             <span class="keywordflow">if</span> ( (<a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(CommandRingName)) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00439             {
00440                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;CmdRingName&gt; value"</span>);
00441             }
00442 
00443             <span class="keywordflow">continue</span>;
00444          }
00445 
00446          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>( <span class="stringliteral">"ServerIPAddr"</span> ) )
00447          {
00448             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00449 
00450             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00451             {
00452                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;ServerIPAddr&gt; value"</span>);
00453             }
00454 
00455             <span class="keywordflow">if</span> ( 20 &lt;= strlen(_token) )
00456             {
00457                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"&lt;ServerIPAddr&gt; name too long"</span>);
00458             }
00459 
00460             strcpy( ServerIPAddr, _token );
00461             <span class="keywordflow">continue</span>;
00462          }
00463 
00464          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"ServerPort"</span>) )
00465          {
00466             <span class="keywordflow">if</span> ( (<a class="code" href="classWormServerBase.html#n2">ServerPort</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>()) == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00467             {
00468                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00469                              , <span class="stringliteral">"WormServerBase::HandleConfigLine(): Invalid &lt;ServerPort&gt; value in line\n%s\n"</span>
00470                              , p_parser-&gt;<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00471                              );
00472             }
00473             <span class="keywordflow">continue</span>;
00474          }
00475 
00476          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"SendTimeoutMSecs"</span>) )
00477          {
00478             <span class="comment">// convert to milliseconds</span>
00479             <span class="keywordflow">if</span> ( (<a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>()) &lt; 0 )
00480             {
00481                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00482                              , <span class="stringliteral">"WormServerBase::HandleConfigLine(): Invalid &lt;SendTimeoutMSecs&gt; line (must be &gt; 0), reverting to 10000 ms\n"</span>
00483                              );
00484                <a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a> = 10000;
00485             }
00486             <span class="keywordflow">continue</span>;
00487          }
00488 
00489          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"RecvTimeoutMSecs"</span>) )
00490          {
00491             <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>();
00492             <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> &lt; -1 )
00493             {
00494                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00495                              , <span class="stringliteral">"WormServerBase::HandleConfigLine(): Invalid &lt;RecvTimeoutSecs&gt; line, reverting to 200 ms\n"</span>
00496                              );
00497                <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> = 200;
00498             }
00499             <span class="keywordflow">continue</span>;
00500          }
00501 
00502 
00503          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"MaxServerThreads"</span>) )
00504          {
00505             <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>();
00506             <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> &lt;= 0 || <a class="code" href="serverbase_8h.html#a3">SERVE_MAX_THREADS</a> &lt; <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> )
00507             {
00508                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00509                              , <span class="stringliteral">"WormServerBase::HandleConfigLine(): &lt;MaxServiceThreads&gt; (%d) out of range (0 - %d)\n%s %d\n"</span>
00510                              , MaxServiceThreads
00511                              , SERVE_MAX_THREADS
00512                              , <span class="stringliteral">"                                    setting to "</span>
00513                              , SERVE_MAX_THREADS
00514                              );
00515                <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> = <a class="code" href="serverbase_8h.html#a3">SERVE_MAX_THREADS</a>;
00516             }
00517             <span class="keywordflow">continue</span>;
00518          }
00519 
00520          <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"SocketDebug"</span>) )
00521          {
00522             <a class="code" href="classWormServerBase.html#n0">SocketDebug</a> = <span class="keyword">true</span>;
00523             <span class="keywordflow">continue</span>;
00524          }
00525 
00526          r_handled = <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a>;
00527 
00528       } <span class="keywordflow">while</span> ( false );
00529    }
00530    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00531    {
00532       r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00533       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00534                    , <span class="stringliteral">"WormServerBase::HandleConfigLine(): configuration error:\n%s%s\n"</span>
00535                    , <span class="stringliteral">"                                    "</span>
00536                    , _we.what()
00537                    );
00538    }
00539 
00540    <span class="keywordflow">return</span> r_handled;
00541 }
00542 <span class="comment">//---------------------------------------------------------------------------</span>
00543 <span class="comment">/******************************************************************************</span>
00544 <span class="comment">* SendStatus() builds a heartbeat or error message &amp; puts it into    *</span>
00545 <span class="comment">*                     shared memory.  Writes errors to log file &amp; screen.    *</span>
00546 <span class="comment">******************************************************************************/</span>
<a name="l00547"></a><a class="code" href="classWormServerBase.html#b5">00547</a> <span class="keywordtype">void</span> <a class="code" href="classWormServerBase.html#b5">WormServerBase::SendStatus</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type, <span class="keywordtype">short</span> p_ierr, <span class="keywordtype">char</span> * p_text )
00548 {
00549    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00550    {
00551       <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a>    logo;
00552       <span class="keywordtype">char</span>        msg[256];
00553       <span class="keywordtype">long</span>        size;
00554       <span class="keywordtype">long</span>        t;
00555         
00556       <span class="comment">/* Build the message</span>
00557 <span class="comment">      *******************/</span>
00558       logo.<a class="code" href="structMSG__LOGO.html#m2">instid</a> = <a class="code" href="classTGlobalUtils.html#d8">TGlobalUtils::GetThisInstallationId</a>();
00559       logo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>    = <a class="code" href="classTGlobalUtils.html#d7">TGlobalUtils::GetThisModuleId</a>();
00560       logo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   = <a class="code" href="getutil_8c.html#a16">type</a>;
00561         
00562       time( &amp;t );
00563 
00564       strcpy( msg, <span class="stringliteral">""</span> );
00565    
00566       <span class="keywordflow">if</span>( <a class="code" href="getutil_8c.html#a16">type</a> == <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_HEARTBEAT"</span>) )
00567       {
00568          sprintf( msg, <span class="stringliteral">"%ld %ld\n\0"</span>, t, TGlobalUtils::GetPID());
00569       }
00570       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="getutil_8c.html#a16">type</a> == <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_ERROR"</span>) )
00571       {
00572          sprintf( msg, <span class="stringliteral">"%ld %hd %s\n\0"</span>, t, p_ierr, p_text);
00573       }
00574       <span class="keywordflow">else</span>
00575       {
00576          <span class="keywordflow">return</span>;
00577       }
00578         
00579       size = strlen( msg );   <span class="comment">/* don't include the null byte in the message */</span>
00580 
00581       <span class="comment">/* Write the message to shared memory</span>
00582 <span class="comment">      ************************************/</span>
00583 
00584       <span class="keywordflow">if</span>( <a class="code" href="transport_8c.html#a19">tport_putmsg</a>( &amp;CommandRegion, &amp;logo, size, msg ) != <a class="code" href="transport_8h.html#a5">PUT_OK</a> )
00585       {
00586          <span class="keywordflow">if</span>( <a class="code" href="getutil_8c.html#a16">type</a> == <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_HEARTBEAT"</span>) )
00587          {
00588             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00589                           , <span class="stringliteral">"WormServerBase::SendStatus(): Error sending heartbeat.\n"</span>
00590                           );
00591          }
00592          <span class="keywordflow">else</span> <span class="comment">// if( type == TGlobalUtils::LookupMessageTypeId("TYPE_ERROR") )</span>
00593          {
00594             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00595                           , <span class="stringliteral">"WormServerBase::SendStatus(): Error sending error: %d.\n"</span>
00596                           , p_ierr
00597                           );
00598          }
00599       }
00600    }
00601 }
00602 <span class="comment">//---------------------------------------------------------------------------</span>
<a name="l00603"></a><a class="code" href="classWormServerBase.html#a4">00603</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#a4">WormServerBase::Run</a>()
00604 {
00605    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00606 
00607    <span class="keyword">static</span> <span class="keywordtype">long</span> CurrentTime
00608              , LastBeatTime
00609              ;
00610 
00611    <span class="keywordflow">try</span>
00612    {
00613       <span class="keywordflow">if</span> ( <a class="code" href="classTConfigurable.html#n0">ConfigState</a> != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00614       {
00615          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"WormServerBase::Run() Server not configured"</span>);
00616       }
00617 
00618       <span class="keywordflow">if</span> ( SocketDebug )
00619       {
00620          <span class="comment">// Turn Socket level debugging On/Off</span>
00621          <a class="code" href="socket__ew__common_8c.html#a18">setSocket_ewDebug</a>(1);
00622       }
00623 
00624       <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;CommandRegion, CommandRingKey );
00625 
00626 <span class="preprocessor">#ifdef _SOLARIS</span>
00627 <span class="preprocessor"></span>      <span class="comment">// Ignore broken socket signals</span>
00628       (void)sigignore(SIGPIPE);
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>
00631       <span class="comment">// Set up the signal handler so we can shut down gracefully</span>
00632            <span class="comment">//</span>
00633            signal(SIGINT, (SIG_HANDLR_PTR)SignalHandler);     <span class="comment">/* &lt;Ctrl-C&gt; interrupt */</span>
00634            signal(SIGTERM, (SIG_HANDLR_PTR)SignalHandler);    <span class="comment">/* program termination request */</span>
00635            signal(SIGABRT, (SIG_HANDLR_PTR)SignalHandler);    <span class="comment">/* abnormal termination */</span>
00636 <span class="preprocessor">#ifdef SIGBREAK</span>
00637 <span class="preprocessor"></span>           signal(SIGBREAK, (SIG_HANDLR_PTR)SignalHandler);   <span class="comment">/* keyboard break */</span>
00638 <span class="preprocessor">#endif</span>
00639 <span class="preprocessor"></span>
00640       <span class="keywordflow">if</span> ( ! <a class="code" href="classWormServerBase.html#b7">PrepareToRun</a>() )
00641       {
00642          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"PrepareToRun() reported not ready"</span>);
00643       }
00644 
00645 
00646       <span class="comment">// Start the Listener Thread</span>
00647       <span class="comment">//</span>
00648       <span class="comment">// alternative:     MyThreadFunction = &amp;WormServerBase::Listener;</span>
00649       <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> = time(NULL) + 5; <span class="comment">// allow an extra 5 seconds to start</span>
00650       <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#b1">StartThread</a>( THREAD_STACK, &amp;ListenerThreadId ) == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
00651       {
00652          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed starting listener thread"</span>);
00653       }
00654 
00655 
00656       <span class="keywordtype">int</span> flag;
00657 
00658       <span class="comment">// initialize the Times</span>
00659       <span class="comment">//</span>
00660       time(&amp;CurrentTime);
00661       LastBeatTime = CurrentTime;
00662 
00663       <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">true</span>;
00664       <span class="keywordflow">do</span>
00665       {
00666          <span class="comment">// Check for and respond to stop flags</span>
00667          flag = <a class="code" href="transport_8c.html#a22">tport_getflag</a>(&amp;CommandRegion);
00668          <span class="keywordflow">if</span>( flag == <a class="code" href="transport_8h.html#a17">TERMINATE</a>  ||  flag == (int)<a class="code" href="classTGlobalUtils.html#d6">TGlobalUtils::GetPID</a>() )
00669          {
00670             <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>; <span class="comment">// signal all threads to return</span>
00671             <span class="keywordflow">continue</span>;
00672          }
00673 
00674          <span class="comment">// +2 is to allow sleeps for same time</span>
00675          <span class="keywordflow">if</span> ( (<a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> + <a class="code" href="serverbase_8cpp.html#a0">ACCEPTABLE_SEC_TO_WAIT_FOR_SERVICE_THREAD_TO_START</a> + 2) &lt; time(NULL) )
00676          {
00677             <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), 0, <span class="stringliteral">"listener thread stopped"</span> );
00678             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Listener thread stopped pulsing"</span>);
00679          }
00680 
00681          <span class="comment">// Send server's heartbeat if it is time</span>
00682          <span class="keywordflow">if</span>( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() &lt;= (time(&amp;CurrentTime) - LastBeatTime) )
00683          {
00684             LastBeatTime = CurrentTime;
00685             <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_HEARTBEAT"</span>), 0, <span class="stringliteral">""</span> );
00686          }
00687 
00688          <span class="comment">// Handle logging, etc, in MainThreadActions()....</span>
00689          <span class="comment">// so, don't throw an error here</span>
00690          <span class="comment">//</span>
00691          <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#b8">MainThreadActions</a>() == <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00692          {
00693             <span class="comment">//</span>
00694             <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
00695          }
00696          <span class="keywordflow">else</span>
00697          {
00698             <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00699          }
00700 
00701       } <span class="keywordflow">while</span>( Running );
00702 
00703    }
00704    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00705    {
00706       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00707       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00708                     , <span class="stringliteral">"WormServerBase::Run(): error: %s\n"</span>
00709                     , _we.what()
00710                     );
00711    }
00712 
00713    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT|WORM_LOG_TIMESTAMP
00714                  , <span class="stringliteral">"WormServerBase::Run(): calling FinishedRunning()\n"</span>
00715                  );
00716 
00717    <span class="comment">// Tell the derivative classes to finish up</span>
00718    <a class="code" href="classWormServerBase.html#b9">FinishedRunning</a>();
00719 
00720    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00721    {
00722       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00723                     , <span class="stringliteral">"WormServerBase::Listener(): detaching from command ring\n"</span>
00724                     );
00725       <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;CommandRegion );
00726       <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00727    }
00728 
00729    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT|WORM_LOG_TIMESTAMP
00730                  , <span class="stringliteral">"WormServerBase::Run(): returning.\n"</span>
00731                  );
00732 
00733    <span class="keywordflow">return</span> r_status;
00734 }
00735 <span class="comment">//---------------------------------------------------------------------------</span>
00736 <span class="comment">// THREAD_RETURN is some sort of void</span>
00737 <span class="comment">//</span>
00738 <span class="comment">// The sockaddr structure varies depending on the the protocol selected.</span>
00739 <span class="comment">// The structure below is used with TCP/IP. Other protocols use similar structures.</span>
00740 <span class="comment">//</span>
00741 <span class="comment">// struct sockaddr_in {</span>
00742 <span class="comment">//         short   sin_family;</span>
00743 <span class="comment">//         u_short sin_port;</span>
00744 <span class="comment">//         struct  in_addr sin_addr;</span>
00745 <span class="comment">//         char    sin_zero[8];</span>
00746 <span class="comment">// };</span>
00747 <span class="comment">//</span>
00748 <span class="comment">// struct hostent {</span>
00749 <span class="comment">//     char FAR *       h_name;</span>
00750 <span class="comment">//     char FAR * FAR * h_aliases;</span>
00751 <span class="comment">//     short            h_addrtype;</span>
00752 <span class="comment">//     short            h_length;</span>
00753 <span class="comment">//     char FAR * FAR * h_addr_list;</span>
00754 <span class="comment">// };</span>
00755 <span class="comment">//</span>
00756 <span class="comment">// Members</span>
00757 <span class="comment">//h_name -- Official name of the host (PC).If using the DNS or similar resolution system,</span>
00758 <span class="comment">//          it is the Fully Qualified Domain Name (FQDN) that caused the server to return a reply.</span>
00759 <span class="comment">//          If using a local "hosts" file, it is the first entry after the IP address.</span>
00760 <span class="comment">//h_aliases -- A NULL-terminated array of alternate names.</span>
00761 <span class="comment">//h_addrtype -- The type of address being returned.</span>
00762 <span class="comment">//h_length -- The length, in bytes, of each address.</span>
00763 <span class="comment">//h_addr_list -- A NULL-terminated list of addresses for the host.</span>
00764 <span class="comment">//               Addresses are returned in network byte order.</span>
00765 <span class="comment">//               The macro h_addr is defined to be h_addr_list[0] for compatibility with older software.</span>
00766 <span class="comment">//</span>
<a name="l00767"></a><a class="code" href="classWormServerBase.html#b0">00767</a> THREAD_RETURN <a class="code" href="classWormServerBase.html#b0">WormServerBase::Listener</a>( <span class="keywordtype">void</span> * p_dummy )
00768 {
00769 
00770    <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a11">WORM_LOG_TRACKING</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00771    {
00772       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDOUT|WORM_LOG_TIMESTAMP
00773                     , <span class="stringliteral">"WormServerBase::Listener(): Starting\n"</span>
00774                     );
00775    }
00776 
00777    <span class="keywordflow">try</span>
00778    {
00779       <span class="keywordtype">int</span>              _clientaddrlength;
00780 
00781 <span class="comment">/*</span>
00782 <span class="comment">      // Fill in the hostent structure, given dot address as a char string</span>
00783 <span class="comment">      //</span>
00784 <span class="comment">//      unsigned long    ServerNBOAddr;</span>
00785 <span class="comment">//      struct hostent * HostEnt;</span>
00786 <span class="comment">//      struct  in_addr  hostentaddr;</span>
00787 <span class="comment">//      short            hostentaddrlen;</span>
00788 <span class="comment"></span>
00789 <span class="comment">      // TODO : CHECK inet_addr() ON UNIX</span>
00790 <span class="comment">      if ( (ServerNBOAddr = inet_addr(ServerIPAddr)) == INADDR_NONE)</span>
00791 <span class="comment">      {</span>
00792 <span class="comment">         char _msg[40];</span>
00793 <span class="comment">         sprintf( _msg, "inet_addr(%s) failed", ServerIPAddr );</span>
00794 <span class="comment">         throw worm_exception(_msg);</span>
00795 <span class="comment">      }</span>
00796 <span class="comment">      // TODO : CHECK gethostbyaddr() ON UNIX</span>
00797 <span class="comment">      HostEnt = gethostbyaddr((char *)&amp;ServerNBOAddr, sizeof(ServerNBOAddr), AF_INET);</span>
00798 <span class="comment">      if (HostEnt == NULL)</span>
00799 <span class="comment">      {</span>
00800 <span class="comment">         char _msg[80];</span>
00801 <span class="comment">         sprintf( _msg</span>
00802 <span class="comment">                , "gethostbyaddr() for %s failed"</span>
00803 <span class="comment">                , ServerIPAddr</span>
00804 <span class="comment">                );</span>
00805 <span class="comment">         throw worm_exception(_msg);</span>
00806 <span class="comment">      }</span>
00807 <span class="comment"></span>
00808 <span class="comment">      memcpy( (char *)&amp;hostentaddr, HostEnt-&gt;h_addr, HostEnt-&gt;h_length );</span>
00809 <span class="comment">      hostentaddrlen = HostEnt-&gt;h_length;</span>
00810 <span class="comment">*/</span>
00811 
00812       <span class="keywordflow">while</span>( Running )
00813       {
00814          <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> = time(NULL);
00815 
00816 
00817          <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> == INVALID_SOCKET )
00818          {
00819             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00820             {
00821                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00822                              , <span class="stringliteral">"WormServerBase::Listener(): calling socket_ew()\n"</span>
00823                              );
00824             }
00825 
00826             <span class="keywordflow">if</span> ( ( <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = <a class="code" href="socket__ew__common_8c.html#a6">socket_ew</a>(AF_INET, SOCK_STREAM, 0) ) == INVALID_SOCKET )
00827             {
00828                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"socket_ew() returned error"</span>);
00829             }
00830 
00831             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00832             {
00833                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00834                              , <span class="stringliteral">"WormServerBase::Listener(): calling setsockopt(SO_REUSEADDR)\n"</span>
00835                              );
00836             }
00837 
00838             <span class="comment">// Allows the server to reuse the address if problems (stop, crash, etc.)</span>
00839             <span class="comment">// kept the socket bound to a previous process</span>
00840             <span class="comment">//</span>
00841             <span class="keywordtype">char</span> _value = 1;
00842             <span class="keywordflow">if</span>( setsockopt( PassiveSocket, SOL_SOCKET, SO_REUSEADDR, &amp;_value, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *) ) != 0 )
00843             {
00844                <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00845                {
00846                   <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00847                                 , <span class="stringliteral">"setsockopt() failed setting SO_REUSEADDR, can't reuse socket if crash.\n"</span>
00848                                 );
00849                }
00850             }
00851 
00852 
00853 <span class="comment">/*</span>
00854 <span class="comment">            struct sockaddr_in _serverstruct;</span>
00855 <span class="comment"></span>
00856 <span class="comment">            // Fill in server's socket address structure</span>
00857 <span class="comment">            //*******************************************</span>
00858 <span class="comment">            memset( (char *)&amp;_serverstruct, '\0', sizeof(_serverstruct) );</span>
00859 <span class="comment">            memcpy( (char *)&amp;_serverstruct.sin_addr, &amp;hostentaddr, hostentaddrlen );</span>
00860 <span class="comment">            _serverstruct.sin_family = AF_INET;</span>
00861 <span class="comment">            _serverstruct.sin_port   = htons( (short)ServerPort );</span>
00862 <span class="comment">*/</span>
00863             <span class="keyword">struct </span>sockaddr_in _serverstruct;
00864 
00865             <span class="comment">// Fill in server's socket address structure</span>
00866             <span class="comment">//*******************************************</span>
00867             memset( (<span class="keywordtype">char</span> *)&amp;_serverstruct, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(_serverstruct) );
00868 
00869             _serverstruct.sin_family = AF_INET;
00870             _serverstruct.sin_port   = htons( (<span class="keywordtype">short</span>)ServerPort );
00871 
00872             <span class="keywordflow">if</span> ((int)(_serverstruct.sin_addr.S_un.S_addr = inet_addr(ServerIPAddr)) == -1)
00873             {
00874                <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"inet_addr("</span> );
00875                               _expt += <a class="code" href="classWormServerBase.html#n1">ServerIPAddr</a>;
00876                               _expt += <span class="stringliteral">") failed"</span>;
00877                <span class="keywordflow">throw</span> _expt;
00878             }
00879 
00880 
00881 
00882             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00883             {
00884                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00885                              , <span class="stringliteral">"WormServerBase::Listener(): calling bind_ew()\n"</span>
00886                              );
00887             }
00888 
00889             <span class="comment">// Bind socket to a name</span>
00890             <span class="keywordflow">if</span> ( <a class="code" href="socket__ew__common_8c.html#a8">bind_ew</a>( PassiveSocket, (<span class="keyword">struct</span> sockaddr *)&amp;_serverstruct, <span class="keyword">sizeof</span>(_serverstruct)) )
00891             {
00892                <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( PassiveSocket, SOCKET_CLOSE_IMMEDIATELY_EW );
00893                <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = INVALID_SOCKET;
00894                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"bind_ew() returned error"</span>);
00895             }
00896 
00897             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00898             {
00899                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00900                              , <span class="stringliteral">"WormServerBase::Listener(): calling listen_ew(%d, %d)\n"</span>
00901                              , PassiveSocket
00902                              , MaxServiceThreads
00903                              );
00904             }
00905 
00906             <span class="comment">// start listening</span>
00907             <span class="keywordflow">if</span> ( <a class="code" href="socket__ew__common_8c.html#a9">listen_ew</a>( PassiveSocket, MaxServiceThreads ) )
00908             {
00909                <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( PassiveSocket, SOCKET_CLOSE_IMMEDIATELY_EW );
00910                <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = INVALID_SOCKET;
00911                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"listen_ew() returned error"</span>);
00912             }
00913 
00914             <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> = time(NULL);
00915 
00916          } <span class="comment">// need to initialize server socket</span>
00917 
00918 
00919          <span class="comment">// =================================================================</span>
00920          <span class="comment">// Clean up the thread info structures</span>
00921          <span class="comment">//</span>
00922          <span class="comment">// Remove thread tracking structures for any threads in the</span>
00923          <span class="comment">// ERROR or COMPLETED state</span>
00924          <span class="comment">//</span>
00925          <span class="comment">// That is, assume that any thread in another state is still</span>
00926          <span class="comment">// talking successfully with its socket.</span>
00927          <span class="comment">//</span>
00928          <a class="code" href="serverbase_8h.html#a13">SERVICETHREADID_VECTOR</a> _vec;      <span class="comment">// list of items to be removed from list</span>
00929          _vec.reserve(<a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.size()); <span class="comment">// adjust capacity</span>
00930 
00931          <a class="code" href="serverbase_8h.html#a12">SERVICETHREAD_MAP_ITERATOR</a> _sttitr = <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.begin()
00932                                   , _enditr = <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.end()
00933                                   ;
00934          <span class="keywordflow">while</span> ( _sttitr != _enditr )
00935          {
00936 <span class="comment">//            if ( TGlobalUtils::GetLoggingLevel() == WORM_LOG_DEBUG )</span>
00937 <span class="comment">//            {</span>
00938 <span class="comment">//               TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR</span>
00939 <span class="comment">//                             , "WormServerBase::Listener(): checking thread %d (d: %d)\n"</span>
00940 <span class="comment">//                             , _sttitr-&gt;second.threadid</span>
00941 <span class="comment">//                             , _sttitr-&gt;second.descriptor</span>
00942 <span class="comment">//                             );</span>
00943 <span class="comment">//            }</span>
00944 
00945             <span class="keywordflow">switch</span> ( _sttitr-&gt;second.status )
00946             {
00947               <span class="keywordflow">case</span> <a class="code" href="serverbase_8h.html#a22a14">THREAD_ERROR</a>:
00948                    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00949                                  , <span class="stringliteral">"WormServerBase::Listener(): service thread %d reported error\n"</span>
00950                                  , _sttitr-&gt;second.threadid
00951                                  );
00952               <span class="keywordflow">case</span> <a class="code" href="serverbase_8h.html#a22a21">THREAD_COMPLETED</a>:
00953               <span class="keywordflow">case</span> <a class="code" href="serverbase_8h.html#a22a20">THREAD_DISCONNECTED</a>:
00954                    _vec.push_back( _sttitr-&gt;second.descriptor );
00955                    <span class="keywordflow">break</span>;
00956 
00957               <span class="keywordflow">default</span>:
00958                    <span class="keywordflow">if</span> (   (_sttitr-&gt;second.lastpulse + <a class="code" href="serverbase_8h.html#a6">SERVICE_THREAD_PULSE_MAX</a>) &lt; time(NULL)
00959                        &amp;&amp; (_sttitr-&gt;second.status != <a class="code" href="serverbase_8h.html#a22a19">THREAD_BLOCKINGSOCKET</a>)
00960                       )
00961                    {
00962                       <span class="comment">// Service thread found without a pulse for too long, and it is not</span>
00963                       <span class="comment">// making a possibly blocking socket call.</span>
00964                       <span class="comment">// Close socket and kill the thread</span>
00965                       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
00966                                     , <span class="stringliteral">"WormServerBase::Listener(): service thread %d found hung, killing it\n"</span>
00967                                     , _sttitr-&gt;second.threadid
00968                                     );
00969                       <span class="keywordflow">try</span>
00970                       {
00971                          <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( _sttitr-&gt;second.descriptor, SOCKET_CLOSE_SIMPLY_EW );
00972                       }
00973                       <span class="keywordflow">catch</span>( ... ) { } <span class="comment">// ensure that the thread is killed despite any closure error</span>
00974                       <a class="code" href="classThreadableObject.html#e2">KillThread</a>( _sttitr-&gt;second.threadid );
00975                       _vec.push_back( _sttitr-&gt;second.descriptor );
00976                    }
00977                    <span class="keywordflow">break</span>;
00978             }
00979 
00980 
00981             _sttitr++;
00982          }
00983 
00984          <span class="keywordflow">for</span> ( SOCKET _t = 0 ; _t &lt; _vec.size() ; _t++ )
00985          {
00986             <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00987             {
00988                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
00989                              , <span class="stringliteral">"WormServerBase::Listener(): erasing thread %d\n"</span>
00990                              , _vec[_t]
00991                              );
00992             }
00993             <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.erase(_vec[_t]);
00994          }
00995 
00996 
00997          <span class="comment">// =================================================================</span>
00998          <span class="comment">// Try to accept new client</span>
00999          <span class="comment">//</span>
01000          <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.size() == <a class="code" href="classWormServerBase.html#o1">MaxServiceThreads</a> )
01001          {
01002             <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a10">WORM_LOG_STATUS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01003             {
01004                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
01005                              , <span class="stringliteral">"WormServerBase::Listener(): maxed out on service threads, cannot service client\n"</span>
01006                              );
01007             }
01008             <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(WAIT_FOR_SERVICE_THREAD);
01009          }
01010          <span class="keywordflow">else</span>
01011          {
01012 <span class="comment">//            if ( TGlobalUtils::GetLoggingLevel() == WORM_LOG_DEBUG )</span>
01013 <span class="comment">//            {</span>
01014 <span class="comment">//               TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR</span>
01015 <span class="comment">//                             , "WormServerBase::Listener(): waiting for new connection\n"</span>
01016 <span class="comment">//                             );</span>
01017 <span class="comment">//            }</span>
01018 
01019 
01020             <a class="code" href="struct__ServiceThreadInfoStruct.html">_ServiceThreadInfoStruct</a> _newconn_info;
01021             _newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m4">status</a> = <a class="code" href="serverbase_8h.html#a22a15">THREAD_STARTING</a>;
01022 
01023             _clientaddrlength = <span class="keyword">sizeof</span>(_newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m3">sock_addr</a>);
01024 
01025             <span class="comment">// Don't use a blocking socket here (-1), so the loop can clean up</span>
01026             <span class="comment">// dead threads if needed.</span>
01027             _newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m0">descriptor</a> = <a class="code" href="socket__ew__common_8c.html#a10">accept_ew</a>( PassiveSocket
01028                                                 , (<span class="keyword">struct</span> sockaddr*)&amp;_newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m3">sock_addr</a>
01029                                                 , &amp;_clientaddrlength
01030                                                 , 100 <span class="comment">// do not make this -1</span>
01031                                                 );
01032 
01033             <span class="keywordflow">if</span>( _newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m0">descriptor</a> == INVALID_SOCKET )
01034             {
01035 <span class="preprocessor">#if defined(_WINNT) || defined(_Windows)</span>
01036 <span class="preprocessor"></span>
01037                <span class="keywordtype">int</span> _err = <a class="code" href="socket__ew_8c.html#a6">socketGetError_ew</a>();
01038                <span class="keywordflow">switch</span>( _err )
01039                {
01040                  <span class="keywordflow">case</span> WSAEMFILE:
01041                       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01042                                     , <span class="stringliteral">"WormServerBase::Listener(): accept_ew() returned error: no descriptors available\n"</span>
01043                                     );
01044                       <span class="comment">// queue not empty, no descriptors available (can try again later)</span>
01045                       <span class="keywordflow">break</span>;
01046                  <span class="keywordflow">case</span> WSAEWOULDBLOCK:
01047 <span class="comment">//                      if ( TGlobalUtils::GetLoggingLevel() == WORM_LOG_DEBUG )</span>
01048 <span class="comment">//                      {</span>
01049 <span class="comment">//                         TLogger::Logit( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP</span>
01050 <span class="comment">//                                       , "WormServerBase::Listener(): accept_ew() returned error, no connection attempt\n"</span>
01051 <span class="comment">//                                       );</span>
01052 <span class="comment">//                      }</span>
01053                       <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
01054                       <span class="keywordflow">break</span>;
01055                  <span class="keywordflow">default</span>:
01056                       <span class="keywordflow">throw</span> <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a>( WSF_ACCEPT
01057                                                  , _err
01058                                                  , <span class="stringliteral">"Socket error returned from accept_ew()"</span>
01059                                                  );
01060                }
01061 <span class="preprocessor">#else</span>
01062 <span class="preprocessor"></span>               <span class="comment">/* TODO : FINISH NON-WINDOWS ERROR HANDLING */</span>
01063                <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( PassiveSocket, SOCKET_CLOSE_IMMEDIATELY_EW );
01064                <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = INVALID_SOCKET;
01065                <span class="keywordflow">continue</span>;
01066 <span class="preprocessor">#endif</span>
01067 <span class="preprocessor"></span>            }
01068             <span class="keywordflow">else</span>
01069             {
01070                strcpy( _newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m2">ipaddr</a>, inet_ntoa(_newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m3">sock_addr</a>.sin_addr) );
01071 
01072                <span class="comment">// Start the Service thread</span>
01073                <span class="comment">//</span>
01074                <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a10">WORM_LOG_STATUS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01075                {
01076                   <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01077                                 , <span class="stringliteral">"WormServerBase::Listener(): Connection accepted from IP address %s\n"</span>
01078                                 , _newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m2">ipaddr</a>
01079                                 );
01080                }
01081 
01082                <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_newconn_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m0">descriptor</a>] = _newconn_info;
01083 
01084                TO_THREAD_ID _newthreadid;
01085 
01086                <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#b0">StartThreadWithArg</a>( (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)THREAD_STACK
01087                                       , &amp;_newthreadid
01088                                       , &amp;_newconn_info.descriptor
01089                                       )  == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
01090                {
01091                   <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( _newconn_info.descriptor, SOCKET_CLOSE_IMMEDIATELY_EW );
01092                   <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.erase(_newconn_info.descriptor);
01093                   <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01094                   {
01095                      <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01096                                    , <span class="stringliteral">"WormServerBase::Listener(): failed to start service thread\n"</span>
01097                                    , _newconn_info.ipaddr
01098                                    );
01099                   }
01100                   <span class="keywordflow">continue</span>;
01101                }
01102 
01103                <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_newconn_info.descriptor].threadid = _newthreadid;
01104 
01105                <span class="comment">// Check to see if the thread has awakened</span>
01106                <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a12">WORM_LOG_DETAILS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01107                {
01108                   <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01109                                 , <span class="stringliteral">"WormServerBase::Listener(): waiting for thread %d to come alive\n"</span>
01110                                 , _newthreadid
01111                                 );
01112                }
01113 
01114                <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> = time(NULL);
01115                <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(ACCEPTABLE_SEC_TO_WAIT_FOR_SERVICE_THREAD_TO_START);
01116 
01117                <span class="keywordflow">if</span> (   0 &lt; <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.count(_newconn_info.descriptor)
01118                    &amp;&amp; <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_newconn_info.descriptor].status == <a class="code" href="serverbase_8h.html#a22a15">THREAD_STARTING</a>
01119                   )
01120                {
01121                   <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01122                   {
01123                      <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01124                                    , <span class="stringliteral">"WormServerBase::Listener(): Thread %d never went to busy, killing it\n"</span>
01125                                    , _newthreadid
01126                                    );
01127                   }
01128                   <span class="comment">// A confused thread running around out there,</span>
01129                   <span class="comment">// clean up the socket and kill it</span>
01130                   <span class="comment">//</span>
01131                   <a class="code" href="classThreadableObject.html#e2">KillThread</a>( _newthreadid );
01132                   <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( _newconn_info.descriptor, SOCKET_CLOSE_IMMEDIATELY_EW );
01133                   <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.erase(_newconn_info.descriptor);
01134                }
01135 
01136             } <span class="comment">// accept_ew() successful</span>
01137 
01138          } <span class="comment">// thread available (not maxed out)</span>
01139 
01140       } <span class="comment">// Running == true</span>
01141    }
01142    <span class="keywordflow">catch</span>( <a class="code" href="classworm__socket__exception.html">worm_socket_exception</a>&amp; _se )
01143    {
01144       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01145                     , <span class="stringliteral">"WormServerBase::Listener(): socket exception:\n%s\n"</span>
01146                     , _se.DecodeError()
01147                     );
01148    }
01149    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a>&amp; _we )
01150    {
01151       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR|WORM_LOG_TIMESTAMP
01152                     , <span class="stringliteral">"WormServerBase::Listener(): %s\n"</span>
01153                     , _we.what()
01154                     );
01155    }
01156 
01157 
01158    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> != INVALID_SOCKET )
01159    {
01160       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
01161                     , <span class="stringliteral">"WormServerBase::Listener(): closing passive socket\n"</span>
01162                     );
01163       <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( PassiveSocket, SOCKET_CLOSE_IMMEDIATELY_EW );
01164       <a class="code" href="classWormServerBase.html#o0">PassiveSocket</a> = INVALID_SOCKET;
01165    }
01166 
01167    <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TOSTDERR
01168                  , <span class="stringliteral">"WormServerBase::Listener(): returning\n"</span>
01169                  );
01170 
01171 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:10 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
