<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mfc_dlog_modl_base.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>mfc_dlog_modl_base.cpp</h1><a href="mfc__dlog__modl__base_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// mfc_dlog_modl_base.cpp: implementation of the CMFCDialogModuleBase class.</span>
00002 <span class="comment">//</span>
00004 <span class="comment"></span>
00005 <span class="preprocessor">#include "<a class="code" href="mfc__dlog__modl__base_8h.html">mfc_dlog_modl_base.h</a>"</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="worm__environ_8h.html">worm_environ.h</a>&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;<a class="code" href="timefuncs_8h.html">timefuncs.h</a>&gt;</span>
00009 
00010 <span class="comment">//#ifdef _DEBUG</span>
00011 <span class="comment">//#define new DEBUG_NEW</span>
00012 <span class="comment">//#undef THIS_FILE</span>
00013 <span class="comment">//static char THIS_FILE[]=__FILE__;</span>
00014 <span class="comment">//#endif</span>
00015 
00016 
00018 <span class="comment">// Construction/Destruction</span>
00020 <span class="comment"></span>
<a name="l00021"></a><a class="code" href="classCMFCDialogModuleBase.html#a1">00021</a> <a class="code" href="classCMFCDialogModuleBase.html#a1">CMFCDialogModuleBase::CMFCDialogModuleBase</a>()
00022 {
00023    <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a> = NULL;
00024 
00025    <a class="code" href="classCMFCDialogModuleBase.html#n4">CommandRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00026    <a class="code" href="classCMFCDialogModuleBase.html#n5">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00027    <a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00028    <a class="code" href="classCMFCDialogModuleBase.html#n8">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00029    <a class="code" href="classCMFCDialogModuleBase.html#o0">MaxMessageLength</a> = 0;
00030    <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a> = NULL;
00031    <a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a> = 0;
00032 }
00033 
<a name="l00034"></a><a class="code" href="classCMFCDialogModuleBase.html#a2">00034</a> <a class="code" href="classCMFCDialogModuleBase.html#a2">CMFCDialogModuleBase::~CMFCDialogModuleBase</a>()
00035 {
00036    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> != <a class="code" href="classCMFCDialogModuleBase.html#n4">CommandRingKey</a> )
00037    {
00038       <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n8">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00039       {
00040          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;InputRegion );
00041          <a class="code" href="classCMFCDialogModuleBase.html#n8">InputRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00042       }
00043    }
00044    <span class="keywordflow">if</span> ( CommandRingKey )
00045    {
00046       <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n5">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00047       {
00048          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;CommandRegion );
00049          <a class="code" href="classCMFCDialogModuleBase.html#n5">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00050       }
00051    }
00052    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a> != NULL )
00053    {
00054       <span class="keyword">delete</span>( MessageBuffer );
00055       <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a> = NULL;
00056    }
00057    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a> != NULL )
00058    {
00059       <span class="keyword">delete</span>( MyGlobalUtils );
00060       <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a> = NULL;
00061    }
00062 }
00063 
00065 
<a name="l00066"></a><a class="code" href="classCMFCDialogModuleBase.html#b2">00066</a> <span class="keywordtype">bool</span> <a class="code" href="classCMFCDialogModuleBase.html#b2">CMFCDialogModuleBase::PrepApp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * p_configfilename)
00067 {
00068    <span class="keywordflow">try</span>
00069    {
00070       <span class="comment">// ----- Get the global utilities before parsing the command file -----</span>
00071       <span class="comment">//</span>
00072       <span class="comment">// Need an instance of the TGlobalUtils class for holding global values.</span>
00073       <span class="comment">// (Once initialized, all further uses are through static class methods).</span>
00074       <span class="comment">//</span>
00075       <span class="comment">// The constructor reads the lookup files specified in the environment.</span>
00076       <span class="comment">// Then ParseCommandFile() allows any method-specific overrides.</span>
00077       <span class="comment">// </span>
00078       <span class="keywordflow">if</span> ( (<a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a> = <span class="keyword">new</span> <a class="code" href="classTGlobalUtils.html">TGlobalUtils</a>(m_lpCmdLine)) == NULL )
00079       {
00080          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating global utilities object"</span>);
00081       }
00082 
00083       <a class="code" href="classCMFCDialogAppBase.html#n1">LoggingLevel</a> = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>();
00084 
00085       <span class="comment">// Change working directory to environment variable EW_PARAMS value</span>
00086       <span class="keywordtype">char</span> * runPath = NULL;
00087 
00088       <span class="keywordtype">bool</span> _isEW = <span class="keyword">false</span>;
00089 
00090       <span class="keywordflow">if</span> ( (runPath = <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>( WORM_CONFIG_DIR )) == NULL )
00091       {
00092          _isEW = <span class="keyword">true</span>;
00093          runPath = <a class="code" href="classTGlobalUtils.html#d2">TGlobalUtils::GetEnvironmentValue</a>( EW_CONFIG_DIR );
00094       }
00095 
00096       <span class="keywordflow">if</span> ( runPath == NULL )
00097       {
00098          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Neither environment variable &lt;"</span> );
00099          _expt += <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>;
00100          _expt += <span class="stringliteral">"&gt; nor &lt;"</span>;
00101          _expt += <a class="code" href="worm__environ_8h.html#a7">EW_CONFIG_DIR</a>;
00102          _expt += <span class="stringliteral">"&gt; is defined"</span>;
00103          <span class="keywordflow">throw</span> _expt;
00104       }
00105 
00106       <span class="keywordflow">if</span> ( *runPath == <span class="charliteral">'\0'</span> )
00107       {
00108          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Environment variable "</span> );
00109          _expt += (_isEW ? <a class="code" href="worm__environ_8h.html#a7">EW_CONFIG_DIR</a> : <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>);
00110          _expt += <span class="stringliteral">" defined, but has no value"</span>;
00111          <span class="keywordflow">throw</span> _expt;
00112       }
00113 
00114       <span class="keywordflow">if</span> ( ! SetCurrentDirectory( runPath ) )
00115       {
00116          <a class="code" href="classworm__exception.html">worm_exception</a> _expt( <span class="stringliteral">"Params directory not found: "</span> );
00117          _expt += runPath;
00118          _expt += <span class="stringliteral">"\nPlease set environment variable "</span>;
00119          _expt += <a class="code" href="worm__environ_8h.html#a6">WORM_CONFIG_DIR</a>;
00120          <span class="keywordflow">throw</span> _expt;
00121       }
00122    }
00123    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00124    {
00125       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00126                     , <span class="stringliteral">"CMFCDialogModuleBase::PrepApp(): %s\n"</span>
00127                     , _we.what()
00128                     );
00129       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00130    }
00131 
00132    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00133 }
00134 
00136 
<a name="l00137"></a><a class="code" href="classCMFCDialogModuleBase.html#b0">00137</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classCMFCDialogModuleBase.html#b0">CMFCDialogModuleBase::HandleConfigLine</a>(<a class="code" href="classConfigSource.html">ConfigSource</a> *p_parser)
00138 {
00139    <span class="comment">// Do not manipulate ConfigState herein.</span>
00140    <span class="comment">//</span>
00141 
00142    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_handled = <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a>-&gt;<a class="code" href="classTGlobalUtils.html#a1">HandleConfigLine</a>( p_parser );
00143 
00144 
00145    <span class="keywordflow">if</span> ( r_handled == <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00146    {
00147       <span class="keywordflow">try</span>
00148       {
00149          <span class="keyword">static</span> <span class="keywordtype">char</span> * _token;
00150 
00151          <span class="keywordflow">do</span>
00152          {
00153 
00154 
00155             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"AcceptLogo"</span>) )
00156             {
00157                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00158 
00159                <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a> == <a class="code" href="mfc__dlog__modl__base_8h.html#a6">SERVE_MAX_LOGOS</a> )
00160                {
00161                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Attempt to load too many &lt;AcceptLogo&gt; lines"</span>);
00162                }
00163 
00164                <span class="comment">// AcceptLogo    INST_WILDCARD   MOD_GLASS       TYPE_WILDCARD</span>
00165 
00166                <span class="comment">// INSTALLATION</span>
00167 
00168                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00169 
00170                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00171                {
00172                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;AcceptLogo&gt; line (no installation)"</span>);
00173                }
00174 
00175                <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].instid = <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(_token);
00176 
00177                <span class="keywordflow">if</span> (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].instid == <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(<span class="stringliteral">"INST_WILDCARD"</span>)
00178                    &amp;&amp; strcmp(_token, <span class="stringliteral">"INST_WILDCARD"</span>) != 0
00179                   )
00180                {
00181                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized installation id: "</span>);
00182                   _expt += _token;
00183                   <span class="keywordflow">throw</span> _expt;
00184                }
00185 
00186                <span class="comment">// MODULE</span>
00187 
00188                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00189 
00190                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00191                {
00192                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;AcceptLogo&gt; line (no module)"</span>);
00193                }
00194 
00195                <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].mod = <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(_token);
00196 
00197                <span class="keywordflow">if</span> (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].mod == <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(<span class="stringliteral">"MOD_WILDCARD"</span>)
00198                    &amp;&amp; strcmp(_token, <span class="stringliteral">"MOD_WILDCARD"</span>) != 0
00199                   )
00200                {
00201                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized module id: "</span>);
00202                   _expt += _token;
00203                   <span class="keywordflow">throw</span> _expt;
00204                }
00205 
00206                <span class="comment">// MESSAGE TYPE</span>
00207 
00208                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00209 
00210                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00211                {
00212                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;AcceptLogo&gt; line (no message type)"</span>);
00213                }
00214 
00215                <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].type = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(_token);
00216 
00217                <span class="keywordflow">if</span> (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[<a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>].type == <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_WILDCARD"</span>)
00218                    &amp;&amp; strcmp(_token, <span class="stringliteral">"TYPE_WILDCARD"</span>) != 0
00219                   )
00220                {
00221                   <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Unrecognized message type id: "</span>);
00222                   _expt += _token;
00223                   <span class="keywordflow">throw</span> _expt;
00224                }
00225 
00226                <a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a>++;
00227 
00228                <span class="keywordflow">continue</span>;
00229             }
00230 
00231             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"CmdRingName"</span>) )
00232             {
00233                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00234                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00235                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00236                {
00237                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;CmdRingName&gt; value"</span>);
00238                }
00239                strncpy( CommandRingName, _token, MAX_RINGNAME_LEN );
00240 
00241                <span class="keywordflow">if</span> ( (<a class="code" href="classCMFCDialogModuleBase.html#n4">CommandRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(CommandRingName)) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00242                {
00243                   <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;CmdRingName&gt; value"</span>);
00244                }
00245 
00246                <span class="keywordflow">continue</span>;
00247             }
00248 
00249             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"InputRingName"</span>) )
00250             {
00251                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00252                _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00253                <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00254                {
00255                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;InputRing&gt; for input messages"</span>);
00256                }
00257                strncpy( InputRingName, _token, MAX_RINGNAME_LEN );
00258 
00259                <span class="keywordflow">if</span> ( (<a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(InputRingName)) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00260                {
00261                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;InputRing&gt;"</span>);
00262                }
00263                <span class="keywordflow">continue</span>;
00264             }
00265 
00266             <span class="keywordflow">if</span>( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"MaxMsgSize"</span>) )
00267             {
00268                r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00269                <span class="keywordtype">int</span> _maxmsglen = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>();
00270                <span class="keywordflow">if</span> ( _maxmsglen &lt;= 0 )
00271                {
00272                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;MaxMsgSize&gt; for input messages"</span>);
00273                }
00274                <a class="code" href="classCMFCDialogModuleBase.html#o0">MaxMessageLength</a> = _maxmsglen;
00275                <span class="keywordflow">continue</span>;
00276             }
00277 
00278          } <span class="keywordflow">while</span>( false );
00279       }
00280       <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00281       {
00282          r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00283          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00284                       , <span class="stringliteral">"CMFCDialogModuleBase::HandleConfigLine(): configuration error: %s\nin line: %s\n"</span>
00285                       , _we.what()
00286                       , p_parser-&gt;<a class="code" href="classConfigSource.html#a4">GetCurrentLine</a>()
00287                       );
00288       }
00289    }
00290 
00291    <span class="keywordflow">return</span> r_handled;
00292 }
00293 
00295 
<a name="l00296"></a><a class="code" href="classCMFCDialogModuleBase.html#b1">00296</a> <span class="keywordtype">void</span> <a class="code" href="classCMFCDialogModuleBase.html#b1">CMFCDialogModuleBase::CheckConfig</a>()
00297 {
00298 <span class="comment">//   CMFCDialogAppBase::CheckConfig();</span>
00299 
00300    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a> == NULL )
00301    {
00302       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00303                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): Global Configurations object not created\n"</span>
00304                     );
00305       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00306    }
00307    <span class="keywordflow">else</span>
00308    {
00309       <a class="code" href="classCMFCDialogAppBase.html#n1">LoggingLevel</a> = <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>();
00310       
00311       <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogModuleBase.html#n0">MyGlobalUtils</a>-&gt;<a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00312       {
00313          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00314                        , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): Global Configurations object not configured\n"</span>
00315                        );
00316          <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00317       }
00318    }
00319 
00320    <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() &lt; 1 )
00321    {
00322       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00323                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): No &lt;HeartBeatInt&gt; value from the config file\n"</span>
00324                     );
00325       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00326    }
00327 
00328    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a> == 0 )
00329    {
00330       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00331                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): No &lt;AcceptLogo&gt; lines found in the config file\n"</span>
00332                     );
00333       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00334    }
00335 
00336    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n4">CommandRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00337    {
00338       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00339                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): No &lt;CmdRingName&gt; value from the config file\n"</span>
00340                     );
00341       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00342    }
00343 
00344 
00345         <span class="keywordflow">if</span>( (<a class="code" href="classCMFCDialogModuleBase.html#n2">TYPE_HEARTBEAT</a> = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_HEARTBEAT"</span>)) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00346         {
00347       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00348                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): Message type TYPE_HEARTBEAT not defined\n"</span>
00349                     );
00350       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00351         }
00352 
00353         <span class="keywordflow">if</span>( (<a class="code" href="classCMFCDialogModuleBase.html#n1">TYPE_ERROR</a> = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_ERROR"</span>)) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00354         {
00355       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00356                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): Message type TYPE_ERROR not defined\n"</span>
00357                     );
00358       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00359         }
00360 
00361    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#o0">MaxMessageLength</a> &lt;= 1 )
00362    {
00363       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00364                     , <span class="stringliteral">"CMFCDialogModuleBase::CheckConfig(): No valid &lt;MaxMsgSize&gt; found in the config file\n"</span>
00365                     );
00366       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00367    }
00368 }
00369 
00371 
<a name="l00372"></a><a class="code" href="classCMFCDialogModuleBase.html#b3">00372</a> <span class="keywordtype">bool</span> <a class="code" href="classCMFCDialogModuleBase.html#b3">CMFCDialogModuleBase::InitApp</a>()
00373 {
00374    <span class="keywordtype">bool</span> r_status = <span class="keyword">true</span>;
00375 
00376 
00377    <span class="keywordflow">try</span>
00378    {
00379       <span class="comment">// Start status thread</span>
00380 
00381 
00382       <span class="keywordflow">if</span> ( (<a class="code" href="classCMFCDialogModuleBase.html#n11">StatusThread</a> = AfxBeginThread( StartMFCWorkerThread
00383                                          , <span class="keyword">this</span>
00384                                          , 0
00385                                          , 0
00386                                          , NULL
00387                                          )) == NULL )
00388       {
00389          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed starting the status thread"</span>);
00390       }
00391    
00392       <span class="comment">// Five previous thread time to lookup thread type id variable</span>
00393       <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>( 300 );
00394 
00395    }
00396    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00397    {
00398       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00399                    , <span class="stringliteral">"CMFCDialogModuleBase::InitApp(): Error: %s\n"</span>
00400                    , _we.what()
00401                    );
00402       r_status = <span class="keyword">false</span>;
00403    }
00404 
00405    <span class="keywordflow">return</span> r_status;
00406 }
00407 
00409 
<a name="l00410"></a><a class="code" href="classCMFCDialogModuleBase.html#b4">00410</a> <span class="keywordtype">bool</span> <a class="code" href="classCMFCDialogModuleBase.html#b4">CMFCDialogModuleBase::BeforeMessage</a>() { <span class="keywordflow">return</span> <span class="keyword">true</span>; }
00411 
00413 
<a name="l00414"></a><a class="code" href="classCMFCDialogModuleBase.html#a0">00414</a> UINT <a class="code" href="classCMFCDialogModuleBase.html#a0">CMFCDialogModuleBase::StartWorkerThread</a>()
00415 {
00416    <span class="keywordflow">return</span> <a class="code" href="classCMFCDialogModuleBase.html#b8">StatusAndReadLoop</a>();
00417 }
00418 
00420 
<a name="l00421"></a><a class="code" href="classCMFCDialogModuleBase.html#b8">00421</a> UINT <a class="code" href="classCMFCDialogModuleBase.html#b8">CMFCDialogModuleBase::StatusAndReadLoop</a>()
00422 {
00423    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> InstallWildcard = <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(<span class="stringliteral">"INST_WILDCARD"</span>)
00424                , ModuleWildcard  = <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(<span class="stringliteral">"MOD_WILDCARD"</span>)
00425                , MessageWildcard = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_WILDCARD"</span>)
00426                ;
00427 
00428    UINT r_status = 0;
00429 
00430    <span class="keywordflow">try</span>
00431    {
00432       <span class="comment">// pause for second to allow the dialog window to initialize</span>
00433       <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>( 1000 );
00434 
00435 <span class="comment">//      if ( ConfigState != WORM_STAT_SUCCESS )</span>
00436 <span class="comment">//      {</span>
00437 <span class="comment">//         throw worm_exception("WormServerBase::Run() Server not configured");</span>
00438 <span class="comment">//      }</span>
00439 
00440       <span class="comment">// create the command/status ring writer</span>
00441 
00442       <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;CommandRegion, CommandRingKey );
00443 
00444 
00445       <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00446       {
00447          <span class="comment">// having a valid ring key means that </span>
00448          <span class="comment">// we want to be able to read messages from</span>
00449          <span class="comment">// an input ring.</span>
00450          <span class="comment">//</span>
00451 
00452          <span class="keywordflow">if</span> ( (<a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="classCMFCDialogModuleBase.html#o0">MaxMessageLength</a>+1]) == NULL )
00453          {
00454             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"RingReaderServer::PrepareToRun(): failed allocating message buffer"</span>);
00455          }
00456 
00457          <span class="comment">// The input region may or may not be the same as the command region</span>
00458          <span class="comment">//</span>
00459          <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> != <a class="code" href="classCMFCDialogModuleBase.html#n4">CommandRingKey</a> )
00460          {
00461             <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;InputRegion, InputRingKey );
00462          }
00463          <span class="keywordflow">else</span>
00464          {
00465             memcpy( (<span class="keywordtype">void</span> *)&amp;InputRegion , (<span class="keywordtype">void</span> *)&amp;CommandRegion, <span class="keyword">sizeof</span>(InputRegion) );
00466          }
00467       }
00468 
00469 
00470 
00471       <span class="keywordtype">int</span> flag;
00472    
00473       <span class="keywordtype">long</span> CurrentTime
00474          , LastBeatTime
00475          ;
00476       <span class="keywordtype">bool</span>     MsgIsReady = <span class="keyword">false</span>;
00477       <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a> _arrivelogo;        <span class="comment">// logo of arriving message</span>
00478       <span class="keywordtype">long</span>     _arr_msg_len;       <span class="comment">// length of arriving message</span>
00479       <span class="keywordtype">char</span>     _errormsg[300];
00480 
00481 
00482       <span class="comment">// initialize the Times</span>
00483       <span class="comment">//</span>
00484       time(&amp;CurrentTime);
00485       LastBeatTime = CurrentTime;
00486 
00487 
00488       <span class="comment">// skip over any messages in the ring</span>
00489       <span class="comment">//</span>
00490       <span class="keywordflow">while</span>( <a class="code" href="transport_8c.html#a20">tport_getmsg</a>( &amp;InputRegion
00491                          ,  AcceptLogo
00492                          ,  AcceptLogoCount
00493                          , &amp;_arrivelogo
00494                          , &amp;_arr_msg_len
00495                          ,  MessageBuffer
00496                          ,  MaxMessageLength
00497                          ) != <a class="code" href="transport_8h.html#a9">GET_NONE</a> );
00498 
00499 
00500       <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogModuleBase.html#b4">BeforeMessage</a>() )
00501       {
00502          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"BeforeMessage() returned error"</span>);
00503       }
00504 
00505 
00506       <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">true</span>;
00507       <span class="keywordflow">do</span>
00508       {
00509          <span class="comment">// Check for and respond to stop flags</span>
00510          flag = <a class="code" href="transport_8c.html#a22">tport_getflag</a>(&amp;CommandRegion);
00511          <span class="keywordflow">if</span>( flag == <a class="code" href="transport_8h.html#a17">TERMINATE</a>  ||  flag == (int)<a class="code" href="classTGlobalUtils.html#d6">TGlobalUtils::GetPID</a>() )
00512          {
00513             <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">false</span>; <span class="comment">// signal all threads to return</span>
00514             <span class="keywordflow">continue</span>;
00515          }
00516 
00517          <span class="comment">// Send heartbeat if it is time</span>
00518          <span class="keywordflow">if</span>( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() &lt;= (time(&amp;CurrentTime) - LastBeatTime) )
00519          {
00520             LastBeatTime = CurrentTime;
00521             <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>( TYPE_HEARTBEAT, 0, <span class="stringliteral">""</span> );
00522          }
00523 
00524          <span class="comment">// perform actions that derivative classes need to evaluate</span>
00525          <span class="comment">// existence of fatal error.</span>
00526          <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#b9">CheckForFatal</a>() )
00527          {
00528             <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">false</span>;
00529             <span class="keywordflow">continue</span>;
00530          }
00531 
00532 
00533          <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n7">InputRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00534          {
00535             <span class="comment">// Have an input ring, try to get message</span>
00536             <span class="comment">// from transport ring</span>
00537             <span class="comment">//</span>
00538 
00539             MsgIsReady = <span class="keyword">true</span>;
00540 
00541             <span class="keywordflow">switch</span>(
00542                     <a class="code" href="transport_8c.html#a20">tport_getmsg</a>( &amp;InputRegion
00543                                 ,  AcceptLogo
00544                                 ,  AcceptLogoCount
00545                                 , &amp;_arrivelogo
00546                                 , &amp;_arr_msg_len
00547                                 ,  MessageBuffer
00548                                 ,  MaxMessageLength
00549                                 )
00550                   )
00551             {
00552               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a8">GET_OK</a>:
00553                    <span class="keywordflow">break</span>;
00554 
00555               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a10">GET_MISS</a>:
00556               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a13">GET_MISS_LAPPED</a>:
00557                    <span class="comment">// report error, handle message</span>
00558                    <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>( TYPE_ERROR, ERR_MISSMSG, <span class="stringliteral">"missed messages"</span> );
00559                    <span class="keywordflow">break</span>;
00560 
00561               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a14">GET_MISS_SEQGAP</a>:
00562                    <span class="comment">// report error, handle message</span>
00563                    <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>( TYPE_ERROR, ERR_MISSMSG, <span class="stringliteral">"saw sequence gap"</span> );
00564                    <span class="keywordflow">break</span>;
00565 
00566               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a11">GET_NOTRACK</a>:
00567                    <span class="comment">// report error, handle message</span>
00568                    sprintf( _errormsg
00569                           , <span class="stringliteral">"no tracking for logo i%d m%d t%d in %s"</span>
00570                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00571                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00572                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
00573                           , InputRingName
00574                           );
00575                    <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>( TYPE_ERROR, ERR_NOTRACK, _errormsg );
00576                    <span class="keywordflow">break</span>;
00577 
00578               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a12">GET_TOOBIG</a>:
00579                    <span class="comment">// report error, return to main loop to sleep</span>
00580                    sprintf( _errormsg
00581                           , <span class="stringliteral">"tport msg[%ld] i%d m%d t%d too big. Max is %ld"</span>
00582                           , _arr_msg_len
00583                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00584                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00585                           , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
00586                          , MaxMessageLength
00587                           );
00588                    <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>( TYPE_ERROR, ERR_TOOBIG, _errormsg );
00589 
00590                    <span class="comment">// fall - through</span>
00591 
00592               <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a9">GET_NONE</a>:
00593                    <span class="comment">// no message ready, prepare to sleep before looping</span>
00594                    MsgIsReady = <span class="keyword">false</span>;
00595                    <span class="keywordflow">break</span>;
00596             }
00597 
00598          } <span class="comment">// have input ring</span>
00599 
00600 
00601          <span class="keywordflow">if</span> ( MsgIsReady )
00602          {
00603             <span class="comment">// NULL-terminate string buffer</span>
00604             <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
00605 
00606             <span class="comment">// truncate end-of-line if present</span>
00607             <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a>[_arr_msg_len-1] == <span class="charliteral">'\n'</span> )
00608             {
00609                _arr_msg_len--;
00610                <a class="code" href="classCMFCDialogModuleBase.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
00611             }
00612 
00613             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i = 0, _sz = <a class="code" href="classCMFCDialogModuleBase.html#n10">AcceptLogoCount</a> ; _i &lt; _sz ; _i++ )
00614             {
00615                <span class="keywordflow">if</span> (   (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a> == InstallWildcard
00616                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == InstallWildcard
00617                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a>
00618                       )
00619                    &amp;&amp; (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a> == ModuleWildcard
00620                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == ModuleWildcard
00621                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a>
00622                       )
00623                    &amp;&amp; (   <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a> == MessageWildcard
00624                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == MessageWildcard
00625                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == <a class="code" href="classCMFCDialogModuleBase.html#n9">AcceptLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a>
00626                       )
00627                   )
00628                {
00629                   <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogModuleBase.html#b5">HandleMessage</a>(_arrivelogo, MessageBuffer) )
00630                   {
00631                      <span class="comment">// HandleMessage() reported error state</span>
00632                      <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">false</span>;
00633                   }
00634                   <span class="keywordflow">break</span>;
00635                }
00636             }
00637 
00638          } <span class="comment">// message is ready</span>
00639          <span class="keywordflow">else</span>
00640          {
00641             <span class="comment">// only sleep if no message to check</span>
00642             <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
00643          }
00644 
00645       } <span class="keywordflow">while</span>( Running );
00646 
00647    }
00648    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00649    {
00650       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00651       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00652                     , <span class="stringliteral">"CMFCDialogModuleBase::StatusAndReadLoop(): error: %s\n"</span>
00653                     , _we.what()
00654                     );
00655    }
00656 
00657    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogAppBase.html#b3">GetMainWindow</a>() != NULL )
00658    {
00659       ((CDialog *)<a class="code" href="classCMFCDialogAppBase.html#b3">GetMainWindow</a>())-&gt;EndDialog(IDCANCEL);
00660    }
00661 
00662    <span class="keywordflow">return</span> r_status;
00663 }
00664 
00666 
<a name="l00667"></a><a class="code" href="classCMFCDialogModuleBase.html#b7">00667</a> <span class="keywordtype">void</span> <a class="code" href="classCMFCDialogModuleBase.html#b7">CMFCDialogModuleBase::HeartBeat</a>()
00668 {
00669    <span class="keyword">static</span> <span class="keywordtype">long</span> _lastBeat  = 0
00670              , _interval = <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>()
00671              ;
00672 
00673    <span class="keywordflow">if</span> ( 0 &lt; _interval )
00674    {
00675       <span class="keywordflow">if</span> ( (_lastBeat + _interval) &lt; time(NULL) )
00676       {
00677          <a class="code" href="classCMFCDialogModuleBase.html#b6">SendStatus</a>(TYPE_HEARTBEAT);
00678          _lastBeat = time(NULL);
00679       }
00680    }
00681 }
00682 
00684 
<a name="l00685"></a><a class="code" href="classCMFCDialogModuleBase.html#b6">00685</a> <span class="keywordtype">void</span> <a class="code" href="classCMFCDialogModuleBase.html#b6">CMFCDialogModuleBase::SendStatus</a>( WORM_MSGTYPE_ID   p_type
00686                                      , <span class="keywordtype">short</span>             p_ierr
00687                                      , <span class="keyword">const</span> <span class="keywordtype">char</span>      * p_text
00688                                      )
00689 {
00690    <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogModuleBase.html#n5">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> == NULL )
00691    {
00692       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00693                     , <span class="stringliteral">"CMFCDialogModuleBase::SendStatus(): Command Ring share is NULL\n"</span>
00694                     );
00695       <span class="keywordflow">return</span>;
00696    }
00697 
00698    <span class="keywordflow">try</span>
00699    {
00700       <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a>    logo;
00701            <span class="keywordtype">char</span>        msg[256];
00702            <span class="keywordtype">long</span>        size;
00703            <span class="keywordtype">long</span>        t;
00704         
00705       <span class="comment">/* Build the message</span>
00706 <span class="comment">      *******************/</span>
00707       logo.<a class="code" href="structMSG__LOGO.html#m2">instid</a> = <a class="code" href="classTGlobalUtils.html#d8">TGlobalUtils::GetThisInstallationId</a>();
00708       logo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>    = <a class="code" href="classTGlobalUtils.html#d7">TGlobalUtils::GetThisModuleId</a>();
00709       logo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   = p_type;
00710         
00711       time( &amp;t );
00712 
00713       strcpy( msg, <span class="stringliteral">""</span> );
00714    
00715       <span class="keywordflow">if</span>( p_type == <a class="code" href="classCMFCDialogModuleBase.html#n2">TYPE_HEARTBEAT</a> )
00716       {
00717          sprintf( msg, <span class="stringliteral">"%ld %ld\n\0"</span>, t, TGlobalUtils::GetPID());
00718       }
00719       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( p_type == <a class="code" href="classCMFCDialogModuleBase.html#n1">TYPE_ERROR</a> )
00720       {
00721          sprintf( msg, <span class="stringliteral">"%ld %hd %s\n\0"</span>, t, p_ierr, p_text);
00722       }
00723       <span class="keywordflow">else</span>
00724       {
00725          <span class="keywordflow">if</span> ( <a class="code" href="classCMFCDialogAppBase.html#n1">LoggingLevel</a> == <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> )
00726          {
00727             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00728                           , <span class="stringliteral">"CMFCDialogModuleBase::SendStatus(): invalid message type %d\n"</span>
00729                           , p_type
00730                           );
00731          }
00732          <span class="keywordflow">return</span>;
00733       }
00734         
00735       size = strlen( msg );   <span class="comment">/* don't include the null byte in the message */</span>
00736 
00737       <span class="comment">/* Write the message to shared memory</span>
00738 <span class="comment">      ************************************/</span>
00739 
00740       <span class="keywordflow">if</span>( <a class="code" href="transport_8c.html#a19">tport_putmsg</a>( &amp;CommandRegion, &amp;logo, size, msg ) != <a class="code" href="transport_8h.html#a5">PUT_OK</a> )
00741       {
00742          <span class="keywordflow">if</span>( p_type == <a class="code" href="classCMFCDialogModuleBase.html#n2">TYPE_HEARTBEAT</a> )
00743          {
00744             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00745                           , <span class="stringliteral">"WormServerBase::SendStatus(): Error sending heartbeat.\n"</span>
00746                           );
00747          }
00748          <span class="keywordflow">else</span> <span class="comment">// if( type == TYPE_ERROR )</span>
00749          {
00750             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00751                           , <span class="stringliteral">"WormServerBase::SendStatus(): Error sending error: %d.\n"</span>
00752                           , p_ierr
00753                           );
00754          }
00755       }
00756    }
00757    <span class="keywordflow">catch</span>( ... )
00758    {
00759       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00760                     , <span class="stringliteral">"TModuleBase::SendStatus() Error\n"</span>
00761                     );
00762       <span class="comment">// so serious we must exit</span>
00763       <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">false</span>;
00764    }
00765 }
00766 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:05 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
