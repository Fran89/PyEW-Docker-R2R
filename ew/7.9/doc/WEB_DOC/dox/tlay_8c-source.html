<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tlay.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>tlay.c</h1><a href="tlay_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *   THIS FILE IS UNDER RCS - DO NOT MODIFY UNLESS YOU HAVE</span>
00004 <span class="comment"> *   CHECKED IT OUT USING THE COMMAND CHECKOUT.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *    $Id: tlay_8c-source.html 2161 2006-05-19 16:55:03Z paulf $</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *    Revision history:</span>
00009 <span class="comment"> *     $Log$
00009 <span class="comment"> *     Revision 1.1  2006/05/19 16:55:02  paulf
00009 <span class="comment"> *     first inclusion
00009 <span class="comment"> *</span>
00010 <span class="comment"> *     Revision 1.1  2000/02/14 18:51:48  lucky</span>
00011 <span class="comment"> *     Initial revision</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> */</span>
00015 
00016 <span class="comment">/*</span>
00017 <span class="comment"> * tlay.c : Travel-time in layered half space (ala Eaton)</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *$ 95Oct19 LDD Explicitly declared return types for all functions.</span>
00020 <span class="comment"> *              Added function prototypes to tlay.h</span>
00021 <span class="comment"> */</span>
00022 <span class="comment">/*********************C O P Y R I G H T   N O T I C E ***********************/</span>
00023 <span class="comment">/* Copyright 1991 by Carl Johnson.  All rights are reserved. Permission     */</span>
00024 <span class="comment">/* is hereby granted for the use of this product for nonprofit, commercial, */</span>
00025 <span class="comment">/* or noncommercial publications that contain appropriate acknowledgement   */</span>
00026 <span class="comment">/* of the author. Modification of this code is permitted as long as this    */</span>
00027 <span class="comment">/* notice is included in each resulting source module.                      */</span>
00028 <span class="comment">/****************************************************************************/</span>
00029 <span class="preprocessor">#include &lt;math.h&gt;</span>
00030 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="kom_8h.html">kom.h</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="tlay_8h.html">tlay.h</a>&gt;</span>
00034 
<a name="l00035"></a><a class="code" href="tlay_8c.html#a0">00035</a> <span class="preprocessor">#define Panic(x) (fprintf(stderr,"Panic point %d in tlay.c\n",(x)),exit(-1))</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="tlay_8c.html#a1">00037</a> <span class="preprocessor">#define MAXLAY 20</span>
<a name="l00038"></a><a class="code" href="tlay_8c.html#a2">00038</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a2">nLay</a> = 0;
<a name="l00039"></a><a class="code" href="tlay_8c.html#a3">00039</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a3">iRef</a>;
00040 
00041 <span class="comment">/* Function prototypes from other source files*/</span>
00042 <span class="keywordtype">void</span> <a class="code" href="mnbrak_8c.html#a6">mnbrak</a>(<span class="keywordtype">float</span> *, <span class="keywordtype">float</span> *, <span class="keywordtype">float</span> *, <span class="keywordtype">float</span> *, <span class="keywordtype">float</span> *, <span class="keywordtype">float</span> *, <span class="keywordtype">float</span>(*)(<span class="keywordtype">float</span>) );
00043 <span class="keywordtype">float</span> <a class="code" href="brent_8c.html#a5">brent</a>(<span class="keywordtype">float</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span> (*)(<span class="keywordtype">float</span>), <span class="keywordtype">float</span>, <span class="keywordtype">float</span> *);
00044 
00045 <span class="comment">/* Global variables is used by t_fun and t_dis function                 */</span>
<a name="l00046"></a><a class="code" href="tlay_8c.html#a4">00046</a> <span class="keyword">static</span> <span class="keywordtype">int</span>    <a class="code" href="tlay_8c.html#a4">iSrc</a>;     <span class="comment">/* Source layer index, for direct ray           */</span>
<a name="l00047"></a><a class="code" href="tlay_8c.html#a5">00047</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a5">zSrc</a>;     <span class="comment">/* Source depth, for direct ray calc            */</span>
<a name="l00048"></a><a class="code" href="tlay_8c.html#a6">00048</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a6">xSrc</a>;     <span class="comment">/* Source distance, for direct ray calc         */</span>
00049 
00050 <span class="comment">/* Global variables set by t_set and used by t_lay for fast calculations*/</span>
<a name="l00051"></a><a class="code" href="tlay_8c.html#a7">00051</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a7">zTop</a>[2*<a class="code" href="tlay_8c.html#a1">MAXLAY</a>];
<a name="l00052"></a><a class="code" href="tlay_8c.html#a8">00052</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a8">vLay</a>[2*<a class="code" href="tlay_8c.html#a1">MAXLAY</a>];
00053 
00054 <span class="comment">/* Travel time command processing       */</span>
<a name="l00055"></a><a class="code" href="tlay_8c.html#a9">00055</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a9">initMod</a>   = 0;
<a name="l00056"></a><a class="code" href="tlay_8c.html#a10">00056</a> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a10">PoverS</a> = 1.72;
00057 
00058 <span class="comment">/***********************************************************************</span>
00059 <span class="comment"> *   t_com():  Process all recognized commands.                        *</span>
00060 <span class="comment"> *             Return 1 on success, 0 if command was not recognized    *</span>
00061 <span class="comment"> ***********************************************************************/</span>
<a name="l00062"></a><a class="code" href="tlay_8c.html#a13">00062</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a13">t_com</a>( <span class="keywordtype">void</span> )
00063 {
00064         <span class="keywordtype">double</span> z, v, r, t, dtdr, dtdz;
00065         <span class="keywordtype">double</span> tz, tr;
00066         <span class="keywordtype">double</span> rmax, rdel;
00067         <a class="code" href="structTPHASE.html">TPHASE</a> treg[4];
00068         <span class="keywordtype">int</span> np;
00069         <span class="keywordtype">int</span> i;
00070 
00071         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"lay"</span>)) {
00072                 z = <a class="code" href="kom_8c.html#a17">k_val</a>();
00073                 v = <a class="code" href="kom_8c.html#a17">k_val</a>();
00074                 <a class="code" href="tlay_8c.html#a14">t_model</a>(z, v);
00075                 <span class="keywordflow">return</span> 1;
00076         }
00077 
00078         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"psratio"</span>)) {
00079                 <a class="code" href="tlay_8c.html#a10">PoverS</a> = <a class="code" href="kom_8c.html#a17">k_val</a>();
00080                 <span class="keywordflow">return</span> 1;
00081         }
00082 
00083         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"ray"</span>)) {
00084                 z = <a class="code" href="kom_8c.html#a17">k_val</a>();
00085                 r = <a class="code" href="kom_8c.html#a17">k_val</a>();
00086                 t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, &amp;dtdr, &amp;dtdz);
00087                 fprintf(stdout, <span class="stringliteral">"%6.2f : %6.2f %6.2f %6.2f %6.2f\n"</span>,
00088                         t, r, z, dtdr, dtdz);
00089                 <span class="keywordflow">return</span> 1;
00090         }
00091 
00092         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"raytst"</span>)) {
00093                 <a class="code" href="tlay_8c.html#a15">t_set</a>();
00094                 z = <a class="code" href="kom_8c.html#a17">k_val</a>();
00095                 rmax = <a class="code" href="kom_8c.html#a17">k_val</a>();
00096                 rdel = <a class="code" href="kom_8c.html#a17">k_val</a>();
00097                 <span class="keywordflow">for</span>(r=rdel; r&lt;rmax; r+=rdel) {
00098                         tr = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r+0.1, z, &amp;dtdr, &amp;dtdz);
00099                         tz = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z+0.1, &amp;dtdr, &amp;dtdz);
00100                         t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, &amp;dtdr, &amp;dtdz);
00101                         fprintf(stdout,
00102                                 <span class="stringliteral">"%d %6.1f %6.1f %6.2f %6.2f %6.2f %6.2f\n"</span>,
00103                                 iRef, z, r, dtdr, dtdz,
00104                                 10.0*(tr-t), 10.0*(tz-t));
00105                 }
00106                 <span class="keywordflow">return</span> 1;
00107         }
00108 
00109         <span class="keywordflow">if</span>(<a class="code" href="kom_8c.html#a11">k_its</a>(<span class="stringliteral">"region"</span>)) {
00110                 <a class="code" href="tlay_8c.html#a15">t_set</a>();
00111                 z = <a class="code" href="kom_8c.html#a17">k_val</a>();
00112                 rmax = <a class="code" href="kom_8c.html#a17">k_val</a>();
00113                 rdel = <a class="code" href="kom_8c.html#a17">k_val</a>();
00114                 <span class="keywordflow">for</span>(r=rdel; r&lt;rmax; r+=rdel) {
00115                         np = <a class="code" href="tlay_8c.html#a22">t_region</a>(r, z, treg);
00116                         fprintf(stdout, <span class="stringliteral">"%6.1f : "</span>, r);
00117                         <span class="keywordflow">for</span>(i=0; i&lt;np; i++)
00118                                 fprintf(stdout, <span class="stringliteral">"%6.2f "</span>, treg[i].t);
00119                         fprintf(stdout, <span class="stringliteral">"\n"</span>);
00120                 }
00121                 <span class="keywordflow">return</span> 1;
00122         }
00123 
00124         <span class="keywordflow">return</span> 0;
00125 }
00126 
00127 <span class="comment">/**************************************************************************</span>
00128 <span class="comment"> * t_model()  Add layer to velocity model.                                *</span>
00129 <span class="comment"> **************************************************************************/</span>
<a name="l00130"></a><a class="code" href="tlay_8c.html#a14">00130</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a14">t_model</a>(<span class="keywordtype">double</span> z, <span class="keywordtype">double</span> v)
00131 {
00132         <span class="keywordtype">int</span> i;
00133 
00134         <span class="keywordflow">if</span>(<a class="code" href="tlay_8c.html#a2">nLay</a> &lt; <a class="code" href="tlay_8c.html#a1">MAXLAY</a>) {
00135                 <a class="code" href="tlay_8c.html#a7">zTop</a>[<a class="code" href="tlay_8c.html#a2">nLay</a>] = z;
00136                 <a class="code" href="tlay_8c.html#a8">vLay</a>[<a class="code" href="tlay_8c.html#a2">nLay</a>] = v;
00137                 <a class="code" href="tlay_8c.html#a2">nLay</a>++;
00138         }
00139 
00140         <span class="keywordflow">for</span>(i=1; i&lt;<a class="code" href="tlay_8c.html#a2">nLay</a>; i++) {
00141                 <a class="code" href="tlay_8c.html#a7">zTop</a>[2*<a class="code" href="tlay_8c.html#a2">nLay</a>-1-i] = 2*<a class="code" href="tlay_8c.html#a7">zTop</a>[<a class="code" href="tlay_8c.html#a2">nLay</a>-1] - <a class="code" href="tlay_8c.html#a7">zTop</a>[i];
00142                 <a class="code" href="tlay_8c.html#a8">vLay</a>[2*<a class="code" href="tlay_8c.html#a2">nLay</a>-1-i] = <a class="code" href="tlay_8c.html#a8">vLay</a>[i-1];
00143         }
00144         <a class="code" href="tlay_8c.html#a7">zTop</a>[<a class="code" href="tlay_8c.html#a2">nLay</a>] = <a class="code" href="tlay_8c.html#a7">zTop</a>[<a class="code" href="tlay_8c.html#a2">nLay</a>-1] + 0.01;
00145 
00146 <span class="comment">/*      printf("nLay = %d\n", nLay);</span>
00147 <span class="comment">        for(i=0; i&lt;2*nLay-1; i++)</span>
00148 <span class="comment">                printf("%d : %6.1f %6.1f\n", i, zTop[i], vLay[i]); */</span> <span class="comment">/*DEBUG*/</span>
00149         <span class="keywordflow">return</span> <a class="code" href="tlay_8c.html#a2">nLay</a>;
00150 }
00151 
00152 <span class="comment">/**************************************************************************</span>
00153 <span class="comment"> *   t_set()  Set up travel time calculations                             *</span>
00154 <span class="comment"> **************************************************************************/</span>
<a name="l00155"></a><a class="code" href="tlay_8c.html#a15">00155</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a15">t_set</a>( <span class="keywordtype">void</span> )
00156 {
00157         <span class="keywordflow">if</span>(initMod)
00158                 <span class="keywordflow">return</span> <a class="code" href="tlay_8c.html#a2">nLay</a>;
00159         <a class="code" href="tlay_8c.html#a9">initMod</a> = 1;
00160         <span class="keywordflow">return</span> <a class="code" href="tlay_8c.html#a2">nLay</a>;
00161 }
00162 
00163 <span class="comment">/**************************************************************************</span>
00164 <span class="comment"> *   t_fun()  Calculate direct travel time from takeoff angle             *</span>
00165 <span class="comment"> **************************************************************************/</span>
<a name="l00166"></a><a class="code" href="tlay_8c.html#a16">00166</a> <span class="keywordtype">float</span> <a class="code" href="tlay_8c.html#a16">t_fun</a>(<span class="keywordtype">float</span> r)
00167 {
00168         <span class="keywordtype">int</span> i;
00169         <span class="keywordtype">double</span> q;
00170         <span class="keywordtype">double</span> p;
00171         <span class="keywordtype">float</span> t;
00172         <span class="keywordtype">float</span> td;
00173 
00174         p = atan(r/zSrc);
00175         t = 0.0;
00176         <span class="keywordflow">for</span>(i=0; i&lt;=<a class="code" href="tlay_8c.html#a4">iSrc</a>; i++) {
00177                 <span class="keywordflow">if</span>(i == <a class="code" href="tlay_8c.html#a4">iSrc</a>) {
00178                         td = (float) (fabs(zSrc - zTop[i]) / cos(p) / <a class="code" href="tlay_8c.html#a8">vLay</a>[i]);
00179                 } <span class="keywordflow">else</span> {
00180                         q = asin(vLay[i]*sin(p)/vLay[iSrc]);
00181                         td = (float)((<a class="code" href="tlay_8c.html#a7">zTop</a>[i+1] - <a class="code" href="tlay_8c.html#a7">zTop</a>[i]) / cos(q) / <a class="code" href="tlay_8c.html#a8">vLay</a>[i]);
00182                 }
00183                 t += td;
00184         }
00185         <span class="keywordflow">return</span> t;
00186 }
00187 
00188 <span class="comment">/**************************************************************************</span>
00189 <span class="comment"> *   t_dis()  Calculate direct ray distance from takeoff angle            *</span>
00190 <span class="comment"> **************************************************************************/</span>
<a name="l00191"></a><a class="code" href="tlay_8c.html#a17">00191</a> <span class="keywordtype">float</span> <a class="code" href="tlay_8c.html#a17">t_dis</a>( <span class="keywordtype">float</span> r )
00192 {
00193         <span class="keywordtype">int</span> i;
00194         <span class="keywordtype">double</span> q;
00195         <span class="keywordtype">double</span> p;
00196         <span class="keywordtype">float</span> x;
00197         <span class="keywordtype">float</span> xd;
00198 
00199         p = atan(r/zSrc);
00200         x = (float)0.0;
00201         <span class="keywordflow">for</span>(i=0; i&lt;=<a class="code" href="tlay_8c.html#a4">iSrc</a>; i++) {
00202                 <span class="keywordflow">if</span>(i == <a class="code" href="tlay_8c.html#a4">iSrc</a>) {
00203                         xd = (float) ((<a class="code" href="tlay_8c.html#a5">zSrc</a> - <a class="code" href="tlay_8c.html#a7">zTop</a>[i]) * tan(p));
00204                 } <span class="keywordflow">else</span> {
00205                         q = asin(vLay[i]*sin(p)/vLay[iSrc]);
00206                         xd = (float)((<a class="code" href="tlay_8c.html#a7">zTop</a>[i+1] - <a class="code" href="tlay_8c.html#a7">zTop</a>[i]) * tan(q));
00207                 }
00208                 x += xd;
00209         }
00210         <span class="keywordflow">return</span> (float) ((x-<a class="code" href="tlay_8c.html#a6">xSrc</a>)*(x-<a class="code" href="tlay_8c.html#a6">xSrc</a>));
00211 }
00212 
00213 <span class="comment">/**************************************************************************</span>
00214 <span class="comment"> *  t_lay()  Calculate travel times                                       *</span>
00215 <span class="comment"> **************************************************************************/</span>
<a name="l00216"></a><a class="code" href="tlay_8c.html#a18">00216</a> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a18">t_lay</a>( <span class="keywordtype">double</span>  r,        <span class="comment">/* Epicentral distance          */</span>
00217               <span class="keywordtype">double</span>  z,        <span class="comment">/* Hypocentral depth            */</span>
00218               <span class="keywordtype">double</span> *dtdr,     <span class="comment">/* dTdR                         */</span>
00219               <span class="keywordtype">double</span> *dtdz )    <span class="comment">/* dTdZ                         */</span>
00220 {
00221         <span class="keywordtype">double</span> tmin;            <span class="comment">/* Minimum trav time            */</span>
00222         <span class="keywordtype">double</span> t;               <span class="comment">/* Travel time                  */</span>
00223         <span class="keywordtype">double</span> x;               <span class="comment">/* Critical dist                */</span>
00224         <span class="keywordtype">double</span> p;               <span class="comment">/* Takeoff angle                */</span>
00225         <span class="keywordtype">double</span> q;               <span class="comment">/* Layer incidence              */</span>
00226         <span class="keywordtype">double</span> td;              <span class="comment">/* Travel time inc              */</span>
00227         <span class="keywordtype">double</span> xd;              <span class="comment">/* Crit. dist inc               */</span>
00228         <span class="keywordtype">double</span> tdir;
00229         <span class="keywordtype">double</span> toa;
00230         <span class="keywordtype">double</span> sgn;
00231         <span class="keywordtype">float</span> ax, bx, cx;
00232         <span class="keywordtype">float</span> fa, fb, fc;
00233         <span class="keywordtype">float</span> xmin;
00234         <span class="keywordtype">int</span> isrc;
00235         <span class="keywordtype">int</span> i, j;
00236 
00237         <a class="code" href="tlay_8c.html#a15">t_set</a>();
00238         tmin = 10000.0;
00239         sgn = 1.0;
00240         <span class="keywordflow">if</span>(z &lt; 0.0) {
00241                 z = -z;
00242                 sgn = -sgn;
00243         }
00244 <span class="comment">/* Calculate source layer                       */</span>
00245         isrc = 0;
00246         <span class="keywordflow">for</span>(i=1; i&lt;<a class="code" href="tlay_8c.html#a2">nLay</a>; i++) {
00247                 <span class="keywordflow">if</span>(z &gt; <a class="code" href="tlay_8c.html#a7">zTop</a>[i])
00248                         isrc = i;
00249         }
00250         <a class="code" href="tlay_8c.html#a4">iSrc</a> = isrc;
00251         <a class="code" href="tlay_8c.html#a5">zSrc</a> = z;
00252         <span class="keywordflow">if</span> ( <a class="code" href="tlay_8c.html#a5">zSrc</a> &lt; .01 ) <a class="code" href="tlay_8c.html#a5">zSrc</a> = .01;              <span class="comment">/* Added by WMK 2/12/96 */</span>
00253         <a class="code" href="tlay_8c.html#a6">xSrc</a> = r;
00254 
00255 <span class="comment">/* Calculate minimum refraction         */</span>
00256         <a class="code" href="tlay_8c.html#a3">iRef</a> = 0;
00257         <span class="keywordflow">for</span>(i=isrc+1; i&lt;<a class="code" href="tlay_8c.html#a2">nLay</a>; i++) {
00258                 t = 0.0;
00259                 x = 0.0;
00260                 p = 1.0/<a class="code" href="tlay_8c.html#a8">vLay</a>[i];
00261                 <span class="keywordflow">for</span>(j=0; j&lt;i; j++) {
00262                         q = asin(p * vLay[j]);
00263                         td = (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1]-<a class="code" href="tlay_8c.html#a7">zTop</a>[j]) / cos(q) / <a class="code" href="tlay_8c.html#a8">vLay</a>[j];
00264                         xd = (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1]-<a class="code" href="tlay_8c.html#a7">zTop</a>[j]) * tan(q);
00265                         t += td;                <span class="comment">/* Upgoing ray          */</span>
00266                         x += xd;
00267                         <span class="keywordflow">if</span>(j == isrc) { <span class="comment">/* Source in layer      */</span>
00268                                 t += td * (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1] - z)
00269                                         / (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1] - <a class="code" href="tlay_8c.html#a7">zTop</a>[j]);
00270                                 x += xd * (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1] - z)
00271                                         / (<a class="code" href="tlay_8c.html#a7">zTop</a>[j+1] - <a class="code" href="tlay_8c.html#a7">zTop</a>[j]);
00272                         }
00273                         <span class="keywordflow">if</span>(j &gt; isrc) {  <span class="comment">/* Downgoing ray        */</span>
00274                                 t += td;
00275                                 x += xd;
00276                         }
00277                 }
00278                 <span class="keywordflow">if</span>(x &lt; r) {
00279                         t += (r-x) / <a class="code" href="tlay_8c.html#a8">vLay</a>[i];
00280                         <span class="keywordflow">if</span>(t &lt; tmin) {
00281                                 <a class="code" href="tlay_8c.html#a3">iRef</a> = i;
00282                                 tmin = t;
00283                                 toa = 3.1415927 - asin(p * vLay[isrc]);
00284                         }
00285                 }
00286         }
00287 
00288 <span class="comment">/* Travel time of direct ray */</span>
00289         ax = (float)(0.8 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00290         bx = (float)(1.5 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00291         <a class="code" href="mnbrak_8c.html#a6">mnbrak</a>(&amp;ax, &amp;bx, &amp;cx, &amp;fa, &amp;fb, &amp;fc, t_dis);
00292         <a class="code" href="brent_8c.html#a5">brent</a>(ax, bx, cx, t_dis, (<span class="keywordtype">float</span>)0.001, &amp;xmin);
00293         tdir = <a class="code" href="tlay_8c.html#a16">t_fun</a>(xmin);
00294         <span class="keywordflow">if</span>(tdir &lt; tmin) {
00295                 <a class="code" href="tlay_8c.html#a3">iRef</a> = 0;
00296                 tmin = tdir;
00297                 toa = atan(xmin/zSrc);     <span class="comment">/* changed from z to zSrc by WMK */</span>
00298                 <span class="keywordflow">if</span>(toa &lt; 0.0)
00299                         toa += 3.141592654;
00300         }
00301 
00302         *dtdz = sgn * cos(toa)/<a class="code" href="tlay_8c.html#a8">vLay</a>[isrc];
00303         *dtdr = sin(toa)/<a class="code" href="tlay_8c.html#a8">vLay</a>[isrc];
00304         <span class="keywordflow">return</span> tmin;
00305 }
00306 
00307 <span class="comment">/**************************************************************************</span>
00308 <span class="comment"> *  t_direct()  Calculate travel time of direct P                         *</span>
00309 <span class="comment"> **************************************************************************/</span>
<a name="l00310"></a><a class="code" href="tlay_8c.html#a19">00310</a> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a19">t_direct</a>( <span class="keywordtype">double</span>  r,
00311                  <span class="keywordtype">double</span>  z,
00312                  <span class="keywordtype">double</span> *dtdr,
00313                  <span class="keywordtype">double</span> *dtdz )
00314 {
00315         <span class="keywordtype">double</span> toa;
00316         <span class="keywordtype">double</span> tp;
00317         <span class="keywordtype">float</span> ax, bx, cx;
00318         <span class="keywordtype">float</span> fa, fb, fc;
00319         <span class="keywordtype">float</span> xmin;
00320         <span class="keywordtype">int</span> i;
00321 
00322 <span class="comment">/* source layer */</span>
00323         <a class="code" href="tlay_8c.html#a4">iSrc</a> = 0;
00324         <span class="keywordflow">for</span>(i=1; i&lt;<a class="code" href="tlay_8c.html#a2">nLay</a>; i++)
00325                 <span class="keywordflow">if</span>(z &gt; <a class="code" href="tlay_8c.html#a7">zTop</a>[i])
00326                         <a class="code" href="tlay_8c.html#a4">iSrc</a> = i;
00327         <a class="code" href="tlay_8c.html#a5">zSrc</a> = z;
00328         <a class="code" href="tlay_8c.html#a6">xSrc</a> = r;
00329 
00330 <span class="comment">/* Calculate travel time, need to take care of Z &gt; 0 by direct calcuation */</span>
00331         ax = (float)(0.8 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00332         bx = (float)(1.5 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00333         <a class="code" href="mnbrak_8c.html#a6">mnbrak</a>(&amp;ax, &amp;bx, &amp;cx, &amp;fa, &amp;fb, &amp;fc, t_dis);
00334         <a class="code" href="brent_8c.html#a5">brent</a>(ax, bx, cx, t_dis, (<span class="keywordtype">float</span>) 0.001, &amp;xmin);
00335         toa = atan(xmin/z);
00336         <span class="keywordflow">if</span>(toa &lt; 0.0)
00337                 toa += 3.141592654;
00338         tp = <a class="code" href="tlay_8c.html#a16">t_fun</a>(xmin);
00339         *dtdz = cos(toa) / <a class="code" href="tlay_8c.html#a8">vLay</a>[<a class="code" href="tlay_8c.html#a4">iSrc</a>];
00340         *dtdr = sin(toa) / <a class="code" href="tlay_8c.html#a8">vLay</a>[<a class="code" href="tlay_8c.html#a4">iSrc</a>];
00341         <span class="keywordflow">return</span> tp;
00342 }
00343 
00344 <span class="comment">/**************************************************************************</span>
00345 <span class="comment"> *  t_pmp()  Calculate travel time of mantle reflection                   *</span>
00346 <span class="comment"> **************************************************************************/</span>
<a name="l00347"></a><a class="code" href="tlay_8c.html#a20">00347</a> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a20">t_pmp</a>( <span class="keywordtype">double</span>  r,
00348               <span class="keywordtype">double</span>  z,
00349               <span class="keywordtype">double</span> *dtdr,
00350               <span class="keywordtype">double</span> *dtdz )
00351 {
00352         <span class="keywordtype">double</span> toa;
00353         <span class="keywordtype">double</span> tpmp;
00354         <span class="keywordtype">float</span> ax, bx, cx;
00355         <span class="keywordtype">float</span> fa, fb, fc;
00356         <span class="keywordtype">float</span> xmin;
00357         <span class="keywordtype">int</span> nlay;
00358         <span class="keywordtype">int</span> i;
00359 
00360 <span class="comment">/* source layer */</span>
00361         nlay = <a class="code" href="tlay_8c.html#a2">nLay</a>;
00362         <a class="code" href="tlay_8c.html#a2">nLay</a> = 2*nlay - 1;
00363         <a class="code" href="tlay_8c.html#a4">iSrc</a> = 0;
00364         <span class="keywordflow">for</span>(i=1; i&lt;<a class="code" href="tlay_8c.html#a2">nLay</a>; i++)
00365                 <span class="keywordflow">if</span>(z &gt; <a class="code" href="tlay_8c.html#a7">zTop</a>[i])
00366                         <a class="code" href="tlay_8c.html#a4">iSrc</a> = i;
00367         <a class="code" href="tlay_8c.html#a5">zSrc</a> = z;
00368         <a class="code" href="tlay_8c.html#a6">xSrc</a> = r;
00369 
00370 <span class="comment">/* Calcuate travel time of direct ray from image source         */</span>
00371         ax = (float)(0.8 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00372         bx = (float)(1.5 * <a class="code" href="tlay_8c.html#a6">xSrc</a>);
00373         <a class="code" href="mnbrak_8c.html#a6">mnbrak</a>(&amp;ax, &amp;bx, &amp;cx, &amp;fa, &amp;fb, &amp;fc, t_dis);
00374         <a class="code" href="brent_8c.html#a5">brent</a>(ax, bx, cx, t_dis, (<span class="keywordtype">float</span>)0.001, &amp;xmin);
00375         toa = atan(xmin/z);
00376         <span class="keywordflow">if</span>(toa &lt; 0.0)
00377                 toa += 3.141592654;
00378         tpmp = <a class="code" href="tlay_8c.html#a16">t_fun</a>(xmin);
00379         *dtdz = -cos(toa) / <a class="code" href="tlay_8c.html#a8">vLay</a>[<a class="code" href="tlay_8c.html#a4">iSrc</a>];
00380         *dtdr = sin(toa) / <a class="code" href="tlay_8c.html#a8">vLay</a>[<a class="code" href="tlay_8c.html#a4">iSrc</a>];
00381         <a class="code" href="tlay_8c.html#a2">nLay</a> = nlay;
00382         <span class="keywordflow">return</span> tpmp;
00383 }
00384 
00385 <span class="comment">/**************************************************************************</span>
00386 <span class="comment"> *  t_phase()  Calculate travel time for a given phase                    *</span>
00387 <span class="comment"> **************************************************************************/</span>
<a name="l00388"></a><a class="code" href="tlay_8c.html#a21">00388</a> <span class="keywordtype">double</span> <a class="code" href="tlay_8c.html#a21">t_phase</a>( <span class="keywordtype">int</span>     ph,             <span class="comment">/* Phase index (0-5)    */</span>
00389                 <span class="keywordtype">double</span>  r,              <span class="comment">/* Epicentral distance  */</span>
00390                 <span class="keywordtype">double</span>  z,              <span class="comment">/* Hypocentral depth    */</span>
00391                 <span class="keywordtype">double</span> *dtdr,           <span class="comment">/* dTdR                 */</span>
00392                 <span class="keywordtype">double</span> *dtdz )          <span class="comment">/* dTdZ                 */</span>
00393 {
00394         <span class="keywordtype">double</span> t;
00395 
00396         <a class="code" href="tlay_8c.html#a15">t_set</a>();
00397         <span class="keywordflow">switch</span>(ph) {
00398         <span class="keywordflow">case</span> 0: <span class="comment">/* P    */</span>
00399         <span class="keywordflow">case</span> 2: <span class="comment">/* Pn   */</span>
00400                 t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, dtdr, dtdz);
00401                 <span class="keywordflow">break</span>;
00402         <span class="keywordflow">case</span> 1: <span class="comment">/* S    */</span>
00403         <span class="keywordflow">case</span> 3: <span class="comment">/* Sn   */</span>
00404                 t = <a class="code" href="tlay_8c.html#a10">PoverS</a> * <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, dtdr, dtdz);
00405                 *dtdr *= <a class="code" href="tlay_8c.html#a10">PoverS</a>;
00406                 *dtdz *= <a class="code" href="tlay_8c.html#a10">PoverS</a>;
00407                 <span class="keywordflow">break</span>;
00408         <span class="keywordflow">case</span> 4: <span class="comment">/* Pg   */</span>
00409                 <a class="code" href="tlay_8c.html#a2">nLay</a>--;
00410                 t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, dtdr, dtdz);
00411                 <a class="code" href="tlay_8c.html#a2">nLay</a>++;
00412                 <span class="keywordflow">break</span>;
00413         <span class="keywordflow">case</span> 5: <span class="comment">/* Sg   */</span>
00414                 <a class="code" href="tlay_8c.html#a2">nLay</a>--;
00415                 t = <a class="code" href="tlay_8c.html#a10">PoverS</a> * <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, dtdr, dtdz);
00416                 <a class="code" href="tlay_8c.html#a2">nLay</a>++;
00417                 *dtdr *= <a class="code" href="tlay_8c.html#a10">PoverS</a>;
00418                 *dtdz *= <a class="code" href="tlay_8c.html#a10">PoverS</a>;
00419                 <span class="keywordflow">break</span>;
00420         <span class="keywordflow">case</span> 6: <span class="comment">/* P*, Direct P */</span>
00421                 t = <a class="code" href="tlay_8c.html#a19">t_direct</a>(r, z, dtdr, dtdz);
00422                 <span class="keywordflow">break</span>;
00423         <span class="keywordflow">case</span> 7: <span class="comment">/* PmP */</span>
00424                 t = <a class="code" href="tlay_8c.html#a20">t_pmp</a>(r, z, dtdr, dtdz);
00425                 <span class="keywordflow">break</span>;
00426         }
00427         <span class="keywordflow">return</span> t;
00428 }
00429 
00430 <span class="comment">/**************************************************************************</span>
00431 <span class="comment"> *  t_region()  Calculate regional phase travel times: P, Pg, S, and Sg   *</span>
00432 <span class="comment"> **************************************************************************/</span>
<a name="l00433"></a><a class="code" href="tlay_8c.html#a22">00433</a> <span class="keywordtype">int</span> <a class="code" href="tlay_8c.html#a22">t_region</a>( <span class="keywordtype">double</span>  r,        <span class="comment">/* Epicentral distance                  */</span>
00434               <span class="keywordtype">double</span>  z,        <span class="comment">/* Hypocentral depth                    */</span>
00435               <a class="code" href="structTPHASE.html">TPHASE</a> *treg)     <span class="comment">/* Travtime and derive for each phase   */</span>
00436 {
00437         <span class="keywordtype">double</span> t;
00438         <span class="keywordtype">double</span> dtdr;
00439         <span class="keywordtype">double</span> dtdz;
00440 
00441         t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, &amp;dtdr, &amp;dtdz);
00442         treg[0].<a class="code" href="structTPHASE.html#m0">phase</a> = 0;
00443         treg[0].<a class="code" href="structTPHASE.html#m1">t</a> = t;
00444         treg[0].<a class="code" href="structTPHASE.html#m2">dtdr</a> = dtdr;
00445         treg[0].<a class="code" href="structTPHASE.html#m3">dtdz</a> = dtdz;
00446         treg[1].<a class="code" href="structTPHASE.html#m0">phase</a> = 1;
00447         treg[1].<a class="code" href="structTPHASE.html#m1">t</a> = <a class="code" href="tlay_8c.html#a10">PoverS</a> * t;
00448         treg[1].<a class="code" href="structTPHASE.html#m2">dtdr</a> = <a class="code" href="tlay_8c.html#a10">PoverS</a> * dtdr;
00449         treg[1].<a class="code" href="structTPHASE.html#m3">dtdz</a> = <a class="code" href="tlay_8c.html#a10">PoverS</a> * dtdz;
00450         <span class="keywordflow">if</span>(<a class="code" href="tlay_8c.html#a2">nLay</a> &lt; 2)
00451                 <span class="keywordflow">return</span> 2;
00452         <a class="code" href="tlay_8c.html#a2">nLay</a>--;
00453         t = <a class="code" href="tlay_8c.html#a18">t_lay</a>(r, z, &amp;dtdr, &amp;dtdz);
00454         <a class="code" href="tlay_8c.html#a2">nLay</a>++;
00455         <span class="keywordflow">if</span>(t &lt; treg[0].<a class="code" href="structTPHASE.html#m1">t</a> + 0.1)
00456                 <span class="keywordflow">return</span> 2;
00457         treg[0].phase = 2;
00458         treg[1].phase = 3;
00459         treg[2].phase = 4;
00460         treg[2].t = t;
00461         treg[2].dtdr = dtdr;
00462         treg[2].dtdz = dtdz;
00463         treg[3].phase = 5;
00464         treg[3].t = <a class="code" href="tlay_8c.html#a10">PoverS</a> * t;
00465         treg[3].dtdr = <a class="code" href="tlay_8c.html#a10">PoverS</a> * dtdr;
00466         treg[3].dtdz = <a class="code" href="tlay_8c.html#a10">PoverS</a> * dtdz;
00467         <span class="keywordflow">return</span> 4;
00468 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:11 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
