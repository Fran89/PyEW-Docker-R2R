<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mutableserverbase.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>mutableserverbase.cpp</h1><a href="mutableserverbase_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// mutableserverbase.cpp: implementation of the MutableServerBase class.</span>
00002 <span class="comment">//</span>
00004 <span class="comment"></span>
00005 
00006 <span class="preprocessor">#include "<a class="code" href="mutableserverbase_8h.html">mutableserverbase.h</a>"</span>
00007 
00008 
<a name="l00009"></a><a class="code" href="mutableserverbase_8cpp.html#a0">00009</a> <span class="preprocessor">#define THR_KEY_LISTENER -1</span>
<a name="l00010"></a><a class="code" href="mutableserverbase_8cpp.html#a1">00010</a> <span class="preprocessor"></span><span class="preprocessor">#define THR_KEY_STACKER  -2</span>
<a name="l00011"></a><a class="code" href="mutableserverbase_8cpp.html#a2">00011</a> <span class="preprocessor"></span><span class="preprocessor">#define THR_KEY_HANDLER  -3</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">// this must follow the other includes</span>
00014 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00015 <span class="preprocessor">#include &lt;<a class="code" href="transport_8h.html">transport.h</a>&gt;</span>
00016 }
00017 
00018 <span class="comment">// Implementation of mode names,</span>
00019 <span class="comment">// this array must match the enum MUTABLE_MODE_TYPE</span>
00020 <span class="comment">// towards the top of mutableserverbase.h</span>
00021 <span class="comment">//</span>
<a name="l00022"></a><a class="code" href="classMutableServerBase.html#q0">00022</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="classMutableServerBase.html#q0">MutableServerBase::MSB_MODE_NAME</a>[] =
00023 {
00024   <span class="stringliteral">""</span>
00025 , <span class="stringliteral">"Standalone"</span>
00026 , <span class="stringliteral">"Module"</span>
00027 , <span class="stringliteral">"Server"</span>
00028 , <span class="stringliteral">"Client"</span>
00029 };
00030 
00031 
00033 <span class="comment">// Construction/Destruction</span>
00035 <span class="comment"></span>
<a name="l00036"></a><a class="code" href="classMutableServerBase.html#a2">00036</a> <a class="code" href="classMutableServerBase.html#a2">MutableServerBase::MutableServerBase</a>()
00037 {
00038    <a class="code" href="classMutableServerBase.html#o0">MaxMessageLength</a> = 0;
00039    <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a> = NULL;
00040 
00041    <a class="code" href="classMutableServerBase.html#n24">LoggingOptions</a> = <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a>;
00042 
00043    <a class="code" href="classMutableServerBase.html#n0">Mode</a> = <a class="code" href="mutableserverbase_8h.html#a14a9">MMT_NONE</a>;
00044 
00045    <a class="code" href="classMutableServerBase.html#n3">ConnectFailureSec</a> = -1;
00046 
00047    <a class="code" href="classMutableServerBase.html#n17">MessageMutex</a> = NULL;
00048   
00049    <a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a> = 0;
00050 
00051    <a class="code" href="classMutableServerBase.html#n1">MaxClients</a> = 1;
00052 
00053    <a class="code" href="classMutableServerBase.html#n4">MaxServerTryLoopCount</a> = 2;
00054 
00055    <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> = NULL;
00056    <a class="code" href="classMutableServerBase.html#n16">TransmitBufferLength</a> = 0;
00057 
00058    <a class="code" href="classMutableServerBase.html#n5">InputRingName</a> = <span class="stringliteral">""</span>;
00059    <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00060    <a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00061    <a class="code" href="classMutableServerBase.html#n9">InputRegion</a> = &amp;<a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>;
00062    
00063    <a class="code" href="classMutableServerBase.html#n6">OutputRingName</a> = <span class="stringliteral">""</span>;
00064    <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00065    <a class="code" href="classMutableServerBase.html#n12">OutputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00066    <a class="code" href="classMutableServerBase.html#n10">OutputRegion</a> = &amp;<a class="code" href="classMutableServerBase.html#n12">OutputRegionStruct</a>;
00067       
00068 }
00069 <span class="comment">//</span>
00070 <span class="comment">//-------------------------------------------------------------------</span>
00071 <span class="comment">//</span>
<a name="l00072"></a><a class="code" href="classMutableServerBase.html#a3">00072</a> <a class="code" href="classMutableServerBase.html#a3">MutableServerBase::~MutableServerBase</a>()
00073 {
00074    <span class="keywordflow">if</span> (   <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>
00075        &amp;&amp; <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> != <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a>
00076        &amp;&amp; <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> != <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a>
00077       )
00078    {
00079       <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n12">OutputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00080       {
00081          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00082                        , <span class="stringliteral">"~MutableServerBase(): detaching from output ring\n"</span>
00083                        );
00084          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;OutputRegionStruct );
00085          <a class="code" href="classMutableServerBase.html#n12">OutputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00086       }
00087 
00088       <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00089    }
00090 
00091    <span class="keywordflow">if</span> (   <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>
00092        &amp;&amp; <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> != <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a>
00093       )
00094    {
00095       <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00096       {
00097          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00098                        , <span class="stringliteral">"~MutableServerBase(): detaching from input ring\n"</span>
00099                        );
00100          <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;InputRegionStruct );
00101          <a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00102       }
00103 
00104       <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> = <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a>;
00105    }
00106 
00107    <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> != NULL )
00108    {
00109       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00110                     , <span class="stringliteral">"~MutableServerBase(): detaching from command ring\n"</span>
00111                     );
00112       <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;CommandRegion );
00113       <a class="code" href="classWormServerBase.html#n11">CommandRegion</a>.<a class="code" href="structSHM__INFO.html#m0">addr</a> = NULL;
00114    }
00115 
00116    <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n17">MessageMutex</a> != NULL )
00117    {
00118       <span class="keyword">delete</span>( MessageMutex );
00119    }
00120 
00121    <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a> != NULL )
00122    {
00123       <span class="keyword">delete</span> [] <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a>;
00124    }
00125 
00126    <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> != NULL )
00127    {
00128       <span class="keyword">delete</span> [] <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a>;
00129    }
00130 
00131 }
00132 <span class="comment">//</span>
00133 <span class="comment">//-------------------------------------------------------------------</span>
00134 <span class="comment">//</span>
<a name="l00135"></a><a class="code" href="classMutableServerBase.html#a0">00135</a> <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> <a class="code" href="classMutableServerBase.html#a0">MutableServerBase::HandleConfigLine</a>( <a class="code" href="classConfigSource.html">ConfigSource</a> * p_parser )
00136 {
00137    <span class="comment">// Do not manipulate ConfigState herein.</span>
00138    <span class="comment">//</span>
00139    <a class="code" href="configurable_8h.html#a3">HANDLE_STATUS</a> r_handled = <a class="code" href="configurable_8h.html#a3a2">HANDLER_USED</a>;
00140 
00141    <span class="keywordflow">try</span>
00142    {
00143       <span class="keywordtype">char</span> * _token;
00144 
00145       <span class="keywordtype">int</span> _ival;
00146 
00147       <span class="keywordflow">do</span>
00148       {
00149          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"ImA"</span>) )
00150          {
00151             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00152             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00153             {
00154                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;ImA&gt; line"</span>);
00155             }
00156 
00157             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"StandAlone"</span>) )
00158             {
00159                <a class="code" href="classMutableServerBase.html#n0">Mode</a> = <a class="code" href="mutableserverbase_8h.html#a14a10">MMT_STANDALONE</a>;
00160                <span class="keywordflow">continue</span>;
00161             }
00162 
00163             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Module"</span>) )
00164             {
00165                <a class="code" href="classMutableServerBase.html#n0">Mode</a> = <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>;
00166                <span class="keywordflow">continue</span>;
00167             }
00168 
00169             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Server"</span>) )
00170             {
00171                <a class="code" href="classMutableServerBase.html#n0">Mode</a> = <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>;
00172                <span class="keywordflow">continue</span>;
00173             }
00174 
00175             <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Client"</span>) )
00176             {
00177                <a class="code" href="classMutableServerBase.html#n0">Mode</a> = <a class="code" href="mutableserverbase_8h.html#a14a13">MMT_CLIENT</a>;
00178                <span class="keywordflow">continue</span>;
00179             }
00180          }
00181 
00182 
00183          <span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span>
00184          <span class="comment">// Client</span>
00185          <span class="comment">//</span>
00186          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"Provider"</span>) )
00187          {
00188             <a class="code" href="struct__PROVIDER__ADDR.html">PROVIDER_ADDR</a> _provider;
00189 
00190             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00191             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00192             {
00193                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;Provider&gt; line"</span>);
00194             }
00195             _provider.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a> = _token;
00196 
00197             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00198             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00199             {
00200                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete &lt;Provider&gt; line"</span>);
00201             }
00202             _provider.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a> = _token;
00203 
00204             <a class="code" href="classMutableServerBase.html#n2">Providers</a>.push_back( _provider );
00205 
00206             <span class="keywordflow">continue</span>;
00207          }
00208 
00209          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"ConnectFailDelay"</span>) )
00210          {
00211             <span class="keywordflow">if</span> ( (_ival = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>()) == p_parser-&gt;<a class="code" href="classConfigSource.html#p0">INVALID_INT</a> )
00212             {
00213                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Invalid or incomplete &lt;ConnectFailDelay&gt; line"</span>);
00214             }
00215             <a class="code" href="classMutableServerBase.html#n3">ConnectFailureSec</a> = _ival;
00216 
00217             <span class="keywordflow">continue</span>;
00218          }
00219 
00220 
00221          <span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span>
00222          <span class="comment">// Server</span>
00223          <span class="comment">//</span>
00224          <span class="comment">// see WormServerBase::HandleConfigLine()</span>
00225 
00226 
00227          <span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span>
00228          <span class="comment">// Module</span>
00229          <span class="comment">//</span>
00230          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"InputRing"</span>) )
00231          {
00232             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00233             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00234             {
00235                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing &lt;InputRing&gt; value"</span>);
00236             }
00237             <a class="code" href="classMutableServerBase.html#n5">InputRingName</a> = _token;
00238 
00239             <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(<a class="code" href="classMutableServerBase.html#n5">InputRingName</a>.c_str())) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00240             {
00241                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;InputRing&gt; value"</span>);
00242             }
00243 
00244             <span class="keywordflow">continue</span>;
00245          }
00246 
00247          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"OutputRing"</span>) )
00248          {
00249             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00250             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00251             {
00252                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;OutputRing&gt; value"</span>);
00253             }
00254             <a class="code" href="classMutableServerBase.html#n6">OutputRingName</a> = _token;
00255 
00256             <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> = <a class="code" href="classTGlobalUtils.html#d16">TGlobalUtils::LookupRingKey</a>(<a class="code" href="classMutableServerBase.html#n6">OutputRingName</a>.c_str())) == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00257             {
00258                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"invalid &lt;OutputRing&gt; value"</span>);
00259             }
00260 
00261             <span class="keywordflow">continue</span>;
00262          }
00263 
00264          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"AcceptLogo"</span>) )
00265          {
00266             <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a> == <a class="code" href="mfc__dlog__modl__base_8h.html#a6">SERVE_MAX_LOGOS</a> )
00267             {
00268                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"too many &lt;AcceptLogo&gt; lines"</span>);
00269             }
00270 
00271             <span class="comment">// Institution</span>
00272 
00273             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00274             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00275             {
00276                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;AcceptLogo&gt; institution value"</span>);
00277             }
00278 
00279             <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[<a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a>].instid = (WORM_INSTALLATION_ID)<a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(_token);
00280 
00281             <span class="comment">// Module</span>
00282 
00283             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00284             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00285             {
00286                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;AcceptLogo&gt; module value"</span>);
00287             }
00288 
00289             <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[<a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a>].mod = (WORM_MODULE_ID)<a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(_token);
00290 
00291             <span class="comment">// Type</span>
00292 
00293             _token = p_parser-&gt;<a class="code" href="classConfigSource.html#a12">String</a>();
00294             <span class="keywordflow">if</span> ( strlen(_token) == 0 )
00295             {
00296                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"missing &lt;AcceptLogo&gt; type value"</span>);
00297             }
00298 
00299             <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[<a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a>].type = (WORM_MSGTYPE_ID)<a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(_token);
00300 
00301             <a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a>++;
00302 
00303             <span class="keywordflow">continue</span>;
00304          }
00305 
00306 
00307          <span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span>
00308          <span class="comment">// Module or Server</span>
00309          <span class="comment">//</span>
00310 
00311          <span class="keywordflow">if</span> ( p_parser-&gt;<a class="code" href="classConfigSource.html#a22">Its</a>(<span class="stringliteral">"MaxMessageLength"</span>) )
00312          {
00313             <span class="keywordtype">int</span> _wrkint = p_parser-&gt;<a class="code" href="classConfigSource.html#a13">Int</a>();
00314             <span class="keywordflow">if</span> ( _wrkint == <a class="code" href="classConfigSource.html#p0">ConfigSource::INVALID_INT</a> )
00315             {
00316                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing or invalid &lt;MaxMessageLength&gt; value"</span>);
00317             }
00318             <a class="code" href="classMutableServerBase.html#o0">MaxMessageLength</a> = _wrkint;
00319 
00320             <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="classMutableServerBase.html#o0">MaxMessageLength</a>]) == NULL )
00321             {
00322                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed allocating MessageBuffer"</span>);
00323             }
00324          }
00325 
00326 
00327          <span class="comment">// Give the base class a whack at it</span>
00328 
00329          r_handled = <a class="code" href="classWormServerBase.html#a0">WormServerBase::HandleConfigLine</a>( p_parser );
00330 
00331 
00332       } <span class="keywordflow">while</span> ( false );
00333    }
00334    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00335    {
00336       r_handled = <a class="code" href="configurable_8h.html#a3a0">HANDLER_INVALID</a>;
00337       <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00338       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00339                    , <span class="stringliteral">"MutableServerBase::HandleConfigLine(): configuration error:\n%s\n"</span>
00340                    , _we.what()
00341                    );
00342    }
00343 
00344    <span class="keywordflow">return</span> r_handled;
00345 }
00346 <span class="comment">//</span>
00347 <span class="comment">//-------------------------------------------------------------------</span>
00348 <span class="comment">//</span>
<a name="l00349"></a><a class="code" href="classMutableServerBase.html#b0">00349</a> <span class="keywordtype">void</span> <a class="code" href="classMutableServerBase.html#b0">MutableServerBase::CheckConfig</a>()
00350 {
00351 
00352    <span class="keywordflow">switch</span> ( Mode )
00353    {
00354      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a9">MMT_NONE</a>:
00355           <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00356                         , <span class="stringliteral">"MutableServerBase::CheckConfig(): &lt;ImA&gt; line is required\n"</span>
00357                         );
00358           <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00359 
00360           <span class="keywordflow">break</span>;
00361 
00362      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a13">MMT_CLIENT</a>:
00363 
00364           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n2">Providers</a>.size() == 0 )
00365           {
00366              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00367                            , <span class="stringliteral">"MutableServerBase::CheckConfig(): client mode requires at least one &lt;Provider&gt; line\n"</span>
00368                            );
00369              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00370           }
00371 
00372           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n3">ConnectFailureSec</a> &lt; 0 )
00373           {
00374              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00375                            , <span class="stringliteral">"MutableServerBase::CheckConfig() client mode requires &lt;ConnectFailureSec&gt; line\n"</span>
00376                            );
00377              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00378           }
00379           
00380           <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n3">SendTimeoutMS</a> == -2 )
00381           {
00382              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00383                            , <span class="stringliteral">"MutableServerBase::CheckConfig() client mode requires &lt;SendTimeoutMSecs&gt; line\n"</span>
00384                            );
00385              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00386           }
00387 
00388           <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> &lt; <a class="code" href="serverbase_8h.html#a8">MIN_RECV_TIMEOUT_MS</a> )
00389           {
00390              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00391                            , <span class="stringliteral">"WormServerBase::CheckConfig(): &lt;RecvTimeoutMSecs&gt; too low in config file, using %d\n"</span>
00392                            , MIN_RECV_TIMEOUT_MS
00393                            );
00394              <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> = <a class="code" href="serverbase_8h.html#a8">MIN_RECV_TIMEOUT_MS</a>;
00395           }
00396 
00397           <span class="keywordflow">break</span>;
00398 
00399  
00400      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>:
00401 
00402           <span class="keywordflow">if</span> ( strlen(ServerIPAddr) == 0 )
00403           {
00404              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00405                            , <span class="stringliteral">"MutableServerBase::CheckConfig() server mode requires &lt;ServerIPAddr&gt; line\n"</span>
00406                            );
00407              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00408           }
00409 
00410           <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n2">ServerPort</a> == 0 )
00411           {
00412              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00413                            , <span class="stringliteral">"MutableServerBase::CheckConfig() server mode requires &lt;ServerPort&gt; line\n"</span>
00414                            );
00415              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00416           }
00417 
00418           <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00419           {
00420              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#o0">MaxMessageLength</a> == 0 )
00421              {
00422                 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00423                               , <span class="stringliteral">"MutableServerBase::CheckConfig() Error: missing or invalid &lt;MaxMessageLength&gt; line\n"</span>
00424                               );
00425                 <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00426              }
00427           }
00428 
00429           <span class="keywordflow">break</span>;
00430  
00431      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>:
00432 
00433           <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00434           {
00435              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00436                            , <span class="stringliteral">"MutableServerBase::CheckConfig() module mode requires &lt;CmdRingName&gt; line\n"</span>
00437                            );
00438              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00439           }
00440 
00441           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00442           {
00443              <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> = <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a>;
00444           }
00445 
00446           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> == <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00447           {
00448              <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> = <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a>;
00449           }
00450 
00451           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#o0">MaxMessageLength</a> == 0 )
00452           {
00453              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00454                            , <span class="stringliteral">"MutableServerBase::CheckConfig() Error: missing or invalid &lt;MaxMessageLength&gt; line\n"</span>
00455                            );
00456              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00457           }
00458 
00459           <a class="code" href="classMutableServerBase.html#n23">ResultMsgLogo</a>.<a class="code" href="structMSG__LOGO.html#m2">instid</a> = <a class="code" href="classTGlobalUtils.html#d8">TGlobalUtils::GetThisInstallationId</a>();
00460           <a class="code" href="classMutableServerBase.html#n23">ResultMsgLogo</a>.<a class="code" href="structMSG__LOGO.html#m1">mod</a>    = <a class="code" href="classTGlobalUtils.html#d7">TGlobalUtils::GetThisModuleId</a>();
00461 
00462           <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a> == 0 )
00463           {
00464              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00465                            , <span class="stringliteral">"MutableServerBase::CheckConfig() Error: no valid &lt;AcceptLogo&gt; lines found\n"</span>
00466                            );
00467              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00468           }
00469 
00470           <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n23">ResultMsgLogo</a>.<a class="code" href="structMSG__LOGO.html#m0">type</a> = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<a class="code" href="classMutableServerBase.html#b5">OutputMessageTypeKey</a>())) == <a class="code" href="worm__types_8h.html#a9">WORM_MSGTYPE_INVALID</a> )
00471           {
00472              <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00473                            , <span class="stringliteral">"MutableServerBase::CheckConfig() Error: id not found for output message type %s\n"</span>
00474                            , <a class="code" href="classMutableServerBase.html#b5">OutputMessageTypeKey</a>()
00475                            );
00476              <a class="code" href="classTConfigurable.html#n0">ConfigState</a> = <a class="code" href="statuscode_8h.html#a16a6">WORM_STAT_BADSTATE</a>;
00477           }
00478 
00479           <span class="keywordflow">break</span>;
00480  
00481    }
00482 
00483    
00484    <span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span>
00485    <span class="comment">// Standalone</span>
00486    <span class="comment">//</span>
00487 
00488 <span class="comment">//   TGlobalUtils::SetFileLoggingState( false );</span>
00489 
00490 <span class="comment">//   Mode = MMT_STANDALONE;</span>
00491 
00492 }
00493 <span class="comment">//</span>
00494 <span class="comment">//-------------------------------------------------------------------</span>
00495 <span class="comment">//</span>
<a name="l00496"></a><a class="code" href="classMutableServerBase.html#b6">00496</a> <span class="keywordtype">bool</span> <a class="code" href="classMutableServerBase.html#b6">MutableServerBase::CheckForThreadDeath</a>()
00497 {
00498    <span class="keywordflow">try</span>
00499    {
00500       <span class="keywordflow">switch</span>( Mode )
00501       {
00502         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>:
00503 
00504              <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n20">LastStackerPulse</a> + 6) &lt; time(NULL) )
00505              {
00506                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), 0, <span class="stringliteral">"stacker thread stopped"</span> );
00507                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Stacker thread stopped pulsing"</span>);
00508              }
00509 
00510              <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n22">LastHandlerPulse</a> + 6) &lt; time(NULL) )
00511              {
00512                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), 0, <span class="stringliteral">"handler thread stopped"</span> );
00513                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Handler thread stopped pulsing"</span>);
00514              }
00515           
00516              <span class="keywordflow">break</span>;
00517 
00518         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>:
00519 
00520              <span class="comment">// length of acceptable delay in listener pulse is tied to the</span>
00521              <span class="comment">// length of time it takes for a new service thread to start up,</span>
00522              <span class="comment">// (since the listener is incapacitated during that time).</span>
00523              <span class="comment">//</span>
00524              <span class="keywordflow">if</span> ( (<a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> + 10 + 3) &lt; time(NULL) )
00525              {
00526                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), 0, <span class="stringliteral">"listener thread stopped"</span> );
00527                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Listener thread stopped pulsing"</span>);
00528              }
00529           
00530              <span class="keywordflow">break</span>;
00531       }
00532    }
00533    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00534    {
00535       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00536    }
00537 
00538    <span class="keywordflow">return</span> <span class="keyword">false</span>;
00539 }
00540 <span class="comment">//</span>
00541 <span class="comment">//-------------------------------------------------------------------</span>
00542 <span class="comment">//</span>
<a name="l00543"></a><a class="code" href="classMutableServerBase.html#a1">00543</a> <span class="keywordtype">void</span> <a class="code" href="classMutableServerBase.html#a1">MutableServerBase::StartThreadFunc</a>( <span class="keywordtype">void</span> * p_arg )
00544 {
00545    <span class="keywordflow">switch</span> ( *((<span class="keywordtype">int</span> *)p_arg) )
00546    {
00547      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8cpp.html#a0">THR_KEY_LISTENER</a>:
00548           <a class="code" href="classWormServerBase.html#b0">Listener</a>(p_arg);  <span class="comment">// p_arg is ignored</span>
00549           <span class="keywordflow">break</span>;
00550 
00551      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8cpp.html#a1">THR_KEY_STACKER</a>:
00552           <a class="code" href="classMutableServerBase.html#b3">Stacker</a>();  <span class="comment">// p_arg is ignored</span>
00553           <span class="keywordflow">break</span>;
00554 
00555      <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8cpp.html#a2">THR_KEY_HANDLER</a>:
00556           <a class="code" href="classMutableServerBase.html#b4">Handler</a>();  <span class="comment">// p_arg is ignored</span>
00557           <span class="keywordflow">break</span>;
00558 
00559      <span class="keywordflow">default</span>:
00560           <a class="code" href="classMutableServerBase.html#b2">ClientServicer</a>( p_arg ); <span class="comment">// p_arg is socket descriptor</span>
00561           <span class="keywordflow">break</span>;
00562    }
00563 }
00564 <span class="comment">//</span>
00565 <span class="comment">//-------------------------------------------------------------------</span>
00566 <span class="comment">//</span>
00567 <span class="comment">// Server and Module</span>
00568 <span class="comment">//</span>
<a name="l00569"></a><a class="code" href="classMutableServerBase.html#b7">00569</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classMutableServerBase.html#b7">MutableServerBase::MainThreadActions</a>()
00570 {
00571    <span class="keyword">static</span> <span class="keywordtype">long</span> CurrentTime
00572              , LastBeatTime
00573              ;
00574 
00575       <span class="comment">// set running state to keep worker threads from dying</span>
00576       <span class="comment">//</span>
00577       <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">true</span>;
00578 
00579       <span class="comment">//</span>
00580       <span class="comment">// START WORKER THREADS</span>
00581       <span class="comment">//</span>
00582       <span class="keywordtype">int</span> _arg;
00583 
00584       <span class="keywordflow">switch</span>( Mode )
00585       {
00586         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>:
00587 
00588              <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n17">MessageMutex</a> = <span class="keyword">new</span> <a class="code" href="classTMutex.html">TMutex</a>(<span class="stringliteral">"msbmbmtx"</span>)) == NULL )
00589              {
00590                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating Message buffer mutex"</span>);
00591              }
00592 
00593              <span class="comment">// Start processing thread</span>
00594              <span class="comment">//</span>
00595              <a class="code" href="classMutableServerBase.html#n22">LastHandlerPulse</a> = time(NULL) + 5; <span class="comment">// allow an extra 5 seconds to start</span>
00596              _arg = <a class="code" href="mutableserverbase_8cpp.html#a2">THR_KEY_HANDLER</a>;
00597              <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#b0">StartThreadWithArg</a>( THREAD_STACK, &amp;HandlerThreadId, &amp;_arg ) == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
00598              {
00599                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server failed starting handler thread"</span>);
00600              }
00601              <span class="comment">// give the thread a chance to start</span>
00602              <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(300);
00603 
00604              <span class="comment">// Start stacker thread</span>
00605              <span class="comment">//</span>
00606              <a class="code" href="classMutableServerBase.html#n20">LastStackerPulse</a> = time(NULL) + 5; <span class="comment">// allow an extra 5 seconds to start</span>
00607              _arg = <a class="code" href="mutableserverbase_8cpp.html#a1">THR_KEY_STACKER</a>;
00608              <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#b0">StartThreadWithArg</a>( THREAD_STACK, &amp;StackerThreadId, &amp;_arg ) == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
00609              {
00610                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server failed starting stacker thread"</span>);
00611              }
00612              <span class="comment">// give the thread a chance to start</span>
00613              <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(250);
00614           
00615              <span class="keywordflow">break</span>;
00616 
00617         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>:
00618 
00619              <span class="keywordflow">if</span> ( SocketDebug )
00620              {
00621                 <span class="comment">// Turn Socket level debugging On/Off</span>
00622                 <a class="code" href="socket__ew__common_8c.html#a18">setSocket_ewDebug</a>(1);
00623              }
00624 
00625              <span class="comment">// Start the Listener Thread</span>
00626              <span class="comment">//</span>
00627              <a class="code" href="classWormServerBase.html#n5">LastListenerPulse</a> = time(NULL) + 5; <span class="comment">// allow an extra 5 seconds to start</span>
00628              _arg = <a class="code" href="mutableserverbase_8cpp.html#a0">THR_KEY_LISTENER</a>;
00629              <span class="keywordflow">if</span> ( <a class="code" href="classThreadableObject.html#b0">StartThreadWithArg</a>( THREAD_STACK, &amp;ListenerThreadId, &amp;_arg ) == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
00630              {
00631                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server failed starting listener thread"</span>);
00632              }
00633              <span class="comment">// give the thread a chance to start</span>
00634              <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(250);
00635 
00636              <span class="keywordflow">break</span>;
00637       }
00638 
00639 
00640       <span class="keywordtype">int</span> shutdown_flag;
00641 
00642       <span class="comment">// initialize main heartbeat times</span>
00643       <span class="comment">//</span>
00644       time(&amp;CurrentTime);
00645       LastBeatTime = CurrentTime;
00646 
00647       
00648       <span class="keywordflow">while</span> ( Running )
00649       {
00650          <span class="comment">// Module and Server check for shutdown commands</span>
00651          <span class="comment">//</span>
00652          <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00653          {
00654             <span class="comment">// Check for and respond to stop flags</span>
00655             shutdown_flag = <a class="code" href="transport_8c.html#a22">tport_getflag</a>(&amp;CommandRegion);
00656             <span class="keywordflow">if</span>( shutdown_flag == <a class="code" href="transport_8h.html#a17">TERMINATE</a>  ||  shutdown_flag  == (int)<a class="code" href="classTGlobalUtils.html#d6">TGlobalUtils::GetPID</a>() )
00657             {
00658                <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>; <span class="comment">// signal all threads to return</span>
00659                <span class="keywordflow">continue</span>;
00660             }
00661 
00662             <span class="comment">// Send heartbeat if it is time</span>
00663             <span class="keywordflow">if</span>( <a class="code" href="classTGlobalUtils.html#d12">TGlobalUtils::GetHeartbeatInt</a>() &lt;= (time(&amp;CurrentTime) - LastBeatTime) )
00664             {
00665                LastBeatTime = CurrentTime;
00666                <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_HEARTBEAT"</span>), 0, <span class="stringliteral">""</span> );
00667             }
00668          }
00669 
00670 
00671          <span class="comment">// signal handler sets global utils terminate flag, check that</span>
00672          <span class="comment">//</span>
00673          <span class="keywordflow">if</span> ( <a class="code" href="classTGlobalUtils.html#d1">TGlobalUtils::GetTerminateFlag</a>() )
00674          {
00675             <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>; <span class="comment">// signal all threads to return</span>
00676             <span class="keywordflow">continue</span>;
00677          }
00678 
00679 
00680          <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#b6">CheckForThreadDeath</a>() )
00681          {
00682             <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00683          }
00684          <span class="keywordflow">else</span>
00685          {
00686             <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
00687          }
00688 
00689       } <span class="comment">// Running</span>
00690 
00691 
00692    <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00693 
00694    <span class="comment">// All errors are thrown</span>
00695    <span class="keywordflow">return</span> <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00696 }
00697 <span class="comment">//</span>
00698 <span class="comment">//-------------------------------------------------------------------</span>
00699 <span class="comment">//</span>
<a name="l00700"></a><a class="code" href="classMutableServerBase.html#a4">00700</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classWormServerBase.html#a4">MutableServerBase::Run</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[] )
00701 {
00702    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00703 
00704    <a class="code" href="classMutableServerRequest.html">MutableServerRequest</a> * _requestcontainer = NULL;
00705 
00706    <a class="code" href="classMutableServerResult.html">MutableServerResult</a> * _resultcontainer  = NULL;
00707 
00708    <span class="keywordflow">try</span>
00709    {
00710       <span class="keywordflow">if</span> ( <a class="code" href="classTConfigurable.html#n0">ConfigState</a> != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00711       {
00712          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"MutableServerBase::Run() not properly configured"</span>);
00713       }
00714 
00715       <span class="comment">// Set up the signal handler so we can shut down gracefully</span>
00716            <span class="comment">//</span>
00717       signal(SIGINT, (SIG_HANDLR_PTR)SignalHandler);     <span class="comment">/* &lt;Ctrl-C&gt; interrupt */</span>
00718       signal(SIGTERM, (SIG_HANDLR_PTR)SignalHandler);    <span class="comment">/* program termination request */</span>
00719       signal(SIGABRT, (SIG_HANDLR_PTR)SignalHandler);    <span class="comment">/* abnormal termination */</span>
00720 <span class="preprocessor">#ifdef SIGBREAK</span>
00721 <span class="preprocessor"></span>      signal(SIGBREAK, (SIG_HANDLR_PTR)SignalHandler);   <span class="comment">/* keyboard break */</span>
00722 <span class="preprocessor">#endif</span>
00723 <span class="preprocessor"></span>
00724 <span class="preprocessor">#ifdef _SOLARIS</span>
00725 <span class="preprocessor"></span>      <span class="comment">// Ignore broken socket signals</span>
00726       (void)sigignore(SIGPIPE);
00727 <span class="preprocessor">#endif</span>
00728 <span class="preprocessor"></span>
00729 
00730       <span class="comment">// Call base class's PrepareToRun() to init logging level</span>
00731       <span class="comment">// and to perform other initialization needed by derivative</span>
00732       <span class="comment">// classes.</span>
00733       <span class="comment">//</span>
00734       <span class="keywordflow">if</span> ( ! <a class="code" href="classMutableServerBase.html#b1">PrepareToRun</a>() )
00735       {
00736          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"PrepareToRun() returned not ready"</span>);
00737       }
00738 
00739 
00740       <span class="keywordflow">switch</span>( Mode )
00741       {
00742         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a13">MMT_CLIENT</a>:
00743    
00744              <a class="code" href="classMutableServerBase.html#n24">LoggingOptions</a> = <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a>;
00745 
00746              <span class="keywordflow">if</span> ( (_requestcontainer = <a class="code" href="classMutableServerBase.html#b9">GetRequestContainer</a>()) == NULL )
00747              {
00748                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating request container"</span>);
00749              }
00750 
00751              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#b11">GetRequestFromInput</a>( argc, argv, _requestcontainer ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00752              {
00753                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"GetRequestFromInput() returned error"</span>);
00754              }
00755 
00756              <span class="keywordflow">if</span> ( (_resultcontainer = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
00757              {
00758                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating result container"</span>);
00759              }
00760 
00761              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#c0">TransmitRequest</a>( _requestcontainer, _resultcontainer ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00762              {
00763                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TransmitRequest() returned error"</span>);
00764              }
00765 
00766              <span class="comment">// Handle special case of client that will return </span>
00767              <span class="comment">// WORM_STAT_SUCCESS  = got good result</span>
00768              <span class="comment">// WORM_STAT_BADSTATE = did not get good result</span>
00769              <span class="comment">// WORM_STAT_FAILURE  = system failure</span>
00770              <span class="comment">//</span>
00771              <span class="keywordflow">if</span> ( (r_status = <a class="code" href="classMutableServerBase.html#b13">HandleResult</a>( _resultcontainer )) == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
00772              {
00773                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"HandleResult() returned error"</span>);
00774              }
00775              
00776              <span class="keywordflow">break</span>;
00777 
00778 
00779         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a10">MMT_STANDALONE</a>:
00780 
00781              <a class="code" href="classMutableServerBase.html#n24">LoggingOptions</a> = <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a>;
00782 
00783              <span class="keywordflow">if</span> ( (_requestcontainer = <a class="code" href="classMutableServerBase.html#b9">GetRequestContainer</a>()) == NULL )
00784              {
00785                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating request container"</span>);
00786              }
00787 
00788              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#b11">GetRequestFromInput</a>( argc, argv, _requestcontainer ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00789              {
00790                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"GetRequestFromInput() returned error"</span>);
00791              }
00792 
00793              <span class="keywordflow">if</span> ( (_resultcontainer = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
00794              {
00795                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating result container"</span>);
00796              }
00797 
00798              <span class="keywordflow">if</span> ( (r_status = <a class="code" href="classMutableServerBase.html#b12">ProcessRequest</a>(_requestcontainer, _resultcontainer)) == <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00799              {
00800                 <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#b13">HandleResult</a>( _resultcontainer ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
00801                 {
00802                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"HandleResult() returned error"</span>);
00803                 }
00804              }
00805 
00806              <span class="keywordflow">break</span>;
00807 
00808 
00809         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>:
00810 
00811              <a class="code" href="classMutableServerBase.html#n24">LoggingOptions</a> = <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a>|<a class="code" href="logger_8h.html#a2">WORM_LOG_TOSTDERR</a>;
00812 
00813              <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;CommandRegion, CommandRingKey );
00814              
00815              <a class="code" href="classMutableServerBase.html#b7">MainThreadActions</a>();
00816 
00817              <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;CommandRegion );
00818 
00819              <span class="keywordflow">break</span>;
00820 
00821 
00822         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>:
00823 
00824              <a class="code" href="classMutableServerBase.html#n24">LoggingOptions</a> = <a class="code" href="logger_8h.html#a0">WORM_LOG_TOFILE</a>|<a class="code" href="logger_8h.html#a2">WORM_LOG_TOSTDERR</a>;
00825 
00826              <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00827              {
00828                 <a class="code" href="transport_8c.html#a17">tport_attach</a>( &amp;CommandRegion, CommandRingKey );
00829              }
00830              
00831              <a class="code" href="classMutableServerBase.html#b7">MainThreadActions</a>();
00832 
00833              <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> != <a class="code" href="worm__types_8h.html#a11">WORM_RING_INVALID</a> )
00834              {
00835                 <a class="code" href="transport_8c.html#a18">tport_detach</a>( &amp;CommandRegion );
00836              }
00837 
00838              <span class="keywordflow">break</span>;
00839       }
00840 
00841    }
00842    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
00843    {
00844       <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00845       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00846                     , <span class="stringliteral">"MutableServerBase::Run() Error: %s\n"</span>
00847                     , _we.what()
00848                     );
00849       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00850    }
00851    <span class="keywordflow">catch</span>( ... )
00852    {
00853       <a class="code" href="classWormServerBase.html#n12">Running</a> = <span class="keyword">false</span>;
00854       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
00855    }
00856 
00857    <span class="keywordflow">if</span> ( _requestcontainer != NULL )
00858    {
00859       <span class="keyword">delete</span>( _requestcontainer );
00860    }
00861 
00862    <span class="keywordflow">if</span> ( _resultcontainer != NULL )
00863    {
00864       <span class="keyword">delete</span>( _resultcontainer );
00865    }
00866 
00867    <span class="keywordflow">return</span> r_status;
00868 }
00869 <span class="comment">//</span>
00870 <span class="comment">//-------------------------------------------------------------------</span>
00871 <span class="comment">//</span>
<a name="l00872"></a><a class="code" href="classMutableServerBase.html#c0">00872</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classMutableServerBase.html#c0">MutableServerBase::TransmitRequest</a>( <a class="code" href="classMutableServerRequest.html">MutableServerRequest</a> * p_request
00873                                                    , <a class="code" href="classMutableServerResult.html">MutableServerResult</a>  * r_result
00874                                                    )
00875 {
00876    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
00877 
00878    SOCKET _clientsocket = INVALID_SOCKET;
00879 
00880    <span class="keywordtype">char</span> * _buffer = NULL;
00881 
00882    <span class="keywordflow">try</span>
00883    {
00884       <span class="keywordflow">if</span> ( p_request == NULL || r_result == NULL )
00885       {
00886          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"NULL parameter pointer"</span>);
00887       }
00888 
00889       <span class="keywordflow">switch</span>( Mode )
00890       {
00891         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a13">MMT_CLIENT</a>:
00892              <span class="comment">// send via socket</span>
00893              {
00894                 <span class="keywordtype">int</span>                 _lastprovider = 0
00895                   ,                 _currprovider = 0
00896                   ;
00897                 <a class="code" href="struct__PROVIDER__ADDR.html">PROVIDER_ADDR</a>       _provider_addr;
00898                 <span class="keyword">struct </span>sockaddr_in  _socket_addr;
00899                 
00900 
00901                 <span class="keywordtype">bool</span> _needresult = <span class="keyword">true</span>;
00902 
00903    <span class="comment">/* TODO: get last provider id from persistence store  */</span>
00904 
00905                 _currprovider = _lastprovider;
00906 
00907                 <span class="comment">// Willing to try each provider up to 2 times</span>
00908                 <span class="comment">//</span>
00909                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _pass = 0 ; _needresult &amp;&amp; _pass &lt; <a class="code" href="classMutableServerBase.html#n4">MaxServerTryLoopCount</a> ; _pass++ )
00910                 {
00911 
00912                    <span class="keywordflow">if</span> ( _pass != 0 )
00913                    {
00914                       <span class="comment">// sleep before trying to connect again</span>
00915                       <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(250);
00916                    }
00917 
00918 
00919                    <span class="keywordflow">do</span>
00920                    {
00921                       _currprovider++;
00922 
00923 
00924                       <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n2">Providers</a>.size() &lt;= _currprovider )
00925                       {
00926                          _currprovider = 0;
00927                       }
00928 
00929                       _provider_addr = <a class="code" href="classMutableServerBase.html#n2">Providers</a>[_currprovider];
00930 
00931                       <span class="comment">// Fill socket address structure with  address and port</span>
00932                       memset( (<span class="keywordtype">char</span> *)&amp;_socket_addr, 0, <span class="keyword">sizeof</span>(_socket_addr) );
00933                       _socket_addr.sin_family = AF_INET;
00934                       _socket_addr.sin_port = htons( (<span class="keywordtype">short</span>)atoi(_provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a>.c_str()) );
00935 
00936                       <span class="keywordflow">if</span> ( (int)(_socket_addr.sin_addr.S_un.S_addr = inet_addr(_provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>.c_str())) == INADDR_NONE )
00937                       {
00938                          <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"inet_addr failed for "</span>);
00939                                         _expt += _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>;
00940                                         _expt += <span class="stringliteral">":"</span>;
00941                                         _expt += _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a>;
00942                          <span class="keywordflow">throw</span> _expt;
00943                       }
00944 
00945                       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00946                       {
00947                          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00948                                        , <span class="stringliteral">"Attempting connection to provider %d: %s:%s\n"</span>
00949                                        , _currprovider
00950                                        , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>.c_str()
00951                                        , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a>.c_str()
00952                                        );
00953                       }
00954 
00955 
00956                       <span class="keywordflow">if</span> ( ( _clientsocket = <a class="code" href="socket__ew__common_8c.html#a6">socket_ew</a>( AF_INET, SOCK_STREAM, 0) ) == INVALID_SOCKET )
00957                       {
00958                          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"socket_ew() failed"</span>);
00959                       }
00960 
00961                       <span class="keywordflow">if</span> ( _clientsocket == SOCKET_ERROR )
00962                       {
00963                          _clientsocket = INVALID_SOCKET;
00964                          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"socket_ew() failed"</span>);
00965                       }
00966 
00967 
00968                       <span class="keywordflow">if</span> ( <a class="code" href="socket__ew__common_8c.html#a7">connect_ew</a>( _clientsocket
00969                                      , (<span class="keyword">struct</span> sockaddr * )&amp;_socket_addr
00970                                      , <span class="keyword">sizeof</span>(_socket_addr)
00971                                      , ConnectFailureSec
00972                                      ) != 0 )
00973                       {
00974                          <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a12">WORM_LOG_DETAILS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00975                          {
00976                             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00977                                          , <span class="stringliteral">"connect_ew(): failed for %s:%s\n"</span>
00978                                          , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>.c_str()
00979                                          , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a>.c_str()
00980                                          );
00981                          }
00982                       }
00983                       <span class="keywordflow">else</span>
00984                       {
00985 
00986                          <span class="comment">// have a connection to a server</span>
00987                          <span class="comment">//</span>
00988 
00989                          <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
00990                          {
00991                             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
00992                                           , <span class="stringliteral">"Connected to %s:%s\n"</span>
00993                                           , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>.c_str()
00994                                           , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m1">Port</a>.c_str()
00995                                           );
00996                          }
00997 
00998 
00999                          <span class="keywordflow">if</span> ( (_buffer = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="classMutableServerBase.html#b8">GetMaxSocketBufferSize</a>()]) == NULL )
01000                          {
01001                             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed to allocate socket buffer"</span>);
01002                          }
01003 
01004 
01005                          <span class="comment">// Set up thread info for base class handling</span>
01006                          <span class="comment">//</span>
01007                          <a class="code" href="struct__ServiceThreadInfoStruct.html">ServiceThreadInfoStruct</a> _thr_info;
01008 
01009                          _thr_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m0">descriptor</a> = _clientsocket;
01010                          strcpy ( _thr_info.<a class="code" href="struct__ServiceThreadInfoStruct.html#m2">ipaddr</a> , _provider_addr.<a class="code" href="struct__PROVIDER__ADDR.html#m0">IPAddr</a>.c_str() );
01011                 
01012                          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_clientsocket] = _thr_info;
01013 
01014                                
01015                          p_request-&gt;<a class="code" href="classMutableServerMessage.html#a1">FormatBuffer</a>();
01016 
01017                          <span class="keywordtype">int</span> _msglen = p_request-&gt;<a class="code" href="classMutableServerMessage.html#a2">GetBufferLength</a>();
01018 
01019                          strcpy( _buffer, p_request-&gt;<a class="code" href="classMutableServerMessage.html#a3">GetBuffer</a>() );
01020 
01021                          <span class="comment">// wait a quarter second for the server socket to prepare</span>
01022                          <span class="comment">//</span>
01023                          <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(250);
01024 
01025 
01026                          <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a13">WORM_LOG_DEBUG</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01027                          {
01028                             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01029                                           , <span class="stringliteral">"sending to descriptor %d (%d); message [%d]:\n%s&lt;\n"</span>
01030                                           , (<span class="keywordtype">int</span>)_clientsocket
01031                                           , SendTimeoutMS
01032                                           , _msglen
01033                                           , _buffer
01034                                           );
01035                          }
01036 
01037 
01038                          <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#b4">SendMessage</a>(  _clientsocket
01039                                          ,  _buffer
01040                                          , &amp;_msglen
01041                                          )
01042                               == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
01043                          {
01044                             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed sending request"</span>);
01045                          }
01046 
01047 
01048                          <span class="comment">// willing to wait at least 5 seconds for </span>
01049                          time_t _quit_time = time(NULL)
01050                                            + ( <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> / 1000 &lt; 5 ? 5 : <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> / 1000 )
01051                                            ;
01052 
01053 
01054                          <span class="keywordtype">bool</span> _readfinished = <span class="keyword">false</span>;
01055 
01056                          <span class="keywordflow">do</span>
01057                          {
01058                             <span class="comment">// Get message line from socket</span>
01059                
01060                             _msglen = <a class="code" href="classMutableServerBase.html#b8">GetMaxSocketBufferSize</a>();
01061 
01062                             <span class="keywordflow">switch</span>( <a class="code" href="classWormServerBase.html#b3">ListenForMsg</a>(  _clientsocket
01063                                                 ,  _buffer
01064                                                 , &amp;_msglen <span class="comment">// in = max read ; out = actually read</span>
01065                                                 ,   500   <span class="comment">// 500 ms for this try</span>
01066                                                 ) )
01067                             {
01068                               <span class="keywordflow">case</span>  0:  <span class="comment">// got message line</span>
01069                                    _readfinished = r_result-&gt;<a class="code" href="classMutableServerMessage.html#a4">ParseMessageLine</a>( _buffer );
01070                                    <span class="keywordflow">break</span>;
01071                               <span class="keywordflow">case</span> -1:  <span class="comment">// timed out</span>
01072                                    <span class="keywordflow">if</span> ( _quit_time &lt; time(NULL) )
01073                                    {
01074                                       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"timed out waiting for server result"</span>);
01075                                    }
01076                                    <span class="keywordflow">break</span>;
01077                               <span class="keywordflow">case</span> -2:  <span class="comment">// socket closed on other end</span>
01078                                     <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server closed socket"</span>);
01079                               <span class="keywordflow">case</span> -3:  <span class="comment">// socket error</span>
01080                                     <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Socket error"</span>);
01081                               <span class="keywordflow">case</span> -4:  <span class="comment">// message too large for buffer</span>
01082                                     <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Server response too large for buffer"</span>);
01083                             }
01084         
01085 
01086                          } <span class="keywordflow">while</span>( ! _readfinished );
01087 
01088 
01089                          <span class="comment">// Leave the loop unless the server responded that it</span>
01090                          <span class="comment">// was busy, which case try another server</span>
01091                          <span class="comment">//</span>
01092                          <span class="keywordflow">if</span> ( r_result-&gt;<a class="code" href="classMutableServerResult.html#a2">GetStatus</a>() != <a class="code" href="result__status_8h.html#a4">MSB_RESULT_BUSY</a> )
01093                          {
01094                             _needresult = <span class="keyword">false</span>;
01095                          }
01096 
01097                       } <span class="comment">// obtained a server connection</span>
01098 
01099                       <span class="comment">// Loop until connected or all providers tried once</span>
01100                    } <span class="keywordflow">while</span>(   _needresult
01101                            &amp;&amp; _currprovider != _lastprovider 
01102                           );
01103 
01104                 } <span class="comment">// try all providers for n passes</span>
01105 
01106 
01107                 <span class="keywordflow">if</span> ( _needresult )
01108                 {
01109                    <span class="keywordflow">if</span>(   <a class="code" href="worm__defs_8h.html#a14a10">WORM_LOG_STATUS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>()
01110                       &amp;&amp;                    <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() &lt; <a class="code" href="worm__defs_8h.html#a14a12">WORM_LOG_DETAILS</a>
01111                      )
01112                    {
01113                          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01114                                        , <span class="stringliteral">"Unable to establish connection to providers:\n"</span>
01115                                        );
01116                       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _p = 0 ; _p &lt; <a class="code" href="classMutableServerBase.html#n2">Providers</a>.size() ; _p )
01117                       {
01118                          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01119                                        , <span class="stringliteral">"   %s:%s\n"</span>
01120                                        , Providers[_p].IPAddr.c_str()
01121                                        , <a class="code" href="classMutableServerBase.html#n2">Providers</a>[_p].Port.c_str()
01122                                        );
01123                       }
01124                    }
01125                    r_status = <a class="code" href="worm__statuscode_8h.html#a22a21">WORM_STAT_DISCONNECT</a>;
01126                 }
01127 
01128 
01129              } <span class="comment">// client Mode</span>
01130              <span class="keywordflow">break</span>;
01131 
01132         <span class="keywordflow">default</span>:
01133              <span class="comment">// other modes invalid</span>
01134              {
01135                 <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Invalid call for "</span>);
01136                                _expt +=                <a class="code" href="classMutableServerBase.html#q0">MSB_MODE_NAME</a>[<a class="code" href="classMutableServerBase.html#n0">Mode</a>];
01137                                _expt +=                                   <span class="stringliteral">" mode."</span>;
01138                 <span class="keywordflow">throw</span> _expt;
01139              }
01140       }
01141    }
01142    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01143    {
01144       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
01145 
01146       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01147       {
01148          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01149                       , <span class="stringliteral">"MutableServerBase::TransmitRequest(): %s\n"</span>
01150                       , _we.what()
01151                       );
01152       }
01153    }
01154    <span class="keywordflow">catch</span>( ... )
01155    {
01156       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
01157 
01158       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01159       {
01160          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01161                       , <span class="stringliteral">"MutableServerBase::TransmitRequest(): Unknown error\n"</span>
01162                       );
01163       }
01164    }
01165 
01166 
01167    <span class="keywordflow">if</span> ( _clientsocket != INVALID_SOCKET )
01168    {
01169       <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( _clientsocket, SOCKET_CLOSE_IMMEDIATELY_EW );
01170    }
01171 
01172    <span class="keywordflow">return</span> r_status;
01173 }
01174 <span class="comment">//</span>
01175 <span class="comment">//-------------------------------------------------------------------</span>
01176 <span class="comment">//</span>
<a name="l01177"></a><a class="code" href="classMutableServerBase.html#c1">01177</a> <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> <a class="code" href="classMutableServerBase.html#c1">MutableServerBase::TransmitResult</a>(       <a class="code" href="classMutableServerResult.html">MutableServerResult</a> * p_result
01178                                                   , <span class="keyword">const</span> SOCKET              * p_socketdescriptor <span class="comment">/* = NULL */</span>
01179                                                   )
01180 {
01181    <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> r_status = <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>;
01182 
01183    <a class="code" href="classMutableServerResult.html">MutableServerResult</a> * _workresult = p_result;
01184    <span class="keywordtype">bool</span> _myresult = <span class="keyword">false</span>;
01185 
01186    <span class="keywordflow">try</span>
01187    {
01188       <span class="keywordtype">int</span> _neededlength;
01189 
01190       <span class="keywordflow">switch</span>( Mode )
01191       {
01192         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a12">MMT_SERVER</a>:
01193              <span class="comment">// send via socket</span>
01194              <span class="keywordflow">if</span> ( p_socketdescriptor == NULL )
01195              {
01196                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"SOCKET pointer NULL"</span>);
01197              }
01198              <span class="keywordflow">else</span>
01199              {
01200                 <span class="keywordtype">int</span>    _msglen;
01201 
01202                 SOCKET _socket = (SOCKET)*p_socketdescriptor;
01203 
01204                 <span class="keywordflow">if</span> ( _workresult == NULL )
01205                 {
01206                    <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
01207                    {
01208                       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01209                                     , <span class="stringliteral">"NULL result container pointer\n"</span>
01210                                     );
01211                    }
01212                    <span class="keywordflow">if</span> ( (_workresult = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
01213                    {
01214                       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed to create work result buffer for error"</span>);
01215                    }
01216                    _myresult = <span class="keyword">true</span>;
01217                    _workresult-&gt;<a class="code" href="classMutableServerResult.html#a1">SetStatus</a>( MSB_RESULT_ERROR );
01218                 }
01219 
01220                 _workresult-&gt;<a class="code" href="classMutableServerMessage.html#a1">FormatBuffer</a>();
01221                 _msglen = p_result-&gt;<a class="code" href="classMutableServerMessage.html#a2">GetBufferLength</a>();
01222 
01223 
01224 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01225               , <span class="stringliteral">"DEBUG [%d] returning status to client at %d; message [%d]:\n%s&lt;\n"</span>
01226               , SendTimeoutMS
01227               , (<span class="keywordtype">int</span>)_socket
01228               , _msglen
01229               , p_result-&gt;<a class="code" href="classMutableServerMessage.html#a3">GetBuffer</a>()
01230               );
01231 
01232                 <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#b4">SendMessage</a>(  _socket
01233                                 ,  p_result-&gt;<a class="code" href="classMutableServerMessage.html#a3">GetBuffer</a>()
01234                                 , &amp;_msglen
01235                                 ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a>
01236                    )
01237                 {
01238                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed sending result across socket"</span>);
01239                 }
01240              }
01241              <span class="keywordflow">break</span>;
01242 
01243         <span class="keywordflow">case</span> <a class="code" href="mutableserverbase_8h.html#a14a11">MMT_MODULE</a>:
01244 
01245              <span class="comment">// send via ring</span>
01246 
01247              <span class="keywordflow">if</span> ( p_result == NULL )
01248              {
01249                 <span class="comment">// this represents an error condition ("-1\n\n")</span>
01250                 _neededlength = 4;
01251              }
01252              <span class="keywordflow">else</span>
01253              {
01254                 p_result-&gt;<a class="code" href="classMutableServerMessage.html#a1">FormatBuffer</a>();
01255                 _neededlength = p_result-&gt;<a class="code" href="classMutableServerMessage.html#a2">GetBufferLength</a>();
01256              }
01257 
01258              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n16">TransmitBufferLength</a> &lt; _neededlength )
01259              {
01260                 <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> != NULL )
01261                 {
01262                    <span class="keyword">delete</span> [] <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a>;
01263                 }
01264                 <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> = NULL;
01265              }
01266 
01267              <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> == NULL )
01268              {
01269                 <span class="keywordflow">if</span> ( (<a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[p_result-&gt;<a class="code" href="classMutableServerMessage.html#a2">GetBufferLength</a>()+100]) == NULL )
01270                 {
01271                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed allocating transmit buffer"</span>);
01272                 }
01273                 <a class="code" href="classMutableServerBase.html#n16">TransmitBufferLength</a> = p_result-&gt;<a class="code" href="classMutableServerMessage.html#a2">GetBufferLength</a>()+100;
01274              }
01275 
01276 
01277              <a class="code" href="classMutableServerBase.html#n15">TransmitBuffer</a>[0] = <span class="charliteral">'\0'</span>;
01278 
01279              <span class="keywordflow">if</span> ( p_result == NULL )
01280              {
01281                 strcpy( TransmitBuffer , <span class="stringliteral">"-1\n\n"</span> );
01282              }
01283              <span class="keywordflow">else</span>
01284              {
01285                 strcpy( TransmitBuffer , p_result-&gt;<a class="code" href="classMutableServerMessage.html#a3">GetBuffer</a>() );
01286              }
01287 
01288              <span class="keywordflow">if</span> ( <a class="code" href="transport_8c.html#a19">tport_putmsg</a>(  OutputRegion
01289                               , &amp;ResultMsgLogo
01290                               ,  _neededlength
01291                               ,  TransmitBuffer
01292                               )
01293                   != <a class="code" href="transport_8h.html#a5">PUT_OK</a>
01294                 )
01295              {
01296                 <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"tport_putmsg() failed"</span>);
01297              }
01298 
01299              <span class="keywordflow">break</span>;
01300 
01301         <span class="keywordflow">default</span>:
01302              <span class="comment">// other modes invalid</span>
01303              {
01304                 <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"invalid call for "</span>);
01305                                _expt +=                <a class="code" href="classMutableServerBase.html#q0">MSB_MODE_NAME</a>[<a class="code" href="classMutableServerBase.html#n0">Mode</a>];
01306                                _expt +=                                  <span class="stringliteral">" mode."</span>;
01307                 <span class="keywordflow">throw</span> _expt;
01308              }
01309       }
01310    }
01311    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01312    {
01313       r_status = <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a>;
01314 
01315       <span class="keywordflow">if</span>( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classTGlobalUtils.html#d11">TGlobalUtils::GetLoggingLevel</a>() )
01316       {
01317          <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01318                       , <span class="stringliteral">"MutableServerBase::TransmitResult(): %s\n"</span>
01319                       , _we.what()
01320                       );
01321       }
01322    }
01323 
01324    <span class="keywordflow">if</span> ( _myresult &amp;&amp; _workresult != NULL )
01325    {
01326       <span class="keyword">delete</span> ( _workresult );
01327    }
01328 
01329    <span class="keywordflow">return</span> r_status;
01330 }
01331 <span class="comment">//</span>
01332 <span class="comment">//-------------------------------------------------------------------</span>
01333 <span class="comment">//</span>
<a name="l01334"></a><a class="code" href="classMutableServerBase.html#b3">01334</a> THREAD_RETURN <a class="code" href="classMutableServerBase.html#b3">MutableServerBase::Stacker</a>()
01335 {
01336    <span class="keyword">static</span> InstallWildcard = <a class="code" href="classTGlobalUtils.html#d13">TGlobalUtils::LookupInstallationId</a>(<span class="stringliteral">"INST_WILDCARD"</span>);
01337    <span class="keyword">static</span> ModuleWildcard  = <a class="code" href="classTGlobalUtils.html#d14">TGlobalUtils::LookupModuleId</a>(<span class="stringliteral">"MOD_WILDCARD"</span>);
01338    <span class="keyword">static</span> MessageWildcard = <a class="code" href="classTGlobalUtils.html#d15">TGlobalUtils::LookupMessageTypeId</a>(<span class="stringliteral">"TYPE_WILDCARD"</span>);
01339 
01340    <span class="keywordtype">int</span>      _getmsg_status;
01341         <a class="code" href="structMSG__LOGO.html">MSG_LOGO</a> _arrivelogo;      <span class="comment">// logo of arriving message</span>
01342    <span class="keywordtype">long</span>     _arr_msg_len;     <span class="comment">// length of arriving message</span>
01343    <span class="keywordtype">bool</span>     _msg_ready;
01344    <span class="keywordtype">char</span>     _errormsg[300];   <span class="comment">//</span>
01345 
01346    <span class="keywordtype">bool</span> _attached = <span class="keyword">false</span>;
01347 
01348 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01349               , <span class="stringliteral">"MutableServerBase::Stacker(): A\n"</span>
01350               );
01351 
01352    <span class="keywordflow">try</span>
01353    {
01354       <a class="code" href="classMutableServerBase.html#n20">LastStackerPulse</a> = time(NULL); <span class="comment">// "I'm still alive"</span>
01355 
01356 
01357       <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> == <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> )
01358       {
01359          <a class="code" href="classMutableServerBase.html#n9">InputRegion</a> = &amp;<a class="code" href="classWormServerBase.html#n11">CommandRegion</a>;
01360       }
01361       <span class="keywordflow">else</span>
01362       {
01363          <a class="code" href="classMutableServerBase.html#n9">InputRegion</a> = &amp;<a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>;
01364          <a class="code" href="transport_8c.html#a17">tport_attach</a>( InputRegion, InputRingKey );
01365          _attached = <span class="keyword">true</span>;
01366       }
01367 
01368 
01369       <span class="comment">// Skip any messages already in ring</span>
01370       <span class="comment">//</span>
01371       <span class="keywordflow">do</span>
01372       {
01373          _getmsg_status = <a class="code" href="transport_8c.html#a20">tport_getmsg</a>(  InputRegion
01374                                       ,  ServeLogo
01375                                       ,  ServeLogoCount
01376                                       , &amp;_arrivelogo
01377                                       , &amp;_arr_msg_len
01378                                       ,  MessageBuffer
01379                                       ,  MaxMessageLength
01380                                       );
01381       }
01382       <span class="keywordflow">while</span> ( _getmsg_status != <a class="code" href="transport_8h.html#a9">GET_NONE</a> );
01383       
01384 
01385       <span class="comment">// Add wildcard to those accepted</span>
01386 
01387       <span class="keywordflow">while</span> ( Running )
01388       {
01389          <a class="code" href="classMutableServerBase.html#n20">LastStackerPulse</a> = time(NULL); <span class="comment">// "I'm still alive"</span>
01390 
01391          _msg_ready = <span class="keyword">true</span>;
01392 
01393          <span class="keywordflow">switch</span>( (_getmsg_status = <a class="code" href="transport_8c.html#a20">tport_getmsg</a>(  InputRegion
01394                                                ,  ServeLogo
01395                                                ,  ServeLogoCount
01396                                                , &amp;_arrivelogo
01397                                                , &amp;_arr_msg_len
01398                                                ,  MessageBuffer
01399                                                ,  MaxMessageLength
01400                                                ))
01401                )
01402          {
01403            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a8">GET_OK</a>:
01404                 <span class="keywordflow">break</span>;
01405 
01406            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a10">GET_MISS</a>:
01407            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a13">GET_MISS_LAPPED</a>:
01408                 <span class="comment">// report error, handle message</span>
01409                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), MSB_ERR_MISSMSG, <span class="stringliteral">"missed messages"</span> );
01410                 <span class="keywordflow">break</span>;
01411 
01412            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a14">GET_MISS_SEQGAP</a>:
01413                 <span class="comment">// report error, handle message</span>
01414                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), MSB_ERR_MISSMSG, <span class="stringliteral">"saw sequence gap"</span> );
01415                 <span class="keywordflow">break</span>;
01416 
01417            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a11">GET_NOTRACK</a>:
01418                 <span class="comment">// report error, handle message</span>
01419                 sprintf( _errormsg
01420                        , <span class="stringliteral">"no tracking for logo i%d m%d t%d in %s"</span>
01421                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
01422                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
01423                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
01424                        , InputRingName
01425                        );
01426                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), MSB_ERR_NOTRACK, _errormsg );
01427                 <span class="keywordflow">break</span>;
01428 
01429            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a12">GET_TOOBIG</a>:
01430                 <span class="comment">// report error, return to main loop to sleep</span>
01431                 sprintf( _errormsg
01432                        , <span class="stringliteral">"tport msg[%ld] i%d m%d t%d too big. Max is %ld"</span>
01433                        , _arr_msg_len
01434                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>
01435                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>
01436                        , (<span class="keywordtype">int</span>)_arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>
01437                        , MaxMessageLength
01438                        );
01439                 <a class="code" href="classWormServerBase.html#b5">SendStatus</a>( TGlobalUtils::LookupMessageTypeId(<span class="stringliteral">"TYPE_ERROR"</span>), MSB_ERR_TOOBIG, _errormsg );
01440 
01441                 _msg_ready = <span class="keyword">false</span>;
01442 
01443                <span class="keywordflow">break</span>;
01444 
01445            <span class="keywordflow">case</span> <a class="code" href="transport_8h.html#a9">GET_NONE</a>:
01446 
01447                 <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
01448                 _msg_ready = <span class="keyword">false</span>;
01449 
01450                <span class="keywordflow">break</span>;
01451 
01452          }  <span class="comment">// switch( tport_getmsg() )</span>
01453 
01454 
01455          <span class="keywordflow">if</span> ( _msg_ready )
01456          {
01457             <span class="comment">// NULL-terminate string buffer</span>
01458             <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
01459 
01460             <span class="comment">// truncate end-of-line if present</span>
01461             <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a>[_arr_msg_len-1] == <span class="charliteral">'\n'</span> )
01462             {
01463                _arr_msg_len--;
01464                <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a>[_arr_msg_len] = 0;
01465             }
01466 
01467             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i = 0, _sz = <a class="code" href="classMutableServerBase.html#n14">ServeLogoCount</a> ; _i &lt; _sz ; _i++ )
01468             {
01469                <span class="keywordflow">if</span> (   (   <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a> == InstallWildcard
01470                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == InstallWildcard
01471                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m2">instid</a>   == <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m2">instid</a>
01472                       )
01473                    &amp;&amp; (   <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a> == ModuleWildcard
01474                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == ModuleWildcard
01475                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m1">mod</a>   == <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m1">mod</a>
01476                       )
01477                    &amp;&amp; (   <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a> == MessageWildcard
01478                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == MessageWildcard
01479                        || _arrivelogo.<a class="code" href="structMSG__LOGO.html#m0">type</a>   == <a class="code" href="classMutableServerBase.html#n13">ServeLogo</a>[_i].<a class="code" href="structMSG__LOGO.html#m0">type</a>
01480                       )
01481                   )
01482                {
01483                   std::string _newmsg = <a class="code" href="classMutableServerBase.html#o1">MessageBuffer</a>;
01484 
01485                   <span class="comment">// put the new message on the queue for the handler thread</span>
01486                   <a class="code" href="classMutableServerBase.html#n18">MessageQueue</a>.push( _newmsg );
01487 
01488                   <span class="keywordflow">break</span>;
01489                }
01490             } <span class="comment">// check each logo for match</span>
01491          } <span class="comment">// msg_ready</span>
01492 
01493       } <span class="comment">// Running</span>
01494 
01495    }
01496    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01497    {
01498       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01499                     , <span class="stringliteral">"MutableServerBase::Stacker() Error: %s"</span>
01500                     , _we.what()
01501                     );
01502       <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL );
01503    }
01504    <span class="keywordflow">catch</span>( ... )
01505    {
01506       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01507                     , <span class="stringliteral">"MutableServerBase::Stacker() Unknown Error"</span>
01508                     );
01509       <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL );
01510    }
01511 
01512    <span class="keywordflow">if</span> ( _attached )
01513    {
01514       <a class="code" href="transport_8c.html#a18">tport_detach</a>( InputRegion );
01515    }
01516 }
01517 <span class="comment">//</span>
01518 <span class="comment">//-------------------------------------------------------------------</span>
01519 <span class="comment">//</span>
<a name="l01520"></a><a class="code" href="classMutableServerBase.html#b4">01520</a> THREAD_RETURN <a class="code" href="classMutableServerBase.html#b4">MutableServerBase::Handler</a>()
01521 {
01522 
01523    <span class="keywordtype">bool</span> _attached = <span class="keyword">false</span>;
01524 
01525    std::string _message;
01526 
01527    <a class="code" href="classMutableServerRequest.html">MutableServerRequest</a> * _requestcontainer = NULL;
01528 
01529    <a class="code" href="classMutableServerResult.html">MutableServerResult</a> * _resultcontainer = NULL;
01530 
01531    <span class="keywordflow">try</span>
01532    {
01533       <a class="code" href="classMutableServerBase.html#n22">LastHandlerPulse</a> = time(NULL); <span class="comment">// "I'm still alive"</span>
01534 
01535 
01536       <span class="keywordflow">if</span> ( (_requestcontainer = <a class="code" href="classMutableServerBase.html#b9">GetRequestContainer</a>()) == NULL )
01537       {
01538          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed to create request container"</span>);
01539       }
01540 
01541       <span class="keywordflow">if</span> ( (_resultcontainer = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
01542       {
01543          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed to create result container"</span>);
01544       }
01545 
01546 
01547       <span class="keywordflow">if</span>      ( <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> == <a class="code" href="classWormServerBase.html#n10">CommandRingKey</a> )
01548       {
01549          <a class="code" href="classMutableServerBase.html#n10">OutputRegion</a> = &amp;<a class="code" href="classWormServerBase.html#n11">CommandRegion</a>;
01550       }
01551       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n8">OutputRingKey</a> == <a class="code" href="classMutableServerBase.html#n7">InputRingKey</a> )
01552       {
01553          <a class="code" href="classMutableServerBase.html#n10">OutputRegion</a> = &amp;<a class="code" href="classMutableServerBase.html#n11">InputRegionStruct</a>;
01554       }
01555       <span class="keywordflow">else</span>
01556       {
01557          <a class="code" href="classMutableServerBase.html#n10">OutputRegion</a> = &amp;<a class="code" href="classMutableServerBase.html#n12">OutputRegionStruct</a>;
01558          <a class="code" href="transport_8c.html#a17">tport_attach</a>( OutputRegion, OutputRingKey );
01559          _attached = <span class="keyword">true</span>;
01560       }
01561 
01562 
01563       <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> _processing_state;
01564 
01565 
01566       <span class="keywordflow">while</span> ( Running )
01567       {
01568          <a class="code" href="classMutableServerBase.html#n22">LastHandlerPulse</a> = time(NULL); <span class="comment">// "I'm still alive"</span>
01569 
01570          <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#n18">MessageQueue</a>.empty() )
01571          {
01572             <a class="code" href="classTTimeFuncs.html#d3">TTimeFuncs::MSecSleep</a>(500);
01573          }
01574          <span class="keywordflow">else</span>
01575          {
01576             <span class="comment">// get the next message</span>
01577             _message = <a class="code" href="classMutableServerBase.html#n18">MessageQueue</a>.front();
01578 
01579             <span class="comment">// remove the message from the queue</span>
01580             <a class="code" href="classMutableServerBase.html#n18">MessageQueue</a>.pop();
01581 
01582             <span class="keywordflow">try</span>
01583             {
01584                _requestcontainer-&gt;<a class="code" href="classMutableServerMessage.html#a5">ParseFromBuffer</a>( _message.c_str() );
01585             }
01586             <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01587             {
01588                <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01589                              , <span class="stringliteral">"MutableServerBase::Handler() Error parsing message:\n%s\n%s\n"</span>
01590                              , _message.c_str()
01591                              , _we.what()
01592                              );
01593 
01594                <span class="comment">//  loop for next messsage</span>
01595                <span class="keywordflow">continue</span>;
01596             }
01597          
01598 
01599             _processing_state = <a class="code" href="classMutableServerBase.html#b12">ProcessRequest</a>( _requestcontainer, _resultcontainer );
01600 
01601             <span class="keywordflow">if</span> ( _processing_state == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
01602             {
01603                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"ProcessRequest() returned error"</span>);
01604             }
01605 
01606             <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( _resultcontainer ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
01607             {
01608                <span class="comment">// failure to transmit here means that we're unable</span>
01609                <span class="comment">// to send the response to the ring -- should die</span>
01610                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"ParseRequestFromMessage() returned error"</span>);
01611             }
01612 
01613          } <span class="comment">// handling pending message</span>
01614 
01615       } <span class="comment">// Running</span>
01616 
01617    }
01618    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01619    {
01620       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01621                     , <span class="stringliteral">"MutableServerBase::Handler() Error: %s\n"</span>
01622                     , _we.what()
01623                     );
01624       <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL );
01625    }
01626    <span class="keywordflow">catch</span>( ... )
01627    {
01628       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01629                     , <span class="stringliteral">"MutableServerBase::Handler() Unknown Error\n"</span>
01630                     );
01631       <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL );
01632    }
01633 
01634 
01635    <span class="keywordflow">if</span> ( _attached )
01636    {
01637       <a class="code" href="transport_8c.html#a18">tport_detach</a>( OutputRegion );
01638    }
01639 
01640 
01641    <span class="keywordflow">if</span> ( _requestcontainer != NULL )
01642    {
01643       <span class="keyword">delete</span>( _requestcontainer );
01644    }
01645 
01646    <span class="keywordflow">if</span> ( _resultcontainer != NULL )
01647    {
01648       <span class="keyword">delete</span>( _resultcontainer );
01649    }
01650 }
01651 <span class="comment">//</span>
01652 <span class="comment">//-------------------------------------------------------------------</span>
01653 <span class="comment">//</span>
<a name="l01654"></a><a class="code" href="classMutableServerBase.html#b2">01654</a> THREAD_RETURN <a class="code" href="classMutableServerBase.html#b2">MutableServerBase::ClientServicer</a>( <span class="keywordtype">void</span> * p_socketdescriptor )
01655 {
01656    <span class="keywordflow">if</span> ( p_socketdescriptor == NULL )
01657    {
01658       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01659                     , <span class="stringliteral">"MutableServerBase::ClientServicer() Error: NULL descriptor parameter\n"</span>
01660                     );
01661       <span class="keywordflow">return</span>;
01662    }
01663 
01664    <span class="keywordtype">char</span> * _buffer = NULL;
01665 
01666    <a class="code" href="classMutableServerRequest.html">MutableServerRequest</a> * _requestcontainer = NULL;
01667 
01668    <a class="code" href="classMutableServerResult.html">MutableServerResult</a> * _resultcontainer = NULL;
01669 
01670 
01671    SOCKET _mapkey = *((SOCKET *)p_socketdescriptor);
01672 
01673    <span class="keywordtype">bool</span> _send_error_message = <span class="keyword">false</span>;
01674 
01675 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01676               , <span class="stringliteral">"MutableServerBase::ClientServicer(): descriptor %d\n"</span>
01677               , (<span class="keywordtype">int</span>)_mapkey
01678               );
01679 
01680    <span class="keywordflow">try</span>
01681    {
01682       <span class="comment">// tell the main thread this thread is alive</span>
01683       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01684       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a16">THREAD_INITIALIZING</a>;
01685 
01686       <span class="keywordflow">if</span> ( <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>.size() == <a class="code" href="classMutableServerBase.html#n1">MaxClients</a> )
01687       {
01688          <span class="comment">// no more service threads allowed, tell client that</span>
01689          <span class="comment">// we're busy</span>
01690 
01691          <span class="keywordflow">if</span> ( (_resultcontainer = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
01692          {
01693             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating result container"</span>);
01694          }
01695 
01696          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01697          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a17">THREAD_WAITING</a>;
01698 
01699          _resultcontainer-&gt;<a class="code" href="classMutableServerResult.html#a1">SetStatus</a>( MSB_RESULT_BUSY );
01700 
01701          <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( _resultcontainer, &amp;_mapkey ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
01702          {
01703             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TransmitResult() returned error"</span>);
01704          }
01705       }
01706       <span class="keywordflow">else</span>
01707       {
01708          <span class="keywordflow">if</span> ( (_buffer = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="classMutableServerBase.html#b8">GetMaxSocketBufferSize</a>()+1]) == NULL )
01709          {
01710             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed getting request buffer"</span>);
01711          }
01712 
01713          <span class="keywordflow">if</span> ( (_requestcontainer = <a class="code" href="classMutableServerBase.html#b9">GetRequestContainer</a>()) == NULL )
01714          {
01715             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating request container"</span>);
01716          }
01717 
01718          <span class="keywordflow">if</span> ( (_resultcontainer = <a class="code" href="classMutableServerBase.html#b10">GetResultContainer</a>()) == NULL )
01719          {
01720             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed creating result container"</span>);
01721          }
01722 
01723          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01724          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a17">THREAD_WAITING</a>;
01725 
01726 
01727          <span class="keywordtype">bool</span> _messagefinished = <span class="keyword">false</span>
01728             , _readfinished    = <span class="keyword">false</span>
01729             ;
01730 
01731          <span class="keywordtype">int</span> _length;
01732 
01733 
01734          <span class="comment">// set number of seconds to wait for client's message</span>
01735          <span class="comment">//</span>
01736          time_t _quit_time = time(NULL)
01737                            + ( <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> / 1000 &lt; 5 ? 5 : <a class="code" href="classWormServerBase.html#n8">RecvTimeoutMS</a> / 1000 )
01738                            ;
01739 
01740          <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a10">WORM_LOG_STATUS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
01741          {
01742             <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01743                           , <span class="stringliteral">"MutableServerBase::ClientServicer(): calling ListenForMsg(,,,%d)\n"</span>
01744                           , RecvTimeoutMS
01745                           );
01746          }
01747 
01748 
01749          <span class="keywordflow">do</span>
01750          {
01751             <span class="comment">// Get message line from socket</span>
01752 
01753          
01754             _length = <a class="code" href="classMutableServerBase.html#b8">GetMaxSocketBufferSize</a>();
01755 
01756             <span class="keywordflow">switch</span> ( <a class="code" href="classWormServerBase.html#b3">ListenForMsg</a>(  _mapkey
01757                                  ,  _buffer
01758                                  , &amp;_length
01759                                  ,  500   <span class="comment">// 500 ms for this pass</span>
01760                                  )
01761                    )
01762             {
01763               <span class="keywordflow">case</span> 0:    <span class="comment">// success</span>
01764                    _buffer[_length] = <span class="charliteral">'\0'</span>;
01765 
01766                    <span class="keywordflow">if</span> ( <a class="code" href="worm__defs_8h.html#a14a9">WORM_LOG_ERRORS</a> &lt;= <a class="code" href="classWormServerBase.html#n6">LoggingLevel</a> )
01767                    {
01768                       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01769                                     , <span class="stringliteral">"MutableServerBase::ClientServicer(): received msg line: %s\n"</span>
01770                                     , _buffer
01771                                     );
01772                    }
01773 
01774                    _readfinished = _messagefinished = _requestcontainer-&gt;<a class="code" href="classMutableServerMessage.html#a4">ParseMessageLine</a>( _buffer );
01775 <span class="comment">/*</span>
01776 <span class="comment">                   if ( ! (_messagefinished = _requestcontainer-&gt;ParseMessageLine( _buffer )) )</span>
01777 <span class="comment">                   {</span>
01778 <span class="comment">                      _readfinished = false;</span>
01779 <span class="comment">                   }</span>
01780 <span class="comment">                   else</span>
01781 <span class="comment">                   {</span>
01782 <span class="comment">                      _readfinished = true;</span>
01783 <span class="comment">                   }</span>
01784 <span class="comment">*/</span>
01785                    <span class="keywordflow">break</span>;
01786 
01787               <span class="keywordflow">case</span> -1:  <span class="comment">// timed out</span>
01788                    <span class="keywordflow">if</span> ( _quit_time &lt; time(NULL) )
01789                    {
01790                       _send_error_message = <span class="keyword">true</span>;
01791                       <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Client connection timed out"</span>);
01792                    }
01793                    <span class="keywordflow">break</span>;
01794 
01795               <span class="keywordflow">case</span> -2:  <span class="comment">// client closed socket</span>
01796                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Client closed connection"</span>);
01797 
01798               <span class="keywordflow">case</span> -3:  <span class="comment">// socket error</span>
01799                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Socket error"</span>);
01800 
01801               <span class="keywordflow">case</span> -4:  <span class="comment">// msg too large for buffer</span>
01802                    _send_error_message = <span class="keyword">true</span>;
01803                    <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Message too large for transmit buffer"</span>);
01804             }
01805 
01806 
01807 <span class="comment">//TLogger::Logit( LoggingOptions</span>
01808 <span class="comment">//              , "MutableServerBase::ClientServicer(): DEBUG M\n"</span>
01809 <span class="comment">//              );</span>
01810         
01811 
01812          } <span class="keywordflow">while</span>( ! _readfinished );
01813 
01814 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01815               , <span class="stringliteral">"MutableServerBase::ClientServicer(): DEBUG N\n"</span>
01816               );
01817 
01818          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01819          <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a18">THREAD_PROCESSING</a>;
01820 
01821          <span class="keywordflow">if</span> ( _messagefinished )
01822          {
01823 
01824 <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01825               , <span class="stringliteral">"MutableServerBase::ClientServicer(): DEBUG O -- message finished\n"</span>
01826               );
01827 
01828             <a class="code" href="statuscode_8h.html#a16">WORM_STATUS_CODE</a> _state = <a class="code" href="classMutableServerBase.html#b12">ProcessRequest</a>( _requestcontainer, _resultcontainer );
01829 
01830             <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01831 
01832             <span class="keywordflow">if</span> ( _state == <a class="code" href="statuscode_8h.html#a16a5">WORM_STAT_FAILURE</a> )
01833             {
01834                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"ProcessRequest() returned error"</span>);
01835             }
01836 
01837             <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].lastpulse = time(NULL); <span class="comment">// "I'm still alive"</span>
01838 
01839             <span class="keywordflow">if</span> ( <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( _resultcontainer, &amp;_mapkey ) != <a class="code" href="statuscode_8h.html#a16a7">WORM_STAT_SUCCESS</a> )
01840             {
01841                <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"TransmitResult() returned error"</span>);
01842             }
01843          }
01844          <span class="keywordflow">else</span>
01845          {
01846             <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Incomplete message received"</span>);
01847          }
01848 
01849 <span class="comment">//         ThreadsInfo[_mapkey].lastpulse = time(NULL); // "I'm still alive"</span>
01850       } <span class="comment">// service thread(s) not maxed out</span>
01851 
01852       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a21">THREAD_COMPLETED</a>;
01853    
01854    }
01855    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> &amp; _we )
01856    {
01857       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a14">THREAD_ERROR</a>;
01858       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01859                     , <span class="stringliteral">"MutableServerBase::ClientServicer(thr: %d) Error: %s\n"</span>
01860                     , ThreadsInfo[_mapkey].threadid
01861                     , _we.what()
01862                     );
01863       <span class="keywordflow">if</span> ( _send_error_message )
01864       {
01865          <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL, &amp;_mapkey );
01866       }
01867    }
01868    <span class="keywordflow">catch</span>( ... )
01869    {
01870       <a class="code" href="classWormServerBase.html#n7">ThreadsInfo</a>[_mapkey].status = <a class="code" href="serverbase_8h.html#a22a14">THREAD_ERROR</a>;
01871       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( LoggingOptions
01872                     , <span class="stringliteral">"MutableServerBase::ClientServicer(thr: %d) Unknown error\n"</span>
01873                     , ThreadsInfo[_mapkey].threadid
01874                     );
01875       <span class="keywordflow">if</span> ( _send_error_message )
01876       {
01877          <a class="code" href="classMutableServerBase.html#c1">TransmitResult</a>( NULL, &amp;_mapkey );
01878       }
01879    }
01880 
01881 
01882    <span class="comment">// Close socket</span>
01883 
01884    <span class="keywordflow">if</span> ( _mapkey != NULL )
01885    {
01886       <a class="code" href="socket__ew__common_8c.html#a16">closesocket_ew</a>( _mapkey, SOCKET_CLOSE_IMMEDIATELY_EW );
01887    }
01888 
01889    <span class="keywordflow">if</span> ( _buffer != NULL )
01890    {
01891       <span class="keyword">delete</span>[] _buffer;
01892    }
01893 
01894    <span class="keywordflow">if</span> ( _requestcontainer != NULL )
01895    {
01896       <span class="keyword">delete</span>( _requestcontainer );
01897    }
01898 
01899    <span class="keywordflow">if</span> ( _resultcontainer != NULL )
01900    {
01901       <span class="keyword">delete</span>( _resultcontainer );
01902    }
01903 }
01904 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:06 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
