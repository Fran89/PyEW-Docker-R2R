<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mfc_dlog_app_base.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>mfc_dlog_app_base.cpp</h1><a href="mfc__dlog__app__base_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// mfc_dlog_app_base.cpp : Base class for MFC applications that use a dialog-style.</span>
00002 <span class="comment">//</span>
00003 
00004 <span class="comment">//#include &lt;stdafx.h&gt;</span>
00005 
00006 <span class="preprocessor">#include &lt;<a class="code" href="mfc__dlog__app__base_8h.html">mfc_dlog_app_base.h</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="comfile_8h.html">comfile.h</a>&gt;</span>
00008 
00009 <span class="comment">//#ifdef _DEBUG</span>
00010 <span class="comment">//#define new DEBUG_NEW</span>
00011 <span class="comment">//#undef THIS_FILE</span>
00012 <span class="comment">//#define THIS_FILE "__FILE__"</span>
00013 <span class="comment">//static char THIS_FILE[] = __FILE__;</span>
00014 <span class="comment">//#endif</span>
00015 
00016 
00017 
00019 
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment">** This function is used by CMFCDialogAppBase, and all derivatives,</span>
00023 <span class="comment">** to start worker threads running in a given class method.</span>
00024 <span class="comment">**</span>
00025 <span class="comment">** First, set class variable(s) to track start directives,</span>
00026 <span class="comment">** then call this method, with 'this' as the parameter,</span>
00027 <span class="comment">** afterwards the worker thread can determine from the class</span>
00028 <span class="comment">** variables what the thread activities should be performed.</span>
00029 <span class="comment">**</span>
00030 <span class="comment">** Note that the class variables are not thread-safe, so </span>
00031 <span class="comment">** multiple worker threads, the caller should impose a sleep</span>
00032 <span class="comment">** after each AfxBeginThread() to allow the worker thread to</span>
00033 <span class="comment">** read the class variables before they are changed.</span>
00034 <span class="comment">*/</span>
<a name="l00035"></a><a class="code" href="mfc__dlog__app__base_8cpp.html#a0">00035</a> UINT AFX_CDECL <a class="code" href="mfc__dlog__app__base_8cpp.html#a0">StartMFCWorkerThread</a>(LPVOID p_object)
00036 {
00037    <a class="code" href="classCMFCDialogAppBase.html">CMFCDialogAppBase</a> * p_sr = (<a class="code" href="classCMFCDialogAppBase.html">CMFCDialogAppBase</a> *)p_object;
00038 
00039    p_sr-&gt;<a class="code" href="classCMFCDialogAppBase.html#a2">StartWorkerThread</a>();
00040 
00041    <span class="keywordflow">return</span> 0;
00042 }
00043 
00044 
00046 <span class="comment">// CMFCDialogAppBase</span>
00047 
00048 BEGIN_MESSAGE_MAP(<a class="code" href="classCMFCDialogAppBase.html">CMFCDialogAppBase</a>, CWinApp)
00049         <span class="comment">//{{AFX_MSG_MAP(CMFCDialogAppBase)</span>
00050                 <span class="comment">// NOTE - the ClassWizard will add and remove mapping macros here.</span>
00051                 <span class="comment">//    DO NOT EDIT what you see in these blocks of generated code!</span>
00052         <span class="comment">//}}AFX_MSG</span>
00053         ON_COMMAND(ID_HELP, CWinApp::OnHelp)
00054    <span class="comment">// Using dialog-based application needs special idle processing</span>
00055    <span class="comment">// to updates menus, ets.</span>
00056 END_MESSAGE_MAP()
00057 
00058 
00059 <span class="comment">// CMFCDialogAppBase construction</span>
00060 
<a name="l00061"></a><a class="code" href="classCMFCDialogAppBase.html#a0">00061</a> <a class="code" href="classCMFCDialogAppBase.html#a0">CMFCDialogAppBase::CMFCDialogAppBase</a>()
00062 {
00063    <a class="code" href="classCMFCDialogAppBase.html#n1">LoggingLevel</a> = 0;
00064 }
00065 
00067 <span class="comment">// The one and only CMFCDialogAppBase object</span>
00068 
00069 <span class="comment">// CMFCDialogAppBase theApp;</span>
00070 
00071 
00073 <span class="comment">// CMFCDialogAppBase initialization</span>
00074 
<a name="l00075"></a><a class="code" href="classCMFCDialogAppBase.html#a1">00075</a> BOOL <a class="code" href="classCMFCDialogAppBase.html#a1">CMFCDialogAppBase::InitInstance</a>()
00076 {
00077 
00078    <span class="keywordflow">try</span>
00079    {
00080 <span class="preprocessor">#ifdef _DEBUG</span>
00081 <span class="preprocessor"></span>      <a class="code" href="classTLogger.html#d0">TLogger::TruncateOnOpen</a>();
00082 <span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084       <span class="comment">// m_lpCmdLine should be the configuration (.d) file name</span>
00085 
00086       <span class="comment">// Check the command line</span>
00087       <span class="keywordflow">if</span> ( m_lpCmdLine[0] == <span class="charliteral">'\0'</span> )
00088       {
00089          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Missing command line parm 1 (configuration file name)"</span>);
00090       }
00091 
00092 
00093       <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogAppBase.html#b0">PrepApp</a>(m_lpCmdLine) )
00094       {
00095          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed preparing application"</span>);
00096       }
00097 
00098 
00099       <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogAppBase.html#b1">ParseCommandFile</a>(m_lpCmdLine) )
00100       {
00101          <span class="comment">// error parsing command file</span>
00102          <a class="code" href="classworm__exception.html">worm_exception</a> _expt(<span class="stringliteral">"Error parsing command file "</span>);
00103                         _expt += m_lpCmdLine;
00104          <span class="keywordflow">throw</span> _expt;
00105       }
00106 
00107       <span class="comment">// Running = true so any threads started in InitApp()</span>
00108       <span class="comment">//           won't quit right away</span>
00109       <a class="code" href="classCMFCDialogAppBase.html#n0">Running</a> = <span class="keyword">true</span>;
00110 
00111       <span class="keywordflow">if</span> ( ! <a class="code" href="classCMFCDialogAppBase.html#b2">InitApp</a>() )
00112       {
00113          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"Failed call to InitApp()"</span>);
00114       }
00115 
00116 
00117            m_pMainWnd = <a class="code" href="classCMFCDialogAppBase.html#b3">GetMainWindow</a>();
00118 
00119       <a class="code" href="classCMFCDialogAppBase.html#b4">OpenMainDialog</a>();
00120 
00121    }
00122    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00123    {
00124       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00125                    , <span class="stringliteral">"%s: Exiting due to\n%s\n"</span>
00126                    , <a class="code" href="classCMFCDialogAppBase.html#b5">GetApplicationName</a>()
00127                    , _we.what()
00128                    );
00129    }
00130 
00131 
00132    <a class="code" href="classTLogger.html#d2">TLogger::Close</a>();
00133 
00134 
00135         <span class="comment">// Since the dialog has been closed, return FALSE so that we exit the</span>
00136         <span class="comment">//  application, rather than start the application's message pump.</span>
00137         <span class="keywordflow">return</span> <a class="code" href="earthworm__defs_8h.html#a9">FALSE</a>;
00138 }
00139 
00141 
00142 
00144 
00145 
<a name="l00146"></a><a class="code" href="classCMFCDialogAppBase.html#b1">00146</a> <span class="keywordtype">bool</span> <a class="code" href="classCMFCDialogAppBase.html#b1">CMFCDialogAppBase::ParseCommandFile</a>( LPTSTR p_filename )
00147 {
00148    <span class="keywordtype">bool</span> r_status = <span class="keyword">true</span>;
00149    
00150    <a class="code" href="classTComFileParser.html">TComFileParser</a> * _parser = NULL;
00151 
00152    <span class="keywordflow">try</span>
00153    {
00154 
00155       <span class="keywordflow">if</span> ( (_parser = <span class="keyword">new</span> <a class="code" href="classTComFileParser.html">TComFileParser</a>()) == NULL )
00156       {
00157          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"failed creating TComFileParser to parse configuration file"</span>);
00158       }
00159 
00160       <span class="keywordflow">if</span> ( ! _parser-&gt;<a class="code" href="classTComFileParser.html#a2">Open</a>(p_filename) )
00161       {
00162          <span class="keywordtype">char</span> _msg[80];
00163          sprintf( _msg, <span class="stringliteral">"failed opening configuration file %s"</span>, p_filename );
00164          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(_msg);
00165       }
00166 
00167 
00168       <span class="keywordtype">bool</span> _reading = <span class="keyword">true</span>;
00169 
00170       <span class="keywordtype">char</span> * _token;
00171 
00172       <span class="keywordflow">do</span>
00173       {
00174           <span class="keywordflow">switch</span>( _parser-&gt;<a class="code" href="classTComFileParser.html#a5">ReadLine</a>() )
00175           {
00176             <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a5">COMFILE_EOF</a>:  <span class="comment">// eof</span>
00177                  _reading = <span class="keyword">false</span>;
00178                  <span class="keywordflow">break</span>;
00179 
00180             <span class="keywordflow">case</span> <a class="code" href="configsource_8h.html#a7a4">COMFILE_ERROR</a>: <span class="comment">// error</span>
00181                  <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"error returned by TComFileParser::ReadLine()"</span>);
00182 
00183             <span class="keywordflow">case</span> 0:  <span class="comment">// empty line, TComFileParser should not return this</span>
00184                  <span class="keywordflow">break</span>;
00185 
00186             <span class="keywordflow">default</span>:
00187 
00188                  <span class="comment">// Get the command into _token</span>
00189                  _token = _parser-&gt;<a class="code" href="classConfigSource.html#a5">NextToken</a>();
00190 
00191                  <span class="comment">// check if module .d commands handled by deriving class</span>
00192                  <span class="comment">//</span>
00193                  <span class="keywordflow">if</span> ( <a class="code" href="classTConfigurable.html#a1">HandleConfigLine</a>(_parser) != <a class="code" href="configurable_8h.html#a3a1">HANDLER_UNUSED</a> )
00194                  {
00195                     <span class="keywordflow">continue</span>;
00196                  }
00197 
00198                  <span class="comment">// Not handled </span>
00199                  <span class="comment">//</span>
00200                  <span class="comment">// Don't throw an error here because it is preferable to report</span>
00201                  <span class="comment">// as many errors as possible to the file.</span>
00202                  <span class="comment">//</span>
00203                  <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE|WORM_LOG_TIMESTAMP
00204                                , <span class="stringliteral">"ParseCommandFile(): unrecognized command: %s\n"</span>
00205                                , _token
00206                                );
00207                     
00208                  r_status = <span class="keyword">false</span>;
00209           }
00210       } <span class="keywordflow">while</span>( _reading );
00211 
00212       <span class="keyword">delete</span>( _parser );
00213       _parser = NULL;
00214 
00215 
00216       <span class="comment">// Is derivative class ready?</span>
00217       <span class="comment">//</span>
00218       <span class="keywordflow">if</span> ( ! <a class="code" href="classTConfigurable.html#a2">IsReady</a>() )
00219       {
00220          <span class="keywordflow">throw</span> <a class="code" href="classworm__exception.html">worm_exception</a>(<span class="stringliteral">"application not configured properly"</span>);
00221       }
00222 
00223    }
00224    <span class="keywordflow">catch</span>( <a class="code" href="classworm__exception.html">worm_exception</a> _we )
00225    {
00226       <a class="code" href="classTLogger.html#d1">TLogger::Logit</a>( WORM_LOG_TOFILE
00227                    , <span class="stringliteral">"ParseCommandFile(): Error: \n%s\n"</span>
00228                    , _we.what()
00229                    );
00230       r_status = <span class="keyword">false</span>;
00231    }
00232    
00233    <span class="keywordflow">if</span> ( _parser != NULL )
00234    {
00235       <span class="keyword">delete</span>( _parser ) ;
00236    }
00237 
00238 
00239    
00240    <span class="keywordflow">return</span> r_status;
00241 }
00242 
00244 
00245 
</pre></div><hr><address style="align: right;"><small>Generated on Tue May 6 09:16:05 2003 for Earthworm Libs by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
