<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      q2ew – Earthworm
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="http://earthwormcentral.com/trac/ew/search" />
        <link rel="help" href="TracGuide.html" />
        <link rel="alternate" href="http://earthwormcentral.com/trac/ew/wiki/q2ew?format=txt" type="text/x-trac-wiki" title="Plain Text" />
        <link rel="start" href="http://earthwormcentral.com/trac/ew/wiki" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../chrome/tracjsgantt/jsgantt.css" type="text/css" /><link rel="stylesheet" href="../chrome/tracjsgantt/tracjsgantt.css" type="text/css" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="http://earthwormcentral.com/trac/ew/search/opensearch" title="Search Earthworm" />
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/tracjsgantt/jsgantt.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/trac/ew/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://earthwormcentral.com/trac/ew"><img src="../chrome/site/images/ew.logo_tiny.png" alt="" /></a>
      </div>
      <form id="search" action="http://earthwormcentral.com/trac/ew/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="http://earthwormcentral.com/trac/ew/login">Login</a></li><li><a href="TracGuide.html">Help/Guide</a></li><li><a href="http://earthwormcentral.com/trac/ew/about">About Trac</a></li><li class="last"><a href="http://earthwormcentral.com/trac/ew/prefs">Preferences</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="http://earthwormcentral.com/trac/ew/wiki">Wiki</a></li><li><a href="http://earthwormcentral.com/trac/ew/timeline">Timeline</a></li><li><a href="http://earthwormcentral.com/trac/ew/roadmap">Roadmap</a></li><li><a href="http://earthwormcentral.com/trac/ew/browser">Browse Source</a></li><li><a href="http://earthwormcentral.com/trac/ew/query">View Tickets</a></li><li class="last"><a href="http://earthwormcentral.com/trac/ew/search">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="View WikiStart" href="http://earthwormcentral.com/trac/ew/wiki">wiki:</a><a class="pathentry" href="q2ew.html" title="View q2ew">q2ew</a>
</div>
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><a href="WikiStart.html">Start Page</a></li><li><a href="TitleIndex.html">Index</a></li><li class="last"><a href="http://earthwormcentral.com/trac/ew/wiki/q2ew?action=history">History</a></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">
        
          
          <div class="trac-modifiedby">
            <span><a href="http://earthwormcentral.com/trac/ew/wiki/q2ew?action=diff&amp;version=4" title="Version 4 by branden">Last modified</a> <a class="timeline" href="http://earthwormcentral.com/trac/ew/timeline?from=2012-04-08T17%3A18%3A51-07%3A00&amp;precision=second" title="2012-04-08T17:18:51-07:00 in Timeline">17 months</a> ago</span>
            <span class="trac-print">Last modified on 04/08/12 17:18:51</span>
          </div>
          <div id="wikipage"><p>
</p><div class="wiki-toc">
<ol>
  <li>
    <a href="q2ew.html#EarthwormModule:q2ew">Earthworm Module: q2ew</a>
    <ol>
      <li>
        <a href="q2ew.html#Function">Function</a>
      </li>
      <li>
        <a href="q2ew.html#Details">Details</a>
      </li>
      <li>
        <a href="q2ew.html#ConfigurationFileCommands">Configuration File Commands</a>
        <ol>
          <li>
            <a href="q2ew.html#ExampleConfigurationFile">Example Configuration File</a>
          </li>
          <li>
            <a href="q2ew.html#FunctionalCommandListing">Functional Command Listing</a>
          </li>
          <li>
            <a href="q2ew.html#AlphabeticCommandListingDescription">Alphabetic Command Listing &amp; Description</a>
          </li>
          <li>
            <a href="q2ew.html#DescriptorFileExample">Descriptor File Example</a>
          </li>
        </ol>
      </li>
      <li>
        <a href="q2ew.html#HelpfulHints">Helpful Hints</a>
      </li>
    </ol>
  </li>
</ol>
</div><p>
</p>
<h1 id="EarthwormModule:q2ew"><a class="wiki" href="Earthworm.html">Earthworm</a> Module: q2ew</h1>
<p>
<strong>Contributed by: </strong>
</p>
<h2 id="Function">Function</h2>
<p>
A Quanterra/COMSERV data feeding program.
</p>
<h2 id="Details">Details</h2>
<p>
q2ew is a Quanterra/COMSERV data feeding program for Earthworm. The utility was written for the Alaska Tsunami Warning Center's Quanterra Q730 digitizers, but should work with any Quanterra digitizer that is COMSERV compatible. COMSERV is a software freeware product developed by Quanterra and other Quanterra users. It is a middleware software layer between the digitizer and the data acquisition software (clients). In short, COMSERV insulates the developer/user from changes to the QSL communications protocol and acts as a multithreaded switch for client processes to access data from the digitizers.
</p>
<p>
COMSERV must be configured on the same host as the Earthworm system in order for this program to work. Berkeley is the ftp repository for the <a class="ext-link" href="ftp://quake.geo.berkeley.edu/pub/quanterra/"><span class="icon">​</span>COMSERV software</a>. Please refer to the COMSERV documentation on how to correctly install and configure this system.
</p>
<p>
q2ew is designed as a multi-threaded program. The main thread loops polling the COMSERV shared memory region, using COMSERV cs_scan() calls, for new packets arriving from digitizers. Once data arrives, the main thread converts the data into an earthworm trace buffer and ships the data off to the earthworm transport ring. The second thread, the heartbeat, checks that data are coming in from COMSERV in the main thread and issues regular heartbeats. Should there be a fatal problem with the COMSERV server for any of the stations, the heartbeat thread detects this and a message is sent to statmgr and the process dies. The cs_status() call is a critical one to adjust to fine tune the program to modify the severity of reactions to problems/changes observed with COMSERV. All of the fatal errors will cause q2ew to die, but some of the recoverable errors are now set to cause q2ew to die (in particular CSCR_DIED). As we gain more experience with the robustness of COMSERV, we can adjust the recoverable errors to simply provide status messages, but for now lets play it cautious.
</p>
<p>
The program q2ew has been tested on Solaris and Linux platforms.
</p>
<h2 id="ConfigurationFileCommands">Configuration File Commands</h2>
<p>
On startup, q2ew reads the configuration file named on the command line. As always, the configuraton file contains comments:
</p>
<pre class="wiki">#  marks the line as a comment (example: # This is a comment).
</pre><p>
Command names must be typed in the control file exactly as shown in this document (upper/lower case matters!). q2ew supports one diagnostic command line option, -v is for verbose mode so that you can see packets coming in.
</p>
<h3 id="ExampleConfigurationFile">Example Configuration File</h3>
<pre class="wiki">#
# q2ew configuration file
#
# This code receives MiniSEED records from COMSERV, converts them into
# Earthworm trace buf messages, and stuffs them into a wave ring.
#
#
 ModuleId	MOD_Q2EW	# module id for this import,
 RingName	WAVE_RING	# transport ring to use for input/output,

 HeartbeatInt	10		# Heartbeat interval in seconds
				# this should be half the q2ew.desc heartbeat!

 LogFile	1		# If 0, don't write logfile at all,

 LOG2LogFile 	1		#  write LOG chans to log file
				# this is useful for debugging timing or
				# data logger problems.	

TimeoutNoSend	5		# If no data for X seconds from COMSERV for
				# ALL stations,  then kill process (HB and
				# main thread). 
				# NOTE: this timeout does not take effect until
				# a trace data packet comes from comserv. That
				# is, LOG channels do not count! 
				# 
				# Iff TimeoutNoSend == 0, then this data
				# check is DISABLED and q2ew will only die
				# if EW or COMSERV dies.

# For ATWC, set this next config param to CSQ_LAST
 ComservSeqBuf	CSQ_LAST	# This is a comserv sequence control value
				# that can have the following settings:
				# CSQ_NEXT  = Get newer than already received
				# CSQ_LAST  = Get first available data (latest)
				# CSQ_FIRST = Get all data in DAQ
				# This effects what data are returned.

# These are optional for those EW users who want to have a pin number
# instead of a SCNL. The keyword here is SCNL2pinmap. No duplicate checking
# occurs. Note that SCNL2pinmap replaces SCN2pinmap (q2ew now supports location code)

# Example
#		S	C    	N	L	pin
SCNL2pinmap 	Q003	HHZ  	AT	--	1
SCNL2pinmap 	Q003	HHN  	AT	00	2
SCNL2pinmap 	Q003	HHE  	AT	01	3
</pre><h3 id="FunctionalCommandListing">Functional Command Listing</h3>
<p>
Below are the configure commands recognized by q2ew, grouped by the function they influence. Most of the commands are required. Only SCNL2pinmap and LOG2LogFile are optional.
</p>
<pre class="wiki">         Earthworm system setup:
 		MyModuleId	   	required
		RingName	   	required
		ComservSeqBuf	   	required
		HeartbeatInt	   	required
		TimeoutNoSend	   	required
	
	Output Control:
		LogFile		   	required
		LOG2LogFile		optional
		SCNL2pinmap		optional
</pre><h3 id="AlphabeticCommandListingDescription">Alphabetic Command Listing &amp; Description</h3>
<p>
In the following section, all configuration file commands are listed in alphabetical order. Listed along with the command (bold-type) are its arguments (in red), the name of the subroutine that processes the command, and the function within the module that the command influences. A detailed description of the command and is also given. Default values and example commands are listed after each command description.
</p>
<p>
The following list is organized by:
</p>
<p>
command [argument here]
</p>
<p>
<strong>ComservSeqBuf [csqtype]</strong><br />
Processed by: main<br />
Function: Main q2ew Thread
</p>
<p>
This command is used to define how q2ew gets data from COMSERV. csqtype is the name of a #define as found in COMSERV's comserv/include/service.h file. csqtype can have the following values:
</p>
<pre class="wiki">	CSQ_NEXT
	CSQ_LAST
	CSQ_FIRST

CSQ_LAST is what is being used for ATWC since they are only interested in the latest available data from the digitizer or DA 
(digitizer=DA in Quanterras documents). CSQ_NEXT gets only the data that are newer than that already receieved by COMSERV 
and CSQ_FIRST gets all the data in the DA's buffer.

Default:  none
Example: 
	ComservSeqBuf CSQ_LAST
</pre><p>
<strong>HeartbeatInt [beat]</strong><br />
Processed by: HeartBeat<br />
Function: Earthworm setup
</p>
<p>
Beat the q2ew heart every beat seconds. This is implemented as a separate thread in q2ew.
</p>
<p>
<strong>LOG2LogFile [switch]</strong><br />
Processed by: logLOGchans<br />
Function: Main q2ew Thread
</p>
<p>
Sets the on-off switch for writing Quanterra LOG channels to the LogFile. If switch is 0, no LOG channels will be written to the log. If switch is 1, q2ew will write all LOG channels to the LogFile. Turning this on will automatically turn on writing of a LogFile.
</p>
<pre class="wiki">Default:  0 - do not use logit() for LOG channels
</pre><p>
<strong>LogFile [switch]</strong><br />
Processed by: GetConfig<br />
Function: Earthworm Setup
</p>
<p>
Sets the on-off switch for writing a log file to disk. If switch is 0, no log file will be written. If switch is 1, q2ew will write a daily log file(s) called q2ewxx.log_yymmdd where xx is q2ew's module id (set with "MyModuleId" command) and yymmdd is the current UTC date (ex: 960123) on the system clock. The file(s) will be written in the EW_LOG directory (environment variable).
</p>
<pre class="wiki">Default:  none
</pre><p>
<strong>MyModuleId [mod_id]</strong><br />
Processed by: GetConfig<br />
Function: Earthworm setup
</p>
<p>
Sets the module id for labeling all outgoing messages. mod_id is a character string (valid strings are listed in earthworm.d) that relates (in earthworm.d) to a unique single-byte number.
</p>
<pre class="wiki">Default:  none				
Calnet:   MyModuleId MOD_Q2EW
</pre><p>
<strong>RingName [ring]</strong><br />
Processed by: GetConfig<br />
Function: Earthworm setup
</p>
<p>
This is the ring into which the waveforms and messages are sent.
</p>
<pre class="wiki">Default:  none, required option				
ATWC:   RingName WAVE_RING
</pre><p>
<strong>SCNL2pinmap [S C N L pin]</strong><br />
Processed by: insertSCNL<br />
Function: Main q2ew Thread
</p>
<p>
This command is used to define how q2ew maps a Station Channel Name to a pin number for those installations who wish to define pins....This is a throwback to old digitizers and is not recommended since Quanterra digitizers can properly be configured to know SCNL information. Data from S C N L is compared to the SEED header of the waveform packets coming off the DA and the pin number is substituted into the tracebuf struct passed to Earthworm. S is for station name, C is for channel identifier, and N is for network code. Note that station, channel, and network names in Quanterra follow the SEED convention and can be 5, 3, and 2 chars in length respectively.
</p>
<pre class="wiki">Default:  none, optional command
SCNL2pinmap	Q003 HHZ AT --  1
SCNL2pinmap	Q003 HLN AT --  2
SCNL2pinmap	Q003 HLE AT --  3
</pre><p>
<strong>TimeoutNoSend [timeout]</strong><br />
Processed by: HeartBeat<br />
Function: Earthworm setup
</p>
<p>
If no waveform packets come from the DA after timeout seconds, the q2ew module will notify statmgr and die. If timeout is set to 0, then the q2ew module will never check for this timeout. If set to 0, q2ew will only die if COMSERV dies, or if the Earthworm system calls for its termination. This timeout begins once the first Waveform packet is received from ANY DA served by COMSERV. It is not specific to any one DA.
</p>
<pre class="wiki">Default:  none, required option				
ATWC:   TimeoutNoSend 0
</pre><h3 id="DescriptorFileExample">Descriptor File Example</h3>
<p>
Here is a copy of the q2ew.desc file as implemented. Note that all causes of death for q2ew feed through the function q2ew_die() which logs all causes of death using logit() and sends a message to the statmgr utility.
</p>
<pre class="wiki">modName  q2ew
modId    MOD_Q2EW
instId   INST_ATWC

restartMe	# restart this sucker as it is critical to data collection
#
#
#    Heartbeat Specification.  If the status manager does not receive
#    a heartbeat message every  seconds from this module, an
#    error will be reported (client module dead).   is the maximum
#    number of pager messages that will be reported and  is the
#    maximum number of email messages that will be reported.  If the
#    page or mail limit is exceeded, no further errors will be reported
#    until the status manager is restarted.
#
tsec: 20  page: 0  mail: 99

# these are the statmgr messages that q2ew will send before dieing
#
err: 0  nerr: 1  tsec: 0  page: 5  mail: 20
text: "COMSERV has a problem and died"
#
err: 1  nerr: 1  tsec: 0  page: 5  mail: 20
text: "COMSERV Recv NO DATA TIMEOUT and died"
#
err: 2  nerr: 1  tsec: 0  page: 5  mail: 20
text: "SIGNAL caused q2ew to die"
#
err: 3  nerr: 1  tsec: 0  page: 5  mail: 20
text: "EW tport_putmsg() failed, q2ew dead"
#
err: 4  nerr: 1  tsec: 0  page: 5  mail: 20
text: "EW TERMINATE recv'd, q2ew dead"
#
err: 5  nerr: 1  tsec: 0  page: 5  mail: 20
text: "EW config problems on startup, q2ew dead"
#
# BELOW: WARNINGS, NOT FATAL YET 
err: 6  nerr: 1  tsec: 0  page: 5  mail: 20
text: "qlib2 decompression errors"
#
</pre><h2 id="HelpfulHints">Helpful Hints</h2>
</div>
        
        
      </div>
      

    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="last first">
          <a rel="nofollow" href="http://earthwormcentral.com/trac/ew/wiki/q2ew?format=txt">Plain Text</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="http://earthwormcentral.com/trac/ew/about"><strong>Trac 0.12.4</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>